import{a as E}from"./chunk-4RWSWTIC.js";import{s as T,u as H,y as P}from"./chunk-E2PEM77A.js";import{f as S,g as z}from"./chunk-OTLOUAP3.js";import{a as k}from"./chunk-5Q65R7QF.js";import{C as D}from"./chunk-2G3SBK6Q.js";var A=96/72,F=class{constructor(m){this._spatialReference=m,this._imageDataCanvas=null,this._cimResourceManager=new E}get _canvas(){return this._imageDataCanvas||(this._imageDataCanvas=document.createElement("canvas")),this._imageDataCanvas}get resourceManager(){return this._cimResourceManager}async rasterizeCIMSymbolAsync(m,n,s,C,_,r,c,l,g,p){if(!m)return null;let{data:w}=m;if(!w||w.type!=="CIMSymbolReference"||!w.symbol)return null;let{symbol:R}=w;r||(r=D(R));let o=await k.resolveSymbolOverrides(w,n,this._spatialReference,_,r,c,l),d=this._cimResourceManager,f=[];P.fetchResources(o,d,f),P.fetchFonts(o,d,f),f.length>0&&await Promise.all(f);let{width:t,height:a}=s,b=O(r,t,a,C,p),e=P.getEnvelope(o,b,d);if(!e)return null;e.x===1/0&&(e.x=t+2),e.y===1/0&&(e.y=-a/2),e.width===-1/0&&(e.width=t),e.height===-1/0&&(e.height=a);let y=1,I=0,v=0;switch(R.type){case"CIMPointSymbol":case"CIMTextSymbol":{let i=1;e.width>t&&(i=t/e.width);let h=1;e.height>a&&(h=a/e.height),C==="preview"&&(e.width<t&&(i=t/e.width),e.height<a&&(h=a/e.height)),y=Math.min(i,h),I=e.x+e.width/2,v=e.y+e.height/2}break;case"CIMLineSymbol":if(p){v=e.y+e.height/2,I=e.x+e.width/2;let i=e.width-t,h=e.height-a;b={paths:S(b.paths,{xmin:-1*e.width/2+i,xmax:e.width/2-i,ymin:-1*e.height/2+h,ymax:e.height/2-h,width:e.width-2*i,height:e.height-2*h})}}else{(g||e.height>a)&&(y=a/e.height),v=e.y+e.height/2;let i=e.x*y+t/2,h=(e.x+e.width)*y+t/2,{paths:M}=b;M[0][0][0]-=i/y,M[0][2][0]-=(h-t)/y}break;case"CIMPolygonSymbol":if(p){v=e.y+e.height/2,I=e.x+e.width/2;let i=e.width-t,h=e.height-a;b={paths:S(b.rings,{xmin:-1*e.width/2+i,xmax:e.width/2-i,ymin:-1*e.height/2+h,ymax:e.height/2-h,width:e.width-2*i,height:e.height-2*h})}}else{I=e.x+e.width/2,v=e.y+e.height/2;let i=e.x*y+t/2,h=(e.x+e.width)*y+t/2,M=e.y*y+a/2,G=(e.y+e.height)*y+a/2,{rings:u}=b;i<0&&(u[0][0][0]-=i,u[0][3][0]-=i,u[0][4][0]-=i),M<0&&(u[0][0][1]+=M,u[0][1][1]+=M,u[0][4][1]+=M),h>t&&(u[0][1][0]-=h-t,u[0][2][0]-=h-t),G>a&&(u[0][2][1]+=G-a,u[0][3][1]+=G-a)}}let q={type:"cim",data:{type:"CIMSymbolReference",symbol:o}};return this.rasterize(q,t,a,I,v,y,r,1,b)}rasterize(m,n,s,C,_,r,c,l=0,g=null,p=window.devicePixelRatio||1){let{data:w}=m;if(!w||w.type!=="CIMSymbolReference"||!w.symbol)return null;let{symbol:R}=w,o=this._canvas,d=p*A;o.width=n*d,o.height=s*d,c||(c=D(R)),g||(g=O(c,n,s,"legend")),o.width+=2*l,o.height+=2*l;let f=o.getContext("2d",{willReadFrequently:!0}),t=T.createIdentity();return t.translate(-C,-_),t.scale(r*d,-r*d),t.translate(n*d/2+l,s*d/2+l),f.clearRect(0,0,o.width,o.height),new H(f,this._cimResourceManager,t,!0).drawSymbol(R,g),f.getImageData(0,0,o.width,o.height)}};function L(x,m,n,s){return m==="esriGeometryPolygon"?{rings:z(S(x.rings,{xmin:0,ymin:0,xmax:n,ymax:s,width:n,height:s}),-1*n/2,-1*s/2)}:m==="esriGeometryPolyline"?{paths:z(S(x.paths,{xmin:0,ymin:0,xmax:n,ymax:s,width:n,height:s}),-1*n/2,-1*s/2)}:null}function O(x,m,n,s,C){let r=-m/2+1,c=m/2-1,l=n/2-1,g=-n/2+1;if(C&&(x==="esriGeometryPolygon"||x==="esriGeometryPolyline")){let p=L(C,x,m,n);if(p)return p}switch(x){case"esriGeometryPoint":return{x:0,y:0};case"esriGeometryPolyline":return{paths:[[[r,0],[0,0],[c,0]]]};default:return s==="legend"?{rings:[[[r,l],[c,0],[c,g],[r,g],[r,l]]]}:{rings:[[[r,l],[c,l],[c,g],[r,g],[r,l]]]}}}export{F as a};
