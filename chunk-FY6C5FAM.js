import{a as ce}from"./chunk-SJUUYRVI.js";import{a as ue,b as he}from"./chunk-AY7CYY2N.js";import"./chunk-VEK547EU.js";import"./chunk-LAVD467M.js";import"./chunk-6CUAH7AI.js";import"./chunk-OC2XJJQU.js";import{a as de}from"./chunk-4OC4J3KU.js";import"./chunk-54HXR2K7.js";import{u as pe}from"./chunk-T4QAGZWF.js";import"./chunk-7BXTHPPE.js";import"./chunk-Q5KIWWVU.js";import"./chunk-KK722UJA.js";import"./chunk-C27Q2S3P.js";import"./chunk-ZFRNSCYG.js";import"./chunk-UWWX7VSW.js";import"./chunk-CFF33S4D.js";import{q as le}from"./chunk-2XYAAYOE.js";import{b as se,f as ne,i as ae}from"./chunk-SU7IJ65K.js";import"./chunk-YSD7LK2L.js";import{a as ie}from"./chunk-BSSTF6JG.js";import{c as oe}from"./chunk-BPX3YT3K.js";import{a as re}from"./chunk-NIYDRLW4.js";import"./chunk-CAXK5KYB.js";import"./chunk-3CCK7BDD.js";import"./chunk-LNYBTIG7.js";import"./chunk-NNX76JDG.js";import"./chunk-76O2P2CB.js";import"./chunk-AOQ57NDM.js";import"./chunk-VMECOA4F.js";import"./chunk-JPMGMA4B.js";import{b as q}from"./chunk-YQGS4EZO.js";import"./chunk-3REMXE4W.js";import"./chunk-4ABKPPKG.js";import"./chunk-PMVQ5DJK.js";import"./chunk-I4Q2S2XA.js";import"./chunk-V774RJYN.js";import"./chunk-L2WNUKLP.js";import"./chunk-XITT4JU2.js";import"./chunk-ZBX6HJOS.js";import"./chunk-BSMAMABT.js";import"./chunk-LYNAYPL3.js";import"./chunk-ULANM5YP.js";import"./chunk-KAMRW6HF.js";import"./chunk-DJW5LMRG.js";import"./chunk-ALWV3RJ2.js";import"./chunk-DEH76MSI.js";import{a as M}from"./chunk-DVBZA6ZU.js";import{a as K,b as B}from"./chunk-6YRWGF73.js";import{a as b}from"./chunk-V2JYXY4D.js";import"./chunk-VTGWQ7AP.js";import"./chunk-TBA3OZMJ.js";import"./chunk-S4QV2MGO.js";import"./chunk-USMAJP2P.js";import"./chunk-PHNFWHVF.js";import"./chunk-4N5OXIEM.js";import"./chunk-W26XKMAT.js";import{a as te}from"./chunk-NQWYPF77.js";import{a as Y}from"./chunk-D7WE3OBT.js";import"./chunk-JTDXB5TK.js";import"./chunk-CWUY5SXW.js";import"./chunk-KD27XIJC.js";import"./chunk-GWBRHLNH.js";import"./chunk-EM35R6FY.js";import"./chunk-QXXXCEV5.js";import{c as ee}from"./chunk-6B5XFA6F.js";import"./chunk-NHEQ4TAR.js";import"./chunk-HP4LYRR4.js";import{b as Q}from"./chunk-AFC2H4Q3.js";import"./chunk-OLOKUDVI.js";import"./chunk-4G7UTTZJ.js";import"./chunk-ZTOZWLEE.js";import"./chunk-RJWOVI3M.js";import"./chunk-NRBJLISB.js";import"./chunk-PTZYZULI.js";import"./chunk-NMLYCCKN.js";import"./chunk-RSDQHAJX.js";import{a as Z}from"./chunk-BOVYXYHK.js";import"./chunk-FENRIY2T.js";import"./chunk-HX2VGIR2.js";import"./chunk-64QN2VGD.js";import"./chunk-JGEVVXD4.js";import{p as X}from"./chunk-B3FO6PT7.js";import"./chunk-C4UMJHQC.js";import"./chunk-BCREO4Q5.js";import{d as L,f as $}from"./chunk-LXFQWIWE.js";import"./chunk-QT6UNBJP.js";import"./chunk-V2GNNIXD.js";import"./chunk-NSYL2RQJ.js";import{a as p,c as G,h as C,i as _,j as z}from"./chunk-MWSXMSWY.js";import{f as j}from"./chunk-JRCKELO6.js";import"./chunk-ZVCMULXF.js";import"./chunk-KJULKTB5.js";import"./chunk-LACL4BQ2.js";import"./chunk-YR2HD3ZC.js";import"./chunk-GJASVPF6.js";import"./chunk-UBFCO3DV.js";import"./chunk-NI7FJV5X.js";import"./chunk-BUSG3ZOF.js";import"./chunk-XZIOXVVJ.js";import"./chunk-EXJYW3PC.js";import"./chunk-SXQPBCOX.js";import"./chunk-LFH24RLM.js";import{n as J}from"./chunk-Z5Q7KLA4.js";import"./chunk-X4LNX4BR.js";import"./chunk-4XZ6X7MQ.js";import"./chunk-WLHY3MMA.js";import"./chunk-KGVXGH6H.js";import"./chunk-ARRCN5K3.js";import"./chunk-LXQPIAN7.js";import"./chunk-FTDD7QBB.js";import"./chunk-DB3UIQCU.js";import"./chunk-SBHKMV3P.js";import"./chunk-R4A63S45.js";import"./chunk-ETE32IYO.js";import"./chunk-ONUGDWDK.js";import"./chunk-SG7CQU4O.js";import{H as s,J as w}from"./chunk-QHVIRF5H.js";import{I as f}from"./chunk-WZDN6K3C.js";import{a as o}from"./chunk-QGVBCWUY.js";import"./chunk-OJQ73TPF.js";import"./chunk-354SCPDU.js";import"./chunk-OVHPPCBL.js";import"./chunk-IYZFKXJ6.js";import{E as c,O as W,e as U,j as A,p as x,v as E}from"./chunk-CKJ56T2Q.js";import"./chunk-SNFOAZZQ.js";import"./chunk-F6JAWRPN.js";import"./chunk-UHRSAPGQ.js";import{h as R,w as P}from"./chunk-V76GWARL.js";import{a as O,b as F}from"./chunk-N2WTMF3X.js";function H(e,t){return ne(t.extent,fe),ae(fe,ee(ge,e.x,e.y,0))}var fe=se(),ge=Z();var m=class extends w{get tiles(){let e=this.tilesCoveringView,t=this.pointOfInterest!=null?this.pointOfInterest:this.view.center;return e.sort((i,n)=>H(t,i)-H(t,n)),e}_scaleEnabled(){return oe(this.view.scale,this.layer.minScale||0,this.layer.maxScale||0)}get tilesCoveringView(){if(!this.view.ready||!this.view.featuresTilingScheme||!this.view.state||this.tileInfo==null)return[];if(!this._scaleEnabled)return[];let{spans:e,lodInfo:t}=this.view.featuresTilingScheme.getTileCoverage(this.view.state,0),{level:i}=t,n=[];for(let{row:r,colFrom:a,colTo:l}of e)for(let v=a;v<=l;v++){let I=t.normalizeCol(v),g=new b(null,i,r,I);this.tileInfo.updateTileInfo(g),n.push(g)}return n}get tileInfo(){return this.view.featuresTilingScheme?.tileInfo??null}get tileSize(){return this.tileInfo!=null?this.tileInfo.size[0]:256}constructor(e){super(e),this.pointOfInterest=null}initialize(){this.addHandles(p(()=>this.view?.state?.viewpoint,()=>this.notifyChange("tilesCoveringView"),C))}};o([s({readOnly:!0})],m.prototype,"tiles",null),o([s({readOnly:!0})],m.prototype,"_scaleEnabled",null),o([s({readOnly:!0})],m.prototype,"tilesCoveringView",null),o([s({readOnly:!0})],m.prototype,"tileInfo",null),o([s({readOnly:!0})],m.prototype,"tileSize",null),o([s({constructOnly:!0})],m.prototype,"view",void 0),o([s({constructOnly:!0})],m.prototype,"layer",void 0),o([s()],m.prototype,"pointOfInterest",void 0),m=o([f("esri.views.2d.interactive.snapping.featureSources.featureServiceSource.FeatureServiceTiles2D")],m);var y=class extends w{get _sortedTilesCoveringView(){let e=(this.view.featureTiles?.tiles?.toArray()??[]).map(we),t=this._effectivePointOfInterest;return t!=null&&e.sort((i,n)=>H(t,i)-H(t,n)),e}get tileInfo(){return this.view.featureTiles?.tilingScheme?.toTileInfo()??null}get tileSize(){return this.view.featureTiles?.tileSize??256}get _effectivePointOfInterest(){let e=this.pointOfInterest;return e??this.view.pointsOfInterest?.focus.location}constructor(e){super(e),this.tiles=[],this.pointOfInterest=null}initialize(){this.addHandles([p(()=>this.view.featureTiles,e=>{this.removeHandles(me),e&&this.addHandles(e.addClient(),me)},_),p(()=>this._sortedTilesCoveringView,e=>this._set("tiles",e),{initial:!0,equals:(e,t)=>R(e,t,(i,n)=>i.id===n.id)})])}};function we({lij:[e,t,i],extent:n}){return new b(`${e}/${t}/${i}`,e,t,i,n)}o([s({readOnly:!0})],y.prototype,"tiles",void 0),o([s({readOnly:!0})],y.prototype,"_sortedTilesCoveringView",null),o([s({readOnly:!0})],y.prototype,"tileInfo",null),o([s({readOnly:!0})],y.prototype,"tileSize",null),o([s({constructOnly:!0})],y.prototype,"view",void 0),o([s()],y.prototype,"pointOfInterest",void 0),o([s()],y.prototype,"_effectivePointOfInterest",null),y=o([f("esri.views.3d.interactive.snapping.featureSources.featureServiceSource.FeatureServiceTiles3D")],y);var me="feature-tiles";var T=class extends ce{constructor(e){super(e)}initialize(){let e=setInterval(()=>this._fetchDebugInfo(),2e3);this.addHandles(A(()=>clearInterval(e)))}getTiles(){if(!this._debugInfo)return[];let e=new Map,t=new Map;this._debugInfo.storedTiles.forEach(r=>{e.set(r.data.id,r.featureCount)}),this._debugInfo.pendingTiles.forEach(r=>{e.set(r.data.id,r.featureCount),t.set(r.data.id,r.state)});let i=r=>{let a=t.get(r),l=e.get(r)??"?";return a?`${a}:${l}
${r}`:`store:${l}
${r}`},n=new Map;return this._debugInfo.storedTiles.forEach(r=>{n.set(r.data.id,r.data)}),this._debugInfo.pendingTiles.forEach(r=>{n.set(r.data.id,r.data)}),Array.from(n.values()).map(r=>({lij:[r.level,r.row,r.col],level:r.level,geometry:X.fromExtent($(r.extent,this.view.spatialReference)),label:i(r.id)}))}_fetchDebugInfo(){this.handle.getDebugInfo(null).then(e=>{this._debugInfo=e,this.update()})}};o([s({constructOnly:!0})],T.prototype,"handle",void 0),T=o([f("esri.views.interactive.snapping.featureSources.WorkerTileTreeDebugger")],T);var h=class extends w{get updating(){return this._updatingHandles.updating||this._workerHandleUpdating}constructor(e){super(e),this._updatingHandles=new M,this._suspendController=null,this.schedule=null,this.hasZ=!1,this.elevationAlignPointsInFeatures=async t=>{let i=[];for(let{points:n}of t.pointsInFeatures)for(let{z:r}of n)i.push(r);return{elevations:i,drapedObjectIds:new Set,failedObjectIds:new Set}},this.queryForSymbologySnapping=async()=>({candidates:[],sourceCandidateIndices:[]}),this.availability=0,this._workerHandleUpdating=!0,this.updateOutFields=W(async(t,i)=>{await this._updatingHandles.addPromise(this._workerHandle.invokeMethod("updateOutFields",[...t],i)),this._updatingHandles.addPromise(this._workerHandle.invokeMethod("whenNotUpdating",{},i))})}destroy(){this._suspendController=U(this._suspendController),this._workerHandle.destroy(),this._updatingHandles.destroy()}initialize(){this._workerHandle=new V(this.schedule,{alignElevation:async(e,{signal:t})=>({result:await this.elevationAlignPointsInFeatures(e.query,t)}),getSymbologyCandidates:async(e,{signal:t})=>({result:await this.queryForSymbologySnapping(e,t)})}),this.addHandles([this._workerHandle.on("notify-updating",({updating:e})=>this._workerHandleUpdating=e),this._workerHandle.on("notify-availability",({availability:e})=>this._set("availability",e))])}async setup(e,t){let i=ve(e.layer);if(i==null)return;let n={configuration:ye(e.configuration),serviceInfo:i,spatialReference:e.spatialReference.toJSON(),hasZ:this.hasZ,elevationInfo:e.layer.elevationInfo?.toJSON()};await this._updatingHandles.addPromise(this._workerHandle.invokeMethod("setup",n,t)),this._updatingHandles.addPromise(this._workerHandle.invokeMethod("whenNotUpdating",{},t))}async configure(e,t){let i=ye(e);await this._updatingHandles.addPromise(this._workerHandle.invokeMethod("configure",i,t)),this._updatingHandles.addPromise(this._workerHandle.invokeMethod("whenNotUpdating",{},t))}async refresh(e){await this._updatingHandles.addPromise(this._workerHandle.invokeMethod("refresh",{},e)),this._updatingHandles.addPromise(this._workerHandle.invokeMethod("whenNotUpdating",{},e))}async fetchCandidates(e,t){let{point:i,filter:n,coordinateHelper:r}=e,a=F(O({},e),{point:re(i[0],i[1],i[2],r.spatialReference.toJSON()),filter:n?.toJSON()});return this._workerHandle.invoke(a,t)}async updateTiles(e,t){let i={tiles:e.tiles,tileInfo:e.tileInfo!=null?e.tileInfo.toJSON():null,tileSize:e.tileSize};await this._updatingHandles.addPromise(this._workerHandle.invokeMethod("updateTiles",i,t)),this._updatingHandles.addPromise(this._workerHandle.invokeMethod("whenNotUpdating",{},t))}async handleEdits({historicMoment:e,addedFeatures:t,deletedFeatures:i,updatedFeatures:n},r){let a={historicMoment:e,addedFeatures:t?.map(({objectId:l})=>l).filter(P)??[],deletedFeatures:i?.map(({objectId:l,globalId:v})=>({objectId:l,globalId:v}))??[],updatedFeatures:n?.map(({objectId:l})=>l).filter(P)??[]};await this._updatingHandles.addPromise(this._workerHandle.invokeMethod("handleEdits",a,r)),this._updatingHandles.addPromise(this._workerHandle.invokeMethod("whenNotUpdating",{},r))}async setHistoricMoment(e,t){await this._updatingHandles.addPromise(this._workerHandle.invokeMethod("setHistoricMoment",{moment:e},t))}getDebugInfo(e){return this._workerHandle.invokeMethod("getDebugInfo",{},e)}async notifyElevationSourceChange(){await this._workerHandle.invokeMethod("notifyElevationSourceChange",{})}async notifySymbologyChange(){await this._workerHandle.invokeMethod("notifySymbologyChange",{})}async setSymbologySnappingSupported(e){await this._workerHandle.invokeMethod("setSymbologySnappingSupported",e)}async setSuspended(e){this._suspendController?.abort(),this._suspendController=new AbortController,await this._workerHandle.invokeMethod("setSuspended",e,this._suspendController.signal)}};function ye(e){return{filter:e.filter!=null?e.filter.toJSON():null,customParameters:e.customParameters,viewType:e.viewType}}function ve(e){return e.geometryType==="multipatch"||e.geometryType==="mesh"?null:{url:e.parsedUrl?.path??"",fieldsIndex:e.fieldsIndex.toJSON(),geometryType:te.toJSON(e.geometryType),capabilities:e.capabilities,objectIdField:e.objectIdField,globalIdField:e.globalIdField,spatialReference:e.spatialReference.toJSON(),timeInfo:e.timeInfo?.toJSON()}}o([s({constructOnly:!0})],h.prototype,"schedule",void 0),o([s({constructOnly:!0})],h.prototype,"hasZ",void 0),o([s({constructOnly:!0})],h.prototype,"elevationAlignPointsInFeatures",void 0),o([s({constructOnly:!0})],h.prototype,"queryForSymbologySnapping",void 0),o([s({readOnly:!0})],h.prototype,"updating",null),o([s({readOnly:!0})],h.prototype,"availability",void 0),o([s()],h.prototype,"_workerHandleUpdating",void 0),h=o([f("esri.views.interactive.snapping.featureSources.featureServiceSource.FeatureServiceSnappingSourceWorkerHandle")],h);var V=class extends ie{constructor(t,i){super("FeatureServiceSnappingSourceWorker","fetchCandidates",{},t,{strategy:"dedicated",client:i})}};var S=class extends w{get tiles(){return[new b("0/0/0",0,0,0,L(-1e8,-1e8,1e8,1e8))]}get tileInfo(){return new B({origin:new J({x:-1e8,y:1e8,spatialReference:this.layer.spatialReference}),size:[512,512],lods:[new K({level:0,scale:1,resolution:390625})],spatialReference:this.layer.spatialReference})}get tileSize(){return this.tileInfo.size[0]}constructor(e){super(e),this.pointOfInterest=null}};o([s({readOnly:!0})],S.prototype,"tiles",null),o([s({readOnly:!0})],S.prototype,"tileInfo",null),o([s({readOnly:!0})],S.prototype,"tileSize",null),o([s({constructOnly:!0})],S.prototype,"layer",void 0),o([s()],S.prototype,"pointOfInterest",void 0),S=o([f("esri.views.interactive.snapping.featureSources.featureServiceSource.FeatureServiceTilesSimple")],S);var d=class extends w{get _updateTilesParameters(){return{tiles:this._tilesOfInterest.tiles,tileInfo:this._tilesOfInterest.tileInfo,tileSize:this._tilesOfInterest.tileSize}}get _layerView(){return this.view?.allLayerViews.find(e=>e.layer===this._layer)}get _isSuspended(){return q(this._layer)&&!this.layerSource.sublayerSources.some(e=>e.enabled&&e.layer.visible)?!0:!!this.view&&(this._layerView?.suspended!==!1||!this.layerSource.enabled)}get updating(){return this._workerHandle?.updating||this._updatingHandles.updating}get _outFields(){let{view:e,_layerView:t,layerSource:i}=this,{layer:n}=i,{fieldsIndex:r,timeInfo:a,floorInfo:l,subtypeField:v}=n,I=t&&"filter"in t?t.filter:null,g=I?.where&&I.where!=="1=1"?this._getOrLoadWhereFields(I.where,r):[];if(I?.timeExtent&&a){let{startField:u,endField:k}=a,D=r.get(u)?.name??u,N=r.get(k)?.name??k;D&&g.push(D),N&&g.push(N)}if(e?.map&&pe(e.map)&&e.map.utilityNetworks?.find(u=>u.isUtilityLayer(n))){let u=n.fieldsIndex.get("assetGroup")?.name,k=n.fieldsIndex.get("assetType")?.name;u&&k&&(g.push(u),g.push(k))}if(n&&l?.floorField&&e?.floors?.length){let u=r.get(l.floorField)?.name??l.floorField;u&&g.push(u)}if(v){let u=r.get(v)?.name??v;u&&g.push(u)}return new Set(g)}get configuration(){let{view:e}=this,{apiKey:t,customParameters:i}=this._layer,n=e!=null?e.type:"2d",r=this._layer.createQuery();return this._layerView&&"effectiveDisplayFilter"in this._layerView&&(r.where=Q(r.where,this._layerView.effectiveDisplayFilter?.where)),{filter:r,customParameters:t?F(O({},i),{token:t}):i,viewType:n}}get availability(){return this._workerHandle?.availability??0}get _layer(){return this.layerSource.layer}constructor(e){super(e),this._updatingHandles=new M,this._workerHandle=null,this._debug=null,this._memoizedMakeGetGroundElevation=de(he)}initialize(){let e,t=this.view;if(t==null||t.destroyed)this._tilesOfInterest=new S({layer:this._layer}),e=this._workerHandle=new h;else switch(t.type){case"2d":this._tilesOfInterest=new m({view:t,layer:this._layer}),e=this._workerHandle=new h;break;case"3d":{let{resourceController:i}=t,n=this._layer;this._tilesOfInterest=new y({view:t}),e=this._workerHandle=new h({schedule:r=>i.immediate.schedule(r),hasZ:this._layer.hasZ&&(this._layer.returnZ??!0),elevationAlignPointsInFeatures:async(r,a)=>{let l=await t.whenLayerView(n);return E(a),l.elevationAlignPointsInFeatures(r,a)},queryForSymbologySnapping:async(r,a)=>{let l=await t.whenLayerView(n);return E(a),l.queryForSymbologySnapping(r,a)}}),this.addHandles([t.elevationProvider.on("elevation-change",({context:r})=>{let{elevationInfo:a}=n;le(r,a)&&c(e.notifyElevationSourceChange())}),p(()=>n.elevationInfo,()=>c(e.notifyElevationSourceChange()),_),p(()=>this._layerView?.layer?.renderer,()=>c(e.notifySymbologyChange()),_),p(()=>this._layerView?.symbologySnappingSupported??!1,r=>c(e.setSymbologySnappingSupported(r)),_),G(()=>this._layerView?.layer,["edits","apply-edits","graphic-update"],()=>e.notifySymbologyChange())]);break}}this.addHandles([x(e)]),c(e.setup({layer:this._layer,spatialReference:this.spatialReference,configuration:this.configuration},null)),this._updatingHandles.add(()=>this._updateTilesParameters,()=>c(e.updateTiles(this._updateTilesParameters,null)),_),this.addHandles([p(()=>this.configuration,i=>c(e.configure(i,null)),C),p(()=>this._layer.historicMoment,i=>c(e.setHistoricMoment(i)),z),p(()=>this._outFields,i=>c(e.updateOutFields(i)),_),p(()=>this._isSuspended,i=>c(e.setSuspended(i)),z)]),t!=null&&this.addHandles(p(()=>Y.FEATURE_SERVICE_SNAPPING_SOURCE_TILE_TREE_SHOW_TILES,i=>{i&&!this._debug?(this._debug=new T({view:t,handle:e}),this.addHandles(x(this._debug),"debug")):!i&&this._debug&&this.removeHandles("debug")},_)),this.addHandles([this.layerSource.layer.on("edits",i=>c(e.handleEdits(i,null))),this.layerSource.layer.on("apply-edits",i=>this._updatingHandles.addPromise(i.result))])}destroy(){this._updatingHandles.destroy(),this._tilesOfInterest.destroy()}refresh(){this._workerHandle?.refresh(null)}async fetchCandidates(e,t){let{coordinateHelper:i,point:n}=e;this._tilesOfInterest.pointOfInterest=i.arrayToPoint(n);let r=this._memoizedMakeGetGroundElevation(this.view,i.spatialReference);return(await this._workerHandle.fetchCandidates(O({},e),t)).candidates.map(a=>ue(a,r))}getDebugInfo(e){return this._workerHandle.getDebugInfo(e)}_getOrLoadWhereFields(e,t){let{_whereModule:i}=this;if(!this._loadWhereModuleTask&&!i){let n=j(async()=>{let r=await import("./chunk-EWPE6CE4.js");return this._whereModule=r.default,this._whereModule});return this._loadWhereModuleTask=n,this._updatingHandles.addPromise(n.promise),[]}if(!i)return[];try{return i.create(e,{fieldsIndex:t}).fieldNames}catch{return[]}}};o([s({constructOnly:!0})],d.prototype,"spatialReference",void 0),o([s({constructOnly:!0})],d.prototype,"layerSource",void 0),o([s({constructOnly:!0})],d.prototype,"view",void 0),o([s()],d.prototype,"_tilesOfInterest",void 0),o([s({readOnly:!0})],d.prototype,"_updateTilesParameters",null),o([s()],d.prototype,"_layerView",null),o([s()],d.prototype,"_isSuspended",null),o([s({readOnly:!0})],d.prototype,"updating",null),o([s()],d.prototype,"_outFields",null),o([s({readOnly:!0})],d.prototype,"configuration",null),o([s({readOnly:!0})],d.prototype,"availability",null),o([s()],d.prototype,"_loadWhereModuleTask",void 0),o([s()],d.prototype,"_whereModule",void 0),d=o([f("esri.views.interactive.snapping.featureSources.FeatureServiceSnappingSource")],d);export{d as FeatureServiceSnappingSource};
