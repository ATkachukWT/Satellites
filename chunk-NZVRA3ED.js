import{a as ee,b as j,c as te}from"./chunk-CQPPG6BL.js";import{c as G}from"./chunk-B44Y56KQ.js";import{a as A}from"./chunk-RJZWYGCE.js";import{d as Ce,e as Te,l as Y}from"./chunk-I775TR7R.js";import{c as Oe}from"./chunk-IE6LCR36.js";import{e as be}from"./chunk-WI3QVC6K.js";import{a as Ae}from"./chunk-IDSQ2YJ4.js";import{a as P}from"./chunk-LXEWGICX.js";import{h as K}from"./chunk-CAXK5KYB.js";import{a as Me}from"./chunk-HBMVPT4U.js";import{a as Qe}from"./chunk-WPZN772I.js";import{b as je}from"./chunk-TBA3OZMJ.js";import{a as ve}from"./chunk-CDP4MSRO.js";import{a as _e}from"./chunk-XEZTJAR4.js";import{a as B}from"./chunk-BUP3AMMF.js";import{G as Re,b as Fe,d as O}from"./chunk-KD27XIJC.js";import{g as xe,h as X}from"./chunk-TPFJWNIU.js";import{c as W,d as V,z as J}from"./chunk-6B5XFA6F.js";import{c as k}from"./chunk-BOVYXYHK.js";import{a as ge,d as Se,h as Ee,i as we,v as Ie}from"./chunk-LXFQWIWE.js";import{b as he}from"./chunk-QT6UNBJP.js";import{d as ce}from"./chunk-MWSXMSWY.js";import{a as le}from"./chunk-GJASVPF6.js";import{m as fe}from"./chunk-LFH24RLM.js";import{g as $}from"./chunk-Z5Q7KLA4.js";import{a as Z}from"./chunk-4XZ6X7MQ.js";import{J as ye,ka as me,r as pe,u as de}from"./chunk-KGVXGH6H.js";import{a as ue}from"./chunk-ARRCN5K3.js";import{H as p,J as T}from"./chunk-QHVIRF5H.js";import{I as C}from"./chunk-WZDN6K3C.js";import{a as c}from"./chunk-QGVBCWUY.js";import{b as ae}from"./chunk-CKJ56T2Q.js";import{r as oe,t as H}from"./chunk-UHRSAPGQ.js";import{n as ne,o as se}from"./chunk-V76GWARL.js";var De="esri.views.3d.layers.i3s.I3SMeshViewFilter",N=()=>oe.getLogger(De),f=class extends T{constructor(e){super(e),this._projectionEngineLoaded=!1}initialize(){ce(()=>this.viewFilter?.geometry||this.layerFilter!=null).then(()=>this.loadAsyncModule(import("./chunk-FTLDMWA3.js").then(e=>{this.destroyed||(this._geometryEngine=e)})))}get sortedObjectIds(){if(this.viewFilter?.objectIds==null)return null;let e=Fe(this.viewFilter.objectIds);return e.sort(),e}get parsedWhereClause(){let e=this.viewFilter?.where;if(e==null||!e)return null;try{return be.create(e,{fieldsIndex:this.layerFieldsIndex})}catch(t){N().error(`Failed to parse filter where clause: ${t}`)}return null}addFilters(e,t,r,s){let i=this.sortedObjectIds;i!=null&&e.push(a=>Te(i,!0,a)),this.addSqlFilter(e,this.parsedWhereClause),this.addTimeFilter(e,this.viewFilter?.timeExtent);let n=j(this._layerMaskGeometries),o=this._geometryEngine;if(n!=null&&this.layerFilter!=null&&o!=null){let a=this.layerFilter.spatialRelationship;e.push((u,m)=>Ne(o,u,m,s,t,r,n,a))}let l=j(this._viewMaskGeometries);if(l!=null&&this.viewFilter!=null&&o!=null){let a=this.viewFilter.spatialRelationship;e.push((u,m)=>Ne(o,u,m,s,t,r,l,a))}}isMBSGeometryVisible(e,t,r){let s=j(this._layerMaskGeometries),i=this._geometryEngine;if(s!=null&&this.layerFilter!=null&&i!=null){let o=this.layerFilter.spatialRelationship,l=s[0].spatialReference||t;return A(e,r,D,l)?Ge(i,D,s,l,o):(N().warnOnce("SceneLayer.mask geometry is using unsupported SpatialReference, skipping geometry filter for MBS"),!0)}let n=j(this._viewMaskGeometries);if(n!=null&&this.viewFilter!=null&&i!=null){let o=this.viewFilter.spatialRelationship,l=n[0].spatialReference||t;return A(e,r,D,l)?Ge(i,D,n,l,o):(N().warnOnce("SceneLayerView.filter.geometry is using unsupported SpatialReference, skipping geometry filter for MBS"),!0)}return!0}get parsedGeometry(){let e=j(this._viewMaskGeometries),t=j(this._layerMaskGeometries);return e==null||t==null?e||t:t.concat(e)}get _layerMaskGeometries(){let e=this.layerFilter;return e==null?null:this._geometryEngine==null?ee:e.spatialRelationship==="disjoint"?e.geometries.map(t=>({type:"polygon",rings:t.rings,spatialReference:t.spatialReference,cache:{}})):[e.geometries.reduce((t,r)=>(t.rings=[...t.rings,...r.rings],t),{type:"polygon",rings:[],spatialReference:e.geometries[0].spatialReference,cache:{}})]}get _viewMaskGeometries(){if(this.viewFilter==null)return null;let{geometry:e}=this.viewFilter;if(e==null)return null;if(this.viewFilter==null||this._geometryEngine==null)return ee;let{distance:t,units:r}=this.viewFilter,s=this.viewFilter.spatialRelationship,i=e.type==="mesh"?e.extent:e;if(t==null||t===0)return L(this._geometryEngine,i,s);let n=r||me(i.spatialReference);if(i.spatialReference.isWGS84){let a=this._geometryEngine.geodesicBuffer(i,t,n);return L(this._geometryEngine,a,s)}let o=$(i,Z.WGS84);if(o!=null){let a=$(this._geometryEngine.geodesicBuffer(o,t,n),i.spatialReference);return L(this._geometryEngine,a,s)}if(!this._projectionEngineLoaded&&(this.loadAsyncModule(xe().then(()=>this._projectionEngineLoaded=!0)),!this._projectionEngineLoaded))return null;let l=null;try{l=X(i,Z.WGS84)}catch{}if(l)try{l=X(this._geometryEngine.geodesicBuffer(l,t,n),i.spatialReference)}catch{l=null}return l||N().error(`Filter by geodesic buffer (distance) unsupported, failed to project input geometry (${i.spatialReference.wkid}) to WGS84.`),L(this._geometryEngine,l,s)}get updating(){return te(this._layerMaskGeometries)||te(this._viewMaskGeometries)}static checkSupport(e){return e!=null&&(!!qe(e.spatialRelationship)||(N().warn(`Filters with spatialRelationship other than ${ke.join(", ")} are not supported for mesh scene layers`),!1))}};c([p()],f.prototype,"layerFilter",void 0),c([p({type:Me})],f.prototype,"viewFilter",void 0),c([p()],f.prototype,"layerFieldsIndex",void 0),c([p()],f.prototype,"loadAsyncModule",void 0),c([p()],f.prototype,"addSqlFilter",void 0),c([p()],f.prototype,"addTimeFilter",void 0),c([p({readOnly:!0})],f.prototype,"sortedObjectIds",null),c([p({readOnly:!0})],f.prototype,"parsedWhereClause",null),c([p({readOnly:!0})],f.prototype,"parsedGeometry",null),c([p({readOnly:!0})],f.prototype,"_layerMaskGeometries",null),c([p({readOnly:!0})],f.prototype,"_viewMaskGeometries",null),c([p()],f.prototype,"updating",null),c([p()],f.prototype,"_projectionEngineLoaded",void 0),c([p()],f.prototype,"_geometryEngine",void 0),f=c([C(De)],f);var ke=(e=>e)(["contains","intersects","disjoint"]);function qe(e){return e!=null&&ke.includes(e)}var y;function L(e,t,r){if(t==null)return null;if(r==="disjoint"&&t.type==="polygon"){let s=t.rings.length,i=t.spatialReference,n=new Array(s);for(let a=0;a<s;++a){let u=Se(1/0,1/0,-1/0,-1/0);we(u,t.rings[a]),n[a]={type:"polygon",rings:[t.rings[a]],spatialReference:i,cache:{},aabr:u}}n.sort((a,u)=>a.aabr[0]-u.aabr[0]);let o=new Set,l=new ne;for(let a=0;a<n.length;++a){let u=n[a],m=u.aabr[0];o.forEach(d=>{if(m>=d.aabr[2])return void o.delete(d);if(u.aabr[1]>d.aabr[3]||u.aabr[3]<d.aabr[1]||!e.intersects(u,d))return;u.rings=u.rings.concat(d.rings),Ee(u.aabr,d.aabr,u.aabr),u.cache={},o.delete(d);let g=se(n,d,n.length,l);n.splice(g,1)}),o.add(u)}for(let a of n)a.aabr=void 0;return n}return[t]}function Ge(e,t,r,s,i){if(t[3]>=.5*(t[2]+ye(s).radius))return!0;let n=Ve(e,t,s);return r.every(o=>Je(e,o,n,i)!==y.DISCARD)}function Ne(e,t,r,s,i,n,o,l){let a=o[0].spatialReference||i.spatialReference;if(!A(r.node.serviceMbsInIndexSR,n,D,a))return void N().warnOnce("SceneLayerView.filter.geometry is using unsupported SpatialReference, skipping geometry filter");let u=Ve(e,D,a),m=Ue(l,i,a,s,r.objectHandle);for(let d of o){if(t.length===0)return;switch(Je(e,d,u,l)){case y.DISCARD:return void(t.length=0);case y.KEEP:continue}Ce(t,r.featureIds,g=>ze(e,d,g,m))}}(function(e){e[e.KEEP=0]="KEEP",e[e.DISCARD=1]="DISCARD",e[e.TEST=2]="TEST"})(y||(y={}));var D=K(0,0,0,0);function Ue(e,t,r,s,i){let n=t.renderSpatialReference,o=new Map,l={type:"polygon",rings:[[[0,0,0],[0,0,0],[0,0,0],[0,0,0]]],spatialReference:r};l.rings[0][3]=l.rings[0][0];let a={indices:null,data:null,stride:0,startIndex:0,endIndex:0},u,m;switch(e){case"intersects":u=(d,g,b)=>d.intersects(g,b)?y.KEEP:y.TEST,m=re;break;case"contains":u=(d,g,b)=>d.contains(g,b)?y.TEST:y.DISCARD,m=re;break;default:u=(d,g,b)=>d.disjoint(g,b)?y.TEST:y.DISCARD,m=Pe}return{collection:s,object:i,type:e,maskSR:r,renderSR:n,aabbCache:o,triangle:l,positions:a,triangleTest:u,geometryTest:m}}function Ve(e,t,r){let s={type:"point",x:t[0],y:t[1],hasZ:!1,hasM:!1,spatialReference:r},i=!pe(r)&&!de(r),n=Number.isNaN(t[3])?0:he(t[3],0,2*ue.radius),o=i?e.buffer(s,n,1):e.geodesicBuffer(s,n,1);return o.type="polygon",o}function Je(e,t,r,s){switch(s){case"intersects":case"contains":return re(e,t,r);case"disjoint":return Pe(e,t,r)}}function re(e,t,r){return e.intersects(t,r)?e.contains(t,r)?y.KEEP:y.TEST:y.DISCARD}function Pe(e,t,r){return e.intersects(t,r)?e.contains(t,r)?y.DISCARD:y.TEST:y.KEEP}function ze(e,t,r,s){let{collection:i,object:n,renderSR:o,maskSR:l,geometryTest:a,aabbCache:u}=s,m=u.get(r);if(!m){let F=i.getObjectTransform(n);i.getComponentAabb(n,r,I);let S=[k(I[0],I[1],0),k(I[0],I[4],0),k(I[3],I[4],0),k(I[3],I[1],0)];for(let h=0;h<4;++h)J(S[h],S[h],F.rotationScale),V(S[h],S[h],F.position),P(S[h],o,S[h],l);m={type:"polygon",rings:[S],spatialReference:l,cache:{}},m.rings[0][4]=m.rings[0][0],u.set(r,m)}switch(a(e,t,m)){case y.DISCARD:return!1;case y.KEEP:return!0}let{triangle:d,triangleTest:g,positions:b}=s,_=d.rings[0][0],v=d.rings[0][1],x=d.rings[0][2],M=i.getObjectTransform(n);i.getComponentPositions(n,r,b);let{indices:q,data:w,stride:U,startIndex:Ke,endIndex:Le}=b;for(let F=Ke;F<Le;F+=3){let S=U*q[F],h=U*q[F+1],z=U*q[F+2];switch(W(_,w[S],w[S+1],w[S+2]),W(v,w[h],w[h+1],w[h+2]),W(x,w[z],w[z+1],w[z+2]),J(_,_,M.rotationScale),J(v,v,M.rotationScale),J(x,x,M.rotationScale),V(_,_,M.position),V(v,v,M.position),V(x,x,M.position),P(_,o,_,l),P(v,o,v,l),P(x,o,x,l),g(e,t,d)){case y.DISCARD:return!1;case y.KEEP:return!0}}return s.type!=="intersects"}var I=O();var He=Oe,R=class extends T{constructor(e){super(e)}initialize(){this.addHandles(this.layerView.on("visible-geometry-changed",()=>this.spatialIndex.events.emit("changed")))}destroy(){this._dataQueryEngineInstance=ae(this._dataQueryEngineInstance),this._set("layerView",null)}get spatialReference(){return this.layerView.view.spatialReference}get layer(){return this.layerView.i3slayer}get defaultQueryJSON(){return new je({outSpatialReference:this.spatialReference}).toJSON()}get _dataQueryEngine(){return this._ensureDataQueryEngine()}async executeQueryForCount(e,t){return this._dataQueryEngine.executeQueryForCount(this._ensureQueryJSON(e),t)}async executeQueryForExtent(e,t){let{count:r,extent:s}=await this._dataQueryEngine.executeQueryForExtent(this._ensureQueryJSON(e),t);return{count:r,extent:fe.fromJSON(s)}}async executeQueryForIds(e,t){return this._dataQueryEngine.executeQueryForIds(this._ensureQueryJSON(e),t)}async executeQuery(e,t){let r=this._ensureQueryJSON(e);if(r.returnGeometry)throw new H("unsupported-query","returnGeometry is not supported when querying a mesh scene layer view, it is only supported when directly querying a scene layer");if(r.returnCentroid)throw new H("unsupported-query","returnCentroid is not yet supported for mesh scene layer queries");let s=await this._dataQueryEngine.executeQuery(r,t),i=Qe.fromJSON(s);return i.features.forEach(n=>n.geometry=null),i}_ensureQueryJSON(e){return e==null?this.defaultQueryJSON:e.toJSON()}_ensureDataQueryEngine(){if(this._dataQueryEngineInstance)return this._dataQueryEngineInstance;let e=this.layer.objectIdField||Ae,t="esriGeometryPolygon",r=this.layer.fieldsIndex?.toJSON()||new ve([]),s=this.layerView.view.resourceController.scheduler,i=this.spatialReference.toJSON(),n=this.priority,o=this.spatialIndex;return this._dataQueryEngineInstance=new He({hasZ:!0,hasM:!1,geometryType:t,fieldsIndex:r,timeInfo:null,spatialReference:i,objectIdField:e,featureStore:o,scheduler:s,priority:n}),this._dataQueryEngineInstance}};c([p({constructOnly:!0})],R.prototype,"layerView",void 0),c([p({constructOnly:!0})],R.prototype,"priority",void 0),c([p({constructOnly:!0})],R.prototype,"spatialIndex",void 0),c([p()],R.prototype,"spatialReference",null),c([p()],R.prototype,"layer",null),c([p()],R.prototype,"defaultQueryJSON",null),R=c([C("esri.views.3d.layers.i3s.I3SQueryEngine")],R);var Be=class{constructor(t){this._objectIdField=t.objectIdField,this._getFeatureExtent=t.getFeatureExtent}getObjectId(t){return t.id}getAttributes(t){let{meta:r,index:s}=t,i={};this._objectIdField&&(i[this._objectIdField]=t.id);let n=r.attributeInfo?.attributeData;if(n!=null)for(let o of Object.keys(n))i[o]=Y(n[o],s);return i}getAttribute(t,r){if(r===this._objectIdField)return t.id;let{meta:s,index:i}=t,n=s.attributeInfo?.attributeData;return n!=null?Y(n[r],i):null}getGeometry(t){if(t.geometry)return t.geometry;let[r,s,i,n,o]=this._getFeatureExtent(t,We);return new B([5],[r,s,i,n,s,i,n,o,i,r,o,i,r,s,i])}getCentroid(t,r){if(t.geometry)return _e(new B,t.geometry,r.hasZ,r.hasM);let[s,i,n,o,l,a]=this._getFeatureExtent(t,We);return new B([0],[(s+o)/2,(i+l)/2,(n+a)/2])}cloneWithGeometry(t,r){let{id:s,index:i,meta:n}=t;return new ie(s,i,n,r)}},ie=class{constructor(t,r,s,i){this.id=t,this.index=r,this.meta=s,this.geometry=i}get usedMemory(){return 32+(this.geometry?.usedMemory??0)}},We=O();var Ze=O(),Q=class extends T{constructor(e){super(e),this.events=new le}forEach(e){this.forAllFeatures(t=>(e(t),G.CONTINUE))}forEachBounds(e,t){for(let r of e)t(this.getFeatureExtent(r,Ze))}forEachInBounds(e,t){this.forAllFeatures(r=>{let s=this.getFeatureExtent(r,$e);return Ie(e,Re(s,Xe))&&t(r),G.CONTINUE},r=>{if(A(r.node.serviceMbsInIndexSR,this.sourceSpatialReference,E,this.viewSpatialReference),E[0]>=e[0]&&E[2]<=e[2]&&E[1]>=e[1]&&E[3]<=e[3])return G.CONTINUE;let s=Math.max(e[0],Math.min(E[0],e[2])),i=Math.max(e[1],Math.min(E[1],e[3])),n=E[0]-s,o=E[1]-i;return n*n+o*o<=E[3]*E[3]?G.CONTINUE:G.SKIP})}};c([p({constructOnly:!0})],Q.prototype,"featureAdapter",void 0),c([p({constructOnly:!0})],Q.prototype,"forAllFeatures",void 0),c([p({constructOnly:!0})],Q.prototype,"getFeatureExtent",void 0),c([p({constructOnly:!0})],Q.prototype,"sourceSpatialReference",void 0),c([p({constructOnly:!0})],Q.prototype,"viewSpatialReference",void 0),Q=c([C("esri.views.3d.layers.i3s.I3SQueryFeatureStore")],Q);var E=K(0,0,0,0),$e=O(),Xe=ge();export{f as a,R as b,Be as c,ie as d,Q as e};
