import{a as ye,c as be,d as Ce}from"./chunk-H7DCRSK5.js";import{a as _e}from"./chunk-2EE5YRTN.js";import{b as Ht}from"./chunk-2V2KUC4L.js";import{a as ge,b as At}from"./chunk-LG3C3MKX.js";import{c as Mt,d as Dt,e as kt}from"./chunk-FL7OPLFN.js";import{d as xt,e as ht}from"./chunk-3VYKLHOM.js";import"./chunk-LKA3X57N.js";import"./chunk-NWNJEGEK.js";import"./chunk-KBHP2G24.js";import"./chunk-ALYBHVUD.js";import"./chunk-CZNLG4Q3.js";import"./chunk-CRVFDW2R.js";import"./chunk-INZW3TXV.js";import"./chunk-USV42SA7.js";import{b as Et}from"./chunk-2IZGBHXN.js";import"./chunk-2CQRLDTB.js";import"./chunk-Q5KIWWVU.js";import{a as Vt,b as St}from"./chunk-QLZDPV4K.js";import{b as Pt,d as me}from"./chunk-JYUV3HWY.js";import"./chunk-R7MBZ4JV.js";import"./chunk-DSVUPQIZ.js";import"./chunk-KLXERNY4.js";import"./chunk-KRDCB7BJ.js";import{a as fe}from"./chunk-PQNOJ4XM.js";import{a as pt}from"./chunk-2TGLTRKB.js";import"./chunk-MOHGYSPI.js";import{b as ve}from"./chunk-KT2IZTJQ.js";import"./chunk-7S2234XQ.js";import"./chunk-5QOQFLF6.js";import"./chunk-2I3LIA7G.js";import"./chunk-5DVGZXEZ.js";import"./chunk-BENEV3E6.js";import"./chunk-R3G2IXBO.js";import"./chunk-PXDIM3V6.js";import{a as Rt}from"./chunk-63BBKXWS.js";import{c as G}from"./chunk-62UTK67Z.js";import"./chunk-UWWX7VSW.js";import"./chunk-CFF33S4D.js";import{b as nt}from"./chunk-XY4QPRKP.js";import{a as he}from"./chunk-UV6SBQOQ.js";import"./chunk-OWV7FEAY.js";import{f as ce,m as pe,p as It}from"./chunk-2XYAAYOE.js";import"./chunk-BVDJBTNQ.js";import"./chunk-LSUWBOLF.js";import"./chunk-LHI3UGTZ.js";import"./chunk-6SGUOKGX.js";import"./chunk-LCFWGHLF.js";import"./chunk-XACQ2RJ5.js";import{b as de}from"./chunk-3TRID6QS.js";import{d as Tt}from"./chunk-VUJT53YX.js";import"./chunk-WUXNV6ZW.js";import"./chunk-PM3EZWDJ.js";import"./chunk-PSFZFYFC.js";import"./chunk-WIFM6OT5.js";import{a as J,b as ot}from"./chunk-GI4NW5SA.js";import"./chunk-T5NHE3SD.js";import"./chunk-SWCOPTUX.js";import"./chunk-7EWNVUY7.js";import"./chunk-SXYHD4V6.js";import"./chunk-FSW536RM.js";import"./chunk-YNDA4ZZB.js";import"./chunk-JAN3FVXP.js";import"./chunk-F4HA2HQL.js";import"./chunk-BSKAVVQS.js";import"./chunk-AEU2INWT.js";import"./chunk-Z4UBZ6W2.js";import"./chunk-CMKJEBQJ.js";import"./chunk-AQMR24IC.js";import"./chunk-3J3Q4LMA.js";import"./chunk-PSNQ2KG3.js";import"./chunk-V4ZQZTCB.js";import"./chunk-PEYNLMWW.js";import"./chunk-6L543SC5.js";import"./chunk-CUV3BSEW.js";import"./chunk-6FI5AY7X.js";import"./chunk-ZCAR53EN.js";import"./chunk-DH67ILIV.js";import"./chunk-7GUYYJRR.js";import"./chunk-WS4AMEGN.js";import"./chunk-CU7FHMWW.js";import"./chunk-CSFAHB4Y.js";import"./chunk-PTXLSCMJ.js";import"./chunk-NRRX2M6N.js";import"./chunk-PMLKCTEJ.js";import"./chunk-MYO2G5ZH.js";import"./chunk-YVCKQBWT.js";import"./chunk-4XEE5PE3.js";import"./chunk-MBNZK2RR.js";import"./chunk-DV6KBPBR.js";import"./chunk-XWEUR6F7.js";import"./chunk-KALTBP5D.js";import"./chunk-O2J7LFYY.js";import"./chunk-422PSKZ7.js";import"./chunk-SFANISLX.js";import"./chunk-5L4CW2H2.js";import"./chunk-UJ7KVQR6.js";import"./chunk-B74L7AUE.js";import"./chunk-MJO3PLZV.js";import"./chunk-YU3IFRYW.js";import"./chunk-XKFJ6GWH.js";import"./chunk-GSXOR3JU.js";import"./chunk-55OTJIMU.js";import"./chunk-EM2AEAFS.js";import"./chunk-VGAXEXH3.js";import"./chunk-YEPHAEAY.js";import"./chunk-76X7RFM4.js";import"./chunk-HMNTGQTR.js";import"./chunk-ZLIWNUFM.js";import"./chunk-GVSOJUIP.js";import"./chunk-GWSX6PRO.js";import"./chunk-ELCBU4NP.js";import"./chunk-GMZFCQJQ.js";import"./chunk-5WDH2LXO.js";import"./chunk-L7NOU4T2.js";import"./chunk-SU7IJ65K.js";import"./chunk-WOZSH7YY.js";import"./chunk-2PJRHNJW.js";import"./chunk-B2RVSTL3.js";import"./chunk-2CKJLDTO.js";import"./chunk-F6TN7E7K.js";import"./chunk-HUUJBVXR.js";import"./chunk-4LDVFWME.js";import"./chunk-A45BLB26.js";import"./chunk-DFYW3Y3B.js";import"./chunk-UBQPWKE4.js";import{a as ae,e as le}from"./chunk-YSD7LK2L.js";import"./chunk-LXEWGICX.js";import"./chunk-NIYDRLW4.js";import"./chunk-4K47EN3B.js";import"./chunk-FSWSNKJD.js";import"./chunk-MVDZB4AK.js";import"./chunk-ESSDCWGF.js";import"./chunk-WVKBXQWE.js";import"./chunk-FGEB67EG.js";import"./chunk-YEXMIDOT.js";import"./chunk-GV3ZFCVD.js";import"./chunk-SOEEM7Z7.js";import"./chunk-T7PUQGWM.js";import"./chunk-44A27HB7.js";import"./chunk-47NSYSFY.js";import"./chunk-QXNVQZT7.js";import"./chunk-CAXK5KYB.js";import{a as dt,b as ue,d as wt,e as ct}from"./chunk-3CCK7BDD.js";import"./chunk-LNYBTIG7.js";import"./chunk-VYZHOYXV.js";import"./chunk-K7YQAHQ7.js";import"./chunk-XAHD7XBV.js";import"./chunk-J6YGDWJF.js";import"./chunk-YQNUGDFH.js";import"./chunk-QCZ3ZIGQ.js";import"./chunk-RZU6EEB3.js";import"./chunk-ONYJLWAD.js";import{e as se}from"./chunk-VMECOA4F.js";import"./chunk-PHODKV66.js";import"./chunk-JPMGMA4B.js";import"./chunk-3REMXE4W.js";import"./chunk-4ABKPPKG.js";import"./chunk-PMVQ5DJK.js";import"./chunk-I4Q2S2XA.js";import"./chunk-V774RJYN.js";import"./chunk-L2WNUKLP.js";import"./chunk-XITT4JU2.js";import"./chunk-ZBX6HJOS.js";import"./chunk-BSMAMABT.js";import"./chunk-LYNAYPL3.js";import"./chunk-ULANM5YP.js";import{h as ne,q as re}from"./chunk-77L5NP7A.js";import{a as h}from"./chunk-KAMRW6HF.js";import"./chunk-6DGDLLNL.js";import"./chunk-UWWWQ44M.js";import"./chunk-BHB4UQZT.js";import"./chunk-DJW5LMRG.js";import"./chunk-SEJXLJ5V.js";import"./chunk-MPAJA3DL.js";import{a as ie}from"./chunk-ALWV3RJ2.js";import"./chunk-DEH76MSI.js";import{a as Z}from"./chunk-DVBZA6ZU.js";import{a as Lt}from"./chunk-LAVV77UH.js";import"./chunk-VTGWQ7AP.js";import"./chunk-PHNFWHVF.js";import{o as oe}from"./chunk-DTU6MHUX.js";import"./chunk-NFXNGFHZ.js";import"./chunk-W26XKMAT.js";import"./chunk-NQWYPF77.js";import{d as et,f as Ct}from"./chunk-KRAKR4MK.js";import"./chunk-MCO7DSFO.js";import"./chunk-D7WE3OBT.js";import"./chunk-JTDXB5TK.js";import"./chunk-XCIPBOI4.js";import"./chunk-CWUY5SXW.js";import"./chunk-KD27XIJC.js";import{j as tt}from"./chunk-TPFJWNIU.js";import"./chunk-P25RU3X5.js";import"./chunk-XRRQM4E2.js";import"./chunk-GWBRHLNH.js";import"./chunk-G7TP3ZYQ.js";import"./chunk-Y6YEAKJ5.js";import"./chunk-S52JRLJC.js";import"./chunk-U4TLMQTY.js";import"./chunk-PDQQY7RQ.js";import"./chunk-W5OI4BJ2.js";import"./chunk-RWCIDBNQ.js";import"./chunk-2NH7HOKA.js";import"./chunk-HM5RIVQC.js";import"./chunk-EM35R6FY.js";import"./chunk-2ZFXOJDB.js";import"./chunk-QXXXCEV5.js";import{E as ee,G as Ot,H as N,b as O,d as k,e as U,n as x,u as it}from"./chunk-6B5XFA6F.js";import"./chunk-HP4LYRR4.js";import"./chunk-AFC2H4Q3.js";import{i as te}from"./chunk-OLOKUDVI.js";import"./chunk-4G7UTTZJ.js";import"./chunk-ZTOZWLEE.js";import"./chunk-RJWOVI3M.js";import"./chunk-SP2CO3KX.js";import"./chunk-NRBJLISB.js";import"./chunk-PTZYZULI.js";import"./chunk-NMLYCCKN.js";import"./chunk-RSDQHAJX.js";import{a as m,b as Y,e as M}from"./chunk-BOVYXYHK.js";import"./chunk-FENRIY2T.js";import"./chunk-HX2VGIR2.js";import"./chunk-64QN2VGD.js";import"./chunk-JGEVVXD4.js";import"./chunk-B3FO6PT7.js";import"./chunk-C4UMJHQC.js";import"./chunk-BCREO4Q5.js";import{B as Yt,s as Xt,t as bt}from"./chunk-LXFQWIWE.js";import"./chunk-QT6UNBJP.js";import"./chunk-SLAWDKDA.js";import{a as lt,i as T,j as Qt}from"./chunk-MWSXMSWY.js";import{f as $t}from"./chunk-JRCKELO6.js";import"./chunk-KJULKTB5.js";import"./chunk-LACL4BQ2.js";import{c as Kt}from"./chunk-YR2HD3ZC.js";import{a as at}from"./chunk-GJASVPF6.js";import"./chunk-UBFCO3DV.js";import"./chunk-NI7FJV5X.js";import"./chunk-BUSG3ZOF.js";import"./chunk-XZIOXVVJ.js";import"./chunk-EXJYW3PC.js";import"./chunk-SXQPBCOX.js";import"./chunk-LFH24RLM.js";import{n as ut}from"./chunk-Z5Q7KLA4.js";import"./chunk-X4LNX4BR.js";import"./chunk-4XZ6X7MQ.js";import"./chunk-WLHY3MMA.js";import"./chunk-KGVXGH6H.js";import"./chunk-ARRCN5K3.js";import"./chunk-LXQPIAN7.js";import"./chunk-FTDD7QBB.js";import"./chunk-DB3UIQCU.js";import"./chunk-SBHKMV3P.js";import"./chunk-R4A63S45.js";import"./chunk-ETE32IYO.js";import"./chunk-ONUGDWDK.js";import"./chunk-SG7CQU4O.js";import{H as r,J as w,g as B}from"./chunk-QHVIRF5H.js";import{I as b}from"./chunk-WZDN6K3C.js";import{a as n}from"./chunk-QGVBCWUY.js";import"./chunk-OJQ73TPF.js";import"./chunk-354SCPDU.js";import"./chunk-OVHPPCBL.js";import"./chunk-IYZFKXJ6.js";import{E as Jt,b as I,e as yt,g as Zt,j as st,m as X}from"./chunk-CKJ56T2Q.js";import"./chunk-SNFOAZZQ.js";import"./chunk-F6JAWRPN.js";import{b as Q,r as q}from"./chunk-UHRSAPGQ.js";import{h as qt}from"./chunk-V76GWARL.js";import{a as A,b as H}from"./chunk-N2WTMF3X.js";var z=class extends w{constructor(t){super(t),this.target=null,this.intersectedGraphic=null,this.intersectedLocation=null,this.elevationAlignedTargetLocation=null,this.visible=void 0}};n([r()],z.prototype,"target",void 0),n([r()],z.prototype,"intersectedGraphic",void 0),n([r()],z.prototype,"intersectedLocation",void 0),n([r()],z.prototype,"elevationAlignedTargetLocation",void 0),n([r({type:Boolean})],z.prototype,"visible",void 0),z=n([b("esri.views.3d.analysis.LineOfSightAnalysisResult")],z);var Oe=z;var D=class extends w{constructor(t){super(t),this.elevationAlignedTargetLocation=null,this.inputPoints={isValid:!1,observer:m(),observerSurfaceNormal:null,observerFeatureId:null,target:m(),targetSurfaceNormal:null,targetFeatureId:null,observerAdjusted:m(),targetAdjusted:m()},this.computationResult={start:m(),end:m(),intersection:m(),isValid:!1,isTargetVisible:!1},this.result=null}notifyResultChanged(){this.notifyChange("computationResult")}notifyInputPointsChanged(){this.notifyChange("inputPoints")}};n([r()],D.prototype,"target",void 0),n([r()],D.prototype,"elevationAlignedTargetLocation",void 0),n([r()],D.prototype,"inputPoints",void 0),n([r()],D.prototype,"computationResult",void 0),n([r()],D.prototype,"result",void 0),D=n([b("esri.views.3d.analysis.LineOfSight.LineOfSightComputation")],D);var Gt,P=Gt=class extends w{constructor(t){super(t)}clone(){return new Gt({type:this.type,id:Q(this.id),mapPoint:Q(this.mapPoint),renderPoint:Y(this.renderPoint),normal:Q(this.normal),ray:Q(this.ray),graphic:this.graphic})}equals(t){return this.type===t.type&&this.id===t.id&&Zt(this.mapPoint,t.mapPoint)&&ee(this.renderPoint,t.renderPoint)&&qt(this.normal,t.normal)&&ue(this.ray,t.ray)&&this.graphic===t.graphic}};n([r()],P.prototype,"type",void 0),n([r({constructOnly:!0})],P.prototype,"id",void 0),n([r({constructOnly:!0})],P.prototype,"mapPoint",void 0),n([r({constructOnly:!0})],P.prototype,"renderPoint",void 0),n([r({constructOnly:!0})],P.prototype,"normal",void 0),n([r({constructOnly:!0})],P.prototype,"graphic",void 0),n([r({constructOnly:!0})],P.prototype,"ray",void 0),P=Gt=n([b("esri.views.3d.analysis.LineOfSight.LineOfSightIntersectionResult")],P);var F=class extends w{constructor(t){super(t),this._terrainIntersectionOptionsLayerUids=new Set(["terrain"])}initialize(){this.intersector=de(this.view.state.viewingMode),this.intersector.options.hud=!1,this.intersector.options.store=ot.MIN}getScreenPointIntersection(t){let e=te(t,se.get()),i=ve(this.view.state.camera,e,zt);return this._getRayIntersection(i)}_getRayIntersection(t,e){let{view:i,intersector:o}=this;if(t==null||i.sceneIntersectionHelper==null)return null;o.options.store=ot.MIN,i.sceneIntersectionHelper.intersectToolIntersectorRay(t,o,e);let s=o.results.min;if(s.target==null)return null;let l=m();if(!s.getIntersectionPoint(l)||e?.maxDistance!=null&&!s.withinDistance(e.maxDistance))return null;let a=i.renderCoordsHelper.fromRenderCoords(l,new ut({spatialReference:i.spatialReference})),p=Y(s.normal);if(he(s))return new P({type:J.TERRAIN,id:s.target.lij.slice(),mapPoint:a,renderPoint:l,normal:p,ray:wt(t),graphic:null});let d=nt(s,i);if(d==null)return null;let{layer:c,sourceLayer:u}=d,g=u?.type==="scene"?oe(d,u.objectIdField):d.uid;return new P({type:J.OBJECT,id:`${c?.uid}/${g}`,mapPoint:a,renderPoint:l,normal:p,ray:wt(t),graphic:d})}updateFromGroundIntersection(t,e,i){let o=Ee,s=Ae,l=He,a=we;O(s,t),this.view.renderCoordsHelper.worldUpAtPosition(s,l),it(l,l);let p=this.view.basemapTerrain.visibleElevationBounds,d=(e>=0?1:-1)*((p?Math.abs(p.max-p.min):100)+Math.abs(e));x(a,l,d),k(o,s,a),ct(o,s,zt);let c=this._getRayIntersection(zt,{include:this._terrainIntersectionOptionsLayerUids,maxDistance:d});if(c!=null){let u=we;return x(u,l,e),k(i,c.renderPoint,u),Y(c.normal)}return O(i,t),null}};n([r()],F.prototype,"view",void 0),n([r()],F.prototype,"intersector",void 0),F=n([b("esri.views.3d.analysis.LineOfSight.LineOfSightRayIntersector")],F);var Ee=m(),Ae=m(),He=m(),we=m(),zt=dt();var f=class extends at.EventedMixin(w){constructor(t){super(t),this.updateOnCameraChange=!0,this._observerGroundOffsetRenderSpace=0,this._effectiveObserverElevationMode="absolute-height",this._observerFeatureId=null,this._updatingHandles=new Z,this._frameTask=Ct,this._computationHandles=new B,this._externalObserverUpdate=!0}initialize(){let t=this.view.resourceController?.scheduler;this._frameTask=t?t.registerTask(et.LINE_OF_SIGHT_TOOL):Ct,this._intersector=new F({view:this.view}),this.addHandles([this._connectObserver(),this._connectComputations(),this._connectTargets()])}destroy(){this._computationHandles.destroy(),this._computations.removeAll(),this._updatingHandles.destroy()}get updating(){return this._frameTask.updating||this._updatingHandles.updating}get priority(){return this._frameTask.priority}set priority(t){this._frameTask.priority=t}get _computations(){return this.analysisViewData.computations}get _elevationAlignedObserverPositionRenderSpace(){return this.analysisViewData.observerEngineLocation}set _elevationAlignedObserverPositionRenderSpace(t){this.analysisViewData.observerEngineLocation=t}get _screenPixelSize(){return this.view.state.camera.computeScreenPixelSizeAt(this._elevationAlignedObserverPositionRenderSpace)}_computeResult(t){let e=t.computation,{inputPoints:i,computationResult:o}=e,{observerAdjusted:s,targetAdjusted:l}=i,{start:a,end:p}=o;O(a,s),O(p,l),this._canCompute(e)?this._computeIntersection(t):Me(t),e.notifyResultChanged(),this.emit("result-changed",{target:t.computation.target,result:e.result})}_adjustStartEndPositions(t){let{view:e}=this,{inputPoints:i}=t,{observer:o,target:s,observerAdjusted:l,targetAdjusted:a}=i;O(l,o),O(a,s),me(e,this._intersector.intersector,i);let{observerSurfaceNormal:p,targetSurfaceNormal:d}=i,c=this._screenPixelSize,u=gt;p!=null?O(u,p):U(u,a,l);let g=c;it(u,u),x(u,u,Math.min(g,1)),k(l,l,u),d!=null?O(u,d):U(u,l,a);let v=e.state.camera.computeScreenPixelSizeAt(a);it(u,u),x(u,u,Math.min(v,1)),k(a,a,u)}_computeIntersection({computation:t,interpolationInfo:e}){let{view:i}=this,{sceneIntersectionHelper:o,renderCoordsHelper:s}=i;if(o==null)return;let l=this._intersector.intersector,{computationResult:a,inputPoints:p}=t,{observer:d,target:c}=p,{start:u,end:g}=a,v=ct(u,g,ke);l.options.store=ot.MIN,o.intersectToolIntersectorRay(v,l);let R=l.results.min,S=a.intersection,$=gt,_=!0;if(R!=null&&R.getIntersectionPoint(S)){O(e.originalIntersection,S),O(e.originalObserver,u),O(e.originalTarget,g),s.fromRenderCoords(S,$,i.spatialReference);let L=1-N(g,c)/N(u,c);_=N(d,S)>=L*N(d,c)}let j=new ut($,i.spatialReference);{let{result:L,target:E}=t;L!=null?(L.target=E,L.intersectedGraphic=_?null:nt(R,i),L.intersectedLocation=_?null:j,L.visible=_):t.result=new Oe({target:E,elevationAlignedTargetLocation:t.elevationAlignedTargetLocation,intersectedGraphic:_?null:nt(R,i),intersectedLocation:_?null:j,visible:_})}a.isValid=p.isValid=!0,a.isTargetVisible=_}_canCompute(t){let e=this.analysisViewData.elevationAlignedObserver,i=this.view.frustum;if(e==null||t.elevationAlignedTargetLocation==null||i==null)return!1;let{observerAdjusted:o,targetAdjusted:s}=t.inputPoints,l=i.intersectsPoint(o),a=i.intersectsPoint(s);return l&&a}_onObserverPositionChange(t,e,i,o,s){if(this._externalObserverUpdate=s,t==null)return this.analysisViewData.elevationAlignedObserver=null,void(this._observerFeatureId=null);if(e==null)return xt(this.analysis,t.spatialReference,q.getLogger(this)),void(this.analysisViewData.elevationAlignedObserver=null);let l=Te(e,i),{absoluteZ:a,elevation:p}=It(e.x,e.y,e.z,this.view.spatialReference,this.view,l),d=e.clone();d.z=a,this._effectiveObserverElevationMode=l.mode,this.analysisViewData.elevationAlignedObserver=d;let c=m();this.view.renderCoordsHelper.toRenderCoords(d,c),this._elevationAlignedObserverPositionRenderSpace=c,this._observerGroundOffsetRenderSpace=a-p,this._observerFeatureId=Pt(o),this.priority=et.LINE_OF_SIGHT_TOOL_INTERACTIVE}_onObserverRenderSpacePositionChangeForComputation(t,e,i,o,s){let{inputPoints:l}=t;switch(O(l.observer,e),l.observerFeatureId=s,l.observerSurfaceNormal=null,o){case"on-the-ground":case"relative-to-ground":{let a=this._intersector.updateFromGroundIntersection(l.observer,i,l.observer);l.observerFeatureId==null&&(l.observerSurfaceNormal=a)}}this._adjustStartEndPositions(t),t.notifyInputPointsChanged(),this.priority=et.LINE_OF_SIGHT_TOOL_INTERACTIVE}_onTargetPositionChange(t,e,i,o,s,l=!0){let a=t.inputPoints;if(l&&(a.isValid=!1),i==null)return e!=null&&xt(this.analysis,e.spatialReference,q.getLogger(this)),t.elevationAlignedTargetLocation=null,void t.notifyInputPointsChanged();let p=Te(i,o),{absoluteZ:d,elevation:c}=It(i.x,i.y,i.z,this.view.spatialReference,this.view,p),u=i.clone();switch(u.z=d,t.elevationAlignedTargetLocation=u,this.view.renderCoordsHelper.toRenderCoords(t.elevationAlignedTargetLocation,a.target),a.targetFeatureId=Pt(s),a.targetSurfaceNormal=null,p.mode){case"on-the-ground":case"relative-to-ground":{let g=this._intersector.updateFromGroundIntersection(a.target,d-c,a.target);a.targetFeatureId==null&&(a.targetSurfaceNormal=g)}}this._adjustStartEndPositions(t),t.notifyInputPointsChanged(),this.priority=et.LINE_OF_SIGHT_TOOL_INTERACTIVE}_connectComputationToTarget(t){return X([this._updatingHandles.add(()=>({computation:t,targetPosition:t.target.position,targetElevationInfo:t.target.elevationInfo,targetFeatureInfo:t.target.feature,projectedTargetPosition:tt(t.target.position,this.view.spatialReference)}),({computation:e,targetPosition:i,targetElevationInfo:o,targetFeatureInfo:s,projectedTargetPosition:l})=>{l.pending==null?this._onTargetPositionChange(e,i,l.geometry,o,s):this._updatingHandles.addPromise(l.pending)},T)])}_connectComputationToObserver(t){return this._updatingHandles.add(()=>({computation:t,observer:this.analysisViewData.elevationAlignedObserver}),({computation:e})=>{this._externalObserverUpdate&&(e.inputPoints.isValid=!1,e.notifyInputPointsChanged())},T)}_connectComputationToRenderSpaceObserver(t){return this._updatingHandles.add(()=>({computation:t,observer:this._elevationAlignedObserverPositionRenderSpace,observerGroundOffset:this._observerGroundOffsetRenderSpace,observerElevationMode:this._effectiveObserverElevationMode,observerFeatureId:this._observerFeatureId}),({computation:e,observer:i,observerGroundOffset:o,observerElevationMode:s,observerFeatureId:l})=>{this._onObserverRenderSpacePositionChangeForComputation(e,i,o,s,l)},T)}_connectComputationToCamera(t){return this._updatingHandles.add(()=>({camera:this.view.state.camera,isDirty:this._isCameraDirty}),({isDirty:e})=>{!this.updateOnCameraChange||t.inputPoints.isValid&&!e||t.notifyInputPointsChanged()})}_connectComputationToSlicePlane(t){return this._updatingHandles.add(()=>this.view.slicePlane,()=>{t.inputPoints.isValid=!1,t.notifyInputPointsChanged()})}_connectComputationToElevation(t){let e=(i,o)=>{let s=this.analysis.observer,l=t.target,a=null,p=null,d=null,c=null,u=null,g=null;if(s?.position!=null){let v=tt(s.position,this.view.spatialReference);if(v.pending!=null)return this._updatingHandles.addPromise(v.pending),void v.pending.finally(()=>e(i,o));a=v.geometry,p=s.elevationInfo,d=s.feature}if(l.position!=null){let v=tt(l.position,this.view.spatialReference);if(v.pending!=null)return this._updatingHandles.addPromise(v.pending),void v.pending.finally(()=>e(i,o));c=v.geometry,u=l.elevationInfo,g=l.feature}a==null&&c==null||(fe(i,o,mt,this.view.spatialReference),a!=null&&bt(mt,a)&&this._onObserverPositionChange(s!=null?s.position:null,a,p,d,!1),c!=null&&bt(mt,c)&&this._onTargetPositionChange(t,l.position,c,u,g,!1),a!=null&&c!=null&&Xt(mt,a,c)&&t.notifyInputPointsChanged())};return this.view.elevationProvider.on("elevation-change",({extent:i,spatialReference:o})=>e(i,o))}_connectComputationToTask(t){let e=null,i={computation:t,interpolationInfo:{originalIntersection:m(),originalObserver:m(),originalTarget:m()}};return X([this._updatingHandles.add(()=>t.inputPoints,()=>{e=yt(e),e=$t(async o=>{await Jt(this._frameTask.schedule(()=>this._computeResult(i),o))})},{initial:!0,equals:()=>!1}),st(()=>e=yt(e))])}_connectComputation(t){let e=this._computationHandles;e.has(t)||e.add([this._connectComputationToTarget(t),this._connectComputationToObserver(t),this._connectComputationToRenderSpaceObserver(t),this._connectComputationToCamera(t),this._connectComputationToSlicePlane(t),this._connectComputationToElevation(t),this._connectComputationToTask(t)],t)}_disconnectComputation(t){this._computationHandles.remove(t)}_onComputationCollectionChange({added:t,removed:e}){for(let i of e)this._disconnectComputation(i);for(let i of t)this._connectComputation(i)}_onTargetCollectionChange({added:t,removed:e}){for(let i of e)this._removeTarget(i);for(let i of t)this._addTarget(i)}_onCursorTargetChange(t,e){e!=null&&this._removeTarget(e),t!=null&&this._addTarget(t)}_addTarget(t){this._computations.some(e=>e.target===t)||this._computations.add(new D({target:t}))}_removeTarget(t){let e=this._computations.findIndex(i=>i.target===t);this._computations.removeAt(e)}_connectObserver(){return X([this._updatingHandles.add(()=>({observerPosition:this.analysis.observer!=null?this.analysis.observer.position:null,projectedObserverPosition:tt(this.analysis.observer!=null?this.analysis.observer.position:null,this.view.spatialReference),observerElevationInfo:this.analysis.observer!=null?this.analysis.observer.elevationInfo:null,observerFeatureInfo:this.analysis.observer!=null?this.analysis.observer.feature:null}),({observerPosition:t,projectedObserverPosition:e,observerElevationInfo:i,observerFeatureInfo:o})=>{e.pending==null?this._onObserverPositionChange(t,e.geometry,i,o,!0):this._updatingHandles.addPromise(e.pending)},T)])}_connectComputations(){return this._updatingHandles.addOnCollectionChange(()=>this._computations,t=>this._onComputationCollectionChange(t),{initial:!0,final:!0})}_connectTargets(){return X([this._updatingHandles.addOnCollectionChange(()=>this.analysis.targets,t=>this._onTargetCollectionChange(t),{initial:!0,final:!0}),this._updatingHandles.add(()=>this.analysisViewData.cursorTarget,(t,e)=>{this._onCursorTargetChange(t,e)})])}get _isCameraDirty(){let t=this.analysisViewData.elevationAlignedObserver,{view:e}=this,{renderCoordsHelper:i}=e;if(t==null||i==null)return!1;let o=gt;i.toRenderCoords(t,o);let s=e.state.camera.computeScreenPixelSizeAt(o);return Math.abs((s-this._screenPixelSize)/this._screenPixelSize)>De}};function Te(t,e){return t.hasZ?e??{mode:"absolute-height",offset:0}:{mode:"on-the-ground",offset:0}}function Me({computation:t,interpolationInfo:e}){let{computationResult:i,inputPoints:o}=t,{start:s,end:l,intersection:a}=i,{originalIntersection:p,originalObserver:d,originalTarget:c}=e;if(O(a,p),o.isValid){let u=gt,g=N(d,p)/N(d,c);Ot(u,s,d),x(u,u,1-g),k(a,a,u),Ot(u,l,c),x(u,u,g),k(a,a,u),i.isValid=!0}else t.result=null,i.isValid=!1,i.isTargetVisible=!1}n([r({constructOnly:!0})],f.prototype,"analysis",void 0),n([r({constructOnly:!0})],f.prototype,"analysisViewData",void 0),n([r({constructOnly:!0})],f.prototype,"view",void 0),n([r()],f.prototype,"updating",null),n([r()],f.prototype,"priority",null),n([r()],f.prototype,"updateOnCameraChange",void 0),n([r()],f.prototype,"_computations",null),n([r()],f.prototype,"_elevationAlignedObserverPositionRenderSpace",null),n([r()],f.prototype,"_observerGroundOffsetRenderSpace",void 0),n([r()],f.prototype,"_effectiveObserverElevationMode",void 0),n([r()],f.prototype,"_observerFeatureId",void 0),n([r()],f.prototype,"_screenPixelSize",null),n([r({readOnly:!0})],f.prototype,"_updatingHandles",void 0),n([r()],f.prototype,"_frameTask",void 0),n([r()],f.prototype,"_isCameraDirty",null),f=n([b("esri.views.3d.analysis.LineOfSight.LineOfSightController")],f);var De=.1,gt=m(),ke=dt(),mt=Yt();var Ft=class{constructor(){this.glowWidth=8,this.innerWidth=.75}},Le=new Ft;function Ie(t){let e=t.accentColor;return{glowColor:e,innerColor:ne(e),globalAlpha:.75*e.a}}var jt=class{constructor(){this.size=.5}},Pe=new jt;function Nt(t){return re(t.accentColor,.75)}var Bt=class{constructor(){this.size=.5,this.visibleColor=new h([3,252,111,.75]),this.occludedColor=new h([252,3,69,.75]),this.undefinedColor=new h([127,127,127,.75])}},Ve=new Bt,Ut=class{constructor(){this.innerWidth=2,this.outerWidth=8,this.visibleInnerColor=new h([3,252,111,1]),this.visibleOuterColor=new h([3,252,111,.15]),this.occludedInnerColor=new h([252,3,69,1]),this.occludedOuterColor=new h([252,3,69,.1]),this.undefinedInnerColor=new h([255,255,255,1]),this.undefinedOuterColor=new h([127,127,127,.2])}},rt=new Ut;var vt=class extends Mt{constructor(e,i){let o=kt(Nt(e.effectiveTheme)),s=Tt(o,Pe.size,32,32),l=new Dt(s);super({view:e,renderObjects:[l],metadata:i,elevationInfo:{mode:"absolute-height",offset:0}}),Ht(this),this.themeHandle=lt(()=>({color:Nt(e.effectiveTheme)}),a=>{o.setParameters(a)})}destroy(){this.themeHandle.remove(),super.destroy()}},ft=class extends Mt{constructor(e,i){let{size:o,visibleColor:s,occludedColor:l,undefinedColor:a}=Ve;super({view:e,renderObjects:[Wt(o,s,G.Custom1),Wt(o,l,G.Custom2),Wt(o,a,G.Custom3)],metadata:i,elevationInfo:{mode:"absolute-height",offset:0}}),Ht(this)}};function Wt(t,e,i){return new Dt(Tt(kt(h.toUnitRGBA(e)),t,32,32),i)}var W;(function(t){t.Ready="ready",t.Creating="creating",t.Created="created"})(W||(W={}));var y=class extends ye{constructor(t){super(t),this._creationMode=!1,this.removeIncompleteOnCancel=!1,this.analysisViewData=null,this._latestPointerMovePointerType=null,this._laserlineVisualElement=null,this._grabbedManipulator=null,this._analysisHandles=new B,this._updatingHandles=new Z,this._manipulatorHandles=new B,this._targetTrackerManipulator=null}initialize(){this._intersector=new F({view:this.view}),this.addHandles(lt(()=>this.state,t=>{t===W.Created&&this.finishToolCreation()},Qt)),this._observerManipulator=this._createObserverManipulator(),this._createLaserLine(),this.addHandles([this._updatingHandles.add(()=>this.analysisViewData?.elevationAlignedObserver,t=>this._onObserverLocationChange(t),T),this._updatingHandles.add(()=>Ie(this.view.effectiveTheme),({glowColor:t,innerColor:e,globalAlpha:i})=>this._updateLaserLineStyle(t,e,i),T),this._updatingHandles.add(()=>this._laserLineRendererDependencies(),t=>this._updateLaserLineRenderer(t)),this._connectComputations(),this._updatingHandles.addWhen(()=>!this._shouldRenderTracker,()=>this._clearCursorTracker(),T),this._updatingHandles.add(()=>({active:this.active,hasGrabbedManipulators:this.hasGrabbedManipulators}),({active:t,hasGrabbedManipulators:e})=>{this._creationMode=!!t&&(this._creationMode||!e)},T)])}destroy(){this._updatingHandles=I(this._updatingHandles),this._manipulatorHandles=I(this._manipulatorHandles),this._analysisHandles=I(this._analysisHandles),this._observerManipulator=null,this._clearCursorTracker(),this._removeLaserLine(),this._intersector=null,this._set("analysis",null)}get state(){return this.active?!this.hasGrabbedManipulators||this._creationMode?W.Creating:W.Created:this.analysis.observer?.position!=null?W.Created:W.Ready}get cursor(){return this.active&&this._showTracker?"crosshair":null}get updating(){return this.analysisViewData!=null&&this.analysisViewData.updating||this._updatingHandles.updating}get _showTracker(){return this.active&&this._latestPointerMovePointerType==="mouse"}get _shouldRenderTracker(){return this._showTracker&&this.analysis.observer?.position!=null&&!this.hasGrabbedManipulators}continue(){this.view.activeTool=this}stop(){this.view.activeTool=null}onEditableChange(){this.analysisViewData.editable=this.internallyEditable}onInputEvent(t){switch(t.type){case"immediate-double-click":this._doubleClickHandler(t);break;case"key-down":this._keyDownHandler(t);break;case"pointer-move":this._pointerMoveHandler(t)}}onInputEventAfter(t){t.type==="immediate-click"&&this._clickHandler(t)}onShow(){}onHide(){}onDeactivate(){this._clearCursorTracker()}_connectComputations(){return this._updatingHandles.addOnCollectionChange(()=>this.analysisViewData.computations,t=>this._onComputationsCollectionChange(t),{initial:!0,final:!0})}_onComputationsCollectionChange({added:t,removed:e}){for(let i of e)this._disconnectComputation(i);for(let i of t)this._connectComputation(i)}_connectComputation(t){if(this.destroyed)return void q.getLogger(this).warn("Attempting to connect an analysis to a destroyed LineOfSight tool. Ignoring.");let e=this._analysisHandles;if(e.has(t))return;let i=this._createTargetManipulator(t.target);this._targetTrackerManipulator==null&&i.metadata.target===this.analysisViewData.cursorTarget&&(this._targetTrackerManipulator=i,this._targetTrackerManipulator.available=!1,this._targetTrackerManipulator.interactive=!1,this._updateLaserLineRenderer()),e.add([this._updatingHandles.add(()=>ze(t),()=>Ge(i,t),T),this._updatingHandles.add(()=>t.elevationAlignedTargetLocation,o=>this._onTargetLocationChange(o,i),T)],t)}_disconnectComputation(t){if(this.destroyed)return void q.getLogger(this).warn("Attempting to disconnect an analysis from a destroyed LineOfSight tool. Ignoring.");this._analysisHandles.remove(t);let e=this._getTargetManipulator(t.target);e!=null&&(this.manipulators.remove(e),this._manipulatorHandles.remove(e),this._targetTrackerManipulator!=null&&this._targetTrackerManipulator===e&&(this._targetTrackerManipulator=null))}_clearCursorTracker(){this.analysisViewData.cursorTarget=I(this.analysisViewData.cursorTarget)}_createTargetManipulator(t){let e={target:t,type:"target"},i=new ft(this.view,e);return this._manipulatorHandles.add([this._createTargetManipulatorDragPipeline(i),i.events.on("grab-changed",o=>this._manipulatorGrabChanged(i,o)),i.events.on("immediate-click",o=>this._manipulatorClick(i,o))],i),this.manipulators.add(i),t.position!=null?i.elevationAlignedLocation=t.position:i.available=!1,i}_getTargetManipulator(t){let e=null;return this.manipulators.forEach(i=>{let o=i.manipulator;e==null&&o.metadata.type==="target"&&o.metadata.target===t&&(e=o)}),e}_createObserverManipulator(){let t=new vt(this.view,{type:"observer",intersection:null});return this._manipulatorHandles.add([this._createObserverManipulatorDragPipeline(t),t.events.on("grab-changed",e=>this._manipulatorGrabChanged(t,e)),t.events.on("immediate-click",e=>this._manipulatorClick(t,e))],t),this.manipulators.add(t),t}_screenToIntersection(){return t=>{let e=this._intersector.getScreenPointIntersection(t.screenEnd);return e==null?null:H(A({},t),{intersection:e})}}_createTargetManipulatorDragPipeline(t){return Et(t,(e,i,o)=>{i.next(this._screenToIntersection()).next(this._updateTargetDragStep(t)).next(()=>this._updateLaserLineRenderer()),o.next(xe(t.metadata.target)).next(()=>this._updateLaserLineRenderer())})}_createObserverManipulatorDragPipeline(t){return Et(t,(e,i,o)=>{i.next(this._screenToIntersection()).next(this._updateObserverDragStep()).next(()=>this._updateLaserLineRenderer()),o.next(this._cancelObserverDragStep()).next(()=>this._updateLaserLineRenderer())})}_updateObserverDragStep(){return t=>(t.intersection.mapPoint!=null?(this.analysis.observer==null&&(this.analysis.observer=new Vt),this._updateFromIntersection(this.analysis.observer,t.intersection)):this.analysis.observer=null,t)}_cancelObserverDragStep(){let t=this.analysis.observer?.position!=null?this.analysis.observer.clone():null;return e=>(this.analysis.observer=t,e)}_updateTargetDragStep(t){return e=>{this._updateFromIntersection(t.metadata.target,e.intersection);let i=e.intersection.mapPoint;return i!=null&&(t.elevationAlignedLocation=i),e}}_manipulatorGrabChanged(t,e){switch(e.action){case"start":this._grabbedManipulator=t;break;case"end":this._grabbedManipulator===t&&(this._grabbedManipulator=null)}}_laserLineRendererDependencies(){return{laserlineVisualElement:this._laserlineVisualElement,grabbedManipulator:this._grabbedManipulator,shouldRenderTracker:this._shouldRenderTracker,observerPosition:this.analysis.observer!=null?this.analysis.observer.position:null,visible:this.visible}}_updateLaserLineRenderer(t=this._laserLineRendererDependencies()){let{laserlineVisualElement:e,grabbedManipulator:i,shouldRenderTracker:o,observerPosition:s,visible:l}=t;if(e==null)return;let a=i??(o&&s!=null?this._targetTrackerManipulator:null);a!=null&&l?(e.visible=!0,e.heightManifoldTarget=a.renderLocation,a!==this._observerManipulator?e.lineVerticalPlaneSegment=le(this._observerManipulator.renderLocation,a.renderLocation,Fe):e.lineVerticalPlaneSegment=null):(e.visible=!1,e.heightManifoldTarget=null,e.lineVerticalPlaneSegment=null)}_createLaserLine(){this._removeLaserLine();let{glowWidth:t,innerWidth:e}=Le;this._laserlineVisualElement=new ge({view:this.view,attached:!0,visible:this.visible,style:{glowWidth:t,innerWidth:e},isDecoration:!0})}_removeLaserLine(){this._laserlineVisualElement!=null&&(this._laserlineVisualElement.destroy(),this._laserlineVisualElement=null)}_updateLaserLineStyle(t,e,i){let o=this._laserlineVisualElement;if(o==null)return;let s=o.style;o.style=H(A({},s),{glowColor:h.toUnitRGB(t),innerColor:h.toUnitRGB(e),globalAlpha:i})}_onObserverLocationChange(t){t!=null?(this._observerManipulator.metadata.intersection=null,this._observerManipulator.available=!0,this._observerManipulator.elevationAlignedLocation=t):this._observerManipulator.available=!1}_onTargetLocationChange(t,e){t!=null?(e.elevationAlignedLocation=t,e!==this._targetTrackerManipulator&&(e.available=!0)):e.available=!1}_addPointFromClickEvent(t){let e=this._intersector.getScreenPointIntersection(t);if(e?.mapPoint!=null)if(this.analysis.observer?.position!=null){this._clearCursorTracker();let i=new St;this._updateFromIntersection(i,e),this.analysis.targets.add(i)}else{let i=new Vt;this._updateFromIntersection(i,e),this.analysis.observer=i}}_clickHandler(t){this.active&&t.button!==pt.Right&&(this._addPointFromClickEvent(Rt(t)),t.stopPropagation())}_doubleClickHandler(t){this.active&&t.button!==pt.Right&&(this.stop(),t.stopPropagation())}_keyDownHandler(t){this.active&&t.key==="Escape"&&(this.stop(),t.stopPropagation())}_pointerMoveHandler(t){if(this.hasGrabbedManipulators||(this._latestPointerMovePointerType=t.pointerType,this._updateLaserLineRenderer(),!this._showTracker||this.analysis.observer?.position==null))return;let e=Rt(t),i=this._intersector.getScreenPointIntersection(e);i?.mapPoint!=null&&(this.analysisViewData.cursorTarget==null&&(this.analysisViewData.cursorTarget=new St),this._updateFromIntersection(this.analysisViewData.cursorTarget,i),this._updateLaserLineRenderer())}_updateFromIntersection(t,e){if(e.mapPoint==null)return t.position=null,t.elevationInfo=null,void(t.feature=null);switch(e.type){case J.OBJECT:if(e.graphic!=null){let o=e.graphic,s=ce(o);s.mode==="on-the-ground"&&(s.mode="relative-to-ground",s.offset=0),t.elevationInfo=new Lt(s),t.feature=o}else t.elevationInfo=null,t.feature=null;break;case J.TERRAIN:t.elevationInfo=new Lt({mode:"on-the-ground"}),t.feature=null;break;default:t.elevationInfo=null,t.feature=null}let i=e.mapPoint.clone();i.z=pe(this.view,i,{mode:"absolute-height",offset:0},t.elevationInfo),t.position=i}_manipulatorClick(t,e){if(t.metadata.type==="observer"||t.grabbing||t.dragging||e.button!==pt.Right||this.analysis.targets.length<=1)return;let{target:i}=t.metadata;this.analysis.targets.remove(i),e.stopPropagation()}get testInfo(){}};function xe(t){let e=t.position?.clone();return i=>(t.position=e,i)}function Ge(t,e){let{isValid:i,isTargetVisible:o}=e.computationResult;t.state=i?o?G.Custom1:G.Custom2:G.Custom3}function ze(t){let{isValid:e,isTargetVisible:i}=t.computationResult;return{isValid:e,isTargetVisible:i}}n([r({constructOnly:!0})],y.prototype,"view",void 0),n([r({constructOnly:!0})],y.prototype,"analysis",void 0),n([r()],y.prototype,"_creationMode",void 0),n([r({readOnly:!0})],y.prototype,"state",null),n([r({readOnly:!0})],y.prototype,"cursor",null),n([r()],y.prototype,"removeIncompleteOnCancel",void 0),n([r({readOnly:!0})],y.prototype,"updating",null),n([r({constructOnly:!0})],y.prototype,"analysisViewData",void 0),n([r({readOnly:!0})],y.prototype,"_showTracker",null),n([r()],y.prototype,"_latestPointerMovePointerType",void 0),n([r()],y.prototype,"_shouldRenderTracker",null),n([r()],y.prototype,"_laserlineVisualElement",void 0),n([r()],y.prototype,"_grabbedManipulator",void 0),y=n([b("esri.views.3d.analysis.LineOfSight.LineOfSightTool")],y);var Fe=ae();var _t=class{constructor(e,i,o,s){this.visibleLineVisualElement=e,this.occludedLineVisualElement=i,this.undefinedLineVisualElement=o,this.targetVisualElement=s}destroy(){this.visibleLineVisualElement.destroy(),this.occludedLineVisualElement.destroy(),this.undefinedLineVisualElement.destroy(),this.targetVisualElement.destroy()}};var V=class extends w{constructor(t){super(t),this._lineOfSightVisualElements=new Array,this._computationHandles=new B,this._updatingHandles=new Z}initialize(){this.addHandles(this._connectComputations()),this._createObserverVisualization()}destroy(){this._updatingHandles=I(this._updatingHandles),this._computationHandles=I(this._computationHandles),this._observerVisualElement=I(this._observerVisualElement)}get visible(){return this.analysisViewData.visible}get updating(){return this._updatingHandles.updating}get interactiveAndEditable(){return this.analysisViewData.interactive&&this.analysisViewData.editable}get test(){}_createLineOfSightVisualization(){let t=rt,e=this.view,i=this.isDecoration,o={view:e,attached:!0,width:t.outerWidth,innerWidth:t.innerWidth,isDecoration:i},s=h.toUnitRGBA(t.visibleOuterColor),l=h.toUnitRGBA(t.visibleInnerColor),a=h.toUnitRGBA(t.occludedOuterColor),p=h.toUnitRGBA(t.occludedInnerColor),d=h.toUnitRGBA(t.undefinedOuterColor),c=h.toUnitRGBA(t.undefinedInnerColor),u=new ht(H(A({},o),{color:s,innerColor:l})),g=new ht(H(A({},o),{color:a,innerColor:p})),v=new ht(H(A({},o),{color:d,innerColor:c})),R=new At(H(A({view:e,attached:!0},Se),{size:8,isDecoration:i})),S=new _t(u,g,v,R);return this._lineOfSightVisualElements.push(S),S}_destroyLineOfSightVisualization(t){t.destroy(),this._lineOfSightVisualElements.splice(this._lineOfSightVisualElements.indexOf(t),1)}_updateLineOfSightVisualization(t,e,i){let o=rt,{computationResult:s,inputPoints:l}=t,{start:a,end:p,intersection:d,isValid:c,isTargetVisible:u}=s,{observer:g}=l,v=Ne;v[12]=g[0],v[13]=g[1],v[14]=g[2];let R=U(je,a,g),S=U(Be,p,g),$=U(Ue,d,g),{visibleLineVisualElement:_,occludedLineVisualElement:j,undefinedLineVisualElement:L,targetVisualElement:E}=e,Re=this.analysisViewData.elevationAlignedObserver==null||t.elevationAlignedTargetLocation==null,K=this.visible&&!Re;_.visible=K,j.visible=K,L.visible=K,E.visible=K,E.attached=!i.interactiveAndEditable,K&&(_.geometry=null,j.geometry=null,L.geometry=null,E.geometry=t.elevationAlignedTargetLocation,c?u?(_.geometry=[[M(R),M(S)]],_.transform=v,_.color=h.toUnitRGBA(o.visibleOuterColor),E.color=h.toUnitRGBA(o.visibleInnerColor)):(_.geometry=[[M(R),M($)]],_.transform=v,_.color=h.toUnitRGBA(o.occludedOuterColor),j.geometry=[[M($),M(S)]],j.transform=v,E.color=h.toUnitRGBA(o.occludedInnerColor)):(L.geometry=[[M(R),M(S)]],L.transform=v,E.color=h.toUnitRGBA(o.undefinedInnerColor)))}_getLineOfSightVisualizationDependencies(t){let{computationResult:e}=t,{occludedOuterColor:i,visibleOuterColor:o}=rt;return{computationResult:e,occludedOuterColor:i,visibleOuterColor:o,visible:this.visible,interactiveAndEditable:this.interactiveAndEditable}}_connectComputation(t){let e=this._computationHandles;if(e.has(t))return;let i=this._createLineOfSightVisualization();e.add([this._updatingHandles.add(()=>this._getLineOfSightVisualizationDependencies(t),o=>this._updateLineOfSightVisualization(t,i,o),{initial:!0,equals:()=>!1}),st(()=>this._destroyLineOfSightVisualization(i))],t)}_disconnectComputation(t){this._computationHandles.remove(t)}_connectComputations(){return this._updatingHandles.addOnCollectionChange(()=>this.analysisViewData.computations,t=>this._onComputationsCollectionChange(t),{initial:!0,final:!0})}_onComputationsCollectionChange({added:t,removed:e}){for(let i of e)this._disconnectComputation(i);for(let i of t)this._connectComputation(i)}_createObserverVisualization(){let t=h.toUnitRGBA(rt.visibleInnerColor),e=new At(H(A({view:this.view,color:t},Se),{isDecoration:this.isDecoration}));this._observerVisualElement=e,this.addHandles(this._updatingHandles.add(()=>({observer:this.analysisViewData.elevationAlignedObserver,interactiveAndEditable:this.interactiveAndEditable,visible:this.visible}),({observer:i,interactiveAndEditable:o,visible:s})=>{i!=null&&!o&&s?(e.geometry=i,this._observerVisualElement.attached=!0):e.attached=!1},T))}};n([r({constructOnly:!0})],V.prototype,"analysis",void 0),n([r({constructOnly:!0})],V.prototype,"analysisViewData",void 0),n([r({constructOnly:!0})],V.prototype,"view",void 0),n([r({readOnly:!0})],V.prototype,"visible",null),n([r({constructOnly:!0})],V.prototype,"isDecoration",void 0),n([r()],V.prototype,"updating",null),n([r()],V.prototype,"interactiveAndEditable",null),n([r()],V.prototype,"test",null),V=n([b("esri.views.3d.analysis.LineOfSight.LineOfSightVisualization")],V);var Se={size:6,pixelSnappingEnabled:!1,primitive:"circle",elevationInfo:{mode:"absolute-height",offset:0},outlineSize:0},je=m(),Be=m(),Ue=m(),Ne=ie();var C=class extends _e(at.EventedMixin(w)){constructor(t){super(t),this.type="line-of-sight-view-3d",this.analysis=null,this.tool=null,this.computations=new Kt,this.elevationAlignedObserver=null,this.observerEngineLocation=m(),this.cursorTarget=null,this.editable=!0}initialize(){let t=this.view,e=this.analysis;this._analysisController=new f({analysis:e,analysisViewData:this,view:t}),this._analysisVisualization=new V({analysis:e,analysisViewData:this,view:t,isDecoration:!this.parent}),this.addHandles([this._analysisController.on("result-changed",i=>{i.target!==this.cursorTarget&&this.emit("result-changed",i)}),be(this,y)])}destroy(){Ce(this),this._analysisController=I(this._analysisController),this._analysisVisualization=I(this._analysisVisualization)}get results(){return this.computations.map(t=>t.result)}get priority(){return this._analysisController.priority}set priority(t){this._analysisController.priority=t}get updating(){return this._analysisController!=null&&this._analysisController.updating||this._analysisVisualization!=null&&this._analysisVisualization.updating}getResultForTarget(t){return this.computations.find(e=>e.target===t)?.result}get testInfo(){}};n([r({readOnly:!0})],C.prototype,"type",void 0),n([r({constructOnly:!0,nonNullable:!0})],C.prototype,"analysis",void 0),n([r()],C.prototype,"tool",void 0),n([r({readOnly:!0})],C.prototype,"results",null),n([r()],C.prototype,"priority",null),n([r()],C.prototype,"computations",void 0),n([r()],C.prototype,"elevationAlignedObserver",void 0),n([r()],C.prototype,"observerEngineLocation",void 0),n([r()],C.prototype,"cursorTarget",void 0),n([r()],C.prototype,"updating",null),n([r()],C.prototype,"editable",void 0),n([r()],C.prototype,"_analysisController",void 0),n([r()],C.prototype,"_analysisVisualization",void 0),C=n([b("esri.views.3d.analysis.LineOfSightAnalysisView3D")],C);var or=C;export{or as default};
