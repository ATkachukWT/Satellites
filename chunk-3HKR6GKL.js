import{a as _}from"./chunk-P4DMCVOC.js";import{a as N,b as R}from"./chunk-VEVXUPES.js";import{b as V}from"./chunk-CUJN6GMF.js";import{a as O}from"./chunk-WPZN772I.js";import{j as Q}from"./chunk-SIMI7FRM.js";import{f as w}from"./chunk-KWBPUP6A.js";import{b as d}from"./chunk-TBA3OZMJ.js";import{b as y}from"./chunk-4N5OXIEM.js";import{b as m}from"./chunk-44S2QQS2.js";import{m as g}from"./chunk-LFH24RLM.js";import{m as D}from"./chunk-KGVXGH6H.js";import{h as b}from"./chunk-ONUGDWDK.js";import{H as u,J as F}from"./chunk-QHVIRF5H.js";import{I as S}from"./chunk-WZDN6K3C.js";import{a}from"./chunk-QGVBCWUY.js";import{C as n}from"./chunk-CKJ56T2Q.js";import{t as f}from"./chunk-UHRSAPGQ.js";import{a as x}from"./chunk-V76GWARL.js";import{a as h}from"./chunk-N2WTMF3X.js";async function q(e,t,r){let i=m(e),c=await w(i,d.from(t),h({},r)),o=c.data.extent;return!o||isNaN(o.xmin)||isNaN(o.ymin)||isNaN(o.xmax)||isNaN(o.ymax)?{count:c.data.count,extent:null}:{count:c.data.count,extent:g.fromJSON(o)}}var s=class extends F{constructor(e){super(e),this.dynamicDataSource=null,this.fieldsIndex=null,this.gdbVersion=null,this.infoFor3D=null,this.pbfSupported=!1,this.queryAttachmentsSupported=!1,this.sourceSpatialReference=null,this.url=null}get parsedUrl(){return b(this.url)}async execute(e,t){let r=await this.executeJSON(e,t);return this.featureSetFromJSON(e,r,t)}async executeJSON(e,t){let r=this._normalizeQuery(e),i=e.outStatistics?.[0]!=null,c=x("featurelayer-pbf-statistics"),o=(!i||c)&&e.returnTrueCurves!==!0,p;if(this.pbfSupported&&o)try{p=await _(this.url,r,t)}catch(l){if(l.name!=="query:parsing-pbf")throw l;this.pbfSupported=!1}return this.pbfSupported&&o||(p=await V(this.url,r,t)),this._normalizeFields(p.fields),p}async featureSetFromJSON(e,t,r){if(!this._queryIs3DObjectFormat(e)||this.infoFor3D==null||!t.features)return O.fromJSON(t);let{meshFeatureSetFromJSON:i}=await n(import("./chunk-QGOGMPFE.js"),r);return i(e,this.infoFor3D,t)}executeForCount(e,t){return N(this.url,this._normalizeQuery(e),t)}executeForExtent(e,t){return q(this.url,this._normalizeQuery(e),t)}executeForIds(e,t){return R(this.url,this._normalizeQuery(e),t)}async executeRelationshipQuery(e,t){let[{default:r},{executeRelationshipQuery:i}]=await n(Promise.all([import("./chunk-DU3LTNV6.js"),import("./chunk-AAGNQ7JB.js")]),t);return e=r.from(e),(this.gdbVersion||this.dynamicDataSource)&&((e=e.clone()).gdbVersion=e.gdbVersion||this.gdbVersion,e.dynamicDataSource=e.dynamicDataSource||this.dynamicDataSource),i(this.url,e,t)}async executeRelationshipQueryForCount(e,t){let[{default:r},{executeRelationshipQueryForCount:i}]=await n(Promise.all([import("./chunk-DU3LTNV6.js"),import("./chunk-AAGNQ7JB.js")]),t);return e=r.from(e),(this.gdbVersion||this.dynamicDataSource)&&((e=e.clone()).gdbVersion=e.gdbVersion||this.gdbVersion,e.dynamicDataSource=e.dynamicDataSource||this.dynamicDataSource),i(this.url,e,t)}async executeAttachmentQuery(e,t){let{executeAttachmentQuery:r,fetchAttachments:i,processAttachmentQueryResult:c}=await n(import("./chunk-5HLBIL6B.js"),t),o=m(this.url);return c(o,await(this.queryAttachmentsSupported?r(o,e,t):i(o,e,t)))}async executeAttributeBinsQuery(e,t){let{executeAttributeBinsQuery:r}=await n(import("./chunk-UIK3X7RP.js"),t);return r(this.parsedUrl,e,t)}async executeTopFeaturesQuery(e,t){let{executeTopFeaturesQuery:r}=await n(import("./chunk-UE2IOM45.js"),t);return r(this.parsedUrl,e,this.sourceSpatialReference,t)}async executeForTopIds(e,t){let{executeForTopIds:r}=await n(import("./chunk-HNSGXULO.js"),t);return r(this.parsedUrl,e,t)}async executeForTopExtents(e,t){let{executeForTopExtents:r}=await n(import("./chunk-ZFGIKHP2.js"),t);return r(this.parsedUrl,e,t)}async executeForTopCount(e,t){let{executeForTopCount:r}=await n(import("./chunk-DDYDTJTV.js"),t);return r(this.parsedUrl,e,t)}_normalizeQuery(e){let t=d.from(e);t.sourceSpatialReference=t.sourceSpatialReference||this.sourceSpatialReference,(this.gdbVersion||this.dynamicDataSource)&&(t=t===e?t.clone():t,t.gdbVersion=e.gdbVersion||this.gdbVersion,t.dynamicDataSource=e.dynamicDataSource?y.from(e.dynamicDataSource):this.dynamicDataSource);let{infoFor3D:r}=this;if(r!=null&&this._queryIs3DObjectFormat(e)){if(t=t===e?t.clone():t,t.formatOf3DObjects=Q(r),!t.formatOf3DObjects)throw new f("query:unsupported-3d-query-formats","Could not find any supported 3D object query format. Only supported formats are 3D_glb and 3D_gltf");if(t.outSpatialReference&&!D(t.outSpatialReference,this.sourceSpatialReference))throw new f("query:unsupported-out-spatial-reference","3D object feature services do not support projection of geometries");if(t.outFields==null||!t.outFields.includes("*")){t=t===e?t.clone():t,t.outFields==null&&(t.outFields=[]);let{originX:i,originY:c,originZ:o,translationX:p,translationY:l,translationZ:I,scaleX:T,scaleY:j,scaleZ:v,rotationX:A,rotationY:J,rotationZ:U,rotationDeg:C}=r.transformFieldRoles;t.outFields.push(i,c,o,p,l,I,T,j,v,A,J,U,C)}}return t}_normalizeFields(e){if(this.fieldsIndex!=null&&e!=null)for(let t of e){let r=this.fieldsIndex.get(t.name);r&&Object.assign(t,r.toJSON())}}_queryIs3DObjectFormat(e){return this.infoFor3D!=null&&e.returnGeometry===!0&&e.multipatchOption!=="xyFootprint"&&!e.outStatistics}};a([u({type:y})],s.prototype,"dynamicDataSource",void 0),a([u()],s.prototype,"fieldsIndex",void 0),a([u()],s.prototype,"gdbVersion",void 0),a([u()],s.prototype,"infoFor3D",void 0),a([u({readOnly:!0})],s.prototype,"parsedUrl",null),a([u()],s.prototype,"pbfSupported",void 0),a([u()],s.prototype,"queryAttachmentsSupported",void 0),a([u()],s.prototype,"sourceSpatialReference",void 0),a([u({type:String})],s.prototype,"url",void 0),s=a([S("esri.layers.graphics.sources.support.QueryTask")],s);var mt=s;export{mt as a};
