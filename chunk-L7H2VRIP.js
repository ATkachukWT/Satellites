import{a as D,b as N}from"./chunk-AY7CYY2N.js";import"./chunk-VEK547EU.js";import"./chunk-LAVD467M.js";import"./chunk-6CUAH7AI.js";import"./chunk-OC2XJJQU.js";import{a as W}from"./chunk-4OC4J3KU.js";import"./chunk-54HXR2K7.js";import{p as U,r as q}from"./chunk-T4QAGZWF.js";import"./chunk-7BXTHPPE.js";import"./chunk-Q5KIWWVU.js";import"./chunk-KK722UJA.js";import"./chunk-C27Q2S3P.js";import{b as j}from"./chunk-DB752BXH.js";import{a as y,b as L,c as m}from"./chunk-HATZI22X.js";import{a as O}from"./chunk-NVYT4DEO.js";import{a as R}from"./chunk-L25QECEE.js";import"./chunk-E4ND5WCV.js";import"./chunk-JX3MPN3R.js";import{c as z}from"./chunk-IE6LCR36.js";import"./chunk-SCNTWYD2.js";import"./chunk-K3Z3MI77.js";import"./chunk-35XAFVAL.js";import"./chunk-C3PAYYXB.js";import"./chunk-3CWCNPAI.js";import"./chunk-UCYOLKZK.js";import"./chunk-WTZT4FKW.js";import"./chunk-6FDNNAVT.js";import"./chunk-FYZRIMPP.js";import"./chunk-VYI3HIPB.js";import"./chunk-WI3QVC6K.js";import"./chunk-ZFRNSCYG.js";import"./chunk-UWWX7VSW.js";import"./chunk-CFF33S4D.js";import{o as g}from"./chunk-JAENS3D3.js";import"./chunk-3ATD3H4Q.js";import{q as T}from"./chunk-2XYAAYOE.js";import"./chunk-NIYDRLW4.js";import"./chunk-CAXK5KYB.js";import"./chunk-3CCK7BDD.js";import"./chunk-LNYBTIG7.js";import"./chunk-ME2B26KJ.js";import"./chunk-U7PX7SHO.js";import"./chunk-AOQ57NDM.js";import"./chunk-VMECOA4F.js";import"./chunk-JPMGMA4B.js";import"./chunk-I4Q2S2XA.js";import"./chunk-V774RJYN.js";import"./chunk-L2WNUKLP.js";import"./chunk-XITT4JU2.js";import"./chunk-ZBX6HJOS.js";import"./chunk-BSMAMABT.js";import"./chunk-LYNAYPL3.js";import"./chunk-ULANM5YP.js";import"./chunk-2G3SBK6Q.js";import"./chunk-VOB6IBIW.js";import"./chunk-63B3IOWG.js";import"./chunk-KAMRW6HF.js";import"./chunk-DJW5LMRG.js";import"./chunk-ALWV3RJ2.js";import"./chunk-DEH76MSI.js";import{a as Z}from"./chunk-DVBZA6ZU.js";import"./chunk-VTGWQ7AP.js";import"./chunk-TBA3OZMJ.js";import"./chunk-S4QV2MGO.js";import"./chunk-USMAJP2P.js";import"./chunk-PHNFWHVF.js";import"./chunk-4N5OXIEM.js";import"./chunk-W26XKMAT.js";import{a as M}from"./chunk-NQWYPF77.js";import"./chunk-G27DRLGO.js";import{d as x}from"./chunk-KRAKR4MK.js";import"./chunk-MCO7DSFO.js";import"./chunk-D7WE3OBT.js";import{a as G}from"./chunk-CDP4MSRO.js";import"./chunk-BCSLWH5H.js";import"./chunk-TOH4K6HW.js";import"./chunk-UP6FLASM.js";import"./chunk-DGBDFGKO.js";import"./chunk-44S2QQS2.js";import"./chunk-DQOFEB5P.js";import"./chunk-JTDXB5TK.js";import{m as A}from"./chunk-2NP7F5RO.js";import"./chunk-7QY3BMVN.js";import{b as F}from"./chunk-XEZTJAR4.js";import"./chunk-BUP3AMMF.js";import"./chunk-XCIPBOI4.js";import"./chunk-CWUY5SXW.js";import"./chunk-KD27XIJC.js";import{h as P,r as H,t as I}from"./chunk-TPFJWNIU.js";import"./chunk-P25RU3X5.js";import"./chunk-XRRQM4E2.js";import"./chunk-GWBRHLNH.js";import"./chunk-EM35R6FY.js";import"./chunk-QXXXCEV5.js";import"./chunk-6B5XFA6F.js";import"./chunk-M67YQAIX.js";import"./chunk-NHEQ4TAR.js";import"./chunk-BIRSPTTF.js";import"./chunk-IZLELRQR.js";import"./chunk-7EMOONQX.js";import"./chunk-RZF6KTKU.js";import"./chunk-HP4LYRR4.js";import"./chunk-AFC2H4Q3.js";import"./chunk-OLOKUDVI.js";import"./chunk-4G7UTTZJ.js";import"./chunk-ZTOZWLEE.js";import"./chunk-RJWOVI3M.js";import"./chunk-SP2CO3KX.js";import"./chunk-NRBJLISB.js";import"./chunk-PTZYZULI.js";import"./chunk-NMLYCCKN.js";import"./chunk-RSDQHAJX.js";import"./chunk-BOVYXYHK.js";import"./chunk-FENRIY2T.js";import"./chunk-5HJY3X5Y.js";import"./chunk-6RZAM42M.js";import"./chunk-WDETDPZG.js";import"./chunk-HX2VGIR2.js";import"./chunk-64QN2VGD.js";import"./chunk-JGEVVXD4.js";import{p as C}from"./chunk-B3FO6PT7.js";import"./chunk-C4UMJHQC.js";import"./chunk-BCREO4Q5.js";import"./chunk-LXFQWIWE.js";import"./chunk-QT6UNBJP.js";import{a as k,c as E,i as u}from"./chunk-MWSXMSWY.js";import{f as b}from"./chunk-JRCKELO6.js";import"./chunk-ZVCMULXF.js";import"./chunk-KJULKTB5.js";import"./chunk-LACL4BQ2.js";import"./chunk-YR2HD3ZC.js";import"./chunk-GJASVPF6.js";import"./chunk-UBFCO3DV.js";import"./chunk-NI7FJV5X.js";import"./chunk-BUSG3ZOF.js";import"./chunk-XZIOXVVJ.js";import"./chunk-EXJYW3PC.js";import"./chunk-SXQPBCOX.js";import"./chunk-LFH24RLM.js";import"./chunk-Z5Q7KLA4.js";import"./chunk-X4LNX4BR.js";import"./chunk-4XZ6X7MQ.js";import"./chunk-WLHY3MMA.js";import"./chunk-KGVXGH6H.js";import"./chunk-ARRCN5K3.js";import"./chunk-LXQPIAN7.js";import"./chunk-FTDD7QBB.js";import"./chunk-DB3UIQCU.js";import"./chunk-SBHKMV3P.js";import"./chunk-R4A63S45.js";import"./chunk-ETE32IYO.js";import"./chunk-ONUGDWDK.js";import"./chunk-SG7CQU4O.js";import{H as p,J as w}from"./chunk-QHVIRF5H.js";import{I as S}from"./chunk-WZDN6K3C.js";import{a as s}from"./chunk-QGVBCWUY.js";import"./chunk-OJQ73TPF.js";import"./chunk-354SCPDU.js";import"./chunk-OVHPPCBL.js";import"./chunk-IYZFKXJ6.js";import{C as _,H as v,v as d}from"./chunk-CKJ56T2Q.js";import"./chunk-SNFOAZZQ.js";import"./chunk-F6JAWRPN.js";import"./chunk-UHRSAPGQ.js";import{p as f}from"./chunk-V76GWARL.js";import"./chunk-N2WTMF3X.js";var J="graphics-collections",a=class extends w{get updating(){return this._updatingHandles.updating}get _hasZ(){let e=this.view;return e!=null&&e.type==="3d"&&this.layerSource.layer.type!=="map-notes"}get _snappingElevationAligner(){let{view:e}=this,{layer:t}=this.layerSource,i=e!=null&&e.type==="3d";if(!i||t.type==="map-notes")return y();let o=async(r,n)=>(await _(e.whenLayerView(t),n)).elevationAlignPointsInFeatures(r,n);return y(i,{elevationInfo:t.elevationInfo,alignPointsInFeatures:o})}get _snappingElevationFilter(){let{view:e}=this,t=e!=null&&e.type==="3d"&&this.layerSource.layer.type!=="map-notes";return L(t)}get _symbologySnappingFetcher(){let{view:e}=this,{layer:t}=this.layerSource,i=e!=null&&e.type==="3d",o=this._extrudedPolygonSymbolsCount>0;return i&&t.type!=="map-notes"&&o?m(o,async(r,n)=>{let l=await e.whenLayerView(t);return d(n),l.queryForSymbologySnapping({candidates:r,spatialReference:e.spatialReference},n)}):m()}constructor(e){super(e),this.availability=1,this._sources={multipoint:null,point:null,polygon:null,polyline:null},this._loadedWkids=new Set,this._loadedWkts=new Set,this._pendingAdds=[],this._extrudedPolygonSymbolsCount=0,this._updatingHandles=new Z,this._memoizedMakeGetGroundElevation=W(N)}destroy(){for(let e of this._pendingAdds)e.task.abort();this._pendingAdds.length=0,this._mapSources(e=>this._destroySource(e)),this._updatingHandles.destroy()}initialize(){this._updatingHandles.add(()=>this.getGraphicsLayers(),i=>{this._updatingHandles.removeHandles(J);for(let o of i)this._addMany(o.graphics.toArray()),this.addHandles([o.on("graphic-update",r=>this._onGraphicUpdate(r)),this._updatingHandles.addOnCollectionChange(()=>o.graphics,r=>this._onGraphicsChanged(r))],J)},u);let{view:e}=this,{layer:t}=this.layerSource;e!=null&&e.type==="3d"&&t.type!=="map-notes"&&e.elevationProvider&&this.addHandles([e.elevationProvider.on("elevation-change",({context:i})=>{T(i,t.elevationInfo)&&this._snappingElevationAligner.notifyElevationSourceChange()}),k(()=>t.elevationInfo,()=>this._snappingElevationAligner.notifyElevationSourceChange(),u),E(()=>t,["edits","apply-edits","graphic-update"],()=>this._symbologySnappingFetcher.notifySymbologyChange())])}async fetchCandidates(e,t){let{point:i,coordinateHelper:{spatialReference:o}}=e,r=await v(this._mapSources(c=>this._fetchCandidatesForSource(c,e,t)));d(t);let n=this._memoizedMakeGetGroundElevation(this.view,o),l=r.flat().map(c=>D(c,n));return U(i,l),l}async _fetchCandidatesForSource(e,t,i){let o=q(t,this.view?.type??"2d"),r=await O(e.queryEngine,o,i);d(i);let n=await this._snappingElevationAligner.alignCandidates(r.candidates,t.coordinateHelper.spatialReference,i);d(i);let l=await this._symbologySnappingFetcher.fetch(n,i);d(i);let c=l.length===0?n:[...n,...l];return this._snappingElevationFilter.filter(o,c)}refresh(){}_onGraphicUpdate(e){if(this.getGraphicsLayers().some(t=>t.graphics.includes(e.graphic)))switch(e.property){case"geometry":case"visible":this._remove(e.graphic),this._addMany([e.graphic])}}_onGraphicsChanged(e){for(let t of e.removed)this._remove(t);this._addMany(e.added)}_addMany(e){let t=[],i=new Map;for(let o of e)o.geometry!=null&&(this._needsInitializeProjection(o.geometry.spatialReference)?(t.push(o.geometry.spatialReference),i.set(o.uid,o)):this._add(o));this._createPendingAdd(t,i)}_createPendingAdd(e,t){if(!e.length)return;let i=b(async n=>{await I(e.map(l=>({source:l,dest:this.spatialReference})),{signal:n}),this._markLoadedSpatialReferences(e);for(let l of t.values())this._add(l)});this._updatingHandles.addPromise(i.promise);let o={task:i,graphics:t},r=()=>f(this._pendingAdds,o);i.promise.then(r,r),this._pendingAdds.push(o)}_markLoadedSpatialReferences(e){for(let t of e){t.wkid!=null&&this._loadedWkids.add(t.wkid);let i=t.wkt2||t.wkt;i&&this._loadedWkts.add(i)}}_add(e){if(e.geometry==null||!e.visible)return;let t=e.geometry;if(t.type==="mesh")return;t.type==="extent"&&(t=C.fromExtent(t));let i=this._ensureSource(t.type);if(i==null)return;let o=this._createOptimizedFeature(e.uid,t);o!=null&&(i.featureStore.add(o),g(e.symbol)&&this._extrudedPolygonSymbolsCount++)}_needsInitializeProjection(e){if(e.wkid!=null&&this._loadedWkids.has(e.wkid))return!1;let t=e.wkt2||e.wkt;return(!t||!this._loadedWkts.has(t))&&!H(e,this.spatialReference)}_createOptimizedFeature(e,t){let i=P(j(t),this.spatialReference);if(!i)return null;let o=this._ensureGeometryHasZ(i),r=A(o,this._hasZ,!1);return new F(r,{[h]:e},null,e)}_ensureGeometryHasZ(e){if(!this._hasZ)return e;let t=o=>{for(;o.length<3;)o.push(0)},i=e.clone();switch(i.hasZ=!0,i.type){case"point":i.z=i.z??0;break;case"multipoint":i.points.forEach(t);break;case"polyline":i.paths.forEach(o=>o.forEach(t));break;case"polygon":i.rings.forEach(o=>o.forEach(t))}return i}_ensureSource(e){let t=this._sources[e];if(t!=null)return t;let i=this._createSource(e);return this._sources[e]=i,i}_createSource(e){let t=M.toJSON(e),i=this._hasZ,o=new R({geometryType:t,hasZ:i,hasM:!1});return{featureStore:o,queryEngine:new z({featureStore:o,fieldsIndex:G.fromLayerJSON({fields:[{name:h,type:"esriFieldTypeOID",alias:h}]}),geometryType:t,hasM:!1,hasZ:i,objectIdField:h,spatialReference:this.spatialReference,priority:x.SNAPPING,scheduler:this.view!=null&&this.view.type==="3d"?this.view.resourceController.scheduler:null}),type:e}}_remove(e){this._mapSources(t=>this._removeFromSource(t,e));for(let t of this._pendingAdds)t.graphics.delete(e.uid),t.graphics.size===0&&t.task.abort()}_removeFromSource(e,t){let i=t.uid;e.featureStore.has(i)&&(e.featureStore.removeById(t.uid),g(t.symbol)&&this._extrudedPolygonSymbolsCount--)}_destroySource(e){e.queryEngine.destroy(),this._sources[e.type]=null}_mapSources(e){let{point:t,polygon:i,polyline:o,multipoint:r}=this._sources,n=[];return t!=null&&n.push(e(t)),i!=null&&n.push(e(i)),o!=null&&n.push(e(o)),r!=null&&n.push(e(r)),n}};s([p()],a.prototype,"getGraphicsLayers",void 0),s([p({constructOnly:!0})],a.prototype,"layerSource",void 0),s([p({constructOnly:!0})],a.prototype,"spatialReference",void 0),s([p({constructOnly:!0})],a.prototype,"view",void 0),s([p({readOnly:!0})],a.prototype,"updating",null),s([p({readOnly:!0})],a.prototype,"availability",void 0),s([p()],a.prototype,"_hasZ",null),s([p()],a.prototype,"_snappingElevationAligner",null),s([p()],a.prototype,"_snappingElevationFilter",null),s([p()],a.prototype,"_symbologySnappingFetcher",null),s([p()],a.prototype,"_extrudedPolygonSymbolsCount",void 0),a=s([S("esri.views.interactive.snapping.featureSources.GraphicsSnappingSource")],a);var h="OBJECTID";export{a as GraphicsSnappingSource};
