import{a as Ce,b as Oe,d as De,e as Fe,f as Se,g as Ge}from"./chunk-MUHN3B32.js";import{a as Ne}from"./chunk-W5KOEBEW.js";import{a as xe,b as Ee,d as we}from"./chunk-FLKHBKFN.js";import{d as ve,e as Ie}from"./chunk-CQPPG6BL.js";import{i as be,j as M}from"./chunk-4A4W2HKR.js";import"./chunk-RJZWYGCE.js";import"./chunk-322WAKKC.js";import"./chunk-6KU27KDM.js";import"./chunk-NTZN6TGL.js";import"./chunk-ZIK4TOX5.js";import{a as fe}from"./chunk-2U44WK2Y.js";import"./chunk-75L4O5ME.js";import"./chunk-JUMM5VTE.js";import"./chunk-4ZBUTOIE.js";import{c as pe}from"./chunk-3S7MXQDG.js";import"./chunk-4Y7EKSO4.js";import"./chunk-KRX2B2DE.js";import"./chunk-YMDW3G4U.js";import{b as ne,j as de,l as P,p as le,q as he}from"./chunk-I775TR7R.js";import"./chunk-VCEKZDML.js";import"./chunk-3NX4GRTL.js";import"./chunk-JX3MPN3R.js";import"./chunk-IE6LCR36.js";import"./chunk-SCNTWYD2.js";import"./chunk-K3Z3MI77.js";import"./chunk-35XAFVAL.js";import"./chunk-C3PAYYXB.js";import"./chunk-3CWCNPAI.js";import"./chunk-UCYOLKZK.js";import"./chunk-WTZT4FKW.js";import"./chunk-6FDNNAVT.js";import"./chunk-FYZRIMPP.js";import"./chunk-VYI3HIPB.js";import"./chunk-WI3QVC6K.js";import"./chunk-ZQCWKCV6.js";import"./chunk-Q7U5SZXR.js";import"./chunk-IPMZUQ2D.js";import{b as ye}from"./chunk-QGGZPZNN.js";import"./chunk-24PMLB7F.js";import"./chunk-YAHHW2G4.js";import"./chunk-BCDNNCF4.js";import"./chunk-NPWEUFES.js";import"./chunk-PQNOJ4XM.js";import{a as _e}from"./chunk-26JWDTE3.js";import"./chunk-GPDZGV7G.js";import"./chunk-R2HHW4XT.js";import"./chunk-LG7DXNE4.js";import"./chunk-2DH3L3DZ.js";import"./chunk-2VR3WADU.js";import"./chunk-7S2234XQ.js";import"./chunk-5QOQFLF6.js";import"./chunk-2I3LIA7G.js";import{a as me}from"./chunk-5DVGZXEZ.js";import"./chunk-QCAQAWPU.js";import"./chunk-BENEV3E6.js";import"./chunk-R3G2IXBO.js";import"./chunk-ZFRNSCYG.js";import{a as ge}from"./chunk-IDSQ2YJ4.js";import"./chunk-IZXGUN7P.js";import"./chunk-CFF33S4D.js";import"./chunk-TY4DYZZJ.js";import"./chunk-6SGUOKGX.js";import"./chunk-LCFWGHLF.js";import"./chunk-XACQ2RJ5.js";import"./chunk-3TRID6QS.js";import"./chunk-VUJT53YX.js";import"./chunk-WUXNV6ZW.js";import{b as ce}from"./chunk-PM3EZWDJ.js";import{h as ue}from"./chunk-KE2U7ENE.js";import"./chunk-WIFM6OT5.js";import"./chunk-GI4NW5SA.js";import"./chunk-F4FOXK2P.js";import"./chunk-T5NHE3SD.js";import"./chunk-SWCOPTUX.js";import"./chunk-7EWNVUY7.js";import"./chunk-SXYHD4V6.js";import"./chunk-FSW536RM.js";import"./chunk-YNDA4ZZB.js";import"./chunk-JAN3FVXP.js";import"./chunk-F4HA2HQL.js";import"./chunk-BSKAVVQS.js";import"./chunk-AEU2INWT.js";import"./chunk-Z4UBZ6W2.js";import"./chunk-CMKJEBQJ.js";import"./chunk-AQMR24IC.js";import"./chunk-3J3Q4LMA.js";import"./chunk-PSNQ2KG3.js";import"./chunk-LIKQ6DPU.js";import"./chunk-H6LI7TZP.js";import"./chunk-2IWALBQY.js";import"./chunk-IVHM64W3.js";import"./chunk-QQ5W5TEP.js";import"./chunk-YQHQQW4I.js";import"./chunk-7V6BRQYE.js";import"./chunk-IZU6TNEP.js";import"./chunk-DNN7JJKY.js";import"./chunk-Y7XG5IWW.js";import"./chunk-X5NPIY3C.js";import"./chunk-JXRFF2VE.js";import"./chunk-7WCQBAQY.js";import"./chunk-V4ZQZTCB.js";import"./chunk-PEYNLMWW.js";import"./chunk-FQIIIJGL.js";import"./chunk-SZTSN5BD.js";import"./chunk-VAOSSSLB.js";import"./chunk-6L543SC5.js";import"./chunk-CUV3BSEW.js";import"./chunk-6FI5AY7X.js";import"./chunk-ZCAR53EN.js";import"./chunk-DH67ILIV.js";import"./chunk-7GUYYJRR.js";import"./chunk-WS4AMEGN.js";import"./chunk-CU7FHMWW.js";import"./chunk-CSFAHB4Y.js";import"./chunk-AMISFAT3.js";import"./chunk-PTXLSCMJ.js";import"./chunk-NRRX2M6N.js";import"./chunk-PMLKCTEJ.js";import"./chunk-MYO2G5ZH.js";import"./chunk-MTUYS77G.js";import"./chunk-EG2DTURK.js";import"./chunk-57FV5BVL.js";import"./chunk-YVCKQBWT.js";import"./chunk-4XEE5PE3.js";import"./chunk-DV6KBPBR.js";import"./chunk-XWEUR6F7.js";import"./chunk-KALTBP5D.js";import"./chunk-O2J7LFYY.js";import"./chunk-422PSKZ7.js";import"./chunk-SFANISLX.js";import"./chunk-5L4CW2H2.js";import"./chunk-UJ7KVQR6.js";import"./chunk-B74L7AUE.js";import{a as N}from"./chunk-MJO3PLZV.js";import"./chunk-YU3IFRYW.js";import"./chunk-XKFJ6GWH.js";import"./chunk-GSXOR3JU.js";import"./chunk-55OTJIMU.js";import"./chunk-EM2AEAFS.js";import"./chunk-VGAXEXH3.js";import"./chunk-YEPHAEAY.js";import"./chunk-76X7RFM4.js";import"./chunk-HMNTGQTR.js";import"./chunk-ZLIWNUFM.js";import"./chunk-GVSOJUIP.js";import"./chunk-GWSX6PRO.js";import"./chunk-ELCBU4NP.js";import"./chunk-GMZFCQJQ.js";import"./chunk-5WDH2LXO.js";import"./chunk-L7NOU4T2.js";import"./chunk-SU7IJ65K.js";import"./chunk-WOZSH7YY.js";import"./chunk-2PJRHNJW.js";import"./chunk-B2RVSTL3.js";import"./chunk-2CKJLDTO.js";import"./chunk-F6TN7E7K.js";import"./chunk-HUUJBVXR.js";import"./chunk-4LDVFWME.js";import"./chunk-A45BLB26.js";import"./chunk-DFYW3Y3B.js";import"./chunk-UBQPWKE4.js";import"./chunk-YSD7LK2L.js";import"./chunk-CTVZOIWY.js";import{a as se}from"./chunk-BSSTF6JG.js";import"./chunk-7JW7DYCQ.js";import"./chunk-UP67O2XH.js";import"./chunk-6CO4643W.js";import"./chunk-TMY7UIU7.js";import"./chunk-BPX3YT3K.js";import{a as ae}from"./chunk-LXEWGICX.js";import{a as oe}from"./chunk-NIYDRLW4.js";import"./chunk-4K47EN3B.js";import"./chunk-FGY3YBPM.js";import"./chunk-EDOVNTC7.js";import"./chunk-FSWSNKJD.js";import"./chunk-MVDZB4AK.js";import"./chunk-ESSDCWGF.js";import"./chunk-WVKBXQWE.js";import"./chunk-FGEB67EG.js";import"./chunk-YEXMIDOT.js";import"./chunk-GV3ZFCVD.js";import"./chunk-SOEEM7Z7.js";import"./chunk-T7PUQGWM.js";import"./chunk-44A27HB7.js";import"./chunk-47NSYSFY.js";import"./chunk-QXNVQZT7.js";import"./chunk-CAXK5KYB.js";import"./chunk-3CCK7BDD.js";import"./chunk-LNYBTIG7.js";import"./chunk-37H4LYIE.js";import"./chunk-VYZHOYXV.js";import"./chunk-K7YQAHQ7.js";import"./chunk-XAHD7XBV.js";import{b as ie}from"./chunk-J6YGDWJF.js";import{a as re}from"./chunk-YQNUGDFH.js";import"./chunk-QCZ3ZIGQ.js";import"./chunk-NNX76JDG.js";import"./chunk-76O2P2CB.js";import"./chunk-KBDKZSTB.js";import{a as te}from"./chunk-HBMVPT4U.js";import"./chunk-XN6KHUVJ.js";import"./chunk-BGOXHRAZ.js";import"./chunk-SXNHGK6A.js";import"./chunk-TMZQBNSB.js";import"./chunk-PFSX77NO.js";import"./chunk-ZJWWZWMH.js";import"./chunk-W45QYQK6.js";import"./chunk-I5V562B6.js";import"./chunk-5NHJFBCW.js";import"./chunk-WPZN772I.js";import"./chunk-AOQ57NDM.js";import"./chunk-ONYJLWAD.js";import"./chunk-VMECOA4F.js";import"./chunk-PHODKV66.js";import"./chunk-JPMGMA4B.js";import"./chunk-YHWE4TIZ.js";import"./chunk-JGU5JAYW.js";import"./chunk-LCMPSAU3.js";import"./chunk-CRJDOM7J.js";import"./chunk-BCFGKQ2N.js";import"./chunk-YQGS4EZO.js";import"./chunk-3REMXE4W.js";import"./chunk-4ABKPPKG.js";import"./chunk-PMVQ5DJK.js";import"./chunk-I4Q2S2XA.js";import"./chunk-V774RJYN.js";import"./chunk-L2WNUKLP.js";import"./chunk-XITT4JU2.js";import"./chunk-ZBX6HJOS.js";import"./chunk-BSMAMABT.js";import"./chunk-LYNAYPL3.js";import"./chunk-ULANM5YP.js";import"./chunk-77L5NP7A.js";import"./chunk-KAMRW6HF.js";import"./chunk-6DGDLLNL.js";import"./chunk-UWWWQ44M.js";import"./chunk-BHB4UQZT.js";import"./chunk-DJW5LMRG.js";import"./chunk-SEJXLJ5V.js";import"./chunk-MPAJA3DL.js";import"./chunk-ALWV3RJ2.js";import"./chunk-DEH76MSI.js";import"./chunk-DVBZA6ZU.js";import"./chunk-VTGWQ7AP.js";import{b as A}from"./chunk-TBA3OZMJ.js";import"./chunk-S4QV2MGO.js";import"./chunk-USMAJP2P.js";import"./chunk-PHNFWHVF.js";import"./chunk-4N5OXIEM.js";import{j as ee}from"./chunk-DTU6MHUX.js";import"./chunk-NFXNGFHZ.js";import"./chunk-W26XKMAT.js";import"./chunk-NQWYPF77.js";import"./chunk-6KRFVLII.js";import"./chunk-G27DRLGO.js";import{d as J}from"./chunk-KRAKR4MK.js";import"./chunk-MCO7DSFO.js";import"./chunk-D7WE3OBT.js";import"./chunk-CDP4MSRO.js";import"./chunk-BCSLWH5H.js";import"./chunk-TOH4K6HW.js";import"./chunk-UP6FLASM.js";import"./chunk-DGBDFGKO.js";import"./chunk-44S2QQS2.js";import"./chunk-DQOFEB5P.js";import"./chunk-JTDXB5TK.js";import"./chunk-2NP7F5RO.js";import"./chunk-7QY3BMVN.js";import"./chunk-XEZTJAR4.js";import"./chunk-BUP3AMMF.js";import{e as K}from"./chunk-XCIPBOI4.js";import"./chunk-CWUY5SXW.js";import{a as S,b as Z}from"./chunk-KD27XIJC.js";import"./chunk-TPFJWNIU.js";import{a as $}from"./chunk-P25RU3X5.js";import{k as G}from"./chunk-XRRQM4E2.js";import"./chunk-GWBRHLNH.js";import"./chunk-G7TP3ZYQ.js";import"./chunk-Y6YEAKJ5.js";import"./chunk-U4TLMQTY.js";import"./chunk-PDQQY7RQ.js";import"./chunk-RWCIDBNQ.js";import"./chunk-2NH7HOKA.js";import"./chunk-HM5RIVQC.js";import"./chunk-EM35R6FY.js";import"./chunk-2ZFXOJDB.js";import"./chunk-QXXXCEV5.js";import{c as X}from"./chunk-6B5XFA6F.js";import"./chunk-M67YQAIX.js";import"./chunk-NHEQ4TAR.js";import"./chunk-BIRSPTTF.js";import{a as Y}from"./chunk-IZLELRQR.js";import"./chunk-7EMOONQX.js";import"./chunk-RZF6KTKU.js";import"./chunk-HP4LYRR4.js";import"./chunk-AFC2H4Q3.js";import"./chunk-OLOKUDVI.js";import"./chunk-4G7UTTZJ.js";import"./chunk-ZTOZWLEE.js";import"./chunk-RJWOVI3M.js";import"./chunk-SP2CO3KX.js";import"./chunk-NRBJLISB.js";import"./chunk-PTZYZULI.js";import"./chunk-NMLYCCKN.js";import"./chunk-RSDQHAJX.js";import{a as B,i as W}from"./chunk-BOVYXYHK.js";import"./chunk-FENRIY2T.js";import"./chunk-5HJY3X5Y.js";import"./chunk-6RZAM42M.js";import"./chunk-WDETDPZG.js";import"./chunk-HX2VGIR2.js";import"./chunk-64QN2VGD.js";import"./chunk-JGEVVXD4.js";import"./chunk-B3FO6PT7.js";import"./chunk-C4UMJHQC.js";import"./chunk-BCREO4Q5.js";import"./chunk-LXFQWIWE.js";import"./chunk-QT6UNBJP.js";import"./chunk-V2GNNIXD.js";import"./chunk-NSYL2RQJ.js";import"./chunk-SLAWDKDA.js";import{a as k,i as w}from"./chunk-MWSXMSWY.js";import"./chunk-JRCKELO6.js";import"./chunk-ZVCMULXF.js";import"./chunk-KJULKTB5.js";import"./chunk-LACL4BQ2.js";import"./chunk-YR2HD3ZC.js";import{a as T}from"./chunk-GJASVPF6.js";import"./chunk-UBFCO3DV.js";import"./chunk-NI7FJV5X.js";import"./chunk-BUSG3ZOF.js";import"./chunk-XZIOXVVJ.js";import"./chunk-EXJYW3PC.js";import"./chunk-SXQPBCOX.js";import{c as U,d as z}from"./chunk-LFH24RLM.js";import"./chunk-Z5Q7KLA4.js";import"./chunk-X4LNX4BR.js";import"./chunk-4XZ6X7MQ.js";import"./chunk-WLHY3MMA.js";import"./chunk-KGVXGH6H.js";import"./chunk-ARRCN5K3.js";import"./chunk-LXQPIAN7.js";import"./chunk-FTDD7QBB.js";import"./chunk-DB3UIQCU.js";import"./chunk-SBHKMV3P.js";import"./chunk-R4A63S45.js";import"./chunk-ETE32IYO.js";import"./chunk-ONUGDWDK.js";import"./chunk-SG7CQU4O.js";import{B as F,H as g}from"./chunk-QHVIRF5H.js";import{I as q,g as j,h as Q}from"./chunk-WZDN6K3C.js";import{a as c}from"./chunk-QGVBCWUY.js";import"./chunk-OJQ73TPF.js";import"./chunk-354SCPDU.js";import"./chunk-OVHPPCBL.js";import"./chunk-IYZFKXJ6.js";import{b as f}from"./chunk-CKJ56T2Q.js";import"./chunk-SNFOAZZQ.js";import"./chunk-F6JAWRPN.js";import{r as x}from"./chunk-UHRSAPGQ.js";import{m as H}from"./chunk-V76GWARL.js";import"./chunk-N2WTMF3X.js";var E=class extends se{constructor(e){super("SceneLayerWorker","dracoDecompressPointCloudData",{dracoDecompressPointCloudData:r=>[r.geometryBuffer]},e,{hasInitialize:!0})}};var C=class extends T{constructor(e,r){super(),this._updateAndCompare=e,this._notifyUpdated=r,this._nodes=new Map,this._graphics=new Map,this._duplicates=new Map}clear(){if(this._graphics.size>0){let e=this.toArray();this._graphics.clear(),this.emit("change",{added:[],removed:e})}this._nodes.clear()}get length(){return this._graphics.size}get(e){return this._graphics.get(e)}getNode(e){return this._nodes.get(e)}hasNode(e){return this._nodes.has(e)}nodes(){return this._nodes.values()}addNode(e,r){this._nodes.set(e,r);let i=r.graphics;if(i.length===0)return;let s=new Set;for(let a=0;a<i.length;a++){let n=i[a],d=n.objectId,p=this._graphics.get(d);if(p){s.add(d),n!==p&&(i[a]=p);let h=this._duplicates.get(d);h?h.push(e):this._duplicates.set(d,[p.nodeIndex,e])}else n.nodeIndex=e,this._graphics.set(d,n)}s.size&&this._updateForeignGraphics(r);let o=s.size>0?i.filter(a=>!s.has(a.objectId)):i;o.length>0&&this.emit("change",{added:o,removed:[]})}removeNode(e){let r=this._nodes.get(e);if(!r)return;this._nodes.delete(e);let i=new Set,s=[];for(let o of r.graphics){let a=o.objectId,n=this._graphics.get(a);if(!n)continue;let d=this._duplicates.get(a);if(d){let p=d.indexOf(e);if(p===-1)continue;if(d.splice(p,1),n.nodeIndex===e){let h=this.getNode(d[0]);for(let l=1;l<d.length;l++){let y=this.getNode(d[l]);(h==null||y!=null&&y.node.level>h.node.level)&&(h=y)}h!=null&&i.add(h)}d.length===1&&this._duplicates.delete(a)}else this._graphics.delete(a),s.push(o)}s.length>0&&this.emit("change",{added:[],removed:s}),i.forEach(o=>this._updateForeignGraphics(o))}_updateForeignGraphics(e){let r=[],i=e.node.index,s=e.node.level,o=0;for(;o<e.graphics.length;){let a=e.graphics[o].nodeIndex;if(a===i){o++;continue}let n=1;for(;o+n<e.graphics.length&&e.graphics[o+n].nodeIndex===a;)n++;let d=this.getNode(a);if(d!=null&&d.node.level>s)o+=n;else{for(let p=o;p<o+n;p++){let h=e.graphics[p];h.nodeIndex=i,this._updateAndCompare(h,e,p)&&r.push(h)}o+=n}}r.length>0&&this._notifyUpdated(r)}toArray(){return Array.from(this._graphics.values())}find(e){return Q(this._graphics,e)}some(e){return j(this._graphics,e)}forEach(e){this._graphics.forEach(r=>e(r))}forEachNode(e){this._nodes.forEach((r,i)=>e(r,i))}get nodeCount(){return this._nodes.size}_checkInvariants(){let e=new Map;this._nodes.forEach((r,i)=>{r.graphics.forEach(s=>{e.set(s.objectId,1+(e.get(s.objectId)??0)),this._duplicates.get(s.objectId)})}),e.forEach((r,i)=>{let s=this._graphics.get(i);if(!s||!this._nodes.get(s.nodeIndex))return;let o=this._duplicates.get(i);o&&o.forEach(a=>{this._nodes.get(a)})})}};var Ae=Fe(),L=class{constructor(e,r,i,s){this.graphics=e,this.featureIds=r,this.attributeInfo=i,this.node=s}get cachedMemory(){return this.graphics.reduce((e,r)=>ee(r)+e,K(this.featureIds)+1024)}},u=class extends Ie(ve(Ne(fe(Ge)))){constructor(){super(...arguments),this.type="scene-layer-graphics-3d",this._queryEngine=null,this._memCache=null,this._interactiveEditingSessions=new Map,this._pendingEditsQueue=Promise.resolve(),this.loadedGraphics=new C((t,e,r)=>Re(t,e,r),t=>this.processor.graphicsCore.recreateGraphics(t)),this.holeFilling="always",this.progressiveLoadFactor=1,this.supportsHeightUnitConversion=!0,this._coordinatesOutsideExtentErrors=0,this._maxCoordinatesOutsideExtentErrors=20}tryRecycleWith(t,e){return t.url===this.layer.url&&this._i3sOverrides.isEmpty?t.load(e).then(()=>{le(this.layer,t,this._i3sOverrides),this.layer=t,this._i3sOverrides.destroy();let r=this.view.resourceController?.memoryController;this._i3sOverrides=new M({view:this.view,layer:t,memoryController:r}),f(this._queryEngine),this._setupQueryEngine(),this.processor.resetObjectStates()}):null}initialize(){this.addResolvingPromise(this.layer.indexInfo);let t=this.view.resourceController?.memoryController;this._i3sOverrides=new M({view:this.view,layer:this.layer,memoryController:t}),he(this.layer,this.view.spatialReference,this.view.viewingMode),this._fieldsHelper=new Se({layerView:this}),this._updatingHandles.add(()=>this.layer.rangeInfos,e=>this._rangeInfosChanged(e),w),this._updatingHandles.add(()=>this.layer.renderer,(e,r)=>this._rendererChange(e,r)),this._updatingHandles.add(()=>[this.parsedDefinitionExpression,this._excludeObjectIdsSorted],()=>this._filterChange()),this.addHandles(k(()=>N.I3S_TREE_SHOW_TILES,e=>{if(e&&!this._treeDebugger){let r=this._controller.crsIndex;import("./chunk-3Z25RBD6.js").then(({I3STreeDebugger:i})=>{!this._treeDebugger&&N.I3S_TREE_SHOW_TILES&&(this._treeDebugger=new i({lv:this,view:this.view,nodeSR:r}))})}else e||!this._treeDebugger||N.I3S_TREE_SHOW_TILES||(this._treeDebugger.destroy(),this._treeDebugger=null)},w)),this._set("processor",new we({owner:this,preferredUpdatePolicy:me.ASYNC,scaleVisibilityEnabled:!0,filterVisibilityEnabled:!0,timeExtentEnabled:!1,frustumVisibilityEnabled:!1,elevationAlignmentEnabled:!0,elevationFeatureExpressionEnabled:!1,setUidToIdOnAdd:!1,dataExtent:this.layer.fullExtent,updateClippingExtent:e=>this._updateClippingExtent(e)})),this.processor.elevationAlignment?.events.on("invalidate-elevation",({extent:e,spatialReference:r})=>this._controller.updateElevationChanged(e,r)),this.supportsHeightUnitConversion&&(this._verticalScale=$("point",this.layer.spatialReference,this.view.spatialReference)),this.addResolvingPromise(this.processor.when()),this._memCache=this.view.resourceController.memoryController.newCache(`psl-${this.uid}`),this._controller=new be({layerView:this}),ne(this.layer.geometryDefinitions)&&(this._worker=new E(e=>this.view.resourceController.immediate.schedule(e))),this.addHandles(this.layer.on("apply-edits",e=>this._updatingHandles.addPromise(e.result))),this.addHandles(this.layer.on("edits",e=>{let r=this._pendingEditsQueue.then(()=>this._handleEdits(e)).then();this._pendingEditsQueue=r,this._updatingHandles.addPromise(r)})),this.when(()=>{this._setupQueryEngine(),this._updatingHandles.add(()=>this.maximumNumberOfFeatures,e=>this._controller.featureTarget=e,w),this._updatingHandles.add(()=>this.suspended,e=>{e&&this._removeAllNodeData()})})}destroy(){this._treeDebugger=f(this._treeDebugger),this._i3sOverrides=f(this._i3sOverrides),this._set("processor",f(this.processor)),this._controller=f(this._controller),this._queryEngine=f(this._queryEngine),this._worker=f(this._worker),this._memCache=f(this._memCache),this.loadedGraphics.clear(),this._fieldsHelper=f(this._fieldsHelper)}get i3slayer(){return this.layer}get updatingProgressValue(){return this._controller?.updatingProgress??1}get requiredFields(){return this._fieldsHelper?.requiredFields??[]}get maximumNumberOfFeatures(){return this.processor?.graphicsCore?.displayFeatureLimit?.maximumNumberOfFeatures??0}set maximumNumberOfFeatures(t){t!=null?(this._override("maximumNumberOfFeatures",t),this._controller.fixedFeatureTarget=!0):(this._clearOverride("maximumNumberOfFeatures"),this._controller.fixedFeatureTarget=!1)}get maximumNumberOfFeaturesExceeded(){return!this.suspended&&!!this._controller?.useMaximumNumberOfFeatures&&!this._controller.leavesReached}get _excludeObjectIdsSorted(){let t=this.layer.excludeObjectIds;return t.length?t.toArray().sort((e,r)=>e-r):null}get lodFactor(){return this.layer.semantic==="Labels"?1:this.view.qualitySettings.sceneService.point.lodFactor}get hasM(){return!1}get hasZ(){return!0}get contentVisible(){return!this.suspended&&!!this._controller?.rootNodeVisible}get legendEnabled(){return this.contentVisible&&this.i3slayer?.legendEnabled===!0}async whenGraphicAttributes(t,e){return de(this.layer,t,this._getObjectIdField(),e,()=>[...this.loadedGraphics.nodes()])}getHit(t){if(!this.loadedGraphics)return null;let e=ce(this.loadedGraphics.find(i=>i.uid===t),this.layer),r=this._getObjectIdField();return e?.attributes?.[r]?(e.layer=this.layer,e.sourceLayer=this.layer,{type:"graphic",graphic:e,layer:e.layer}):null}whenGraphicBounds(t,e){return this.processor.whenGraphicBounds(t,e)}computeAttachmentOrigin(t,e){return this.processor.computeAttachmentOrigin(t,e)}isUpdating(){return!!(this._controller?.updating||this.processor?.updating||this._fieldsHelper?.updating||this.layerFilterUpdating)}highlight(t,e){return this.processor.highlight(t,this.layer.objectIdField,e?.name??ue)}get updatePolicy(){return this.processor.graphicsCore.effectiveUpdatePolicy}createInteractiveEditSession(t){return Ce(this._attributeEditingContext,t)}async _decompressBinaryPointData(t,e){let r={geometryBuffer:t.geometryBuffer};this._worker==null&&(this._worker=new E(s=>this.view.resourceController.immediate.schedule(s)));let i=await this._worker.invoke(r,e);if(i==null)throw new Error("Failed to decompress Draco point data");return{positionData:i.positions,featureIds:i.featureIds}}async addNode(t,e,r){if(!R(e)&&!Me(e))throw new Error;if(this.loadedGraphics.hasNode(t.index))return void x.getLogger(this).error("I3S node "+t.id+" already added");let i=this.layer.fullExtent!=null?Ve(this.layer.fullExtent.clone(),.5):null,{featureIds:s,pointPositions:o}=R(e)?await this._extractBinaryPointPositions(t,e,r):this._extractLegacyPointPositions(e),a=new Array;this._validatePositions(t,s,o,i,a);let n=this._controller.crsVertex,d=this.view.spatialReference;G(o,n,0,o,d,0,s.length);let p=R(e)?t.level:0,h=this._createGraphics(s,o,t.index,p),l=new L(h,s,e.attributeDataInfo,t);if(await this._i3sOverrides.applyAttributeOverrides(l.featureIds,e.attributeDataInfo,r),t.numFeatures=l.graphics.length,this._updateNodeMemory(t),V(l),a.length>0&&(this._computeObb(t,a,n),this._controller.updateVisibility(t.index)),!this._controller.isGeometryVisible(t))return void this._cacheNodeData(l);if(this._verticalScale!=null)for(let I of l.graphics)this._verticalScale(I.geometry);let y=this.view._stage.renderView.olidRenderHelper;if(y){let I=Y(this.view.map,this.layer.uid);for(let m=0;m<l.featureIds.length;m++){let O=l.featureIds[m];y.setUidToObjectAndLayerId(O,l.graphics[m].uid,this.layer.id,this.layer.uid,this.layer.popupEnabled&&!I&&pe(this.layer,this.view.popup?.defaultPopupTemplateEnabled),l.node.resources.attributes,m)}}this.loadedGraphics.addNode(t.index,l),this._controller.updateLoadStatus(t.index,!0),this._filterNode(l),this._treeDebugger&&this._treeDebugger.update()}_computeObb(t,e,r){let i=this._controller.crsIndex,s=i.isGeographic?this.view.renderSpatialReference:i;G(e,r,0,e,s,0),t.serviceObbInIndexSR=ie(new re(e,3)),i.isGeographic&&(ae(t.serviceObbInIndexSR.center,s,v,i),t.serviceObbInIndexSR.center=v)}isNodeLoaded(t){return this.loadedGraphics.hasNode(t)}isNodeReloading(){return!1}updateNodeState(){}async _extractBinaryPointPositions(t,e,r){let i=await this._decompressBinaryPointData(e,r),s=i.positionData,o=3,a=s.length/o,n=S(3*a),d=t.serviceObbInIndexSR!=null?t.serviceObbInIndexSR.center:W,p=Math.abs(d[2])*2**-20;for(let h=0;h<a;h++){let l=h*o;n[l]=s[l]+d[0],n[l+1]=s[l+1]+d[1],n[l+2]=s[l+2]+d[2],Math.abs(n[l+2])<p&&(n[l+2]=0)}return{featureIds:i.featureIds?Z(i.featureIds):[],pointPositions:n}}_extractLegacyPointPositions(t){let e=t.pointData.length,r=S(3*e),i=new Array;for(let s=0;s<e;s++){let o=t.pointData[s],a=o.featureDataPosition,n=a.length,d=o.geometries?.[0]??Le[n],p=o.featureIds[0];if(d.type!=="Embedded"||d.params.type!=="points"||n<2||n>3)continue;let h=d.params.vertexAttributes?.position??[0,0,0],l=3*i.length;r[l]=a[0]+h[0],r[l+1]=a[1]+h[1],r[l+2]=n===3?a[2]+h[2]:NaN,i.push(p)}return{featureIds:i,pointPositions:r}}_validatePositions(t,e,r,i,s){if(i==null&&t.serviceObbInIndexSR)return;let o=e.length,a=3;for(let n=0;n<o;n++){let d=n*a;X(v,r[d],r[d+1],r[d+2]);let p=!Number.isNaN(r[2]);i==null||(p?z(i,v):U(i,v))||(this._coordinatesOutsideExtentErrors<this._maxCoordinatesOutsideExtentErrors&&x.getLogger(this).error("Service Error: Coordinates outside of layer extent"),this._coordinatesOutsideExtentErrors+1===this._maxCoordinatesOutsideExtentErrors&&x.getLogger(this).error("Maximum number of errors reached. Further errors are ignored."),this._coordinatesOutsideExtentErrors++),t.serviceObbInIndexSR||s.push(v[0],v[1],v[2])}}_createGraphics(t,e,r,i){let s=t.length,o=3,a=this._getObjectIdField(),n=this.processor.graphicsCore,d=new Array,p=this.view.spatialReference;for(let h=0;h<s;h++){let l=t[h],y={};l!=null&&(y[a]=l);let I=l??F(),m=h*o,O=isNaN(e[m+2])?void 0:e[m+2],D=oe(e[m],e[m+1],O,p),b=this.loadedGraphics.get(I);if(b!=null)(b.level==null||b.level<i)&&(_.property="geometry",_.graphic=b,_.oldValue=b.geometry,_.newValue=D,b.geometry=D,b.level=i,n.graphicUpdateHandler(_)),d.push(b);else{let Pe=F();d.push({objectId:I,uid:Pe,geometry:D,attributes:y,visible:!0,nodeIndex:r,level:i})}}return d}_updateNodeMemory(t){t.memory=4096+(t.numFeatures!=null?t.numFeatures*this.processor.graphicsCore.usedMemoryPerGraphic:0)}_cacheNodeData(t){this._memCache.put(this._getMemCacheKey(t.node),t)}_getMemCacheKey(t){return`${t.index}`}_removeAllNodeData(){this.loadedGraphics.forEachNode((t,e)=>{if(t){let r=t.node;this._updateNodeMemory(r),this._cacheNodeData(t)}this._controller.updateLoadStatus(e,!1)}),this._treeDebugger&&this._treeDebugger.update(),this.loadedGraphics.clear()}removeNode(t){let e=this._removeNodeStageData(t);e&&(this._updateNodeMemory(e.node),this._cacheNodeData(e))}_removeNodeStageData(t){let e=this.loadedGraphics.getNode(t);return e==null?null:(this._controller.updateLoadStatus(t,!1),this.loadedGraphics.removeNode(t),this._treeDebugger&&this._treeDebugger.update(),e)}async loadCachedNodeData(t){return this._memCache?.pop(this._getMemCacheKey(t))}async addCachedNodeData(t,e,r,i){this.loadedGraphics.hasNode(t.index)?x.getLogger(this).error("I3S node "+t.id+" already added"):(await this._i3sOverrides.applyAttributeOverrides(e.featureIds,r,i),e.attributeInfo=r,this.loadedGraphics.addNode(t.index,e),this._controller.updateLoadStatus(t.index,!0),this._updateNodeMemory(t),V(e),this._filterNode(e),this._treeDebugger&&this._treeDebugger.update())}getLoadedNodeIds(){let t=[];return this.loadedGraphics.forEachNode(e=>t.push(e.node.id)),t.sort()}getVisibleNodes(){let t=new Array;return this.loadedGraphics.forEachNode(e=>t.push(e.node)),t}getLoadedNodeIndices(t){this.loadedGraphics.forEachNode((e,r)=>t.push(r))}getLoadedAttributes(t){let e=this.loadedGraphics.getNode(t);if(e?.attributeInfo!=null)return e.attributeInfo.loadedAttributes}getAttributeData(t){let e=this.loadedGraphics.getNode(t);if(e?.attributeInfo!=null)return e.attributeInfo.attributeData}_setAttributeData(t,e){let r=this.loadedGraphics.getNode(t);r?.attributeInfo!=null&&(r.attributeInfo.attributeData=e,this._attributeValuesChanged(r))}async updateAttributes(t,e,r){let i=this.loadedGraphics.getNode(t);i!=null&&(await this._i3sOverrides.applyAttributeOverrides(i.featureIds,e,r),i.attributeInfo=e,this._attributeValuesChanged(i))}_attributeValuesChanged(t){V(t),this._filterNode(t);let{processor:e}=this,{graphicsCore:r}=e;if(r.labelsEnabled){let i=t.node.index,s=new Array;t.graphics.forEach(o=>o.nodeIndex===i&&s.push(o.uid)),r.updateLabelingInfo(s)}e.refreshFilter()}_updateClippingExtent(t){return this._controller&&this._controller.updateClippingArea(t),!1}_getObjectIdField(){return this.layer.objectIdField||ge}_getGlobalIdField(){return this.layer.associatedLayer?.globalIdField}async _rendererChange(t,e){let{layer:{fieldsIndex:r}}=this,i=new Set,s,o;t?(await t.collectRequiredFields(i,r),s=Array.from(i).sort()):s=[],i.clear(),e?(await e.collectRequiredFields(i,r),o=Array.from(i).sort()):o=[],s.length===o.length&&s.every((a,n)=>s[n]===o[n])||this._reloadAllNodes()}_rangeInfosChanged(t){t!=null&&t.length>0&&x.getLogger(this).warn("Unsupported property: rangeInfos are currently only serialized to and from web scenes but do not affect rendering.")}_filterChange(){this.loadedGraphics.forEachNode(t=>this._filterNode(t))}_reloadAllNodes(){this._removeAllNodeData(),this._controller&&this._controller.restartNodeLoading()}_filterNode(t){let e=this.parsedDefinitionExpression,r=this._excludeObjectIdsSorted,i=this._getObjectIdField();for(let s of t.graphics){let o=s.visible,a=!e||this._evaluateClause(e,s),n=r==null||H(r,s.attributes[i])<0;s.visible=a&&n,o!==s.visible&&(_.graphic=s,_.property="visible",_.oldValue=o,_.newValue=s.visible,this.processor.graphicsCore.graphicUpdateHandler(_))}}createQuery(){let t={outFields:["*"],returnGeometry:!0,outSpatialReference:this.view.spatialReference};return this.filter!=null?this.filter.createQuery(t):new A(t)}queryFeatures(t,e){return this._queryEngine.executeQuery(this._ensureQuery(t),e?.signal)}queryObjectIds(t,e){return this._queryEngine.executeQueryForIds(this._ensureQuery(t),e?.signal)}queryFeatureCount(t,e){return this._queryEngine.executeQueryForCount(this._ensureQuery(t),e?.signal)}queryExtent(t,e){return this._queryEngine.executeQueryForExtent(this._ensureQuery(t),e?.signal)}_ensureQuery(t){return this._addDefinitionExpressionToQuery(t==null?this.createQuery():A.from(t))}_setupQueryEngine(){let{layer:t,view:e,hasM:r,hasZ:i}=this,{spatialReference:s,resourceController:o}=e,a=new Ee(s,t,o,()=>this.processor.featureStore,i,r);this._queryEngine=new xe({context:a,priority:J.FEATURE_QUERY_ENGINE})}get usedMemory(){return this.processor?.graphicsCore?.usedMemory??0}get unloadedMemory(){return .8*((this._controller?.unloadedMemoryEstimate??0)+(this.processor?.graphicsCore?.unprocessedMemoryEstimate??0))}get ignoresMemoryFactor(){return this._controller&&this._controller.fixedFeatureTarget}async _handleEdits(t){let e=this._attributeEditingContext,r=await Oe(e,t);De(e,r)}get _attributeEditingContext(){let t=this._getObjectIdField(),e=this._getGlobalIdField();return{sessions:this._interactiveEditingSessions,fieldsIndex:this.layer.fieldsIndex,objectIdField:t,globalIdField:e,forEachNode:r=>this.loadedGraphics.forEachNode(i=>r(i.node,i.featureIds)),attributeStorageInfo:this.i3slayer.attributeStorageInfo??[],i3sOverrides:this._i3sOverrides,getAttributeData:r=>this.getAttributeData(r),setAttributeData:(r,i,s)=>{this._setAttributeData(r,i);let o=this.loadedGraphics.getNode(r);if(s!=null){let a=this.loadedGraphics.get(s.attributes[t]);a!=null&&this.processor.graphicsCore.recreateGraphics([a])}else o!=null&&this.processor.graphicsCore.recreateGraphics(o.graphics)},clearMemCache:()=>{}}}get performanceInfo(){return new _e(this.usedMemory,this.loadedGraphics.length,-1,this.maximumNumberOfFeatures,this.loadedGraphics.nodeCount,this.processor.graphicsCore.performanceInfo)}get test(){}};c([g()],u.prototype,"processor",void 0),c([g({type:te})],u.prototype,"filter",void 0),c([g()],u.prototype,"loadedGraphics",void 0),c([g()],u.prototype,"i3slayer",null),c([g()],u.prototype,"_controller",void 0),c([g()],u.prototype,"updating",void 0),c([g()],u.prototype,"suspended",void 0),c([g()],u.prototype,"holeFilling",void 0),c([g(ye)],u.prototype,"updatingProgress",void 0),c([g()],u.prototype,"updatingProgressValue",null),c([g(Ae.requiredFields)],u.prototype,"requiredFields",null),c([g(Ae.availableFields)],u.prototype,"availableFields",void 0),c([g()],u.prototype,"_fieldsHelper",void 0),c([g({type:Number})],u.prototype,"maximumNumberOfFeatures",null),c([g({readOnly:!0})],u.prototype,"maximumNumberOfFeaturesExceeded",null),c([g()],u.prototype,"_excludeObjectIdsSorted",null),c([g({readOnly:!0})],u.prototype,"lodFactor",null),c([g({readOnly:!0})],u.prototype,"hasM",null),c([g({readOnly:!0})],u.prototype,"hasZ",null),c([g()],u.prototype,"contentVisible",null),c([g({readOnly:!0})],u.prototype,"legendEnabled",null),u=c([q("esri.views.3d.layers.SceneLayerGraphicsView3D")],u);var jt=u;function Me(t){return"pointData"in t}function R(t){return"geometryBuffer"in t&&t.geometryBuffer!==null}function Re(t,e,r){let i=e.attributeInfo;if(i?.loadedAttributes==null||i.attributeData==null)return!1;let s=!1;for(let{name:o}of i.loadedAttributes)if(i.attributeData[o]){let a=P(i.attributeData[o],r);a!==t.attributes[o]&&(t.attributes[o]=a,s=!0)}return s}function V(t){let e=t.attributeInfo,r=t.node.index;if(e?.loadedAttributes!=null&&e.attributeData!=null)for(let i=0;i<t.graphics.length;i++){let s=t.graphics[i];if(s.nodeIndex===r){s.attributes||(s.attributes={});for(let{name:o}of e.loadedAttributes)e.attributeData[o]&&(s.attributes[o]=P(e.attributeData[o],i))}}}function Ve(t,e){return t.xmin-=e,t.ymin-=e,t.xmax+=e,t.ymax+=e,t.zmin!=null&&t.zmax!=null&&(t.zmin-=e,t.zmax+=e),t.mmin!=null&&t.mmax!=null&&(t.mmin-=e,t.mmax+=e),t}var Le={2:{type:"Embedded",params:{type:"points",vertexAttributes:{position:[0,0]}}},3:{type:"Embedded",params:{type:"points",vertexAttributes:{position:[0,0,0]}}}},v=B(),_={graphic:null,property:null,oldValue:null,newValue:null};export{jt as default};
