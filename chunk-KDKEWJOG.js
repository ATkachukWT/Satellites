import{a as ve}from"./chunk-KYSTRHK2.js";import{a as v,b as M,c as xe,e as Te}from"./chunk-JNLUD3YZ.js";import{a as ye}from"./chunk-IPMZUQ2D.js";import{a as R,b as T}from"./chunk-XCJ4FRLL.js";import{h as Me}from"./chunk-KE2U7ENE.js";import{b as le,e as ue,g as pe,h as he}from"./chunk-JAN3FVXP.js";import{c as ce,f as me,g as de}from"./chunk-F4HA2HQL.js";import{b as j}from"./chunk-2IWALBQY.js";import{a as re,b as ne}from"./chunk-PEYNLMWW.js";import{c as fe,f as x}from"./chunk-SZTSN5BD.js";import{a as _}from"./chunk-7GUYYJRR.js";import{j as se,k as oe,l as ae,m as ie}from"./chunk-NRRX2M6N.js";import{a as D}from"./chunk-EM2AEAFS.js";import{a as ge}from"./chunk-VGAXEXH3.js";import{a as te}from"./chunk-L7NOU4T2.js";import{a as W}from"./chunk-TMY7UIU7.js";import{a as F}from"./chunk-FGY3YBPM.js";import{b as V}from"./chunk-EDOVNTC7.js";import{a as f,h as ee}from"./chunk-YEXMIDOT.js";import{a as Y,e as $,g as N}from"./chunk-ONYJLWAD.js";import{d as X,e as K}from"./chunk-DJW5LMRG.js";import{b as Q}from"./chunk-DEH76MSI.js";import{a as g}from"./chunk-RWCIDBNQ.js";import{x as J}from"./chunk-HM5RIVQC.js";import{D as Z,L as E}from"./chunk-6B5XFA6F.js";import{c as U,d as G}from"./chunk-PTZYZULI.js";import{o as k}from"./chunk-NMLYCCKN.js";import{d as H,i as z}from"./chunk-BOVYXYHK.js";import{a}from"./chunk-QGVBCWUY.js";var A,q=null,O=new Map;async function Pe(r){q==null&&(A==null&&(A=import("./chunk-5G7ARCWM.js")),q=await A);let t=r.view,s=O.get(t);s||(s=new q.default({view:t}),O.set(t,s));let o=!!t._stage.renderView.renderingContext.capabilities.compressedTextureS3TC,n=!!t._stage.renderView.renderingContext.capabilities.compressedTextureETC;return await s.initializeWasm(o,n),s.add3DTilesLayerView(r)}function Se(r){return O.get(r)}function De(r){let t=r.view,s=O.get(t);s&&s.remove3DTilesLayerView(r)<1&&(O.delete(t),O.size===0&&(A=null,q=null))}var B=class extends ne{constructor(t,s){super(t,s,new re(Te,()=>import("./chunk-7DTI7YIT.js")),Oe)}initializePipeline(t){let{integratedMeshMode:s,output:o,blendingEnabled:n,cullFace:e,hasOccludees:l,hasPolygonOffset:c,oitPass:m}=t,y=s!==M.None,S=m===D.NONE,d=m===D.FrontFace;return ie({blending:ee(o)&&n?le(m):null,culling:se(e),depthTest:{func:pe(m)},depthWrite:S||d?oe:null,drawBuffers:o===f.Depth?{buffers:[J.NONE]}:he(m,o),colorWrite:ae,stencilWrite:y||l?ce:null,stencilTest:y?me($.IntegratedMeshMaskExcluded):l?de:null,polygonOffset:S||d?c?{factor:2,units:2}:null:ue})}},Oe=new Map([[g.POSITION,0],[g.NORMAL,1],[g.NORMALCOMPRESSED,1],[g.COLOR,2],[g.UV0,3],[g.UVREGION,4],[g.COMPONENTINDEX,5]]);var I=class extends te{constructor(){super(...arguments),this._dirty=!0}_setDirty(){this._dirty=!0}_setClean(){if(this._dirty=!1,this._parameterBlocks!=null)for(let t of this._parameterBlocks)this[t]._setClean()}get dirty(){return this._dirty||this._checkParameterBlocksDirty()}_checkParameterBlocksDirty(){if(this._parameterBlocks==null)return!1;for(let t of this._parameterBlocks)if(this[t].dirty)return!0;return!1}},b=class{constructor(){this._dirty=!0}_setDirty(){this._dirty=!0}_setClean(){this._dirty=!1}get dirty(){return this._dirty}};function i(r={}){return(t,s)=>{let o=t._parameterCount??0;if(t._parameterCount=o+1,r.vectorOps){let n=r.vectorOps;Object.defineProperty(t,s,{get(){return this[o]},set(e){let l=this[o];if(l==null)this[o]=[...e];else{if(n.equals(l,e))return;n.copy(l,e)}this._setDirty()}})}else Object.defineProperty(t,s,{get(){return this[o]},set(n){this[o]!==n&&(r.dispose&&this[o]&&this[o].dispose(),this[o]=n,this._setDirty())}})}}function L(){return(r,t)=>{let s=r._parameterCount??0;r._parameterCount=s+1,r._parameterBlocks=r._parameterBlocks||[],r._parameterBlocks.push(s),Object.defineProperty(r,t,{get(){return this[s]},set(o){this[s]!==o&&(this[s]=o,this._setDirty())}})}}var u=class extends I{constructor(t,s){super(),this.toMapSpace=s,this.baseColor=G(1,1,1,1),this.usePBR=!1,this.hasParametersFromSource=!1,this.mrrFactors=fe,this.emissiveFactor=H(0,0,0),this.baseColorTexture=null,this.metallicRoughnessTexture=null,this.emissionTexture=null,this.occlusionTexture=null,this.normalTexture=null,this.commonMaterialParameters=new w,this.componentParameters=new P,this.objectOpacity=1,this.textureAlphaCutoff=ge,this.alphaDiscardMode=N.Opaque,this.isIntegratedMesh=!1,this.polygonOffsetEnabled=!1,this.ellipsoidMode=ye.Earth,this.hasOccludees=!1;let o=new ve(t.position),n=Q(t.rotationScale);K(n,n),X(n,n),this.transformNormalGlobalFromModel=n,this.transformWorldFromModelTL=o.low,this.transformWorldFromModelTH=o.high,this.transformWorldFromModelRS=t.rotationScale}dispose(){this.baseColorTexture=null,this.metallicRoughnessTexture=null,this.emissionTexture=null,this.occlusionTexture=null,this.normalTexture=null}get texture(){return this.baseColorTexture?.glTexture}get textureMetallicRoughness(){return this.metallicRoughnessTexture?.glTexture}get textureEmissive(){return this.emissionTexture?.glTexture}get hasEmissions(){return this.emissionTexture!=null||!Z(this.emissiveFactor,z)}get textureOcclusion(){return this.occlusionTexture?.glTexture}get textureNormal(){return this.normalTexture?.glTexture}acquireTechnique(t,s,o,n){let e=new xe(t.context.spherical,t.context.doublePrecisionRequiresObfuscation);e.hasVertexColors=n.colors,e.hasNormals=n.hasNormals,e.textureCoordinateType=n.textureCoordinates,e.hasMetallicRoughnessTexture=this.metallicRoughnessTexture!=null,e.hasOcclusionTexture=this.occlusionTexture!=null,e.hasNormalTexture=this.normalTexture!=null,e.oitPass=s.identifier===T.Material&&o.oitPass!=null?o.oitPass:D.NONE,e.terrainDepthTest=s.identifier===T.Material&&o.terrainDepthTest,e.cullAboveTerrain=s.identifier===T.Material&&o.cullAboveTerrain,e.ellipsoidMode=this.ellipsoidMode,e.componentData=this.componentParameters.type,e.cullFace=this.commonMaterialParameters.cullFace,e.doubleSidedMode=this.commonMaterialParameters.doubleSided?j.View:j.None,e.hasColorTexture=this.baseColorTexture!=null;let l=this._computeWhichMaterialPass();if(e.blendingEnabled=l===h.Transparent||l===h.OpaqueAndTransparent,e.alphaDiscardMode=this.alphaDiscardMode,e.integratedMeshMode=this.isIntegratedMesh?we(o)?Ce(o)?M.ColorOverlayWithWater:M.ColorOverlay:M.NoOverlay:M.None,e.hasPolygonOffset=this.polygonOffsetEnabled,e.pbrMode=e.integratedMeshMode===M.ColorOverlayWithWater?x.WaterOnIntegratedMesh:this.usePBR?this.hasParametersFromSource?n.shadeNormals&&this.isIntegratedMesh?x.Disabled:x.Schematic:x.Normal:x.Disabled,e.emissionSource=this.emissionTexture!=null?_.Texture:e.pbrMode===x.Normal?_.Value:_.None,e.shadeNormals=n.shadeNormals,e.normalType=e.hasNormals?V.Compressed:V.ScreenDerivative,e.hasSlicePlane=o.slicePlane!=null&&this.commonMaterialParameters.hasSlicePlane,s.identifier===T.ShadowMap)e.output=f.Shadow,e.vertexDiscardMode=v.None;else if(s.identifier===T.ViewshedShadowMap)e.output=f.ViewshedShadow,e.vertexDiscardMode=v.None;else if(s.identifier===T.Highlight)e.output=f.Highlight,e.vertexDiscardMode=v.None;else{switch(l===h.OpaqueAndTransparent?e.vertexDiscardMode=s.transparent?v.Opaque:v.Transparent:e.vertexDiscardMode=v.None,e.output=s.output,e.receiveAmbientOcclusion=e.receiveShadows=!1,s.output){case f.Color:case f.ColorEmission:e.receiveAmbientOcclusion=n.applySSAO&&o.ssao!=null,e.hasOccludees=o.hasOccludees,e.receiveShadows=o.shadowMap.ready,e.screenSpaceReflections=o.ssr.lastFrameColor!=null,e.cloudReflections=o.clouds.data!=null;break;case f.ObjectAndLayerIdColor:e.objectAndLayerIdColor=!0}e.snowCover=this.hasSnowCover(o)}let c=t.get(B,e);return this._setClean(),c}hasSnowCover(t){return t.weather!=null&&t.weatherVisible&&t.weather.type==="snowy"&&t.weather.snowCover==="enabled"}submit(t,s,o){if(this.objectOpacity<=0)return;let{componentData:n,renderable:e}=o,{geometry:l}=e,c=e.meta.cameraDepthSquared;n.updateHighlights(s.highlights);let{geometryRanges:m,highlightRangesMap:y,shadowmapRanges:S}=n;switch(this._computeWhichMaterialPass()){case h.Opaque:t.opaque.submitDraw(this,l,m,c);break;case h.Transparent:t.transparent.submitDraw(this,l,m,c);break;case h.OpaqueAndTransparent:t.opaque.submitDraw(this,l,m,c),t.transparent.submitDraw(this,l,m,c);break;case h.IntegratedMesh:t.integratedMesh.submitDraw(this,l,m,c),be(s)&&t.highlightIntegratedMesh.submitDraw(this,l,m,c)}if(this.componentParameters.castShadows!==p.None){if(y!=null)for(let d of y)d[0]===Me&&t.highlightShadowMap.submitDraw(this,l,d[1],c,d[0]);S!=null&&t.nonHighlightShadowMap.submitDraw(this,l,S,c),t.shadowMap.submitDraw(this,l,m,c)}if(y!=null)for(let d of y)t.highlight.submitDraw(this,l,d[1],c,d[0]);s.viewshedEnabled&&t.viewshedShadowMap.submitDraw(this,l,m,c)}_computeWhichMaterialPass(){if(this.isIntegratedMesh)return h.IntegratedMesh;if(this.objectOpacity<1)return h.Transparent;if(this.componentParameters.opaqueOverride===p.All)return h.Opaque;if(this.baseColor[3]<1||this.alphaDiscardMode===N.Blend||this.alphaDiscardMode===N.MaskBlend)return h.Transparent;switch(this.componentParameters.transparent){case p.None:return h.Opaque;case p.All:return h.Transparent;case p.Some:return h.OpaqueAndTransparent}}},h,p;a([i({vectorOps:k})],u.prototype,"baseColor",void 0),a([i()],u.prototype,"usePBR",void 0),a([i()],u.prototype,"hasParametersFromSource",void 0),a([i({vectorOps:E})],u.prototype,"mrrFactors",void 0),a([i({vectorOps:E})],u.prototype,"emissiveFactor",void 0),a([i({dispose:!0})],u.prototype,"baseColorTexture",void 0),a([i({dispose:!0})],u.prototype,"metallicRoughnessTexture",void 0),a([i({dispose:!0})],u.prototype,"emissionTexture",void 0),a([i({dispose:!0})],u.prototype,"occlusionTexture",void 0),a([i({dispose:!0})],u.prototype,"normalTexture",void 0),a([L()],u.prototype,"commonMaterialParameters",void 0),a([L()],u.prototype,"componentParameters",void 0),a([i()],u.prototype,"objectOpacity",void 0),a([i()],u.prototype,"textureAlphaCutoff",void 0),a([i()],u.prototype,"alphaDiscardMode",void 0),a([i()],u.prototype,"isIntegratedMesh",void 0),a([i()],u.prototype,"polygonOffsetEnabled",void 0),a([i()],u.prototype,"ellipsoidMode",void 0),a([i()],u.prototype,"hasOccludees",void 0),function(r){r[r.Opaque=0]="Opaque",r[r.Transparent=1]="Transparent",r[r.OpaqueAndTransparent=2]="OpaqueAndTransparent",r[r.IntegratedMesh=3]="IntegratedMesh"}(h||(h={}));var w=class extends b{constructor(){super(...arguments),this.doubleSided=!1,this.cullFace=Y.Back,this.hasSlicePlane=!0}};a([i()],w.prototype,"doubleSided",void 0),a([i()],w.prototype,"cullFace",void 0),a([i()],w.prototype,"hasSlicePlane",void 0);var P=class extends b{constructor(){super(...arguments),this.externalColor=U(1,1,1,1),this.externalColorMixMode=F.Multiply,this.castShadows=p.All}get transparent(){return this.externalColor[3]<1?p.All:p.None}get opaqueOverride(){return this.externalColorMixMode===F.Replace&&this.externalColor[3]===1?p.All:p.None}get visible(){return this.externalColor[3]>0?p.All:p.None}get type(){return W.Uniform}};a([i({vectorOps:k})],P.prototype,"externalColor",void 0),a([i()],P.prototype,"externalColorMixMode",void 0),a([i()],P.prototype,"castShadows",void 0),function(r){r[r.All=0]="All",r[r.Some=1]="Some",r[r.None=2]="None"}(p||(p={}));var C=class extends b{constructor(){super(...arguments),this.texture=null,this.transparent=p.None,this.opaqueOverride=p.None,this.castShadows=p.None}get type(){return W.Varying}};function be(r){return r.overlay?.getTexture(R.Highlight)!=null}function Ce(r){return r.overlay?.getTexture(R.WaterNormal)!=null}function we(r){return r.overlay?.getTexture(R.ColorNoRasterImage)!=null}a([i()],C.prototype,"texture",void 0),a([i()],C.prototype,"transparent",void 0),a([i()],C.prototype,"opaqueOverride",void 0),a([i()],C.prototype,"castShadows",void 0);export{Pe as a,Se as b,De as c,Oe as d,u as e,p as f,P as g,C as h};
