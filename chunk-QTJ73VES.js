import{c as Jt}from"./chunk-R2HHW4XT.js";import{n as Xt,s as $t,t as eo,v as Je,z as to}from"./chunk-LG7DXNE4.js";import{a as jt,m as Wt}from"./chunk-7GENY6TF.js";import{a as Zt,f as Ye,i as Qt,q as Yt}from"./chunk-7S2234XQ.js";import{a as qt}from"./chunk-5QOQFLF6.js";import{a as Kt}from"./chunk-2I3LIA7G.js";import{a as oo,c as ro}from"./chunk-MM2DY7NJ.js";import{a as so,c as io}from"./chunk-IDCT5OYA.js";import{a as Vt}from"./chunk-LSUWBOLF.js";import{a as Ee,g as Ht}from"./chunk-6SGUOKGX.js";import{a as Ut}from"./chunk-PSFZFYFC.js";import{b as Qe}from"./chunk-F4FOXK2P.js";import{c as ae}from"./chunk-SWCOPTUX.js";import{a as zt}from"./chunk-7WCQBAQY.js";import{a as q,b as j,c as we}from"./chunk-V4ZQZTCB.js";import{a as be,b as Se}from"./chunk-PEYNLMWW.js";import{l as xe,m as Ce}from"./chunk-NRRX2M6N.js";import{a as Gt}from"./chunk-MJO3PLZV.js";import{b as ne}from"./chunk-YU3IFRYW.js";import{a as kt}from"./chunk-XKFJ6GWH.js";import{b as Bt}from"./chunk-L7NOU4T2.js";import{b as Lt}from"./chunk-7JW7DYCQ.js";import{b as Nt}from"./chunk-EDOVNTC7.js";import{b as F}from"./chunk-YQNUGDFH.js";import{a as _e}from"./chunk-QCZ3ZIGQ.js";import{a as Ae}from"./chunk-ONYJLWAD.js";import{a as Ft,c as Ke,d as Ze}from"./chunk-QWLNRA4Y.js";import{a as oe}from"./chunk-HBZAOVHW.js";import{b as ye}from"./chunk-XIZXEWWA.js";import{b as ge}from"./chunk-BHB4UQZT.js";import{q as Mt}from"./chunk-DJW5LMRG.js";import{a as H}from"./chunk-ALWV3RJ2.js";import{a as Dt}from"./chunk-DEH76MSI.js";import{a as Pt,b as Ue}from"./chunk-G27DRLGO.js";import{a as I,c as U,d as Ct,f as St,y as wt}from"./chunk-KD27XIJC.js";import{k as Et}from"./chunk-XRRQM4E2.js";import{a as Tt,b as It}from"./chunk-QCRXBE6I.js";import{b as te,e as fe}from"./chunk-Y6YEAKJ5.js";import{a as P}from"./chunk-RWCIDBNQ.js";import{a as qe,b as je,f as We,i as ie,j as z,r as Ot}from"./chunk-HM5RIVQC.js";import{G as He,b as vt,c as V,e as Ve,m as Rt,u as ee,w as ze,y as se}from"./chunk-6B5XFA6F.js";import{e as At,f as _t}from"./chunk-ZTOZWLEE.js";import{a as E,b as ft,e as gt,i as yt}from"./chunk-BOVYXYHK.js";import{p as xt}from"./chunk-B3FO6PT7.js";import{a as bt}from"./chunk-BCREO4Q5.js";import{a as Be,j as ke}from"./chunk-MWSXMSWY.js";import{c as Ge}from"./chunk-YR2HD3ZC.js";import{m as dt}from"./chunk-LFH24RLM.js";import{n as ut}from"./chunk-Z5Q7KLA4.js";import{fa as ht}from"./chunk-KGVXGH6H.js";import{H as T,J as mt}from"./chunk-QHVIRF5H.js";import{I as $}from"./chunk-WZDN6K3C.js";import{a as v}from"./chunk-QGVBCWUY.js";import{b as Le}from"./chunk-CKJ56T2Q.js";import{b as de,t as pt}from"./chunk-UHRSAPGQ.js";import{a as J,b as X}from"./chunk-N2WTMF3X.js";function Ko(e,t,o){let s=(t.length>0?t[0]:e.length/3)-1,r=Ft(e,s,o);if(r!==bt.Z){e=e.slice();for(let i=0;i<e.length;i+=3)e[i+r]=e[i+2]}return oe(e,t,3)}function Zo(e){let t=[[P.POSITION,new F(e.attributeData.position,e.indices,3,!0)]],o=fe(e.indices.length);return e.attributeData.colorFeature!=null?t.push([P.COLORFEATUREATTRIBUTE,new F([e.attributeData.colorFeature],o,1,!0)]):e.attributeData.color&&t.push([P.COLOR,new F(e.attributeData.color,o,4,!0)]),e.attributeData.uvMapSpace&&t.push([P.UVMAPSPACE,new F(e.attributeData.uvMapSpace,e.indices,4,!0)]),e.attributeData.boundingRect&&t.push([P.BOUNDINGRECT,new F(e.attributeData.boundingRect,e.indices,9,!0)]),new ae(e.material,t,e.mapPositions,ne.Mesh,e.attributeData.objectAndLayerIdColor)}function Qo(e,t=null){let o=[[P.POSITION,new F(e.attributeData.position,e.indices,3,!0)],[P.UV0,new F(e.attributeData.uv0,e.indices,2,!0)]];return new ae(e.material,o,e.mapPositions,ne.Mesh,t)}function ao(e){switch(e.type){case"extent":if(e instanceof dt)return xt.fromExtent(e);break;case"polygon":return e}return null}var no=class{constructor(t,o,s){this.renderData=t,this.layerUid=o,this.graphicUid=s,this.outGeometries=new Array}};function ve(e,t,o,s){let r=Ke(e.rings,!!e.hasZ&&s.mode!=="on-the-ground",Ze.CCW_IS_HOLE,e.spatialReference),i=I(r.position.length),n=Zt(r.position,e.spatialReference,0,i,0,r.position,0,r.position.length/3,t,o,s),c=n!=null;return new et(r.position,i,lo(r.polygons,r.position,i),co(r.outlines,r.position,i),c,n)}function or(e,t){let o=Ke(e.rings,!1,Ze.CCW_IS_HOLE),s=Et(o.position,e.spatialReference,0,o.position,t,0);for(let r=2;r<o.position.length;r+=3)o.position[r]=Wt;return{position:o.position,polygons:lo(o.polygons,o.position),outlines:co(o.outlines,o.position),projectionSuccess:s}}function co(e,t,o=null){return e.filter(({count:s})=>s>1).map(({index:s,count:r})=>{let i=3*s,n=3*r;return o!=null?new Pe(s,r,U(t,i,n),U(o,i,n)):new ce(s,r,U(t,i,n))})}function lo(e,t,o=null){let s=new Array;for(let{index:r,count:i,holeIndices:n,pathLengths:c}of e){if(i<=1)continue;let a=3*r,u=3*i,d=n.map(g=>g-r),b=o!=null?new Xe(r,i,U(t,3*r,3*i),U(o,a,u),d,c):new $e(r,i,U(t,3*r,3*i),d,c);s.push(b)}return s}var ce=class{constructor(t,o,s){this.index=t,this.count=o,this.position=s}},Pe=class extends ce{constructor(t,o,s,r){super(t,o,s),this.mapPositions=r}},Xe=class extends Pe{constructor(t,o,s,r,i,n){super(t,o,s,r),this.holeIndices=i,this.pathLengths=n}},$e=class extends ce{constructor(t,o,s,r,i){super(t,o,s),this.holeIndices=r,this.pathLengths=i}},et=class{constructor(t,o,s,r,i,n){this.position=t,this.mapPositions=o,this.polygons=s,this.outlines=r,this.projectionSuccess=i,this.sampledElevation=n}};var Eo=["polygon","extent"],po=class extends to{constructor(t,o,s,r){super(t,o,s,r),this.ensureDrapedStatus(!1)}async doLoad(){if(!this._drivenProperties.size){let u=Ht(this._getSymbolSize());if(u)throw new pt("graphics3dextrudesymbollayer:invalid-size",u)}let t=this.symbolLayer?.material?.color,o=this._getCombinedOpacityAndColor(t),s=gt(o),r=o[3],i=r<1||this.needsDrivenTransparentPass,n=this.symbolLayer?.material?.emissiveFactor,c=n?Rt(ft(n)):yt,a={usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!0,diffuse:s,ambient:s,opacity:r,transparent:i,cullFace:i?Ae.None:Ae.Back,hasVertexColors:!0,hasSlicePlane:this._context.slicePlaneEnabled,castShadows:this.symbolLayer.castShadows,emissiveFactor:c,offsetTransparentBackfaces:!0,normalType:Nt.Compressed};this._materials[D.Main]=new Qe(a,this._context),this._materials[D.Bottom]=new Qe(X(J({},a),{cullFace:Ae.Back}),this._context),this._context.stage.addMany(this._materials)}destroy(){super.destroy(),this._context.stage.removeMany(this._materials),this._materials.length=0}createGraphics3DGraphic(t){let o=t.graphic;if(!this._validateGeometry(o.geometry,Eo,this.symbolLayer.type))return null;let s=this._getVertexOpacityAndColor(t.renderingInfo,255),r=this.setGraphicElevationContext(o);return this._createAs3DShape(o,t.renderingInfo,s,r,o.uid)}layerOpacityChanged(t,o){let s=this.symbolLayer?.material?.color,r=this._getCombinedOpacity(s),i=r<1||this.needsDrivenTransparentPass;this._materials[D.Main]?.setParameters({opacity:r,transparent:i}),this._materials[D.Bottom]?.setParameters({opacity:r,transparent:i});let n=this._getLayerOpacity();t.forEach(c=>o(c)?.layerOpacityChanged(n,this._context.isAsync))}layerElevationInfoChanged(t,o){return this.updateGraphics3DGraphicElevationInfo(t,o,Ye)}slicePlaneEnabledChanged(t,o){return this._materials[D.Main]?.setParameters({hasSlicePlane:this._context.slicePlaneEnabled}),this._materials[D.Bottom]?.setParameters({hasSlicePlane:this._context.slicePlaneEnabled}),t.forEach(s=>{let r=o(s);r?.slicePlaneEnabledChanged(this._context.slicePlaneEnabled,this._context.isAsync)}),!0}physicalBasedRenderingChanged(){let t={usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!0};return this._materials[D.Main]?.setParameters(t),this._materials[D.Bottom]?.setParameters(t),!0}_getExtrusionSize(t){let o;return o=t.size&&this._drivenProperties.size?Jt(t.size,2)??0:this._getSymbolSize(),o/=this._context.renderCoordsHelper.unitInMeters,o}applyRendererDiff(t,o){return this._drivenPropertiesChanged(o)?Je.RecreateSymbol:Je.RecreateGraphics}async queryForSnapping(t,o,s,r){let i=this._getExtrusionSize(s)*this._context.renderCoordsHelper.unitInMeters/ht(o),{objectId:n,target:c}=t,a=de(c);switch(a.z=(a.z??0)+i,t.type){case"edge":{let{start:u,end:d}=t,b=de(u),g=de(d);return b.z=(b.z??0)+i,g.z=(g.z??0)+i,[Ue(n,a,1/0,b,g)]}case"vertex":return[Pt(n,a,1/0),Ue(n,c,1/0,c,a)];default:return[]}}_getSymbolSize(){return this.symbolLayer.size??1}_createAs3DShape(t,o,s,r,i){let n=ao(t.geometry);if(n==null)return null;if(n.rings.length===0||!n.rings.some(O=>O.length>0))return this._logGeometryValidationWarnings(n.rings,"rings","ExtrudeSymbol3DLayer"),null;let c=ve(n,this._context.elevationProvider,this._context.renderCoordsHelper,r);this._logGeometryCreationWarnings(c,n.rings,"rings","ExtrudeSymbol3DLayer");let a=Ee(n);if(a==null)return null;let u=new Array,d=new Array,b=Ct(),g=H(),x=E(),p=this._context.renderCoordsHelper.viewingMode===_e.Global;p||this._context.renderCoordsHelper.worldUpAtPosition(null,x),ge(n.spatialReference,[a.x,a.y,0],g,this._context.renderCoordsHelper.spatialReference);let y=H();_t(y,g);let A=Dt();Mt(A,y);let{polygons:f,mapPositions:h,position:_}=c,m=new Map,C=this._materials[D.Main];for(let O of f){let L=O.count;if(this._context.clippingExtent&&(St(O.mapPositions,b),!wt(b,this._context.clippingExtent)))continue;let G=oe(O.mapPositions,O.holeIndices,3);if(G.length===0)continue;let B=G.length,k=6*L,Me=te(k+B),De=te(B),ue=I(3*k),it=I(3*k),nt=I(3*k),at=I(k);st(_,h,G,O,ue,nt,it,at,Me,De,this._getExtrusionSize(o),x,p),ye(ue,ue,y);let ct=this._context.stage.renderView.getObjectAndLayerIdColor({graphicUid:i,layerUid:this._context.layer.uid}),Fe=new ot(ue,nt,It(it),at),Ne=mo(C,Me,Me.length-De.length,Fe,s,ct),Co=L,So=L,wo=2*O.count,lt=new rt(Co,So,wo,B/3);bo(Ne,lt,g),m.set(Ne,lt),u.push(Ne,mo(this._materials[D.Bottom],De,0,Fe,s,ct)),d.push(Fe.heights)}if(u.length===0)return null;let l=new qt({geometries:u,layerUid:this._context.layer.uid,graphicUid:i,isElevationSource:!0});l.transformation=g;let S=Lt(this.symbolLayer,{opacity:this._getLayerOpacity()}),w=S?new $t(this._materials[D.Main],S,this._context.slicePlaneEnabled):null,N=new eo(this,l,u,null,null,(O,L,G,B,k)=>Ro(O,L,G,B,k,d,m),r,w);return N.alignedSampledElevation=c.sampledElevation,N.needsElevationUpdates=Ye(r.mode),N}};function mo(e,t,o,s,r,i){let n=fe(t.length),c=[[P.POSITION,new F(s.positions,t,3,!0)],[P.NORMALCOMPRESSED,new F(s.normals,t,2,!0)],[P.COLOR,new F(r,n,4,!0)]];return new ae(e,c,s.elevation,ne.Mesh,i,o)}function st(e,t,o,s,r,i,n,c,a,u,d,b,g){{let x=o.length/3,p=2*s.count;Po(e,t,s.index,s.count,o,0,x,r,i,n,c,a,u,p,d,b,g)}{let x=0,p=2*s.count,y=0,A=s.pathLengths[0];ho(r,i,c,n,x,A,s.count,p,a,y,d),p+=4*A,y+=2*A,x+=A;for(let f=1;f<s.pathLengths.length;++f){let h=s.pathLengths[f];ho(r,i,c,n,x,h,s.count,p,a,y,d),p+=4*h,y+=2*h,x+=h}}}function Po(e,t,o,s,r,i,n,c,a,u,d,b,g,x,p,y,A){vt(M,y);{let f=p>0?1:-1,h=3*o,_=0,m=3*_,C=s,l=3*C;for(let S=0;S<s;++S){let w=e[h],N=e[h+1],O=e[h+2];A&&(M[0]=w,M[1]=N,M[2]=O,ee(M,M)),c[m+0]=w,c[m+1]=N,c[m+2]=O;let L=t[h+0],G=t[h+1],B=t[h+2];a[m+0]=L,a[m+1]=G,a[m+2]=B,u[m+0]=-f*M[0],u[m+1]=-f*M[1],u[m+2]=-f*M[2],d[_]=0,c[l+0]=w+p*M[0],c[l+1]=N+p*M[1],c[l+2]=O+p*M[2],a[l+0]=L,a[l+1]=G,a[l+2]=B,d[C]=p,m+=3,l+=3,h+=3,_+=1,C+=1}}{let f=3*i,h=0,_=3*x,m=p<0?_o:Ao,C=p<0?Ao:_o;for(let l=0;l<n;++l)g[h]=r[f+m[0]],g[h+1]=r[f+m[1]],g[h+2]=r[f+m[2]],b[_]=r[f+C[0]]+s,b[_+1]=r[f+C[1]]+s,b[_+2]=r[f+C[2]]+s,h+=3,_+=3,f+=3}}function Re(e,t,o,s,r,i,n){s[i]=s[n],n*=3,e[i*=3]=e[n],e[i+1]=e[n+1],e[i+2]=e[n+2],t[i]=t[n],t[i+1]=t[n+1],t[i+2]=t[n+2],o[i]=r[0],o[i+1]=r[1],o[i+2]=r[2]}var le=E();function ho(e,t,o,s,r,i,n,c,a,u,d){let b=r,g=r+1,x=r+n,p=r+n+1,y=c,A=c+1,f=c+2*i,h=c+2*i+1;d<0&&(b=r+n+1,p=r);let _=3*u;for(let m=0;m<i;++m)m===i-1&&(g=r,d>0?p=r+n:b=r+n),vo(e,b,g,x,le),Re(e,t,s,o,le,y,b),Re(e,t,s,o,le,A,g),Re(e,t,s,o,le,f,x),Re(e,t,s,o,le,h,p),a[_]=y,a[_+1]=f,a[_+2]=h,a[_+3]=y,a[_+4]=h,a[_+5]=A,_+=6,b++,g++,x++,p++,y+=2,A+=2,f+=2,h+=2}var tt=E(),uo=E(),fo=E(),go=E(),yo=E();function vo(e,t,o,s,r){t*=3,o*=3,s*=3,V(tt,e[t++],e[t++],e[t++]),V(uo,e[o++],e[o++],e[o++]),V(fo,e[s++],e[s++],e[s++]),Ve(go,uo,tt),Ve(yo,fo,tt),ze(r,yo,go),ee(r,r)}var re=E();function Ro(e,t,o,s,r,i,n){let c=e.stageObject,a=c.geometries,u=a.length,d=t.mode!=="absolute-height",b=0,g=c.transformation,x=At(H(),g);for(let p=0;p<u;p+=2){let y=a[p];if(!Xt(y))continue;let A=y.getMutableAttribute(P.POSITION).data,f=i[p/2],h=new Kt(y.mapPositions),_=A.length/3,m=!1,C=0;{let l=0;for(let S=0;S<_;S++){re[0]=A[l],re[1]=A[l+1],re[2]=A[l+2],s(h,Oe),d&&(C+=Oe.sampledElevation),Gt.TESTS_DISABLE_OPTIMIZATIONS?(V(R,h.array[h.offset],h.array[h.offset+1],Oe.z+f[l/3]),o!=null&&r.toRenderCoords(R,o,R),se(R,R,x)):(V(R,A[l],A[l+1],A[l+2]),se(R,R,g),r.setAltitude(R,Oe.z+f[l/3]),se(R,R,x)),A[l]=R[0],A[l+1]=R[1],A[l+2]=R[2];let w=Oo/r.unitInMeters;(Math.abs(re[0]-A[l])>=w||Math.abs(re[1]-A[l+1])>=w||Math.abs(re[2]-A[l+2])>=w)&&(m=!0),h.offset+=3,l+=3}}if(m){let l=n.get(y);l&&bo(y,l,g),c.geometryVertexAttributeUpdated(a[p],P.NORMALCOMPRESSED),y.invalidateBoundingInfo(),c.geometryVertexAttributeUpdated(a[p],P.POSITION),a[p+1].invalidateBoundingInfo(),c.geometryVertexAttributeUpdated(a[p+1],P.POSITION)}b+=C/_}return b/u}function bo(e,t,o){let s=e.getMutableAttribute(P.POSITION),r=e.getMutableAttribute(P.NORMALCOMPRESSED).data,{topVertexStart:i,topVertexCount:n,topFaceStart:c,topFaceCount:a}=t,u=s.data,d=n,b=e.attributes.get(P.POSITION).indices,g=c+a,x=i+n,p=I(3*d);for(let m=0;m<d;++m){let C=3*m;p[C+0]=0,p[C+1]=0,p[C+2]=0}let y=To,A=Io,f=Mo,h=Do,_=M;for(let m=c;m<g;++m){let C=3*m;for(let l=0;l<3;++l){let S=b[C+l];h[l]=S;let w=3*S;V(R,u[w+0],u[w+1],u[w+2]),se(y[l],R,o)}He(A,y[1],y[0]),He(f,y[2],y[0]),ze(_,A,f),ee(_,_);for(let l=0;l<3;++l){let S=3*(h[l]-i);p[S+0]+=_[0],p[S+1]+=_[1],p[S+2]+=_[2]}}for(let m=i;m<x;++m){let C=3*(m-i),l=p[C+0],S=p[C+1],w=p[C+2],N=Math.sqrt(l*l+S*S+w*w);Tt(r,m,l/N,S/N,w/N)}}var R=E(),M=E(),Oe=new Qt,Ao=[0,2,1],_o=[0,1,2],Oo=.01,To=[E(),E(),E()],Io=E(),Mo=E(),Do=[0,0,0],D;(function(e){e[e.Main=0]="Main",e[e.Bottom=1]="Bottom"})(D||(D={}));var ot=class{constructor(t,o,s,r){this.positions=t,this.elevation=o,this.normals=s,this.heights=r}},rt=class{constructor(t,o,s,r){this.topVertexStart=t,this.topVertexCount=o,this.topFaceStart=s,this.topFaceCount=r}};var pe=class extends Se{constructor(t,o){super(t,o,new be(ro,()=>import("./chunk-K36DZ7FG.js")))}initializePipeline(){return Ce({colorWrite:xe})}};var W=class extends we{constructor(e){super(X(J({},e),{view:e.focusAreas.view})),this.consumes={required:[q.COMPOSITE,j.FOCUSAREA]},this.produces=q.COMPOSITE,this._passParameters=new oo}precompile(){this.techniques.precompile(pe)}render(e){let t=this.techniques.get(pe),o=e.find(({name:d})=>d===q.COMPOSITE);if(!t.compiled)return this.requestRender(),o;let s=this.bindParameters,r=s.camera,i=r.fullViewport[2],n=r.fullViewport[3],c=e.find(({name:d})=>d===j.FOCUSAREA),a=this.fboCache.acquire(i,n,this.produces),u=this.renderingContext;return u.gl.clear(u.gl.STENCIL_BUFFER_BIT),u.bindFramebuffer(a.fbo),this._passParameters.color=o.getTexture(),this._passParameters.focusArea=c.getTexture(),this._passParameters.effect=Fo[this.focusAreas.style],u.bindTechnique(t,s,this._passParameters),u.screen.draw(),a.attachDepth(o.getAttachment(this.gl.DEPTH_STENCIL_ATTACHMENT)),a}},me;v([T()],W.prototype,"consumes",void 0),v([T()],W.prototype,"produces",void 0),v([T({constructOnly:!0})],W.prototype,"focusAreas",void 0),W=v([$("esri.views.3d.webgl-engine.effects.focusArea.FocusAreaColorNode")],W),function(e){e[e.NONE=0]="NONE",e[e.BRIGHT=1]="BRIGHT",e[e.DARK=2]="DARK"}(me||(me={}));var Fo={none:me.NONE,bright:me.BRIGHT,dark:me.DARK};var he=class extends Se{constructor(t,o){super(t,o,new be(io,()=>import("./chunk-FHKR4YR2.js")))}initializePipeline(){return Ce({colorWrite:xe,depthTest:{func:ie.LEQUAL}})}};var K=class extends we{constructor(e){super(X(J({},e),{view:e.focusAreas.view})),this.consumes={required:[j.FOCUSAREA,q.TRANSPARENT]},this.produces=j.FOCUSAREA,this._vaos=new Array,this._counts=new Array,this._origins=new Array,this._maskParameters=new so}initialize(){this.updateGeometries()}destroy(){this._vaos.forEach(e=>e.dispose()),this._vaos.length=this._counts.length=this._origins.length=0}precompile(){this.techniques.precompile(he)}render(e){let t=this.techniques.get(he),o=this.bindParameters,s=o.camera,r=s.fullViewport[2],i=s.fullViewport[3],n=this.fboCache.acquire(r,i,j.FOCUSAREA,zt.RGBA);if(!t.compiled||!this._vaos)return this.requestRender(),n;let c=e.find(({name:d})=>d===q.TRANSPARENT),a=this.renderingContext;n.attachDepth(c.getAttachment(this.gl.DEPTH_STENCIL_ATTACHMENT)),a.bindFramebuffer(n.fbo),a.clear(qe.COLOR|qe.STENCIL),a.setViewport(0,0,r,i),a.gl.clearStencil(0),a.gl.clear(a.gl.STENCIL_BUFFER_BIT),a.setClearStencil(0);let u=a.bindTechnique(t,o);a.setFaceCullingEnabled(!1),a.setStencilTestEnabled(!0),a.setStencilOpSeparate(We.FRONT,z.KEEP,z.INCR_WRAP,z.KEEP),a.setStencilOpSeparate(We.BACK,z.KEEP,z.DECR_WRAP,z.KEEP),a.setDepthWriteEnabled(!1);for(let d=0;d<this._vaos.length;d++){let b=this._vaos[d],g=this._counts[d];this._maskParameters.origin=this._origins[d],u.bindDraw(o,Bt,this._maskParameters),a.bindVAO(b),a.setStencilWriteMask(255),a.setStencilFunction(ie.ALWAYS,0,255),a.setColorMask(!1,!1,!1,!1),a.drawArrays(je.TRIANGLES,0,g),a.setStencilWriteMask(0),a.setStencilFunction(ie.NOTEQUAL,0,255),a.setColorMask(!0,!0,!0,!0),a.drawArrays(je.TRIANGLES,0,g)}return n}updateGeometries(){if(!this.view._stage)return;this._vaos.forEach(t=>t.dispose()),this._vaos.length=this._counts.length=this._origins.length=0;let e=this.focusAreas.geometries;for(let t of e){let o=new Array,s=t.indicesBottom;for(let c=0;c<s.length;c++)o.push(t.positions[3*(s[c]-1)]),o.push(t.positions[3*(s[c]-1)+1]),o.push(t.positions[3*(s[c]-1)+2]);let r=t.indicesExtruded;for(let c=0;c<r.length;c++)o.push(t.positions[3*r[c]]),o.push(t.positions[3*r[c]+1]),o.push(t.positions[3*r[c]+2]);let i=new Float32Array(o),n=new Vt(this.renderingContext,kt,new Map([["geometry",jt]]),new Map([["geometry",Ut.createVertex(this.renderingContext,Ot.STATIC_DRAW,i)]]));this._vaos.push(n),this._counts.push(s.length+r.length),this._origins.push(t.origin)}this.requestRender()}};v([T()],K.prototype,"consumes",void 0),v([T()],K.prototype,"produces",void 0),v([T({constructOnly:!0})],K.prototype,"focusAreas",void 0),K=v([$("esri.views.3d.webgl-engine.effects.focusArea.FocusAreaMaskNode")],K);var Te=class{constructor(t,o,s,r,i,n){this.positions=t,this.indicesBottom=o,this.indicesExtruded=s,this.height=r,this.origin=i,this.color=n}},xo;(function(e){e[e.NONE=0]="NONE",e[e.BRIGHT=1]="BRIGHT",e[e.DARK=2]="DARK"})(xo||(xo={}));var Z=0,No=5e6,Ie=.42,Q=.32;function ai(e,t){if(e){if(t==="bright"){let o=(e[0]+e[1]+e[2])/3;return[o*Q+(1-Q),o*Q+(1-Q),o*Q+(1-Q),e[3]*Q]}return t==="dark"?[e[0]*Ie,e[1]*Ie,e[2]*Ie,e[3]*Ie]:e}}var Y=class extends mt{constructor(e){super(e),this.style="dark",this.geometries=new Array,this._areas=new Ge,this._elevationContext=new Yt}initialize(){this.addHandles([Be(()=>this.style,()=>this._updateRenderNodes(),ke)]),this.addHandles([Be(()=>this.activePolygons,()=>this._updateFocusAreaGeometries(),ke)])}get activePolygons(){let e=new Ge;for(let t of this.areas)if(t.enabled)for(let o of t.geometries)e.push(o);return e}add(e){this.areas.add(e),this._updateFocusAreaGeometries()}addMany(e){this.areas.addMany(e),this._updateFocusAreaGeometries()}remove(e){this.areas.remove(e),this._updateFocusAreaGeometries()}removeMany(e){this.areas.removeMany(e),this._updateFocusAreaGeometries()}removeAll(){this.areas.removeAll(),this._updateFocusAreaGeometries()}containsGeometry(e){let t=!0,o=new ut(e);return t=this.areas.some(s=>!!s.enabled&&!!s?.geometries.length&&s.geometries.some(r=>r.contains(o))),t}get areas(){return this._areas}_updateFocusAreaGeometries(){this._extrudePolygons(),this._updateRenderNodes()}_extrudePolygons(){if(!this.view.renderCoordsHelper)return;this.geometries.length=0;let e=No-Z,t=E(),o=this.view.renderCoordsHelper.viewingMode===_e.Global,s=H(),r=H();o||this.view.renderCoordsHelper.worldUpAtPosition([0,0,0],t);for(let i of this.areas)if(i.enabled)for(let n of i.geometries){let c=Ee(n);if(c==null)continue;ge(n.spatialReference,[c.x,c.y,0],s,this.view.renderCoordsHelper.spatialReference);let a=ee(Lo,[s[12]-Z*t[0],s[13]-Z*t[1],s[14]-Z*t[2]]);r[12]=-s[12],r[13]=-s[13],r[14]=-s[14];let u=ve(n,this.view.elevationProvider,this.view.renderCoordsHelper,this._elevationContext),{polygons:d,mapPositions:b,position:g}=u;for(let x of d){let p=x.count,y=oe(x.mapPositions,x.holeIndices,3);if(y.length===0)continue;let A=y.length,f=6*p,h=te(f+A),_=te(A),m=I(3*f),C=I(3*f),l=I(3*f),S=I(f);st(g,b,y,x,m,l,C,S,h,_,e,t,o),ye(m,m,r);let w=new Te(m,_,h,e,[s[12]+Z*a[0],s[13]+Z*a[1],s[14]+Z*a[2]],i.outline?.color);this.geometries.push(w)}}this._maskRenderNode?.updateGeometries()}_updateRenderNodes(){this.view._stage&&(this.style==="none"||this.geometries.length===0?(this._maskRenderNode=Le(this._maskRenderNode),this._colorRenderNode=Le(this._colorRenderNode)):(this._maskRenderNode??=new K({focusAreas:this}),this._colorRenderNode??=new W({focusAreas:this})))}};v([T()],Y.prototype,"activePolygons",null),v([T()],Y.prototype,"style",void 0),v([T()],Y.prototype,"geometries",void 0),v([T({constructOnly:!0})],Y.prototype,"view",void 0),v([T()],Y.prototype,"_areas",void 0),Y=v([$("esri.views.FocusAreas")],Y);var Lo=E();export{Ko as a,Zo as b,Qo as c,ao as d,no as e,ve as f,or as g,po as h,ai as i,Y as j};
