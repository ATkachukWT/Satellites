import{a as Zi,c as Ji}from"./chunk-G7LVEIS2.js";import{a as Ni}from"./chunk-JSO7OQZT.js";import{a as qi,b as Xi,c as Qi,d as Ki}from"./chunk-H7DCRSK5.js";import{a as Gi}from"./chunk-2EE5YRTN.js";import{A as ji,a as Hi,b as re,c as tt,x as it}from"./chunk-5L7JZ2F3.js";import{c as ke}from"./chunk-CR3B6HQY.js";import{a as Ei}from"./chunk-NFLL25V7.js";import{a as _t,f as zi}from"./chunk-ZM6C2LBU.js";import"./chunk-5B4YOQU5.js";import{a as Ci,b as Fi}from"./chunk-LG3C3MKX.js";import{c as ge,d as ae,e as Li,i as Ii,j as ki}from"./chunk-FL7OPLFN.js";import{b as Pi,d as Ui,e as _e}from"./chunk-3VYKLHOM.js";import{a as xi}from"./chunk-HOMK53AL.js";import{a as et}from"./chunk-LKA3X57N.js";import"./chunk-NWNJEGEK.js";import"./chunk-KBHP2G24.js";import"./chunk-ALYBHVUD.js";import"./chunk-CZNLG4Q3.js";import"./chunk-CRVFDW2R.js";import"./chunk-INZW3TXV.js";import"./chunk-USV42SA7.js";import{b as Re,d as Di,g as $e,l as Ri}from"./chunk-2IZGBHXN.js";import{l as Oi}from"./chunk-2CQRLDTB.js";import"./chunk-Q5KIWWVU.js";import{a as gt}from"./chunk-KK722UJA.js";import{a as Si}from"./chunk-YWEC6MDH.js";import{b as Mi,d as yi}from"./chunk-JYUV3HWY.js";import{d as Bi,j as Wi}from"./chunk-TYMNCBDR.js";import{a as Yi}from"./chunk-B6M6RVA3.js";import"./chunk-XMOJ4BVW.js";import"./chunk-MOHGYSPI.js";import"./chunk-KT2IZTJQ.js";import"./chunk-7GENY6TF.js";import"./chunk-2L3Q5NER.js";import"./chunk-XCJ4FRLL.js";import"./chunk-JNJTT3PL.js";import"./chunk-53FQLWMN.js";import"./chunk-PGFEC2N6.js";import"./chunk-5KY2RG7F.js";import"./chunk-XQ4DD6H6.js";import"./chunk-IQA3CVAZ.js";import"./chunk-2DH3L3DZ.js";import"./chunk-2VR3WADU.js";import"./chunk-7S2234XQ.js";import{d as Ai}from"./chunk-5QOQFLF6.js";import"./chunk-2I3LIA7G.js";import"./chunk-5DVGZXEZ.js";import"./chunk-AGQUA5I4.js";import"./chunk-VC6GZ45F.js";import"./chunk-BENEV3E6.js";import"./chunk-R3G2IXBO.js";import"./chunk-2M72FQ5L.js";import"./chunk-SBYRP3FT.js";import"./chunk-N3W77OHB.js";import"./chunk-PXDIM3V6.js";import"./chunk-D4EX42XK.js";import"./chunk-HMAWCT6U.js";import"./chunk-7PDWRJ35.js";import"./chunk-ALHY5HFC.js";import{b as Ti}from"./chunk-63BBKXWS.js";import{b as we}from"./chunk-62UTK67Z.js";import"./chunk-UWWX7VSW.js";import"./chunk-CFF33S4D.js";import"./chunk-MF655E4C.js";import{b as bi}from"./chunk-XY4QPRKP.js";import"./chunk-UV6SBQOQ.js";import"./chunk-OWV7FEAY.js";import"./chunk-NOHUHVCW.js";import"./chunk-2XYAAYOE.js";import{a as Vi,d as wt}from"./chunk-4X7VNDTG.js";import"./chunk-34RMJISL.js";import"./chunk-54P55TN4.js";import{e as ai}from"./chunk-BVDJBTNQ.js";import"./chunk-LSUWBOLF.js";import"./chunk-LHI3UGTZ.js";import"./chunk-6SGUOKGX.js";import"./chunk-LCFWGHLF.js";import"./chunk-XACQ2RJ5.js";import{b as ui}from"./chunk-3TRID6QS.js";import{d as wi,l as vt,n as gi,o as _i}from"./chunk-VUJT53YX.js";import"./chunk-WUXNV6ZW.js";import"./chunk-PM3EZWDJ.js";import"./chunk-KE2U7ENE.js";import"./chunk-PSFZFYFC.js";import"./chunk-WIFM6OT5.js";import{b as oi}from"./chunk-GI4NW5SA.js";import"./chunk-T5NHE3SD.js";import{c as vi}from"./chunk-SWCOPTUX.js";import"./chunk-7EWNVUY7.js";import"./chunk-SXYHD4V6.js";import"./chunk-FSW536RM.js";import"./chunk-YNDA4ZZB.js";import"./chunk-JAN3FVXP.js";import"./chunk-F4HA2HQL.js";import"./chunk-BSKAVVQS.js";import"./chunk-AEU2INWT.js";import{a as mi,b as fi}from"./chunk-Z4UBZ6W2.js";import"./chunk-CMKJEBQJ.js";import"./chunk-AQMR24IC.js";import"./chunk-3J3Q4LMA.js";import"./chunk-PSNQ2KG3.js";import"./chunk-X5NPIY3C.js";import"./chunk-JXRFF2VE.js";import{a as mt,b as ft}from"./chunk-7WCQBAQY.js";import{b as Je,c as pi}from"./chunk-V4ZQZTCB.js";import{a as ni,b as di}from"./chunk-PEYNLMWW.js";import"./chunk-FQIIIJGL.js";import"./chunk-SZTSN5BD.js";import"./chunk-VAOSSSLB.js";import"./chunk-6L543SC5.js";import"./chunk-CUV3BSEW.js";import"./chunk-6FI5AY7X.js";import"./chunk-ZCAR53EN.js";import"./chunk-DH67ILIV.js";import"./chunk-7GUYYJRR.js";import"./chunk-WS4AMEGN.js";import"./chunk-CU7FHMWW.js";import"./chunk-CSFAHB4Y.js";import"./chunk-AMISFAT3.js";import"./chunk-PTXLSCMJ.js";import{g as li,l as hi,m as ci}from"./chunk-NRRX2M6N.js";import"./chunk-PMLKCTEJ.js";import"./chunk-MYO2G5ZH.js";import"./chunk-EG2DTURK.js";import"./chunk-YVCKQBWT.js";import"./chunk-4XEE5PE3.js";import"./chunk-MBNZK2RR.js";import"./chunk-DV6KBPBR.js";import"./chunk-XWEUR6F7.js";import"./chunk-KALTBP5D.js";import"./chunk-O2J7LFYY.js";import"./chunk-422PSKZ7.js";import"./chunk-SFANISLX.js";import"./chunk-5L4CW2H2.js";import"./chunk-UJ7KVQR6.js";import{j as J}from"./chunk-B74L7AUE.js";import"./chunk-MJO3PLZV.js";import"./chunk-YU3IFRYW.js";import"./chunk-XKFJ6GWH.js";import"./chunk-GSXOR3JU.js";import"./chunk-55OTJIMU.js";import"./chunk-EM2AEAFS.js";import"./chunk-VGAXEXH3.js";import"./chunk-YEPHAEAY.js";import"./chunk-76X7RFM4.js";import"./chunk-HMNTGQTR.js";import"./chunk-ZLIWNUFM.js";import"./chunk-GVSOJUIP.js";import"./chunk-GWSX6PRO.js";import"./chunk-ELCBU4NP.js";import"./chunk-GMZFCQJQ.js";import"./chunk-5WDH2LXO.js";import"./chunk-L7NOU4T2.js";import{d as Ie}from"./chunk-SU7IJ65K.js";import"./chunk-WOZSH7YY.js";import"./chunk-2PJRHNJW.js";import"./chunk-B2RVSTL3.js";import"./chunk-2CKJLDTO.js";import"./chunk-F6TN7E7K.js";import"./chunk-HUUJBVXR.js";import"./chunk-4LDVFWME.js";import"./chunk-A45BLB26.js";import"./chunk-DFYW3Y3B.js";import"./chunk-UBQPWKE4.js";import"./chunk-YSD7LK2L.js";import"./chunk-LXEWGICX.js";import"./chunk-NIYDRLW4.js";import"./chunk-4K47EN3B.js";import"./chunk-FSWSNKJD.js";import"./chunk-MVDZB4AK.js";import"./chunk-ESSDCWGF.js";import"./chunk-WVKBXQWE.js";import"./chunk-FGEB67EG.js";import"./chunk-YEXMIDOT.js";import"./chunk-GV3ZFCVD.js";import"./chunk-SOEEM7Z7.js";import"./chunk-T7PUQGWM.js";import"./chunk-44A27HB7.js";import"./chunk-47NSYSFY.js";import"./chunk-QXNVQZT7.js";import{e as ri}from"./chunk-CAXK5KYB.js";import{f as si}from"./chunk-3CCK7BDD.js";import"./chunk-LNYBTIG7.js";import"./chunk-VYZHOYXV.js";import"./chunk-K7YQAHQ7.js";import"./chunk-XAHD7XBV.js";import"./chunk-J6YGDWJF.js";import{b as ii}from"./chunk-YQNUGDFH.js";import{b as ti}from"./chunk-QCZ3ZIGQ.js";import{a as Ze,c as ut}from"./chunk-ONYJLWAD.js";import{N as ei,u as Ke,z as Ye}from"./chunk-VMECOA4F.js";import"./chunk-KOUNUVF6.js";import"./chunk-PHODKV66.js";import"./chunk-JPMGMA4B.js";import"./chunk-3REMXE4W.js";import"./chunk-4ABKPPKG.js";import"./chunk-PMVQ5DJK.js";import"./chunk-I4Q2S2XA.js";import"./chunk-V774RJYN.js";import"./chunk-L2WNUKLP.js";import"./chunk-XITT4JU2.js";import"./chunk-ZBX6HJOS.js";import"./chunk-BSMAMABT.js";import"./chunk-LYNAYPL3.js";import"./chunk-ULANM5YP.js";import"./chunk-77L5NP7A.js";import{a as N}from"./chunk-KAMRW6HF.js";import"./chunk-6DGDLLNL.js";import"./chunk-UWWWQ44M.js";import"./chunk-BHB4UQZT.js";import"./chunk-DJW5LMRG.js";import"./chunk-SEJXLJ5V.js";import"./chunk-MPAJA3DL.js";import{a as _}from"./chunk-ALWV3RJ2.js";import"./chunk-DEH76MSI.js";import"./chunk-VTGWQ7AP.js";import"./chunk-PHNFWHVF.js";import"./chunk-NQWYPF77.js";import"./chunk-KRAKR4MK.js";import"./chunk-MCO7DSFO.js";import"./chunk-D7WE3OBT.js";import"./chunk-JTDXB5TK.js";import"./chunk-XCIPBOI4.js";import"./chunk-KD27XIJC.js";import{c as Xt,p as Qt,r as Kt}from"./chunk-TPFJWNIU.js";import"./chunk-P25RU3X5.js";import"./chunk-XRRQM4E2.js";import"./chunk-GWBRHLNH.js";import"./chunk-G7TP3ZYQ.js";import"./chunk-Y6YEAKJ5.js";import"./chunk-S52JRLJC.js";import"./chunk-U4TLMQTY.js";import{a as Le}from"./chunk-PDQQY7RQ.js";import"./chunk-W5OI4BJ2.js";import{a as $t}from"./chunk-RWCIDBNQ.js";import"./chunk-2NH7HOKA.js";import{a as pt}from"./chunk-HM5RIVQC.js";import"./chunk-EM35R6FY.js";import"./chunk-2ZFXOJDB.js";import"./chunk-QXXXCEV5.js";import{C as ye,D as Jt,G as R,J as de,b as j,c as G,d as q,n as I,o as Yt,p as dt,s as De,u as se,v as ce,w as Zt,y as U}from"./chunk-6B5XFA6F.js";import"./chunk-HP4LYRR4.js";import"./chunk-AFC2H4Q3.js";import"./chunk-OLOKUDVI.js";import"./chunk-4G7UTTZJ.js";import{H as L,g as He,h as Gt,i as qt,n as ie,o as ve,p as W,q as Qe,r as Me,s as ze}from"./chunk-ZTOZWLEE.js";import"./chunk-RJWOVI3M.js";import"./chunk-NRBJLISB.js";import{a as Nt,e as ct}from"./chunk-PTZYZULI.js";import"./chunk-NMLYCCKN.js";import"./chunk-RSDQHAJX.js";import{a as u,b as ht,c as k,e as Wt}from"./chunk-BOVYXYHK.js";import"./chunk-FENRIY2T.js";import"./chunk-HX2VGIR2.js";import"./chunk-64QN2VGD.js";import"./chunk-JGEVVXD4.js";import"./chunk-B3FO6PT7.js";import"./chunk-C4UMJHQC.js";import"./chunk-BCREO4Q5.js";import"./chunk-LXFQWIWE.js";import{b as be,h as g,i as fe}from"./chunk-QT6UNBJP.js";import{a as v,b as Te,f as Oe,h as Xe,i as T,j as he}from"./chunk-MWSXMSWY.js";import{f as Ut}from"./chunk-JRCKELO6.js";import"./chunk-KJULKTB5.js";import"./chunk-LACL4BQ2.js";import{c as Bt}from"./chunk-YR2HD3ZC.js";import"./chunk-GJASVPF6.js";import"./chunk-UBFCO3DV.js";import"./chunk-NI7FJV5X.js";import"./chunk-BUSG3ZOF.js";import"./chunk-XZIOXVVJ.js";import"./chunk-EXJYW3PC.js";import"./chunk-SXQPBCOX.js";import"./chunk-LFH24RLM.js";import{n as xe}from"./chunk-Z5Q7KLA4.js";import"./chunk-X4LNX4BR.js";import"./chunk-4XZ6X7MQ.js";import"./chunk-WLHY3MMA.js";import"./chunk-KGVXGH6H.js";import"./chunk-ARRCN5K3.js";import"./chunk-LXQPIAN7.js";import"./chunk-FTDD7QBB.js";import"./chunk-DB3UIQCU.js";import"./chunk-SBHKMV3P.js";import"./chunk-R4A63S45.js";import"./chunk-ETE32IYO.js";import"./chunk-ONUGDWDK.js";import"./chunk-SG7CQU4O.js";import{H as l,J as te,g as me}from"./chunk-QHVIRF5H.js";import{I as z}from"./chunk-WZDN6K3C.js";import{a as n}from"./chunk-QGVBCWUY.js";import"./chunk-OJQ73TPF.js";import"./chunk-354SCPDU.js";import"./chunk-OVHPPCBL.js";import"./chunk-IYZFKXJ6.js";import{J as jt,b as C,c as Ht,e as Se,f as zt,j as Lt,m as Ne,p as It,v as kt}from"./chunk-CKJ56T2Q.js";import"./chunk-SNFOAZZQ.js";import"./chunk-F6JAWRPN.js";import{e as Ft,r as xt}from"./chunk-UHRSAPGQ.js";import{a as Et,w as Pt}from"./chunk-V76GWARL.js";import{a as H,b as B}from"./chunk-N2WTMF3X.js";var $i=2,Ms=4,st=g(2),es=1.5,Vt=class{constructor(){this.collisionRadius=5,this.fovUnfocusedArcWidth=Ms,this.fovFocusedArcWidth=$i*this.fovUnfocusedArcWidth,this.scaleOrientSize=90,this.scaleOrientHandleRadius=.025,this.scaleOrientMinDistance=1,this.scaleOrientArrowTipLength=.3,this.scaleOrientArrowTipFocusMultiplier=$i/1.5,this.observerSize=5,this.hoverTimeoutMilliseconds=1e3,this.viewAngleThreshold=10}getFovArcWidth(e){return e?this.fovFocusedArcWidth:this.fovUnfocusedArcWidth}getScaleOrientArrowTipLength(e){return this.scaleOrientArrowTipLength*(e?this.scaleOrientArrowTipFocusMultiplier:1)}},E=new Vt,bt=class{constructor(){this.frameWidthNotSelected=.3,this.frameWidthSelected=1,this.frameColor=new N([255,255,255,.99]),this.observerPointConfiguration={size:6,pixelSnappingEnabled:!1,primitive:"circle",elevationInfo:{mode:"absolute-height",offset:0},outlineSize:0,color:N.toUnitRGBA(new N([3,252,111,1]))},this.shapeMaterialParameters={color:[.33,.33,.33,.25],renderOccluded:J.Occlude,cullFace:Ze.Back,writeDepth:!1}}},oe=new bt;function Ce({tiltedUpVector:t,rightVector:e,observerRenderSpace:i},s){let r=ki(t,e,i,s);return r[12]=0,r[13]=0,r[14]=0,r}function je(t,e,i,s){let r=u(),a=i.plane,o=ys(e,a),h;if(Math.abs(o)>E.viewAngleThreshold)h=t.next(_t(e,i.plane));else{let d=Ye(s.targetRenderSpace,i.basis1,Ke()),c=se(ss,i.basis1),p=se(Ss,i.basis2);h=t.next(_t(e,d)).next(m=>{let f=O=>{let D=ce(R(ts,O,i.origin),p),F=Math.acos(be(D/s.farDistanceRenderSpace,-1,1)),K=Math.sin(F)*s.farDistanceRenderSpace;return q(u(),i.origin,q(u(),I(ts,c,K),I(Ts,p,D)))},w=f(m.renderStart),V=f(m.renderEnd);return B(H({},m),{renderStart:w,renderEnd:V})})}return h.next(d=>{d.action==="start"&&j(r,d.renderStart);let c=fe(Ii(r,d.renderEnd,i.origin,a));return B(H({},d),{deltaAngle:c})})}function ys(t,e){let i=ss;t.renderCoordsHelper.toRenderCoords(t.camera.position,i);let s=Wi(t,i,t.camera.heading,t.camera.tilt,Bi()).direction;return fe(ye(s,e))-90}function ne(t,e,i,s){return W(is,i,s),U(t,e,is)}var ss=u(),Ss=u(),ts=u(),Ts=u(),is=_();var rt=class extends it{constructor(e){super(),this._handles=new me,this._tool=e.tool,this._view=e.view,this._focusedArcMaterial=this._createArcMaterial(!0),this._unfocusedArcMaterial=this._createArcMaterial(!1),this._createManipulators(),this.forEachManipulator(i=>this._tool.manipulators.add(i))}destroy(){this._handles=C(this._handles),this.forEachManipulator(e=>{this._tool.manipulators.remove(e),e.destroy()}),this._tool=null,this._view=null,this._manipulators=null}createDragPipeline(e,i){let s=Object.values(this._manipulators);return Ne(s.map(({manipulator:r,side:a})=>Re(r,(o,h,d,c,p)=>{let m=As(a,i),f=h.next(V=>B(H({},V),{manipulatorType:re.SCALE,side:a})),w=je(f,this._view,m,i);e(o,w,d)})))}updateManipulatorsTransform(e){e.arcCentersPoints(rs),this._forEachManipulatorInfo(i=>this._updateArcManipulatorTransform(i,e,rs[i.side]))}updateManipulatorVisuals(e){this._forEachManipulatorInfo(i=>this._updateArcManipulatorVisuals(i,e))}_updateArcManipulatorVisuals({manipulator:e,side:i},s){let r=[];if(s!=null){let[a,o]=Os(i,s,this._unfocusedArcMaterial);r.push(new ae(a,we.Unfocused),new ae(a.instantiate({material:this._focusedArcMaterial}),we.Focused)),e.collisionType={type:"line",paths:[o]}}e.renderObjects=r,e.radius=E.collisionRadius}_updateArcManipulatorTransform({manipulator:e,side:i},s,r){let a=s.horizontalFieldOfView,o=g(s.verticalFieldOfView/2),h=g(a/2),d=Ee(i);e.renderLocation=r;let c=_(),p=O=>{He(c,O,c)};p(Me(Ae,g(-90))),d||p(Qe(Ae,o));let m=s.farDistanceRenderSpace,f,w;p(ve(Ae,G(os,m,m,m))),p(ze(Ae,Cs(i))),p(Ce(s,Ae)),d?(f=h,w=s.tiltedUpVector):(w=s.rightVector,f=o),f*=i==="right"||i==="bottom"?-1:1;let V=W(Ae,f,w);V!=null&&p(V),e.modelTransform=c}_createManipulators(){let e=this._createArcManipulator("left"),i=this._createArcManipulator("right"),s=this._createArcManipulator("top"),r=this._createArcManipulator("bottom");this._manipulators={left:e,right:i,top:s,bottom:r},[[r.manipulator,s.manipulator],[e.manipulator,i.manipulator]].forEach(([a,o])=>{a.metadata={pairedManipulator:o},o.metadata={pairedManipulator:a}})}_createArcManipulator(e){let i=new ge({view:this._view,autoScaleRenderObjects:!1,worldSized:!0}),s={manipulator:i,side:e};return this._updateArcManipulatorVisuals(s),this._handles.add(i.events.on("focus-changed",r=>{let a=i.metadata?.pairedManipulator;a!=null&&(a.hovering!==i.hovering&&(a.hovering=i.hovering),a.grabbing!==i.grabbing&&(a.grabbing=i.grabbing))})),s}_createArcMaterial(e){let i=E.getFovArcWidth(e),s=new Ai({renderOccluded:J.OccludeAndTransparent,isDecoration:!0,width:i});return this._handles.add(v(()=>N.toUnitRGBA(this._view.effectiveTheme.accentColor),r=>s.setParameters({color:r}),T)),s}forEachManipulator(e){Object.values(this._manipulators).forEach(({manipulator:i})=>e(i,re.SCALE))}_forEachManipulatorInfo(e){Object.values(this._manipulators).forEach(i=>e(i))}get test(){return{manipulators:this._manipulators}}};function Os(t,e,i){let{horizontalFieldOfView:s,verticalFieldOfView:r}=e,a=Ee(t),o=g(be((a?r:s)/2,0,15)),h=Ds(-o/2,o/2,a?1:Math.max(Math.sin(g(90-r/2)),.1));return[gi(i,h),h]}function Ds(t,e,i,s=10){Le(s>1,"createArcPolylineGeometry() needs at least 2 for numVertices");let r=e-t;if(r<=0||i<=0)return[k(0,0,.01),k(0,0,-.01)];let a=[],o=r/s;for(let h=0;h<s;h++){let d=t+h*o;h===s-1&&(d=e);let c=Math.cos(d)*i,p=Math.sin(d)*i,m=k(c-i,0,p);a.push(m)}return a}function Rs(t){switch(t){case"left":return 0;case"bottom":return 1;case"right":return 2;case"top":return 3}}function Cs(t){return Rs(t)*Es}function Ee(t){return t==="left"||t==="right"}function as(t){return t==="left"?"right":t==="right"?"left":t==="top"?"bottom":"top"}function As(t,{observerRenderSpace:e,targetRenderSpace:i,tiltedUpVector:s,rightVector:r,farDistanceRenderSpace:a}){let o=R(os,i,e),h=Ee(t)?r:s,d=I(Ps,h,a);return Ie(e,o,d)}var Es=Math.PI/2,Ae=_(),os=u(),Ps=u(),rs={top:u(),bottom:u(),left:u(),right:u()};var Pe=class extends ge{constructor(e,i){super({view:e,autoScaleRenderObjects:!1,worldSized:!1,radius:E.collisionRadius}),this._handles=new me,this._setupManipulatorVisual(i)}destroy(){this._handles.remove(),super.destroy()}_setupManipulatorVisual(e){let i=this._createMaterial(),s=1,r=[k(0,0,0),k(0,0,s)],a=vt(i,r,e,16,!1),o=vt(i,r,e*ke,16,!1),h=ns(!1,i,e),d=ns(!0,i,e),c=_();ie(c,r[r.length-1]),L(c,c,Qe(ls,Math.PI/2)),L(c,c,Me(ls,Math.PI/2)),h.transformation=c,d.transformation=c,this.renderObjects=[new ae(a,we.Unfocused),new ae(o,we.Focused),new ae(h,we.Unfocused),new ae(d,we.Focused)];let p=k(0,E.getScaleOrientArrowTipLength(!0),0),m=U(p,p,c),f=[...r,m];this.collisionType={type:"line",paths:[f]}}_createMaterial(){let e=new et({cullFace:Ze.Back,renderOccluded:J.OccludeAndTransparent,isDecoration:!0});return this._handles.add(v(()=>N.toUnitRGBA(this.view.effectiveTheme.accentColor),i=>e.setParameters({color:i}),T)),e}};function ns(t,e,i){let s=E.getScaleOrientArrowTipLength(t),r=2*i;t&&(r*=ke);let a=s/2;return _i(e,s,a,a,r,0)}var ls=_();var ot=class extends it{constructor(e){super(),this._handles=new me,this._tool=e.tool,this._view=e.view;let i=E.scaleOrientHandleRadius;this._manipulatorHeading=new Pe(this._view,i),this._manipulatorTilt=new Pe(this._view,i),this._manipulatorDistance=new Pe(this._view,i),this.forEachManipulator(s=>this._tool.manipulators.add(s))}destroy(){this._handles.destroy(),this.forEachManipulator(e=>{this._tool.manipulators.remove(e),e.destroy()}),this._manipulatorHeading=null,this._manipulatorTilt=null,this._manipulatorDistance=null,this._tool=null,this._view=null}createHeadingDragPipeline(e,i){return Re(this._manipulatorHeading,(s,r,a,o,h)=>{let d=this._view,{tiltParallelToSurface:c,farDistanceRenderSpace:p,upVector:m,observerRenderSpace:f,targetRenderSpace:w,rightVector:V}=i,O=Math.sin(g(c))*p,D=q(at,f,I(Mt,m,O)),F=R(Mt,w,D),K=I(xs,V,de(F)),x=Ie(D,F,K),Y=je(r,d,x,i).next(Z=>B(H({},Z),{manipulatorType:re.ROTATE}));e(s,Y,a)})}createTiltDragPipeline(e,i){return Re(this._manipulatorTilt,(s,r,a,o,h)=>{let{observerRenderSpace:d,farDistanceRenderSpace:c,upVector:p,targetDirection:m}=i,f=ce(m,p),w=Yt(at,m,p,-f);I(w,se(w,w),c);let V=I(Mt,p,c),O=Ie(d,w,V),D=je(r,this._view,O,i).next(F=>B(H({},F),{manipulatorType:re.ROTATE}));e(s,D,a)})}createDistanceDragPipeline(e,i){return Re(this._manipulatorDistance,(s,r,a,o,h)=>{let d=si(i.observerRenderSpace,i.targetDirection),c=r.next(Ri(this._view,s.location)).next(zi(this._view,d)).next(p=>B(H({},p),{manipulatorType:re.SCALE}));e(s,c,a)})}updateManipulators(e){let{targetRenderSpace:i}=e;this._manipulatorHeading.renderLocation=i,this._manipulatorTilt.renderLocation=i,this._manipulatorDistance.renderLocation=i;let s=_(),r=p=>{He(s,p,s)},a=E.scaleOrientSize*(tt/70);r(ve(Ue,G(at,a,a,a))),r(Ce(e,Ue));let o=E.scaleOrientHandleRadius*ke*a,h=I(at,e.targetDirection,o);r(ie(Ue,h));let d=ze(Ue,-yt);L(d,d,Me(hs,-yt)),this._manipulatorHeading.modelTransform=L(_(),s,d);let c=Me(Ue,yt);L(c,c,ze(hs,Math.PI)),this._manipulatorTilt.modelTransform=He(_(),s,c),this._manipulatorDistance.modelTransform=s}forEachManipulator(e){e(this._manipulatorHeading,re.ROTATE),e(this._manipulatorTilt,re.ROTATE),e(this._manipulatorDistance,re.SCALE)}},Ue=_(),hs=_(),at=u(),Mt=u(),xs=u(),yt=Math.PI/2;var Be=class extends ge{constructor(e,i){super({view:e,autoScaleRenderObjects:!1,worldSized:!1,radius:E.observerSize,interactive:!1}),this._handles=new me;let s=Li(this._color);this.renderObjects=[new ae(wi(s,E.observerSize,32,32))],i.manipulators.add(this),this._handles.add([v(()=>this._color,r=>{s.setParameters({color:r})},T)])}destroy(){this._handles.remove(),super.destroy()}get _color(){return N.toUnitRGBA(this.view.effectiveTheme.accentColor)}};n([l()],Be.prototype,"_color",null);var cs=Symbol("dragHandles"),ds=Symbol("hideManipulators"),ps=Symbol("hideFoVManipulators"),us=Symbol("hideObserverManipulator"),X=class extends te{constructor(t){super(t),this._moveManipulation=null,this._observerManipulator=null,this._fieldOfViewManipulation=null,this._scaleOrientManipulation=null,this._forceHoveringTask=null,this._forceHoveringTestPromise=null,this._grabbing=!1,this.viewshedComputedData=null}initialize(){this._moveManipulation=this._createMoveManipulation(),this._fieldOfViewManipulation=new rt({view:this.view,tool:this.parentTool}),this._scaleOrientManipulation=new ot({view:this.view,tool:this.parentTool}),this._observerManipulator=new Be(this.view,this.parentTool),this.addHandles([v(()=>this.viewshedComputedData?.observerRenderSpace,e=>{e!=null&&(this._moveManipulation.renderLocation=e,this._observerManipulator.renderLocation=e)},he),v(()=>this.viewshedComputedData?.heading,e=>{e&&(this._moveManipulation.angle=g(90-e))},T),v(()=>{let{viewshedComputedData:e}=this;return{viewshedComputedData:e,observer:e?.observer}},({viewshedComputedData:e,observer:i},s)=>{this._grabbing&&i!==s?.observer||(this.removeHandles(cs),e?.isValid()&&this.addHandles([this._buildObserverDragPipeline(e),this._buildFOVDragPipeline(e),this._buildScaleOrientDragPipeline(e)].filter(Pt),cs))},T),v(()=>{let e=this.viewshedComputedData;return e?.isValid()?{viewshedCompData:e,target:e.targetRenderSpace,hFOV:e.horizontalFieldOfView,vFOV:e.verticalFieldOfView}:null},e=>{e!=null&&this._fieldOfViewManipulation.updateManipulatorsTransform(e.viewshedCompData)},T),v(()=>{let e=this.viewshedComputedData;return e?.isValid()?{viewshedCompData:e,hFOV:e.horizontalFieldOfView,vFOV:e.verticalFieldOfView,tilt:e.tilt}:null},e=>{e!=null&&this._fieldOfViewManipulation.updateManipulatorVisuals(e.viewshedCompData)},T),v(()=>{let e=this.analysisViewData.visible&&(this.viewshedComputedData?.isValid()??!1),i=this.parentTool.selectedViewshedComputedData===this.viewshedComputedData;return{fovManipulationAvailable:e&&!this.parentTool.isPlacingTarget,nonFOVManipulationAvailable:e&&(!this.parentTool.creating||i)}},({fovManipulationAvailable:e,nonFOVManipulationAvailable:i})=>{this._moveManipulation.available=i,this._scaleOrientManipulation.available=i,this._observerManipulator.available=i,this._fieldOfViewManipulation.available=e},T),v(()=>{let e=this.viewshedComputedData;if(!e?.isValid())return null;let{observer:i,target:s,verticalFieldOfView:r,horizontalFieldOfView:a}=e;return{viewshedCompData:e,observer:i,target:s,verticalFieldOfView:r,horizontalFieldOfView:a}},e=>{e!=null&&this._scaleOrientManipulation.updateManipulators(e.viewshedCompData)},T)]);let t=e=>{let i=this.analysisViewData;this.addHandles([e.events.on("focus-changed",()=>{let s=this._someManipulatorHovering();s&&this.parentTool.subToolHandles.forEach(({subTool:r})=>{r._resetHoveringTask()}),this._someManipulatorSelected()||s||(this._forceHoveringTask=Ut(async r=>{await(this._forceHoveringTestPromise??jt(E.hoverTimeoutMilliseconds,r)),kt(r),this._forceHoveringTask=null,this._updateManipulatorVisibility()}))}),e.events.on("grab-changed",s=>{this._grabbing=s.action==="start",s.action==="end"&&i.tool?.updateInteractionVisualsVisibility(),this.parentTool.subToolHandles.forEach(({subTool:r})=>{r!==this&&r._setInteractive(!this._grabbing)}),this._setInteractive(r=>r.hasManipulator(e)||!this._grabbing)}),e.events.on("drag",s=>{s.action==="start"&&i.tool?.updateInteractionVisualsVisibility()})])};this._forEachManipulator(t)}destroy(){this._forceHoveringTask=Se(this._forceHoveringTask),this._moveManipulation=C(this._moveManipulation),this._fieldOfViewManipulation=C(this._fieldOfViewManipulation),this._scaleOrientManipulation=C(this._scaleOrientManipulation),this.parentTool.manipulators.remove(this._observerManipulator),this._observerManipulator=C(this._observerManipulator)}get viewshed(){return this.viewshedComputedData?.viewshed}get grabbing(){return this._grabbing}get observer(){return this.viewshed?.observer}set observer(t){let e=this.viewshed;e!=null&&(e.observer=t)}get discManipulator(){return this._moveManipulation.xyManipulation.discManipulator}get moveInteractionState(){let{dragging:t,grabbing:e}=this._moveManipulation;return{dragging:t,grabbing:e}}get scaleOrientInteractionState(){let{dragging:t,grabbing:e}=this._scaleOrientManipulation;return{dragging:t,grabbing:e}}_setInteractive(t){let e=typeof t=="boolean";this._forEachManipulation(i=>i.interactive=e?t:t(i))}onManipulatorSelectionChanged(){this._updateManipulatorVisibility(),!this._someManipulatorSelected()&&(this.analysisViewData.selectedViewshed===this.viewshed&&(this.analysisViewData.selectedViewshed=null),this._resetHoveringTask())}hasManipulator(t){let e=!1;return this._forEachManipulator(i=>{e=e||i===t}),e}_someManipulatorSelected(){return this._moveManipulation.selected||this._fieldOfViewManipulation.selected||this._scaleOrientManipulation.selected}_someManipulatorHovering(){return this._moveManipulation.hovering||this._fieldOfViewManipulation.hovering||this._scaleOrientManipulation.hovering}_createMoveManipulation(){return new ji({view:this.view,tool:this.parentTool,snapToScene:!1,xyAvailable:!0,xyAxisAvailable:!0,zAvailable:!0,radius:tt})}_buildObserverDragPipeline(t){let e={mode:"absolute-height",offset:0},i=t.observer;if(i==null)return null;let s=this.view.spatialReference;return this._moveManipulation.createDragPipeline((r,a,o,h,d)=>{h=h.next($e(this,["observer"]));let c=Qt(i,s);if(c==null)return{steps:o,cancel:h};let p=Oi.fromGeometry(c,ti(this.view.viewingMode));return{steps:o.next(Di({operations:p})).next(m=>(this.observer=p.data.geometry,m)),cancel:h}},e,s,void 0)}_buildFOVDragPipeline(t){let e=0,i=0;return this._fieldOfViewManipulation.createDragPipeline((s,r,a)=>{if(t==null)return{steps:r,cancel:a};let o=t.viewshed,h=null;return a=a.next($e(o,["horizontalFieldOfView","verticalFieldOfView"])),{steps:r.next(d=>{d.action==="start"&&(h=null,e=t.horizontalFieldOfView,i=t.verticalFieldOfView);let c=d.deltaAngle;if(h==null&&c!==0){let f=d.side==="bottom"||d.side==="left"?c>0:c<0;h=Ee(d.side)?e===0&&f||e===360&&!f:i===0&&f}let p=h?as(d.side):d.side,m=0;switch(p){case"left":m=e/2-c;break;case"right":m=e/2+c;break;case"top":m=i+2*c;break;case"bottom":m=i-2*c}return Ee(p)?(m=wt.normalize(m),m=m>270?0:m>180?180:m,o.horizontalFieldOfView=2*m):o.verticalFieldOfView=m,d}),cancel:a}},t)}_buildScaleOrientDragPipeline(t){let e=0,i=0,s=(r,a)=>(o,h,d)=>{if(t==null)return{steps:h,cancel:d};let c=t.viewshed;return d=d.next($e(c,[r])),{steps:h=h.next(a(c,t)),cancel:d}};return Ne([this._scaleOrientManipulation.createHeadingDragPipeline(s("heading",(r,a)=>o=>(o.action==="start"&&(i=t.heading),r.heading=wt.normalize(i+o.deltaAngle),o)),t),this._scaleOrientManipulation.createTiltDragPipeline(s("tilt",(r,a)=>o=>{o.action==="start"&&(e=t.tilt);let h=e+o.deltaAngle;return h<-90?h=180:h>270&&(h=0),r.tilt=zs.clamp(h),o}),t),this._scaleOrientManipulation.createDistanceDragPipeline(s("farDistance",(r,a)=>o=>{let h=R(Hs,o.renderEnd,a.observerRenderSpace),d=de(h)*a.metersPerUnit,c=ce(h,a.targetDirection)<0?E.scaleOrientMinDistance:d;return r.farDistance=c,o}),t)])}_updateManipulatorVisibility(){let t=this._someManipulatorSelected(),e=this._forceHoveringTask!=null||this._someManipulatorHovering(),i=this._fieldOfViewManipulation.hovering,s=this.parentTool.creating,r=[],a=o=>{r.push(o.disableDisplay())};t||!s&&e?this.removeHandles(ds):(this._scaleOrientManipulation.forEachManipulator(a),this._moveManipulation.forEachManipulator(a),this.addHandles(r,ds),r=[]),t||!s&&e||s&&i?this.removeHandles(ps):(this._fieldOfViewManipulation.forEachManipulator(a),this.addHandles(r,ps)),t||!s?this.removeHandles(us):this.addHandles(this._observerManipulator.disableDisplay(),us)}_resetHoveringTask(){this._forceHoveringTask=Se(this._forceHoveringTask),this._updateManipulatorVisibility()}_forEachManipulator(t){this._forEachManipulation(e=>{e.forEachManipulator(t)}),t(this._observerManipulator)}_forEachManipulation(t){t(this._moveManipulation),t(this._fieldOfViewManipulation),t(this._scaleOrientManipulation)}get test(){return{moveManipulation:this._moveManipulation,fieldOfViewManipulation:this._fieldOfViewManipulation,scaleOrientManipulation:this._scaleOrientManipulation,viewshedComputedData:this.viewshedComputedData,setHoveringTimeoutPromise:t=>{this._forceHoveringTestPromise=t}}}};n([l({constructOnly:!0})],X.prototype,"analysis",void 0),n([l({constructOnly:!0})],X.prototype,"analysisViewData",void 0),n([l({constructOnly:!0})],X.prototype,"parentTool",void 0),n([l({constructOnly:!0,nonNullable:!0})],X.prototype,"view",void 0),n([l()],X.prototype,"viewshed",null),n([l()],X.prototype,"_grabbing",void 0),n([l()],X.prototype,"grabbing",null),n([l()],X.prototype,"viewshedComputedData",void 0),n([l()],X.prototype,"observer",null),X=n([z("esri.views.3d.analysis.Viewshed.ViewshedSubTool")],X);var Hs=u(),zs=new Vi(0,180);var St=Symbol("interactionVisuals"),A=class extends qi{constructor(t){super(t),this.removeIncompleteOnCancel=!1,this.automaticManipulatorSelection=!1,this._stagedViewshed=null,this._stagedViewshedComputedData=null,this._creationState=!1,this._interactionVisualElements=null,this._settings=new Hi({getTheme:()=>this.view.effectiveTheme}),this._selectedManipulator=null}initialize(){this._intersector=Ni(this.view.state.viewingMode),this._createInteractionVisuals();let t=this.analysisViewData.viewshedComputedDataHandles;this.subToolHandles=Oe(()=>t,({viewshedComputedData:e})=>{let i=new X({analysis:this.analysis,analysisViewData:this.analysisViewData,parentTool:this,view:this.view,viewshedComputedData:e});return{subTool:i,remove:()=>{this.selectedViewshed===e.viewshed&&(this.selectedViewshed=null),i.destroy()}}}),this.addHandles([v(()=>t?.some(e=>e.viewshedComputedData.isValid()),e=>{e&&this.finishToolCreation()},he),v(()=>this._stagedViewshed,e=>{let i=this.analysisViewData.viewshedComputedDataHandles;this._stagedViewshedComputedData=e!=null&&i!=null?this._findSubTool(e)?.viewshedComputedData:null},he),v(()=>this.firstGrabbedManipulator,e=>{if(e!=null){let i=this._findSubTool(e)?.viewshed;this.selectedViewshed=i,this._selectManipulator(e)}else this._selectedSubTool?.onManipulatorSelectionChanged()},Xe),v(()=>this.view.activeTool,e=>{e!==this&&e!=null&&(this.selectedViewshed=null)}),Te(()=>{let e=this.selectedViewshedComputedData;return e==null?null:{subTool:this._selectedSubTool,observer:e.observerRenderSpace,target:e.targetRenderSpace}},e=>{let{subTool:i,observer:s,target:r}=e;i?.moveInteractionState.dragging?this._updateInteractionVisualsLocation(s,!0):i?.scaleOrientInteractionState.dragging&&this._updateInteractionVisualsLocation(r,!1)},T),v(()=>this.creating,()=>this.updateInteractionVisualsVisibility()),v(()=>this.selectedViewshed,e=>{let i=this._selectedManipulator,s=this._selectedSubTool;e==null?this._selectManipulator(null):i!=null&&s.hasManipulator(i)||this._selectManipulator(s.discManipulator)},T)])}destroy(){this.subToolHandles=C(this.subToolHandles),this.removeHandles(St)}onDeactivate(){this.removeStaged(),this._creationState=!1}get cursor(){return this.creating?"crosshair":null}get _selectedSubTool(){return this._findSubTool(this.selectedViewshed)}_selectManipulator(t){let e=this._selectedManipulator;e!==t&&(this._selectedManipulator=t,e!=null&&(e.selected=!1),t!=null&&(t.selected=!0),this._findSubTool(e)?.onManipulatorSelectionChanged(),this._selectedSubTool?.onManipulatorSelectionChanged())}get selectedViewshed(){return this.analysisViewData.selectedViewshed}set selectedViewshed(t){this.analysisViewData.selectedViewshed=t}get selectedViewshedComputedData(){return this._selectedSubTool?.viewshedComputedData}get stagedViewshed(){return this._stagedViewshed}get grabbing(){return this.subToolHandles.some(({subTool:t})=>t.grabbing)}get creating(){return this._creationState&&this.active}get isPlacingTarget(){return this._creationState==="placing-target"}createViewsheds(){this.selectedViewshed=null,this._creationState="placing-observer"}onManipulatorSelectionChanged(){this.subToolHandles.forEach(t=>t.subTool.onManipulatorSelectionChanged())}onInputEvent(t){switch(t.type){case"immediate-double-click":this._doubleClickHandler(t);break;case"pointer-move":this._pointerMoveHandler(t);break;case"key-down":gt.cancel===t.key?this._cancelKeyHandler(t):gt.delete.includes(t.key)&&this._deleteKeyHandler();break;case"hold":this.updateInteractionVisualsVisibility(!0)}}onInputEventAfter(t){t.type==="immediate-click"&&this._clickPlacementHandler(t)}_clickPlacementHandler(t){if(!this.creating||this.hasFocusedManipulators)return;let e=this._intersectScreen(t,fs);if(e!=null){if(this._creationState==="placing-observer"){e.mapPoint.z=(e.mapPoint.z??0)+es;let i=new Si({observer:e.mapPoint.clone(),feature:e.feature});this.analysis.viewsheds.add(i),this._stagedViewshed=i,this._creationState="placing-target",this._updateStagedViewshed(e.scenePoint)}else if(this._creationState==="placing-target"){this._updateStagedViewshed(e.scenePoint);let i=this._stagedViewshed;this._creationState="placing-observer",this._stagedViewshed=null,this.selectedViewshed=i}t.stopPropagation()}}_doubleClickHandler(t){this.creating&&(this.removeStaged(),this._creationState=!1,this.view.activeTool=null,t.stopPropagation())}_pointerMoveHandler(t){if(!this.creating)return;let e=this._intersectScreen(t,fs);e!=null&&(this._updateInteractionVisualsLocation(e.scenePoint,!1),this._updateStagedViewshed(e.scenePoint))}_cancelKeyHandler(t){if(this.creating){if(this.removeStaged())return this._creationState="placing-observer",this.selectedViewshed=null,void t.stopPropagation();this._creationState=!1}else if(!this.grabbing)return this.selectedViewshed=null,void t.stopPropagation()}_deleteKeyHandler(){this.creating&&(this.removeStaged(),this._creationState="placing-observer"),this.selectedViewshed!=null&&this.analysis.viewsheds.remove(this.selectedViewshed)}_updateStagedViewshed(t){let e=this._stagedViewshed,i=this._stagedViewshedComputedData;if(e==null||i==null)return;let{heading:s,tilt:r,farDistance:a}=Ls(this.view,i,t);e.farDistance=a,e.tilt=r,e.heading=s}removeStaged(){return this._stagedViewshed!=null&&(this.analysis.viewsheds.remove(this._stagedViewshed),this._stagedViewshed=null,!0)}_intersectScreen(t,e){let i=Ti(t);this.view.sceneIntersectionHelper.intersectToolIntersectorScreen(i,this._intersector);let s=this._intersector.results.min,r=e.scenePoint;if(!s.getIntersectionPoint(r))return null;let a=e.mapPoint;return a.spatialReference=this.view.spatialReference,this.view.renderCoordsHelper.fromRenderCoords(r,a),a==null?null:(e.feature=bi(s,this.view),e)}_createInteractionVisuals(){this.removeHandles(St);let t=this._settings.visualElements,e=new Ci({view:this.view,attached:!1,style:{glowWidth:t.heightPlane.glowWidth,innerWidth:t.heightPlane.innerWidth},isDecoration:!0}),i=new Ei({view:this.view,extensionType:t.zVerticalLine.extensionType,attached:!1,innerWidth:1,writeDepthEnabled:!1,renderOccluded:J.OccludeAndTransparent,isDecoration:!0});this._interactionVisualElements={laserline:e,verticalLine:i},this.addHandles([v(()=>t.zVerticalLine,s=>s.apply(i),he),v(()=>t.heightPlane,s=>s.apply(e),he),Lt(()=>{e.destroy(),i.destroy(),this._interactionVisualElements=null})],St)}updateInteractionVisualsVisibility(t=!1){let e=this.creating,i=this.analysisViewData.visible,s=this._selectedSubTool,r=this.selectedViewshedComputedData,a=(m,f)=>{let w=this._interactionVisualElements;w!=null&&(w.verticalLine.attached=f,w.laserline.attached=m)};if(e)return void a(i,!1);if(s==null||r==null)return void a(!1,!1);let o=s.moveInteractionState,h=t?o.grabbing:o.dragging,d=s.scaleOrientInteractionState,c=t?d.grabbing:d.dragging,p=i&&(h||c);if(a(p,h),p){let m=h?r.observerRenderSpace:r.targetRenderSpace;this._updateInteractionVisualsLocation(m,h)}}_updateInteractionVisualsLocation(t,e){let i=this._interactionVisualElements;if(i==null)return;let{laserline:s,verticalLine:r}=i;s.heightManifoldTarget=t,s.intersectsWorldUpAtLocation=e?t:null,t!=null&&r.setStartEndFromWorldDownAtLocation(t)}_findSubTool(t){if(t==null)return null;let e=t instanceof ge?i=>i.subTool.hasManipulator(t):i=>i.subTool.viewshed===t;return this.subToolHandles?.find(e)?.subTool}get test(){}};function Ls(t,e,i){let s=e.observerRenderSpace,r=R(Is,i,s),a=de(r)*e.metersPerUnit,o=t.renderCoordsHelper.basisMatrixAtPosition(s,Us),h=G(ks,o[8],o[9],o[10]),d=Ye(s,h,Bs),c=ei(d,i,js),p=R(c,c,s),m=(de(p)<1e-4?90:fe(ye(r,p)))*(ce(h,r)<0?-1:1)+90,f=G(ms,o[4],o[5],o[6]),w=fe(ye(f,p)),V=G(ms,o[0],o[1],o[2]);return{heading:ce(p,V)<0?360-w:w,tilt:m,farDistance:a}}n([l({constructOnly:!0})],A.prototype,"view",void 0),n([l()],A.prototype,"analysisViewData",void 0),n([l()],A.prototype,"removeIncompleteOnCancel",void 0),n([l()],A.prototype,"automaticManipulatorSelection",void 0),n([l({constructOnly:!0})],A.prototype,"analysis",void 0),n([l()],A.prototype,"subToolHandles",void 0),n([l()],A.prototype,"_stagedViewshed",void 0),n([l()],A.prototype,"_stagedViewshedComputedData",void 0),n([l()],A.prototype,"_creationState",void 0),n([l({readOnly:!0})],A.prototype,"cursor",null),n([l()],A.prototype,"_selectedManipulator",void 0),n([l()],A.prototype,"_selectedSubTool",null),n([l()],A.prototype,"selectedViewshed",null),n([l()],A.prototype,"selectedViewshedComputedData",null),n([l()],A.prototype,"stagedViewshed",null),n([l()],A.prototype,"grabbing",null),n([l()],A.prototype,"creating",null),n([l()],A.prototype,"isPlacingTarget",null),A=n([z("esri.views.3d.analysis.Viewshed.ViewshedTool")],A);var Is=u(),ks=u(),js=u(),ms=u(),Us=_(),Bs=Ke(),fs={mapPoint:new xe,scenePoint:u(),feature:null},We=A;var nt=class extends Pi{constructor(e){super(e),this._material=null,this._viewshedComputedData=null,this._material=new et(B(H({},oe.shapeMaterialParameters),{isDecoration:this.isDecoration,writeDepth:!1})),this.applyProperties(e)}get viewshedComputedData(){return this._viewshedComputedData}set viewshedComputedData(e){this._viewshedComputedData=e,this.updateTransform()}updateTransform(){let e=this._viewshedComputedData;if(e==null)return;let i=_(),s=e.farDistanceRenderSpace;ve(i,k(s,s,s)),Ce(e,Ge),L(i,Ge,i),ie(Ge,this._viewshedComputedData.observerRenderSpace),L(i,Ge,i),this.transform=i}createExternalResources(){}destroyExternalResources(){}forEachExternalMaterial(e){this._material!=null&&e(this._material)}createGeometries(e){let{_material:i,viewshedComputedData:s}=this;s==null||i==null||!s.isValid()||Ws(i,s).forEach(r=>e.addGeometry(r))}};function Ws(t,e){let{horizontalFieldOfView:i,verticalFieldOfView:s}=e,r=G(Gs,0,0,1),a=G(ws,0,1,0),o=G(gs,1,0,0);ne(r,r,g(s/2),a),ne(r,r,g(i/2),o);let h=S=>Math.ceil(Math.abs(S)/st)+1,d=g(i),c=j(qs,o),p=h(d),m=vs(-d/(p-1)),f=W(Ge,m,c),w=g(-s),V=h(w),O=vs(w/(V-1)),D=j(ws,a),F=W(_s,g(i)/2,o);U(D,D,F);let K=_s,x=[],Y=j(gs,r);for(let S=0;S<p;S++){W(K,O,D);for(let M=0;M<V;M++){let y=3*(M*p+S);x[y]=Y[0],x[y+1]=Y[1],x[y+2]=Y[2],U(Y,Y,K)}U(D,D,f),U(r,r,f),j(Y,r)}let Z=p*V;x[3*Z]=0,x[3*Z+1]=0,x[3*Z+2]=0;let ee=[];for(let S=0;S<p-1;S++)for(let M=0;M<V-1;M++){let y=6*(M*(p-1)+S);ee[y]=M*p+S,ee[y+1]=(M+1)*p+S,ee[y+2]=M*p+S+1,ee[y+3]=M*p+S+1,ee[y+4]=(M+1)*p+S,ee[y+5]=(M+1)*p+S+1}let ue=[ee];if(i!==360&&s!==0){let S=[],M=[];for(let y=0;y<V-1;y++){let P=3*y;S[P]=Z,S[P+1]=(y+1)*p,S[P+2]=y*p,M[P]=Z,M[P+1]=y*p+p-1,M[P+2]=(y+1)*p+p-1}ue.push(S,M)}if(s!==180&&i!==0){let S=[],M=[];for(let y=0;y<p-1;y++){let P=3*y;S[P]=Z,S[P+1]=y,S[P+2]=y+1,M[P]=Z,M[P+1]=y+(V-1)*p+1,M[P+2]=y+(V-1)*p}ue.push(S,M)}return ue.map(S=>{let M=[[$t.POSITION,new ii(x,S,3,!0)]];return new vi(t,M)})}function vs(t){return isNaN(t)?1:t}var Gs=u(),ws=u(),gs=u(),qs=u(),Ge=_(),_s=_();var le=class extends te{constructor(t){super(t),this.visible=!0,this._viewshedCorners={topLeft:u(),topRight:u(),bottomLeft:u(),bottomRight:u()},this._arcCenterPoints={top:u(),bottom:u(),left:u(),right:u()},this._parallelCenters={top:u(),bottom:u()}}initialize(){let t={view:this.view,isDecoration:!0},e=B(H({},t),{color:this._color,renderOccluded:J.OccludeAndTransparent}),i=B(H({},e),{stipplePattern:xi(2)});this._observerVisualElement=new Fi(H(H({},t),oe.observerPointConfiguration)),this._shapeVisualElement=new nt(t),this._frameLinesVisualElement=new _e(e),this._leftArcVisualElement=new _e(e),this._rightArcVisualElement=new _e(e),this._topArcVisualElement=new _e(e),this._bottomArcVisualElement=new _e(e),this._centralLongitude=new _e(i),this._centralLatitude=new _e(i),this.addHandles([v(()=>{let s=this.viewshedComputedData;if(!s?.isValid())return null;let r=this._viewshedCorners,a=this._arcCenterPoints,o=this._parallelCenters;return s.cornerPoints(r),s.arcCentersPoints(a),s.parallelCenterPoints(o),{viewshedComputedData:s,corners:r,arcCenters:a,parallelCenters:o,interactive:this.analysisViewData.interactive,selected:this._selected}},s=>{let r=s!=null;this._forEachVisualElement(a=>a.attached=r),r&&this._updateVisualElements(s)},{initial:!0,equals:Ft}),v(()=>{let{viewshedComputedData:s}=this,{horizontalFieldOfView:r,verticalFieldOfView:a}=s??{};return{viewshedComputedData:s,horizontalFieldOfView:r,verticalFieldOfView:a}},({viewshedComputedData:s})=>{let{_shapeVisualElement:r}=this;s!==r.viewshedComputedData&&(r.viewshedComputedData=s),this._shapeVisualElement.recreateGeometry()},T),v(()=>{let{interactive:s}=this.analysisViewData;return{visible:this.visible,selected:s&&this._selected,staged:s&&this._staged,horFovNot360:this.viewshedComputedData?.horizontalFieldOfView!==360}},({visible:s,selected:r,staged:a,horFovNot360:o})=>{let h=r||a;this._shapeVisualElement.visible=s,this._topArcVisualElement.visible=s,this._bottomArcVisualElement.visible=s,this._frameLinesVisualElement.visible=s&&o;let d=s&&(r||o);this._leftArcVisualElement.visible=d,this._rightArcVisualElement.visible=d,this._forEachLineVisualElement(c=>{c.width=h?oe.frameWidthSelected:oe.frameWidthNotSelected,c.renderOccluded=r?J.OccludeAndTransparent:J.Occlude}),[this._centralLatitude,this._centralLongitude].forEach(c=>{c.width=2*(h?oe.frameWidthSelected:oe.frameWidthNotSelected),c.visible=s&&r})},T),v(()=>{let{analysisViewData:{interactive:s,tool:r},_selected:a,visible:o}=this,h=this.view.activeTool,d=!r?.active&&h instanceof We&&h.creating;return{observerVisible:o&&!a&&(!s||(r?.creating??!1)||d),color:this._color}},({observerVisible:s,color:r})=>{this._observerVisualElement.visible=s,this._forEachLineVisualElement(a=>a.color=r)},T)])}get _color(){let{viewshedComputedData:t,_selected:e,analysisViewData:i}=this;if(t==null)return N.toUnitRGBA(oe.frameColor);let s=i.tool?.active||i.interactive,r=t.viewshed===i.tool?.stagedViewshed,a=s&&(e||r)?this.view.effectiveTheme.accentColor:oe.frameColor;return N.toUnitRGBA(a)}get _selected(){let{viewshedComputedData:t,analysisViewData:{selectedViewshedComputedData:e}}=this;return t!=null&&t===e}get _staged(){let{analysisViewData:{tool:t},viewshedComputedData:e}=this;return t!=null&&t.creating&&t.stagedViewshed===e?.viewshed}destroy(){this._observerVisualElement=C(this._observerVisualElement),this._shapeVisualElement=C(this._shapeVisualElement),this._frameLinesVisualElement=C(this._frameLinesVisualElement),this._leftArcVisualElement=C(this._leftArcVisualElement),this._rightArcVisualElement=C(this._rightArcVisualElement),this._topArcVisualElement=C(this._topArcVisualElement),this._bottomArcVisualElement=C(this._bottomArcVisualElement),this._centralLongitude=C(this._centralLongitude),this._centralLatitude=C(this._centralLatitude)}_forEachLineVisualElement(t){[this._frameLinesVisualElement,this._leftArcVisualElement,this._rightArcVisualElement,this._topArcVisualElement,this._bottomArcVisualElement,this._centralLatitude,this._centralLongitude].forEach(t)}_forEachVisualElement(t){this._forEachLineVisualElement(t),t(this._observerVisualElement),t(this._shapeVisualElement)}_updateVisualElements(t){let{viewshedComputedData:e,corners:i,arcCenters:s,parallelCenters:r}=t,a=ht(e.observerRenderSpace);this._observerVisualElement.geometry=e.observer,this._shapeVisualElement.updateTransform(),this._updateFrameLines(a,i),this._updateFrameArcs(e,i,r),this._updateCentralHelperArcs(e,s)}_updateFrameLines(t,e){this._frameLinesVisualElement.geometry=[[t,e.topLeft],[t,e.topRight],[t,e.bottomLeft],[t,e.bottomRight]]}_updateFrameArcs(t,e,i){let{observerRenderSpace:s,rightVector:r,horizontalFieldOfView:a,tiltedUpVector:o}=t,h=g(a),d=u(),c=_();W(c,h/2,o),U(d,r,c),Fe(this._leftArcVisualElement,s,e.bottomLeft,e.topLeft,"forward",d),W(c,-h/2,o),G(d,0,0,0),U(d,r,c),Fe(this._rightArcVisualElement,s,e.bottomRight,e.topRight,"forward",d);let p=a>180?"backward":"forward";Fe(this._topArcVisualElement,i.top,e.topRight,e.topLeft,p,o),Fe(this._bottomArcVisualElement,i.bottom,e.bottomRight,e.bottomLeft,p,o)}_updateCentralHelperArcs(t,e){let i=t.observerRenderSpace,s=t.horizontalFieldOfView>=180?"backward":"forward";Fe(this._centralLatitude,i,e.right,e.left,s,t.tiltedUpVector),Fe(this._centralLongitude,i,e.top,e.bottom,"forward",t.leftVector)}get test(){}};function Fe(t,e,i,s,r,a,o=st){let h=u();R(h,i,e);let d=de(h),c=u();R(c,s,e),se(c,c),I(c,c,d);let p=ye(h,c),m=ht(a);r==="backward"&&(De(m,m),p=-(2*Math.PI-p));let f=[],w=Math.ceil(Math.abs(p)/o),V=_();W(V,p/w,m);let O=u();j(O,h);let D=u();j(D,i);for(let F=0;F<w;F++){let K=u();j(K,D),U(O,O,V),q(D,e,O);let x=u();j(x,D),f.push([K,x])}t.geometry=f}n([l()],le.prototype,"view",void 0),n([l()],le.prototype,"analysisViewData",void 0),n([l()],le.prototype,"viewshedComputedData",void 0),n([l()],le.prototype,"visible",void 0),n([l()],le.prototype,"_color",null),n([l()],le.prototype,"_selected",null),n([l()],le.prototype,"_staged",null),le=n([z("esri.views.3d.analysis.Viewshed.ViewshedVisualization")],le);var Vs=le;var Ve=class extends te{get visible(){return this.analysisViewData.visible}constructor(t){super(t)}initialize(){let t=this.analysisViewData,e=Oe(()=>this.analysisViewData.viewshedComputedDataHandles,({viewshedComputedData:i})=>{let s=new Vs({view:this.view,viewshedComputedData:i,analysisViewData:t});return{visualization:s,remove:()=>s.destroy()}});this._viewshedVisualizations=e,this.addHandles([It(e),v(()=>this.visible,i=>this._viewshedVisualizations.forEach(({visualization:s})=>s.visible=i),T)])}get test(){}};n([l({constructOnly:!0})],Ve.prototype,"analysisViewData",void 0),n([l({constructOnly:!0,nonNullable:!0})],Ve.prototype,"view",void 0),n([l({constructOnly:!0})],Ve.prototype,"isDecoration",void 0),n([l()],Ve.prototype,"visible",null),Ve=n([z("esri.views.3d.analysis.Viewshed.ViewshedAnalysisVisualization")],Ve);var Ot,b=Ot=class extends te{constructor(t){super(t),this.observerRenderSpaceOverride=null}get observer(){return this.viewshed.observer??new xe}get effectiveObserverRenderSpace(){return this.observerRenderSpaceOverride??this.observerRenderSpace}get effectiveObserver(){return this.renderSpaceToPoint(this.effectiveObserverRenderSpace,this.observer.spatialReference)}get effectiveTargetRenderSpace(){return this._computeTargetRenderSpace(this.effectiveObserverRenderSpace)}get farDistance(){return this.viewshed.farDistance}get farDistanceRenderSpace(){return this.farDistance/this.metersPerUnit}get heading(){return this.viewshed.heading}get tilt(){return this.viewshed.tilt}get feature(){return this.viewshed.feature}get tiltParallelToSurface(){return this.tilt-90}get horizontalFieldOfView(){return this.viewshed.horizontalFieldOfView}get verticalFieldOfView(){return this.viewshed.verticalFieldOfView}get observerRenderSpace(){return this._pointToRenderSpace(this.observer,u())}get target(){let t=this.targetRenderSpace;return this.renderSpaceToPoint(t,this.observer.spatialReference)}get targetRenderSpace(){return this._computeTargetRenderSpace(this.observerRenderSpace)}get targetDirection(){let t=R(u(),this.targetRenderSpace,this.observerRenderSpace);return se(t,t)}get tiltedUpVector(){let t=ne(u(),this.upVector,-g(this.tiltParallelToSurface),this.leftVector);return se(t,t)}get _basis(){return this.renderCoordsHelper.basisMatrixAtPosition(this.observerRenderSpace,_())}get upVector(){let t=this._basis;return k(t[8],t[9],t[10])}get northVector(){let t=this._basis;return k(t[4],t[5],t[6])}get leftVector(){let t=this.upVector,e=ne(u(),this.northVector,-g(this.heading),t);return Zt(e,t,e)}get rightVector(){return De(u(),this.leftVector)}clone(){return new Ot({renderCoordsHelper:this.renderCoordsHelper,viewshed:this.viewshed.clone()})}isValid(){return this.viewshed.isValid()}get metersPerUnit(){return this.renderCoordsHelper.spatialReference.metersPerUnit}pointOnSphere(t,e,i){let{observerRenderSpace:s,targetRenderSpace:r}=this,a=R(Tt,r,s);return ne(a,a,-g(e),this.leftVector),ne(a,a,-g(t),this.tiltedUpVector),q(i,a,s)}cornerPoints(t){let e=this.horizontalFieldOfView/2,i=this.verticalFieldOfView/2;this.pointOnSphere(-e,i,t.topLeft),this.pointOnSphere(e,i,t.topRight),this.pointOnSphere(-e,-i,t.bottomLeft),this.pointOnSphere(e,-i,t.bottomRight)}arcCentersPoints(t){let e=this.horizontalFieldOfView/2,i=this.verticalFieldOfView/2;this.pointOnSphere(0,i,t.top),this.pointOnSphere(0,-i,t.bottom),this.pointOnSphere(-e,0,t.left),this.pointOnSphere(e,0,t.right)}parallelCenterPoints(t){let e=this.observerRenderSpace,i=this.farDistanceRenderSpace*Math.sin(g(this.verticalFieldOfView/2)),s=I(Tt,this.tiltedUpVector,i);q(t.top,e,s),R(t.bottom,e,s)}renderSpaceToPoint(t,e){let i=Tt;return this.renderCoordsHelper.fromRenderCoords(t,i,e),new xe(i[0],i[1],i[2],e)}_pointToRenderSpace(t,e){let i=Wt(t.toArray());return this.renderCoordsHelper.toRenderCoords(i,t.spatialReference,e),e}_computeTargetRenderSpace(t){let{leftVector:e,northVector:i,upVector:s}=this,r=this.farDistanceRenderSpace,a=u();return I(a,i,r),ne(a,a,-g(this.heading),s),ne(a,a,-g(this.tiltParallelToSurface),e),q(a,t,a),a}};n([l()],b.prototype,"renderCoordsHelper",void 0),n([l()],b.prototype,"viewshed",void 0),n([l()],b.prototype,"observerRenderSpaceOverride",void 0),n([l()],b.prototype,"observer",null),n([l()],b.prototype,"effectiveObserverRenderSpace",null),n([l()],b.prototype,"effectiveObserver",null),n([l()],b.prototype,"effectiveTargetRenderSpace",null),n([l()],b.prototype,"farDistance",null),n([l()],b.prototype,"farDistanceRenderSpace",null),n([l()],b.prototype,"heading",null),n([l()],b.prototype,"tilt",null),n([l()],b.prototype,"feature",null),n([l()],b.prototype,"tiltParallelToSurface",null),n([l()],b.prototype,"horizontalFieldOfView",null),n([l()],b.prototype,"verticalFieldOfView",null),n([l()],b.prototype,"observerRenderSpace",null),n([l()],b.prototype,"target",null),n([l()],b.prototype,"targetRenderSpace",null),n([l()],b.prototype,"targetDirection",null),n([l()],b.prototype,"tiltedUpVector",null),n([l()],b.prototype,"_basis",null),n([l()],b.prototype,"upVector",null),n([l()],b.prototype,"northVector",null),n([l()],b.prototype,"leftVector",null),n([l()],b.prototype,"rightVector",null),n([l()],b.prototype,"isValid",null),n([l()],b.prototype,"metersPerUnit",null),b=Ot=n([z("esri.views.3d.analysis.Viewshed.ViewshedComputedData")],b);var Tt=u();var pe=class extends ai{constructor(){super(...arguments),this.sectionAngles=Nt()}get sectionAnglesDeg(){return ct(this.sectionAngles.map(t=>fe(t)))}set sectionAnglesDeg(t){this.sectionAngles=ct(t.map(e=>g(e)))}get projectionMatrix(){return L(_(),this.sectionMatrix,this._projectionMatrixInternal)}get sectionMatrix(){let t=this.sectionAngles[0],e=this.sectionAngles[1],i=this.sectionAngles[2],s=this.sectionAngles[3];Le(t<=e),Le(i<=s);let r=2*Math.tan(this.fovX/2),a=2*Math.tan(this.fovY/2),o=Math.tan(t),h=Math.tan(e),d=Math.tan(i),c=h-o,p=Math.tan(s)-d,m=r/c,f=a/p,w=-(o+c/2)/r*2,V=-(d+p/2)/a*2,O=_();ie(O,[w,V,0]);let D=_();ve(D,[m,f,1]);let F=_();return L(F,D,O)}get _sectionRatioX(){let t=Math.tan(this.sectionAngles[0]),e=Math.tan(this.sectionAngles[1]),i=2*Math.tan(this.fovX/2);return Math.min(1,(e-t)/i)}setViewport(t,e){let i=e*this._sectionRatioX;return this.viewport=[t[0],t[1],i,e],i}};n([l()],pe.prototype,"sectionAngles",void 0),n([l()],pe.prototype,"sectionAnglesDeg",null),n([l()],pe.prototype,"projectionMatrix",null),n([l()],pe.prototype,"sectionMatrix",null),n([l()],pe.prototype,"_sectionRatioX",null),pe=n([z("esri.views.3d.webgl-engine.lib.ViewshedFaceCamera")],pe);var Rt=class{constructor(){this.textureSizeQuality=1,this.textureSizeModHighQuality=1.3,this.textureSizeModLowQuality=.9,this.textureSizeMultiple=128,this.toleranceSides=5,this.toleranceBottomTop=10}textureSizeModifier(e){let i=e?this.textureSizeModHighQuality:this.textureSizeModLowQuality;return this.textureSizeQuality*i}textureResizeModulo(e){return Math.ceil(e/this.textureSizeMultiple)*this.textureSizeMultiple}},Dt=["front","left","right","back","top","bottom"];function Ns(t){return!["top","bottom"].includes(t)}var lt=class{constructor(e){this._fbos=e,this._minTextureSize=16,this._faces={},this._width=0,this._height=0,this.settings=new Rt,this._maxTextureSize=Math.min(Et("esri-mobile")?4096:16384,e.rctx.parameters.maxTextureSize)}get depthTexture(){return this._handle?.getTexture()}get ready(){return this.depthTexture!=null&&this._width!==0&&this._height!==0}get nearFar(){let e=this.faces;return e.length===0?null:e[0].nearFar}get numActiveFaces(){let e=this._faces,i=0;return Object.keys(e).forEach(s=>{e[s]&&(i+=1)}),i}get faces(){let e=this._faces,i=[];for(let s of Dt){let r=e[s];r&&i.push(r)}return i}get atlasRegions(){return this.faces.map(e=>[e.x/this._width,(e.x+e.width)/this._width,e.y/this._height,(e.y+e.height)/this._height])}get viewshedProjectionMatrices(){return this.faces.map(e=>e.projectionMatrix)}get viewshedViewMatrices(){return this.faces.map(e=>e.viewMatrix)}_setupFaceCamera(e,i,s,r){let{effectiveObserverRenderSpace:a,tiltedUpVector:o,targetRenderSpace:h,farDistanceRenderSpace:d,horizontalFieldOfView:c,verticalFieldOfView:p}=i,m=u();R(m,h,a);let f=u(),w=u(),V=(M,y)=>{let P=u(),At=_();return W(At,M,y),U(P,m,At),q(P,a,P),P},O,D=o,F=Math.min(90,c),K=Math.min(90,Math.max(0,(c-90)/2)),x=-45,Y=45,Z=-45,ee=45;if(Ns(e)){let M=y=>be(y,-45,45);Z=M(-p/2)-this.settings.toleranceBottomTop,ee=M(+p/2)+this.settings.toleranceBottomTop}switch(e){case"front":O=h,x=-F/2,Y=F/2;break;case"left":O=V(Math.PI/2,o),x=45-K;break;case"right":O=V(-Math.PI/2,o),Y=-45+K;break;case"top":O=q(f,a,o),D=De(w,m);break;case"bottom":O=R(f,a,o),D=m;break;case"back":O=V(Math.PI,o)}let ue=new pe({center:O,eye:a,up:D,far:d});ue.sectionAnglesDeg=[x-this.settings.toleranceSides,Y+this.settings.toleranceSides,Z,ee],ue.fovY=Math.PI/2;let S=ue.setViewport(s,r);return this._faces[e]=ue,S}isActive(e){return this._computeActiveFaces(e).size>0}_computeActiveFaces(e){let i=new Set,{horizontalFieldOfView:s,verticalFieldOfView:r}=e,a=-r/2,o=r/2;return s===0||r===0||(a<=45&&o>=-45&&i.add("front"),s>90&&(i.add("left"),i.add("right")),s>270&&i.add("back"),o>45-this.settings.toleranceBottomTop&&i.add("top"),a<-45+this.settings.toleranceBottomTop&&i.add("bottom")),i}_computeBaseTextureSize(e,i,s,r){let a=i/e.pixelRatio,o=this.settings.textureSizeModifier(s),h=Math.max(e.fullWidth,e.fullHeight),d=mi(Math.floor(h*a*o)),c=Math.floor(this._maxTextureSize/r),p=be(d,this._minTextureSize,c);return fi(p)}_ensureFBO(e){let i=this._width,s=this._height;this._handle?.fbo?.width===i&&this._handle?.fbo?.height===s||(this._handle?.release(),this._handle=this._fbos.acquire(i,s,"viewshed shadow map",mt.RGBA4));let r=e?ft.DEPTH_STENCIL_TEXTURE:ft.DEPTH16_BUFFER;this._handle.acquireDepth(r)}clearFBO(e){let i=this._fbos.rctx;this._ensureFBO(e),i.bindFramebuffer(this._handle?.fbo),i.setClearColor(1,1,1,1),i.clear(pt.COLOR|pt.DEPTH)}dispose(){this._handle=zt(this._handle)}start(e,i,s,r,a=!1){this._faces={};let o=this._computeActiveFaces(i),h=o.size;if(h===0)return!1;let d=this._computeBaseTextureSize(e,r,s,h),c=0,p=0,m=0;return Dt.filter(f=>o.has(f)).forEach(f=>{let w=Xs(f,h);w>p&&(m=Math.max(m,c),c=0),p=w;let V=w*d;c+=this._setupFaceCamera(f,i,[c,V],d)}),m=Math.max(m,c),this._width=this.settings.textureResizeModulo(m),this._height=Qs(h)*d,this.clearFBO(a),!0}finish(){this._handle?.detachDepth()}get test(){return{faces:this._faces,faceTypes:Dt,width:this._width,height:this._height,getFBO:()=>this._fbos.acquire(this._width,this._height,"viewshed shadow map",mt.RGBA4)}}};function Xs(t,e){if(e<4)return 0;let i=t==="front"||t==="left";return e===4?i?0:1:i||t==="right"?0:1}function Qs(t){return t<4?1:2}var qe=class extends di{constructor(e,i){super(e,i,new ni(Ji,()=>import("./chunk-CC7KEHVE.js")))}initializePipeline(){return ci({colorWrite:hi,blending:li})}};var $=class extends pi{get shadowMap(){return this._shadowMap}get hasViewsheds(){return this._viewsheds.length>0}get _contentPixelRatio(){return this.view.state.contentPixelRatio}get _viewshedsInView(){return this._viewsheds.items.filter(t=>Zs(this.view,t))}constructor(t){super(t),this._passParameters=new Zi,this._viewsheds=new Bt,this._shadowMap=null,this.consumes={required:[Je.VIEWSHED,"normals"]},this.produces=Je.VIEWSHED,this.requireGeometryDepth=!0}initialize(){this._shadowMap=new lt(this.fboCache),this.addHandles([v(()=>this.view.resolutionScale,t=>{let e=this._shadowMap;e&&(e.settings.textureSizeQuality=t)},T),Te(()=>!this.hasViewsheds,()=>this._shadowMap?.dispose()),v(()=>this._viewshedsInView.map(t=>[t.observerRenderSpace,t.heading,t.tilt,t.farDistance,t.horizontalFieldOfView,t.verticalFieldOfView]),()=>this.requestRender(ut.UPDATE),Xe)])}destroy(){this._shadowMap=Ht(this._shadowMap)}precompile(){if(this.hasViewsheds){this.techniques.precompile(qe);for(let t of this._viewshedsInView)if(this._shadowMap?.isActive(t))return void this.view._stage.renderer.precompileViewshedShadowMap()}}render(t){let e=this.bindParameters,i=this.renderingContext,s=t.find(({name:o})=>o===Je.VIEWSHED);if(!this.hasViewsheds||!e.depth)return s;this._passParameters.shadowMap=this._shadowMap??this._passParameters.shadowMap,this._passParameters.normals=t.find(({name:o})=>o==="normals")?.getTexture();let r=this.techniques.get(qe);if(!r?.compiled)return this.requestRender(ut.UPDATE),s;let a=this.view._stage.renderer.isFeatureEnabled(Yi.HighResolutionViewshed);for(let o of this._viewshedsInView){if(!this._renderShadowCubeMap(e,o,a)||!this._shadowMap?.ready)continue;let h=this._setupViewshedParameters(o,e.camera);i.bindTechnique(r,e,h),i.bindFramebuffer(s.fbo),i.screen.draw()}return this.shadowMap?.dispose(),s}updateViewsheds(t){let e=this._viewsheds,{removes:i,adds:s}=t;if(i&&(Array.isArray(i)?e.removeMany(i):e.remove(i)),s)if(Array.isArray(s)){let r=s.filter(a=>!e.includes(a));e.addMany(r)}else e.includes(s)||e.add(s)}_renderShadowCubeMap(t,e,i){let s=this._shadowMap;if(!s)return!1;let r=this.view.basemapTerrain.hasStencilEnabledExtents,a=s.start(t.camera,e,i,this._contentPixelRatio,r);return a&&s.faces.forEach(o=>this.view._stage.renderer.renderViewshedShadowMap(o)),s.finish(),a}_setupViewshedParameters(t,e){let i=this._shadowMap;if(!i)return this._passParameters;let s=this._passParameters,r=t.effectiveObserverRenderSpace;s.localOrigin=r,s.observerOffset=R($s,t.observerRenderSpace,t.effectiveObserverRenderSpace),s.fovs=[g(t.horizontalFieldOfView),g(t.verticalFieldOfView)],s.headingAndTilt=[g(t.heading),g(t.tiltParallelToSurface)],s.upVector=t.tiltedUpVector;let a=Ks(t.targetRenderSpace,r);s.targetVector=a;let o=new Array,h=new Array;for(let d=0;d<i.numActiveFaces;d++)Gt(Ct,i.viewshedViewMatrices[d],r),o.push(...Ct),Ys(i.viewshedProjectionMatrices[d],Ct,bs),h.push(...bs);return s.viewMatrices=o,s.projectionMatrices=h,s.volumeOffset=this.selectedViewshed?.()===t.viewshed?Js(t,this.view,e.eye):0,s}get test(){return{viewsheds:this._viewsheds,shadowMap:this._shadowMap,viewshedsInView:this._viewshedsInView}}};function Ks(t,e){let i=u();return R(i,t,e)}function Ys(t,e,i){let s=k(.5,.5,.5);return ie(i,s),qt(i,i,s),L(i,i,t),L(i,i,e),i}function Zs(t,e){let i=ri(e.observerRenderSpace,e.farDistanceRenderSpace);return!!t.ready&&t.frustum.intersectsSphere(i)}function Js(t,e,i){if(t==null)return 0;let{observerRenderSpace:s,targetRenderSpace:r}=t,a=dt(i,s)>dt(i,r)?t.observer:t.target;return e.pixelSizeAt(a)}n([l()],$.prototype,"selectedViewshed",void 0),n([l()],$.prototype,"shadowMap",null),n([l()],$.prototype,"hasViewsheds",null),n([l()],$.prototype,"_contentPixelRatio",null),n([l()],$.prototype,"_viewshedsInView",null),n([l()],$.prototype,"consumes",void 0),n([l()],$.prototype,"produces",void 0),$=n([z("esri.views.3d.webgl-engine.lib.Viewshed")],$);var $s=u(),Ct=_(),bs=_();var Q=class extends Gi(te){constructor(t){super(t),this.type="viewshed-view-3d",this.analysis=null,this.tool=null,this._selectedViewshed=null,this.viewshedComputedDataHandles=null,this._placementTask=null,this._viewshedRenderer=null,this._intersector=null}get selectedViewshed(){return this._selectedViewshed}set selectedViewshed(t){this._unselectOtherViewsheds(t),this._selectedViewshed=t}get selectedViewshedComputedData(){return this.tool?.selectedViewshedComputedData}initialize(){let t=this.view;this._viewshedRenderer=new $({view:t,selectedViewshed:()=>this.selectedViewshed??this.tool?.stagedViewshed}),this._intersector=ui(this.view.state.viewingMode),this._intersector.options.hud=!1,this._intersector.options.store=oi.MIN,this.viewshedComputedDataHandles=Oe(()=>this.analysis.viewsheds,e=>{let i=new b({renderCoordsHelper:t.renderCoordsHelper,viewshed:e}),s=Symbol();return this.addHandles([v(()=>({valid:i.isValid(),canProject:Kt(i.observer?.spatialReference,this.view.spatialReference)||Xt()}),({valid:r,canProject:a},o)=>{this.visible&&(r&&a?this._addViewshedsToRenderer(i):o?.valid&&o?.canProject&&this._removeViewshedsFromRenderer(i),a||Ui(this.analysis,i.observer.spatialReference,xt.getLogger(this)))},T),v(()=>[t.state.camera,t.slicePlane,i.viewshed.observer,i.targetRenderSpace,i.verticalFieldOfView,i.horizontalFieldOfView,i.feature],()=>{this._updateObserverFromFeature(t,i)},T)]),{viewshedComputedData:i,remove:()=>{this.removeHandles(s),this._removeViewshedsFromRenderer(i),i.destroy()}}}),this._analysisVisualization=new Ve({view:t,analysisViewData:this,isDecoration:!this.parent}),this.addHandles([v(()=>this.visible,e=>{let i=this.viewshedComputedDataHandles;if(i==null)return;e||(this.selectedViewshed=null);let s=i.map(r=>r.viewshedComputedData).filter(r=>r.isValid()).toArray();e?this._addViewshedsToRenderer(s):this._removeViewshedsFromRenderer(s)}),v(()=>t.renderCoordsHelper,e=>{this.viewshedComputedDataHandles?.forEach(({viewshedComputedData:i})=>i.renderCoordsHelper=e)}),Qi(this,We),Te(()=>this.interactive,()=>{this._unselectOtherViewsheds(this.selectedViewshed)},he)])}destroy(){this._placementTask=Se(this._placementTask),Ki(this),this._analysisVisualization=C(this._analysisVisualization);let t=this.viewshedComputedDataHandles;t!=null&&this._removeViewshedsFromRenderer(t.map(e=>e.viewshedComputedData).toArray())}async createViewsheds(t){return this._placementTask=Se(this._placementTask),this._placementTask=Xi(this,t),this.tool!=null&&this.tool.createViewsheds(),await this._placementTask.promise}_addViewshedsToRenderer(t){this._viewshedRenderer.updateViewsheds({adds:t})}_removeViewshedsFromRenderer(t){this._viewshedRenderer.updateViewsheds({removes:t})}_updateObserverFromFeature(t,e){let i=e.observerRenderSpace,s=e.targetRenderSpace,r=j(u(),i),a={observer:i,observerSurfaceNormal:null,observerAdjusted:r,observerFeatureId:Mi(e.feature),target:s,targetSurfaceNormal:null,targetAdjusted:j(u(),s),targetFeatureId:null};yi(t,this._intersector,a,o=>Math.min(o,.05*e.farDistanceRenderSpace)),e.observerRenderSpaceOverride=Jt(r,i)?null:r}_unselectOtherViewsheds(t){if(t!=null)for(let e of this.view.tools.items)e!==this.tool&&e instanceof We&&(e.analysisViewData.selectedViewshed=null)}get test(){}};n([l({readOnly:!0})],Q.prototype,"type",void 0),n([l({constructOnly:!0,nonNullable:!0})],Q.prototype,"analysis",void 0),n([l()],Q.prototype,"tool",void 0),n([l()],Q.prototype,"_selectedViewshed",void 0),n([l()],Q.prototype,"selectedViewshed",null),n([l()],Q.prototype,"selectedViewshedComputedData",null),n([l()],Q.prototype,"viewshedComputedDataHandles",void 0),n([l()],Q.prototype,"_analysisVisualization",void 0),n([l()],Q.prototype,"_placementTask",void 0),n([l()],Q.prototype,"_viewshedRenderer",void 0),Q=n([z("esri.views.3d.analysis.ViewshedAnalysisView3D")],Q);var Eh=Q;export{Eh as default};
