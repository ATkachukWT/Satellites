import{c as N}from"./chunk-YMDW3G4U.js";import{a as ee}from"./chunk-BSSTF6JG.js";import{a as te}from"./chunk-LXEWGICX.js";import{d as Q,i as X}from"./chunk-XIZXEWWA.js";import{a as q,b as K}from"./chunk-MPAJA3DL.js";import{r as Z}from"./chunk-TPFJWNIU.js";import{a as $}from"./chunk-BOVYXYHK.js";import{u as z}from"./chunk-QT6UNBJP.js";import{a as _}from"./chunk-4XZ6X7MQ.js";import{b as Y}from"./chunk-R4A63S45.js";import{a as J}from"./chunk-F6JAWRPN.js";import{r as W}from"./chunk-UHRSAPGQ.js";var T,g;(function(e){e[e.None=0]="None",e[e.Int16=1]="Int16",e[e.Int32=2]="Int32"})(T||(T={})),function(e){e[e.Replace=0]="Replace",e[e.Outside=1]="Outside",e[e.Inside=2]="Inside",e[e.Finished=3]="Finished"}(g||(g={}));function re(){return v||(v=new Promise(e=>import("./chunk-44YJKV3K.js").then(t=>t.i).then(({default:t})=>{let r=t({locateFile:ue,onRuntimeInitialized:()=>e(r)});delete r.then})).catch(e=>{throw e})),v}function ue(e){return Y(`esri/libs/i3s/${e}`)}var v;var O=class{constructor(t,r,n,o,c,a){this.layout=t,this.interleavedVertexData=r,this.indices=n,this.hasColors=o,this.hasModifications=c,this.positionData=a}},F=class{constructor(t,r,n,o,c,a,u){this.componentOffsets=t,this.featureIds=r,this.anchorIds=n,this.anchors=o,this.transformedGeometry=c,this.globalTrafo=a,this.obb=u}},se=class extends ee{constructor(t){super("SceneLayerWorker","process",{process:r=>[r.geometryBuffer],project:r=>[r.positions.buffer],transformNormals:r=>[r.normals.buffer]},t,{hasInitialize:!0})}setModifications(t,r,n,o){let c={context:t,modifications:le(r,n,o),isGeodetic:o.isGeographic};this.broadcast(c,"setModifications")}setLegacySchema(t,r){let n=JSON.stringify(r);return this.broadcast({context:t,jsonSchema:n},"setLegacySchema")}destroyContext(t){return this.broadcast(t,"destroyContext")}project(t,r){return this.invokeMethod("project",t,r)}transformNormals(t,r){return this.invokeMethod("transformNormals",t,r)}},s=new J({deallocator:null}),A=$();function le(e,t,r){s.clear();let n=1/0,o=1/0,c=-1/0,a=-1/0,u=!1;for(let p of t){let w=p.type==="clip"?g.Inside:p.type==="mask"?g.Outside:g.Replace,d=p.geometry,b=h=>h;if(d.spatialReference){if(!Z(d.spatialReference,r)){W.getLogger("esri.views.3d.layers.I3SMeshWorkerHandle").warn("Can't project modification polygon into layer spatial reference, ignoring modification");continue}b=h=>(te(h,d.spatialReference,A,r),A)}else d.hasZ||(A[2]=0,b=h=>(A[0]=h[0],A[1]=h[1],A));u=u||w===g.Outside,s.push(w),s.push(d.rings.length);for(let h of d.rings){s.push(h.length);for(let M of h){let l=b(M);s.push(l[0]),s.push(l[1]),s.push(l[2]),n=Math.min(n,l[0]),o=Math.min(o,l[1]),c=Math.max(c,l[0]),a=Math.max(a,l[1])}}}e!=null&&(u?(s.push(g.Inside),s.push(2),s.push(4),s.push(n-1e-4),s.push(o-1e-4),s.push(0),s.push(c+1e-4),s.push(o-1e-4),s.push(0),s.push(c+1e-4),s.push(a+1e-4),s.push(0),s.push(n-1e-4),s.push(a+1e-4),s.push(0),s.push(4),s.push(e[0]),s.push(e[1]),s.push(0),s.push(e[2]),s.push(e[1]),s.push(0),s.push(e[2]),s.push(e[3]),s.push(0),s.push(e[0]),s.push(e[3]),s.push(0)):(s.push(g.Outside),s.push(1),s.push(4),s.push(e[0]),s.push(e[1]),s.push(0),s.push(e[2]),s.push(e[1]),s.push(0),s.push(e[2]),s.push(e[3]),s.push(0),s.push(e[0]),s.push(e[3]),s.push(0))),s.push(g.Finished);let m=new Float64Array(s.length);for(let p=0;p<s.length;++p)m[p]=s.at(p);return m}async function ve(e){i=await L();let t=[e.geometryBuffer];return{result:oe(i,e,t),transferList:t}}async function Ue(e){i=await L();let t=[e.geometryBuffer],{geometryBuffer:r}=e,n=r.byteLength,o=i._malloc(n),c=new Uint8Array(i.HEAPU8.buffer,o,n);c.set(new Uint8Array(r));let a=i.dracoDecompressPointCloudData(o,c.byteLength);if(i._free(o),a.error.length>0)throw new Error(`i3s.wasm: ${a.error}`);let u=a.featureIds?.length>0?a.featureIds.slice():null,m=a.positions.slice();return u&&t.push(u.buffer),t.push(m.buffer),{result:{positions:m,featureIds:u},transferList:t}}async function Be(e){await L(),me(e);let t={buffer:e.buffer};return{result:t,transferList:[t.buffer]}}async function De(e){await L(),pe(e)}async function Ce(e){i=await L(),i.setLegacySchema(e.context,e.jsonSchema)}async function ke(e){let{localMatrix:t,origin:r,positions:n,vertexSpace:o}=e,c=_.fromJSON(e.inSpatialReference),a=_.fromJSON(e.outSpatialReference),u,[{projectBuffer:m},{initializeProjection:p}]=await Promise.all([import("./chunk-HE4L4UYE.js"),import("./chunk-423Y2HTX.js")]);await p(c,a);let w=[0,0,0];if(!m(r,c,0,w,a,0))throw new Error("Failed to project");if(o.type==="georeferenced"&&o.origin==null){if(u=new Float64Array(n.length),!m(n,c,0,u,a,0,u.length/3))throw new Error("Failed to project")}else{let l=o.type==="georeferenced"?q.fromJSON(o):K.fromJSON(o),{projectMeshVertexPositions:y}=await import("./chunk-O6YEPVMB.js"),E=y({vertexAttributes:{position:n},transform:t?{localMatrix:t}:void 0,vertexSpace:l,spatialReference:c},a);if(!E)throw new Error("Failed to project");u=E}let d=u.length,[b,h,M]=w;for(let l=0;l<d;l+=3)u[l]-=b,u[l+1]-=h,u[l+2]-=M;return{result:{projected:u,original:n,projectedOrigin:w},transferList:[u.buffer,n.buffer]}}async function He({normalMatrix:e,normals:t}){let r=new Float32Array(t.length);return Q(r,t,e),z(e)&&X(r,r),{result:{transformed:r,original:t},transferList:[r.buffer,t.buffer]}}function Ge(e){ne(e)}var he,i;function pe(e){if(!i)return;let t=e.modifications,r=i._malloc(8*t.length),n=new Float64Array(i.HEAPU8.buffer,r,t.length);for(let o=0;o<t.length;++o)n[o]=t[o];i.setModifications(e.context,r,t.length,e.isGeodetic),i._free(r)}function oe(e,t,r){let{context:n,globalTrafo:o,mbs:c,obbData:a,elevationOffset:u,geometryBuffer:m,geometryDescriptor:p,indexToVertexProjector:w,vertexToRenderProjector:d}=t,b=e._malloc(m.byteLength),h=33,M=e._malloc(h*Float64Array.BYTES_PER_ELEMENT),l=new Uint8Array(e.HEAPU8.buffer,b,m.byteLength);l.set(new Uint8Array(m));let y=new Float64Array(e.HEAPU8.buffer,M,h);P(y,[NaN,NaN,NaN]);let E=y.byteOffset+3*y.BYTES_PER_ELEMENT,S=new Float64Array(y.buffer,E);P(S,o),E+=16*y.BYTES_PER_ELEMENT,S=new Float64Array(y.buffer,E),P(S,c),E+=4*y.BYTES_PER_ELEMENT,a&&(S=new Float64Array(y.buffer,E),P(S,a));let U=p,ie={isDraco:!1,isLegacy:!1,color:t.layouts.some(x=>x.some(I=>I.name==="color")),normal:t.needNormals&&t.layouts.some(x=>x.some(I=>I.name==="normalCompressed")),uv0:t.layouts.some(x=>x.some(I=>I.name==="uv0")),uvRegion:t.layouts.some(x=>x.some(I=>I.name==="uvRegion")),featureIndex:U.featureIndex},f=e.process(n,!!t.obbData,b,l.byteLength,U,ie,M,u,w,d,t.normalReferenceFrame);if(e._free(M),e._free(b),f.error.length>0)throw new Error(`i3s.wasm: ${f.error}`);if(f.discarded)return null;let j=f.componentOffsets.length>0?f.componentOffsets.slice():null,R=f.featureIds.length>0?f.featureIds.slice():null,ae=f.anchorIds.length>0?Array.from(f.anchorIds):null,fe=f.anchors.length>0?Array.from(f.anchors):null,B=f.interleavedVertedData.slice().buffer,D=f.indicesType===T.Int16?new Uint16Array(f.indices.buffer,f.indices.byteOffset,f.indices.byteLength/2).slice():new Uint32Array(f.indices.buffer,f.indices.byteOffset,f.indices.byteLength/4).slice(),C=f.positions.slice(),{buffer:k,byteOffset:H,byteLength:G}=f.positionIndices,V=f.positionIndicesType===T.Int16?new Uint16Array(k,H,G/2).slice():new Uint32Array(k,H,G/4).slice(),ce=new O(t.layouts[0],B,D,f.hasColors,f.hasModifications,{data:C,indices:V});return R&&r.push(R.buffer),j&&r.push(j.buffer),r.push(B),r.push(D.buffer),r.push(C.buffer),r.push(V.buffer),new F(j,R,ae,fe,ce,o,f.obb)}function Ve(e){return e===0?N.Unmodified:e===1?N.PotentiallyModified:e===2?N.Culled:N.Unknown}function me(e){if(!i)return;let{context:t,buffer:r}=e,n=i._malloc(r.byteLength),o=r.byteLength/Float64Array.BYTES_PER_ELEMENT,c=new Float64Array(i.HEAPU8.buffer,n,o),a=new Float64Array(r);c.set(a),i.filterOBBs(t,n,o),a.set(c),i._free(n)}function ne(e){i&&i.destroy(e)===0&&(i=null)}function P(e,t){for(let r=0;r<t.length;++r)e[r]=t[r]}async function We(){i||await L()}async function L(){return i||(i=await(he??=re())),i}var Je={transform:(e,t)=>i&&oe(i,e,t),destroy:ne};export{se as a,le as b,ve as c,Ue as d,Be as e,De as f,Ce as g,ke as h,He as i,Ge as j,pe as k,Ve as l,me as m,We as n,Je as o};
