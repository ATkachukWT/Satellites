import{a as U}from"./chunk-W277N2SJ.js";import{c as I,l as N}from"./chunk-2CQRLDTB.js";import"./chunk-Q5KIWWVU.js";import{d as z,e as L}from"./chunk-ZVLOOFGN.js";import"./chunk-IAG3AFVL.js";import"./chunk-5BRKCXYS.js";import"./chunk-DSVUPQIZ.js";import"./chunk-QCZ3ZIGQ.js";import"./chunk-CUJB6F5L.js";import"./chunk-VMECOA4F.js";import"./chunk-4RMBQ2W6.js";import"./chunk-JPMGMA4B.js";import"./chunk-PMVQ5DJK.js";import{a as T}from"./chunk-6DGDLLNL.js";import"./chunk-DJW5LMRG.js";import"./chunk-ALWV3RJ2.js";import"./chunk-DEH76MSI.js";import{a as C}from"./chunk-DVBZA6ZU.js";import"./chunk-JTDXB5TK.js";import{h as R,q as S,t as D}from"./chunk-TPFJWNIU.js";import"./chunk-P25RU3X5.js";import"./chunk-XRRQM4E2.js";import"./chunk-GWBRHLNH.js";import"./chunk-EM35R6FY.js";import"./chunk-QXXXCEV5.js";import{p as A}from"./chunk-6B5XFA6F.js";import"./chunk-OLOKUDVI.js";import"./chunk-PTZYZULI.js";import"./chunk-NMLYCCKN.js";import"./chunk-RSDQHAJX.js";import{a as j}from"./chunk-BOVYXYHK.js";import"./chunk-JGEVVXD4.js";import{p as G}from"./chunk-B3FO6PT7.js";import"./chunk-C4UMJHQC.js";import"./chunk-BCREO4Q5.js";import"./chunk-LXFQWIWE.js";import"./chunk-QT6UNBJP.js";import"./chunk-SLAWDKDA.js";import{a as v,c as H,h as O,i as w,j as x}from"./chunk-MWSXMSWY.js";import"./chunk-JRCKELO6.js";import"./chunk-YR2HD3ZC.js";import{a as _}from"./chunk-GJASVPF6.js";import"./chunk-XZIOXVVJ.js";import"./chunk-SXQPBCOX.js";import"./chunk-LFH24RLM.js";import{n as V}from"./chunk-Z5Q7KLA4.js";import"./chunk-X4LNX4BR.js";import"./chunk-4XZ6X7MQ.js";import"./chunk-WLHY3MMA.js";import"./chunk-KGVXGH6H.js";import"./chunk-ARRCN5K3.js";import"./chunk-LXQPIAN7.js";import"./chunk-DB3UIQCU.js";import"./chunk-SBHKMV3P.js";import"./chunk-R4A63S45.js";import"./chunk-ETE32IYO.js";import"./chunk-ONUGDWDK.js";import"./chunk-SG7CQU4O.js";import{H as i,J as g}from"./chunk-QHVIRF5H.js";import{I as u}from"./chunk-WZDN6K3C.js";import{a as o}from"./chunk-QGVBCWUY.js";import"./chunk-OJQ73TPF.js";import"./chunk-354SCPDU.js";import"./chunk-OVHPPCBL.js";import"./chunk-IYZFKXJ6.js";import{p as f}from"./chunk-CKJ56T2Q.js";import"./chunk-SNFOAZZQ.js";import"./chunk-F6JAWRPN.js";import"./chunk-UHRSAPGQ.js";import{w as M}from"./chunk-V76GWARL.js";import{a as P}from"./chunk-N2WTMF3X.js";var d=class extends g{get operations(){return this._operations}get updating(){return this._updatingHandles.updating}constructor(e){super(e),this._updatingHandles=new C}initialize(){this.addHandles([f(this._updatingHandles),this._updatingHandles.add(()=>{let e=this.element.georeference;return e?.type==="control-points"?e.controlPoints:null},e=>this._elementControlPointsChanged(e),w)])}_elementControlPointsChanged(e){let t=e?.map(({mapPoint:n})=>n).filter(M),r=this.view.spatialReference;this._updatingHandles.addPromise(this._whenProjected(t,r,n=>{if(!n)return void this._replaceOperations(null);let{_operations:s}=this,c=new G({rings:[n.map(({x:l,y:h})=>[l,h])],spatialReference:r});if(s?.trySetGeometry(c))return void this.onModifiedExternally();let y=this.view.state.viewingMode;this._replaceOperations(new U(I.fromGeometry(c,y),y,l=>this._operationsGeometryChanged(l)))}))}_operationsGeometryChanged(e){let{element:{georeference:t},_operations:r}=this;if(!r||!t||t.type!=="control-points"||!t.controlPoints)return;let n=r.data.geometry,s=t.controlPoints.map(({mapPoint:l})=>l).filter(M);if(n.rings[0]?.length!==s.length)return;let c=n.rings[0].map(([l,h])=>new V({x:l,y:h,spatialReference:n.spatialReference})),y=s.map(({spatialReference:l})=>l);this._updatingHandles.addPromise(this._whenProjected(c,y,l=>this._updateElementControlPoints(l,e)))}_updateElementControlPoints(e,t){let{georeference:r}=this.element;if(!r||!e||r.type!=="control-points"||r.controlPoints?.length!==e?.length)return;let n=r.controlPoints;if(n?.length===e.length)for(let s=0;s<n.length;s++)t&&(n[s].sourcePoint=r.toSource(e[s])),n[s].mapPoint=e[s]}async _whenProjected(e,t,r){if(!e)return void r(e);let{_operations:n,element:{georeference:s}}=this,c=e.map(({spatialReference:h})=>h),y=Array.isArray(t)?t:new Array(c.length).fill(t);await D(Array.from(c).map((h,E)=>({source:h,dest:y[E]})));let l=e.map((h,E)=>R(h,y[E]));n===this._operations&&s===this.element.georeference&&r(l)}_replaceOperations(e){this._operations&&(this.removeHandles(this._operations),this._operations.destroy()),this._operations=e}};o([i({constructOnly:!0})],d.prototype,"view",void 0),o([i({constructOnly:!0})],d.prototype,"layer",void 0),o([i({constructOnly:!0})],d.prototype,"element",void 0),o([i({constructOnly:!0})],d.prototype,"onModifiedExternally",void 0),o([i()],d.prototype,"_operations",void 0),o([i()],d.prototype,"operations",null),o([i()],d.prototype,"updating",null),d=o([u("esri.views.3d.interactive.editingTools.media.MediaElementControllerControlPoints")],d);var m=class extends g{get operations(){return this._operations}get updating(){return this._updatingHandles.updating}constructor(e){super(e),this._updatingHandles=new C}initialize(){this.addHandles([f(this._updatingHandles),this._updatingHandles.add(()=>this.element.georeference?.coords,e=>this._elementCoordinatesChanged(e),w)])}_elementCoordinatesChanged(e){this._updatedElementCoordinates!==e&&this._updatingHandles.addPromise(this._whenProjected(e,this.view.spatialReference,t=>{if(!t)return void this._replaceOperations(null);let{_operations:r}=this;r?.trySetGeometry(t)?this.onModifiedExternally():this._replaceOperations(N.fromGeometry(t,this.view.state.viewingMode))}))}_operationsGeometryChanged(){let{element:{georeference:e},_operations:t}=this;if(!t||!e)return;let r=t.data.geometry;if(!e.coords)return void this._updateElementCoordinates(r);let n=e.coords.spatialReference;this._updatingHandles.addPromise(this._whenProjected(r,n,s=>this._updateElementCoordinates(s)))}_updateElementCoordinates(e){let{georeference:t}=this.element;t&&(t.coords=e,this._updatedElementCoordinates=t.coords)}async _whenProjected(e,t,r){if(!e)return void r(e);let{_operations:n,element:{georeference:s}}=this,c=await S(e,t);n===this._operations&&s===this.element.georeference&&r(c)}_replaceOperations(e){this._operations&&(this.removeHandles(this._operations),this._operations.destroy()),this._operations=e,e&&this.addHandles(e.data.on("change",()=>this._operationsGeometryChanged()),e),this.onModifiedExternally()}};o([i({constructOnly:!0})],m.prototype,"view",void 0),o([i({constructOnly:!0})],m.prototype,"layer",void 0),o([i({constructOnly:!0})],m.prototype,"element",void 0),o([i({constructOnly:!0})],m.prototype,"onModifiedExternally",void 0),o([i()],m.prototype,"_operations",void 0),o([i()],m.prototype,"operations",null),o([i()],m.prototype,"updating",null),m=o([u("esri.views.3d.interactive.editingTools.media.MediaElementControllerShape")],m);function k(e,t,r){return b(e.allLayerViews.find(n=>n.layer===t),r)}function b(e,t){if(!e||e.type!=="media-3d"||e.suspended)return!1;let r=e.layer.source;return!!r&&(r instanceof z||r instanceof L?r===t:"hasElement"in r&&r.hasElement(t))}var a=class extends g{grabbableForEvent(){return!0}constructor(e){super(e),this.interactive=!0,this.selectable=!1,this.grabbable=!0,this.grabbing=!1,this.dragging=!1,this.hovering=!0,this.selected=!1,this.cursor=null,this.consumesClicks=!0,this.events=new _.EventEmitter,this.addHandles(v(()=>this.selected,t=>this.events.emit("select-changed",{action:t?"select":"deselect"}),O))}destroy(){this._set("view",null)}intersectionDistance(e){let{view:t,layer:r,element:n}=this;if(!k(t,r,n))return null;let s=t.toMap(e,{include:{layer:r,element:n}});return s&&T(s,F,t.renderSpatialReference)?A(F,t.state.camera.eye):null}onElevationChange(){}onViewChange(){}};o([i({constructOnly:!0,nonNullable:!0})],a.prototype,"element",void 0),o([i({constructOnly:!0,nonNullable:!0})],a.prototype,"layer",void 0),o([i({constructOnly:!0,nonNullable:!0})],a.prototype,"view",void 0),o([i()],a.prototype,"interactive",void 0),o([i()],a.prototype,"selectable",void 0),o([i()],a.prototype,"grabbable",void 0),o([i()],a.prototype,"grabbing",void 0),o([i()],a.prototype,"dragging",void 0),o([i()],a.prototype,"hovering",void 0),o([i()],a.prototype,"selected",void 0),o([i()],a.prototype,"cursor",void 0),a=o([u("esri.views.3d.interactive.editingTools.media.MediaElementManipulator3D")],a);var F=j();var W=Symbol(),p=class extends _.EventedAccessor{get operations(){return this._controller?.operations}get elevationInfo(){return{mode:"on-the-ground",offset:0}}get _layerView(){let e=this.view.allLayerViews.find(t=>t.layer===this.layer);return e?.type==="media-3d"?e:null}get visible(){return b(this._layerView,this.element)}get isDraped(){return!0}get origin(){return null}get updating(){return!!this._controller?.updating}get _controllerClass(){return this.tool==="transform"||this.element.georeference?.type!=="control-points"?m:d}constructor(e){super(e),this.tool="transform"}initialize(){this.addHandles([v(()=>this._controllerClass,e=>this._updateController(e),x),H(()=>this._layerView,"element-render-changed",({element:e})=>{this.element===e&&this.emit("committed")})])}toMap(e){let{layer:t,element:r}=this;return this.view.toMap(e,{include:{layer:t,element:r}})}createManipulator(e){let{view:t,layer:r,element:n}=this;return new a(P({view:t,layer:r,element:n},e))}_updateController(e){if(this._controller&&this._controller instanceof e)return;this.removeHandles(W);let{view:t,layer:r,element:n}=this,s=()=>{this.emit("modified-externally")};this._controller=new e({view:t,layer:r,element:n,onModifiedExternally:s}),s(),this.addHandles(f(this._controller),W)}};o([i({constructOnly:!0})],p.prototype,"view",void 0),o([i({constructOnly:!0})],p.prototype,"layer",void 0),o([i({constructOnly:!0})],p.prototype,"element",void 0),o([i()],p.prototype,"tool",void 0),o([i()],p.prototype,"_controller",void 0),o([i()],p.prototype,"elevationInfo",null),o([i()],p.prototype,"_layerView",null),o([i()],p.prototype,"visible",null),o([i()],p.prototype,"updating",null),o([i()],p.prototype,"_controllerClass",null),p=o([u("esri.views.3d.interactive.editingTools.ManipulatedObject3DMediaElement")],p);export{p as ManipulatedObject3DMediaElement};
