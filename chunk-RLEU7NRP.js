import{b as Be,d as ve}from"./chunk-R3QN3IUS.js";import{b as P}from"./chunk-3NX4GRTL.js";import{b as be,e as Q}from"./chunk-4RW2T2TW.js";import{a as Ie,b as Le}from"./chunk-IDJEFLWC.js";import{b as N}from"./chunk-F4FOXK2P.js";import{c as Ce}from"./chunk-SWCOPTUX.js";import{b as Ee}from"./chunk-AEU2INWT.js";import{a as Ae,c as Fe,d as Oe,e as Ve}from"./chunk-SZTSN5BD.js";import{b as J}from"./chunk-EDOVNTC7.js";import{c as ye,d as Re}from"./chunk-37H4LYIE.js";import{b as B}from"./chunk-YQNUGDFH.js";import{a as Me}from"./chunk-VIFXPONX.js";import{a as Z,b as Se,g as w}from"./chunk-ONYJLWAD.js";import{b as we}from"./chunk-QSMPW36A.js";import{b as Te,d as ge,f as z,i as K}from"./chunk-XIZXEWWA.js";import{a as pe,h as $,q as xe}from"./chunk-DJW5LMRG.js";import{a as he}from"./chunk-ALWV3RJ2.js";import{a as I,c as L}from"./chunk-DEH76MSI.js";import{F as se,l as k}from"./chunk-KD27XIJC.js";import{a as F}from"./chunk-G7TP3ZYQ.js";import{a as R}from"./chunk-RWCIDBNQ.js";import{g as de}from"./chunk-EM35R6FY.js";import{c as W,d as H,o as le,p as ce,s as me,t as fe}from"./chunk-2ZFXOJDB.js";import{a as ae,e as ie,g as U,u as ne,x as ue,y as q}from"./chunk-6B5XFA6F.js";import{f as oe}from"./chunk-ZTOZWLEE.js";import{f as _}from"./chunk-RJWOVI3M.js";import{a as C}from"./chunk-BOVYXYHK.js";import{u as G}from"./chunk-QT6UNBJP.js";import{a as A,b as E}from"./chunk-N2WTMF3X.js";function M(r){if(r==null)return null;let t=r.offset!=null?r.offset:ye,s=r.rotation!=null?r.rotation:0,o=r.scale!=null?r.scale:Re,c=L(1,0,0,0,1,0,t[0],t[1],1),m=L(Math.cos(s),-Math.sin(s),0,Math.sin(s),Math.cos(s),0,0,0,1),n=L(o[0],0,0,0,o[1],0,0,0,1),l=I();return $(l,m,n),$(l,c,l),l}var X=class{constructor(){this.geometries=new Array,this.materials=new Array,this.textures=new Array}},D=class{constructor(t,s,o){this.name=t,this.lodThreshold=s,this.pivotOffset=o,this.stageResources=new X,this.numberOfVertices=0}};async function vr(r,t){let s=Ge(we(r));if(s.fileType==="wosr"){let u=await(t.cache?t.cache.loadWOSR(s.url,t):Ie(s.url,t)),{engineResources:p,referenceBoundingBox:h}=Le(u,t);return{lods:p,referenceBoundingBox:h,isEsriSymbolResource:!1,isWosr:!0}}let o;if(t.cache)o=await t.cache.loadGLTF(s.url,t,!!t.usePBR);else{let{loadGLTF:u}=await import("./chunk-THC27IVH.js");o=await u(new Me(t.streamDataRequester),s.url,t,t.usePBR)}let c=o.model.meta?.ESRI_proxyEllipsoid,m=o.meta.isEsriSymbolResource&&c!=null&&o.meta.ESRI_webstyle==="EsriRealisticTreesStyle";m&&!o.customMeta.esriTreeRendering&&(o.customMeta.esriTreeRendering=!0,We(o,c));let n=!!t.usePBR,l=o.meta.isEsriSymbolResource?{usePBR:n,isSchematic:!1,treeRendering:m,mrrFactors:Ve}:{usePBR:n,isSchematic:!1,treeRendering:!1,mrrFactors:Fe},e=E(A({},t.materialParameters),{treeRendering:m}),{engineResources:a,referenceBoundingBox:i}=_e(o,l,e,t,s.specifiedLodIndex);return{lods:a,referenceBoundingBox:i,isEsriSymbolResource:o.meta.isEsriSymbolResource,isWosr:!1}}function Ge(r){let t=r.match(/(.*\.(gltf|glb))(\?lod=([0-9]+))?$/);return t?{fileType:"gltf",url:t[1],specifiedLodIndex:t[4]!=null?Number(t[4]):null}:r.match(/(.*\.(json|json\.gz))$/)?{fileType:"wosr",url:r,specifiedLodIndex:null}:{fileType:"unknown",url:r,specifiedLodIndex:null}}function _e(r,t,s,o,c){let m=r.model,n=new Array,l=new Map,e=new Map,a=m.lods.length,i=se();return m.lods.forEach((u,p)=>{let h=o.skipHighLods===!0&&(a>1&&p===0||a>3&&p===1)||o.skipHighLods===!1&&c!=null&&p!==c;if(h&&p!==0)return;let f=new D(u.name,u.lodThreshold,[0,0,0]);u.parts.forEach(g=>{let T=h?new N({},o):ke(m,g,f,t,s,l,e,o),{geometry:b,vertexCount:d}=Ue(g,T??new N({},o)),x=b.boundingInfo;x!=null&&p===0&&(k(i,x.bbMin),k(i,x.bbMax)),T!=null&&(f.stageResources.geometries.push(b),f.numberOfVertices+=d)}),h||n.push(f)}),{engineResources:n,referenceBoundingBox:i}}function ke(r,t,s,o,c,m,n,l){let e=r.materials.get(t.material);if(e==null)return null;let{normal:a,color:i,texCoord0:u,tangent:p}=t.attributes,h=t.material+(a?"_normal":"")+(i?"_color":"")+(u?"_texCoord0":"")+(p?"_tangent":""),f=t.attributes.texCoord0!=null,g=t.attributes.normal!=null,T=qe(e.alphaMode);if(!m.has(h)){if(f){let v=(V,je=!1)=>{if(V!=null&&!n.has(V)){let j=r.textures.get(V);if(j){let y=j.data;n.set(V,new Ee(P(y)?y.data:y,E(A({},j.parameters),{preMultiplyAlpha:!P(y)&&je,encoding:P(y)?y.encoding:void 0})))}}};v(e.colorTexture,T!==w.Opaque),v(e.normalTexture),v(e.occlusionTexture),v(e.emissiveTexture),v(e.metallicRoughnessTexture)}let d=1/_,x=e.color[0]**d,Y=e.color[1]**d,ee=e.color[2]**d,Pe=e.emissiveFactor[0]**d,Ne=e.emissiveFactor[1]**d,De=e.emissiveFactor[2]**d,O=e.colorTexture!=null&&f?n.get(e.colorTexture):null,re=Ae(e),te=e.normalTextureTransform?.scale!=null?e.normalTextureTransform?.scale:de;m.set(h,new N(A(E(A({},o),{transparent:T===w.Blend,customDepthTest:Se.Lequal,textureAlphaMode:T,textureAlphaCutoff:e.alphaCutoff,diffuse:[x,Y,ee],ambient:[x,Y,ee],opacity:e.opacity,doubleSided:e.doubleSided,doubleSidedType:"winding-order",cullFace:e.doubleSided?Z.None:Z.Back,hasVertexColors:!!t.attributes.color,hasVertexTangents:!!t.attributes.tangent,normalType:g?J.Attribute:J.ScreenDerivative,castShadows:!0,receiveShadows:e.receiveShadows,receiveAmbientOcclusion:e.receiveAmbientOcclustion,textureId:O?.id,colorMixMode:e.colorMixMode,normalTextureId:e.normalTexture!=null&&f?n.get(e.normalTexture).id:void 0,textureAlphaPremultiplied:O!=null&&!!O.parameters.preMultiplyAlpha,occlusionTextureId:e.occlusionTexture!=null&&f?n.get(e.occlusionTexture).id:void 0,emissiveTextureId:e.emissiveTexture!=null&&f?n.get(e.emissiveTexture).id:void 0,metallicRoughnessTextureId:e.metallicRoughnessTexture!=null&&f?n.get(e.metallicRoughnessTexture).id:void 0,emissiveFactor:[Pe,Ne,De],mrrFactors:re?Oe:[e.metallicFactor,e.roughnessFactor,o.mrrFactors[2]],isSchematic:re,colorTextureTransformMatrix:M(e.colorTextureTransform),normalTextureTransformMatrix:M(e.normalTextureTransform),scale:[te[0],te[1]],occlusionTextureTransformMatrix:M(e.occlusionTextureTransform),emissiveTextureTransformMatrix:M(e.emissiveTextureTransform),metallicRoughnessTextureTransformMatrix:M(e.metallicRoughnessTextureTransform)}),c),l))}let b=m.get(h);if(s.stageResources.materials.push(b),f){let d=x=>{x!=null&&s.stageResources.textures.push(n.get(x))};d(e.colorTexture),d(e.normalTexture),d(e.occlusionTexture),d(e.emissiveTexture),d(e.metallicRoughnessTexture)}return b}function Ue(r,t){let s=r.attributes.position.count,o=ve(r.indices||s,r.primitiveType),c=F(3*s),{typedBuffer:m,typedBufferStride:n}=r.attributes.position;Te(c,m,r.transform,3,n);let l=[[R.POSITION,new B(c,o,3,!0)]];if(r.attributes.normal!=null){let a=F(3*s),{typedBuffer:i,typedBufferStride:u}=r.attributes.normal;xe(S,r.transform),ge(a,i,S,3,u),G(S)&&K(a,a),l.push([R.NORMAL,new B(a,o,3,!0)])}if(r.attributes.tangent!=null){let a=F(4*s),{typedBuffer:i,typedBufferStride:u}=r.attributes.tangent;pe(S,r.transform),be(a,i,S,4,u),G(S)&&K(a,a,4),l.push([R.TANGENT,new B(a,o,4,!0)])}if(r.attributes.texCoord0!=null){let a=F(2*s),{typedBuffer:i,typedBufferStride:u}=r.attributes.texCoord0;Be(a,i,2,u),l.push([R.UV0,new B(a,o,2,!0)])}let e=r.attributes.color;if(e!=null){let a=new Uint8Array(4*s);e.elementCount===4?e instanceof H?Q(a,e,1,255):(e instanceof ce||e instanceof fe)&&Q(a,e,1/255,255):(a.fill(255),e instanceof W?z(a,e.typedBuffer,1,255,4,e.typedBufferStride):(r.attributes.color instanceof le||r.attributes.color instanceof me)&&z(a,e.typedBuffer,1/255,255,4,r.attributes.color.typedBufferStride)),l.push([R.COLOR,new B(a,o,4,!0)])}return{geometry:new Ce(t,l),vertexCount:s}}var S=I();function qe(r){switch(r){case"BLEND":return w.Blend;case"MASK":return w.Mask;case"OPAQUE":case null:case void 0:return w.Opaque}}function We(r,t){for(let s=0;s<r.model.lods.length;++s){let o=r.model.lods[s];for(let c of o.parts){let m=c.attributes.normal;if(m==null)return;let n=c.attributes.position,l=n.count,e=C(),a=C(),i=C(),u=new Float32Array(4*l),p=new Float32Array(3*l),h=oe(he(),c.transform),f=0,g=0;for(let T=0;T<l;T++){n.getVec(T,a),m.getVec(T,e),q(a,a,c.transform),ie(i,a,t.center),U(i,i,t.radius);let b=i[2],d=ae(i),x=Math.min(.45+.55*d*d,1)**_;U(i,i,t.radius),h!==null&&q(i,i,h),ne(i,i),s+1!==r.model.lods.length&&r.model.lods.length>1&&ue(i,i,e,b>-1?.2:Math.min(-4*b-3.8,1)),p[f]=i[0],p[f+1]=i[1],p[f+2]=i[2],f+=3,u[g]=x,u[g+1]=x,u[g+2]=x,u[g+3]=1,g+=4}c.attributes.normal=new W(p),c.attributes.color=new H(u)}}}export{M as a,vr as b,Ge as c};
