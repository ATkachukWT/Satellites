import{a as xs}from"./chunk-AGNIXKQH.js";import{$ as Xi,A as se,B as ti,C as Be,D as A,E as gt,F as ii,G as Ya,H as et,J as ds,K as de,L as Ze,M as Lt,N as Fe,O as Ki,P as Et,Q as tt,R as ue,S as it,T as J,U as Ke,V as fs,W as hs,X as ys,Z as Ce,_ as $i,a as os,aa as j,b as ee,ba as E,c as X,ca as gs,d as s,da as g,e as y,ea as F,f as z,fa as c,g as v,ga as C,h as At,ha as Oe,i as Zi,ia as ai,j as ns,ja as xt,k as R,ka as Qi,l as ei,la as vt,m as Rt,ma as O,n as Y,na as ri,o as Fi,p as ls,q as us,r as Qa,s as le,t as ps,u as D,v as ye,y as ms,z as cs}from"./chunk-W3HXXDUN.js";import{a as Xa}from"./chunk-P5DBP5G4.js";import{B as Vi,E as ts,F as is,a as Ue,b as Si,c as Na,d as Qt,e as ki,f as kr,g as Hr,h as Ga,i as ja,j as Nr,k as Gr,l as jr,m as Hi,n as Wr,o as Zr,p as Kr,q as $r,r as Xr,s as Qr,t as Yr,v as Jr,w as es,x as Wa,y as Za}from"./chunk-E4MEDSYW.js";import{a as k}from"./chunk-WH5SLVE3.js";import{y as qr}from"./chunk-E2PEM77A.js";import{c as Er,f as qi}from"./chunk-R3ABULTC.js";import{a as Dr}from"./chunk-47CBJZNC.js";import{b as ht,c as wi,g as ce,h as ss,i as Wi,j as L,k as K,l as q,m as U,n as G,o as yt}from"./chunk-BFOAQMH4.js";import{a as $a}from"./chunk-4TIUXNXO.js";import{a as Gi,b as rs,c as ji}from"./chunk-CEAEFIX3.js";import{b as Jt}from"./chunk-HUWVQAJL.js";import{a as Ka,b as as}from"./chunk-PSFZFYFC.js";import{b as Yt,e as Ni}from"./chunk-PMLKCTEJ.js";import{M as Ha,e as Rr,s as ka,t as Lr,v as Bi}from"./chunk-X7BNFUFQ.js";import{b as Br}from"./chunk-VOB6IBIW.js";import{c as Ur}from"./chunk-63B3IOWG.js";import{e as Or,h as _r}from"./chunk-DJW5LMRG.js";import{a as Ar}from"./chunk-PHNFWHVF.js";import{a as Cr}from"./chunk-W5OI4BJ2.js";import{a as Ot,b as Li,h as Ie,i as _t,j as We,k as vi,l as bi,p as Ei,q as Ui,r as qa}from"./chunk-HM5RIVQC.js";import{a as st,c as Ba}from"./chunk-OLOKUDVI.js";import{ha as Ir}from"./chunk-KGVXGH6H.js";import{a as n,b as w}from"./chunk-QGVBCWUY.js";import{E as Mr,P as Pr,c as Ua}from"./chunk-CKJ56T2Q.js";import{n as zr,r as Ri,t as Tr}from"./chunk-UHRSAPGQ.js";import{a as je,c as wr,w as Fr}from"./chunk-V76GWARL.js";import{a as m,b as x}from"./chunk-N2WTMF3X.js";var zi={[Ie.BYTE]:1,[Ie.UNSIGNED_BYTE]:1,[Ie.SHORT]:2,[Ie.UNSIGNED_SHORT]:2,[Ie.HALF_FLOAT]:2,[Ie.INT]:4,[Ie.UNSIGNED_INT]:4,[Ie.FLOAT]:4};var Yi=class{constructor(e,t){this._boundPart=null,this.vertexBuffers=new Map,this.indexBuffers=new Map,this.groups=[];for(let i in t.vertex){let{data:r,attributes:o}=t.vertex[i],l=Ka.createVertex(e,qa.STATIC_DRAW,r);this.vertexBuffers.set(i,{buffer:l,attributes:o})}for(let i in t.index){let{data:r}=t.index[i],o=Ka.createIndex(e,qa.STATIC_DRAW,r);this.indexBuffers.set(i,{buffer:o})}for(let i of t.groups)this.groups.push(x(m({},i),{vertexArrays:new Map}));this.parts=t.parts}bind(e,t,i){this._boundPart=i;let{group:r}=this.parts[this._boundPart],o=this.groups[r];if(!o)throw new Error(`Missing group ${r}.`);let l=o.vertexArrays.get(t.stringHash);if(!l){let u=new Set(t.locations.keys()),p=o.index?this.indexBuffers.get(o.index)?.buffer:null,f=new Map,d=new Map;for(let[h,{buffer:b,attributes:S}]of this.vertexBuffers){let V=S.filter(T=>u.has(T.name));V.length>0&&(f.set(h,V),d.set(h,b))}l=new as(e,t.locations,f,d,p),o.vertexArrays.set(t.stringHash,l)}e.bindVAO(l)}draw(e){if(this._boundPart==null)throw new Error("Mesh.bind() has not been called.");let{start:t,count:i}=this.parts[this._boundPart],{group:r}=this.parts[this._boundPart],{primitive:o,index:l}=this.groups[r];if(l){let u=this.indexBuffers.get(l);if(!u)throw new Error(`Missing index buffer "${l}".`);let{indexType:p}=u.buffer;if(!p)throw new Error("Buffer type error.");e.drawElements(o,i,p,t*zi[p])}else e.drawArrays(o,t,i)}unbind(e){this._boundPart=null,e.bindVAO(null)}destroy(){for(let{vertexArrays:e}of this.groups)for(let[t,i]of e)i.disposeVAOOnly();for(let{buffer:e}of this.vertexBuffers.values())e.dispose();for(let{buffer:e}of this.indexBuffers.values())e.dispose()}};var Bs={position:{type:Ie.SHORT,count:2}},Ji=class a extends Yi{static create(e,t){let i=[],{stride:r}=t;if(r==null){r=0;for(let[d,{count:h,type:b,offset:S}]of Object.entries(t.layout)){if(S!=null)throw new Error("Stride cannot be computed automatically when attribute offsets are supplied explicitly.");r+=h*zi[b]}}let o=0;for(let[d,{count:h,offset:b,type:S,normalized:V}]of Object.entries(t.layout)){b!=null&&(o=b);let T=new Cr(d,h,S,o,r,V!=null&&V,0);i.push(T),o+=h*zi[S]}let l={primitive:t.primitive};t.index!=null&&(l.index="indexData");let{count:u}=t;if(u==null&&(u=t.index?t.index.length:t.vertex.byteLength/r,Math.floor(u)!==u))throw new Error(`The byte length of vertex data must be an exact multiple of the stride, which is ${r}.`);let p={start:0,count:u,group:0,primitive:t.primitive},f={vertex:{vertexData:{data:t.vertex,attributes:i}},parts:[p],groups:[l]};return t.index!=null&&(f.index={indexData:{data:t.index}}),new a(e,f,t.layout)}static fromVertexStream(e,t){return a.create(e,{primitive:Li.TRIANGLE_STRIP,vertex:new Uint16Array(t),layout:Bs})}constructor(e,t,i){super(e,t),this._spec=i}bind(e,t,i=0){super.bind(e,t,i)}};var Ja=class{get forceStaticPath(){return je("esri-cim-animations-enable-status")==="disabled"}get forceAnimatedPath(){return je("esri-cim-animations-enable-status")==="forced"}get freezeGlobalTime(){return je("esri-cim-animations-freeze-time")??!1}get spotlightAnimatedSymbols(){return!!je("esri-cim-animations-spotlight")}get forceGlobalTimeOrigin(){return je("esri-cim-animations-freeze-time")!==!1}},si=new Ja;var $e=class extends O{};n([c(s)],$e.prototype,"globalTime",void 0),n([c(y)],$e.prototype,"animationTextureSize",void 0),n([c(X)],$e.prototype,"animationTexture",void 0),n([c(R)],$e.prototype,"toScreen",void 0),n([c(R)],$e.prototype,"toNdc",void 0),n([c(s)],$e.prototype,"mapRotation",void 0),n([c(s)],$e.prototype,"pixelRatio",void 0);function er(a){let e=Y(12.9898),t=Y(78.233),i=Y(43758.5453),r=Fe(a,Fi(e,t)),o=Ke(r,Y(3.14));return Et(Ce(o).multiply(i))}function xe(a){return se(a,Y(jr))}function vs(a,e){return a.x.multiply(e.y).subtract(e.x.multiply(a.y))}function bs(a){return a.multiply(2).subtract(1)}function H(a,e){let t=Y(2**e);return Ke(Ki(a.divide(t)),Y(2))}function bt(a,e){return A(H(a,e),Y(.5))}function ea(a,e){return H(a,e+Bi)}function Ss(a,e){return H(a,e)}function Vs(a){let e=H(a.z,7),t=Y(1).subtract(e),i=a.xyz.subtract(ls(0,0,Y(128)));return t.multiply(a).add(e.multiply(i))}function St(a){let e=us(.99609375,.0038909912109375,1519918441772461e-20,59371814131736755e-24);return Fe(a,e)}function tr(a){return ue(ue(ue(a.x,a.y),a.z),a.w)}function oi(a){return new s(1).subtract(a)}function vn(a){return a.subtract(new s(1))}function bn(a,e){return a.subtract(new s(e))}var _e=class extends O{getVisualVariableData(e){if(!this._vvData){let t=this.getAttributeDataCoords(e);this._vvData=E(this.visualVariableData,t).setDebugName("storage2")}return this._vvData}getAttributeDataCoords(e){if(!this._uv){let t=Vs(e),i=this.size,r=Rt(t.x),o=Rt(t.y).multiply(Rt(256)),l=Rt(t.z).multiply(Rt(256)).multiply(Rt(256)),u=Y(r.add(o).add(l)),p=Ke(u,i),f=u.subtract(p).divide(i);this._uv=new y(p,f).add(.5).divide(i)}return this._uv}getFilterData(e){let t=this.getAttributeDataCoords(e);return E(this.filterFlags,t).setDebugName("storage0")}getAnimationData(e){let t=this.getAttributeDataCoords(e);return E(this.animation,t).setDebugName("storage1")}getVVData(e){return this.getVisualVariableData(e)}getDataDrivenData0(e){let t=this.getAttributeDataCoords(e);return E(this.dataDriven0,t).setDebugName("storage30")}getDataDrivenData1(e){let t=this.getAttributeDataCoords(e);return E(this.dataDriven1,t).setDebugName("storage31")}getDataDrivenData2(e){let t=this.getAttributeDataCoords(e);return E(this.dataDriven2,t).setDebugName("storage32")}getGPGPUData(e){let t=this.getAttributeDataCoords(e);return E(this.gpgpu,t).setDebugName("storage4")}getLocalTimeOrigin(e){let t=this.getAttributeDataCoords(e);return E(this.localTimeOrigin,t).x.setDebugName("storage5")}getFilterFlags(e){return je("webgl-ignores-sampler-precision")?ds(this.getFilterData(e).x.multiply(Y(255))):this.getFilterData(e).x.multiply(Y(255))}getLabelVisibility(e){let t=this.getFilterData(e).y.multiply(255);return new s(1).subtract(t)}getAnimationValue(e){return this.getAnimationData(e).x}getSizeValue(e){return this.getVisualVariableData(e).x}getColorValue(e){return this.getVisualVariableData(e).y}getOpacityValue(e){return this.getVisualVariableData(e).z}getRotationValue(e){return this.getVisualVariableData(e).w}};n([c(X)],_e.prototype,"filterFlags",void 0),n([c(X)],_e.prototype,"animation",void 0),n([c(X)],_e.prototype,"gpgpu",void 0),n([c(X)],_e.prototype,"localTimeOrigin",void 0),n([c(X)],_e.prototype,"visualVariableData",void 0),n([c(X)],_e.prototype,"dataDriven0",void 0),n([c(X)],_e.prototype,"dataDriven1",void 0),n([c(X)],_e.prototype,"dataDriven2",void 0),n([c(s)],_e.prototype,"size",void 0);var ni=class extends O{};n([c(s)],ni.prototype,"activeReasons",void 0),n([c(s)],ni.prototype,"highlightAll",void 0);var Vt=class extends O{};n([c(y)],Vt.prototype,"position",void 0),n([c(s)],Vt.prototype,"distance",void 0),n([c(s)],Vt.prototype,"smallSymbolDistance",void 0),n([c(s)],Vt.prototype,"smallSymbolSizeThreshold",void 0);var fe=class extends O{};n([c(R)],fe.prototype,"displayViewScreenMat3",void 0),n([c(R)],fe.prototype,"displayViewMat3",void 0),n([c(R)],fe.prototype,"displayMat3",void 0),n([c(R)],fe.prototype,"viewMat3",void 0),n([c(R)],fe.prototype,"tileMat3",void 0),n([c(s)],fe.prototype,"displayZoomFactor",void 0),n([c(s)],fe.prototype,"requiredZoomFactor",void 0),n([c(y)],fe.prototype,"tileOffset",void 0),n([c(s)],fe.prototype,"currentScale",void 0),n([c(s)],fe.prototype,"currentZoom",void 0),n([c(s)],fe.prototype,"metersPerSRUnit",void 0),n([c(s)],fe.prototype,"rotation",void 0),n([c(s)],fe.prototype,"pixelRatio",void 0);var oe=class extends ai{};n([g(0,z)],oe.prototype,"id",void 0),n([g(1,s)],oe.prototype,"bitset",void 0),n([g(2,y)],oe.prototype,"pos",void 0);var ie=class extends xt{};n([g(14,y)],ie.prototype,"nextPos1",void 0),n([g(15,y)],ie.prototype,"nextPos2",void 0);var ae=class extends Qi{},te=class extends ri{clip(e,t){let i=new s(0),r=this.storage.getFilterFlags(e);if(i=i.add(Y(2).multiply(Y(1).subtract(ea(r,0)))),this.inside?i=i.add(Y(2).multiply(Y(1).subtract(ea(r,1)))):this.outside?i=i.add(Y(2).multiply(ea(r,1))):this.highlight&&(i=i.add(Y(2).multiply(Y(1).subtract(this._checkHighlight(r))))),t!=null){let o=new s(1).subtract(j(t.x,this.view.currentZoom)),l=j(t.y,this.view.currentZoom);i=i.add(new s(2).multiply(o.add(l)))}return i}getFragmentOutput(e,t,i=new s(1/255)){let r=new vt;return r.fragColor=this._maybeWriteHittest(t)??this._maybeHighlight(e,i)??e,r}_maybeHighlight(e,t){return this.highlight?new v(e.rgb,j(t,e.a)):null}_checkHighlight(e){let t=this._checkHighlightBit(e,0);for(let i=1;i<Bi;i++)t=t.add(this._checkHighlightBit(e,i));return j(new s(.1),t.add(this.highlight.highlightAll))}_checkHighlightBit(e,t){return Ss(e,t).multiply(H(this.highlight.activeReasons,t))}maybeRunHittest(e,t,i){if(this.hittestRequest==null)return null;let r=this.hittest(e,t,i),o=D(A(r,this.hittestRequest.distance),new s(2),new s(0)),l=this.storage.getAttributeDataCoords(e.id),u=bs(l);o=o.add(this.clip(e.id,e.zoomRange));let p=new v(new s(1/255),0,0,0);return{glPointSize:new s(1),glPosition:new v(u,o,1),color:p}}_maybeWriteHittest(e){return this.hittestRequest!=null?e.color:null}};n([Oe],te.prototype,"inside",void 0),n([Oe],te.prototype,"outside",void 0),n([C(ni)],te.prototype,"highlight",void 0),n([c(_e)],te.prototype,"storage",void 0),n([c(fe)],te.prototype,"view",void 0),n([C(Vt)],te.prototype,"hittestRequest",void 0);var re=class extends O{};n([c(y)],re.prototype,"size",void 0),n([c(X)],re.prototype,"texture",void 0);var ve=class extends O{getColor(e,t,i){return ye([ii(xe(e),i),t],[Be(e,this.values.first()),this.colors.first()],[gt(e,this.values.last()),this.colors.last()],[!0,()=>{let r=this.values.findIndex(f=>A(f,e)),o=this.values.get(r),l=r.subtract(1),u=this.values.get(l),p=e.subtract(u).divide(o.subtract(u));return J(this.colors.get(l),this.colors.get(r),p)}])}};n([c(ee.ofType(v,8))],ve.prototype,"colors",void 0),n([c(ee.ofType(s,8))],ve.prototype,"values",void 0);var be=class extends O{getOpacity(e){return ye([xe(e),new s(1)],[Be(e,this.opacityValues.first()),this.opacities.first()],[gt(e,this.opacityValues.last()),this.opacities.last()],[!0,()=>{let t=this.opacityValues.findIndex(u=>A(u,e)),i=this.opacityValues.get(t),r=t.subtract(1),o=this.opacityValues.get(r),l=e.subtract(o).divide(i.subtract(o));return J(this.opacities.get(r),this.opacities.get(t),l)}])}};n([c(ee.ofType(s,8))],be.prototype,"opacities",void 0),n([c(ee.ofType(s,8))],be.prototype,"opacityValues",void 0);var ot=class extends O{getVVRotationMat4(e){return D(xe(e),ei.identity(),()=>{let t=this.getNormalizedAngle(e).multiply(Na),i=Ce(t),r=Ze(t);return new ei(r,i,0,0,i.multiply(new s(-1)),r,0,0,0,0,1,0,0,0,0,1)})}getVVRotationMat3(e){return D(xe(e),R.identity(),()=>{let t=this.getNormalizedAngle(e).multiply(Na),i=Ce(t),r=Ze(t);return new R(r,i,0,i.multiply(new s(-1)),r,0,0,0,1)})}getNormalizedAngle(e){let t=se(this.rotationType,new s(Si.Arithmatic));return D(t,new s(90).subtract(e),e)}};n([c(s)],ot.prototype,"rotationType",void 0);var Ae=class extends O{getSize(e,t){let i=this.minMaxValueAndSize.xy,r=this.minMaxValueAndSize.zw;return D(xe(e),t,()=>{let o=e.subtract(i.x).divide(i.y.subtract(i.x)),l=de(o,new s(0),new s(1));return r.x.add(l.multiply(r.y.subtract(r.x)))})}};n([c(v)],Ae.prototype,"minMaxValueAndSize",void 0);var ze=class extends O{getSizeForViewScale(e){return ye([Be(e,this.values.first()),this.sizes.first()],[gt(e,this.values.last()),this.sizes.last()],[!0,()=>{let t=this.values.findIndex(u=>A(u,e)),i=this.values.get(t),r=t.subtract(1),o=this.values.get(r),l=e.subtract(o).divide(i.subtract(o));return J(this.sizes.get(r),this.sizes.get(t),l)}])}};n([c(ee.ofType(s,8))],ze.prototype,"sizes",void 0),n([c(ee.ofType(s,8))],ze.prototype,"values",void 0);var Te=class extends O{getSize(e,t){let i=ye([xe(e),t],[Be(e,this.values.first()),this.sizes.first()],[gt(e,this.values.last()),this.sizes.last()],[!0,()=>{let r=this.values.findIndex(f=>A(f,e)),o=this.values.get(r),l=r.subtract(1),u=this.values.get(l),p=e.subtract(u).divide(o.subtract(u));return J(this.sizes.get(l),this.sizes.get(r),p)}]);return D(xe(i),t,i)}};n([c(ee.ofType(s,8))],Te.prototype,"sizes",void 0),n([c(ee.ofType(s,8))],Te.prototype,"values",void 0);var Re=class extends O{getSize(e,t){return D(xe(e),t,e.multiply(this.unitValueToPixelsRatio))}};n([c(s)],Re.prototype,"unitValueToPixelsRatio",void 0);function ir(a){return a.visualVariableSizeMinMaxValue!=null||a.visualVariableSizeScaleStops!=null||a.visualVariableSizeStops!=null||a.visualVariableSizeUnitValue!=null}function nt(a,e,t){if(ir(a)){let i=a.storage.getSizeValue(e);return a.visualVariableSizeMinMaxValue?.getSize(i,t)??a.visualVariableSizeScaleStops?.getSizeForViewScale(a.view.currentScale)??a.visualVariableSizeStops?.getSize(i,t)??a.visualVariableSizeUnitValue?.getSize(i,t)}return t}function at(a,e,t,i=new At(!1)){if(a.visualVariableColor==null)return t;let r=a.storage.getColorValue(e);return a.visualVariableColor.getColor(r,t,i)}function rt(a,e){if(a.visualVariableOpacity==null)return new s(1);let t=a.storage.getOpacityValue(e);return a.visualVariableOpacity.getOpacity(t)}function ta(a,e){if(a.visualVariableRotation==null)return R.identity();let t=a.storage.getRotationValue(e);return a.visualVariableRotation.getVVRotationMat3(t)}function ws(a,e){if(a.visualVariableRotation==null)return new s(0);let t=a.storage.getRotationValue(e);return a.visualVariableRotation.getNormalizedAngle(t)}var li=class extends oe{};n([g(3,v)],li.prototype,"animationPointerAndBaseSizeAndReferenceSize",void 0),n([g(4,y)],li.prototype,"zoomRange",void 0);var ia=class extends ae{},Le=class extends te{_getScreenPosition(e){let{pos:t,translation:i,rotation:r,scale:o,offset:l,id:u,vvScale:p}=e,f=ws(this,u).multiply(Math.PI/180),d=i.x.multiply(4/3),h=i.y.multiply(-1).multiply(4/3),b=Ce(f),S=Ze(f),V=S.multiply(d).add(le(b).multiply(h)),T=b.multiply(d).add(S.multiply(h)),M=Ce(r.subtract(f)),P=Ze(r.subtract(f)),_=new s(0),Q=new s(1),{pixelRatio:ne}=this.animationInfo,N=new R(Q,_,_,_,Q,_,V.multiply(ne),T.multiply(ne),Q),W=new R(P,M.multiply(-1),_,M,P,_,0,0,Q),$=o.multiply(p).multiply(ne).multiply(4/3),Z=W.multiply($),I=this.animationInfo.toScreen.multiply(new z(t,1)),xi=N.multiply(I).xy,Xt=Z.multiply(new z(l,0)).xy;return xi.add(Xt)}_clip(e,t){let i=super.clip(e,t),r=Be(this._getLocalTimeOrigin(e),new s(0));return si.forceGlobalTimeOrigin||(i=i.add(ye([r,()=>new s(2)],[!0,()=>new s(0)]))),i}_getLocalTimeOrigin(e){return this.storage.getLocalTimeOrigin(e)}_toNdc(e){return this.animationInfo.toNdc.multiply(new z(e,1)).xy}_getEvalParams(e,t){let{globalTime:i,animationTextureSize:r,animationTexture:o}=this.animationInfo;return{globalTime:i,localTimeOrigin:this._getLocalTimeOrigin(e.id),animationTextureSize:r,animationTexture:o,pixelDimensions:t}}_getColor(e,t){return D(se(t.isSDF,new s(1)),this._getSDFColor(e,t),this._getSpriteColor(e,t))}_getSpriteColor(e,t){return E(this.mosaicInfo.texture,e).multiply(t.color)}_getSDFColor(e,t){let i=E(this.mosaicInfo.texture,e),r=new s(.5).subtract(St(i)).multiply(t.distanceToPx).multiply(ki),o=de(new s(.5).subtract(r),new s(0),new s(1)),l=t.color.multiply(o),u=t.outlineSize.multiply(.5),p=et(r).subtract(u),f=de(new s(.5).subtract(p),new s(0),new s(1)),d=t.outlineColor.multiply(f);return new s(1).subtract(d.a).multiply(l).add(d)}};function Ut(a,e,t){let i=a.add(new y(e,0)),r=E(t.animationTexture,i.add(.5).divide(t.animationTextureSize)).xy;return a=a.add(r),ps(m({animationPointer:a},t),v,null,o=>{let{out:l}=o;if(!l)throw new Error("out is null");return ts(x(m({},o),{out:l}))})}n([c(re)],Le.prototype,"mosaicInfo",void 0),n([c($e)],Le.prototype,"animationInfo",void 0),n([C(ve)],Le.prototype,"visualVariableColor",void 0),n([C(be)],Le.prototype,"visualVariableOpacity",void 0),n([C(Ae)],Le.prototype,"visualVariableSizeMinMaxValue",void 0),n([C(ze)],Le.prototype,"visualVariableSizeScaleStops",void 0),n([C(Te)],Le.prototype,"visualVariableSizeStops",void 0),n([C(Re)],Le.prototype,"visualVariableSizeUnitValue",void 0),n([C(ot)],Le.prototype,"visualVariableRotation",void 0);var lt;(function(a){a[a.transform=0]="transform",a[a.fromColor=1]="fromColor",a[a.toColor=2]="toColor",a[a.colorMix=3]="colorMix",a[a.toOpacity=4]="toOpacity",a[a.opacityMix=5]="opacityMix"})(lt||(lt={}));function qs(a,e){return Fe(a,fs(e))}function ui(a,e,t){let i=t.subtract(e),r=qs(a.subtract(e),i),o=de(r.divide(tt(i)),new s(0),new s(1));return Lt(a,e.add(o.multiply(t.subtract(e))))}function pe(a){let e=et(a);return j(e.x.add(e.y).add(e.z),new s(1.05))}function me(a,e,t,i){let r=new R(t.x.multiply(i.y).subtract(i.x.multiply(t.y)),i.x.multiply(e.y).subtract(e.x.multiply(i.y)),e.x.multiply(t.y).subtract(t.x.multiply(e.y)),t.y.subtract(i.y),i.y.subtract(e.y),e.y.subtract(t.y),i.x.subtract(t.x),e.x.subtract(i.x),t.x.subtract(e.x)),o=e.x.multiply(t.y.subtract(i.y)),l=t.x.multiply(i.y.subtract(e.y)),u=i.x.multiply(e.y.subtract(t.y)),p=o.add(l).add(u);return new s(1).divide(p).multiply(r.multiply(new z(1,a)))}function ks(a,e,t,i){return se(pe(me(a,e,t,i)),new s(1))}function Bt(a,e,t,i){let r=t.subtract(e),o=i.subtract(e),l=vs(r,o),u=Ya(ti(l,new s(Gr)),A(l,new s(-.05)));return ye([Ya(hs(u),ks(a.xy,e,t,i)),new s(-1)],[!0,()=>{let p=ui(a,e,t),f=ui(a,t,i),d=ui(a,i,e);return it(it(p,f),d)}])}function qe(a){return a.distance.add(1)}function pi(a,e,t){let{viewMat3:i,tileMat3:r}=a.view,o=i.multiply(r),l=o.multiply(new z(e.pos,1)),u=o.multiply(new z(t.nextPos1,1)),p=o.multiply(new z(t.nextPos2,1));return Bt(a.hittestRequest.position,l.xy,u.xy,p.xy)}function Fs(a,e,t){return Lt(a,t).subtract(e)}var qt=class extends li{};n([g(5,y)],qt.prototype,"offset",void 0),n([g(6,y)],qt.prototype,"uv",void 0),n([g(7,v)],qt.prototype,"sizing",void 0),n([g(8,s)],qt.prototype,"angle",void 0);var kt=class extends xt{};n([g(12,y)],kt.prototype,"offsetNextVertex1",void 0),n([g(13,y)],kt.prototype,"offsetNextVertex2",void 0),n([g(14,y)],kt.prototype,"textureUVNextVertex1",void 0),n([g(15,y)],kt.prototype,"textureUVNextVertex2",void 0);var ar=class extends ia{};function ut(a,e,t,i){return e.multiply(a.x).add(t.multiply(a.y)).add(i.multiply(a.z))}var mi=class extends Le{constructor(){super(...arguments),this.type="AnimatedMarkerShader",this.computeAttributes={offset:["offsetNextVertex1","offsetNextVertex2"],uv:["textureUVNextVertex1","textureUVNextVertex2"]}}_vertexPreamble(e){let{id:t,pos:i,offset:r,animationPointerAndBaseSizeAndReferenceSize:o,uv:l,sizing:u,angle:p}=e,f=o.xy,d=o.z,h=o.w,b=u.xy,S=u.z,V=H(e.bitset,Ue.bitset.isStroke),T=u.w,M=H(e.bitset,Ue.bitset.scaleSymbolsProportionally),P=this._getEvalParams(e,b),_=Ut(f,lt.transform,P),Q=ye([se(H(e.bitset,Ue.bitset.isMapAligned),new s(1)),this.view.rotation.divide(180).multiply(Math.PI)],[!0,new s(0)]),ne=new ns(Ze(Q),Ce(Q.multiply(-1)),Ce(Q),Ze(Q)).multiply(_.xy),N=_.z.subtract(Q).subtract(p.multiply(Qt)),W=_.w,$=H(e.bitset,Ue.bitset.isSDF),Z=nt(this,t,new s(h)).divide(new s(h));return{baseSize:d,animationPointer:f,strokeWidth:S,isOutline:V,unscaledDistanceToPx:T,scaleSymbolsProportionally:M,isSDF:$,position:this._getScreenPosition({id:t,pos:i,offset:r,referenceSize:h,translation:ne,rotation:N,scale:W,vvScale:Z}),uv:l,evalParams:P,vvScale:Z,scale:W}}vertex(e,t){let{position:i,animationPointer:r,evalParams:o,isOutline:l,unscaledDistanceToPx:u,vvScale:p,uv:f,strokeWidth:d,scaleSymbolsProportionally:h,scale:b,isSDF:S,baseSize:V}=this._vertexPreamble(e),T=this._toNdc(i),M=Ut(r,lt.fromColor,o);M=new v(M.rgb.multiply(M.a),M.a);let P=Ut(r,lt.toColor,o);P=new v(P.rgb.multiply(P.a),P.a);let _=Ut(r,lt.colorMix,o);_=new v(_.rgb.multiply(_.a),_.a);let Q=Ut(r,lt.toOpacity,o).a,ne=Ut(r,lt.opacityMix,o).a,N=at(this,e.id,M,ii(bt(e.bitset,Ue.bitset.colorLocked),new At(l))),W=J(N,P,_),$=rt(this,e.id),Z=J($,Q,ne),I=W.multiply(Z),xi=this.clip(e.id,e.zoomRange),Xt=u.multiply(p);return m({glPosition:new v(T,xi,1),uv:f.divide(this.mosaicInfo.size),color:I.multiply(new s(1).subtract(l)),outlineColor:I.multiply(l),distanceToPx:Xt,strokeWidth:d.multiply(J(new s(1),b,h)),isOutline:l,isSDF:S},this.maybeRunHittest(e,t,{pos:e.pos,size:V,sizeCorrection:new s(1),isMapAligned:new s(1),vvRotationMat3:new R(1,0,0,0,1,0,0,0,1),placementMat3:new R(1,0,0,0,1,0,0,0,1),outlineSize:new s(1),distanceToPx:Xt,isSDF:S}))}fragment(e){let t=this._getColor(e.uv,{color:e.color,distanceToPx:e.distanceToPx,isSDF:e.isSDF,outlineColor:e.outlineColor,outlineSize:e.strokeWidth});return si.spotlightAnimatedSymbols&&(t=t.add(new v(0,.3,0,.3))),this.getFragmentOutput(t,e)}hittest(e,t,i){return D(ti(i.size,this.hittestRequest.smallSymbolSizeThreshold),this._hittestSmallMarker(e,t,i),this._hittestMarker(e,t,i))}_hittestSmallMarker(e,t,i){let{position:r,distance:o,smallSymbolDistance:l}=this.hittestRequest,u=o.subtract(l),{viewMat3:p,tileMat3:f}=this.view,d=p.multiply(f).multiply(new z(i.pos,1)).xy,h=i.size.multiply(.5);return Lt(d,r).subtract(h).add(u)}_hittestMarker(e,t,i){let r=this._vertexPreamble(m({},e)).position,o=this._vertexPreamble(x(m({},e),{offset:t.offsetNextVertex1,uv:t.textureUVNextVertex1})).position,l=this._vertexPreamble(x(m({},e),{offset:t.offsetNextVertex2,uv:t.textureUVNextVertex2})).position,u=this.hittestRequest.position,p=this.hittestRequest.distance,f=Bt(u,r,o,l);return D(A(f,p),f,this._hittestSamples(r,o,l,e,t,i))}_hittestSamples(e,t,i,r,o,l){let{outlineSize:u,isSDF:p,distanceToPx:f}=l,d=this.hittestRequest.position,h=this.hittestRequest.distance,b=me(d.add(new y(le(h),le(h))),e,t,i),S=me(d.add(new y(0,le(h))),e,t,i),V=me(d.add(new y(h,le(h))),e,t,i),T=me(d.add(new y(le(h),0)),e,t,i),M=me(d,e,t,i),P=me(d.add(new y(h,0)),e,t,i),_=me(d.add(new y(le(h),h)),e,t,i),Q=me(d.add(new y(0,h)),e,t,i),ne=me(d.add(new y(h,h)),e,t,i),N=r.uv.divide(this.mosaicInfo.size),W=o.textureUVNextVertex1.divide(this.mosaicInfo.size),$=o.textureUVNextVertex2.divide(this.mosaicInfo.size),Z={color:new v(1,1,1,1),outlineSize:u,outlineColor:new v(1,1,1,1),isSDF:p,distanceToPx:f},I=new s(0);return I=I.add(pe(b).multiply(this._getColor(ut(b,N,W,$),Z).a)),I=I.add(pe(S).multiply(this._getColor(ut(S,N,W,$),Z).a)),I=I.add(pe(V).multiply(this._getColor(ut(V,N,W,$),Z).a)),I=I.add(pe(T).multiply(this._getColor(ut(T,N,W,$),Z).a)),I=I.add(pe(M).multiply(this._getColor(ut(M,N,W,$),Z).a)),I=I.add(pe(P).multiply(this._getColor(ut(P,N,W,$),Z).a)),I=I.add(pe(_).multiply(this._getColor(ut(_,N,W,$),Z).a)),I=I.add(pe(Q).multiply(this._getColor(ut(Q,N,W,$),Z).a)),I=I.add(pe(ne).multiply(this._getColor(ut(ne,N,W,$),Z).a)),j(I,new s(.05)).multiply(qe(this.hittestRequest))}};n([w(0,F(qt)),w(1,F(kt))],mi.prototype,"vertex",null),n([w(0,F(ar))],mi.prototype,"fragment",null);var B=class extends os{constructor(){super(...arguments),this.symbologyPlane=ce.FILL,this._input=null}};var aa=class extends B{render(e,t){let{context:i,painter:r}=e,{target:o}=t,{freezeGlobalTime:l}=si,u=0,p=r.textureManager.animationStore.getTexture(i,u),f=[2/e.state.size[0],0,0,0,-2/e.state.size[1],0,-1,1,1],d=Array.from(Or($a(),f)),h=Array.from(_r($a(),d,o.transforms.displayViewScreenMat3)),b=t.instance.getInput();r.setShader({shader:this.shaders.geometry,uniforms:x(m(m({},K(e,t.target,b.uniforms)),q(e,t.target)),{mosaicInfo:r.textureManager.getMosaicInfo(i,t.textureKey,!0),animationInfo:{globalTime:l===!1?e.time/1e3:l,animationTextureSize:[p.descriptor.width,p.descriptor.height],animationTexture:{unit:6,texture:p},toScreen:h,toNdc:f,mapRotation:e.state.rotation,pixelRatio:e.state.pixelRatio}}),defines:m({},U(e)),optionalAttributes:{zoomRange:!0},useComputeBuffer:!0}),r.setPipelineState(m({},G(e))),r.submitDraw(e,t),l===!1&&o.requestRender()}};var ra=class extends aa{constructor(){super(...arguments),this.type=k.AnimatedMarker,this.symbologyPlane=ce.MARKER,this.shaders={geometry:new mi}}};var sa=class extends ai{};n([g(0,y)],sa.prototype,"pos",void 0);var rr=class extends ae{},oa=class extends O{};n([c(s)],oa.prototype,"dotSize",void 0);var ci=class extends O{};n([c(X)],ci.prototype,"locations",void 0),n([c(s)],ci.prototype,"pixelRatio",void 0),n([c(s)],ci.prototype,"tileZoomFactor",void 0);var Hs=1e-6,pt=class extends ri{constructor(){super(...arguments),this.type="DotDensityPointShader"}vertex(e){let t=new R(1,0,0,0,-1,0,0,1,1).multiply(new z(e.pos.xy.divide(512),1)),i=E(this.draw.locations,t.xy),r=ue(this.instance.dotSize.divide(2),new s(1)),o=new s(0);o=o.add(j(i.a,new s(Hs)).multiply(2));let l=r.add(this.instance.dotSize),u=this.view.displayViewScreenMat3.multiply(new z(e.pos.add(.5),1)),p=new v(u.xy,o,1),f=this.instance.dotSize.divide(l),d=new s(-1).divide(r.divide(l));return l=l.multiply(this.draw.pixelRatio.multiply(this.draw.tileZoomFactor)),{glPosition:p,glPointSize:l,color:i,ratio:f,invEdgeRatio:d}}fragment(e){let t=tt(e.glPointCoord.subtract(.5)).multiply(2),i=$i(new s(0),new s(1),e.invEdgeRatio.multiply(t.subtract(e.ratio)).add(1)),r=new vt;return r.fragColor=e.color.multiply(i),r}};n([c(oa)],pt.prototype,"instance",void 0),n([c(ci)],pt.prototype,"draw",void 0),n([c(fe)],pt.prototype,"view",void 0),n([w(0,F(sa))],pt.prototype,"vertex",null),n([w(0,F(rr))],pt.prototype,"fragment",null);var na=class extends oe{};n([g(3,s)],na.prototype,"inverseArea",void 0);var di=class extends O{};n([c(ee.ofType(v,2))],di.prototype,"isActive",void 0),n([c(ee.ofType(v,8))],di.prototype,"colors",void 0),n([c(s)],di.prototype,"dotValue",void 0);var wt=class extends O{};n([c(X)],wt.prototype,"dotTexture0",void 0),n([c(X)],wt.prototype,"dotTexture1",void 0),n([c(s)],wt.prototype,"tileZoomFactor",void 0),n([c(s)],wt.prototype,"pixelRatio",void 0),n([c(s)],wt.prototype,"tileDotsOverArea",void 0);var mt=class extends te{constructor(){super(...arguments),this.type="DotDensityPolygonShader"}_dotThreshold(e,t,i){return e.divide(t).divide(i)}vertex(e){let t=new R(2/512,0,0,0,-2/512,0,-1,1,1).multiply(new z(e.pos,1)),i=this.clip(e.id),r=new v(t.xy,i,1),o=this.storage.getVVData(e.id).multiply(this.instance.isActive.get(0)).multiply(e.inverseArea),l=this.storage.getDataDrivenData0(e.id).multiply(this.instance.isActive.get(1)).multiply(e.inverseArea),u=this.draw.tileZoomFactor.multiply(512).divide(this.draw.pixelRatio),p=this._dotThreshold(o,this.instance.dotValue,this.draw.tileDotsOverArea),f=this._dotThreshold(l,this.instance.dotValue,this.draw.tileDotsOverArea),d=e.pos.add(.5).divide(u);return{glPosition:r,color:new v(0,0,0,0),textureCoords:d,thresholds0:p,thresholds1:f}}fragment(e){let t=new vt,i=E(this.draw.dotTexture0,e.textureCoords),r=E(this.draw.dotTexture1,e.textureCoords),o=e.thresholds0.subtract(i),l=e.thresholds1.subtract(r),u,p=ei.fromColumns(this.instance.colors[0],this.instance.colors[1],this.instance.colors[2],this.instance.colors[3]),f=ei.fromColumns(this.instance.colors[4],this.instance.colors[5],this.instance.colors[6],this.instance.colors[7]);if(this.blending){let d=j(new s(0),o),h=j(new s(0),l),b=Fe(d,o).add(Fe(h,l)),S=j(b,new s(0)),V=new s(1).subtract(S),T=b.add(S),M=o.multiply(d).divide(T),P=l.multiply(h).divide(T),_=p.multiply(M).add(f.multiply(P));u=V.multiply(_)}else{let d=ue(tr(o),tr(l)),h=j(d,new s(0)),b=new s(1).subtract(h),S=j(d,o),V=j(d,l),T=p.multiply(S).add(f.multiply(V));u=b.multiply(T)}return t.fragColor=u,t}hittest(e){return qe(this.hittestRequest)}};n([Oe],mt.prototype,"blending",void 0),n([c(di)],mt.prototype,"instance",void 0),n([c(wt)],mt.prototype,"draw",void 0),n([w(0,F(na))],mt.prototype,"vertex",null),n([w(0,F(ae))],mt.prototype,"fragment",null);var Ns={pos:{count:2,type:Ie.UNSIGNED_SHORT}},la=class{constructor(){this._dotTextureSize=0,this._dotTextures=null,this._dotMesh=null}destroy(){this._disposeTextures(),this._dotFBO&&this._dotFBO.dispose(),this._dotMesh&&this._dotMesh.destroy()}getFBO(e){if(this._dotFBO==null){let t=512,i=512,r=new Yt(t,i);r.samplingMode=vi.NEAREST,r.wrapMode=bi.CLAMP_TO_EDGE;let o=new rs(e,new Gi(Ui.DEPTH_STENCIL,t,i));this._dotFBO=new ji(e,r,o)}return this._dotFBO}getDotDensityMesh(e){if(this._dotMesh==null){let t=512,i=t*t,r=2,o=new Int16Array(i*r);for(let l=0;l<t;l++)for(let u=0;u<t;u++)o[r*(u+l*t)]=u,o[r*(u+l*t)+1]=l;this._dotMesh=Ji.create(e,{primitive:Li.POINTS,vertex:o,count:i,layout:Ns})}return this._dotMesh}getDotDensityTextures(e,t,i){if(this._dotTextureSize===t&&this._seed===i||(this._disposeTextures(),this._dotTextureSize=t,this._seed=i),this._dotTextures===null){let r=new wr(i);this._dotTextures=[this._allocDotDensityTexture(e,t,r),this._allocDotDensityTexture(e,t,r)]}return this._dotTextures}_disposeTextures(){if(this._dotTextures){for(let e=0;e<this._dotTextures.length;e++)this._dotTextures[e].dispose();this._dotTextures=null}}_allocDotDensityTexture(e,t,i){let r=new Float32Array(t*t*4);for(let l=0;l<r.length;l++)r[l]=i.getFloat();let o=new Yt;return o.dataType=Ei.FLOAT,o.samplingMode=vi.NEAREST,o.width=t,o.height=t,new Ni(e,o,r)}};var Xe=class extends oe{};n([g(3,v)],Xe.prototype,"color",void 0),n([g(4,y)],Xe.prototype,"zoomRange",void 0);var Ve=class extends te{constructor(){super(...arguments),this.type="FillShader",this.computeAttributes={pos:["nextPos1","nextPos2"]}}vertex(e,t){let i=rt(this,e.id),r=at(this,e.id,e.color).multiply(i),o=this.view.displayViewScreenMat3.multiply(new z(e.pos.xy,1)),l=this.clip(e.id,e.zoomRange);return m({glPosition:new v(o.xy,l,1),color:r},this.maybeRunHittest(e,t,null))}fragment(e){return this.getFragmentOutput(e.color,e,new s(0))}hittest(e,t){return pi(this,e,t)}};n([C(ve)],Ve.prototype,"visualVariableColor",void 0),n([C(be)],Ve.prototype,"visualVariableOpacity",void 0),n([w(0,F(Xe)),w(1,F(ie))],Ve.prototype,"vertex",null),n([w(0,F(ae))],Ve.prototype,"fragment",null);var ua=class extends B{constructor(){super(...arguments),this.type=k.DotDensity,this.shaders={polygon:new mt,point:new pt,fill:new Ve},this._resources=new Map}render(e,t){Wi(e)||L(e)?this._renderPolygons(e,t):this._renderDotDensity(e,t)}_renderPolygons(e,t){let{painter:i}=e;i.setShader({shader:this.shaders.fill,uniforms:x(m({},q(e,t.target)),{visualVariableColor:null,visualVariableOpacity:null}),defines:m({},U(e)),optionalAttributes:{zoomRange:!1},useComputeBuffer:L(e)}),i.setPipelineState(G(e)),i.submitDraw(e,t)}_renderDotDensity(e,t){let{context:i,painter:r,requiredLevel:o}=e,l=t.instance.getInput().uniforms,u=this._getOrCreateResourcesRecord(i),p=u.getDotDensityTextures(i,512,l.seed),f=1/2**(o-t.target.key.level),d=512,h=d*window.devicePixelRatio*d*window.devicePixelRatio,b=1/f*(1/f),S=l.dotScale?e.state.scale/l.dotScale:1,V=l.dotValue*S*b;r.setShader({shader:this.shaders.polygon,uniforms:x(m({},q(e,t.target)),{instance:{isActive:l.isActive,colors:l.colors,dotValue:Math.max(1,V)},draw:{dotTexture0:{unit:ka,texture:p[0]},dotTexture1:{unit:Lr,texture:p[1]},tileZoomFactor:f,pixelRatio:window.devicePixelRatio,tileDotsOverArea:h/(512*window.devicePixelRatio*512*window.devicePixelRatio)}}),defines:x(m({},U(e)),{blending:l.blending}),optionalAttributes:{},useComputeBuffer:!1});let T=i.getViewport();i.setViewport(0,0,512,512);let M=i.getBoundFramebufferObject(),P=u.getFBO(i);i.bindFramebuffer(P),i.setClearColor(0,0,0,0),i.clear(Ot.COLOR),r.setPipelineState({color:{write:[!0,!0,!0,!0],blendMode:"composite"},depth:!1,stencil:!1}),r.updatePipelineState(i),r.submitDraw(e,t),i.bindFramebuffer(M),i.setViewport(T.x,T.y,T.width,T.height);let _=u.getFBO(i).colorTexture,Q={shader:this.shaders.point,uniforms:{view:ss(e,t.target),instance:{dotSize:l.dotSize},draw:{locations:{unit:ka,texture:_},tileZoomFactor:1,pixelRatio:window.devicePixelRatio}},defines:m({},U(e)),optionalAttributes:{},useComputeBuffer:!1};r.setPipelineState(G(e)),r.submitDrawMesh(i,Q,u.getDotDensityMesh(i))}shutdown(e){super.shutdown(e),this._resources.get(e)?.destroy(),this._resources.delete(e)}_getOrCreateResourcesRecord(e){let t=this._resources.get(e);return t==null&&(t=new la,this._resources.set(e,t)),t}};var ke=class extends O{getPatternOffsetAtTileOrigin(e,t=new s(0),i=new s(1)){let r=new y(Yr).divide(e),o=e.multiply(Et(this.maxIntsToLocalOrigin.multiply(r))).add(this.tileOffsetFromLocalOrigin).subtract(new s(.5).multiply(e));return o=new y(o.x.multiply(i).subtract(o.y.multiply(t)),o.x.multiply(t).add(o.y.multiply(i))),Ke(o,e)}};n([c(y)],ke.prototype,"tileOffsetFromLocalOrigin",void 0),n([c(y)],ke.prototype,"maxIntsToLocalOrigin",void 0);var ct=class extends Xe{};n([g(5,v)],ct.prototype,"tlbr",void 0),n([g(6,s)],ct.prototype,"width",void 0),n([g(7,s)],ct.prototype,"height",void 0),n([g(8,y)],ct.prototype,"offset",void 0),n([g(9,y)],ct.prototype,"scale",void 0),n([g(10,s)],ct.prototype,"angle",void 0);var sr=class extends ae{};function Gs(a,e,t,i,r){let o=se(H(r,Zr),Y(1)),l=St(new v(a,0));return D(o,Qa(i.divide(e.x),t.divide(e.y),0,le(t.divide(e.x)),i.divide(e.y),0,er(Fi(l,0)),er(Fi(0,l)),1),Qa(i.divide(e.x),t.divide(e.y),0,le(t.divide(e.x)),i.divide(e.y),0,0,0,1))}function or(a,e){let t=a.view.requiredZoomFactor,i=new y(e.width,e.height),r=i.multiply(e.scale).multiply(t),o=e.angle.multiply(Qt),l=Ce(o),u=Ze(o),p=Gs(e.id,r,l,u,e.bitset),f=a.localTileOffset.getPatternOffsetAtTileOrigin(i,l,u),d=t.multiply(e.scale).multiply(e.offset.subtract(f)).divide(r),h=new z(e.pos,1),b=p.multiply(h).xy.subtract(d),S=e.tlbr.divide(a.mosaicInfo.size.xyxy),V=H(e.bitset,Hi);return a.visualVariableColor!=null&&(V=D(xe(a.storage.getColorValue(e.id)),new s(0),V)),{tileTextureCoord:b,tlbr:S,sampleAlphaOnly:V}}function nr(a,e){let t=Ke(e.tileTextureCoord,new s(1)),i=J(e.tlbr.xy,e.tlbr.zw,t),r=E(a.mosaicInfo.texture,i);return r=D(A(e.sampleAlphaOnly,new s(.5)),r.aaaa,r),e.color.multiply(r)}var Ft=class extends Ve{constructor(){super(...arguments),this.type="ComplexFillShader"}vertex(e,t){return m(m({},super.vertex(e,t)),or(this,e))}fragment(e){let t=nr(this,e);return this.getFragmentOutput(t,e,new s(0))}};n([c(re)],Ft.prototype,"mosaicInfo",void 0),n([c(ke)],Ft.prototype,"localTileOffset",void 0),n([w(0,F(ct)),w(1,F(ie))],Ft.prototype,"vertex",null),n([w(0,F(sr))],Ft.prototype,"fragment",null);var pa=class extends B{constructor(){super(...arguments),this.type=k.ComplexFill,this.shaders={geometry:new Ft}}render(e,t){let{context:i,painter:r}=e,o=t.instance.getInput();r.setShader({shader:this.shaders.geometry,uniforms:x(m(m({},K(e,t.target,o.uniforms)),q(e,t.target)),{mosaicInfo:r.textureManager.getMosaicInfo(i,t.textureKey),localTileOffset:yt(t.target)}),defines:m({},U(e)),optionalAttributes:o.optionalAttributes,useComputeBuffer:L(e)}),r.setPipelineState(G(e)),r.submitDraw(e,t)}};function He(a){let e=1/a;return{antialiasing:e,blur:0+e}}var Ee=class extends oe{};n([g(3,v)],Ee.prototype,"color",void 0),n([g(4,y)],Ee.prototype,"offset",void 0),n([g(5,y)],Ee.prototype,"normal",void 0),n([g(6,s)],Ee.prototype,"halfWidth",void 0),n([g(7,s)],Ee.prototype,"referenceHalfWidth",void 0),n([g(8,y)],Ee.prototype,"zoomRange",void 0);var Ht=class extends ae{},Nt=class extends O{};function zs(a){return ue(new s(kr).multiply(j(a,new s(Hr))),new s(1))}function Ti(a,e){let{halfWidth:t,normal:i}=a,r=zs(t),o=tt(i).multiply(t);return de(r.multiply(t.subtract(o)).divide(e.add(r).subtract(new s(1))),new s(0),new s(1))}function js(a,e){let{id:t,halfWidth:i,referenceHalfWidth:r}=e;if(ir(a)){let o=new s(2).multiply(r),l=nt(a,t,o);return new s(.5).multiply(i.divide(ue(r,new s(Nr)))).multiply(l)}return i}function Gt(a,e){let{id:t,offset:i,pos:r,normal:o,zoomRange:l}=e,{displayViewScreenMat3:u,displayViewMat3:p}=a.view,f=at(a,t,e.color),d=rt(a,t),h=js(a,e),b=new s(.5).multiply(a.antialiasingControls.antialiasing),S=ue(h.add(b),new s(.45)).add(new s(.1).multiply(b)),V=zs(S).multiply(S).multiply(i),T=p.multiply(new z(V,new s(0))),M=u.multiply(new z(r,new s(1))).add(T),P=new s(2).multiply(j(h,new s(0))).add(a.clip(t,l)),_=new v(M.xy,P,1);return{color:f,opacity:d,halfWidth:S,normal:o,scaledOffset:V,scaledHalfWidth:h,glPosition:new v(_.xy,P,1)}}function jt(a,e){let{opacity:t,color:i}=a,r=Ti(a,e);return t.multiply(i).multiply(r)}n([c(s)],Nt.prototype,"antialiasing",void 0),n([c(s)],Nt.prototype,"blur",void 0);var ge=class extends te{constructor(){super(...arguments),this.type="LineShader",this.computeAttributes={pos:["nextPos1","nextPos2"]}}vertex(e,t){let i=Gt(this,e);return m(m({},i),this.maybeRunHittest(e,t,i.halfWidth))}fragment(e){let t=jt(e,this.antialiasingControls.blur);return this.getFragmentOutput(t,e)}hittest(e,t,i){let{viewMat3:r,tileMat3:o}=this.view,l=r.multiply(o),u=l.multiply(new z(e.pos,1)),p=l.multiply(new z(t.nextPos1,1)),f=l.multiply(new z(t.nextPos2,1)),{distance:d,smallSymbolDistance:h,smallSymbolSizeThreshold:b}=this.hittestRequest,S=j(i,b.multiply(.5)).multiply(d.subtract(h)),V=this.hittestRequest.position;return it(ui(V,u.xy,p.xy),ui(V,u.xy,f.xy)).subtract(i).add(S)}};n([c(Nt)],ge.prototype,"antialiasingControls",void 0),n([C(ve)],ge.prototype,"visualVariableColor",void 0),n([C(be)],ge.prototype,"visualVariableOpacity",void 0),n([C(Ae)],ge.prototype,"visualVariableSizeMinMaxValue",void 0),n([C(ze)],ge.prototype,"visualVariableSizeScaleStops",void 0),n([C(Te)],ge.prototype,"visualVariableSizeStops",void 0),n([C(Re)],ge.prototype,"visualVariableSizeUnitValue",void 0),n([w(0,F(Ee)),w(1,F(ie))],ge.prototype,"vertex",null),n([w(0,F(Ht))],ge.prototype,"fragment",null);var Qe=class extends oe{};n([g(3,y)],Qe.prototype,"offset",void 0),n([g(4,v)],Qe.prototype,"color",void 0),n([g(5,y)],Qe.prototype,"normal",void 0),n([g(6,s)],Qe.prototype,"halfWidth",void 0),n([g(7,s)],Qe.prototype,"referenceHalfWidth",void 0),n([g(8,y)],Qe.prototype,"zoomRange",void 0);var Mi=class extends Ht{};function Pi(a,e,t){let{id:i,bitset:r}=e,o=H(r,Wr),l=A(o,new s(.5)),u=Gt(a,e),p=D(l,u.halfWidth,new s(0)),f=rt(a,i),d=at(a,i,e.color),h=D(l,e.color,d.multiply(f)),b=a.view.displayViewScreenMat3.multiply(new z(e.pos.xy,1)),S=a.clip(e.id),V=new v(b.xy,S,1),T=D(l,u.glPosition,V),M=t&&a.maybeRunHittest(e,t,l);return m({isOutline:o,color:h,opacity:new s(1),halfWidth:p,normal:u.normal,glPosition:T},M)}var Ne=class extends te{constructor(){super(...arguments),this.computeAttributes={pos:["nextPos1","nextPos2"]}}};n([c(Nt)],Ne.prototype,"antialiasingControls",void 0),n([C(ve)],Ne.prototype,"visualVariableColor",void 0),n([C(be)],Ne.prototype,"visualVariableOpacity",void 0),n([C(Ae)],Ne.prototype,"visualVariableSizeMinMaxValue",void 0),n([C(ze)],Ne.prototype,"visualVariableSizeScaleStops",void 0),n([C(Te)],Ne.prototype,"visualVariableSizeStops",void 0),n([C(Re)],Ne.prototype,"visualVariableSizeUnitValue",void 0);var zt=class extends Ne{constructor(){super(...arguments),this.type="OutlineFillShader"}vertex(e,t){return Pi(this,e,t)}fragment(e){let{color:t,isOutline:i}=e,r=A(i,new s(.5)),o=jt(e,this.antialiasingControls.blur),l=D(r,o,t),u=D(r,new s(1/255),new s(0));return this.getFragmentOutput(l,e,u)}hittest(e,t,i){return D(i,qe(this.hittestRequest),pi(this,e,t))}};n([w(0,F(Qe)),w(1,F(ie))],zt.prototype,"vertex",null),n([w(0,F(Mi))],zt.prototype,"fragment",null);var Di=class extends Xe{};n([g(5,v)],Di.prototype,"tlbr",void 0),n([g(6,s)],Di.prototype,"inverseRasterizationScale",void 0);var lr=class extends ae{};function Ws(a){let e=new s(1),t=new s(0);return new R(e.divide(a.x),t.divide(a.y),0,le(t.divide(a.x)),e.divide(a.y),0,0,0,1)}function ur(a,e){let t=e.tlbr.xy,i=e.tlbr.zw,r=i.x.subtract(t.x),o=t.y.subtract(i.y),l=new y(r,o).multiply(e.inverseRasterizationScale),u=l.multiply(a.view.requiredZoomFactor),p=Ws(u),f=a.localTileOffset.getPatternOffsetAtTileOrigin(l).divide(u),d=new z(e.pos,1);return{tileTextureCoord:p.multiply(d).xy.subtract(f),tlbr:e.tlbr.divide(a.mosaicInfo.size.xyxy)}}function pr(a,e){let t=Ke(a.tileTextureCoord,new s(1)),i=J(a.tlbr.xy,a.tlbr.zw,t),r=E(e.texture,i);return a.color.multiply(r)}var Tt=class extends Ve{constructor(){super(...arguments),this.type="PatternFillShader"}vertex(e,t){return m(m({},super.vertex(e,t)),ur(this,e))}fragment(e){let t=pr(e,this.mosaicInfo);return this.getFragmentOutput(t,e,new s(0))}};n([c(re)],Tt.prototype,"mosaicInfo",void 0),n([c(ke)],Tt.prototype,"localTileOffset",void 0),n([w(0,F(Di)),w(1,F(ie))],Tt.prototype,"vertex",null),n([w(0,F(lr))],Tt.prototype,"fragment",null);var Ii=class extends Qe{};n([g(9,v)],Ii.prototype,"tlbr",void 0),n([g(10,s)],Ii.prototype,"inverseRasterizationScale",void 0);var Ci=class extends Mi{},Mt=class extends zt{constructor(){super(...arguments),this.type="PatternOutlineFillShader"}vertex(e,t){return m(m({},Pi(this,e,t)),ur(this,e))}fragment(e){let{isOutline:t}=e,i=A(t,new s(.5)),r=jt(e,this.antialiasingControls.blur),o=pr(e,this.mosaicInfo),l=D(i,r,o),u=D(i,new s(1/255),new s(0));return this.getFragmentOutput(l,e,u)}};n([c(re)],Mt.prototype,"mosaicInfo",void 0),n([c(ke)],Mt.prototype,"localTileOffset",void 0),n([w(0,F(Ii)),w(1,F(ie))],Mt.prototype,"vertex",null),n([w(0,F(Ci))],Mt.prototype,"fragment",null);var Ts=1/Jr,Ye=class extends oe{};n([g(3,v)],Ye.prototype,"color",void 0),n([g(4,v)],Ye.prototype,"tlbr",void 0),n([g(5,s)],Ye.prototype,"angle",void 0),n([g(6,s)],Ye.prototype,"aux1",void 0),n([g(7,s)],Ye.prototype,"aux2",void 0),n([g(8,y)],Ye.prototype,"aux3",void 0),n([g(9,y)],Ye.prototype,"aux4",void 0),n([g(10,y)],Ye.prototype,"zoomRange",void 0);var mr=class extends Ci{},Pt=class extends Ne{constructor(){super(...arguments),this.type="ComplexOutlineFillShader"}vertex(e,t){let{aux1:i,aux2:r,aux3:o,aux4:l}=e,u=x(m({},e),{width:i,height:r,offset:o,scale:l.multiply(Ts)}),p=x(m({},e),{halfWidth:i,referenceHalfWidth:r,offset:o,normal:l.subtract(es).multiply(Ts)}),f=Pi(this,p),d=or(this,u),h=A(f.isOutline,new s(.5));return m(m(m({},f),d),this.maybeRunHittest(e,t,h))}fragment(e){let{isOutline:t}=e,i=A(t,new s(.5)),r=jt(e,this.antialiasingControls.blur),o=nr(this,e),l=D(i,r,o),u=D(i,new s(1/255),new s(0));return this.getFragmentOutput(l,e,u)}hittest(e,t,i){return D(i,qe(this.hittestRequest),pi(this,e,t))}};n([c(re)],Pt.prototype,"mosaicInfo",void 0),n([c(ke)],Pt.prototype,"localTileOffset",void 0),n([w(0,F(Ye)),w(1,F(ie))],Pt.prototype,"vertex",null),n([w(0,F(mr))],Pt.prototype,"fragment",null);var ma=class extends B{constructor(){super(...arguments),this.type=k.ComplexOutlineFill,this.shaders={geometry:new Pt}}render(e,t){let{context:i,painter:r,pixelRatio:o}=e,l=t.instance.getInput();r.setShader({shader:this.shaders.geometry,uniforms:x(m(m({},K(e,t.target,l.uniforms)),q(e,t.target)),{antialiasingControls:He(o),mosaicInfo:r.textureManager.getMosaicInfo(i,t.textureKey),localTileOffset:yt(t.target)}),defines:m({},U(e)),optionalAttributes:l.optionalAttributes,useComputeBuffer:L(e)}),r.setPipelineState(G(e)),r.submitDraw(e,t)}};var ca=class extends B{constructor(){super(...arguments),this.type=k.Fill,this.shaders={geometry:new Ve}}render(e,t){let{painter:i}=e,r=t.instance.getInput();i.setShader({shader:this.shaders.geometry,uniforms:m(m({},K(e,t.target,r.uniforms)),q(e,t.target)),defines:U(e),optionalAttributes:r.optionalAttributes,useComputeBuffer:L(e)}),i.setPipelineState(G(e)),i.submitDraw(e,t)}};var Wt=class extends Xe{};n([g(5,v)],Wt.prototype,"tlbr",void 0),n([g(6,y)],Wt.prototype,"relativePosition",void 0),n([g(7,s)],Wt.prototype,"gradientMethod",void 0),n([g(8,y)],Wt.prototype,"relativeGradientSize",void 0);var cr=class extends ae{},Zt=class extends Ve{constructor(){super(...arguments),this.type="GradientFillShader"}vertex(e,t){let{tlbr:i,relativePosition:r,gradientMethod:o,relativeGradientSize:l}=e,u=D(bt(e.bitset,Za.isAbsolute),this.view.displayZoomFactor,new s(1));return x(m({},super.vertex(e,t)),{tlbr:i,relativePosition:r,gradientMethod:o,gradientSize:l.multiply(u),isDiscrete:H(e.bitset,Za.isDiscrete)})}fragment(e){let{tlbr:t,relativePosition:i,gradientMethod:r,gradientSize:o,isDiscrete:l}=e,u=D(A(l,new s(.5)),o.subtract(1),new y(0)),p=ye([se(r,new s(Wa.rectangular)),()=>{let S=et(i).add(u).divide(o);return oi(ue(S.x,S.y))}],[se(r,new s(Wa.circular)),oi(Xi(Fe(i,i)).add(u.x).divide(o.x))],[!0,oi(i.x.add(u.x).divide(o.x))]),f=new y(de(p,new s(0),new s(1)),.5),d=J(t.xy,t.zw,f).divide(this.mosaicInfo.size),h=E(this.mosaicInfo.texture,d),b=e.color.a;return this.getFragmentOutput(h.multiply(b),e,new s(0))}};n([c(re)],Zt.prototype,"mosaicInfo",void 0),n([w(0,F(Wt)),w(1,F(ie))],Zt.prototype,"vertex",null),n([w(0,F(cr))],Zt.prototype,"fragment",null);var da=class extends B{constructor(){super(...arguments),this.type=k.GradientFill,this.shaders={geometry:new Zt},this.symbologyPlane=ce.FILL}render(e,t){let{context:i,painter:r}=e,o=t.instance.getInput();r.setShader({shader:this.shaders.geometry,uniforms:x(m(m({},K(e,t.target,o.uniforms)),q(e,t.target)),{mosaicInfo:r.textureManager.getMosaicInfo(i,t.textureKey)}),defines:m({},U(e)),optionalAttributes:o.optionalAttributes,useComputeBuffer:L(e)}),r.setPipelineState(G(e)),r.submitDraw(e,t)}};var fa=class extends B{constructor(){super(...arguments),this.type=k.OutlineFill,this.shaders={geometry:new zt}}render(e,t){let{painter:i,pixelRatio:r}=e,o=t.instance.getInput();i.setShader({shader:this.shaders.geometry,uniforms:x(m(m({},K(e,t.target,o.uniforms)),q(e,t.target)),{antialiasingControls:He(r)}),defines:m({},U(e)),optionalAttributes:o.optionalAttributes,useComputeBuffer:L(e)}),i.setPipelineState(G(e)),i.submitDraw(e,t)}};var ha=class extends B{constructor(){super(...arguments),this.type=k.PatternFill,this.shaders={geometry:new Tt}}render(e,t){let{context:i,painter:r}=e,o=t.instance.getInput();r.setShader({shader:this.shaders.geometry,uniforms:x(m(m({},K(e,t.target,o.uniforms)),q(e,t.target)),{mosaicInfo:r.textureManager.getMosaicInfo(i,t.textureKey),localTileOffset:yt(t.target)}),defines:m({},U(e)),optionalAttributes:o.optionalAttributes,useComputeBuffer:L(e)}),r.setPipelineState(G(e)),r.submitDraw(e,t)}};var ya=class extends B{constructor(){super(...arguments),this.type=k.PatternOutlineFill,this.shaders={geometry:new Mt}}render(e,t){let{context:i,painter:r,pixelRatio:o}=e,l=t.instance.getInput();r.setShader({shader:this.shaders.geometry,uniforms:x(m(m({},K(e,t.target,l.uniforms)),q(e,t.target)),{antialiasingControls:He(o),mosaicInfo:r.textureManager.getMosaicInfo(i,t.textureKey),localTileOffset:yt(t.target)}),defines:m({},U(e)),optionalAttributes:l.optionalAttributes,useComputeBuffer:L(e)}),r.setPipelineState(G(e)),r.submitDraw(e,t)}};var Zs=()=>Ri.getLogger("esri.views.2d.engine.webgl.shaderGraph.techniques.heatmap.HeatmapResources"),ga=class{destroy(){this._accumulateFramebuffer=Ua(this._accumulateFramebuffer),this._resolveGradientTexture=Ua(this._resolveGradientTexture),this._prevGradientHash=null,this._qualityProfile=null}get initialized(){return this._accumulateFramebuffer!=null&&this._resolveGradientTexture!=null}get accumulateFramebuffer(){return this._accumulateFramebuffer}get resolveGradientTexture(){return this._resolveGradientTexture}loadQualityProfile(e){if(this._qualityProfile==null){let t=xs(e,Zs());this._qualityProfile=x(m({},t),{defines:{usesHalfFloatPrecision:t.dataType!==Ei.FLOAT}})}return this._qualityProfile}ensureAccumulateFBO(e,t,i){if(this._accumulateFramebuffer==null){let{dataType:r,samplingMode:o,pixelFormat:l,internalFormat:u}=this.loadQualityProfile(e),p=new Yt(t,i);p.pixelFormat=l,p.internalFormat=u,p.dataType=r,p.samplingMode=o,p.wrapMode=bi.CLAMP_TO_EDGE;let f=new Gi(Ui.DEPTH_STENCIL,t,i);this._accumulateFramebuffer=new ji(e,p,f)}else{let{width:r,height:o}=this._accumulateFramebuffer;r===t&&o===i||this._accumulateFramebuffer.resize(t,i)}return this._accumulateFramebuffer}ensureResolveGradientTexture(e,t,i){if(this._resolveGradientTexture==null){let r=new Yt;r.wrapMode=bi.CLAMP_TO_EDGE,this._resolveGradientTexture=new Ni(e,r),this._prevGradientHash=null}return this._prevGradientHash!==t&&(this._resolveGradientTexture.resize(i.length/4,1),this._resolveGradientTexture.setData(i),this._prevGradientHash=t),this._resolveGradientTexture}};function xa(a){return a?.25:1}var va=class extends oe{};n([g(5,y)],va.prototype,"offset",void 0);var dr=class extends ae{},Oi=class extends O{};n([c(s)],Oi.prototype,"radius",void 0),n([c(s)],Oi.prototype,"isFieldActive",void 0);var Dt=class extends te{constructor(){super(...arguments),this.type="HeatmapAccumulateShader",this.usesHalfFloatPrecision=!1}vertex(e){let{radius:t,isFieldActive:i}=this.kernelControls,r=e.offset,o=i.multiply(this.storage.getVVData(e.id).x).add(new s(1).subtract(i)),l=this.view.displayViewScreenMat3.multiply(new z(e.pos,1)).add(this.view.displayViewMat3.multiply(new z(r,0)).multiply(t)),u=this.clip(e.id);return m({glPosition:new v(l.xy,u,1),offset:r,fieldValue:o,color:new v(0)},this.maybeRunHittest(e,{},null))}fragment(e){let{offset:t,fieldValue:i}=e,r=tt(t),o=j(r,new s(1)),l=new s(1).subtract(r.multiply(r)),u=l.multiply(l),p=o.multiply(u).multiply(i).multiply(new s(xa(this.usesHalfFloatPrecision)));return this.getFragmentOutput(new v(p),e)}hittest(e){let{viewMat3:t,tileMat3:i}=this.view,r=t.multiply(i).multiply(new z(e.pos,1));return Fs(r.xy,this.kernelControls.radius,this.hittestRequest.position)}};n([Oe],Dt.prototype,"usesHalfFloatPrecision",void 0),n([c(Oi)],Dt.prototype,"kernelControls",void 0),n([w(0,F(va))],Dt.prototype,"vertex",null),n([w(0,F(dr))],Dt.prototype,"fragment",null);var ba=class extends ai{};n([g(0,y)],ba.prototype,"position",void 0);var fr=class extends Qi{},fi=class extends O{};n([c(X)],fi.prototype,"texture",void 0),n([c(y)],fi.prototype,"minAndInvRange",void 0),n([c(s)],fi.prototype,"normalization",void 0);var Sa=class extends O{};n([c(X)],Sa.prototype,"texture",void 0);var dt=class extends ri{constructor(){super(...arguments),this.type="HeatmapResolveShader",this.usesHalfFloatPrecision=!1}vertex(e){return{glPosition:new v(e.position.multiply(2).subtract(1),1,1),uv:e.position}}fragment(e){let{accumulatedDensity:t,gradient:i}=this,r=E(t.texture,e.uv).r.divide(new s(xa(this.usesHalfFloatPrecision)));r=r.multiply(t.normalization),r=r.subtract(t.minAndInvRange.x).multiply(t.minAndInvRange.y);let o=E(i.texture,new y(r,.5)),l=new vt;return l.fragColor=new v(o.rgb.multiply(o.a),o.a),l}};n([Oe],dt.prototype,"usesHalfFloatPrecision",void 0),n([c(fi)],dt.prototype,"accumulatedDensity",void 0),n([c(Sa)],dt.prototype,"gradient",void 0),n([w(0,F(ba))],dt.prototype,"vertex",null),n([w(0,F(fr))],dt.prototype,"fragment",null);var Va=class extends B{constructor(){super(...arguments),this.type=k.Heatmap,this.drawPhase=ht.MAP|ht.HITTEST|ht.DEBUG,this.shaders={accumulate:new Dt,resolve:new dt},this._isBound=!1,this._resources=new Map}shutdown(e){super.shutdown(e),this._resources.get(e)?.destroy(),this._resources.delete(e),this._prevFBO=null,this._unbind()}render(e,t){let{context:i,painter:r,state:o}=e,l=t.instance.getInput(),{isFieldActive:u}=l.uniforms,p=this._getOrCreateResourcesRecord(i),f=p.loadQualityProfile(i);L(e)||this._bind(e,p,l),r.setShader({shader:this.shaders.accumulate,uniforms:x(m({},q(e,t.target)),{kernelControls:{radius:Ms(l,o),isFieldActive:u?1:0}}),defines:m(m({},U(e)),f.defines),optionalAttributes:{},useComputeBuffer:L(e)});let d=L(e)?$s:Ds;r.setPipelineState(d),r.submitDraw(e,t)}getStencilReference(e){return Ps(e)}renderResolvePass(e,t){if(L(e))return;let{context:i,painter:r}=e,o=this._resources.get(i);if(this._prevFBO==null||this._prevViewport==null||!o?.initialized)return;let{defines:l}=o.loadQualityProfile(i),{minDensity:u,maxDensity:p,radius:f}=t.getInput().uniforms,d=8,h=9,b=o.accumulateFramebuffer,S=o.resolveGradientTexture,V={shader:this.shaders.resolve,uniforms:{accumulatedDensity:{texture:{unit:d,texture:b.colorTexture},minAndInvRange:[u,1/(p-u)],normalization:3/(f*f*Math.PI)},gradient:{texture:{unit:h,texture:S}}},defines:l,optionalAttributes:{},useComputeBuffer:!1};i.bindFramebuffer(this._prevFBO),i.setViewport(0,0,this._prevViewport.width,this._prevViewport.height),i.bindTexture(b.colorTexture,d),i.bindTexture(S,h),r.setPipelineState(Xs),r.submitDrawMesh(i,V,r.quadMesh),this._unbind()}_getOrCreateResourcesRecord(e){let t=this._resources.get(e);return t==null&&(t=new ga,this._resources.set(e,t)),t}_unbind(){this._prevFBO=null,this._prevViewport=null,this._isBound=!1}_bind(e,t,i){if(this._isBound)return;let{context:r,state:o,pixelRatio:l}=e,u=r.getBoundFramebufferObject(),p=r.getViewport();this._prevFBO=u,this._prevViewport=p;let{gradient:f,gradientHash:d}=i.uniforms;t.ensureResolveGradientTexture(r,d,f);let{width:h,height:b}=p,S=Ks(Ms(i,o),l),V=h*S,T=b*S,M=t.ensureAccumulateFBO(r,V,T);r.blitFramebuffer(u,M,0,0,u.width,u.height,0,0,M.width,M.height,Ot.STENCIL,vi.NEAREST),r.bindFramebuffer(M),r.setViewport(0,0,M.width,M.height),r.setColorMask(!0,!0,!0,!0),r.setClearColor(0,0,0,0),r.clear(Ot.COLOR),this._isBound=!0}};function Ks(a,e){let t=e>1.5?.25:.5;return a<1/(2*t)?1:t}function Ps(a){return a.key.level+1}var Ds={color:{write:[!0,!0,!0,!0],blendMode:"additive"},depth:!1,stencil:{write:!1,test:{ref:Ps,compare:_t.GEQUAL,mask:255,op:{fail:We.KEEP,zFail:We.KEEP,zPass:We.REPLACE}}}},$s=x(m({},Ds),{stencil:!1}),Xs={color:{write:[!0,!0,!0,!0],blendMode:"composite"},depth:!1,stencil:!1};function Ms(a,e){let{referenceScale:t,radius:i}=a.uniforms;return i*(t!==0?t/e.scale:1)}var Qs=360/254,we;(function(a){a[a.Color=0]="Color",a[a.Outline=1]="Outline",a[a.Halo=2]="Halo"})(we||(we={}));var Me=class extends oe{};n([g(3,v)],Me.prototype,"color",void 0),n([g(4,y)],Me.prototype,"offset",void 0),n([g(5,y)],Me.prototype,"textureUV",void 0),n([g(6,s)],Me.prototype,"fontSize",void 0),n([g(7,s)],Me.prototype,"referenceSize",void 0),n([g(8,v)],Me.prototype,"outlineColor",void 0),n([g(9,v)],Me.prototype,"haloColor",void 0),n([g(10,y)],Me.prototype,"outlineAndHaloSize",void 0),n([g(11,y)],Me.prototype,"zoomRange",void 0),n([g(12,s)],Me.prototype,"clipAngle",void 0),n([g(13,v)],Me.prototype,"referenceSymbol",void 0);var _i=class extends xt{};n([g(14,y)],_i.prototype,"offsetNextVertex1",void 0),n([g(15,y)],_i.prototype,"offsetNextVertex2",void 0);var hr=class extends ae{},he=class extends te{constructor(){super(...arguments),this.type="TextShader",this.computeAttributes={offset:["offsetNextVertex1","offsetNextVertex2"]},this.textRenderPassType=we.Color,this.isBackgroundPass=!1,this.isLabel=!1}clipLabel(e,t,i){let r=t.multiply(Qs),o=et(this.view.rotation.subtract(r)),l=it(new s(360).subtract(o),o),u=new s(0),p=Ki(this.view.currentZoom.multiply(Ha)).divide(Ha),f=e.x,d=e.y,h=new s(1).subtract(j(f,p)).multiply(2),b=j(new s(90),l).multiply(2),S=new s(2).multiply(new s(1).subtract(j(p,d)));return u=u.add(i.multiply(h)),u=u.add(i.multiply(b)),u=u.add(S),u}vertex(e,t){let i=H(e.bitset,Xr),r=new s(1).subtract(i),o=e.fontSize,l=o.divide(Ga),u=this.textRenderPassType===we.Outline?e.outlineColor:this.textRenderPassType===we.Halo?e.haloColor:this._getVertexColor(e),p=this.isLabel?this.storage.getLabelVisibility(e.id):new s(1),f=this.isLabel?u.multiply(p):u,d=this.view.displayViewScreenMat3.multiply(new z(e.pos,1)),h=e.offset,b=new s(1),S=R.identity(),V=new y(0);if(this.isLabel){if(!e.referenceSymbol)throw new Error("InternalError: Optional attribute 'referenceSymbol' expected for labels");let ne=e.referenceSymbol,N=ne.xy,W=ne.z,$=this._unpackDirection(ne.w),Z=nt(this,e.id,W).divide(2),I=$.multiply(Z.add(Rr));V=N.add(I),h=h.add(V)}else b=nt(this,e.id,e.referenceSize).divide(e.referenceSize),o=o.multiply(b),l=l.multiply(b),h=h.multiply(b),S=ta(this,e.id),h=S.multiply(new z(h,0)).xy;let T=H(e.bitset,Qr),M=this._getViewRotationMatrix(T).multiply(new z(h,0)),P=this.isLabel?this.clipLabel(e.zoomRange,e.clipAngle,T):this.clip(e.id,e.zoomRange);P=this.isBackgroundPass?P.add(r.multiply(2)):P.add(i.multiply(2));let _=new s(0);if(this.textRenderPassType===we.Outline&&(P=P.add(D(se(e.outlineAndHaloSize.x,new s(0)),new s(2),new s(0))),_=new s(e.outlineAndHaloSize.x).divide(l).divide(ja)),this.textRenderPassType===we.Halo){let ne=e.outlineAndHaloSize.x,N=new s(e.outlineAndHaloSize.y);P=P.add(D(se(N,new s(0)),new s(2),new s(0))),_=N.add(ne).divide(l).divide(ja)}let Q=this.isLabel?ii(A(P,new s(1)),Be(p,new s(0))):new At(!1);return m({glPosition:new v(d.xy.add(M.xy),P,1),color:f,size:l,textureUV:e.textureUV.divide(this.mosaicInfo.size),antialiasingWidth:new s(.105*Ga).divide(o).divide(this.view.pixelRatio),outlineDistanceOffset:_},this.maybeRunHittest(e,t,{vvSizeAdjustment:b,vvRotation:S,labelOffset:V,labelClipped:Q}))}_getViewRotationMatrix(e){let t=this.view.displayViewMat3,i=this.view.displayMat3,r=new s(1).subtract(e);return t.multiply(e).add(i.multiply(r))}fragment(e){let t=new s(.25),i=new s(1).subtract(t),r=E(this.mosaicInfo.texture,e.textureUV).a,o=i.subtract(e.outlineDistanceOffset);this.highlight&&(o=o.divide(2));let l=e.antialiasingWidth,u=$i(o.subtract(l),o.add(l),r);return this.getFragmentOutput(e.color.multiply(u),e)}hittest(e,t,{vvSizeAdjustment:i,vvRotation:r,labelOffset:o,labelClipped:l}){let u,p,f;this.isLabel?(u=new z(e.offset.add(o),0),p=new z(t.offsetNextVertex1.add(o),0),f=new z(t.offsetNextVertex2.add(o),0)):(u=r.multiply(new z(e.offset.multiply(i),0)),p=r.multiply(new z(t.offsetNextVertex1.multiply(i),0)),f=r.multiply(new z(t.offsetNextVertex2.multiply(i),0)));let{viewMat3:d,tileMat3:h}=this.view,b=d.multiply(h).multiply(new z(e.pos,1)),S=b.add(h.multiply(u)).xy,V=b.add(h.multiply(p)).xy,T=b.add(h.multiply(f)).xy,M=Bt(this.hittestRequest.position,S.xy,V.xy,T.xy);return this.isLabel?D(l,qe(this.hittestRequest),M):M}_unpackDirection(e){let t=new Zi(e),i=ms(t,new Zi(2)),r=cs(t,new Zi(3));return new y(new s(i).subtract(1),new s(r).subtract(1))}_getVertexColor(e){let t=e.color;if(this.visualVariableColor){let i=this.storage.getColorValue(e.id);t=this.visualVariableColor.getColor(i,e.color,new At(!1))}if(this.visualVariableOpacity){let i=this.storage.getOpacityValue(e.id),r=this.visualVariableOpacity.getOpacity(i);t=t.multiply(r)}return t}};n([C(ve)],he.prototype,"visualVariableColor",void 0),n([C(be)],he.prototype,"visualVariableOpacity",void 0),n([C(ot)],he.prototype,"visualVariableRotation",void 0),n([C(Ae)],he.prototype,"visualVariableSizeMinMaxValue",void 0),n([C(ze)],he.prototype,"visualVariableSizeScaleStops",void 0),n([C(Te)],he.prototype,"visualVariableSizeStops",void 0),n([C(Re)],he.prototype,"visualVariableSizeUnitValue",void 0),n([c(re)],he.prototype,"mosaicInfo",void 0),n([Oe],he.prototype,"textRenderPassType",void 0),n([Oe],he.prototype,"isBackgroundPass",void 0),n([Oe],he.prototype,"isLabel",void 0),n([w(0,F(Me)),w(1,F(_i))],he.prototype,"vertex",null),n([w(0,F(hr))],he.prototype,"fragment",null);var wa=class extends B{constructor(){super(...arguments),this.type=k.Label,this.shaders={geometry:new he},this.drawPhase=ht.LABEL|ht.LABEL_ALPHA|ht.HITTEST,this.symbologyPlane=ce.TEXT}render(e,t){let{context:i,painter:r}=e,o=U(e),l=m({},G(e)),u=t.instance.getInput(),p={shader:this.shaders.geometry,uniforms:x(m(m({},K(e,t.target,u.uniforms)),q(e,t.target)),{mosaicInfo:r.textureManager.getMosaicInfo(i,t.textureKey)}),defines:x(m({},o),{textRenderPassType:we.Color,isBackgroundPass:!0,isLabel:!0}),optionalAttributes:u.optionalAttributes,useComputeBuffer:L(e)};r.setPipelineState(l),r.setShader(p),r.submitDraw(e,t),r.setShader(x(m({},p),{defines:x(m({},o),{textRenderPassType:we.Halo,isBackgroundPass:!1,isLabel:!0})})),r.submitDraw(e,t),r.setShader(x(m({},p),{defines:x(m({},o),{textRenderPassType:we.Color,isBackgroundPass:!1,isLabel:!0})})),r.submitDraw(e,t)}};var It=class extends Ee{};n([g(9,s)],It.prototype,"accumulatedDistance",void 0),n([g(10,s)],It.prototype,"totalLength",void 0),n([g(11,s)],It.prototype,"gradientSize",void 0),n([g(12,y)],It.prototype,"segmentDirection",void 0),n([g(13,v)],It.prototype,"tlbr",void 0);var Fa=class extends O{};n([c(s)],Fa.prototype,"isColorPass",void 0);var Kt=class extends ge{constructor(){super(...arguments),this.type="GradientStrokeShader"}vertex(e,t){let{totalLength:i,gradientSize:r,segmentDirection:o,tlbr:l}=e,u=Gt(this,e),p=H(e.bitset,Vi.isAlongLine),f=i.divide(this.view.displayZoomFactor),d=D(bt(e.bitset,Vi.isAbsoluteSize),()=>{let S=D(A(p,new s(.5)),f,u.halfWidth);return r.divide(S)},r),h=e.accumulatedDistance.divide(this.view.displayZoomFactor).add(Fe(o,u.scaledOffset)).divide(f),b=l.divide(this.mosaicInfo.size.xyxy);return m(x(m({},u),{tlbr:b,relativePositionAlongLine:h,relativeGradientSize:d,isAlongLine:H(e.bitset,Vi.isAlongLine),isDiscrete:H(e.bitset,Vi.isDiscrete)}),this.maybeRunHittest(e,t,u.halfWidth))}fragment(e){let{isAlongLine:t,isDiscrete:i,relativePositionAlongLine:r,relativeGradientSize:o,normal:l,tlbr:u}=e,p=Ti(e,this.antialiasingControls.blur),f=new s(.5).multiply(l.y).add(new s(.5)),d=D(A(t,new s(.5)),r,f),h=D(A(i,new s(.5)),o.subtract(1),new s(0)),b=oi(d.add(h).divide(o)),S=J(u.xy,u.zw,new y(de(b,new s(0),new s(1)),.5)),V=E(this.mosaicInfo.texture,S),T=e.opacity.multiply(p),M=this.getFragmentOutput(V.multiply(T),e),P=j(new s(.5),this.technique.isColorPass).multiply(je("gradient-depth-epsilon")),_=j(new s(0),l.y).multiply(new s(je("gradient-depth-bias")).subtract(P));return M.glFragDepth=de(tt(l).add(_),new s(0),new s(1)),M}};n([c(re)],Kt.prototype,"mosaicInfo",void 0),n([c(Fa)],Kt.prototype,"technique",void 0),n([w(0,F(It)),w(1,F(ie))],Kt.prototype,"vertex",null);var za=class extends B{constructor(){super(...arguments),this.type=k.GradientStroke,this.shaders={geometry:new Kt},this.symbologyPlane=ce.LINE}_getShaderOptions(e,t,i){let{context:r,painter:o,pixelRatio:l}=e,u=t.instance.getInput();return{shader:this.shaders.geometry,uniforms:x(m(m({},K(e,t.target,u.uniforms)),q(e,t.target)),{antialiasingControls:He(l),mosaicInfo:o.textureManager.getMosaicInfo(r,t.textureKey),technique:{isColorPass:i}}),defines:m({},U(e)),optionalAttributes:u.optionalAttributes,useComputeBuffer:L(e)}}render(e,t){let{painter:i}=e;if(L(e)||Wi(e)){let l=G(e);return i.setPipelineState(l),i.setShader(this._getShaderOptions(e,t,1)),void i.submitDraw(e,t)}e.context.setClearDepth(1),e.context.clear(Ot.DEPTH);let r={color:!1,depth:{write:{zNear:0,zFar:1},test:_t.LESS},stencil:{write:!1,test:{ref:l=>l.stencilRef,compare:_t.EQUAL,mask:255,op:{fail:We.KEEP,zFail:We.KEEP,zPass:We.KEEP}}}};i.setShader(this._getShaderOptions(e,t,0)),i.setPipelineState(r),i.submitDraw(e,t);let o={color:{write:[!0,!0,!0,!0],blendMode:"composite"},depth:{write:!1,test:_t.LEQUAL},stencil:{write:!1,test:{ref:l=>l.stencilRef,compare:_t.EQUAL,mask:255,op:{fail:We.KEEP,zFail:We.KEEP,zPass:We.KEEP}}}};i.setShader(this._getShaderOptions(e,t,1)),i.setPipelineState(o),i.submitDraw(e,t)}};var Ta=class extends B{constructor(){super(...arguments),this.type=k.Line,this.shaders={geometry:new ge},this.symbologyPlane=ce.LINE}render(e,t){let{painter:i,pixelRatio:r}=e,o=t.instance.getInput();i.setShader({shader:this.shaders.geometry,uniforms:x(m(m({},K(e,t.target,o.uniforms)),q(e,t.target)),{antialiasingControls:He(r)}),defines:m({},U(e)),optionalAttributes:o.optionalAttributes,useComputeBuffer:L(e)}),i.setPipelineState(G(e)),i.submitDraw(e,t)}};var Ct=class extends Ee{};n([g(9,s)],Ct.prototype,"accumulatedDistance",void 0),n([g(10,y)],Ct.prototype,"segmentDirection",void 0),n([g(11,s)],Ct.prototype,"offsetAlongLine",void 0),n([g(12,s)],Ct.prototype,"capType",void 0),n([g(13,v)],Ct.prototype,"tlbr",void 0);var hi=class extends ge{constructor(){super(...arguments),this.type="TexturedLineShader"}_getDistanceRatio(e,t){let i=H(e.bitset,Kr);return i.multiply(ue(t,new s(.25)).multiply(new s(2))).add(new s(1).subtract(i).multiply(st(1)))}_getSDFAlpha(e){let{halfWidth:t,normal:i,tlbr:r,patternSize:o,accumulatedDistance:l,offsetAlongLine:u,dashToPx:p,capType:f}=e,d=o.x.divide(4).multiply(p),h=Et(l.add(u).divide(d)),b=J(r.xy,r.zw,new y(h,.5)),S=St(E(this.mosaicInfo.texture,b)).multiply(2).subtract(1).multiply(64).multiply(p),V=i.y.multiply(t),T=ye([se(f,new s(1)),S.subtract(t)],[se(f,new s(2)),Xi(ys(ue(S,new s(0)),new s(2)).add(V.multiply(V))).subtract(t)],[!0,S]),M=de(new s(.25).subtract(T),new s(0),new s(1));return new v(M)}_getPatternColor(e){let{halfWidth:t,normal:i,color:r,accumulatedDistance:o,patternSize:l,sampleAlphaOnly:u,tlbr:p}=e,f=l.y.multiply(new s(2).multiply(t).divide(l.x)),d=Et(o.divide(f)),h=new s(.5).multiply(i.y).add(new s(.5)),b=J(p.xy,p.zw,new y(h,d)),S=E(this.mosaicInfo.texture,b);return this.visualVariableColor!=null&&(S=D(A(u,new s(.5)),new v(r.a),r)),S}vertex(e,t){let{segmentDirection:i,tlbr:r,bitset:o}=e,l=Gt(this,e),u=e.accumulatedDistance.divide(this.view.displayZoomFactor).add(Fe(i,l.scaledOffset)),p=new y(r.z.subtract(r.x),r.w.subtract(r.y)),f=r.divide(this.mosaicInfo.size.xyxy),d=H(o,$r),h=H(o,Hi),b=D(A(d,new s(.5)),this._getDistanceRatio(e,l.scaledHalfWidth),new s(1));return m(x(m({},l),{tlbr:f,patternSize:p,accumulatedDistance:u,isSDF:d,sampleAlphaOnly:h,dashToPx:b,offsetAlongLine:e.offsetAlongLine,capType:e.capType}),this.maybeRunHittest(e,t,l.halfWidth))}fragment(e){let{color:t,opacity:i,isSDF:r}=e,o=Ti(e,this.antialiasingControls.blur),l=D(A(r,new s(.5)),this._getSDFAlpha(e),this._getPatternColor(e)),u=t.multiply(i).multiply(o).multiply(l);return this.getFragmentOutput(u,e)}};n([c(re)],hi.prototype,"mosaicInfo",void 0),n([w(0,F(Ct)),w(1,F(ie))],hi.prototype,"vertex",null);var Ma=class extends B{constructor(){super(...arguments),this.type=k.TexturedLine,this.shaders={geometry:new hi},this.symbologyPlane=ce.LINE}render(e,t){let{context:i,painter:r,pixelRatio:o}=e,l=t.instance.getInput();r.setShader({shader:this.shaders.geometry,uniforms:x(m(m({},K(e,t.target,l.uniforms)),q(e,t.target)),{antialiasingControls:He(o),mosaicInfo:r.textureManager.getMosaicInfo(i,t.textureKey)}),defines:m({},U(e)),optionalAttributes:l.optionalAttributes,useComputeBuffer:L(e)}),r.setPipelineState(G(e)),r.submitDraw(e,t)}};var Je=class extends oe{};n([g(3,v)],Je.prototype,"color",void 0),n([g(4,v)],Je.prototype,"outlineColor",void 0),n([g(5,y)],Je.prototype,"offset",void 0),n([g(6,y)],Je.prototype,"textureUV",void 0),n([g(7,v)],Je.prototype,"sizing",void 0),n([g(8,s)],Je.prototype,"placementAngle",void 0),n([g(9,s)],Je.prototype,"sdfDecodeCoeff",void 0),n([g(10,y)],Je.prototype,"zoomRange",void 0);var $t=class extends xt{};n([g(12,y)],$t.prototype,"offsetNextVertex1",void 0),n([g(13,y)],$t.prototype,"offsetNextVertex2",void 0),n([g(14,y)],$t.prototype,"textureUVNextVertex1",void 0),n([g(15,y)],$t.prototype,"textureUVNextVertex2",void 0);var gr=class extends ae{};function ft(a,e,t,i){return e.multiply(a.x).add(t.multiply(a.y)).add(i.multiply(a.z))}function yr(a){return a.multiply(a).divide(128)}var Pe=class extends te{constructor(){super(...arguments),this.type="MarkerShader",this.computeAttributes={offset:["offsetNextVertex1","offsetNextVertex2"],textureUV:["textureUVNextVertex1","textureUVNextVertex2"]}}vertex(e,t){let i=yr(e.sizing.x),r=yr(e.sizing.y),o=yr(e.sizing.z),l=e.placementAngle,u=H(e.bitset,Ue.bitset.isSDF),p=H(e.bitset,Ue.bitset.isMapAligned),f=H(e.bitset,Ue.bitset.scaleSymbolsProportionally),d=bt(e.bitset,Ue.bitset.colorLocked),h=rt(this,e.id),b=at(this,e.id,e.color,d).multiply(h),S=this.view.displayViewScreenMat3.multiply(new z(e.pos.xy,1)),V=nt(this,e.id,o).divide(o),T=i.multiply(V),M=e.offset.xy.multiply(V),P=r.multiply(f.multiply(V.subtract(1)).add(1));P=it(P,ue(T.subtract(.99),new s(0)));let _=ue(P,new s(1)),Q=it(P,new s(1)),ne=R.fromRotation(l.multiply(Qt)),N=ta(this,e.id),W=this._getViewRotationMatrix(p).multiply(N).multiply(ne).multiply(new z(M.xy,0)),$=this.clip(e.id,e.zoomRange),Z=new v(S.xy.add(W.xy),$,1),I=e.textureUV.divide(this.mosaicInfo.size),xi=e.outlineColor.multiply(Q),Xt=H(e.bitset,Ue.bitset.overrideOutlineColor),Vr=e.sdfDecodeCoeff.multiply(T);return m({glPosition:Z,color:b,textureUV:I,outlineColor:xi,outlineSize:_,distanceToPx:Vr,isSDF:u,overrideOutlineColor:Xt},this.maybeRunHittest(e,t,{pos:e.pos,size:T,sizeCorrection:V,isMapAligned:p,vvRotationMat3:N,placementMat3:ne,outlineSize:_,distanceToPx:Vr,isSDF:u}))}fragment(e){let t=this._getColor(e.textureUV,e);return this.getFragmentOutput(t,e)}hittest(e,t,i){return D(ti(i.size,this.hittestRequest.smallSymbolSizeThreshold),this._hittestSmallMarker(e,t,i),this._hittestMarker(e,t,i))}_getViewRotationMatrix(e){let t=this.view.displayViewMat3,i=this.view.displayMat3,r=new s(1).subtract(e);return t.multiply(e).add(i.multiply(r))}_getViewScreenMatrix(e){let t=this.view.viewMat3.multiply(this.view.tileMat3),i=this.view.tileMat3,r=new s(1).subtract(e);return t.multiply(e).add(i.multiply(r))}_getColor(e,t){return D(se(t.isSDF,new s(1)),this._getSDFColor(e,t),this._getSpriteColor(e,t))}_getSpriteColor(e,t){return E(this.mosaicInfo.texture,e).multiply(t.color)}_getSDFColor(e,t){let i=E(this.mosaicInfo.texture,e),r=new s(.5).subtract(St(i)).multiply(t.distanceToPx).multiply(ki),o=de(new s(.5).subtract(r),new s(0),new s(1)),l=t.color.multiply(o),u=t.outlineSize;this.highlight&&(u=ue(u,t.overrideOutlineColor.multiply(4)));let p=u.multiply(.5),f=et(r).subtract(p),d=de(new s(.5).subtract(f),new s(0),new s(1)),h=J(t.outlineColor,t.color,t.overrideOutlineColor).multiply(d);return new s(1).subtract(h.a).multiply(l).add(h)}_hittestSmallMarker(e,t,i){let{position:r,distance:o,smallSymbolDistance:l}=this.hittestRequest,u=o.subtract(l),{viewMat3:p,tileMat3:f}=this.view,d=p.multiply(f).multiply(new z(i.pos,1)).xy,h=i.size.multiply(.5);return Lt(d,r).subtract(h).add(u)}_hittestMarker(e,t,i){let{pos:r,sizeCorrection:o,isMapAligned:l}=i,u=new z(e.offset.multiply(o),0),p=new z(t.offsetNextVertex1.multiply(o),0),f=new z(t.offsetNextVertex2.multiply(o),0),{viewMat3:d,tileMat3:h}=this.view,b=d.multiply(h).multiply(new z(r,1)),S=this._getViewScreenMatrix(l).multiply(i.vvRotationMat3).multiply(i.placementMat3),V=b.add(S.multiply(u)).xy,T=b.add(S.multiply(p)).xy,M=b.add(S.multiply(f)).xy,P=this.hittestRequest.position,_=this.hittestRequest.distance,Q=Bt(P,V,T,M);return D(A(Q,_),Q,this._hittestSamples(V,T,M,e,t,i))}_hittestSamples(e,t,i,r,o,l){let{outlineSize:u,isSDF:p,distanceToPx:f}=l,d=this.hittestRequest.position,h=this.hittestRequest.distance,b=me(d.add(new y(le(h),le(h))),e,t,i),S=me(d.add(new y(0,le(h))),e,t,i),V=me(d.add(new y(h,le(h))),e,t,i),T=me(d.add(new y(le(h),0)),e,t,i),M=me(d,e,t,i),P=me(d.add(new y(h,0)),e,t,i),_=me(d.add(new y(le(h),h)),e,t,i),Q=me(d.add(new y(0,h)),e,t,i),ne=me(d.add(new y(h,h)),e,t,i),N=r.textureUV.divide(this.mosaicInfo.size),W=o.textureUVNextVertex1.divide(this.mosaicInfo.size),$=o.textureUVNextVertex2.divide(this.mosaicInfo.size),Z={color:new v(1),outlineColor:new v(1),overrideOutlineColor:new s(1),outlineSize:u,distanceToPx:f,isSDF:p},I=new s(0);return I=I.add(pe(b).multiply(this._getColor(ft(b,N,W,$),Z).a)),I=I.add(pe(S).multiply(this._getColor(ft(S,N,W,$),Z).a)),I=I.add(pe(V).multiply(this._getColor(ft(V,N,W,$),Z).a)),I=I.add(pe(T).multiply(this._getColor(ft(T,N,W,$),Z).a)),I=I.add(pe(M).multiply(this._getColor(ft(M,N,W,$),Z).a)),I=I.add(pe(P).multiply(this._getColor(ft(P,N,W,$),Z).a)),I=I.add(pe(_).multiply(this._getColor(ft(_,N,W,$),Z).a)),I=I.add(pe(Q).multiply(this._getColor(ft(Q,N,W,$),Z).a)),I=I.add(pe(ne).multiply(this._getColor(ft(ne,N,W,$),Z).a)),j(I,new s(.05)).multiply(qe(this.hittestRequest))}};n([C(ve)],Pe.prototype,"visualVariableColor",void 0),n([C(be)],Pe.prototype,"visualVariableOpacity",void 0),n([C(ot)],Pe.prototype,"visualVariableRotation",void 0),n([C(Ae)],Pe.prototype,"visualVariableSizeMinMaxValue",void 0),n([C(ze)],Pe.prototype,"visualVariableSizeScaleStops",void 0),n([C(Te)],Pe.prototype,"visualVariableSizeStops",void 0),n([C(Re)],Pe.prototype,"visualVariableSizeUnitValue",void 0),n([c(re)],Pe.prototype,"mosaicInfo",void 0),n([w(0,F(Je)),w(1,F($t))],Pe.prototype,"vertex",null),n([w(0,F(gr))],Pe.prototype,"fragment",null);var Pa=class extends B{constructor(){super(...arguments),this.type=k.Marker,this.shaders={geometry:new Pe},this.symbologyPlane=ce.MARKER}render(e,t){let{context:i,painter:r}=e,o=t.instance.getInput();r.setShader({shader:this.shaders.geometry,uniforms:x(m(m({},K(e,t.target,o.uniforms)),q(e,t.target)),{mosaicInfo:r.textureManager.getMosaicInfo(i,t.textureKey,!0)}),defines:m({},U(e)),optionalAttributes:o.optionalAttributes,useComputeBuffer:L(e)}),r.setPipelineState(G(e)),r.submitDraw(e,t)}};var Da=class{constructor(){this.computeAttributes={}}get locationsMap(){let e=new Map;for(let t in this.locations)e.set(t,this.locations[t].index);return e}get optionPropertyKeys(){if(!this._optionPropertyKeys){let e=new Set(Object.keys(this.options));this._optionPropertyKeys=e}return this._optionPropertyKeys}get _transformFeedbackBindings(){return[]}get locationInfo(){if(!this._locationInfo){let e=this.locationsMap,t=Array.from(e.entries()).map(([r,o])=>`${r}.${o}`).join("."),i=zr(t);this._locationInfo={hash:i,stringHash:t,locations:e,computeAttributeMap:this.computeAttributes}}return this._locationInfo}get renamedLocationsMap(){let e=new Map;for(let[t,i]of this.locationsMap.entries())e.set("a_"+t,i);return e}getShaderKey(e,t,i){return`${Object.keys(e).map(r=>`${r}.${e[r]}`).join(".")}.${Object.keys(i).filter(r=>i[r]).map(r=>`${r}_${i[r].toString()}`).join(".")}.${Object.keys(t).filter(r=>this.optionPropertyKeys.has(r)).join(".")}`}getProgram(e,t,i,r){let o="",l="";for(let u in i)if(i[u]){let p=typeof i[u]=="boolean"?`#define ${u}
`:`#define ${u} ${i[u]}
`;o+=p,l+=p}return o+=this.vertexShader,l+=this.fragmentShader,new gs(o,l,this.renamedLocationsMap,this.locationInfo,this._getUniformBindings(t),this._transformFeedbackBindings)}_getUniformBindings(e){let t=[];for(let i in this.required){let r=this.required[i];t.push({uniformHydrated:null,shaderModulePath:i,uniformName:i,uniformType:r.type,uniformArrayElementType:Is(r),uniformArrayLength:Cs(r)})}for(let i in e){let r=this.options[i];if(e[i])for(let o in r){let l=r[o];t.push({uniformHydrated:null,shaderModulePath:`${i}.${o}`,uniformName:o,uniformType:l.type,uniformArrayElementType:Is(l),uniformArrayLength:Cs(l)})}}return t}},Is=a=>a.type==="array"?a.elementType?.type:void 0,Cs=a=>a.type==="array"?a.size:void 0;var eo={hittestDist:s,hittestPos:y},to={filterFlags:X,animation:X,visualVariableData:X,dataDriven0:X,dataDriven1:X,dataDriven2:X,gpgpu:X,size:s},io={displayViewScreenMat3:R,displayViewMat3:R,displayMat3:R,viewMat3:R,tileMat3:R,displayZoomFactor:s,requiredZoomFactor:s,tileOffset:y,currentScale:s,currentZoom:s,metersPerSRUnit:s},Ia=class extends Da{constructor(){super(...arguments),this.vertexShader=Xa("materials/pie/pie.vert"),this.fragmentShader=Xa("materials/pie/pie.frag"),this.required=x(m(m({},to),io),{outlineWidth:s,colors:ee,defaultColor:v,othersColor:v,outlineColor:v,donutRatio:s,sectorThreshold:s}),this.options={hittestUniforms:eo,visualVariableSizeMinMaxValue:{minMaxValueAndSize:v},visualVariableSizeScaleStops:{sizes:x(m({},ee.ofType(s,8)),{type:"array",elementType:s,size:8}),values:x(m({},ee.ofType(s,8)),{type:"array",elementType:s,size:8})},visualVariableSizeStops:{sizes:x(m({},ee.ofType(s,8)),{type:"array",elementType:s,size:8}),values:x(m({},ee.ofType(s,8)),{type:"array",elementType:s,size:8})},visualVariableSizeUnitValue:{unitValueToPixelsRatio:s},visualVariableOpacity:{opacities:x(m({},ee.ofType(s,8)),{type:"array",elementType:s,size:8}),opacityValues:x(m({},ee.ofType(s,8)),{type:"array",elementType:s,size:8})}},this.locations={pos:{index:0,type:y},id:{index:1,type:z},bitset:{index:2,type:s},offset:{index:3,type:y},texCoords:{index:4,type:y},size:{index:5,type:y},referenceSize:{index:6,type:s},zoomRange:{index:7,type:y}},this.defines={VV_SIZE_MIN_MAX_VALUE:"boolean",VV_SIZE_SCALE_STOPS:"boolean",VV_SIZE_FIELD_STOPS:"boolean",VV_SIZE_UNIT_VALUE:"boolean",VV_OPACITY:"boolean",HITTEST:"boolean",numberOfFields:"number",highlight:"boolean",inside:"boolean",outside:"boolean"}}setNumberOfFields(e){this.required.colors=x(m({},ee.ofType(v,e)),{type:"array",elementType:v,size:e})}};var Ca=class extends B{constructor(){super(...arguments),this.type=k.PieChart,this.shaders={geometry:new Ia},this.symbologyPlane=ce.MARKER}render(e,t){let{painter:i}=e,{instance:r,target:o}=t,l=this.shaders.geometry,u=r.getInput(),p=u.uniforms.numberOfFields,f=L(e),d=q(e,o),h=U(e);l.setNumberOfFields(p),i.setShader({shader:l,uniforms:x(m(m(m({},K(e,t.target,u.uniforms.shader)),d.storage),d.view),{hittestUniforms:d.hittestRequest?{hittestDist:d.hittestRequest?.distance,hittestPos:d.hittestRequest?.position}:null}),defines:x(m({VV_SIZE_MIN_MAX_VALUE:!!u.uniforms.shader.visualVariableSizeMinMaxValue,VV_SIZE_SCALE_STOPS:!!u.uniforms.shader.visualVariableSizeScaleStops,VV_SIZE_FIELD_STOPS:!!u.uniforms.shader.visualVariableSizeStops,VV_SIZE_UNIT_VALUE:!!u.uniforms.shader.visualVariableSizeUnitValue,VV_OPACITY:!!u.uniforms.shader.visualVariableOpacity,HITTEST:f,highlight:d.highlight?1:0},h),{numberOfFields:p}),optionalAttributes:{},useComputeBuffer:f}),i.setPipelineState(G(e)),i.submitDraw(e,t)}};var Oa=class extends B{constructor(){super(...arguments),this.type=k.Text,this.shaders={geometry:new he},this.symbologyPlane=ce.TEXT}render(e,t){let{context:i,painter:r}=e,o=U(e),l=t.instance.getInput(),u={shader:this.shaders.geometry,uniforms:x(m(m({},K(e,t.target,l.uniforms)),q(e,t.target)),{mosaicInfo:r.textureManager.getMosaicInfo(i,t.textureKey)}),defines:x(m({},o),{isBackgroundPass:!0,isLabel:!1,textRenderPassType:we.Color}),optionalAttributes:l.optionalAttributes,useComputeBuffer:L(e)};r.setShader(u),r.setPipelineState(G(e)),r.submitDraw(e,t),r.setShader(x(m({},u),{defines:x(m({},o),{isBackgroundPass:!1,isLabel:!1,textRenderPassType:we.Halo})})),r.submitDraw(e,t),r.setShader(x(m({},u),{defines:x(m({},o),{isBackgroundPass:!1,isLabel:!1,textRenderPassType:we.Outline})})),r.submitDraw(e,t),r.setShader(x(m({},u),{defines:x(m({},o),{isBackgroundPass:!1,isLabel:!1,textRenderPassType:we.Color})})),r.submitDraw(e,t)}};var De={fill:new ca,patternFill:new ha,complexFill:new pa,gradientFill:new da,outlineFill:new fa,patternOutlineFill:new ya,complexOutlineFill:new ma,marker:new Pa,pieChart:new Ca,line:new Ta,texturedLine:new Ma,gradientStroke:new za,text:new Oa,label:new wa,heatmap:new Va,dotDensity:new ua,animatedMarker:new ra};function gy(){for(let a in De)De[a].startup()}function xy(a){for(let e in De)De[e].shutdown(a)}function Ai(a,e){let t=a.slice(0,e),i=e-t.length;for(let r=0;r<i;r++){let o=t[t.length-1];t.push(o)}return t}function Os(a){if(!a)return[0,0,0,0];let{r:e,g:t,b:i,a:r}=a;return[e*(r/255),t*(r/255),i*(r/255),r]}var _a=8,_s=_a-2,As=()=>Ri.getLogger("esri.views.2d.layers.features.support.rendererUtils");function Aa(a){return a.map(e=>ao(e)?ro(e.clone()):e)}function ao(a){return(a.type==="size"||a.type==="color"||a.type==="opacity")&&a.stops!=null}function ro(a){return a.stops=no(a.type,a.stops??[]),a}function yi(a,e,t){return(1-t)*a+t*e}function so(a,e){let[t,...i]=e,r=i.pop(),o=i[0].value,l=i[i.length-1].value,u=(l-o)/_s,p=[];for(let f=o;f<l;f+=u){let d=0;for(;f>=i[d].value;)d++;let h=i[d],b=e[d-1],S=f-b.value,V=h.value===b.value?1:S/(h.value-b.value);if(a==="color"){let T=i[d],M=e[d-1],P=T.color.clone();P.r=yi(M.color.r,P.r,V),P.g=yi(M.color.g,P.g,V),P.b=yi(M.color.b,P.b,V),P.a=yi(M.color.a,P.a,V),p.push({value:f,color:P,label:T.label})}else if(a==="size"){let T=i[d],M=e[d-1],P=Ba(T.size),_=yi(Ba(M.size),P,V);p.push({value:f,size:_,label:T.label})}else{let T=i[d],M=yi(e[d-1].opacity,T.opacity,V);p.push({value:f,opacity:M,label:T.label})}}return[t,...p,r]}function oo(a){let[e,...t]=a,i=t.pop();for(;t.length>_s;){let r=0,o=0;for(let l=1;l<t.length;l++){let u=t[l-1],p=t[l],f=Math.abs(p.value-u.value);f>o&&(o=f,r=l)}t.splice(r,1)}return[e,...t,i]}function no(a,e){return e.length<=_a?e:(As().warn(`Found ${e.length} Visual Variable stops, but MapView only supports ${_a}. Displayed stops will be simplified.`),e.length>2*_a?so(a,e):oo(e))}function lo(){let{supportsColorBufferFloat:a,supportsColorBufferFloatBlend:e,supportsColorBufferHalfFloat:t}=Jt();return a&&e||t}function zy(a){if(!a)return!0;switch(a.type){case"dot-density":break;case"heatmap":if(!lo()){let e=Jt(),t=["supportsColorBufferFloat","supportsColorBufferFloatBlend","supportsColorBufferHalfFloat"].filter(i=>!e[i]).join(", ");return As().errorOnce(new Tr("webgl-missing-extension",`Missing WebGL2 requirements for Heatmap: ${t}`)),!1}}return!0}var po=1.25,Ra=128,mo=128;function co(a){if(!a.stops?.length)return null;let e=a.stops.sort((o,l)=>o.value-l.value),t=Ai(e,8),i=t.map(({value:o})=>o),r=t.map(({color:o})=>Os(o));return{values:i,colors:r}}function fo(a){if(!a.stops?.length)return null;let e=a.stops.sort((i,r)=>i.value-r.value),t=Ai(e,8);return{opacityValues:t.map(({value:i})=>i),opacities:t.map(({opacity:i})=>i)}}function ho(a){return{rotationType:a.rotationType==="geographic"?Si.Geographic:Si.Arithmatic}}function xr(a){if(!a.stops?.length)return null;if(a.stops.some(i=>i.useMaxValue||i.useMinValue))return(i,r)=>{let o=i.statisticsByLevel.get(r.key.level),l=a.stops.map(p=>({value:p.useMaxValue?o?.get(a.field)?.maxValue??0:p.useMinValue?o?.get(a.field)?.minValue??0:p.value,size:p.size?st(p.size):1e-30})).sort((p,f)=>p.value-f.value),u=Ai(l,8);return{values:u.map(({value:p})=>p),sizes:u.map(({size:p})=>p)}};let e=a.stops.sort((i,r)=>i.value-r.value),t=Ai(e,8);return{values:t.map(({value:i})=>i),sizes:t.map(({size:i})=>st(i))}}function yo(a){return e=>{let{state:t}=e;return{unitValueToPixelsRatio:Ir(t.spatialReference)/Ar[a.valueUnit??"meters"]/t.resolution}}}function Rs(a,e){let t=e.length;if(a<e[0].value||t===1)return e[0].size;for(let i=1;i<t;i++)if(a<e[i].value){let r=(a-e[i-1].value)/(e[i].value-e[i-1].value);return e[i-1].size+r*(e[i].size-e[i-1].size)}return e[t-1].size}function go(a){let{minDataValue:e,maxDataValue:t,minSize:i,maxSize:r}=a;if(typeof i=="object"&&typeof r=="object")return(o,l)=>{let u=o.state.scale,p=st(Rs(u,i.stops)),f=st(Rs(u,r.stops));return{minMaxValueAndSize:[e,t,p,f]}};if(typeof i=="object"||typeof r=="object")throw new Error("InternalError: Found a partial VisualVariableSizeMinMaxValue");return{minMaxValueAndSize:[e,t,st(i),st(r)]}}var gi={visualVariableColor:null,visualVariableOpacity:null,visualVariableRotation:null,visualVariableSizeStops:null,visualVariableSizeScaleStops:null,visualVariableSizeOutlineScaleStops:null,visualVariableSizeUnitValue:null,visualVariableSizeMinMaxValue:null};function vr(a,e=mo,t=po){if(a.visualVariableSizeMinMaxValue)return a.visualVariableSizeMinMaxValue instanceof Function?Ra:Math.max(a.visualVariableSizeMinMaxValue.minMaxValueAndSize[3]*t,e);if(a.visualVariableSizeScaleStops){if(a.visualVariableSizeScaleStops instanceof Function)return Ra;let i=a.visualVariableSizeScaleStops.sizes;return Math.max(i[i.length-1]*t,e)}if(a.visualVariableSizeStops){if(a.visualVariableSizeStops instanceof Function)return Ra;let i=a.visualVariableSizeStops.sizes;return Math.max(i[i.length-1]*t,e)}return a.visualVariableSizeUnitValue?2*Ra:0}function Ry(a){let e=m({},gi);if(!a||!("visualVariables"in a)||!a.visualVariables)return e;for(let t of Aa(a.visualVariables))switch(t.type){case"color":e.visualVariableColor=co(t);break;case"opacity":e.visualVariableOpacity=fo(t);break;case"rotation":e.visualVariableRotation=ho(t);break;case"size":switch(xo(t)){case"field-stops":e.visualVariableSizeStops=xr(t);break;case"scale-stops":t.target==="outline"?e.visualVariableSizeOutlineScaleStops=xr(t):e.visualVariableSizeScaleStops=xr(t);break;case"min-max":e.visualVariableSizeMinMaxValue=go(t);break;case"unit-value":e.visualVariableSizeUnitValue=yo(t)}break}return e}function xo(a){return typeof a.minDataValue=="number"&&typeof a.maxDataValue=="number"&&a.minSize!=null&&a.maxSize!=null?"min-max":a?.valueExpression==="$view.scale"&&Array.isArray(a.stops)?"scale-stops":a.field==null&&a?.valueExpression==="$view.scale"||!(Array.isArray(a.stops)||"levels"in a&&a.levels)?a.field!=null||a?.valueExpression!=="$view.scale"?"unit-value":null:"field-stops"}function Ls(a){return!!(a.visualVariableSizeMinMaxValue||a.visualVariableSizeScaleStops||a.visualVariableSizeStops||a.visualVariableSizeUnitValue||a.visualVariableSizeOutlineScaleStops)}function Uy(a){return!!a.visualVariableRotation}function vo(a){return a.minScale||a.maxScale?{minScale:a.minScale??0,maxScale:a.maxScale??0}:null}function Ge(a){if(a==null)return null;if(Array.isArray(a)){let[e,t,i,r]=a;return[e,t,i,255*r]}return typeof a=="string"?a:x(m({},a),{defaultValue:Ge(a?.defaultValue)})}async function Wy(a,e){let{cimResourceManager:t,cimAnalyzer:i,scaleExpression:r}=e.schemaOptions;await Promise.all(qr.fetchResources(a.symbol,t,[]));let o=i.analyzeSymbolReference(a,!1),l={scaleInfo:vo(a),scaleExpression:r},u=[];for(let p of o)switch(p.type){case"marker":u.push(...bo(p,e,l));break;case"fill":u.push(...zo(p,e,l));break;case"gradientFill":u.push(...Mo(p,e,l));break;case"line":u.push(...Do(p,e,l));break;case"gradientStroke":u.push(...Oo(p,e,l));break;case"text":u.push(...Ao(p,e,l))}return u}function bo(a,e,t){let{uniforms:i,schemaOptions:r}=e,{store:o}=r,l=a.isOutline?x(m({},gi),{visualVariableSizeScaleStops:i.visualVariableSizeOutlineScaleStops}):{visualVariableColor:i.visualVariableColor,visualVariableOpacity:i.visualVariableOpacity,visualVariableSizeMinMaxValue:i.visualVariableSizeMinMaxValue,visualVariableSizeScaleStops:i.visualVariableSizeScaleStops,visualVariableSizeStops:i.visualVariableSizeStops,visualVariableSizeUnitValue:i.visualVariableSizeUnitValue,visualVariableRotation:i.visualVariableRotation};return a.animationParams?So(o.ensureInstance(De.animatedMarker,{uniforms:l,optionalAttributes:{zoomRange:!0}}),a,gi,t):Vo(o.ensureInstance(De.marker,{uniforms:l,optionalAttributes:{zoomRange:!!t.scaleInfo}}),a,i,t)}function So(a,e,t,i){return e.animationParams?[a.createMeshInfo({pixelDimensions:e.pixelDimensions,texelDimensions:e.texelDimensions,effects:e.effects?{type:"cim-effect-infos",effectInfos:e.effects}:null,sprite:e.spriteRasterizationParam,animations:e.animationParams,scaleInfo:i.scaleInfo,scaleSymbolsProportionally:e.scaleSymbolsProportionally,strokeWidth:e.outlineWidth,isMapAligned:e.alignment===Ur.MAP,colorLocked:e.colorLocked,isStroke:e.isStroke,baseSize:e.baseSize,referenceSize:e.referenceSize,angleToLine:!!e.markerPlacement&&e.markerPlacement.placement&&"angleToLine"in e.markerPlacement.placement&&e.markerPlacement.placement.angleToLine,sizeRatio:e.sizeRatio})]:[]}function Vo(a,e,t,{scaleInfo:i,scaleExpression:r}){let o=Ls(t);return[a.createMeshInfo({size:e.size,scaleX:e.scaleX,anchorX:e.anchorPoint.x,anchorY:e.anchorPoint.y,angle:e.rotation,color:Ge(e.color)??[0,0,0,0],colorLocked:e.colorLocked,frameHeight:e.frameHeight,widthRatio:e.widthRatio,scaleInfo:i,offsetX:e.offsetX,offsetY:e.offsetY,outlineColor:Ge(e.outlineColor)??[0,0,0,0],outlineSize:e.outlineWidth,referenceSize:e.referenceSize||Br.CIMVectorMarker.size,rotateClockwise:e.rotateClockwise,scaleFactor:r??1,sizeRatio:e.sizeRatio,alignment:e.alignment,isAbsoluteAnchorPoint:e.isAbsoluteAnchorPoint,scaleSymbolsProportionally:e.scaleSymbolsProportionally,sprite:e.spriteRasterizationParam,hasSizeVV:o,placement:e.markerPlacement,effects:e.effects?{type:"cim-effect-infos",effectInfos:e.effects}:null,transforms:e.transform,minPixelBuffer:vr(t)})]}function wo(a,e,t){let{uniforms:i,schemaOptions:r}=e,{store:o}=r;return Fo(o.ensureInstance(De.fill,{uniforms:{visualVariableColor:a.colorLocked?null:i.visualVariableColor,visualVariableOpacity:i.visualVariableOpacity},optionalAttributes:{zoomRange:!!t.scaleInfo}}),a,t)}function Fo(a,e,{scaleInfo:t}){return[a.createMeshInfo({color:Ge(e.color)??[0,0,0,0],scaleInfo:t,effects:e.effects?{type:"cim-effect-infos",effectInfos:e.effects}:null})]}function zo(a,e,t){if(!a.spriteRasterizationParam)return wo(a,e,t);let{uniforms:i,schemaOptions:r}=e,{store:o}=r;return To(o.ensureInstance(De.complexFill,{uniforms:{visualVariableColor:a.colorLocked?null:i.visualVariableColor,visualVariableOpacity:i.visualVariableOpacity},optionalAttributes:{zoomRange:!!t.scaleInfo}}),a,i.visualVariableColor!=null,t)}function To(a,e,t,{scaleInfo:i}){if(!e.spriteRasterizationParam)throw new Error("InternalError: Sprite should always be defined");let r=!!e.hasUnresolvedReplacementColor&&(!t||e.colorLocked),o=e.sampleAlphaOnly&&!r,l=e.spriteRasterizationParam;return[a.createMeshInfo({color:Ge(e.color)??[0,0,0,0],height:e.height,aspectRatio:e.scaleX,offsetX:e.offsetX,offsetY:e.offsetY,scaleX:1,scaleY:1,angle:e.angle,applyRandomOffset:e.applyRandomOffset,sampleAlphaOnly:o,scaleProportionally:l.resource.type==="CIMHatchFill",sprite:l,scaleInfo:i,effects:e.effects?{type:"cim-effect-infos",effectInfos:e.effects}:null})]}function Mo(a,e,t){let{uniforms:i,schemaOptions:r}=e,{store:o}=r;return Po(o.ensureInstance(De.gradientFill,{uniforms:{visualVariableColor:null,visualVariableOpacity:i.visualVariableOpacity},optionalAttributes:{zoomRange:!!t.scaleInfo}}),a,t)}function Po(a,e,{scaleInfo:t}){if(!e.spriteRasterizationParam)throw new Error("InternalError: Sprite should always be defined");let i=e.spriteRasterizationParam;return[a.createMeshInfo({color:Ge(e.color)??[0,0,0,0],angle:e.angle,gradientMethod:e.gradientMethod,gradientSize:e.gradientSize,gradientSizeUnits:e.gradientSizeUnits,gradientType:e.gradientType,sprite:i,scaleInfo:t,effects:e.effects?{type:"cim-effect-infos",effectInfos:e.effects}:null})]}function Do(a,e,t){let{uniforms:i,schemaOptions:r}=e,{store:o}=r,l=a.isOutline?x(m({},gi),{visualVariableSizeScaleStops:i.visualVariableSizeOutlineScaleStops}):{visualVariableColor:a.colorLocked?null:i.visualVariableColor,visualVariableOpacity:i.visualVariableOpacity,visualVariableSizeMinMaxValue:i.visualVariableSizeMinMaxValue,visualVariableSizeScaleStops:i.visualVariableSizeScaleStops,visualVariableSizeStops:i.visualVariableSizeStops,visualVariableSizeUnitValue:i.visualVariableSizeUnitValue},u={uniforms:l,optionalAttributes:{zoomRange:!!t.scaleInfo}},p=!!(l.visualVariableSizeMinMaxValue||l.visualVariableSizeScaleStops||l.visualVariableSizeStops||l.visualVariableSizeUnitValue);return a.spriteRasterizationParam?Co(o.ensureInstance(De.texturedLine,u),a,p,t):Io(o.ensureInstance(De.line,u),a,p,t)}function br(a,e,{scaleInfo:t}){return{color:Ge(a.color)??[0,0,0,0],width:a.width,referenceWidth:a.referenceWidth,capType:a.cap,joinType:a.join,miterLimit:a.miterLimit,scaleInfo:t,hasSizeVV:e,effects:a.effects?{type:"cim-effect-infos",effectInfos:a.effects}:null}}function Io(a,e,t,i){if(e.spriteRasterizationParam)throw new Error("InternalError: Sprite should not be defined");let r=br(e,t,i);return[a.createMeshInfo(r)]}function Co(a,e,t,i){let{spriteRasterizationParam:r,scaleDash:o,sampleAlphaOnly:l}=e;if(!r)throw new Error("InternalError: Sprite should be defined");return[a.createMeshInfo(x(m({},br(e,t,i)),{offsetAlongLine:e.offsetAlongLine??0,shouldScaleDash:o??!1,shouldSampleAlphaOnly:l,isSDF:r.resource.type!=="CIMPictureStroke"&&r.resource.type!=="CIMGradientStroke",sprite:r}))]}function Oo(a,e,t){let{uniforms:i,schemaOptions:r}=e,{store:o}=r;return _o(o.ensureInstance(De.gradientStroke,{uniforms:a.isOutline?x(m({},gi),{visualVariableSizeScaleStops:i.visualVariableSizeOutlineScaleStops}):{visualVariableColor:null,visualVariableOpacity:i.visualVariableOpacity,visualVariableSizeMinMaxValue:i.visualVariableSizeMinMaxValue,visualVariableSizeScaleStops:i.visualVariableSizeScaleStops,visualVariableSizeStops:i.visualVariableSizeStops,visualVariableSizeUnitValue:i.visualVariableSizeUnitValue},optionalAttributes:{zoomRange:!!t.scaleInfo}}),a,t)}function _o(a,e,t){if(!e.spriteRasterizationParam)throw new Error("InternalError: Sprite should always be defined");let i=e.spriteRasterizationParam;return[a.createMeshInfo(x(m({},br(e,!1,t)),{gradientMethod:e.gradientMethod,gradientSize:e.gradientSize,gradientSizeUnits:e.gradientSizeUnits,gradientType:e.gradientType,sprite:i,effects:e.effects?{type:"cim-effect-infos",effectInfos:e.effects}:null}))]}function Ao(a,e,t){let{uniforms:i,schemaOptions:r}=e,{store:o}=r;return Ro(o.ensureInstance(De.text,{uniforms:{visualVariableColor:a.colorLocked?null:i.visualVariableColor,visualVariableOpacity:i.visualVariableOpacity,visualVariableRotation:i.visualVariableRotation,visualVariableSizeMinMaxValue:i.visualVariableSizeMinMaxValue,visualVariableSizeScaleStops:i.visualVariableSizeScaleStops,visualVariableSizeStops:i.visualVariableSizeStops,visualVariableSizeUnitValue:i.visualVariableSizeUnitValue},optionalAttributes:{zoomRange:!!t.scaleInfo,referenceSymbol:!1,clipAngle:!1}}),a,i,t)}function Ro(a,e,t,{scaleInfo:i,scaleExpression:r}){return[a.createMeshInfo({boxBackgroundColor:Ge(e.backgroundColor),boxBorderLineColor:Ge(e.borderLineColor),boxBorderLineSize:e.borderLineWidth??0,color:Ge(e.color)??[0,0,0,0],offsetX:e.offsetX,offsetY:e.offsetY,postAngle:e.angle,fontSize:e.size,referenceSize:e.referenceSize,decoration:e.decoration,haloColor:Ge(e.haloColor)??[0,0,0,0],haloSize:e.haloSize??0,outlineColor:Ge(e.outlineColor)??[0,0,0,0],outlineSize:e.outlineSize,lineWidth:e.lineWidth||512,lineHeightRatio:1,horizontalAlignment:e.horizontalAlignment??"center",verticalAlignment:e.verticalAlignment??"baseline",useCIMAngleBehavior:!1,glyphs:e.textRasterizationParam,scaleInfo:i,effects:e.effects?{type:"cim-effect-infos",effectInfos:e.effects}:null,placement:e.markerPlacement,transforms:e.transform,scaleFactor:r??1,minPixelBuffer:vr(t),repeatLabel:null,repeatLabelDistance:null,allowOverrun:null,labelPosition:null})]}var Sr=class{constructor(){this.type="override-batch",this.messages=[],this._resovler=Pr()}get promise(){return this._resovler.promise}resolve(){this._resovler.resolve()}add(e){this.messages.push(e)}},Es=class{constructor(e){this.updateTracking=new is({debugName:"FeatureCommandQueue"}),this.process=e.process,this._queueProcessor=new Dr({concurrency:1,process:async t=>{if(t.type==="override-batch"){let i=this._nextOverrideBatch;if(i==null)throw new Error("InternalError: Override should be defined");return this._nextOverrideBatch=null,await this.process(i),void i.resolve()}return this.process(t)}})}destroy(){this.updateTracking.destroy(),this._queueProcessor.destroy(),this.clear()}clear(){this._queueProcessor.clear()}async push(e){return Mr(this.updateTracking.addPromise(this._doPush(e)))}async _doPush(e){let t=this._queueProcessor,i=t.last();switch(e.type){case"update":case"highlight":return i?.type===e.type?void 0:t.push(e);case"override":case"edit":return this._pushOverride(e)}}_pushOverride(e){return this._nextOverrideBatch==null&&(this._nextOverrideBatch=new Sr,this._queueProcessor.push(this._nextOverrideBatch)),this._nextOverrideBatch.add(e),this._nextOverrideBatch.promise}};function rg(a,e){return{type:"simple",filters:e,capabilities:{maxTextureSize:Jt().maxTextureSize},bindings:La(a)}}function sg(a,e){let t=Jt();return{type:"multi",target:"feature",keyField:Er,filters:e,capabilities:{maxTextureSize:t.maxTextureSize},bindings:{[qi.TrackLine]:La(a.trackLines.renderer),[qi.LatestObservation]:La(a.latestObservations.renderer),[qi.PreviousObservation]:La(a.previousObservations.renderer)}}}function Ea(a){switch(a){case"opacity":return wi.OPACITY;case"color":return wi.COLOR;case"rotation":return wi.ROTATION;case"size":return wi.SIZE;default:return null}}function La(a){if(!a)return[];switch(a.type){case"simple":case"class-breaks":case"unique-value":case"dictionary":return Us(a);case"dot-density":return Lo(a);case"pie-chart":return Eo(a);case"heatmap":return Uo(a)}}function Lo(a){let e=[];for(let t of a.attributes)e.push({binding:e.length,expression:t.valueExpression,field:t.field});return e}function Eo(a){let e=Us(a),t=4;for(let i of a.attributes)e.push({binding:t++,expression:i.valueExpression,field:i.field});return e}function Uo({valueExpression:a,field:e}){return a||e?[{binding:0,expression:a,field:e}]:[]}function Us(a){return!("visualVariables"in a)||!a.visualVariables?.length?[]:Aa(a.visualVariables).map(e=>No(e)).filter(Fr)}function Bo(a){return a.valueExpression==="$view.scale"?null:{binding:Ea(a.type),field:a.field,normalizationField:a.normalizationField,expression:a.valueExpression,valueRepresentation:a.valueRepresentation}}function qo(a){return{binding:Ea(a.type),field:a.field,normalizationField:a.normalizationField,expression:a.valueExpression}}function ko(a){return{binding:Ea(a.type),field:a.field,normalizationField:a.normalizationField,expression:a.valueExpression}}function Ho(a){return{binding:Ea(a.type),expression:a.valueExpression,field:a.field}}function No(a){switch(a.type){case"size":return Bo(a);case"color":return qo(a);case"opacity":return ko(a);case"rotation":return Ho(a)}}export{si as a,bs as b,oi as c,vn as d,bn as e,Yi as f,Ji as g,De as h,gy as i,xy as j,Os as k,zy as l,gi as m,vr as n,Ry as o,Ls as p,Uy as q,vo as r,Wy as s,So as t,Vo as u,Fo as v,To as w,Po as x,Io as y,Co as z,_o as A,Ro as B,rg as C,sg as D,Us as E,Es as F};
