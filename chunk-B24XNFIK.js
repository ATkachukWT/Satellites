import{c as Re,d as ze,e as Ge,f as A,g as ee,h as ye,i as Oe,j as Pe,k as Be,l as Ue,m as je,n as We,o as He,p as Qe,q as $e,r as Ve,s as me,t as V}from"./chunk-VKNVHDN3.js";import{a as M,b as Y,c as Z,d as C,e as Fe}from"./chunk-WGX2RQVH.js";import{n as Se}from"./chunk-ZQGDHXJX.js";import"./chunk-7CMALMKV.js";import"./chunk-56YFAJ3D.js";import"./chunk-DD4REJYH.js";import"./chunk-7WIURX4Y.js";import"./chunk-CQUBHG54.js";import"./chunk-L25QECEE.js";import"./chunk-E4ND5WCV.js";import"./chunk-JX3MPN3R.js";import"./chunk-IE6LCR36.js";import"./chunk-SCNTWYD2.js";import"./chunk-K3Z3MI77.js";import"./chunk-35XAFVAL.js";import"./chunk-C3PAYYXB.js";import"./chunk-3CWCNPAI.js";import"./chunk-UCYOLKZK.js";import"./chunk-WTZT4FKW.js";import"./chunk-6FDNNAVT.js";import"./chunk-FYZRIMPP.js";import"./chunk-VYI3HIPB.js";import"./chunk-WI3QVC6K.js";import"./chunk-CU7VLLP2.js";import"./chunk-3O6GAUHL.js";import"./chunk-JAENS3D3.js";import"./chunk-3ATD3H4Q.js";import"./chunk-IFPD4DIO.js";import"./chunk-KBSNSGCC.js";import"./chunk-NLZLCUU5.js";import"./chunk-RZU6EEB3.js";import"./chunk-NNX76JDG.js";import"./chunk-76O2P2CB.js";import"./chunk-BAZL6DXF.js";import"./chunk-HPPVXWXI.js";import"./chunk-HBMVPT4U.js";import"./chunk-L6ZFUQTH.js";import"./chunk-4MB4OYWM.js";import"./chunk-OVJTX4VC.js";import"./chunk-55SQMRMH.js";import"./chunk-CQD6CYSR.js";import"./chunk-QDXM6RGS.js";import"./chunk-E3UR4EIC.js";import"./chunk-4Y623NMU.js";import"./chunk-PTAJ247D.js";import"./chunk-O4MHA7YC.js";import"./chunk-XHEYQWRE.js";import"./chunk-CJM4TC3F.js";import{c as xe}from"./chunk-J5PZXDWN.js";import"./chunk-ME2B26KJ.js";import"./chunk-U7PX7SHO.js";import{a as Ee}from"./chunk-DZBH24YT.js";import{a as Ae}from"./chunk-7E723FQO.js";import{e as _e}from"./chunk-SVJ5AK5B.js";import"./chunk-FXCL7YYQ.js";import"./chunk-NK3VUQOP.js";import"./chunk-HUKD3ORH.js";import"./chunk-M7AB4SQK.js";import"./chunk-XN6KHUVJ.js";import"./chunk-3A3BGKXB.js";import"./chunk-BGOXHRAZ.js";import"./chunk-SXNHGK6A.js";import"./chunk-TMZQBNSB.js";import"./chunk-PFSX77NO.js";import"./chunk-ZJWWZWMH.js";import"./chunk-W45QYQK6.js";import"./chunk-I5V562B6.js";import{a as Ie}from"./chunk-CUJB6F5L.js";import{a as Ke}from"./chunk-5NHJFBCW.js";import"./chunk-WPZN772I.js";import"./chunk-AOQ57NDM.js";import"./chunk-JGU5JAYW.js";import"./chunk-LCMPSAU3.js";import"./chunk-CRJDOM7J.js";import"./chunk-BCFGKQ2N.js";import"./chunk-G7BT6VC5.js";import"./chunk-YQGS4EZO.js";import"./chunk-3REMXE4W.js";import"./chunk-4ABKPPKG.js";import"./chunk-PMVQ5DJK.js";import"./chunk-I4Q2S2XA.js";import"./chunk-V774RJYN.js";import"./chunk-L2WNUKLP.js";import"./chunk-XITT4JU2.js";import"./chunk-ZBX6HJOS.js";import"./chunk-BSMAMABT.js";import"./chunk-LYNAYPL3.js";import"./chunk-ULANM5YP.js";import"./chunk-2G3SBK6Q.js";import"./chunk-VOB6IBIW.js";import"./chunk-63B3IOWG.js";import"./chunk-KAMRW6HF.js";import"./chunk-LAVV77UH.js";import"./chunk-VTGWQ7AP.js";import"./chunk-TBA3OZMJ.js";import"./chunk-S4QV2MGO.js";import"./chunk-USMAJP2P.js";import"./chunk-PHNFWHVF.js";import"./chunk-4N5OXIEM.js";import"./chunk-W26XKMAT.js";import"./chunk-NQWYPF77.js";import"./chunk-6KRFVLII.js";import"./chunk-G27DRLGO.js";import"./chunk-KRAKR4MK.js";import"./chunk-MCO7DSFO.js";import"./chunk-D7WE3OBT.js";import"./chunk-CDP4MSRO.js";import"./chunk-BCSLWH5H.js";import"./chunk-TOH4K6HW.js";import"./chunk-UP6FLASM.js";import"./chunk-DGBDFGKO.js";import"./chunk-44S2QQS2.js";import"./chunk-DQOFEB5P.js";import"./chunk-JTDXB5TK.js";import{m as $}from"./chunk-2NP7F5RO.js";import"./chunk-7QY3BMVN.js";import"./chunk-XEZTJAR4.js";import"./chunk-BUP3AMMF.js";import"./chunk-XCIPBOI4.js";import"./chunk-CWUY5SXW.js";import"./chunk-KD27XIJC.js";import"./chunk-TPFJWNIU.js";import"./chunk-P25RU3X5.js";import"./chunk-XRRQM4E2.js";import"./chunk-GWBRHLNH.js";import"./chunk-M67YQAIX.js";import"./chunk-NHEQ4TAR.js";import"./chunk-BIRSPTTF.js";import"./chunk-IZLELRQR.js";import"./chunk-7EMOONQX.js";import"./chunk-RZF6KTKU.js";import"./chunk-HP4LYRR4.js";import"./chunk-AFC2H4Q3.js";import"./chunk-OLOKUDVI.js";import"./chunk-4G7UTTZJ.js";import"./chunk-ZTOZWLEE.js";import"./chunk-RJWOVI3M.js";import"./chunk-SP2CO3KX.js";import"./chunk-NRBJLISB.js";import"./chunk-PTZYZULI.js";import"./chunk-NMLYCCKN.js";import"./chunk-RSDQHAJX.js";import"./chunk-BOVYXYHK.js";import"./chunk-FENRIY2T.js";import"./chunk-5HJY3X5Y.js";import"./chunk-6RZAM42M.js";import"./chunk-WDETDPZG.js";import"./chunk-HX2VGIR2.js";import"./chunk-64QN2VGD.js";import"./chunk-JGEVVXD4.js";import{q as ce}from"./chunk-B3FO6PT7.js";import"./chunk-C4UMJHQC.js";import"./chunk-BCREO4Q5.js";import"./chunk-LXFQWIWE.js";import"./chunk-QT6UNBJP.js";import"./chunk-V2GNNIXD.js";import"./chunk-NSYL2RQJ.js";import"./chunk-SLAWDKDA.js";import{a as De,h as ve}from"./chunk-MWSXMSWY.js";import"./chunk-JRCKELO6.js";import"./chunk-ZVCMULXF.js";import"./chunk-KJULKTB5.js";import"./chunk-LACL4BQ2.js";import{c as Q}from"./chunk-YR2HD3ZC.js";import"./chunk-GJASVPF6.js";import"./chunk-UBFCO3DV.js";import"./chunk-NI7FJV5X.js";import"./chunk-BUSG3ZOF.js";import"./chunk-XZIOXVVJ.js";import"./chunk-EXJYW3PC.js";import"./chunk-SXQPBCOX.js";import{m as ue}from"./chunk-LFH24RLM.js";import{n as ne}from"./chunk-Z5Q7KLA4.js";import"./chunk-X4LNX4BR.js";import"./chunk-4XZ6X7MQ.js";import"./chunk-WLHY3MMA.js";import"./chunk-KGVXGH6H.js";import"./chunk-ARRCN5K3.js";import"./chunk-LXQPIAN7.js";import"./chunk-FTDD7QBB.js";import"./chunk-DB3UIQCU.js";import"./chunk-SBHKMV3P.js";import"./chunk-R4A63S45.js";import"./chunk-ETE32IYO.js";import"./chunk-ONUGDWDK.js";import"./chunk-SG7CQU4O.js";import{H as b,k as W,n as ke}from"./chunk-QHVIRF5H.js";import{I as Ne,i as U}from"./chunk-WZDN6K3C.js";import{a as f}from"./chunk-QGVBCWUY.js";import"./chunk-OJQ73TPF.js";import"./chunk-354SCPDU.js";import"./chunk-OVHPPCBL.js";import"./chunk-IYZFKXJ6.js";import{D as ie,u as Te,v as H}from"./chunk-CKJ56T2Q.js";import"./chunk-SNFOAZZQ.js";import"./chunk-F6JAWRPN.js";import{r as x,t as X}from"./chunk-UHRSAPGQ.js";import"./chunk-V76GWARL.js";import{a as pe}from"./chunk-N2WTMF3X.js";var K;(function(e){e.MULTIPLIER="multiplier",e.ABSOLUTE="absolute-value"})(K||(K={}));var g=class extends Ae(xe(Ee(Ie(Ke)))){constructor(e){if(super(e),this.url=null,this.dataPreloadedInLocalCache=!1,this.initializationLinkChartConfig=null,this.membershipModified=!0,this._currentLinkChartConfig={layoutMode:"organic-standard"},this._graphTypeLookup=new Map,this.dataManager=null,this.knowledgeGraph=null,this.layers=new(Q.ofType(V)),this.entityLinkChartDiagramLookup=new Map,this.relationshipLinkChartDiagramLookup=new Map,this.linkChartExtent=new ue({xmin:-1e-7,ymin:-1e-7,xmax:1e-7,ymax:1e-7}),this.memberEntityTypes=null,this.memberRelationshipTypes=null,this.operationalLayerType="LinkChartLayer",this.sublayerIdsCache=new Map,this.tables=new(Q.ofType(V)),this.type="link-chart",this.chronologicalAuxiliaryGraphics=null,this._originalInclusionList=e?.initializationInclusionModeDefinition,e?.dataPreloadedInLocalCache&&!e?.initializationInclusionModeDefinition)throw new X("knowledge-graph:linkchart-layer-constructor","If creating a link chart composite layer and configured that data is already loaded in the cache, you must specify an inclusion list so the Composite Layer knows what records belong to it");this.addHandles(De(()=>this.layers.concat(this.tables),(a,i)=>this._handleSublayersChange(a,i),ve))}normalizeCtorArgs(e){if(!e)return{};let{url:a,title:i,dataPreloadedInLocalCache:n,initializationLinkChartConfig:t}=e;return{url:a,title:i,dataPreloadedInLocalCache:n,initializationLinkChartConfig:t}}_initializeLayerProperties(e){if(!this.title&&this.url){let o=this.url.split("/");this.title=o[o.length-2]}let a=new Set,i=[],n=[];if(e.inclusionModeDefinition&&(!e.inclusionModeDefinition.namedTypeDefinitions||e.inclusionModeDefinition.namedTypeDefinitions.size<1))throw new X("knowledge-graph:composite-layer-constructor","If an explicit inclusion definition is defined, at least one namedTypeDefinition must also be defined");e.inclusionModeDefinition?.generateAllSublayers?(i=e.knowledgeGraph.dataModel.entityTypes??[],n=e.knowledgeGraph.dataModel.relationshipTypes??[]):e.inclusionModeDefinition?.namedTypeDefinitions&&e.inclusionModeDefinition?.namedTypeDefinitions.size>0?e.inclusionModeDefinition?.namedTypeDefinitions.forEach((o,r)=>{let y=this._graphTypeLookup.get(r);if(!y)return x.getLogger(this).warn(`A named type, ${r}, was in the inclusion list that wasn't in the data model and will be removed`),void e.inclusionModeDefinition?.namedTypeDefinitions.delete(r);y.type==="relationship"?a.has(r)||(a.add(r),n.push(y)):y.type==="entity"?a.has(r)||(a.add(r),i.push(y)):(x.getLogger(this).warn(`A named type, ${r}, was in the inclusion list that wasn't properly modeled and will be removed`),e.inclusionModeDefinition?.namedTypeDefinitions.delete(r))}):(i=e.knowledgeGraph.dataModel.entityTypes??[],n=e.knowledgeGraph.dataModel.relationshipTypes??[]);let t=new Ve({knowledgeGraph:e.knowledgeGraph,inclusionModeDefinition:e.inclusionModeDefinition});this.knowledgeGraph=e.knowledgeGraph,this.memberEntityTypes=i,this.memberRelationshipTypes=n,this.dataManager=t}load(e){let a=async()=>{let i=[],n=[];this.loadLayerAssumingLocalCache(),this._layersLoadedFromAuthoritativeItem()||await me(this),this.dataManager.inclusionModeDefinition&&(this.dataManager.inclusionModeDefinition.generateAllSublayers=!1),this.dataManager.inclusionModeDefinition?.namedTypeDefinitions.forEach(t=>{t.useAllData=!1}),await this._initializeDiagram(),this.layers.forEach(t=>{n.push(t.refreshCachedQueryEngine()),i.push(new Promise(o=>{t.on("layerview-create",()=>{o(null)})}))}),this.tables.forEach(t=>{n.push(t.refreshCachedQueryEngine())}),await Promise.all(n)};return this.addResolvingPromise(new Promise(i=>{Se(this.url).then(async n=>{n.dataModel.entityTypes?.forEach(o=>{o.name&&this._graphTypeLookup.set(o.name,o)}),n.dataModel.relationshipTypes?.forEach(o=>{o.name&&this._graphTypeLookup.set(o.name,o)});let t=this.linkChart?.linkChartProperties;if(t?.originIdOf("entitiesUrl")===W.LINK_CHART&&(this.membershipModified=!1,this._originalInclusionList=await Re.fetchAndConvertSerializedLinkChart({entitiesUrl:t?.entitiesUrl,relationshipsUrl:t?.relationshipsUrl}),this._alignLayersDataModelAndInclusionDefinition(n.dataModel),this.initializationLinkChartConfig={layoutSettings:t?.layoutSettings??void 0,layoutMode:$e(t.layoutType)}),this._initializeLayerProperties({knowledgeGraph:n,inclusionModeDefinition:this._originalInclusionList}),this.dataManager.inclusionModeDefinition?.namedTypeDefinitions?.size||(this.dataManager.inclusionModeDefinition={generateAllSublayers:!1,namedTypeDefinitions:new Map},this.dataManager.knowledgeGraph.dataModel.entityTypes?.forEach(o=>{o.name&&this.dataManager.inclusionModeDefinition?.namedTypeDefinitions.set(o.name,{useAllData:!0})}),this.dataManager.knowledgeGraph.dataModel.relationshipTypes?.forEach(o=>{o.name&&this.dataManager.inclusionModeDefinition?.namedTypeDefinitions.set(o.name,{useAllData:!0})})),this.dataPreloadedInLocalCache){let o=ze.getInstance();for(let[r,y]of this.dataManager.inclusionModeDefinition?.namedTypeDefinitions??[])for(let p of y.members?.values()??[]){let m=o.readFromStoreById(`${r}__${p.id}`);m&&U(this.dataManager.sublayerCaches,r,()=>new Map).set(p.id,m)}await a()}else{let o=this.initializationLinkChartConfig?.layoutMode==="geographic-organic-standard";this.addResolvingPromise(this.dataManager.refreshCacheContent(void 0,!1,o,!0).then(async()=>{H(e),await a()}))}i(null)})})),Promise.resolve(this)}set initializationInclusionModeDefinition(e){this.loadStatus!=="loaded"&&this.loadStatus!=="failed"?this._set("initializationInclusionModeDefinition",e):x.getLogger(this).error("#initializationInclusionModeDefinition","initializationInclusionModeDefinition cannot be changed after the layer is loaded.")}get linkChart(){return this.parent}async addRecords(e,a){let i=[];a?.cascadeAddRelationshipEndNodes&&this.dataManager.knowledgeGraph.dataModel&&(i=await Qe(e,this.dataManager.knowledgeGraph));let n=e.concat(i).filter(t=>!this.sublayerIdsCache.get(t.typeName)?.has(t.id));n.length>0&&(this.membershipModified=!0),await this._handleNewRecords(n,a)}async removeRecords(e,{cascadeRemoveRelationships:a=!0,recalculateLayout:i=!1,overrideMembershipCheck:n=!1}={cascadeRemoveRelationships:!0,recalculateLayout:!1,overrideMembershipCheck:!1}){let t=[];for(let r of e)(n||this.dataManager.inclusionModeDefinition?.namedTypeDefinitions?.get(r.typeName)?.useAllData===!1&&this.dataManager.inclusionModeDefinition?.namedTypeDefinitions?.get(r.typeName)?.members?.has(r.id))&&t.push(r);if(a){let r=new Set,y=[];for(let p of t)if(this.dataManager.nodeConnectionsLookup.has(p.id))for(let m of this.dataManager.nodeConnectionsLookup.get(p.id))r.add(m);for(let p of r)if(this.dataManager.memberIdTypeLookup.has(p))for(let m of this.dataManager.memberIdTypeLookup.get(p))this.dataManager.relationshipTypeNames.has(m)&&y.push({id:p,typeName:m});t=t.concat(y)}this.dataManager.removeFromLayer(t);for(let r of t)this.sublayerIdsCache.get(r.typeName)?.delete(r.id),this.dataManager.relationshipTypeNames.has(r.typeName)?this.relationshipLinkChartDiagramLookup.delete(r.id):this.entityLinkChartDiagramLookup.delete(r.id);i&&await this._calculateLayoutWithSublayerTimeInfo(this._currentLinkChartConfig.layoutMode,{layoutSettings:this._currentLinkChartConfig.layoutSettings}),t.length>0&&(this.membershipModified=!0);let o=[];return this.layers.forEach(r=>{o.push(r.refreshCachedQueryEngine())}),await Promise.all(o),this._refreshNamedTypes(),t}async expand(e,a){let i=[];try{let n=await this.dataManager.getConnectedRecordIds(e,a?.relationshipTypeNames,a);i=n.filter(t=>!this.sublayerIdsCache.get(t.typeName)?.has(t.id)),await this._handleNewRecords(n,a),n.length>0&&(this.membershipModified=!0),H(a?.signal)}catch(n){throw ie(n)&&i.length>0&&this.removeRecords(i,{overrideMembershipCheck:!0}),n}return{records:i}}loadLayerAssumingLocalCache(){let e=[...this.memberRelationshipTypes,...this.memberEntityTypes];this.originIdOf("layers")===W.DEFAULTS?this._createSublayers(e,this.layers,a=>!!a.geometryType):this._updateSublayers(e,this.layers),this.originIdOf("tables")===W.DEFAULTS?this._createSublayers(e,this.tables,a=>!a.geometryType):this._updateSublayers(e,this.tables),this.dataManager.inclusionModeDefinition?.namedTypeDefinitions?.forEach((a,i)=>{let n=U(this.sublayerIdsCache,i,()=>new Set);a.members?.forEach(({id:t,linkChartLocation:o})=>{if(n.add(t),o){let r="coords"in o&&"lengths"in o?o:$(o);this.dataManager.relationshipTypeNames.has(i)?this.relationshipLinkChartDiagramLookup.set(t,r):this.entityLinkChartDiagramLookup.set(t,r)}})})}async calculateLinkChartLayout(e="organic-standard",a){let i=[],n=[],t=[];this.dataManager.sublayerCaches.forEach((s,h)=>{this.dataManager.entityTypeNames.has(h)?s.forEach(l=>{i.push({typeName:h,feature:l})}):this.dataManager.relationshipTypeNames.has(h)&&s.forEach(l=>{n.push({typeName:h,feature:l})})}),this.entityLinkChartDiagramLookup=new Map,this.relationshipLinkChartDiagramLookup=new Map;let o=new Map,r=new Map,y=new Map,p=new Map,m=new Uint8Array(i.length),w=new Float64Array(i.length),L=new Float64Array(i.length),j=new Float64Array(i.length),_=new Float64Array(i.length),k=new Uint32Array(n.length),oe=new Uint32Array(n.length),ge=new Float64Array(n.length),fe=new Float64Array(n.length),c=[],qe="organic-standard",E=new ue({xmin:-1e-7,ymin:-1e-7,xmax:1e-7,ymax:1e-7}),O,Le="organic-standard",u=0,D=0,Je=He.apply;switch(Le=e==="geographic-organic-standard"?qe:e,Le){case"organic-standard":O=Oe.apply;break;case"organic-community":O=Pe.apply;break;case"hierarchical-bottom-to-top":O=Ue.apply;break;case"radial-root-centric":O=je.apply;break;case"tree-left-to-right":O=We.apply;break;default:O=Be.apply}let se=!1;i.forEach(({typeName:s,feature:h})=>{if(e!=="chronological-mono-timeline"&&e!=="chronological-multi-timeline"&&a?.lockedNodeLocations?.has(h.attributes[M])){e==="geographic-organic-standard"&&this.dataManager.geographicLookup.has(s)?m[u]=A.IsGeographic:m[u]=A.None;let l=a.lockedNodeLocations.get(h.attributes[M]);w[u]=l.x,L[u]=l.y}else if(e==="geographic-organic-standard"&&this.dataManager.geographicLookup.has(s)){m[u]=A.IsGeographic;let l=null,T=h.attributes[this.dataManager.geographicLookup.get(s).name];switch(this.dataManager.geographicLookup.get(s)?.geometryType){case"esriGeometryPoint":w[u]=T?.x,L[u]=T?.y;break;case"esriGeometryPolygon":l=T?.centroid,l?.x!=null&&l?.y!=null?(w[u]=l.x,L[u]=l.y):m[u]=A.IsMovable;break;case"esriGeometryPolyline":case"esriGeometryMultipoint":l=T?.extent?.center,l?.x!=null&&l?.y!=null?(w[u]=l.x,L[u]=l.y):m[u]=A.IsMovable;break;default:m[u]=A.IsMovable}(w[u]==null||L[u]==null||Number.isNaN(w[u])||Number.isNaN(L[u]))&&(m[u]=A.IsMovable,w[u]=0,L[u]=0)}else if(e==="chronological-mono-timeline"||e==="chronological-multi-timeline"){!se&&a?.lockedNodeLocations?.has(h.attributes[M])&&(se=!0);let l=a?.timeInfoByTypeName?.get(s),T=l?.startField,R=T&&l?.startField?h.attributes[T]:null;j[u]=R?new Date(R).getTime():NaN;let N=l?.endField,I=N&&l?.endField?h.attributes[N]:null;_[u]=I?new Date(I).getTime():NaN,w[u]=0,L[u]=0,m[u]=A.IsMovable}else m[u]=A.IsMovable,w[u]=0,L[u]=0;p.set(h.attributes[M],u),c[u]={feature:h,typeName:s},u++}),se&&x.getLogger(this).warn("Locked node locations are not supported for chronological layout at this time.  Requested node locations were ignored");let be=!1,re=new Map;n.forEach(s=>{let h=s.feature.attributes[Y],l=s.feature.attributes[Z],T=p.get(h),R=p.get(l),N=a?.timeInfoByTypeName?.get(s.typeName),I=a?.timeInfoByTypeName?N?.startField:null,F=I?s.feature.attributes[I]:null,ae=N?.endField,P=ae?s.feature.attributes[ae]:null;if(T!==void 0&&R!==void 0){let z=h+"-"+l;e!=="chronological-mono-timeline"&&e!=="chronological-multi-timeline"||(z=z+"-"+F+"-"+P);let J=re.get(z);J?.has(s.typeName)||(k[D]=T,oe[D]=R,e!=="chronological-mono-timeline"&&e!=="chronological-multi-timeline"||(ge[D]=F?new Date(F).getTime():NaN,fe[D]=P?new Date(P).getTime():NaN),J===void 0?re.set(z,new Map([[s.typeName,D]])):J.set(s.typeName,D),D++),t.push(s)}else be=!0,this.relationshipLinkChartDiagramLookup.set(h,null)}),be&&x.getLogger(this).warn("A relationship is a member of this layer that has either origin or destination entity nodes that are not members. The diagram geometry will be set to null");let Xe=this._validateOrganicLayoutSettings(e,a?.layoutSettings?.organicLayoutSettings),le=this._convertValidatedOrganicSettingsToCalculationSettings(Xe);await Ge();let q=ee.Error,v=null;if(e==="chronological-mono-timeline"||e==="chronological-multi-timeline"){let s;({status:q,links:v,graphics:s}=Je(()=>a?.signal?.aborted??!1,m,w,L,j,_,k.subarray(0,D),oe.subarray(0,D),ge.subarray(0,D),fe.subarray(0,D),e==="chronological-multi-timeline",a?.layoutSettings?.chronologicalLayoutSettings)),q===ee.Success&&(this.chronologicalAuxiliaryGraphics=s)}else({status:q,links:v}=O(()=>a?.signal?.aborted??!1,m,w,L,k.subarray(0,D),oe.subarray(0,D),le.computationBudgetTime,le.idealEdgeLengthMultiplier,le.repulsionRadiusMultiplier));if(H(a?.signal),q===ee.Error)throw new X("knowledge-graph:layout-failed","Attempting to arrange the records in the specified layout failed");if(q===ee.Canceled)throw Te();for(let s=0;s<c.length;s++){if(L[s]>84.9999?L[s]=84.9999:L[s]<-84.9999&&(L[s]=-84.9999),w[s]>179.9999?w[s]=179.9999:w[s]<-179.9999&&(w[s]=-179.9999),c[s].feature.attributes[C]=new ne(w[s],L[s]),o.has(c[s].typeName))o.get(c[s].typeName)?.set(c[s].feature.attributes[M],c[s].feature);else{let T=new Map;T.set(c[s].feature.attributes[M],c[s].feature),o.set(c[s].typeName,T)}y.set(c[s].feature.attributes[M],c[s].feature);let h=$(c[s].feature.attributes[C]);this.entityLinkChartDiagramLookup.set(c[s].feature.attributes[M],c[s].feature.attributes[C]?h:null);let l=U(this.dataManager.inclusionModeDefinition.namedTypeDefinitions,c[s].typeName,()=>({useAllData:!1,members:new Map}));U(l.members,c[s].feature.attributes[M],()=>({id:c[s].feature.attributes[M],linkChartLocation:void 0})).linkChartLocation=c[s].feature.attributes[C],c[s].feature.attributes[C].x<E.xmin&&(E.xmin=c[s].feature.attributes[C].x),c[s].feature.attributes[C].x>E.xmax&&(E.xmax=c[s].feature.attributes[C].x),c[s].feature.attributes[C].y<E.ymin&&(E.ymin=c[s].feature.attributes[C].y),c[s].feature.attributes[C].y>E.ymax&&(E.ymax=c[s].feature.attributes[C].y)}if(this.linkChartExtent.xmin=E.xmin,this.linkChartExtent.xmax=E.xmax,this.linkChartExtent.ymin=E.ymin,this.linkChartExtent.ymax=E.ymax,!v)throw new X("knowledge-graph:layout-failed","Attempting to retrieve link geometry from diagram engine failed");let te=new Map,he=new Map,de=new Map,we=new Set;for(let s=0;s<t.length;s++){let h=[],l=t[s],T=l.feature.attributes[Y],R=l.feature.attributes[Z],N=T+"-"+R;if(e==="chronological-mono-timeline"||e==="chronological-multi-timeline"){let d=a?.timeInfoByTypeName?.get(l.typeName),S=a?.timeInfoByTypeName?d?.startField:null,G=S?l.feature.attributes[S]:null,B=d?.endField;N+="-"+G+"-"+(B?l.feature.attributes[B]:null)}let I=re.get(N).get(l.typeName),F=I===0?0:v?.vertexEndIndex[I-1];if(!we.has(I)){if(we.add(I),v.types[I]===ye.Recursive){let d=[v.vertices[2*F],v.vertices[2*F+1]],S=[v.vertices[2*(F+1)],v.vertices[2*(F+1)+1]],G=[.5*(d[0]+S[0]),.5*(d[1]+S[1])],B=[G[0]-d[0],G[1]-d[1]],Ze=[G[0]+B[1],G[1]-B[0]],et=[G[0]-B[1],G[1]+B[0]];h.push(d),h.push(Ze),h.push(S),h.push(et),h.push(d)}else{if(v.types[I]!==ye.Regular){x.getLogger(this).warn("A relationship generated an unsupported link geometry type.  It will not be rendered");continue}for(let d=F;d<v.vertexEndIndex[I];d++)h.push([v.vertices[2*d],v.vertices[2*d+1]])}if(e!=="chronological-mono-timeline"&&e!=="chronological-multi-timeline"){let d=c[p.get(T)]?.feature.attributes[C],S=c[p.get(R)]?.feature.attributes[C];h[0][0]===d.x&&h[0][1]===d.y||(h[0]=[d.x,d.y]),h[h.length-1][0]===S.x&&h[h.length-1][1]===S.y||(h[h.length-1]=[S.x,S.y])}for(let d=1;d<h.length-1;d++)h[d][1]>85.5?h[d][1]=85.5:h[d][1]<-85.5&&(h[d][1]=-85.5),h[d][0]>179.9999?h[d][0]=179.9999:h[d][0]<-179.9999&&(h[d][0]=-179.9999);te.has(N)?te.get(N).push(h):te.set(N,[h])}let ae=te.get(N);he.has(N)||(he.set(N,new Map),de.set(N,new Map));let P=he.get(N),z=de.get(N);P.has(l.typeName)||(P.set(l.typeName,ae.shift()),z.set(l.typeName,0));let J=P.get(l.typeName);z.set(l.typeName,z.get(l.typeName)+1);let Me=new ce({paths:[J]});if(l.feature.attributes[C]=Me,r.has(l.typeName))r.get(l.typeName)?.set(l.feature.attributes[M],l.feature);else{let d=new Map;d.set(l.feature.attributes[M],l.feature),r.set(l.typeName,d)}y.set(l.feature.attributes[M],l.feature);let Ce=$(l.feature.attributes[C]);this.relationshipLinkChartDiagramLookup.set(l.feature.attributes[M],l.feature.attributes[C]?Ce:null);let Ye=U(this.dataManager.inclusionModeDefinition.namedTypeDefinitions,l.typeName,()=>({useAllData:!1,members:new Map}));U(Ye.members,l.feature.attributes[M],()=>({id:l.feature.attributes[M],linkChartLocation:void 0})).linkChartLocation=Ce}for(let s of t)s.feature.attributes[Fe]=de.get(s.feature.attributes[Y]+"-"+s.feature.attributes[Z])?.get(s.typeName)??null;return this._currentLinkChartConfig={layoutMode:e,layoutSettings:a?.layoutSettings?.clone()},{nodes:o,links:r,idMap:y}}async applyNewLinkChartLayout(e="organic-standard",a){let i=[];await this._calculateLayoutWithSublayerTimeInfo(e,a),this.layers.forEach(n=>{i.push(n.refreshCachedQueryEngine())}),this.membershipModified=!0,await Promise.all(i),this._refreshNamedTypes()}getCurrentNodeLocations(){let e=new Map;for(let[a,i]of this.dataManager.inclusionModeDefinition?.namedTypeDefinitions.entries()??[])this.dataManager.relationshipTypeNames.has(a)||i?.members?.forEach(n=>{let t=n.linkChartLocation,o,r=n.id;t&&(o="x"in t?{x:t.x,y:t.y}:{x:t.coords[0],y:t.coords[1]},e.set(r,new ne({x:o.x,y:o.y})))});return e}async refreshLinkChartCache(e){await this.dataManager.refreshCacheContent(e);let a=[];this.layers.forEach(i=>{a.push(i.refreshCachedQueryEngine())}),await Promise.all(a),this._refreshNamedTypes()}async connectBetweenEntities(e,a){if(!e.length)return{records:[]};let i=[];try{let n=[];for(let t of this.dataManager.relationshipTypeNames){let o=this.sublayerIdsCache.get(t);o&&(n=n.concat(Array.from(o.keys())))}i=await this.dataManager.getRelationshipsBetweenNodes(e,n,a),await this._handleNewRecords(i,a),H(a)}catch(n){throw ie(n)&&this.removeRecords(i),n}return{records:i}}async connectFromEntities(e,a){if(!e.length)return{records:[]};let i=[];try{let n=[];for(let o of this.dataManager.relationshipTypeNames){let r=this.sublayerIdsCache.get(o);r&&(n=n.concat(Array.from(r.keys())))}let t=[];for(let o of this.dataManager.entityTypeNames){let r=this.sublayerIdsCache.get(o);r&&(t=t.concat(Array.from(r)))}i=await this.dataManager.getRelationshipsFromNodes(e,t,n,a),await this._handleNewRecords(i,a),i.length>0&&(this.membershipModified=!0),H(a)}catch(n){throw ie(n)&&this.removeRecords(i),n}return{records:i}}getCurrentLayout(){return this._currentLinkChartConfig.layoutMode}async _calculateLayoutWithSublayerTimeInfo(e="organic-standard",a){let i=new Map;this.layers.forEach(n=>{i.set(n.objectType.name,n.timeInfo)}),await this.calculateLinkChartLayout(e,pe({timeInfoByTypeName:i},a)),this.linkChart?.handleChronologicalOverlay()}async _handleNewRecords(e,a){let i=[];this.dataManager.addToLayer(e);for(let t of e)this.sublayerIdsCache.has(t.typeName)||(this.sublayerIdsCache.set(t.typeName,new Set),i.push(t.typeName)),this.sublayerIdsCache.get(t.typeName).add(t.id);for(let t of i){let o=this._graphTypeLookup.get(t);if(o){let r=this._createSublayer(o);o.type==="entity"?this.dataManager.entityTypeNames.add(t):this.dataManager.relationshipTypeNames.add(t),r.geometryType?this.layers.push(r):this.tables.push(r),this.dataManager.sublayerCaches.set(t,new Map)}}await me(this,i,a),await this.dataManager.refreshCacheContent(e.map(t=>t.id),void 0,void 0,void 0,a);let n={layoutSettings:this._currentLinkChartConfig.layoutSettings,lockedNodeLocations:new Map};for(let[t,o]of this.entityLinkChartDiagramLookup.entries())o&&n.lockedNodeLocations.set(t,new ne(o.coords[0],o.coords[1]));await this.applyNewLinkChartLayout(this._currentLinkChartConfig.layoutMode,n)}_createSublayers(e,a,i){e.forEach(n=>{let t=this._createSublayer(n);i(t)&&a.push(t),this._updateSublayerCaches(n)})}_updateSublayers(e,a){a.forEach(i=>{i.parentCompositeLayer=this;let n=e.find(t=>t.type===i.graphType&&t.name===i.graphTypeName);n&&(i.objectType=n,i.read({title:n.name},{origin:"service"}),this._updateSublayerCaches(n))})}_updateSublayerCaches(e){let a=this.dataManager.sublayerCaches;a.has(e.name)||a.set(e.name,new Map)}_layersLoadedFromAuthoritativeItem(){let e=this.originIdOf("layers");return e>=W.PORTAL_ITEM&&e<W.USER}async _initializeDiagram(){this.initializationLinkChartConfig?this.initializationLinkChartConfig.doNotRecalculateLayout?(this.dataManager.inclusionModeDefinition?.namedTypeDefinitions?.forEach((e,a)=>{e?.members?.forEach(i=>{let n=i.linkChartLocation,t,o=i.id;if(!n)return;t="x"in n?{x:n.x,y:n.y}:{x:n.coords[0],y:n.coords[1]};let r=$(t);this.dataManager.relationshipTypeNames.has(a)?this.relationshipLinkChartDiagramLookup.set(o,r):this.entityLinkChartDiagramLookup.set(o,r),this.linkChartExtent.xmin>t.x&&(this.linkChartExtent.xmin=t.x),this.linkChartExtent.xmax<t.x&&(this.linkChartExtent.xmax=t.x),this.linkChartExtent.ymin>t.y&&(this.linkChartExtent.ymin=t.y),this.linkChartExtent.ymax<t.y&&(this.linkChartExtent.ymax=t.y)})}),this.memberRelationshipTypes.forEach(e=>{e.name&&this.dataManager.sublayerCaches.get(e.name)?.forEach(a=>{let i=this.relationshipLinkChartDiagramLookup.get(a.attributes[Y]),n=this.relationshipLinkChartDiagramLookup.get(a.attributes[Z]);if(i&&n){let t=$(new ce({paths:[[[i.coords[0],i.coords[1]],[n.coords[0],n.coords[1]]]]}));this.relationshipLinkChartDiagramLookup.set(a.attributes[M],t)}else this.relationshipLinkChartDiagramLookup.set(a.attributes[M],null)})})):await this._calculateLayoutWithSublayerTimeInfo(this.initializationLinkChartConfig.layoutMode,pe({lockedNodeLocations:this.getCurrentNodeLocations()},this.initializationLinkChartConfig||{})):await this._calculateLayoutWithSublayerTimeInfo("organic-standard",{lockedNodeLocations:this.getCurrentNodeLocations()})}_refreshNamedTypes(){for(let e of this.layers)e.emit("refresh",{dataChanged:!0});for(let e of this.tables)e.emit("refresh",{dataChanged:!0})}_validateOrganicLayoutSettings(e,a){let i=k=>typeof k=="number"&&!isNaN(k),n=k=>i(k)&&k>=1,t=k=>i(k)&&k>=1,o=k=>Object.values(K).includes(k),r=k=>i(k)&&k>=0,y={};if(!new Set(["organic-standard","organic-community","geographic-organic-standard","chronological-multi-timeline","chronological-mono-timeline"]).has(e)||!a)return y;let{computationBudgetTime:p,autoRepulsionRadius:m,repulsionRadiusMultiplier:w,absoluteIdealEdgeLength:L,multiplicativeIdealEdgeLength:j,idealEdgeLengthType:_}=a;return t(p)?y.computationBudgetTime=p:p&&x.getLogger(this).warn("Invalid layout computationBudgetTime setting, will revert to default setting"),y.autoRepulsionRadius=m,!m&&n(w)?y.repulsionRadiusMultiplier=w:m||(y.autoRepulsionRadius=!0,x.getLogger(this).warn("Invalid layout repulsionRadiusMultiplier setting, will revert to default setting")),e==="geographic-organic-standard"&&(o(_)?y.idealEdgeLengthType=_:_!==void 0&&x.getLogger(this).warn('Invalid layout idealEdgeLengthType setting, will revert to "multiplier" setting'),_==="absolute-value"&&r(L)?y.absoluteIdealEdgeLength=L:_==="absolute-value"&&L!==void 0?x.getLogger(this).warn("Invalid layout idealEdgeLength setting, will revert to default setting"):_==="multiplier"&&r(j)?y.multiplicativeIdealEdgeLength=j:_==="multiplier"&&j!==void 0&&x.getLogger(this).warn("Invalid layout idealEdgeLength setting, will revert to default setting")),y}_convertValidatedOrganicSettingsToCalculationSettings(e){let a=e.idealEdgeLengthType===K.ABSOLUTE?e.absoluteIdealEdgeLength:e.multiplicativeIdealEdgeLength;return e.idealEdgeLengthType===K.ABSOLUTE&&(a===void 0?a=-1:a*=-1),{computationBudgetTime:e.computationBudgetTime??void 0,repulsionRadiusMultiplier:e.repulsionRadiusMultiplier&&!e.autoRepulsionRadius?e.repulsionRadiusMultiplier:void 0,idealEdgeLengthMultiplier:a}}_createSublayer(e){return new V({objectType:e,parentCompositeLayer:this,graphType:e.type})}_handleSublayersChange(e,a){a&&(a.forEach(i=>{i.parent=null}),this.removeHandles("sublayers-owner")),e&&(e.forEach(i=>{i.parent=this}),this.addHandles([e.on("after-add",({item:i})=>{i.parent=this}),e.on("after-remove",({item:i})=>{i.parent=null})],"sublayers-owner"))}_alignLayersDataModelAndInclusionDefinition(e){let a=new Set((e.entityTypes??[]).map(t=>t.name).concat((e.relationshipTypes??[]).map(t=>t.name))),i=new Set((e.entityTypes??[]).map(t=>t.name)),n=new Set((e.relationshipTypes??[]).map(t=>t.name));if(this.layers){for(let o of this.layers)!o.graphType&&a.has(o.graphTypeName)&&(o.graphType=i.has(o.graphTypeName)?"entity":"relationship");let t=this.layers.filter(o=>a.has(o.graphTypeName)&&(o.graphType==="entity"?i.has(o.graphTypeName):n.has(o.graphTypeName)));this.setAtOrigin("layers",t,ke(this.originIdOf("layers")))}else this.layers=new Q;if(this.layers&&this._originalInclusionList){let t=new Set(this._originalInclusionList.namedTypeDefinitions.keys()),o=this.tables?.map(p=>p.graphTypeName)??[],r=this.layers.map(p=>p.graphTypeName).concat(o);for(let p of r)t.has(p)||this._originalInclusionList.namedTypeDefinitions.set(p,{useAllData:!1,members:new Map});let y=[];for(let p of this._originalInclusionList.namedTypeDefinitions.keys())r.includes(p)||(x.getLogger(this).warn(`A named type, ${p}, was in the serialized feature collection but did not have a sublayer config in the item, so will be removed`),y.push(p));for(let p of y)this._originalInclusionList.namedTypeDefinitions.delete(p)}}};f([b(_e)],g.prototype,"url",void 0),f([b()],g.prototype,"dataPreloadedInLocalCache",void 0),f([b()],g.prototype,"initializationLinkChartConfig",void 0),f([b()],g.prototype,"membershipModified",void 0),f([b()],g.prototype,"dataManager",void 0),f([b()],g.prototype,"initializationInclusionModeDefinition",null),f([b()],g.prototype,"knowledgeGraph",void 0),f([b({type:Q.ofType(V),json:{write:{ignoreOrigin:!0}}})],g.prototype,"layers",void 0),f([b({readOnly:!0})],g.prototype,"linkChart",null),f([b()],g.prototype,"entityLinkChartDiagramLookup",void 0),f([b()],g.prototype,"relationshipLinkChartDiagramLookup",void 0),f([b()],g.prototype,"linkChartExtent",void 0),f([b()],g.prototype,"memberEntityTypes",void 0),f([b()],g.prototype,"memberRelationshipTypes",void 0),f([b({type:["LinkChartLayer"]})],g.prototype,"operationalLayerType",void 0),f([b()],g.prototype,"sublayerIdsCache",void 0),f([b({type:Q.ofType(V),json:{write:{ignoreOrigin:!0}}})],g.prototype,"tables",void 0),f([b({json:{read:!1}})],g.prototype,"type",void 0),f([b({json:{read:!1}})],g.prototype,"chronologicalAuxiliaryGraphics",void 0),g=f([Ne("esri.layers.LinkChartLayer")],g);var Rt=g;export{Rt as default};
