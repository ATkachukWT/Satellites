import{b as G,c as g}from"./chunk-2I3LIA7G.js";import{a as S}from"./chunk-LCFWGHLF.js";import{c as F}from"./chunk-PM3EZWDJ.js";import{b as D}from"./chunk-BHB4UQZT.js";import{a as T}from"./chunk-ALWV3RJ2.js";import{a as b,b as P}from"./chunk-VTGWQ7AP.js";import{k as U}from"./chunk-XRRQM4E2.js";import{a as I}from"./chunk-RWCIDBNQ.js";import{b as z}from"./chunk-4G7UTTZJ.js";import{a as _}from"./chunk-ZTOZWLEE.js";import{a as R}from"./chunk-BOVYXYHK.js";import{v as O}from"./chunk-CKJ56T2Q.js";import{r as A}from"./chunk-UHRSAPGQ.js";function ae(e,t,n,r,o,a,s,i,l,f,c){let m=K[c.mode],u,d,p=0;if(U(e,t,n,r,l.spatialReference,o,i))return m?.requiresAlignment(c)?(p=m.applyElevationAlignmentBuffer(r,o,a,s,i,l,f,c),u=a,d=s):(u=r,d=o),U(u,l.spatialReference,d,a,f.spatialReference,s,i)?p:void 0}function N(e,t,n,r,o){let a=(S(e)?e.z:G(e)?e.array[e.offset+2]:e[2])||0;switch(n.mode){case"on-the-ground":{let s=g(t,e,"ground")??0;return o.verticalDistanceToGround=0,o.sampledElevation=s,void(o.z=s)}case"relative-to-ground":{let s=g(t,e,"ground")??0,i=n.geometryZWithOffset(a,r);return o.verticalDistanceToGround=i,o.sampledElevation=s,void(o.z=i+s)}case"relative-to-scene":{let s=g(t,e,"scene")??0,i=n.geometryZWithOffset(a,r);return o.verticalDistanceToGround=i,o.sampledElevation=s,void(o.z=i+s)}case"absolute-height":{let s=n.geometryZWithOffset(a,r),i=g(t,e,"ground")??0;return o.verticalDistanceToGround=s-i,o.sampledElevation=i,void(o.z=s)}default:return void(o.z=0)}}function le(e,t,n,r){return N(e,t,n,r,E),E.z}function ue(e,t,n){return t==="on-the-ground"&&n==="on-the-ground"?e.staysOnTheGround:t===n||t!=="on-the-ground"&&n!=="on-the-ground"?t==null||n==null?e.definedChanged:C.UPDATE:e.onTheGroundChanged}function fe(e){return e==="relative-to-ground"||e==="relative-to-scene"}function ce(e){return e!=="absolute-height"}function de(e,t,n,r,o){N(t,n,o,r,E),j(e,E.verticalDistanceToGround);let a=E.sampledElevation,s=_(Q,e.transformation);return v[0]=t.x,v[1]=t.y,v[2]=E.z,D(t.spatialReference,v,s,r.spatialReference)?e.transformation=s:console.warn("Could not locate symbol object properly, it might be misplaced"),a}function j(e,t){for(let n=0;n<e.geometries.length;++n){let r=e.geometries[n].getMutableAttribute(I.CENTEROFFSETANDDISTANCE);r&&r.data[3]!==t&&(r.data[3]=t,e.geometryVertexAttributeUpdated(e.geometries[n],I.CENTEROFFSETANDDISTANCE))}}function k(e,t,n,r,o,a){let s=0,i=a.spatialReference;t*=3,r*=3;for(let l=0;l<o;++l){let f=e[t],c=e[t+1],m=e[t+2],u=a.getElevation(f,c,m,i,"ground")??0;s+=u,n[r]=f,n[r+1]=c,n[r+2]=u,t+=3,r+=3}return s/o}function H(e,t,n,r,o,a,s,i){let l=0,f=i.calculateOffsetRenderUnits(s),c=i.featureExpressionInfoContext,m=a.spatialReference;t*=3,r*=3;for(let u=0;u<o;++u){let d=e[t],p=e[t+1],x=e[t+2],h=a.getElevation(d,p,x,m,"ground")??0;l+=h,n[r]=d,n[r+1]=p,n[r+2]=c==null?x+h+f:h+f,t+=3,r+=3}return l/o}function L(e,t,n,r,o,a,s,i){let l=0,f=i.calculateOffsetRenderUnits(s),c=i.featureExpressionInfoContext,m=a.spatialReference;t*=3,r*=3;for(let u=0;u<o;++u){let d=e[t],p=e[t+1],x=e[t+2],h=a.getElevation(d,p,x,m,"scene")??0;l+=h,n[r]=d,n[r+1]=p,n[r+2]=c==null?x+h+f:h+f,t+=3,r+=3}return l/o}function $(e){let t=e.meterUnitOffset,n=e.featureExpressionInfoContext;return t!==0||n!=null}function J(e,t,n,r,o,a,s,i){let l=i.calculateOffsetRenderUnits(s),f=i.featureExpressionInfoContext;t*=3,r*=3;for(let c=0;c<o;++c){let m=e[t],u=e[t+1],d=e[t+2];n[r]=m,n[r+1]=u,n[r+2]=f==null?d+l:l,t+=3,r+=3}return 0}var y=class{constructor(){this.verticalDistanceToGround=0,this.sampledElevation=0,this.z=0}},C;(function(e){e[e.NONE=0]="NONE",e[e.UPDATE=1]="UPDATE",e[e.RECREATE=2]="RECREATE"})(C||(C={}));var K={"absolute-height":{applyElevationAlignmentBuffer:J,requiresAlignment:$},"on-the-ground":{applyElevationAlignmentBuffer:k,requiresAlignment:()=>!0},"relative-to-ground":{applyElevationAlignmentBuffer:H,requiresAlignment:()=>!0},"relative-to-scene":{applyElevationAlignmentBuffer:L,requiresAlignment:()=>!0}},Q=T(),E=new y,v=R();var X=()=>A.getLogger("esri.views.3d.layers.graphics.featureExpressionInfoUtils");function w(e){return{cachedResult:e.cachedResult,arcade:e.arcade?{func:e.arcade.func,context:e.arcade.modules.arcadeUtils.createExecContext(null,{sr:e.arcade.context.spatialReference}),modules:e.arcade.modules}:null}}function ge(e){let t=e?.expression;if(typeof t=="string"){let n=W(t);if(n!=null)return{cachedResult:n}}return null}async function ve(e,t,n,r){let o=e?.expression;if(typeof o!="string")return null;let a=W(o);if(a!=null)return{cachedResult:a};let s=await z();O(n);let i=s.arcadeUtils,l=i.createSyntaxTree(o);return i.dependsOnView(l)?(r?.error("Expressions containing '$view' are not supported on ElevationInfo"),{cachedResult:0}):{arcade:{func:i.createFunction(l),context:i.createExecContext(null,{sr:t}),modules:s}}}function q(e,t,n){return e.arcadeUtils.createFeature(t.attributes,t.geometry,n)}function B(e,t){if(e!=null&&!V(e)){if(!t||!e.arcade)return void X().errorOncePerTick("Arcade support required but not provided");let n=t;n._geometry&&(n._geometry=F(n._geometry)),e.arcade.modules.arcadeUtils.updateExecContext(e.arcade.context,t)}}function M(e){if(e!=null){if(V(e))return e.cachedResult;let t=e.arcade,n=t?.modules.arcadeUtils.executeFunction(t.func,t.context);return typeof n!="number"&&(e.cachedResult=0,n=0),n}return 0}function Ue(e,t=!1){let n=e?.featureExpressionInfo,r=n?.expression;return t||r==="0"||(n=null),n??null}var Ie={cachedResult:0};function V(e){return e.cachedResult!=null}function W(e){return e==="0"?0:null}var Z=class e{constructor(){this._meterUnitOffset=0,this._renderUnitOffset=0,this._unit="meters",this._metersPerElevationInfoUnit=1,this._featureExpressionInfoContext=null,this.centerPointInElevationSR=null,this.mode=null}get featureExpressionInfoContext(){return this._featureExpressionInfoContext}get meterUnitOffset(){return this._meterUnitOffset}get unit(){return this._unit}set unit(t){this._unit=t,this._metersPerElevationInfoUnit=P(t)}get requiresSampledElevationInfo(){return this.mode!=="absolute-height"}reset(){this.mode=null,this._meterUnitOffset=0,this._renderUnitOffset=0,this._featureExpressionInfoContext=null,this.unit="meters"}set offsetMeters(t){this._meterUnitOffset=t,this._renderUnitOffset=0}set offsetElevationInfoUnits(t){this._meterUnitOffset=t*this._metersPerElevationInfoUnit,this._renderUnitOffset=0}addOffsetRenderUnits(t){this._renderUnitOffset+=t}geometryZWithOffset(t,n){let r=this.calculateOffsetRenderUnits(n);return this.featureExpressionInfoContext!=null?r:t+r}calculateOffsetRenderUnits(t){let n=this._meterUnitOffset,r=this.featureExpressionInfoContext;return r!=null&&(n+=M(r)*this._metersPerElevationInfoUnit),n/t.unitInMeters+this._renderUnitOffset}setFromElevationInfo(t){this.mode=t.mode,this.unit=b(t.unit)?t.unit:"meters",this.offsetElevationInfoUnits=t.offset??0}updateFeatureExpressionInfoContext(t,n,r){if(t==null)return void(this._featureExpressionInfoContext=null);let o=t?.arcade;o&&n!=null&&r!=null?(this._featureExpressionInfoContext=w(t),B(this._featureExpressionInfoContext,q(o.modules,n,r))):this._featureExpressionInfoContext=t}static fromElevationInfo(t){let n=new e;return t!=null&&n.setFromElevationInfo(t),n}};export{ae as a,N as b,le as c,ue as d,fe as e,ce as f,de as g,j as h,y as i,C as j,ge as k,ve as l,q as m,B as n,Ue as o,Ie as p,Z as q};
