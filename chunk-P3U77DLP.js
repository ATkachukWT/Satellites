import{a as v,b as u}from"./chunk-GKGOQTV6.js";import"./chunk-WFQUCDHF.js";import{a as R}from"./chunk-EIMGIIJ4.js";import{b as M}from"./chunk-JVPRAOU2.js";import{a as q}from"./chunk-JUMM5VTE.js";import"./chunk-3ABIMFDV.js";import"./chunk-W3HXXDUN.js";import"./chunk-P5DBP5G4.js";import"./chunk-QC6ZIWCS.js";import"./chunk-Q4D6RBGT.js";import"./chunk-5IYUVR2B.js";import"./chunk-ASWKMS6K.js";import"./chunk-WH5SLVE3.js";import"./chunk-CUJ2T6EE.js";import"./chunk-JXEAVWUK.js";import"./chunk-NGQW42AK.js";import"./chunk-M6OVPXT3.js";import"./chunk-UPU3OYP4.js";import"./chunk-FLXA3YE2.js";import"./chunk-BFOAQMH4.js";import"./chunk-OWY34DUP.js";import"./chunk-4TIUXNXO.js";import"./chunk-CEAEFIX3.js";import"./chunk-ULWS5HLW.js";import"./chunk-KE2U7ENE.js";import"./chunk-PSFZFYFC.js";import"./chunk-PMLKCTEJ.js";import"./chunk-MYO2G5ZH.js";import"./chunk-A45BLB26.js";import"./chunk-BPX3YT3K.js";import"./chunk-QXNVQZT7.js";import"./chunk-BYXBJQAS.js";import"./chunk-JLWYDAJB.js";import{a as V,b as x}from"./chunk-ZH7647AP.js";import{b as T}from"./chunk-MKPAHACK.js";import"./chunk-4D3QHJI2.js";import"./chunk-E2J2V7JN.js";import{a as c}from"./chunk-G7RYJIRW.js";import"./chunk-37H4LYIE.js";import"./chunk-VYZHOYXV.js";import"./chunk-X7BNFUFQ.js";import"./chunk-XAHD7XBV.js";import"./chunk-U7PX7SHO.js";import"./chunk-HBZAOVHW.js";import"./chunk-PMVQ5DJK.js";import"./chunk-L2WNUKLP.js";import"./chunk-63B3IOWG.js";import"./chunk-KAMRW6HF.js";import"./chunk-DJW5LMRG.js";import"./chunk-DVBZA6ZU.js";import{d as S}from"./chunk-KRAKR4MK.js";import"./chunk-MCO7DSFO.js";import"./chunk-D7WE3OBT.js";import"./chunk-2NP7F5RO.js";import"./chunk-7QY3BMVN.js";import"./chunk-XEZTJAR4.js";import"./chunk-BUP3AMMF.js";import"./chunk-XCIPBOI4.js";import"./chunk-KD27XIJC.js";import"./chunk-W5OI4BJ2.js";import"./chunk-HM5RIVQC.js";import"./chunk-EM35R6FY.js";import"./chunk-QXXXCEV5.js";import"./chunk-6B5XFA6F.js";import"./chunk-RZF6KTKU.js";import"./chunk-OLOKUDVI.js";import"./chunk-ZTOZWLEE.js";import"./chunk-RJWOVI3M.js";import"./chunk-RSDQHAJX.js";import"./chunk-BOVYXYHK.js";import"./chunk-FENRIY2T.js";import"./chunk-HX2VGIR2.js";import"./chunk-JGEVVXD4.js";import"./chunk-B3FO6PT7.js";import"./chunk-C4UMJHQC.js";import"./chunk-BCREO4Q5.js";import"./chunk-LXFQWIWE.js";import"./chunk-QT6UNBJP.js";import"./chunk-MWSXMSWY.js";import"./chunk-JRCKELO6.js";import"./chunk-YR2HD3ZC.js";import"./chunk-GJASVPF6.js";import"./chunk-NMRTZBDM.js";import"./chunk-NI7FJV5X.js";import"./chunk-BUSG3ZOF.js";import"./chunk-XZIOXVVJ.js";import"./chunk-LFH24RLM.js";import"./chunk-Z5Q7KLA4.js";import"./chunk-X4LNX4BR.js";import"./chunk-4XZ6X7MQ.js";import"./chunk-WLHY3MMA.js";import{m as s}from"./chunk-KGVXGH6H.js";import"./chunk-ARRCN5K3.js";import"./chunk-LXQPIAN7.js";import"./chunk-DB3UIQCU.js";import"./chunk-SBHKMV3P.js";import"./chunk-R4A63S45.js";import"./chunk-ETE32IYO.js";import"./chunk-ONUGDWDK.js";import"./chunk-SG7CQU4O.js";import{H as g}from"./chunk-QHVIRF5H.js";import{I}from"./chunk-WZDN6K3C.js";import{a as o}from"./chunk-QGVBCWUY.js";import"./chunk-OJQ73TPF.js";import"./chunk-354SCPDU.js";import"./chunk-OVHPPCBL.js";import"./chunk-IYZFKXJ6.js";import{D as n}from"./chunk-CKJ56T2Q.js";import"./chunk-SNFOAZZQ.js";import"./chunk-F6JAWRPN.js";import{r as w}from"./chunk-UHRSAPGQ.js";import"./chunk-V76GWARL.js";import{a as y,b as _}from"./chunk-N2WTMF3X.js";var b=[0,0],r=class extends R(v(M(q))){constructor(){super(...arguments),this._tileStrategy=null,this._fetchQueue=null,this.layer=null}get tileMatrixSet(){let{activeLayer:e}=this.layer,{tileMatrixSet:t}=e;if(t&&s(t.tileInfo?.spatialReference,this.view.spatialReference))return t;let i=this._getTileMatrixSetBySpatialReference(e);return i&&i.id!==e.tileMatrixSetId?(e.tileMatrixSetId=i.id,i):null}update(e){this._fetchQueue.pause(),this._fetchQueue.state=e.state,this._tileStrategy.update(e),this._fetchQueue.resume()}attach(){let e=this.tileMatrixSet?.tileInfo;e&&(this._tileInfoView=new T(e),this._fetchQueue=new V({tileInfoView:this._tileInfoView,concurrency:16,process:(t,i)=>this.fetchTile(t,i),scheduler:this.scheduler,priority:S.MAPVIEW_FETCH_QUEUE}),this._tileStrategy=new x({cachePolicy:"keep",resampling:!0,acquireTile:t=>this.acquireTile(t),releaseTile:t=>this.releaseTile(t),tileInfoView:this._tileInfoView}),this.addAttachHandles(this._updatingHandles.add(()=>[this.layer?.activeLayer?.styleId,this.tileMatrixSet],()=>this.doRefresh())),super.attach())}detach(){super.detach(),this._tileStrategy?.destroy(),this._fetchQueue?.destroy(),this._fetchQueue=this._tileStrategy=this._tileInfoView=null}viewChange(){this.requestUpdate()}moveEnd(){this.requestUpdate()}supportsSpatialReference(e){return this.layer.activeLayer.tileMatrixSets?.some(t=>s(t.tileInfo?.spatialReference,e))??!1}async doRefresh(){if(this.attached){if(this.suspended)return this._tileStrategy.clear(),void this.requestUpdate();this._fetchQueue.reset(),this._tileStrategy.refresh(e=>this._updatingHandles.addPromise(this._enqueueTileFetch(e)))}}acquireTile(e){let t=this._bitmapView.createTile(e),i=t.bitmap;return[i.x,i.y]=this._tileInfoView.getTileCoords(b,t.key),i.resolution=this._tileInfoView.getTileResolution(t.key),[i.width,i.height]=this._tileInfoView.tileInfo.size,this._updatingHandles.addPromise(this._enqueueTileFetch(t)),this._bitmapView.addChild(t),this.requestUpdate(),t}releaseTile(e){this._fetchQueue.abort(e.key.id),this._bitmapView.removeChild(e),e.once("detach",()=>e.destroy()),this.requestUpdate()}async fetchTile(e,t={}){let i="tilemapCache"in this.layer?this.layer.tilemapCache:null,{signal:a,resamplingLevel:f=0}=t;if(!i)return this._fetchImage(e,a);let l=new c(0,0,0,0),p;try{await i.fetchAvailabilityUpsample(e.level,e.row,e.col,l,{signal:a}),p=await this._fetchImage(l,a)}catch(h){if(n(h))throw h;if(f<3){let m=this._tileInfoView.getTileParentId(e.id);if(m){let d=new c(m),Q=await this.fetchTile(d,_(y({},t),{resamplingLevel:f+1}));return u(this._tileInfoView,Q,d,e)}}throw h}return u(this._tileInfoView,p,l,e)}canResume(){let e=super.canResume();return e&&this.tileMatrixSet!==null}async _enqueueTileFetch(e){if(!this._fetchQueue.has(e.key.id)){try{let t=await this._fetchQueue.push(e.key);e.bitmap.source=t,e.bitmap.width=this._tileInfoView.tileInfo.size[0],e.bitmap.height=this._tileInfoView.tileInfo.size[1],e.once("attach",()=>this.requestUpdate())}catch(t){n(t)||w.getLogger(this).error(t)}this.requestUpdate()}}async _fetchImage(e,t){return this.layer.fetchImageBitmapTile(e.level,e.row,e.col,{signal:t})}_getTileMatrixSetBySpatialReference(e){return e.tileMatrixSets?.find(t=>s(t.tileInfo?.spatialReference,this.view.spatialReference))}};o([g({readOnly:!0})],r.prototype,"tileMatrixSet",null),r=o([I("esri.views.2d.layers.WMTSLayerView2D")],r);var N=r;export{N as default};
