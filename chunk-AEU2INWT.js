import{c as $,d as J}from"./chunk-Z4UBZ6W2.js";import{a as q}from"./chunk-3J3Q4LMA.js";import{a as f}from"./chunk-PSNQ2KG3.js";import{b as j,e as _}from"./chunk-PMLKCTEJ.js";import{i as k}from"./chunk-MYO2G5ZH.js";import{a as z,b as W}from"./chunk-YU3IFRYW.js";import{h as g}from"./chunk-ONYJLWAD.js";import{a as K}from"./chunk-PDQQY7RQ.js";import{k as d,l as M,n as u,z as m}from"./chunk-HM5RIVQC.js";import{a as V}from"./chunk-GJASVPF6.js";import{b as X}from"./chunk-R4A63S45.js";import{C as O}from"./chunk-ETE32IYO.js";import{A as G,z as F}from"./chunk-ONUGDWDK.js";import{A as b,c as H,d as L,u as v,v as S}from"./chunk-CKJ56T2Q.js";import{r as U,t as N}from"./chunk-UHRSAPGQ.js";import{A,y as E}from"./chunk-V76GWARL.js";import{a as R}from"./chunk-N2WTMF3X.js";function Y(){return Q??=(async()=>{let a=await import("./chunk-BAIWRDOR.js"),t=await a.default({locateFile:e=>X(`esri/libs/basisu/${e}`)});return t.initializeBasis(),t})(),Q}var Q;var h=null,I=null;async function Z(){return I==null&&(I=Y(),h=await I),I}function tt(a,t){if(h==null)return a.byteLength;let e=new h.BasisFile(new Uint8Array(a)),r=at(e)?rt(e.getNumLevels(0),e.getHasAlpha(),e.getImageWidth(0,0),e.getImageHeight(0,0),t):0;return e.close(),e.delete(),r}function et(a,t){if(h==null)return a.byteLength;let e=new h.KTX2File(new Uint8Array(a)),r=st(e)?rt(e.getLevels(),e.getHasAlpha(),e.getWidth(),e.getHeight(),t):0;return e.close(),e.delete(),r}function rt(a,t,e,r,s){let i=k(t?m.COMPRESSED_RGBA8_ETC2_EAC:m.COMPRESSED_RGB8_ETC2),o=s&&a>1?(4**a-1)/(3*4**(a-1)):1;return Math.ceil(e*r*i*o)}function at(a){return a.getNumImages()>=1&&!a.isUASTC()}function st(a){return a.getFaces()>=1&&a.isETC1S()}async function it(a,t,e){h==null&&(h=await Z());let r=new h.BasisFile(new Uint8Array(e));if(!at(r))return null;r.startTranscoding();let s=nt(a,t,r.getNumLevels(0),r.getHasAlpha(),r.getImageWidth(0,0),r.getImageHeight(0,0),(i,o)=>r.getImageTranscodedSizeInBytes(0,i,o),(i,o,n)=>r.transcodeImage(n,0,i,o,0,0));return r.close(),r.delete(),s}async function ot(a,t,e){h==null&&(h=await Z());let r=new h.KTX2File(new Uint8Array(e));if(!st(r))return null;r.startTranscoding();let s=nt(a,t,r.getLevels(),r.getHasAlpha(),r.getWidth(),r.getHeight(),(i,o)=>r.getImageTranscodedSizeInBytes(i,0,0,o),(i,o,n)=>r.transcodeImage(n,i,0,0,o,0,-1,-1));return r.close(),r.delete(),s}function nt(a,t,e,r,s,i,o,n){let{compressedTextureETC:l,compressedTextureS3TC:D}=a.capabilities,[T,y]=l?r?[f.ETC2_RGBA,m.COMPRESSED_RGBA8_ETC2_EAC]:[f.ETC1_RGB,m.COMPRESSED_RGB8_ETC2]:D?r?[f.BC3_RGBA,m.COMPRESSED_RGBA_S3TC_DXT5_EXT]:[f.BC1_RGB,m.COMPRESSED_RGB_S3TC_DXT1_EXT]:[f.RGBA32,u.RGBA],x=t.hasMipmap?e:Math.min(1,e),c=[];for(let p=0;p<x;p++)c.push(new Uint8Array(o(p,T))),n(p,T,c[p]);return t.internalFormat=y,t.hasMipmap=c.length>1,t.samplingMode=t.hasMipmap?d.LINEAR_MIPMAP_LINEAR:d.LINEAR,t.width=s,t.height=i,new _(a,t,{type:"compressed",levels:c})}var w=()=>U.getLogger("esri.views.3d.webgl-engine.lib.DDSUtil"),dt=542327876,pt=131072,ut=4;function B(a){return a.charCodeAt(0)+(a.charCodeAt(1)<<8)+(a.charCodeAt(2)<<16)+(a.charCodeAt(3)<<24)}function _t(a){return String.fromCharCode(255&a,a>>8&255,a>>16&255,a>>24&255)}var ct=B("DXT1"),gt=B("DXT3"),Tt=B("DXT5"),Et=31,At=0,ft=1,Dt=2,xt=3,Ct=4,yt=7,Mt=20,It=21;function lt(a,t,e){let r=wt(e,t.hasMipmap??!1);if(r==null)throw new Error("DDS texture data is null");let{textureData:s,internalFormat:i,width:o,height:n}=r;return t.samplingMode=s.levels.length>1?d.LINEAR_MIPMAP_LINEAR:d.LINEAR,t.hasMipmap=s.levels.length>1,t.internalFormat=i,t.width=o,t.height=n,new _(a,t,s)}function wt(a,t){let e=new Int32Array(a.buffer,a.byteOffset,Et);if(e[At]!==dt)return w().error("Invalid magic number in DDS header"),null;if(!(e[Mt]&ut))return w().error("Unsupported format, must contain a FourCC code"),null;let r=e[It],s,i;switch(r){case ct:s=8,i=m.COMPRESSED_RGB_S3TC_DXT1_EXT;break;case gt:s=16,i=m.COMPRESSED_RGBA_S3TC_DXT3_EXT;break;case Tt:s=16,i=m.COMPRESSED_RGBA_S3TC_DXT5_EXT;break;default:return w().error("Unsupported FourCC code:",_t(r)),null}let o=1,n=e[Ct],l=e[xt];(3&n||3&l)&&(w().warn("Rounding up compressed texture size to nearest multiple of 4."),n=n+3&-4,l=l+3&-4);let D=n,T=l,y,x;e[Dt]&pt&&t!==!1&&(o=Math.max(1,e[yt]));let c=a.byteOffset+e[ft]+4,p=[];for(let P=0;P<o;++P)x=(n+3>>2)*(l+3>>2)*s,y=new Uint8Array(a.buffer,c,x),p.push(y),c+=x,n=Math.max(1,n>>1),l=Math.max(1,l>>1);return{textureData:{type:"compressed",levels:p},internalFormat:i,width:D,height:T}}var mt=class extends z{constructor(t,e){super(),this._data=t,this.type=W.Texture,this.events=new V,this._glTexture=null,this._loadingPromise=null,this._loadingController=null,this._parameters=R(R({},St),e),this._startPreload(t)}dispose(){this.unload(),this._data=this.frameUpdate=void 0}_startPreload(t){t!=null&&(t instanceof HTMLVideoElement?(this.frameUpdate=e=>this._frameUpdate(t,e),this._startPreloadVideoElement(t)):t instanceof HTMLImageElement&&this._startPreloadImageElement(t))}_startPreloadVideoElement(t){if(!(F(t.src)||t.preload==="auto"&&t.crossOrigin)){t.preload="auto",t.crossOrigin="anonymous";let e=!t.paused;if(t.src=t.src,e&&t.autoplay){let r=()=>{t.removeEventListener("canplay",r),t.play()};t.addEventListener("canplay",r)}}}_startPreloadImageElement(t){G(t.src)||F(t.src)||t.crossOrigin||(t.crossOrigin="anonymous",t.src=t.src)}_createDescriptor(t){let e=new j;return e.wrapMode=this._parameters.wrap??M.REPEAT,e.flipped=!this._parameters.noUnpackFlip,e.samplingMode=this._parameters.mipmap?d.LINEAR_MIPMAP_LINEAR:d.LINEAR,e.hasMipmap=!!this._parameters.mipmap,e.preMultiplyAlpha=!!this._parameters.preMultiplyAlpha,e.maxAnisotropy=this._parameters.maxAnisotropy??(this._parameters.mipmap?t.parameters.maxMaxAnisotropy:1),e}get glTexture(){return this._glTexture}get memoryEstimate(){return this._glTexture?.usedMemory||Rt(this._data,this._parameters)}load(t){if(this._glTexture)return this._glTexture;if(this._loadingPromise)return this._loadingPromise;let e=this._data;return e==null?(this._glTexture=new _(t,this._createDescriptor(t),null),this._glTexture):(this._parameters.reloadable||(this._data=void 0),typeof e=="string"?this._loadFromURL(t,e):e instanceof Image?this._loadFromImageElement(t,e):e instanceof HTMLVideoElement?this._loadFromVideoElement(t,e):e instanceof ImageData||e instanceof HTMLCanvasElement?this._loadFromImage(t,e):A(e)&&this._parameters.encoding===g.DDS_ENCODING?this._loadFromDDSData(t,e):E(e)&&this._parameters.encoding===g.DDS_ENCODING?this._loadFromDDSData(t,new Uint8Array(e)):(E(e)||A(e))&&this._parameters.encoding===g.KTX2_ENCODING?this._loadFromKTX2(t,e):(E(e)||A(e))&&this._parameters.encoding===g.BASIS_ENCODING?this._loadFromBasis(t,e):A(e)?this._loadFromPixelData(t,e):E(e)?this._loadFromPixelData(t,new Uint8Array(e)):null)}_frameUpdate(t,e){return this._glTexture==null||t.readyState<C.HAVE_CURRENT_DATA||e===t.currentTime?e:(this._glTexture.setData(t),this._glTexture.descriptor.hasMipmap&&this._glTexture.generateMipmap(),this._parameters.updateCallback&&this._parameters.updateCallback(),t.currentTime)}_loadFromDDSData(t,e){return this._glTexture=lt(t,this._createDescriptor(t),e),this._glTexture}_loadFromKTX2(t,e){return this._loadAsync(()=>ot(t,this._createDescriptor(t),e).then(r=>(this._glTexture=r,r)))}_loadFromBasis(t,e){return this._loadAsync(()=>it(t,this._createDescriptor(t),e).then(r=>(this._glTexture=r,r)))}_loadFromPixelData(t,e){K(this._parameters.width>0&&this._parameters.height>0);let r=this._createDescriptor(t);return r.pixelFormat=this._parameters.components===1?u.LUMINANCE:this._parameters.components===3?u.RGB:u.RGBA,r.width=this._parameters.width??0,r.height=this._parameters.height??0,this._glTexture=new _(t,r,e),this._glTexture}_loadFromURL(t,e){return this._loadAsync(async r=>{let s=await q(e,{signal:r});return S(r),this._loadFromImage(t,s)})}_loadFromImageElement(t,e){return e.complete?this._loadFromImage(t,e):this._loadAsync(async r=>{let s=await O(e,e.src,!1,r);return S(r),this._loadFromImage(t,s)})}_loadFromVideoElement(t,e){return e.readyState>=C.HAVE_CURRENT_DATA?this._loadFromImage(t,e):this._loadFromVideoElementAsync(t,e)}_loadFromVideoElementAsync(t,e){return this._loadAsync(r=>new Promise((s,i)=>{let o=()=>{e.removeEventListener("loadeddata",n),e.removeEventListener("error",l),L(D)},n=()=>{e.readyState>=C.HAVE_CURRENT_DATA&&(o(),s(this._loadFromImage(t,e)))},l=T=>{o(),i(T||new N("Failed to load video"))};e.addEventListener("loadeddata",n),e.addEventListener("error",l);let D=b(r,()=>l(v()))}))}_loadFromImage(t,e){let r=e;if(!(r instanceof HTMLVideoElement)){let{maxTextureSize:o}=t.parameters;r=this._parameters.downsampleUncompressed?$(r,o):J(r,o)}let s=ht(r);this._parameters.width=s.width,this._parameters.height=s.height;let i=this._createDescriptor(t);return i.pixelFormat=this._parameters.components===3?u.RGB:u.RGBA,i.width=s.width,i.height=s.height,i.shouldCompress=this._parameters.shouldCompress,this._glTexture=new _(t,i,r),this._glTexture}_loadAsync(t){let e=new AbortController;this._loadingController=e;let r=t(e.signal);this._loadingPromise=r;let s=()=>{this._loadingController===e&&(this._loadingController=null),this._loadingPromise===r&&(this._loadingPromise=null)};return r.then(s,s),r}unload(){if(this._glTexture=H(this._glTexture),this._loadingController!=null){let t=this._loadingController;this._loadingController=null,this._loadingPromise=null,t.abort()}this.events.emit("unloaded")}get parameters(){return this._parameters}};function Rt(a,t){if(a==null)return 0;if(E(a)||A(a))return t.encoding===g.KTX2_ENCODING?et(a,!!t.mipmap):t.encoding===g.BASIS_ENCODING?tt(a,!!t.mipmap):a.byteLength;let{width:e,height:r}=a instanceof Image||a instanceof ImageData||a instanceof HTMLCanvasElement||a instanceof HTMLVideoElement?ht(a):t;return(t.mipmap?4/3:1)*e*r*(t.components||4)||0}function ht(a){return a instanceof HTMLVideoElement?{width:a.videoWidth,height:a.videoHeight}:a}var C;(function(a){a[a.HAVE_NOTHING=0]="HAVE_NOTHING",a[a.HAVE_METADATA=1]="HAVE_METADATA",a[a.HAVE_CURRENT_DATA=2]="HAVE_CURRENT_DATA",a[a.HAVE_FUTURE_DATA=3]="HAVE_FUTURE_DATA",a[a.HAVE_ENOUGH_DATA=4]="HAVE_ENOUGH_DATA"})(C||(C={}));var St={wrap:{s:M.REPEAT,t:M.REPEAT},mipmap:!0,noUnpackFlip:!1,preMultiplyAlpha:!1,downsampleUncompressed:!1,shouldCompress:!1};export{Z as a,mt as b};
