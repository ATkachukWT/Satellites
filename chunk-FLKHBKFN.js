import{a as T}from"./chunk-322WAKKC.js";import{a as he,b as ce,c as de}from"./chunk-6KU27KDM.js";import{a as ue,c as pe,e as ye}from"./chunk-NTZN6TGL.js";import{a as me,b as ge,c as F}from"./chunk-ZIK4TOX5.js";import{a as re}from"./chunk-4Y7EKSO4.js";import{a as X}from"./chunk-KRX2B2DE.js";import{c as K}from"./chunk-IE6LCR36.js";import{a as ae,b as oe}from"./chunk-R2HHW4XT.js";import{b as le}from"./chunk-LG7DXNE4.js";import{a as se}from"./chunk-2DH3L3DZ.js";import{a as ne}from"./chunk-5DVGZXEZ.js";import{c as ie}from"./chunk-6SGUOKGX.js";import{h as te}from"./chunk-KE2U7ENE.js";import{a as w}from"./chunk-HBMVPT4U.js";import{d as Q}from"./chunk-PFSX77NO.js";import{a as G}from"./chunk-WPZN772I.js";import{a as ee}from"./chunk-3REMXE4W.js";import{a as x}from"./chunk-DVBZA6ZU.js";import{b as C}from"./chunk-TBA3OZMJ.js";import{a as $}from"./chunk-NQWYPF77.js";import{d as Y}from"./chunk-KRAKR4MK.js";import{a as W}from"./chunk-CDP4MSRO.js";import{g as B,h as Z}from"./chunk-XCIPBOI4.js";import{c as z}from"./chunk-HP4LYRR4.js";import{b as V}from"./chunk-AFC2H4Q3.js";import{a as _,b as j,i as d}from"./chunk-MWSXMSWY.js";import{m as L}from"./chunk-LFH24RLM.js";import{f as J,g as k}from"./chunk-Z5Q7KLA4.js";import{a as U}from"./chunk-LXQPIAN7.js";import{H as n,J as E}from"./chunk-QHVIRF5H.js";import{I as m}from"./chunk-WZDN6K3C.js";import{a as s}from"./chunk-QGVBCWUY.js";import{F as I,b,d as P,j as q,v as R,y as D,z as N}from"./chunk-CKJ56T2Q.js";import{r as M}from"./chunk-UHRSAPGQ.js";import{a as y,b as f}from"./chunk-N2WTMF3X.js";var S=class{constructor(t){this._cache=t.newCache("QueryEngine",null,-1)}clear(){this._cache.clear()}destroy(){this._cache.destroy()}get(t){return this._cache.get(t)?.items}put(t,a){this._cache.put(t,new H(a))}get test(){}},H=class{constructor(t){this.items=t}get cachedMemory(){return this.items.reduce((t,a)=>t+a.usedMemory,Z+B)}};var Ee=K,h=class extends E{constructor(e){super(e),this._dataQueryEngineInstance=null}destroy(){this.clear()}get layer(){return this.context.layer}get spatialReference(){return this.context.spatialReference}get _queryGeometryType(){switch(this.layer.geometryType){case"multipoint":case"point":case"polygon":case"polyline":return this.layer.geometryType;case"mesh":return"polygon";default:return}}get defaultQueryJSON(){return new C({outSpatialReference:this.spatialReference}).toJSON()}clear(){return!!this._dataQueryEngineInstance&&(this._dataQueryEngineInstance.destroy(),this._dataQueryEngineInstance=null,!0)}async executeQueryForIdSet(e,t,a){return this._dataQueryEngine.executeQueryForIdSet(this._ensureQueryJSON(e,t),a)}async executeQueryForCount(e,t){return this._dataQueryEngine.executeQueryForCount(this._ensureQueryJSON(e),t)}async executeQueryForExtent(e,t){let{count:a,extent:r}=await this._dataQueryEngine.executeQueryForExtent(this._ensureQueryJSON(e),t);return{count:a,extent:L.fromJSON(r)}}async executeQueryForIds(e,t){return this._dataQueryEngine.executeQueryForIds(this._ensureQueryJSON(e),t)}async executeQueryForLatestObservations(e,t){let a=await this._dataQueryEngine.executeQueryForLatestObservations(this._ensureQueryJSON(e),t),r=G.fromJSON(a);return r.features.forEach(i=>{i.layer=this.layer,i.sourceLayer=this.layer}),r}async executeQuery(e,t){let a=await this._dataQueryEngine.executeQuery(this._ensureQueryJSON(e),t),r=G.fromJSON(a);return r.features.forEach(i=>{i.layer=this.layer,i.sourceLayer=this.layer}),r}_ensureQueryJSON(e,t){let a=this.defaultQueryJSON;if(e!=null&&("outSpatialReference"in e&&!e.outSpatialReference&&(e.outSpatialReference=this.spatialReference),a=e.toJSON(),a.cacheHint=!0),t!=null){let r=t.geometries.map(i=>i.toJSON()).reduce((i,l)=>(i.rings=i.rings.concat(l.rings),i));a=f(y({},a),{cacheHint:!0,sceneFilter:f(y({},t),{geometry:r})})}return a}get _dataQueryEngine(){if(this._dataQueryEngineInstance)return this._dataQueryEngineInstance;let{priority:e,layer:t}=this,a="timeInfo"in t&&t.timeInfo?.toJSON()||null,r=t.objectIdField,i=$.toJSON(this._queryGeometryType),l=t.fieldsIndex?.toJSON()||new W([]),u=this.spatialReference.toJSON(),{hasZ:c,hasM:g,featureStore:v,scheduler:fe,memoryController:be}=this.context,_e=new S(be);return this._dataQueryEngineInstance=new Ee({hasZ:c,hasM:g,geometryType:i,fieldsIndex:l,timeInfo:a,spatialReference:u,objectIdField:r,featureStore:v,scheduler:fe,cache:_e,priority:e}),this._dataQueryEngineInstance}};s([n({constructOnly:!0})],h.prototype,"context",void 0),s([n({constructOnly:!0})],h.prototype,"priority",void 0),s([n()],h.prototype,"layer",null),s([n()],h.prototype,"spatialReference",null),s([n()],h.prototype,"_queryGeometryType",null),s([n()],h.prototype,"defaultQueryJSON",null),h=s([m("esri.views.3d.layers.graphics.QueryEngine")],h);var O=class{constructor(t,a,r,i,l,u){this.spatialReference=t,this.layer=a,this.resourceController=r,this._getFeatureStore=i,this.hasZ=l,this.hasM=u}get scheduler(){return this.resourceController.scheduler}get memoryController(){return this.resourceController.memoryController}get featureStore(){return this._getFeatureStore()}};var p=class extends E{constructor(e){super(e),this._frameTask=null,this._queryEngine=null,this._updateRequested=!0,this._updatingHandles=new x,this._abortController=new AbortController}initialize(){let e=Y.FILTER_VISIBILITY,{layer:t,view:a}=this._configuration,{featureStore:r}=this.context,{spatialReference:i,resourceController:l}=a,u=this._configuration.hasZ??!1,c=this._configuration.hasM??!1,g=new O(i,t,l,()=>r,u,c);this._queryEngine=new h({context:g,priority:e}),this._frameTask=a.resourceController.scheduler.registerTask(e),this._updatingHandles.add(()=>[this._compositedFeatureFilter,this._sceneFilter],()=>this._updateRequested=!0,d),this._updatingHandles.addWhen(()=>!this._frameTask.updating&&this._updateRequested,()=>{this._frameTask.schedule(()=>this._updateVisibility(),this._abortController.signal).catch(N),this._updateRequested=!1},d)}destroy(){this._abortController.abort(),this._updatingHandles.destroy(),this.clear(),this._frameTask=P(this._frameTask),this._queryEngine=b(this._queryEngine),this._set("context",null)}get updating(){return this._updateRequested||this._updatingHandles.updating||this._frameTask.updating}get defaultVisibility(){return this._compositedFeatureFilter==null&&this._sceneFilter==null}get _featureFilter(){return"filter"in this._configuration?this._configuration.filter:null}get _effectiveDisplayFilter(){return"effectiveDisplayFilter"in this._configuration?this._configuration.effectiveDisplayFilter:null}get _sceneFilter(){return"layerFilter"in this._configuration?this._configuration.layerFilter:null}get _floorFilter(){return re(this._configuration)}get _timeExtent(){return"timeExtent"in this._configuration?this._configuration.timeExtent:null}get _compositedFeatureFilter(){let{_featureFilter:e,_effectiveDisplayFilter:t,_timeExtent:a,_floorFilter:r}=this,i=e?.clone();if(t!=null&&(i??=new w,i.where=V(i.where,t.where)),a!=null&&(i??=new w,i.timeExtent=i.timeExtent?.intersection(a)??a),r!=null){i??=new w;let l=i.where==null||i.where==="";i.where=l?r:V(i.where,r)}return i}get _configuration(){return this.context.configuration}reapply(){this._updateRequested=!0}clear(){this._queryEngine.clear(),this.context.clearFeaturesVisibility()}async _updateVisibility(){let{signal:e}=this._abortController,{context:t,_frameTask:a,_sceneFilter:r,_compositedFeatureFilter:i}=this;if(R(e),i==null&&r==null||t.getFeatureCount()===0)return await a.schedule(()=>this.clear(),e);try{let l=await this._queryEngine.executeQueryForIdSet(i,r,e);return R(e),await a.schedule(()=>{t.updateFeatureVisibilities(u=>l.has(u))},e)}catch(l){return D(l),M.getLogger(this).warn(`FeatureFilter query failed: ${l}`,{error:l}),await a.schedule(()=>{t.setAllFeaturesVisibility(!0)},e)}}};s([n({constructOnly:!0})],p.prototype,"context",void 0),s([n()],p.prototype,"updating",null),s([n()],p.prototype,"defaultVisibility",null),s([n()],p.prototype,"_featureFilter",null),s([n()],p.prototype,"_effectiveDisplayFilter",null),s([n()],p.prototype,"_sceneFilter",null),s([n()],p.prototype,"_floorFilter",null),s([n()],p.prototype,"_timeExtent",null),s([n()],p.prototype,"_compositedFeatureFilter",null),s([n()],p.prototype,"_configuration",null),s([n()],p.prototype,"_updateRequested",void 0),p=s([m("esri.views.3d.layers.support.FeatureVisibilityFilter")],p);var o=class extends U{constructor(e){super(e),this.type="graphics-3d",this._updatingHandles=new x,this.elevationFeatureExpressionEnabled=!1,this.scaleVisibilityEnabled=!1,this.filterVisibilityEnabled=!1,this.frustumVisibilityEnabled=!1,this.elevationAlignmentEnabled=!1,this.timeExtentEnabled=!1,this.setUidToIdOnAdd=!0,this.dataExtent=null,this.drapeSourceType=se.Features,this.preferredUpdatePolicy=ne.ASYNC,this._suspendResumeExtent=null}initialize(){let e=this.owner,t=(this.filterVisibilityEnabled||this.timeExtentEnabled)&&e.layer.geometryType!=="multipatch",a=new pe({owner:this,layer:this.layer,preferredUpdatePolicy:this.preferredUpdatePolicy,elevationFeatureExpressionEnabled:this.elevationFeatureExpressionEnabled,graphicSymbolSupported:!1,hasZ:e.hasZ,hasM:e.hasM,setUidToIdOnAdd:this.setUidToIdOnAdd,componentFactories:{deconflictor:r=>e.view.deconflictor.addGraphicsOwner(r),labeler:(r,i)=>e.view.labeler.addGraphicsOwner(r,i),elevationAlignment:this.elevationAlignmentEnabled?(r,i)=>new he({graphicsCoreOwner:this,graphicsCore:r,queryGraphicUIDsInExtent:i,elevationProvider:e.view.elevationProvider}):null,scaleVisibility:this.scaleVisibilityEnabled?(r,i)=>new ye({graphicsCoreOwner:this,layer:this.layer,queryGraphicUIDsInExtent:i,graphicsCore:r,basemapTerrain:e.view.basemapTerrain}):null,filterVisibility:t?r=>new p({context:f(y({},r),{configuration:e})}):null,objectStates:r=>new de(r)}});this._set("graphicsCore",a),this.frustumVisibilityEnabled&&this._set("frustumVisibility",new ce({graphicsCoreOwner:this})),this.elevationAlignment&&this._updatingHandles.add(()=>this.layer.elevationInfo,(r,i)=>{Q(r,i)&&this._updatingHandles.addPromise(this.graphicsCore.elevationInfoChange())}),this._updatingHandles.add(()=>this.layer.labelsVisible,()=>this.graphicsCore.updateVisibilityInfo()),this._updatingHandles.add(()=>this.layer.labelingInfo,(r,i)=>{Q(r,i)&&this.graphicsCore.updateLabelingInfo()}),this._updatingHandles.add(()=>this.preferredUpdatePolicy,r=>this.graphicsCore.preferredUpdatePolicy=r),this.addResolvingPromise(this._initializeAsync())}async _initializeAsync(){await I(this.graphicsCore.initializePromise);let e=this.owner;this._updatingHandles.add(()=>this.renderer,t=>this._updatingHandles.addPromise(this.graphicsCore.rendererChange(t))),this._updatingHandles.add(()=>e.fullOpacity,()=>this.graphicsCore.opacityChange()),this._setupSuspendResumeExtent(),this.updateClippingExtent&&(this._updatingHandles.add(()=>e.view.clippingArea,()=>this._updateClippingExtent()),this._updateClippingExtent()),this.graphicsCore.startCreateGraphics(),this.graphicsCore.labelsEnabled&&await I(this.graphicsCore.updateLabelingInfo())}destroy(){this._updatingHandles.destroy(),this._set("frustumVisibility",b(this.frustumVisibility)),this._set("graphicsCore",b(this.graphicsCore)),this._set("owner",null)}get layer(){return this.owner.layer}get dataUpdating(){return this.graphicsCore?.dataUpdating??!1}get renderer(){let{renderer:e,objectIdField:t}=this.layer;if(!e||!t||e.type==="heatmap"||!e.visualVariables)return e;let a=e.visualVariables.findIndex(i=>i.type==="rotation"&&i.valueExpression!=null&&z(i.valueExpression)===t&&(i.axis==null||i.axis==="heading")&&i.rotationType==="geographic");if(a<0)return e;let r=e.clone();return r.visualVariables?(r.visualVariables.splice(a,1),this._randomRotationRenderers??=new WeakMap,this._randomRotationRenderers.set(r,t),r):e}get scaleVisibility(){return this.graphicsCore?.scaleVisibility}get filterVisibility(){return this.graphicsCore?.filterVisibility}get elevationAlignment(){return this.graphicsCore?.elevationAlignment}get suspendResumeExtentMode(){return this.owner.suspendResumeExtentMode??"computed"}get scaleVisibilitySuspended(){return this.scaleVisibility!=null&&this.scaleVisibility.suspended}get suspended(){return this.owner.suspended}get legendEnabled(){return this.frustumVisibility==null||!this.frustumVisibility.suspended}get suspendInfo(){let e={};return this.scaleVisibilitySuspended&&(e.outsideScaleRange=!0),this.frustumVisibility!=null&&this.frustumVisibility.suspended&&(e.outsideOfView=!0),e}get updating(){return!!(this.graphicsCore?.updating||this.frustumVisibility?.updating||this._updatingHandles.updating)}get updatingRemaining(){return this.graphicsCore?.updatingRemaining??0}get featureStore(){return this.graphicsCore?.featureStore}get view(){return this.owner.view}get loadedGraphics(){return this.owner.loadedGraphics}get fullOpacity(){return this.owner?.fullOpacity}get filter(){return"filter"in this.owner?this.owner.filter:null}get slicePlaneEnabled(){return this.owner.slicePlaneEnabled}get updatePolicy(){return this.owner.updatePolicy}get featureSpatialReference(){return"featureSpatialReference"in this.owner?this.owner.featureSpatialReference:this.owner.view.spatialReference}get graphics3DGraphics(){return this.graphicsCore?.graphics3DGraphics}get graphics3DGraphicsByObjectID(){return this.graphicsCore?.graphics3DGraphicsByObjectID}get symbolUpdateType(){return this.graphicsCore?.symbolUpdateType}get displayFeatureLimit(){let e=this.view.quality,t=this.graphicsCore?.displayFeatureLimit;if(e===1)return t;let a=Math.ceil(t.maximumNumberOfFeatures*e);return new ue(t.maximumTotalNumberOfVertices,a,t.averageSymbolComplexity)}get usedMemory(){return this.graphicsCore?.usedMemory??0}get loadedFeatures(){return this.graphicsCore?.numberOfGraphics??0}get usedMemoryPerFeature(){return this.graphicsCore?.usedMemoryPerGraphic??0}get unprocessedMemoryEstimate(){return this.graphicsCore?.unprocessedMemoryEstimate??0}get performanceInfo(){return this.graphicsCore.performanceInfo}maskOccludee(e){let t=this.graphicsCore?.objectStates;if(!t)return q();let{set:a,handle:r}=t.acquireOccludeeSet(null);return t.setUid(a,e.uid),r}highlight(e,t=null,a){let r=this.graphicsCore?.objectStates;if(!r)return F;if(a??=te,e instanceof C){let{set:l,handle:u}=r.acquireHighlightSet(a,t);return this.owner.queryObjectIds(e).then(c=>r.setObjectIds(l,c)),u}let i=me(e);if(i.length===0)return F;if(i[0]instanceof ee){let l=i;if(T(this.layer.fieldsIndex,l[0].attributes,t)==null){let u=l.map(v=>v.uid),{set:c,handle:g}=r.acquireHighlightSet(a,null);return r.setUids(c,u),g}i=l.map(u=>T(this.layer.fieldsIndex,u.attributes,t))}if(ge(i[0])){let l=i,{set:u,handle:c}=r.acquireHighlightSet(a,t);return r.setObjectIds(u,l),c}return F}resetObjectStates(){this.graphicsCore?.objectStates?.reset()}whenGraphicBounds(e,t){return this.graphicsCore?.whenGraphicBounds(e,t)}computeAttachmentOrigin(e,t){return this.graphicsCore?.computeAttachmentOrigin(e,t)}notifyGraphicGeometryChanged(e){this.graphicsCore.notifyGraphicGeometryChanged(e)}notifyGraphicVisibilityChanged(e){this.graphicsCore.notifyGraphicVisibilityChanged(e)}getRenderingInfo(e,t,a){let r=ae(e,{renderer:t,arcade:a});if(r?.color){let i=r.color;i[0]=i[0]/255,i[1]=i[1]/255,i[2]=i[2]/255}if(r!=null&&t!=null&&this._randomRotationRenderers?.has(t)){let i=this._randomRotationRenderers.get(t),l=e.attributes[i],u=new X(0);u.updateFloatArray([l]),u.updateUint8Array([173]),r.heading=8381e-11*u.digest()}return r}getRenderingInfoAsync(e,t,a,r){return oe(e,y({renderer:t,arcade:a},r))}getSymbolLayerSize(e,t){return this.graphicsCore?.getSymbolLayerSize(e,t)}setObjectIdVisibility(e,t){this.graphicsCore?.setObjectIdVisibility(e,t)}refreshFilter(){this.filterVisibility!=null&&this.filterVisibility.reapply()}getGraphics3DGraphicByObjectId(e){return this.graphicsCore?.getGraphics3DGraphicByObjectId(e)}_updateClippingExtent(){let e=this.owner.view.clippingArea;this.graphicsCore.setClippingExtent(e,this.owner.view.spatialReference)&&(this.updateClippingExtent(e)||this.graphicsCore.recreateAllGraphics())}_setupSuspendResumeExtent(){(this.frustumVisibility||this.scaleVisibility)&&this.addHandles(_(()=>this.suspendResumeExtentMode,()=>{switch(this.removeHandles(A),this.suspendResumeExtentMode){case"computed":this.addHandles([_(()=>this.graphicsCore.computedExtent,e=>this._updateSuspendResumeExtent(e),d),_(()=>this.graphicsCore.extentPadding,()=>this._updateSuspendResumeExtent(this.graphicsCore.computedExtent))],A);break;case"data":this.addHandles([j(()=>this.dataExtent,e=>this._updateSuspendResumeExtent(e),d),_(()=>this.graphicsCore.extentPadding,()=>this._updateSuspendResumeExtent(this.dataExtent))],A);break;default:this.suspendResumeExtentMode}},d))}_updateSuspendResumeExtent(e){e?this._suspendResumeExtentChanged(this._extentToSuspendResumeRect(e,this._suspendResumeExtent)):this._suspendResumeExtentChanged(null)}_extentToSuspendResumeRect(e,t){let a=this.owner.view.spatialReference;if(!e.spatialReference.equals(a)){if(!J(e,a))return;e=k(e,a)}return ie(e,t,le,this.graphicsCore.extentPadding)}_suspendResumeExtentChanged(e){this.frustumVisibility!=null&&this.frustumVisibility.setExtent(e),this.scaleVisibility!=null&&this.scaleVisibility.setExtent(e)}};s([n()],o.prototype,"type",void 0),s([n({constructOnly:!0})],o.prototype,"owner",void 0),s([n()],o.prototype,"layer",null),s([n({readOnly:!0})],o.prototype,"dataUpdating",null),s([n()],o.prototype,"renderer",null),s([n({constructOnly:!0})],o.prototype,"updateClippingExtent",void 0),s([n({constructOnly:!0})],o.prototype,"elevationFeatureExpressionEnabled",void 0),s([n({constructOnly:!0})],o.prototype,"graphicsCore",void 0),s([n({constructOnly:!0})],o.prototype,"scaleVisibilityEnabled",void 0),s([n({constructOnly:!0})],o.prototype,"filterVisibilityEnabled",void 0),s([n({constructOnly:!0})],o.prototype,"frustumVisibilityEnabled",void 0),s([n({constructOnly:!0})],o.prototype,"elevationAlignmentEnabled",void 0),s([n({constructOnly:!0})],o.prototype,"timeExtentEnabled",void 0),s([n({constructOnly:!0})],o.prototype,"setUidToIdOnAdd",void 0),s([n()],o.prototype,"scaleVisibility",null),s([n()],o.prototype,"filterVisibility",null),s([n()],o.prototype,"elevationAlignment",null),s([n({constructOnly:!0})],o.prototype,"frustumVisibility",void 0),s([n()],o.prototype,"suspendResumeExtentMode",null),s([n()],o.prototype,"dataExtent",void 0),s([n()],o.prototype,"scaleVisibilitySuspended",null),s([n()],o.prototype,"suspended",null),s([n()],o.prototype,"legendEnabled",null),s([n()],o.prototype,"suspendInfo",null),s([n()],o.prototype,"updating",null),s([n()],o.prototype,"updatingRemaining",null),s([n()],o.prototype,"featureStore",null),s([n()],o.prototype,"view",null),s([n()],o.prototype,"loadedGraphics",null),s([n()],o.prototype,"fullOpacity",null),s([n()],o.prototype,"filter",null),s([n()],o.prototype,"slicePlaneEnabled",null),s([n()],o.prototype,"drapeSourceType",void 0),s([n()],o.prototype,"updatePolicy",null),s([n()],o.prototype,"preferredUpdatePolicy",void 0),s([n({readOnly:!0})],o.prototype,"displayFeatureLimit",null),o=s([m("esri.views.3d.layers.graphics.Graphics3DFeatureProcessor")],o);var A="suspendResumeExtentMode";export{h as a,O as b,p as c,o as d};
