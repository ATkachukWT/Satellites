import{a as EH,b as DH,d as xH}from"./chunk-T2JBGIMX.js";import{a as CH,c as TH}from"./chunk-BYYGFX6P.js";import{a as aH}from"./chunk-43SQECBA.js";import{a as hH,c as pH}from"./chunk-SY264W3E.js";import{b as mH}from"./chunk-YH5BTWVE.js";import{b as fH}from"./chunk-Z6R3XWAW.js";import{b as gH}from"./chunk-WLZYWV3C.js";import{b as _H}from"./chunk-7H5EID2H.js";import{a as yH,c as vH}from"./chunk-Z7TOIN4H.js";import{a as wH,c as bH}from"./chunk-4JQDLFOH.js";import{b as eH}from"./chunk-KGDMQD77.js";import{a as tH,c as iH}from"./chunk-KWHX7JZR.js";import{b as rH}from"./chunk-5HC2BF3R.js";import{a as nH,c as sH}from"./chunk-3QU4Z27K.js";import{a as pu,b as Hw,c as Bw,f as oH}from"./chunk-OJHTSCVF.js";import{a as lH,c as cH}from"./chunk-WF2YY3ZP.js";import{b as uH}from"./chunk-QKJ5OVCV.js";import{a as pm,b as NM,c as Vw}from"./chunk-ODNMA3LJ.js";import"./chunk-ASTIHUEJ.js";import{b as dH}from"./chunk-6FFLB6O7.js";import"./chunk-B7E6TWPE.js";import{a as da,b as G3,c as q3,d as Fw,f as W3}from"./chunk-VYGAHRQ5.js";import"./chunk-P5PR77YK.js";import{a as hm,b as kw,c as $3,e as Z3}from"./chunk-X6ZOF2KC.js";import{d as Lw}from"./chunk-KVXZQWKR.js";import{a as OM,b as Q3,d as Y3}from"./chunk-RZAQQBUH.js";import{a as wn,b as hu,c as K3,e as X3}from"./chunk-GYDPJHV2.js";import{a as mm,c as J3}from"./chunk-OCXV64J3.js";import{b as Yl}from"./chunk-V5V6AIWH.js";import{a as PM,b as dm,g as z3}from"./chunk-TP3CYP2E.js";import"./chunk-YHVPPOYO.js";import{a as U3,c as du,d as o_,e as j3,f as vn,g as Rr,h as ua}from"./chunk-DNRMZMJ3.js";import"./chunk-OX3SXBYL.js";import{a as H3,b as B3,c as AM}from"./chunk-HKZ53RXG.js";import{A as Iw,a as Dw,b as im,c as su,d as WV,e as la,f as fM,g as gM,h as as,i as _M,j as $V,k as vo,l as ou,m as yM,n as au,o as ZV,p as QV,q as YV,r as KV,s as Mw,t as vM,u as XV,v as wM,w as rm,x as Sw,y as JV,z as e3}from"./chunk-TYMNCBDR.js";import{a as bo,b as RM}from"./chunk-B6M6RVA3.js";import{a as xw}from"./chunk-XMOJ4BVW.js";import{b as qV,d as N3,e as F3,f as um,g as k3,h as V3}from"./chunk-KDKEWJOG.js";import{a as L3}from"./chunk-KYSTRHK2.js";import"./chunk-JNLUD3YZ.js";import{a as $k,b as aw}from"./chunk-KRDCB7BJ.js";import{a as SM,b as Pw,c as s_,d as Ow,e as x3,f as ca,g as M3,h as wo,i as S3,j as I3,k as A3,l as R3,m as P3,o as yn,p as Nw,q as uu,r as IM,s as O3}from"./chunk-RU2T46FC.js";import{$ as MM,A as om,B as bM,C as am,D as lu,E as CM,F as r_,G as p3,H as m3,I as f3,J as g3,K as _3,L as cu,N as y3,O as Ud,R as TM,S as Ka,T as Hn,U as lm,V as cm,W as v3,X as w3,Y as EM,Z as DM,_ as xM,a as Hd,aa as Bn,b as e_,ba as jd,c as Bd,d as t3,e as t_,f as Aw,g as i3,h as r3,i as n3,j as s3,k as Gi,l as ii,m as nm,n as a3,o as l3,p as sm,q as c3,r as u3,s as ir,t as Ki,u as i_,v as d3,w as h3,x as te,y as Rw}from"./chunk-3HPBQSX2.js";import{a as E3}from"./chunk-SNUEOKCP.js";import{a as T3}from"./chunk-ZQCWKCV6.js";import{a as n_,b as b3,c as C3}from"./chunk-Q7U5SZXR.js";import{b as D3}from"./chunk-W5TVDNWG.js";import"./chunk-IPMZUQ2D.js";import{b as o3}from"./chunk-QGGZPZNN.js";import{a as BV,b as UV,c as jV,d as zV}from"./chunk-EW6GNI53.js";import{a as VV,e as HV}from"./chunk-YTT63T5C.js";import{a as GV}from"./chunk-LC2PQWW4.js";import{j as NV}from"./chunk-QTJ73VES.js";import"./chunk-UZ3LPMUO.js";import{b as FV}from"./chunk-24PMLB7F.js";import{b as OV,c as nu,d as Ya}from"./chunk-YAHHW2G4.js";import{b as Ew}from"./chunk-BCDNNCF4.js";import{a as LV}from"./chunk-NPWEUFES.js";import{a as Tw}from"./chunk-PQNOJ4XM.js";import{b as kV}from"./chunk-26JWDTE3.js";import{b as Qk,c as Yk}from"./chunk-GPDZGV7G.js";import"./chunk-R2HHW4XT.js";import"./chunk-LG7DXNE4.js";import{a as PV}from"./chunk-2CZ6E3KR.js";import"./chunk-2TGLTRKB.js";import{a as tm,b as _w}from"./chunk-MOHGYSPI.js";import{b as bw,d as Qa,e as Cw}from"./chunk-KT2IZTJQ.js";import{b as wV,d as bV,e as CV,f as TV,g as yw,h as SV,i as vw,j as IV,k as hM,l as AV,n as mM}from"./chunk-7GENY6TF.js";import{a as pM,b as ww}from"./chunk-2L3Q5NER.js";import{a as ru,b as Ql,c as dM}from"./chunk-XCJ4FRLL.js";import{a as zi,b as Za,c as RV}from"./chunk-JNJTT3PL.js";import"./chunk-53FQLWMN.js";import{a as _V,b as yV,c as vV,d as Xg}from"./chunk-PGFEC2N6.js";import"./chunk-5KY2RG7F.js";import"./chunk-XQ4DD6H6.js";import{a as Vd,b as Kg}from"./chunk-IQA3CVAZ.js";import"./chunk-2DH3L3DZ.js";import{a as gV,c as MV}from"./chunk-2VR3WADU.js";import"./chunk-7S2234XQ.js";import{c as em}from"./chunk-5QOQFLF6.js";import{c as Jg}from"./chunk-2I3LIA7G.js";import{a as gw}from"./chunk-5DVGZXEZ.js";import"./chunk-QCAQAWPU.js";import"./chunk-MM2DY7NJ.js";import"./chunk-IDCT5OYA.js";import"./chunk-MH7FV4OG.js";import"./chunk-AGQUA5I4.js";import"./chunk-VC6GZ45F.js";import{a as EV,b as DV}from"./chunk-BENEV3E6.js";import{i as xV}from"./chunk-R3G2IXBO.js";import"./chunk-2M72FQ5L.js";import"./chunk-SBYRP3FT.js";import{a as aa,b as yo,c as di}from"./chunk-N3W77OHB.js";import{a as Zl,b as mV,c as fV}from"./chunk-PXDIM3V6.js";import"./chunk-D4EX42XK.js";import"./chunk-HMAWCT6U.js";import"./chunk-7PDWRJ35.js";import"./chunk-ALHY5HFC.js";import{a as pV}from"./chunk-VLG7V3KV.js";import{a as Wa,c as Zk,d as Fd,e as kd}from"./chunk-63BBKXWS.js";import{a as Yg}from"./chunk-62UTK67Z.js";import{a as fw}from"./chunk-ZFRNSCYG.js";import{a as dV,b as hV}from"./chunk-NGQW42AK.js";import{a as qk,b as Wk}from"./chunk-EZCOACUK.js";import"./chunk-IDSQ2YJ4.js";import"./chunk-IZXGUN7P.js";import{c as iV,d as rV,f as nV,g as sV,h as oV}from"./chunk-TZFNHKBC.js";import{a as Jk,b as uM,c as uV}from"./chunk-Q4TV4JSK.js";import{a as eV,b as tV}from"./chunk-4ZHOYO2J.js";import{a as lV,b as dw,c as cV,d as hw,e as pw,f as mw}from"./chunk-HMRMWMHT.js";import{a as Xk}from"./chunk-QW4SS6UN.js";import{b as rt,c as rw,d as qa}from"./chunk-UWWX7VSW.js";import{a as Vn}from"./chunk-CFF33S4D.js";import{e as uw}from"./chunk-M6OVPXT3.js";import"./chunk-UPU3OYP4.js";import{c as cw}from"./chunk-FLXA3YE2.js";import{a as _o,t as aV}from"./chunk-BFOAQMH4.js";import"./chunk-OWY34DUP.js";import{a as Xp}from"./chunk-4TIUXNXO.js";import"./chunk-G5XYZLZF.js";import{a as lw,b as Kk,c as $a,d as Jp}from"./chunk-CEAEFIX3.js";import"./chunk-ULWS5HLW.js";import"./chunk-OE4VWDFD.js";import"./chunk-ITLSRYM2.js";import"./chunk-AFU5KDMG.js";import{d as Sk}from"./chunk-2DZZ5W27.js";import{a as nw}from"./chunk-UXLLQMI3.js";import{b as xk,n as Mk}from"./chunk-724E6NM3.js";import"./chunk-JKP7KG6H.js";import{a as os}from"./chunk-QW5LN4Z5.js";import{a as Si,b as ow,c as Ik,d as go,f as Ak,g as Rk,i as Pk,j as Ok,k as Nk,l as Lk,m as Fk,n as kk,o as Vk,p as Hk,q as Bk,r as lM,s as Uk,u as jk,v as cM,w as zk,y as Gk}from"./chunk-QKO2YKBC.js";import{a as kn}from"./chunk-MF655E4C.js";import{a as sw}from"./chunk-CCTFA5SZ.js";import{a as Kp}from"./chunk-T52CAPK7.js";import"./chunk-EVFVSJN5.js";import"./chunk-3OYKXCYJ.js";import{b as Ek,c as Dk}from"./chunk-ZORXOOFY.js";import{b as Ck}from"./chunk-HUWVQAJL.js";import"./chunk-XY4QPRKP.js";import"./chunk-UV6SBQOQ.js";import"./chunk-OWV7FEAY.js";import{a as Qg}from"./chunk-CU7VLLP2.js";import{a as bk,b as Zg,c as aM}from"./chunk-3O6GAUHL.js";import{a as _k,b as iw,c as yk,d as vk}from"./chunk-QCOPOX22.js";import"./chunk-T4UFXW3U.js";import{a as wk}from"./chunk-IDJEFLWC.js";import{a as $g}from"./chunk-NOHUHVCW.js";import"./chunk-JAENS3D3.js";import"./chunk-3ATD3H4Q.js";import{v as gk}from"./chunk-2XYAAYOE.js";import{a as sM,c as oa,d as oM}from"./chunk-4X7VNDTG.js";import{a as f2}from"./chunk-OOXOZUTM.js";import{a as $l}from"./chunk-WQZ56BSL.js";import"./chunk-F7NFZM65.js";import"./chunk-I7FLOUNH.js";import{a as AF}from"./chunk-SDA472RA.js";import{a as Wr}from"./chunk-LXYWEX2U.js";import"./chunk-IBSCSNYA.js";import"./chunk-SPPN4AOM.js";import"./chunk-TY4DYZZJ.js";import{a as nM,b as ew,c as mk,d as fk}from"./chunk-JVF2DMWU.js";import{a as rM}from"./chunk-34RMJISL.js";import{a as MF,b as SF,c as zp}from"./chunk-54P55TN4.js";import{a as Jx,b as ra,c as rn,d as RF,e as Rt}from"./chunk-BVDJBTNQ.js";import{a as ns}from"./chunk-LSUWBOLF.js";import{a as dk,b as J0}from"./chunk-LHI3UGTZ.js";import"./chunk-6SGUOKGX.js";import"./chunk-LCFWGHLF.js";import"./chunk-XACQ2RJ5.js";import{a as Qp,b as nn,c as nk}from"./chunk-3TRID6QS.js";import{f as pk}from"./chunk-VUJT53YX.js";import"./chunk-WUXNV6ZW.js";import"./chunk-PM3EZWDJ.js";import{d as YF,e as KF,f as XF,h as Ld,i as JF,j as ek,k as tk}from"./chunk-KE2U7ENE.js";import{a as vr,b as NF}from"./chunk-PSFZFYFC.js";import"./chunk-WIFM6OT5.js";import{a as na,b as fo,g as ik,h as tM}from"./chunk-GI4NW5SA.js";import"./chunk-F4FOXK2P.js";import{c as iM,d as rk,e as Wl}from"./chunk-T5NHE3SD.js";import{a as hk}from"./chunk-SWCOPTUX.js";import"./chunk-7EWNVUY7.js";import"./chunk-SXYHD4V6.js";import{a as me}from"./chunk-FSW536RM.js";import{a as Yp,c as ok,d as K0,f as ak,g as lk,h as ck,i as X0}from"./chunk-YNDA4ZZB.js";import"./chunk-JAN3FVXP.js";import{e as jF}from"./chunk-F4HA2HQL.js";import{a as uk}from"./chunk-BSKAVVQS.js";import{b as sk}from"./chunk-AEU2INWT.js";import{a as tu}from"./chunk-Z4UBZ6W2.js";import{a as iu,b as $t}from"./chunk-CMKJEBQJ.js";import"./chunk-AQMR24IC.js";import{a as eu}from"./chunk-3J3Q4LMA.js";import"./chunk-PSNQ2KG3.js";import"./chunk-LIKQ6DPU.js";import"./chunk-H6LI7TZP.js";import"./chunk-2IWALBQY.js";import"./chunk-IVHM64W3.js";import"./chunk-QQ5W5TEP.js";import{b as IF}from"./chunk-YQHQQW4I.js";import"./chunk-7V6BRQYE.js";import{b as WF}from"./chunk-IZU6TNEP.js";import"./chunk-DNN7JJKY.js";import{a as Y0}from"./chunk-Y7XG5IWW.js";import"./chunk-X5NPIY3C.js";import{a as $F,b as ZF,c as QF}from"./chunk-JXRFF2VE.js";import{a as Pi,b as wr}from"./chunk-7WCQBAQY.js";import{a as ti,b as Oe,c as ss}from"./chunk-V4ZQZTCB.js";import{a as mt,b as ft}from"./chunk-PEYNLMWW.js";import"./chunk-FQIIIJGL.js";import{f as Zp}from"./chunk-SZTSN5BD.js";import"./chunk-VAOSSSLB.js";import"./chunk-6L543SC5.js";import"./chunk-CUV3BSEW.js";import"./chunk-6FI5AY7X.js";import"./chunk-ZCAR53EN.js";import"./chunk-DH67ILIV.js";import"./chunk-7GUYYJRR.js";import{a as zF}from"./chunk-WS4AMEGN.js";import"./chunk-CU7FHMWW.js";import"./chunk-CSFAHB4Y.js";import"./chunk-AMISFAT3.js";import"./chunk-PTXLSCMJ.js";import{a as qp,b as za,d as Wp,e as BF,f as $p,g as Ga,h as Z0,k as UF,l as St,m as Tt}from"./chunk-NRRX2M6N.js";import{a as GF,b as vi,c as qF,e as Di}from"./chunk-PMLKCTEJ.js";import{a as eM,f as sa,g as PF,h as OF}from"./chunk-MYO2G5ZH.js";import"./chunk-MTUYS77G.js";import"./chunk-EG2DTURK.js";import"./chunk-57FV5BVL.js";import"./chunk-YVCKQBWT.js";import"./chunk-4XEE5PE3.js";import"./chunk-MBNZK2RR.js";import"./chunk-DV6KBPBR.js";import{a as Fn}from"./chunk-XWEUR6F7.js";import"./chunk-KALTBP5D.js";import"./chunk-O2J7LFYY.js";import"./chunk-422PSKZ7.js";import"./chunk-SFANISLX.js";import"./chunk-5L4CW2H2.js";import"./chunk-UJ7KVQR6.js";import{a as $0,b as VF,e as HF,j as dr}from"./chunk-B74L7AUE.js";import{a as ur}from"./chunk-MJO3PLZV.js";import{b as Q0}from"./chunk-YU3IFRYW.js";import{a as ja}from"./chunk-XKFJ6GWH.js";import"./chunk-GSXOR3JU.js";import"./chunk-55OTJIMU.js";import{a as Ns}from"./chunk-EM2AEAFS.js";import"./chunk-VGAXEXH3.js";import"./chunk-YEPHAEAY.js";import"./chunk-76X7RFM4.js";import"./chunk-HMNTGQTR.js";import"./chunk-ZLIWNUFM.js";import"./chunk-GVSOJUIP.js";import"./chunk-GWSX6PRO.js";import"./chunk-ELCBU4NP.js";import"./chunk-GMZFCQJQ.js";import"./chunk-5WDH2LXO.js";import{a as Jc}from"./chunk-L7NOU4T2.js";import{a as LF,b as Wg,c as Gp,j as FF,k as kF}from"./chunk-SU7IJ65K.js";import"./chunk-WOZSH7YY.js";import"./chunk-2PJRHNJW.js";import"./chunk-B2RVSTL3.js";import"./chunk-2CKJLDTO.js";import"./chunk-F6TN7E7K.js";import"./chunk-HUUJBVXR.js";import"./chunk-4LDVFWME.js";import"./chunk-A45BLB26.js";import{a as Kc}from"./chunk-DFYW3Y3B.js";import{e as Kx,g as Xx,j as Gg,n as Od,o as Yc,r as vF}from"./chunk-UBQPWKE4.js";import"./chunk-YSD7LK2L.js";import{a as jp}from"./chunk-CTVZOIWY.js";import{a as wF}from"./chunk-BSSTF6JG.js";import"./chunk-7JW7DYCQ.js";import{a as Nd}from"./chunk-UP67O2XH.js";import"./chunk-6CO4643W.js";import{c as CF}from"./chunk-TMY7UIU7.js";import{b as EF}from"./chunk-BPX3YT3K.js";import{a as Ua}from"./chunk-LXEWGICX.js";import"./chunk-NIYDRLW4.js";import{a as Xc}from"./chunk-4K47EN3B.js";import{a as q0,c as bF}from"./chunk-FGY3YBPM.js";import{b as TF}from"./chunk-EDOVNTC7.js";import"./chunk-FSWSNKJD.js";import"./chunk-MVDZB4AK.js";import"./chunk-ESSDCWGF.js";import"./chunk-WVKBXQWE.js";import"./chunk-FGEB67EG.js";import{a as oe,h as W0}from"./chunk-YEXMIDOT.js";import"./chunk-GV3ZFCVD.js";import"./chunk-SOEEM7Z7.js";import"./chunk-T7PUQGWM.js";import"./chunk-44A27HB7.js";import"./chunk-47NSYSFY.js";import"./chunk-QXNVQZT7.js";import{b as cr,d as fF,e as gF,f as Bp,g as _F,i as Zc,l as Qc,o as yF,r as Up}from"./chunk-CAXK5KYB.js";import{a as Os,c as ia,f as mF}from"./chunk-3CCK7BDD.js";import"./chunk-LNYBTIG7.js";import"./chunk-BYXBJQAS.js";import{b as qg}from"./chunk-THX6XNHV.js";import"./chunk-AKKUUEQK.js";import{a as DF,b as xF}from"./chunk-JLWYDAJB.js";import{b as Yx}from"./chunk-4QYMI4ZX.js";import"./chunk-ZH7647AP.js";import{a as BL,b as UL}from"./chunk-MKPAHACK.js";import{a as ZL}from"./chunk-3QCWBHPT.js";import"./chunk-2T2QPZOS.js";import"./chunk-4YCQZSNI.js";import{a as $L}from"./chunk-4D3QHJI2.js";import{c as zL,e as GL,g as qL,j as WL}from"./chunk-E2J2V7JN.js";import{a as N0}from"./chunk-G7RYJIRW.js";import{b as $x}from"./chunk-37H4LYIE.js";import"./chunk-VYZHOYXV.js";import{b as jL}from"./chunk-K7YQAHQ7.js";import"./chunk-PGUFA2AC.js";import"./chunk-X7BNFUFQ.js";import{c as ta}from"./chunk-XAHD7XBV.js";import{c as pF}from"./chunk-J6YGDWJF.js";import{a as hF}from"./chunk-YQNUGDFH.js";import{a as Se,b as zg,c as G0}from"./chunk-QCZ3ZIGQ.js";import"./chunk-CUJN6GMF.js";import{a as dF}from"./chunk-IKCK67OG.js";import"./chunk-C4ERY4CA.js";import"./chunk-WDTJILD4.js";import"./chunk-YAZINLP3.js";import"./chunk-IFPD4DIO.js";import"./chunk-KBSNSGCC.js";import"./chunk-NLZLCUU5.js";import"./chunk-RZU6EEB3.js";import{a as tw}from"./chunk-NNX76JDG.js";import"./chunk-76O2P2CB.js";import"./chunk-WV5CXXQQ.js";import{a as p0}from"./chunk-KBDKZSTB.js";import"./chunk-BAZL6DXF.js";import"./chunk-HPPVXWXI.js";import"./chunk-HBMVPT4U.js";import"./chunk-L6ZFUQTH.js";import"./chunk-4MB4OYWM.js";import"./chunk-XG5NROZE.js";import"./chunk-7OTP74QG.js";import"./chunk-ZU53JDRS.js";import"./chunk-KQEHVUTS.js";import"./chunk-7LUXMWRM.js";import"./chunk-TO337MWO.js";import"./chunk-WKYBGWI5.js";import"./chunk-62PJ3MJN.js";import{b as tF,c as iF}from"./chunk-OVJTX4VC.js";import"./chunk-55SQMRMH.js";import"./chunk-CQD6CYSR.js";import"./chunk-QDXM6RGS.js";import"./chunk-E3UR4EIC.js";import"./chunk-4Y623NMU.js";import"./chunk-PTAJ247D.js";import"./chunk-O4MHA7YC.js";import"./chunk-XHEYQWRE.js";import"./chunk-R5HXEPJ3.js";import"./chunk-CJM4TC3F.js";import"./chunk-J5PZXDWN.js";import"./chunk-ME2B26KJ.js";import"./chunk-U7PX7SHO.js";import"./chunk-DZBH24YT.js";import"./chunk-7E723FQO.js";import"./chunk-SVJ5AK5B.js";import"./chunk-FXCL7YYQ.js";import"./chunk-NK3VUQOP.js";import"./chunk-HUKD3ORH.js";import"./chunk-NFARB7KW.js";import"./chunk-M7AB4SQK.js";import"./chunk-XN6KHUVJ.js";import"./chunk-3A3BGKXB.js";import"./chunk-BGOXHRAZ.js";import"./chunk-SXNHGK6A.js";import"./chunk-TMZQBNSB.js";import"./chunk-PFSX77NO.js";import"./chunk-ZJWWZWMH.js";import"./chunk-W45QYQK6.js";import"./chunk-I5V562B6.js";import"./chunk-WT3XCHGP.js";import"./chunk-CUJB6F5L.js";import{a as Tk}from"./chunk-5NHJFBCW.js";import"./chunk-GQVERT3D.js";import"./chunk-WPZN772I.js";import"./chunk-AZ7O5NEQ.js";import"./chunk-K27EVVBH.js";import"./chunk-2JKSIF4Q.js";import{a as cF}from"./chunk-EZUSHT3W.js";import{a as uF}from"./chunk-VIFXPONX.js";import"./chunk-AOQ57NDM.js";import{c as Pe,d as Qx,e as z0}from"./chunk-ONYJLWAD.js";import"./chunk-QWLNRA4Y.js";import"./chunk-HBZAOVHW.js";import{D as Zx,E as lF,H as j0,Q as ql,c as V0,d as nF,f as fi,g as sF,h as oF,j as H0,n as jg,o as aF,q as Vp,r as Hp,u as Gl,x as Pd,y as B0,z as U0}from"./chunk-VMECOA4F.js";import"./chunk-KOUNUVF6.js";import{a as k0}from"./chunk-4RMBQ2W6.js";import{e as rF}from"./chunk-PHODKV66.js";import{a as Ug}from"./chunk-JPMGMA4B.js";import"./chunk-A2OWKKGL.js";import"./chunk-YHWE4TIZ.js";import"./chunk-QSMPW36A.js";import"./chunk-JGU5JAYW.js";import"./chunk-LCMPSAU3.js";import"./chunk-CRJDOM7J.js";import"./chunk-BCFGKQ2N.js";import"./chunk-G7BT6VC5.js";import"./chunk-ZPQDV27Y.js";import"./chunk-SIMI7FRM.js";import{b as M2,c as Hc,d as Bc,e as Uc,h as S2,i as Pg,j as Rx,k as Px,l as Dp,r as I2,s as A2}from"./chunk-YQGS4EZO.js";import{a as rs}from"./chunk-3REMXE4W.js";import{p as L0}from"./chunk-4ABKPPKG.js";import{a as Ep}from"./chunk-PMVQ5DJK.js";import{b as KL,i as XL,l as JL,w as eF}from"./chunk-I4Q2S2XA.js";import"./chunk-V774RJYN.js";import{a as Cp}from"./chunk-L2WNUKLP.js";import{c as F0}from"./chunk-XITT4JU2.js";import{a as QL,b as YL}from"./chunk-ZBX6HJOS.js";import"./chunk-BSMAMABT.js";import{d as Fp}from"./chunk-LYNAYPL3.js";import"./chunk-ULANM5YP.js";import{l as kp}from"./chunk-77L5NP7A.js";import"./chunk-2G3SBK6Q.js";import"./chunk-VOB6IBIW.js";import"./chunk-63B3IOWG.js";import{a as _n}from"./chunk-KAMRW6HF.js";import{c as kL}from"./chunk-XIZXEWWA.js";import{a as $c,b as O0}from"./chunk-6DGDLLNL.js";import{a as OL,b as NL,d as LL}from"./chunk-UWWWQ44M.js";import{b as FL}from"./chunk-BHB4UQZT.js";import{a as Op,b as I0,c as Np,d as qc,e as A0,h as R0,i as zl,j as Lp,k as P0,o as PL}from"./chunk-DJW5LMRG.js";import"./chunk-SEJXLJ5V.js";import"./chunk-MPAJA3DL.js";import{a as Wt,c as qx,d as Wc}from"./chunk-ALWV3RJ2.js";import{a as Ln}from"./chunk-DEH76MSI.js";import{a as HL}from"./chunk-YW3L7OMP.js";import{a as mo}from"./chunk-DVBZA6ZU.js";import{a as K2,b as X2}from"./chunk-6YRWGF73.js";import"./chunk-V2JYXY4D.js";import"./chunk-KWBPUP6A.js";import"./chunk-LAVV77UH.js";import"./chunk-VTGWQ7AP.js";import{b as Wx}from"./chunk-TBA3OZMJ.js";import"./chunk-S4QV2MGO.js";import"./chunk-IRI7XXYY.js";import"./chunk-DDZ3KR2Q.js";import{a as VL}from"./chunk-USMAJP2P.js";import"./chunk-PHNFWHVF.js";import"./chunk-4N5OXIEM.js";import"./chunk-DTU6MHUX.js";import"./chunk-NFXNGFHZ.js";import"./chunk-RROJCQBD.js";import"./chunk-3CDCI3XM.js";import"./chunk-W26XKMAT.js";import"./chunk-NQWYPF77.js";import"./chunk-6KRFVLII.js";import"./chunk-G27DRLGO.js";import{a as Ui,c as C0,d as Xt,e as Jn,f as Ed}from"./chunk-KRAKR4MK.js";import{a as pi}from"./chunk-MCO7DSFO.js";import"./chunk-D7WE3OBT.js";import"./chunk-CDP4MSRO.js";import"./chunk-BCSLWH5H.js";import{d as CL}from"./chunk-TOH4K6HW.js";import"./chunk-UP6FLASM.js";import"./chunk-DGBDFGKO.js";import"./chunk-44S2QQS2.js";import"./chunk-DQOFEB5P.js";import{a as Ha}from"./chunk-JTDXB5TK.js";import"./chunk-2NP7F5RO.js";import"./chunk-7QY3BMVN.js";import"./chunk-XEZTJAR4.js";import"./chunk-BUP3AMMF.js";import"./chunk-XCIPBOI4.js";import"./chunk-CWUY5SXW.js";import{E as lL,F as Ul,G as cL,K as uL,M as dL,a as iL,d as jc,e as Bx,j as rL,l as v0,p as nL,q as sL,r as oL,t as aL}from"./chunk-KD27XIJC.js";import{c as yL,e as Va,f as vL,g as wL,h as jl,p as jx,q as Td,r as b0,u as bL}from"./chunk-TPFJWNIU.js";import"./chunk-P25RU3X5.js";import{c as Vg,f as gL,k as _L}from"./chunk-XRRQM4E2.js";import"./chunk-GWBRHLNH.js";import{a as Rd,d as RL}from"./chunk-QCRXBE6I.js";import{a as S0}from"./chunk-G7TP3ZYQ.js";import"./chunk-SBVUMOLF.js";import{a as M0,d as IL,f as AL}from"./chunk-Y6YEAKJ5.js";import{a as is}from"./chunk-S52JRLJC.js";import{b as Ps}from"./chunk-U4TLMQTY.js";import{a as en,e as Gx}from"./chunk-PDQQY7RQ.js";import"./chunk-W5OI4BJ2.js";import{a as yi}from"./chunk-RWCIDBNQ.js";import"./chunk-2NH7HOKA.js";import{a as Ti,b as Jt,c as ei,d as ML,h as Id,i as Ei,j as D0,k as Nn,l as ji,m as Bg,n as mi,o as Gc,p as Ba,q as x0,r as tn,w as lr,x as SL,y as Ad}from"./chunk-HM5RIVQC.js";import{a as Hi,b as DL,c as Hg,e as xL,f as Sd}from"./chunk-EM35R6FY.js";import{c as EL,p as zx}from"./chunk-2ZFXOJDB.js";import{a as Yi,b as es,d as T0,i as ea,q as Dd,s as xd,w as E0}from"./chunk-QXXXCEV5.js";import{A as TL,D as Rp,E as zc,F as Pp,G as ai,H as Ar,J as yr,a as xe,b as ee,c as Te,d as he,e as ve,n as X,o as Md,p as ui,q as po,r as Ir,s as Rs,u as ne,v as ae,w as At,x as ni,y as si,z as ts}from"./chunk-6B5XFA6F.js";import"./chunk-M67YQAIX.js";import"./chunk-NHEQ4TAR.js";import"./chunk-BIRSPTTF.js";import"./chunk-IZLELRQR.js";import{b as Ux}from"./chunk-7EMOONQX.js";import"./chunk-RZF6KTKU.js";import"./chunk-HP4LYRR4.js";import"./chunk-AFC2H4Q3.js";import{d as Zi,f as Kt,g as V2,h as bd,i as Xo}from"./chunk-OLOKUDVI.js";import"./chunk-4G7UTTZJ.js";import{B as $2,C as Z2,D as Q2,E as Y2,a as Sp,c as Cd,d as q2,f as Fx,g as lo,h as kx,j as co,k as Vx,l as W2,m as Fg,p as uo}from"./chunk-ZTOZWLEE.js";import"./chunk-RJWOVI3M.js";import"./chunk-SP2CO3KX.js";import{a as y0}from"./chunk-NRBJLISB.js";import{a as Qi,b as fL,c as fn,f as gn}from"./chunk-PTZYZULI.js";import{a as Ap,c as ho,d as hL,e as w0,k as pL,l as kg,m as mL}from"./chunk-NMLYCCKN.js";import{a as _0,c as Mp}from"./chunk-RSDQHAJX.js";import{a as w,b as mn,c as yt,d as Lg,e as H2,f as B2,h as U2,i as Jo,k as j2,l as z2,m as G2}from"./chunk-BOVYXYHK.js";import"./chunk-FENRIY2T.js";import"./chunk-5HJY3X5Y.js";import{b as J2,c as Hx}from"./chunk-6RZAM42M.js";import"./chunk-WDETDPZG.js";import"./chunk-HX2VGIR2.js";import"./chunk-64QN2VGD.js";import{a as eL}from"./chunk-JGEVVXD4.js";import{p as Ip}from"./chunk-B3FO6PT7.js";import{c as tL}from"./chunk-C4UMJHQC.js";import"./chunk-BCREO4Q5.js";import{A as g0,B as Yo,C as F2,D as Ko,F as k2,a as Yt,c as Og,d as R2,e as P2,f as m0,g as O2,h as ka,j as Ox,k as ao,l as Hl,o as f0,r as Nx,u as N2,v as Bl,x as Lx,y as Ng,z as L2}from"./chunk-LXFQWIWE.js";import{b as q,c as wd,f as Xe,h as kt,i as kl,k as oo,l as xp,t as Vl}from"./chunk-QT6UNBJP.js";import{c as p2}from"./chunk-MDSLION2.js";import{a as vp,b as xx,c as wp,d as La,e as Qo}from"./chunk-I2UM4WSJ.js";import{e as $i}from"./chunk-DCHNVAWJ.js";import{b as Sx}from"./chunk-64RBIOV3.js";import{f as d2,k as h2}from"./chunk-6Z6LKUG5.js";import"./chunk-V2GNNIXD.js";import"./chunk-NSYL2RQJ.js";import"./chunk-SLAWDKDA.js";import{a as S,b as Wi,c as tr,d as Zo,h as Fe,i as Re,j as Ce}from"./chunk-MWSXMSWY.js";import{c as Ig,f as hn}from"./chunk-JRCKELO6.js";import"./chunk-ZVCMULXF.js";import"./chunk-KJULKTB5.js";import{a as l2,h as c2}from"./chunk-LACL4BQ2.js";import{a as Mx,c as lt}from"./chunk-YR2HD3ZC.js";import{a as oi}from"./chunk-GJASVPF6.js";import"./chunk-UBFCO3DV.js";import{a as m2}from"./chunk-NMRTZBDM.js";import"./chunk-NI7FJV5X.js";import{a as On}from"./chunk-BUSG3ZOF.js";import"./chunk-XZIOXVVJ.js";import"./chunk-5RAXVJQI.js";import"./chunk-EXJYW3PC.js";import{a as Ag}from"./chunk-SXQPBCOX.js";import{a as h0,e as D2,f as x2,m as Vi}from"./chunk-LFH24RLM.js";import{a as w2,e as b2,g as C2,j as T2,l as E2,n as pt}from"./chunk-Z5Q7KLA4.js";import{a as Ax}from"./chunk-X4LNX4BR.js";import{a as Qt}from"./chunk-4XZ6X7MQ.js";import{a as Tp}from"./chunk-WLHY3MMA.js";import{J as _t,a as g2,fa as v2,ha as Rg,j as Ix,m as Fa,n as _2,q as y2,v as c0,x as u0,z as d0}from"./chunk-KGVXGH6H.js";import{a as pn}from"./chunk-ARRCN5K3.js";import{a as l0}from"./chunk-LXQPIAN7.js";import{a as o2,c as a2}from"./chunk-FTDD7QBB.js";import{a as Sr}from"./chunk-DB3UIQCU.js";import"./chunk-SBHKMV3P.js";import{a as u2,b as Dx}from"./chunk-R4A63S45.js";import{E as bp}from"./chunk-ETE32IYO.js";import{P as a0}from"./chunk-ONUGDWDK.js";import{f as dn}from"./chunk-SG7CQU4O.js";import{A as i2,B as r2,E as n2,H as d,J as P,a as WN,e as $N,f as yx,g as Pa,i as Jv,k as bx,p as Mg,z as t2}from"./chunk-QHVIRF5H.js";import{C as Ex,I as C,f as no,g as s0,i as _p,o as o0,p as yp,w as s2,x as Tx}from"./chunk-WZDN6K3C.js";import{a as u}from"./chunk-QGVBCWUY.js";import{a as Sg,b as n0,c as Jr,d as e2}from"./chunk-OJQ73TPF.js";import"./chunk-354SCPDU.js";import"./chunk-OVHPPCBL.js";import{a as wx}from"./chunk-IYZFKXJ6.js";import{A as so,C as t0,D as qr,E as Cx,H as KN,J as XN,L as JN,M as Na,P as As,a as ZN,b as G,c as We,d as Ft,e as xr,f as ki,h as vx,j as _r,p as QN,q as Oa,s as e0,u as Mr,v as Ht,x as Fl,y as YN}from"./chunk-CKJ56T2Q.js";import{a as i0,b as r0}from"./chunk-SNFOAZZQ.js";import{a as Nt}from"./chunk-F6JAWRPN.js";import{b as ro,k as qN,r as W,t as Be}from"./chunk-UHRSAPGQ.js";import{I as GN,a as Ct,b as UN,d as jN,h as Kv,i as zN,j as xg,p as Xv,w as vd}from"./chunk-V76GWARL.js";import"./chunk-L4EKTZIP.js";import{a as ie,b as be}from"./chunk-N2WTMF3X.js";var LM;function FM(){return LM}function Kl(e){let t=LM;return LM=e,t}var UW=Symbol("NotFound"),Uw=class extends Error{name="\u0275NotFound";constructor(t){super(t)}};function fm(e){return e===UW||e?.name==="\u0275NotFound"}function Ww(e,t){return Object.is(e,t)}var Pr=null,jw=!1,kM=1,jW=null,ls=Symbol("SIGNAL");function Et(e){let t=Pr;return Pr=e,t}function $w(){return Pr}var zd={version:0,lastCleanEpoch:0,dirty:!1,producerNode:void 0,producerLastReadVersion:void 0,producerIndexOfThis:void 0,nextProducerIndex:0,liveConsumerNode:void 0,liveConsumerIndexOfThis:void 0,consumerAllowSignalWrites:!1,consumerIsAlwaysLive:!1,kind:"unknown",producerMustRecompute:()=>!1,producerRecomputeValue:()=>{},consumerMarkedDirty:()=>{},consumerOnSignalRead:()=>{}};function Zw(e){if(jw)throw new Error("");if(Pr===null)return;Pr.consumerOnSignalRead(e);let t=Pr.nextProducerIndex++;if(Jw(Pr),t<Pr.producerNode.length&&Pr.producerNode[t]!==e&&l_(Pr)){let i=Pr.producerNode[t];Xw(i,Pr.producerIndexOfThis[t])}Pr.producerNode[t]!==e&&(Pr.producerNode[t]=e,Pr.producerIndexOfThis[t]=l_(Pr)?SH(e,Pr,t):0),Pr.producerLastReadVersion[t]=e.version}function MH(){kM++}function Qw(e){if(!(l_(e)&&!e.dirty)&&!(!e.dirty&&e.lastCleanEpoch===kM)){if(!e.producerMustRecompute(e)&&!Yw(e)){qw(e);return}e.producerRecomputeValue(e),qw(e)}}function VM(e){if(e.liveConsumerNode===void 0)return;let t=jw;jw=!0;try{for(let i of e.liveConsumerNode)i.dirty||zW(i)}finally{jw=t}}function HM(){return Pr?.consumerAllowSignalWrites!==!1}function zW(e){e.dirty=!0,VM(e),e.consumerMarkedDirty?.(e)}function qw(e){e.dirty=!1,e.lastCleanEpoch=kM}function gm(e){return e&&(e.nextProducerIndex=0),Et(e)}function c_(e,t){if(Et(t),!(!e||e.producerNode===void 0||e.producerIndexOfThis===void 0||e.producerLastReadVersion===void 0)){if(l_(e))for(let i=e.nextProducerIndex;i<e.producerNode.length;i++)Xw(e.producerNode[i],e.producerIndexOfThis[i]);for(;e.producerNode.length>e.nextProducerIndex;)e.producerNode.pop(),e.producerLastReadVersion.pop(),e.producerIndexOfThis.pop()}}function Yw(e){Jw(e);for(let t=0;t<e.producerNode.length;t++){let i=e.producerNode[t],r=e.producerLastReadVersion[t];if(r!==i.version||(Qw(i),r!==i.version))return!0}return!1}function Kw(e){if(Jw(e),l_(e))for(let t=0;t<e.producerNode.length;t++)Xw(e.producerNode[t],e.producerIndexOfThis[t]);e.producerNode.length=e.producerLastReadVersion.length=e.producerIndexOfThis.length=0,e.liveConsumerNode&&(e.liveConsumerNode.length=e.liveConsumerIndexOfThis.length=0)}function SH(e,t,i){if(IH(e),e.liveConsumerNode.length===0&&AH(e))for(let r=0;r<e.producerNode.length;r++)e.producerIndexOfThis[r]=SH(e.producerNode[r],e,r);return e.liveConsumerIndexOfThis.push(i),e.liveConsumerNode.push(t)-1}function Xw(e,t){if(IH(e),e.liveConsumerNode.length===1&&AH(e))for(let r=0;r<e.producerNode.length;r++)Xw(e.producerNode[r],e.producerIndexOfThis[r]);let i=e.liveConsumerNode.length-1;if(e.liveConsumerNode[t]=e.liveConsumerNode[i],e.liveConsumerIndexOfThis[t]=e.liveConsumerIndexOfThis[i],e.liveConsumerNode.length--,e.liveConsumerIndexOfThis.length--,t<e.liveConsumerNode.length){let r=e.liveConsumerIndexOfThis[t],n=e.liveConsumerNode[t];Jw(n),n.producerIndexOfThis[r]=t}}function l_(e){return e.consumerIsAlwaysLive||(e?.liveConsumerNode?.length??0)>0}function Jw(e){e.producerNode??=[],e.producerIndexOfThis??=[],e.producerLastReadVersion??=[]}function IH(e){e.liveConsumerNode??=[],e.liveConsumerIndexOfThis??=[]}function AH(e){return e.producerNode!==void 0}function eb(e){jW?.(e)}function tb(e,t){let i=Object.create(GW);i.computation=e,t!==void 0&&(i.equal=t);let r=()=>{if(Qw(i),Zw(i),i.value===a_)throw i.error;return i.value};return r[ls]=i,eb(i),r}var zw=Symbol("UNSET"),Gw=Symbol("COMPUTING"),a_=Symbol("ERRORED"),GW=be(ie({},zd),{value:zw,dirty:!0,error:null,equal:Ww,kind:"computed",producerMustRecompute(e){return e.value===zw||e.value===Gw},producerRecomputeValue(e){if(e.value===Gw)throw new Error("");let t=e.value;e.value=Gw;let i=gm(e),r,n=!1;try{r=e.computation(),Et(null),n=t!==zw&&t!==a_&&r!==a_&&e.equal(t,r)}catch(s){r=a_,e.error=s}finally{c_(e,i)}if(n){e.value=t;return}e.value=r,e.version++}});function qW(){throw new Error}var RH=qW;function PH(e){RH(e)}function BM(e){RH=e}var WW=null;function UM(e,t){let i=Object.create(NH);i.value=e,t!==void 0&&(i.equal=t);let r=()=>OH(i);return r[ls]=i,eb(i),[r,o=>ib(i,o),o=>jM(i,o)]}function OH(e){return Zw(e),e.value}function ib(e,t){HM()||PH(e),e.equal(e.value,t)||(e.value=t,$W(e))}function jM(e,t){HM()||PH(e),ib(e,t(e.value))}var NH=be(ie({},zd),{equal:Ww,value:void 0,kind:"signal"});function $W(e){e.version++,MH(),VM(e),WW?.(e)}function Gt(e){return typeof e=="function"}function rb(e){let i=e(r=>{Error.call(r),r.stack=new Error().stack});return i.prototype=Object.create(Error.prototype),i.prototype.constructor=i,i}var nb=rb(e=>function(i){e(this),this.message=i?`${i.length} errors occurred during unsubscription:
${i.map((r,n)=>`${n+1}) ${r.toString()}`).join(`
  `)}`:"",this.name="UnsubscriptionError",this.errors=i});function u_(e,t){if(e){let i=e.indexOf(t);0<=i&&e.splice(i,1)}}var Un=class e{constructor(t){this.initialTeardown=t,this.closed=!1,this._parentage=null,this._finalizers=null}unsubscribe(){let t;if(!this.closed){this.closed=!0;let{_parentage:i}=this;if(i)if(this._parentage=null,Array.isArray(i))for(let s of i)s.remove(this);else i.remove(this);let{initialTeardown:r}=this;if(Gt(r))try{r()}catch(s){t=s instanceof nb?s.errors:[s]}let{_finalizers:n}=this;if(n){this._finalizers=null;for(let s of n)try{LH(s)}catch(o){t=t??[],o instanceof nb?t=[...t,...o.errors]:t.push(o)}}if(t)throw new nb(t)}}add(t){var i;if(t&&t!==this)if(this.closed)LH(t);else{if(t instanceof e){if(t.closed||t._hasParent(this))return;t._addParent(this)}(this._finalizers=(i=this._finalizers)!==null&&i!==void 0?i:[]).push(t)}}_hasParent(t){let{_parentage:i}=this;return i===t||Array.isArray(i)&&i.includes(t)}_addParent(t){let{_parentage:i}=this;this._parentage=Array.isArray(i)?(i.push(t),i):i?[i,t]:t}_removeParent(t){let{_parentage:i}=this;i===t?this._parentage=null:Array.isArray(i)&&u_(i,t)}remove(t){let{_finalizers:i}=this;i&&u_(i,t),t instanceof e&&t._removeParent(this)}};Un.EMPTY=(()=>{let e=new Un;return e.closed=!0,e})();var zM=Un.EMPTY;function sb(e){return e instanceof Un||e&&"closed"in e&&Gt(e.remove)&&Gt(e.add)&&Gt(e.unsubscribe)}function LH(e){Gt(e)?e():e.unsubscribe()}var ha={onUnhandledError:null,onStoppedNotification:null,Promise:void 0,useDeprecatedSynchronousErrorHandling:!1,useDeprecatedNextContext:!1};var _m={setTimeout(e,t,...i){let{delegate:r}=_m;return r?.setTimeout?r.setTimeout(e,t,...i):setTimeout(e,t,...i)},clearTimeout(e){let{delegate:t}=_m;return(t?.clearTimeout||clearTimeout)(e)},delegate:void 0};function ob(e){_m.setTimeout(()=>{let{onUnhandledError:t}=ha;if(t)t(e);else throw e})}function GM(){}var FH=qM("C",void 0,void 0);function kH(e){return qM("E",void 0,e)}function VH(e){return qM("N",e,void 0)}function qM(e,t,i){return{kind:e,value:t,error:i}}var Gd=null;function ym(e){if(ha.useDeprecatedSynchronousErrorHandling){let t=!Gd;if(t&&(Gd={errorThrown:!1,error:null}),e(),t){let{errorThrown:i,error:r}=Gd;if(Gd=null,i)throw r}}else e()}function HH(e){ha.useDeprecatedSynchronousErrorHandling&&Gd&&(Gd.errorThrown=!0,Gd.error=e)}var qd=class extends Un{constructor(t){super(),this.isStopped=!1,t?(this.destination=t,sb(t)&&t.add(this)):this.destination=YW}static create(t,i,r){return new vm(t,i,r)}next(t){this.isStopped?$M(VH(t),this):this._next(t)}error(t){this.isStopped?$M(kH(t),this):(this.isStopped=!0,this._error(t))}complete(){this.isStopped?$M(FH,this):(this.isStopped=!0,this._complete())}unsubscribe(){this.closed||(this.isStopped=!0,super.unsubscribe(),this.destination=null)}_next(t){this.destination.next(t)}_error(t){try{this.destination.error(t)}finally{this.unsubscribe()}}_complete(){try{this.destination.complete()}finally{this.unsubscribe()}}},ZW=Function.prototype.bind;function WM(e,t){return ZW.call(e,t)}var ZM=class{constructor(t){this.partialObserver=t}next(t){let{partialObserver:i}=this;if(i.next)try{i.next(t)}catch(r){ab(r)}}error(t){let{partialObserver:i}=this;if(i.error)try{i.error(t)}catch(r){ab(r)}else ab(t)}complete(){let{partialObserver:t}=this;if(t.complete)try{t.complete()}catch(i){ab(i)}}},vm=class extends qd{constructor(t,i,r){super();let n;if(Gt(t)||!t)n={next:t??void 0,error:i??void 0,complete:r??void 0};else{let s;this&&ha.useDeprecatedNextContext?(s=Object.create(t),s.unsubscribe=()=>this.unsubscribe(),n={next:t.next&&WM(t.next,s),error:t.error&&WM(t.error,s),complete:t.complete&&WM(t.complete,s)}):n=t}this.destination=new ZM(n)}};function ab(e){ha.useDeprecatedSynchronousErrorHandling?HH(e):ob(e)}function QW(e){throw e}function $M(e,t){let{onStoppedNotification:i}=ha;i&&_m.setTimeout(()=>i(e,t))}var YW={closed:!0,next:GM,error:QW,complete:GM};var wm=typeof Symbol=="function"&&Symbol.observable||"@@observable";function BH(e){return e}function UH(e){return e.length===0?BH:e.length===1?e[0]:function(i){return e.reduce((r,n)=>n(r),i)}}var Xi=(()=>{class e{constructor(i){i&&(this._subscribe=i)}lift(i){let r=new e;return r.source=this,r.operator=i,r}subscribe(i,r,n){let s=XW(i)?i:new vm(i,r,n);return ym(()=>{let{operator:o,source:a}=this;s.add(o?o.call(s,a):a?this._subscribe(s):this._trySubscribe(s))}),s}_trySubscribe(i){try{return this._subscribe(i)}catch(r){i.error(r)}}forEach(i,r){return r=jH(r),new r((n,s)=>{let o=new vm({next:a=>{try{i(a)}catch(l){s(l),o.unsubscribe()}},error:s,complete:n});this.subscribe(o)})}_subscribe(i){var r;return(r=this.source)===null||r===void 0?void 0:r.subscribe(i)}[wm](){return this}pipe(...i){return UH(i)(this)}toPromise(i){return i=jH(i),new i((r,n)=>{let s;this.subscribe(o=>s=o,o=>n(o),()=>r(s))})}}return e.create=t=>new e(t),e})();function jH(e){var t;return(t=e??ha.Promise)!==null&&t!==void 0?t:Promise}function KW(e){return e&&Gt(e.next)&&Gt(e.error)&&Gt(e.complete)}function XW(e){return e&&e instanceof qd||KW(e)&&sb(e)}function JW(e){return Gt(e?.lift)}function cs(e){return t=>{if(JW(t))return t.lift(function(i){try{return e(i,this)}catch(r){this.error(r)}});throw new TypeError("Unable to lift unknown Observable type")}}function us(e,t,i,r,n){return new QM(e,t,i,r,n)}var QM=class extends qd{constructor(t,i,r,n,s,o){super(t),this.onFinalize=s,this.shouldUnsubscribe=o,this._next=i?function(a){try{i(a)}catch(l){t.error(l)}}:super._next,this._error=n?function(a){try{n(a)}catch(l){t.error(l)}finally{this.unsubscribe()}}:super._error,this._complete=r?function(){try{r()}catch(a){t.error(a)}finally{this.unsubscribe()}}:super._complete}unsubscribe(){var t;if(!this.shouldUnsubscribe||this.shouldUnsubscribe()){let{closed:i}=this;super.unsubscribe(),!i&&((t=this.onFinalize)===null||t===void 0||t.call(this))}}};var zH=rb(e=>function(){e(this),this.name="ObjectUnsubscribedError",this.message="object unsubscribed"});var Xa=(()=>{class e extends Xi{constructor(){super(),this.closed=!1,this.currentObservers=null,this.observers=[],this.isStopped=!1,this.hasError=!1,this.thrownError=null}lift(i){let r=new lb(this,this);return r.operator=i,r}_throwIfClosed(){if(this.closed)throw new zH}next(i){ym(()=>{if(this._throwIfClosed(),!this.isStopped){this.currentObservers||(this.currentObservers=Array.from(this.observers));for(let r of this.currentObservers)r.next(i)}})}error(i){ym(()=>{if(this._throwIfClosed(),!this.isStopped){this.hasError=this.isStopped=!0,this.thrownError=i;let{observers:r}=this;for(;r.length;)r.shift().error(i)}})}complete(){ym(()=>{if(this._throwIfClosed(),!this.isStopped){this.isStopped=!0;let{observers:i}=this;for(;i.length;)i.shift().complete()}})}unsubscribe(){this.isStopped=this.closed=!0,this.observers=this.currentObservers=null}get observed(){var i;return((i=this.observers)===null||i===void 0?void 0:i.length)>0}_trySubscribe(i){return this._throwIfClosed(),super._trySubscribe(i)}_subscribe(i){return this._throwIfClosed(),this._checkFinalizedStatuses(i),this._innerSubscribe(i)}_innerSubscribe(i){let{hasError:r,isStopped:n,observers:s}=this;return r||n?zM:(this.currentObservers=null,s.push(i),new Un(()=>{this.currentObservers=null,u_(s,i)}))}_checkFinalizedStatuses(i){let{hasError:r,thrownError:n,isStopped:s}=this;r?i.error(n):s&&i.complete()}asObservable(){let i=new Xi;return i.source=this,i}}return e.create=(t,i)=>new lb(t,i),e})(),lb=class extends Xa{constructor(t,i){super(),this.destination=t,this.source=i}next(t){var i,r;(r=(i=this.destination)===null||i===void 0?void 0:i.next)===null||r===void 0||r.call(i,t)}error(t){var i,r;(r=(i=this.destination)===null||i===void 0?void 0:i.error)===null||r===void 0||r.call(i,t)}complete(){var t,i;(i=(t=this.destination)===null||t===void 0?void 0:t.complete)===null||i===void 0||i.call(t)}_subscribe(t){var i,r;return(r=(i=this.source)===null||i===void 0?void 0:i.subscribe(t))!==null&&r!==void 0?r:zM}};var pa=class extends Xa{constructor(t){super(),this._value=t}get value(){return this.getValue()}_subscribe(t){let i=super._subscribe(t);return!i.closed&&t.next(this._value),i}getValue(){let{hasError:t,thrownError:i,_value:r}=this;if(t)throw i;return this._throwIfClosed(),r}next(t){super.next(this._value=t)}};function GH(e){return e&&Gt(e.schedule)}function qH(e){return e[e.length-1]}function WH(e){return Gt(qH(e))?e.pop():void 0}function $H(e){return GH(qH(e))?e.pop():void 0}function QH(e,t,i,r){function n(s){return s instanceof i?s:new i(function(o){o(s)})}return new(i||(i=Promise))(function(s,o){function a(h){try{c(r.next(h))}catch(p){o(p)}}function l(h){try{c(r.throw(h))}catch(p){o(p)}}function c(h){h.done?s(h.value):n(h.value).then(a,l)}c((r=r.apply(e,t||[])).next())})}function ZH(e){var t=typeof Symbol=="function"&&Symbol.iterator,i=t&&e[t],r=0;if(i)return i.call(e);if(e&&typeof e.length=="number")return{next:function(){return e&&r>=e.length&&(e=void 0),{value:e&&e[r++],done:!e}}};throw new TypeError(t?"Object is not iterable.":"Symbol.iterator is not defined.")}function Wd(e){return this instanceof Wd?(this.v=e,this):new Wd(e)}function YH(e,t,i){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var r=i.apply(e,t||[]),n,s=[];return n=Object.create((typeof AsyncIterator=="function"?AsyncIterator:Object).prototype),a("next"),a("throw"),a("return",o),n[Symbol.asyncIterator]=function(){return this},n;function o(f){return function(g){return Promise.resolve(g).then(f,p)}}function a(f,g){r[f]&&(n[f]=function(_){return new Promise(function(v,b){s.push([f,_,v,b])>1||l(f,_)})},g&&(n[f]=g(n[f])))}function l(f,g){try{c(r[f](g))}catch(_){m(s[0][3],_)}}function c(f){f.value instanceof Wd?Promise.resolve(f.value.v).then(h,p):m(s[0][2],f)}function h(f){l("next",f)}function p(f){l("throw",f)}function m(f,g){f(g),s.shift(),s.length&&l(s[0][0],s[0][1])}}function KH(e){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var t=e[Symbol.asyncIterator],i;return t?t.call(e):(e=typeof ZH=="function"?ZH(e):e[Symbol.iterator](),i={},r("next"),r("throw"),r("return"),i[Symbol.asyncIterator]=function(){return this},i);function r(s){i[s]=e[s]&&function(o){return new Promise(function(a,l){o=e[s](o),n(a,l,o.done,o.value)})}}function n(s,o,a,l){Promise.resolve(l).then(function(c){s({value:c,done:a})},o)}}var cb=e=>e&&typeof e.length=="number"&&typeof e!="function";function ub(e){return Gt(e?.then)}function db(e){return Gt(e[wm])}function hb(e){return Symbol.asyncIterator&&Gt(e?.[Symbol.asyncIterator])}function pb(e){return new TypeError(`You provided ${e!==null&&typeof e=="object"?"an invalid object":`'${e}'`} where a stream was expected. You can provide an Observable, Promise, ReadableStream, Array, AsyncIterable, or Iterable.`)}function e9(){return typeof Symbol!="function"||!Symbol.iterator?"@@iterator":Symbol.iterator}var mb=e9();function fb(e){return Gt(e?.[mb])}function gb(e){return YH(this,arguments,function*(){let i=e.getReader();try{for(;;){let{value:r,done:n}=yield Wd(i.read());if(n)return yield Wd(void 0);yield yield Wd(r)}}finally{i.releaseLock()}})}function _b(e){return Gt(e?.getReader)}function ds(e){if(e instanceof Xi)return e;if(e!=null){if(db(e))return t9(e);if(cb(e))return i9(e);if(ub(e))return r9(e);if(hb(e))return XH(e);if(fb(e))return n9(e);if(_b(e))return s9(e)}throw pb(e)}function t9(e){return new Xi(t=>{let i=e[wm]();if(Gt(i.subscribe))return i.subscribe(t);throw new TypeError("Provided object does not correctly implement Symbol.observable")})}function i9(e){return new Xi(t=>{for(let i=0;i<e.length&&!t.closed;i++)t.next(e[i]);t.complete()})}function r9(e){return new Xi(t=>{e.then(i=>{t.closed||(t.next(i),t.complete())},i=>t.error(i)).then(null,ob)})}function n9(e){return new Xi(t=>{for(let i of e)if(t.next(i),t.closed)return;t.complete()})}function XH(e){return new Xi(t=>{o9(e,t).catch(i=>t.error(i))})}function s9(e){return XH(gb(e))}function o9(e,t){var i,r,n,s;return QH(this,void 0,void 0,function*(){try{for(i=KH(e);r=yield i.next(),!r.done;){let o=r.value;if(t.next(o),t.closed)return}}catch(o){n={error:o}}finally{try{r&&!r.done&&(s=i.return)&&(yield s.call(i))}finally{if(n)throw n.error}}t.complete()})}function Co(e,t,i,r=0,n=!1){let s=t.schedule(function(){i(),n?e.add(this.schedule(null,r)):this.unsubscribe()},r);if(e.add(s),!n)return s}function yb(e,t=0){return cs((i,r)=>{i.subscribe(us(r,n=>Co(r,e,()=>r.next(n),t),()=>Co(r,e,()=>r.complete(),t),n=>Co(r,e,()=>r.error(n),t)))})}function vb(e,t=0){return cs((i,r)=>{r.add(e.schedule(()=>i.subscribe(r),t))})}function JH(e,t){return ds(e).pipe(vb(t),yb(t))}function eB(e,t){return ds(e).pipe(vb(t),yb(t))}function tB(e,t){return new Xi(i=>{let r=0;return t.schedule(function(){r===e.length?i.complete():(i.next(e[r++]),i.closed||this.schedule())})})}function iB(e,t){return new Xi(i=>{let r;return Co(i,t,()=>{r=e[mb](),Co(i,t,()=>{let n,s;try{({value:n,done:s}=r.next())}catch(o){i.error(o);return}s?i.complete():i.next(n)},0,!0)}),()=>Gt(r?.return)&&r.return()})}function wb(e,t){if(!e)throw new Error("Iterable cannot be null");return new Xi(i=>{Co(i,t,()=>{let r=e[Symbol.asyncIterator]();Co(i,t,()=>{r.next().then(n=>{n.done?i.complete():i.next(n.value)})},0,!0)})})}function rB(e,t){return wb(gb(e),t)}function nB(e,t){if(e!=null){if(db(e))return JH(e,t);if(cb(e))return tB(e,t);if(ub(e))return eB(e,t);if(hb(e))return wb(e,t);if(fb(e))return iB(e,t);if(_b(e))return rB(e,t)}throw pb(e)}function $d(e,t){return t?nB(e,t):ds(e)}function bb(...e){let t=$H(e);return $d(e,t)}function hs(e,t){return cs((i,r)=>{let n=0;i.subscribe(us(r,s=>{r.next(e.call(t,s,n++))}))})}var{isArray:a9}=Array;function l9(e,t){return a9(t)?e(...t):e(t)}function sB(e){return hs(t=>l9(e,t))}var{isArray:c9}=Array,{getPrototypeOf:u9,prototype:d9,keys:h9}=Object;function oB(e){if(e.length===1){let t=e[0];if(c9(t))return{args:t,keys:null};if(p9(t)){let i=h9(t);return{args:i.map(r=>t[r]),keys:i}}}return{args:e,keys:null}}function p9(e){return e&&typeof e=="object"&&u9(e)===d9}function aB(e,t){return e.reduce((i,r,n)=>(i[r]=t[n],i),{})}function lB(e,t,i,r,n,s,o,a){let l=[],c=0,h=0,p=!1,m=()=>{p&&!l.length&&!c&&t.complete()},f=_=>c<r?g(_):l.push(_),g=_=>{s&&t.next(_),c++;let v=!1;ds(i(_,h++)).subscribe(us(t,b=>{n?.(b),s?f(b):t.next(b)},()=>{v=!0},void 0,()=>{if(v)try{for(c--;l.length&&c<r;){let b=l.shift();o?Co(t,o,()=>g(b)):g(b)}m()}catch(b){t.error(b)}}))};return e.subscribe(us(t,f,()=>{p=!0,m()})),()=>{a?.()}}function Cb(e,t,i=1/0){return Gt(t)?Cb((r,n)=>hs((s,o)=>t(r,s,n,o))(ds(e(r,n))),i):(typeof t=="number"&&(i=t),cs((r,n)=>lB(r,n,e,i)))}function YM(...e){let t=WH(e),{args:i,keys:r}=oB(e),n=new Xi(s=>{let{length:o}=i;if(!o){s.complete();return}let a=new Array(o),l=o,c=o;for(let h=0;h<o;h++){let p=!1;ds(i[h]).subscribe(us(s,m=>{p||(p=!0,c--),a[h]=m},()=>l--,void 0,()=>{(!l||!p)&&(c||s.next(r?aB(r,a):a),s.complete())}))}});return t?n.pipe(sB(t)):n}function KM(e,t){return cs((i,r)=>{let n=0;i.subscribe(us(r,s=>e.call(t,s,n++)&&r.next(s)))})}function XM(e,t){return Gt(t)?Cb(e,t,1):Cb(e,1)}function JM(e){return cs((t,i)=>{try{t.subscribe(i)}finally{i.add(e)}})}function eS(e,t){return cs((i,r)=>{let n=null,s=0,o=!1,a=()=>o&&!n&&r.complete();i.subscribe(us(r,l=>{n?.unsubscribe();let c=0,h=s++;ds(e(l,h)).subscribe(n=us(r,p=>r.next(t?t(l,p,h,c++):p),()=>{n=null,a()}))},()=>{o=!0,a()}))})}function cB(e){let t=Et(null);try{return e()}finally{Et(t)}}var pS="https://angular.dev/best-practices/security#preventing-cross-site-scripting-xss",ct=class extends Error{code;constructor(t,i){super(mS(t,i)),this.code=t}};function m9(e){return`NG0${Math.abs(e)}`}function mS(e,t){return`${m9(e)}${t?": "+t:""}`}function rr(e){for(let t in e)if(e[t]===rr)return t;throw Error("")}function pB(e,t){for(let i in t)t.hasOwnProperty(i)&&!e.hasOwnProperty(i)&&(e[i]=t[i])}function Fs(e){if(typeof e=="string")return e;if(Array.isArray(e))return`[${e.map(Fs).join(", ")}]`;if(e==null)return""+e;let t=e.overriddenName||e.name;if(t)return`${t}`;let i=e.toString();if(i==null)return""+i;let r=i.indexOf(`
`);return r>=0?i.slice(0,r):i}function fS(e,t){return e?t?`${e} ${t}`:e:t||""}var f9=rr({__forward_ref__:rr});function ec(e){return e.__forward_ref__=ec,e.toString=function(){return Fs(this())},e}function sn(e){return gS(e)?e():e}function gS(e){return typeof e=="function"&&e.hasOwnProperty(f9)&&e.__forward_ref__===ec}function mB(e,t,i,r){throw new Error(`ASSERTION ERROR: ${e}`+(r==null?"":` [Expected=> ${i} ${r} ${t} <=Actual]`))}function Zt(e){return{token:e.token,providedIn:e.providedIn||null,factory:e.factory,value:void 0}}function tc(e){return{providers:e.providers||[],imports:e.imports||[]}}function Mb(e){return g9(e,Sb)}function g9(e,t){return e.hasOwnProperty(t)&&e[t]||null}function _9(e){let t=e?.[Sb]??null;return t||null}function iS(e){return e&&e.hasOwnProperty(Eb)?e[Eb]:null}var Sb=rr({\u0275prov:rr}),Eb=rr({\u0275inj:rr}),ht=class{_desc;ngMetadataName="InjectionToken";\u0275prov;constructor(t,i){this._desc=t,this.\u0275prov=void 0,typeof i=="number"?this.__NG_ELEMENT_ID__=i:i!==void 0&&(this.\u0275prov=Zt({token:this,providedIn:i.providedIn||"root",factory:i.factory}))}get multi(){return this}toString(){return`InjectionToken ${this._desc}`}};function _S(e){return e&&!!e.\u0275providers}var yS=rr({\u0275cmp:rr}),vS=rr({\u0275dir:rr}),wS=rr({\u0275pipe:rr});var h_=rr({\u0275fac:rr}),Jd=rr({__NG_ELEMENT_ID__:rr}),uB=rr({__NG_ENV_ID__:rr});function Ib(e){return typeof e=="string"?e:e==null?"":String(e)}function fB(e){return typeof e=="function"?e.name||e.toString():typeof e=="object"&&e!=null&&typeof e.type=="function"?e.type.name||e.type.toString():Ib(e)}function bS(e,t){throw new ct(-200,e)}function Ab(e,t){throw new ct(-201,!1)}var rS;function gB(){return rS}function Ls(e){let t=rS;return rS=e,t}function CS(e,t,i){let r=Mb(e);if(r&&r.providedIn=="root")return r.value===void 0?r.value=r.factory():r.value;if(i&8)return null;if(t!==void 0)return t;Ab(e,"Injector")}var y9={},Zd=y9,nS="__NG_DI_FLAG__",sS=class{injector;constructor(t){this.injector=t}retrieve(t,i){let r=Qd(i)||0;try{return this.injector.get(t,r&8?null:Zd,r)}catch(n){if(fm(n))return n;throw n}}},Db="ngTempTokenPath",v9="ngTokenPath",w9=/\n/gm,b9="\u0275",dB="__source";function C9(e,t=0){let i=FM();if(i===void 0)throw new ct(-203,!1);if(i===null)return CS(e,void 0,t);{let r=T9(t),n=i.retrieve(e,r);if(fm(n)){if(r.optional)return null;throw n}return n}}function Bt(e,t=0){return(gB()||C9)(sn(e),t)}function ot(e,t){return Bt(e,Qd(t))}function Qd(e){return typeof e>"u"||typeof e=="number"?e:0|(e.optional&&8)|(e.host&&1)|(e.self&&2)|(e.skipSelf&&4)}function T9(e){return{optional:!!(e&8),host:!!(e&1),self:!!(e&2),skipSelf:!!(e&4)}}function oS(e){let t=[];for(let i=0;i<e.length;i++){let r=sn(e[i]);if(Array.isArray(r)){if(r.length===0)throw new ct(900,!1);let n,s=0;for(let o=0;o<r.length;o++){let a=r[o],l=E9(a);typeof l=="number"?l===-1?n=a.token:s|=l:n=a}t.push(Bt(n,s))}else t.push(Bt(r))}return t}function TS(e,t){return e[nS]=t,e.prototype[nS]=t,e}function E9(e){return e[nS]}function D9(e,t,i,r){let n=e[Db];throw t[dB]&&n.unshift(t[dB]),e.message=x9(`
`+e.message,n,i,r),e[v9]=n,e[Db]=null,e}function x9(e,t,i,r=null){e=e&&e.charAt(0)===`
`&&e.charAt(1)==b9?e.slice(2):e;let n=Fs(t);if(Array.isArray(t))n=t.map(Fs).join(" -> ");else if(typeof t=="object"){let s=[];for(let o in t)if(t.hasOwnProperty(o)){let a=t[o];s.push(o+":"+(typeof a=="string"?JSON.stringify(a):Fs(a)))}n=`{${s.join(", ")}}`}return`${i}${r?"("+r+")":""}[${n}]: ${e.replace(w9,`
  `)}`}function Yd(e,t){let i=e.hasOwnProperty(h_);return i?e[h_]:null}function _B(e,t,i){if(e.length!==t.length)return!1;for(let r=0;r<e.length;r++){let n=e[r],s=t[r];if(i&&(n=i(n),s=i(s)),s!==n)return!1}return!0}function yB(e){return e.flat(Number.POSITIVE_INFINITY)}function Rb(e,t){e.forEach(i=>Array.isArray(i)?Rb(i,t):t(i))}function ES(e,t,i){t>=e.length?e.push(i):e.splice(t,0,i)}function m_(e,t){return t>=e.length-1?e.pop():e.splice(t,1)[0]}function vB(e,t,i,r){let n=e.length;if(n==t)e.push(i,r);else if(n===1)e.push(r,e[0]),e[0]=i;else{for(n--,e.push(e[n-1],e[n]);n>t;){let s=n-2;e[n]=e[s],n--}e[t]=i,e[t+1]=r}}function wB(e,t,i){let r=Cm(e,t);return r>=0?e[r|1]=i:(r=~r,vB(e,r,t,i)),r}function Pb(e,t){let i=Cm(e,t);if(i>=0)return e[i|1]}function Cm(e,t){return M9(e,t,1)}function M9(e,t,i){let r=0,n=e.length>>i;for(;n!==r;){let s=r+(n-r>>1),o=e[s<<i];if(t===o)return s<<i;o>t?n=s:r=s+1}return~(n<<i)}var gu={},ks=[],_u=new ht(""),DS=new ht("",-1),xS=new ht(""),p_=class{get(t,i=Zd){if(i===Zd)throw new Uw(`NullInjectorError: No provider for ${Fs(t)}!`);return i}};function eh(e){return e[yS]||null}function MS(e){return e[vS]||null}function bB(e){return e[wS]||null}function th(e){return{\u0275providers:e}}function CB(e){return th([{provide:_u,multi:!0,useValue:e}])}function TB(...e){return{\u0275providers:SS(!0,e),\u0275fromNgModule:!0}}function SS(e,...t){let i=[],r=new Set,n,s=o=>{i.push(o)};return Rb(t,o=>{let a=o;xb(a,s,[],r)&&(n||=[],n.push(a))}),n!==void 0&&EB(n,s),i}function EB(e,t){for(let i=0;i<e.length;i++){let{ngModule:r,providers:n}=e[i];IS(n,s=>{t(s,r)})}}function xb(e,t,i,r){if(e=sn(e),!e)return!1;let n=null,s=iS(e),o=!s&&eh(e);if(!s&&!o){let l=e.ngModule;if(s=iS(l),s)n=l;else return!1}else{if(o&&!o.standalone)return!1;n=e}let a=r.has(n);if(o){if(a)return!1;if(r.add(n),o.dependencies){let l=typeof o.dependencies=="function"?o.dependencies():o.dependencies;for(let c of l)xb(c,t,i,r)}}else if(s){if(s.imports!=null&&!a){r.add(n);let c;try{Rb(s.imports,h=>{xb(h,t,i,r)&&(c||=[],c.push(h))})}finally{}c!==void 0&&EB(c,t)}if(!a){let c=Yd(n)||(()=>new n);t({provide:n,useFactory:c,deps:ks},n),t({provide:xS,useValue:n,multi:!0},n),t({provide:_u,useValue:()=>Bt(n),multi:!0},n)}let l=s.providers;if(l!=null&&!a){let c=e;IS(l,h=>{t(h,c)})}}else return!1;return n!==e&&e.providers!==void 0}function IS(e,t){for(let i of e)_S(i)&&(i=i.\u0275providers),Array.isArray(i)?IS(i,t):t(i)}var S9=rr({provide:String,useValue:rr});function DB(e){return e!==null&&typeof e=="object"&&S9 in e}function I9(e){return!!(e&&e.useExisting)}function A9(e){return!!(e&&e.useFactory)}function Kd(e){return typeof e=="function"}function xB(e){return!!e.useClass}var f_=new ht(""),Tb={},hB={},tS;function g_(){return tS===void 0&&(tS=new p_),tS}var ps=class{},Xd=class extends ps{parent;source;scopes;records=new Map;_ngOnDestroyHooks=new Set;_onDestroyHooks=[];get destroyed(){return this._destroyed}_destroyed=!1;injectorDefTypes;constructor(t,i,r,n){super(),this.parent=i,this.source=r,this.scopes=n,lS(t,o=>this.processProvider(o)),this.records.set(DS,bm(void 0,this)),n.has("environment")&&this.records.set(ps,bm(void 0,this));let s=this.records.get(f_);s!=null&&typeof s.value=="string"&&this.scopes.add(s.value),this.injectorDefTypes=new Set(this.get(xS,ks,{self:!0}))}retrieve(t,i){let r=Qd(i)||0;try{return this.get(t,Zd,r)}catch(n){if(fm(n))return n;throw n}}destroy(){d_(this),this._destroyed=!0;let t=Et(null);try{for(let r of this._ngOnDestroyHooks)r.ngOnDestroy();let i=this._onDestroyHooks;this._onDestroyHooks=[];for(let r of i)r()}finally{this.records.clear(),this._ngOnDestroyHooks.clear(),this.injectorDefTypes.clear(),Et(t)}}onDestroy(t){return d_(this),this._onDestroyHooks.push(t),()=>this.removeOnDestroy(t)}runInContext(t){d_(this);let i=Kl(this),r=Ls(void 0),n;try{return t()}finally{Kl(i),Ls(r)}}get(t,i=Zd,r){if(d_(this),t.hasOwnProperty(uB))return t[uB](this);let n=Qd(r),s,o=Kl(this),a=Ls(void 0);try{if(!(n&4)){let c=this.records.get(t);if(c===void 0){let h=L9(t)&&Mb(t);h&&this.injectableDefInScope(h)?c=bm(aS(t),Tb):c=null,this.records.set(t,c)}if(c!=null)return this.hydrate(t,c)}let l=n&2?g_():this.parent;return i=n&8&&i===Zd?null:i,l.get(t,i)}catch(l){if(fm(l)){if((l[Db]=l[Db]||[]).unshift(Fs(t)),o)throw l;return D9(l,t,"R3InjectorError",this.source)}else throw l}finally{Ls(a),Kl(o)}}resolveInjectorInitializers(){let t=Et(null),i=Kl(this),r=Ls(void 0),n;try{let s=this.get(_u,ks,{self:!0});for(let o of s)o()}finally{Kl(i),Ls(r),Et(t)}}toString(){let t=[],i=this.records;for(let r of i.keys())t.push(Fs(r));return`R3Injector[${t.join(", ")}]`}processProvider(t){t=sn(t);let i=Kd(t)?t:sn(t&&t.provide),r=P9(t);if(!Kd(t)&&t.multi===!0){let n=this.records.get(i);n||(n=bm(void 0,Tb,!0),n.factory=()=>oS(n.multi),this.records.set(i,n)),i=t,n.multi.push(t)}this.records.set(i,r)}hydrate(t,i){let r=Et(null);try{return i.value===hB?bS(Fs(t)):i.value===Tb&&(i.value=hB,i.value=i.factory()),typeof i.value=="object"&&i.value&&N9(i.value)&&this._ngOnDestroyHooks.add(i.value),i.value}finally{Et(r)}}injectableDefInScope(t){if(!t.providedIn)return!1;let i=sn(t.providedIn);return typeof i=="string"?i==="any"||this.scopes.has(i):this.injectorDefTypes.has(i)}removeOnDestroy(t){let i=this._onDestroyHooks.indexOf(t);i!==-1&&this._onDestroyHooks.splice(i,1)}};function aS(e){let t=Mb(e),i=t!==null?t.factory:Yd(e);if(i!==null)return i;if(e instanceof ht)throw new ct(204,!1);if(e instanceof Function)return R9(e);throw new ct(204,!1)}function R9(e){if(e.length>0)throw new ct(204,!1);let i=_9(e);return i!==null?()=>i.factory(e):()=>new e}function P9(e){if(DB(e))return bm(void 0,e.useValue);{let t=AS(e);return bm(t,Tb)}}function AS(e,t,i){let r;if(Kd(e)){let n=sn(e);return Yd(n)||aS(n)}else if(DB(e))r=()=>sn(e.useValue);else if(A9(e))r=()=>e.useFactory(...oS(e.deps||[]));else if(I9(e))r=()=>Bt(sn(e.useExisting));else{let n=sn(e&&(e.useClass||e.provide));if(O9(e))r=()=>new n(...oS(e.deps));else return Yd(n)||aS(n)}return r}function d_(e){if(e.destroyed)throw new ct(205,!1)}function bm(e,t,i=!1){return{factory:e,value:t,multi:i?[]:void 0}}function O9(e){return!!e.deps}function N9(e){return e!==null&&typeof e=="object"&&typeof e.ngOnDestroy=="function"}function L9(e){return typeof e=="function"||typeof e=="object"&&e.ngMetadataName==="InjectionToken"}function lS(e,t){for(let i of e)Array.isArray(i)?lS(i,t):i&&_S(i)?lS(i.\u0275providers,t):t(i)}function Tm(e,t){let i;e instanceof Xd?(d_(e),i=e):i=new sS(e);let r,n=Kl(i),s=Ls(void 0);try{return t()}finally{Kl(n),Ls(s)}}function MB(){return gB()!==void 0||FM()!=null}var ma=0,Dt=1,vt=2,$r=3,To=4,Eo=5,__=6,Em=7,on=8,ih=9,ic=10,hr=11,Dm=12,RS=13,rh=14,Do=15,yu=16,nh=17,el=18,y_=19,PS=20,Xl=21,Ob=22,v_=23,Vs=24,Nb=25,Hs=26,SB=1;var vu=7,w_=8,sh=9,bn=10;function tl(e){return Array.isArray(e)&&typeof e[SB]=="object"}function fa(e){return Array.isArray(e)&&e[SB]===!0}function OS(e){return(e.flags&4)!==0}function wu(e){return e.componentOffset>-1}function Lb(e){return(e.flags&1)===1}function il(e){return!!e.template}function xm(e){return(e[vt]&512)!==0}function oh(e){return(e[vt]&256)===256}var IB="svg",AB="math";function xo(e){for(;Array.isArray(e);)e=e[ma];return e}function NS(e,t){return xo(t[e])}function ga(e,t){return xo(t[e.index])}function b_(e,t){return e.data[t]}function Mo(e,t){let i=t[e];return tl(i)?i:i[ma]}function RB(e){return(e[vt]&4)===4}function Fb(e){return(e[vt]&128)===128}function PB(e){return fa(e[$r])}function ah(e,t){return t==null?null:e[t]}function LS(e){e[nh]=0}function FS(e){e[vt]&1024||(e[vt]|=1024,Fb(e)&&T_(e))}function OB(e,t){for(;e>0;)t=t[rh],e--;return t}function C_(e){return!!(e[vt]&9216||e[Vs]?.dirty)}function kb(e){e[ic].changeDetectionScheduler?.notify(8),e[vt]&64&&(e[vt]|=1024),C_(e)&&T_(e)}function T_(e){e[ic].changeDetectionScheduler?.notify(0);let t=mu(e);for(;t!==null&&!(t[vt]&8192||(t[vt]|=8192,!Fb(t)));)t=mu(t)}function kS(e,t){if(oh(e))throw new ct(911,!1);e[Xl]===null&&(e[Xl]=[]),e[Xl].push(t)}function NB(e,t){if(e[Xl]===null)return;let i=e[Xl].indexOf(t);i!==-1&&e[Xl].splice(i,1)}function mu(e){let t=e[$r];return fa(t)?t[$r]:t}function VS(e){return e[Em]??=[]}function HS(e){return e.cleanup??=[]}function LB(e,t,i,r){let n=VS(t);n.push(i),e.firstCreatePass&&HS(e).push(r,n.length-1)}var Ut={lFrame:KB(null),bindingsEnabled:!0,skipHydrationRootTNode:null},E_=function(e){return e[e.Off=0]="Off",e[e.Exhaustive=1]="Exhaustive",e[e.OnlyDirtyViews=2]="OnlyDirtyViews",e}(E_||{}),F9=0,cS=!1;function FB(){return Ut.lFrame.elementDepthCount}function kB(){Ut.lFrame.elementDepthCount++}function VB(){Ut.lFrame.elementDepthCount--}function BS(){return Ut.bindingsEnabled}function HB(){return Ut.skipHydrationRootTNode!==null}function BB(e){return Ut.skipHydrationRootTNode===e}function UB(){Ut.skipHydrationRootTNode=null}function hi(){return Ut.lFrame.lView}function Zr(){return Ut.lFrame.tView}function Mm(e){return Ut.lFrame.contextLView=e,e[on]}function Sm(e){return Ut.lFrame.contextLView=null,e}function ms(){let e=US();for(;e!==null&&e.type===64;)e=e.parent;return e}function US(){return Ut.lFrame.currentTNode}function jB(){let e=Ut.lFrame,t=e.currentTNode;return e.isParent?t:t.parent}function Im(e,t){let i=Ut.lFrame;i.currentTNode=e,i.isParent=t}function jS(){return Ut.lFrame.isParent}function zB(){Ut.lFrame.isParent=!1}function zS(e){mB("Must never be called in production mode"),F9=e}function GS(){return cS}function qS(e){let t=cS;return cS=e,t}function GB(e){return Ut.lFrame.bindingIndex=e}function Am(){return Ut.lFrame.bindingIndex++}function qB(e){let t=Ut.lFrame,i=t.bindingIndex;return t.bindingIndex=t.bindingIndex+e,i}function WB(){return Ut.lFrame.inI18n}function $B(e,t){let i=Ut.lFrame;i.bindingIndex=i.bindingRootIndex=e,Vb(t)}function ZB(){return Ut.lFrame.currentDirectiveIndex}function Vb(e){Ut.lFrame.currentDirectiveIndex=e}function QB(e){let t=Ut.lFrame.currentDirectiveIndex;return t===-1?null:e[t]}function WS(){return Ut.lFrame.currentQueryIndex}function Hb(e){Ut.lFrame.currentQueryIndex=e}function k9(e){let t=e[Dt];return t.type===2?t.declTNode:t.type===1?e[Eo]:null}function $S(e,t,i){if(i&4){let n=t,s=e;for(;n=n.parent,n===null&&!(i&1);)if(n=k9(s),n===null||(s=s[rh],n.type&10))break;if(n===null)return!1;t=n,e=s}let r=Ut.lFrame=YB();return r.currentTNode=t,r.lView=e,!0}function Bb(e){let t=YB(),i=e[Dt];Ut.lFrame=t,t.currentTNode=i.firstChild,t.lView=e,t.tView=i,t.contextLView=e,t.bindingIndex=i.bindingStartIndex,t.inI18n=!1}function YB(){let e=Ut.lFrame,t=e===null?null:e.child;return t===null?KB(e):t}function KB(e){let t={currentTNode:null,isParent:!0,lView:null,tView:null,selectedIndex:-1,contextLView:null,elementDepthCount:0,currentNamespace:null,currentDirectiveIndex:-1,bindingRootIndex:-1,bindingIndex:-1,currentQueryIndex:0,parent:e,child:null,inI18n:!1};return e!==null&&(e.child=t),t}function XB(){let e=Ut.lFrame;return Ut.lFrame=e.parent,e.currentTNode=null,e.lView=null,e}var ZS=XB;function Ub(){let e=XB();e.isParent=!0,e.tView=null,e.selectedIndex=-1,e.contextLView=null,e.elementDepthCount=0,e.currentDirectiveIndex=-1,e.currentNamespace=null,e.bindingRootIndex=-1,e.bindingIndex=-1,e.currentQueryIndex=0}function JB(e){return(Ut.lFrame.contextLView=OB(e,Ut.lFrame.contextLView))[on]}function lh(){return Ut.lFrame.selectedIndex}function bu(e){Ut.lFrame.selectedIndex=e}function jb(){let e=Ut.lFrame;return b_(e.tView,e.selectedIndex)}function eU(){return Ut.lFrame.currentNamespace}var tU=!0;function zb(){return tU}function Gb(e){tU=e}function uS(e,t=null,i=null,r){let n=iU(e,t,i,r);return n.resolveInjectorInitializers(),n}function iU(e,t=null,i=null,r,n=new Set){let s=[i||ks,TB(e)];return r=r||(typeof e=="object"?void 0:Fs(e)),new Xd(s,t||g_(),r||null,n)}var fu=class e{static THROW_IF_NOT_FOUND=Zd;static NULL=new p_;static create(t,i){if(Array.isArray(t))return uS({name:""},i,t,"");{let r=t.name??"";return uS({name:r},t.parent,t.providers,r)}}static \u0275prov=Zt({token:e,providedIn:"any",factory:()=>Bt(DS)});static __NG_ELEMENT_ID__=-1},fs=new ht(""),Rm=(()=>{class e{static __NG_ELEMENT_ID__=V9;static __NG_ENV_ID__=i=>i}return e})(),dS=class extends Rm{_lView;constructor(t){super(),this._lView=t}get destroyed(){return oh(this._lView)}onDestroy(t){let i=this._lView;return kS(i,t),()=>NB(i,t)}};function V9(){return new dS(hi())}var Ja=class{_console=console;handleError(t){this._console.error("ERROR",t)}},rl=new ht("",{providedIn:"root",factory:()=>{let e=ot(ps),t;return i=>{t??=e.get(Ja),t.handleError(i)}}}),rU={provide:_u,useValue:()=>void ot(Ja),multi:!0},H9=new ht("",{providedIn:"root",factory:()=>{let e=ot(fs).defaultView;if(!e)return;let t=ot(rl),i=s=>{t(s.reason),s.preventDefault()},r=s=>{t(s.error),s.preventDefault()},n=()=>{e.addEventListener("unhandledrejection",i),e.addEventListener("error",r)};typeof Zone<"u"?Zone.root.run(n):n(),ot(Rm).onDestroy(()=>{e.removeEventListener("error",r),e.removeEventListener("unhandledrejection",i)})}});function QS(){return th([CB(()=>void ot(H9))])}function YS(e){return typeof e=="function"&&e[ls]!==void 0}function ch(e,t){let[i,r,n]=UM(e,t?.equal),s=i,o=s[ls];return s.set=r,s.update=n,s.asReadonly=nU.bind(s),s}function nU(){let e=this[ls];if(e.readonlyFn===void 0){let t=()=>this();t[ls]=e,e.readonlyFn=t}return e.readonlyFn}function KS(e){return YS(e)&&typeof e.set=="function"}var Jl=class{},D_=new ht("",{providedIn:"root",factory:()=>!1});var XS=new ht(""),qb=new ht("");var uh=(()=>{class e{taskId=0;pendingTasks=new Set;destroyed=!1;pendingTask=new pa(!1);get hasPendingTasks(){return this.destroyed?!1:this.pendingTask.value}get hasPendingTasksObservable(){return this.destroyed?new Xi(i=>{i.next(!1),i.complete()}):this.pendingTask}add(){!this.hasPendingTasks&&!this.destroyed&&this.pendingTask.next(!0);let i=this.taskId++;return this.pendingTasks.add(i),i}has(i){return this.pendingTasks.has(i)}remove(i){this.pendingTasks.delete(i),this.pendingTasks.size===0&&this.hasPendingTasks&&this.pendingTask.next(!1)}ngOnDestroy(){this.pendingTasks.clear(),this.hasPendingTasks&&this.pendingTask.next(!1),this.destroyed=!0,this.pendingTask.unsubscribe()}static \u0275prov=Zt({token:e,providedIn:"root",factory:()=>new e})}return e})(),Wb=(()=>{class e{internalPendingTasks=ot(uh);scheduler=ot(Jl);errorHandler=ot(rl);add(){let i=this.internalPendingTasks.add();return()=>{this.internalPendingTasks.has(i)&&(this.scheduler.notify(11),this.internalPendingTasks.remove(i))}}run(i){let r=this.add();i().catch(this.errorHandler).finally(r)}static \u0275prov=Zt({token:e,providedIn:"root",factory:()=>new e})}return e})();function x_(...e){}var JS=(()=>{class e{static \u0275prov=Zt({token:e,providedIn:"root",factory:()=>new hS})}return e})(),hS=class{dirtyEffectCount=0;queues=new Map;add(t){this.enqueue(t),this.schedule(t)}schedule(t){t.dirty&&this.dirtyEffectCount++}remove(t){let i=t.zone,r=this.queues.get(i);r.has(t)&&(r.delete(t),t.dirty&&this.dirtyEffectCount--)}enqueue(t){let i=t.zone;this.queues.has(i)||this.queues.set(i,new Set);let r=this.queues.get(i);r.has(t)||r.add(t)}flush(){for(;this.dirtyEffectCount>0;){let t=!1;for(let[i,r]of this.queues)i===null?t||=this.flushQueue(r):t||=i.run(()=>this.flushQueue(r));t||(this.dirtyEffectCount=0)}}flushQueue(t){let i=!1;for(let r of t)r.dirty&&(this.dirtyEffectCount--,i=!0,r.run());return i}};function Lm(e){return{toString:e}.toString()}var $b="__parameters__";function X9(e){return function(...i){if(e){let r=e(...i);for(let n in r)this[n]=r[n]}}}function LU(e,t,i){return Lm(()=>{let r=X9(t);function n(...s){if(this instanceof n)return r.apply(this,s),this;let o=new n(...s);return a.annotation=o,a;function a(l,c,h){let p=l.hasOwnProperty($b)?l[$b]:Object.defineProperty(l,$b,{value:[]})[$b];for(;p.length<=h;)p.push(null);return(p[h]=p[h]||[]).push(o),l}}return n.prototype.ngMetadataName=e,n.annotationCls=n,n})}var FU=TS(LU("Optional"),8);var kU=TS(LU("SkipSelf"),4);function J9(e){return typeof e=="function"}var Jb=class{previousValue;currentValue;firstChange;constructor(t,i,r){this.previousValue=t,this.currentValue=i,this.firstChange=r}isFirstChange(){return this.firstChange}};function VU(e,t,i,r){t!==null?t.applyValueToInputSignal(t,r):e[i]=r}var sc=(()=>{let e=()=>HU;return e.ngInherit=!0,e})();function HU(e){return e.type.prototype.ngOnChanges&&(e.setInput=t7),e7}function e7(){let e=UU(this),t=e?.current;if(t){let i=e.previous;if(i===gu)e.previous=t;else for(let r in t)i[r]=t[r];e.current=null,this.ngOnChanges(t)}}function t7(e,t,i,r,n){let s=this.declaredInputs[r],o=UU(e)||i7(e,{previous:gu,current:null}),a=o.current||(o.current={}),l=o.previous,c=l[s];a[s]=new Jb(c&&c.currentValue,i,l===gu),VU(e,t,n,i)}var BU="__ngSimpleChanges__";function UU(e){return e[BU]||null}function i7(e,t){return e[BU]=t}var sU=[];var Ii=function(e,t=null,i){for(let r=0;r<sU.length;r++){let n=sU[r];n(e,t,i)}};function r7(e,t,i){let{ngOnChanges:r,ngOnInit:n,ngDoCheck:s}=t.type.prototype;if(r){let o=HU(t);(i.preOrderHooks??=[]).push(e,o),(i.preOrderCheckHooks??=[]).push(e,o)}n&&(i.preOrderHooks??=[]).push(0-e,n),s&&((i.preOrderHooks??=[]).push(e,s),(i.preOrderCheckHooks??=[]).push(e,s))}function jU(e,t){for(let i=t.directiveStart,r=t.directiveEnd;i<r;i++){let s=e.data[i].type.prototype,{ngAfterContentInit:o,ngAfterContentChecked:a,ngAfterViewInit:l,ngAfterViewChecked:c,ngOnDestroy:h}=s;o&&(e.contentHooks??=[]).push(-i,o),a&&((e.contentHooks??=[]).push(i,a),(e.contentCheckHooks??=[]).push(i,a)),l&&(e.viewHooks??=[]).push(-i,l),c&&((e.viewHooks??=[]).push(i,c),(e.viewCheckHooks??=[]).push(i,c)),h!=null&&(e.destroyHooks??=[]).push(i,h)}}function Qb(e,t,i){zU(e,t,3,i)}function Yb(e,t,i,r){(e[vt]&3)===i&&zU(e,t,i,r)}function eI(e,t){let i=e[vt];(i&3)===t&&(i&=16383,i+=1,e[vt]=i)}function zU(e,t,i,r){let n=r!==void 0?e[nh]&65535:0,s=r??-1,o=t.length-1,a=0;for(let l=n;l<o;l++)if(typeof t[l+1]=="number"){if(a=t[l],r!=null&&a>=r)break}else t[l]<0&&(e[nh]+=65536),(a<s||s==-1)&&(n7(e,i,t,l),e[nh]=(e[nh]&4294901760)+l+2),l++}function oU(e,t){Ii(4,e,t);let i=Et(null);try{t.call(e)}finally{Et(i),Ii(5,e,t)}}function n7(e,t,i,r){let n=i[r]<0,s=i[r+1],o=n?-i[r]:i[r],a=e[o];n?e[vt]>>14<e[nh]>>16&&(e[vt]&3)===t&&(e[vt]+=16384,oU(a,s)):oU(a,s)}var Om=-1,hh=class{factory;injectImpl;resolving=!1;canSeeViewProviders;multi;componentProviders;index;providerFactory;constructor(t,i,r){this.factory=t,this.canSeeViewProviders=i,this.injectImpl=r}};function s7(e){return(e.flags&8)!==0}function o7(e){return(e.flags&16)!==0}function a7(e,t,i){let r=0;for(;r<i.length;){let n=i[r];if(typeof n=="number"){if(n!==0)break;r++;let s=i[r++],o=i[r++],a=i[r++];e.setAttribute(t,o,a,s)}else{let s=n,o=i[++r];c7(s)?e.setProperty(t,s,o):e.setAttribute(t,s,o),r++}}return r}function l7(e){return e===3||e===4||e===6}function c7(e){return e.charCodeAt(0)===64}function I_(e,t){if(!(t===null||t.length===0))if(e===null||e.length===0)e=t.slice();else{let i=-1;for(let r=0;r<t.length;r++){let n=t[r];typeof n=="number"?i=n:i===0||(i===-1||i===2?aU(e,i,n,null,t[++r]):aU(e,i,n,null,null))}}return e}function aU(e,t,i,r,n){let s=0,o=e.length;if(t===-1)o=-1;else for(;s<e.length;){let a=e[s++];if(typeof a=="number"){if(a===t){o=-1;break}else if(a>t){o=s-1;break}}}for(;s<e.length;){let a=e[s];if(typeof a=="number")break;if(a===i){n!==null&&(e[s+1]=n);return}s++,n!==null&&s++}o!==-1&&(e.splice(o,0,t),s=o+1),e.splice(s++,0,i),n!==null&&e.splice(s++,0,n)}function GU(e){return e!==Om}function eC(e){return e&32767}function u7(e){return e>>16}function tC(e,t){let i=u7(e),r=t;for(;i>0;)r=r[rh],i--;return r}var uI=!0;function lU(e){let t=uI;return uI=e,t}var d7=256,qU=d7-1,WU=5,h7=0,nl={};function p7(e,t,i){let r;typeof i=="string"?r=i.charCodeAt(0)||0:i.hasOwnProperty(Jd)&&(r=i[Jd]),r==null&&(r=i[Jd]=h7++);let n=r&qU,s=1<<n;t.data[e+(n>>WU)]|=s}function iC(e,t){let i=$U(e,t);if(i!==-1)return i;let r=t[Dt];r.firstCreatePass&&(e.injectorIndex=t.length,tI(r.data,e),tI(t,null),tI(r.blueprint,null));let n=kI(e,t),s=e.injectorIndex;if(GU(n)){let o=eC(n),a=tC(n,t),l=a[Dt].data;for(let c=0;c<8;c++)t[s+c]=a[o+c]|l[o+c]}return t[s+8]=n,s}function tI(e,t){e.push(0,0,0,0,0,0,0,0,t)}function $U(e,t){return e.injectorIndex===-1||e.parent&&e.parent.injectorIndex===e.injectorIndex||t[e.injectorIndex+8]===null?-1:e.injectorIndex}function kI(e,t){if(e.parent&&e.parent.injectorIndex!==-1)return e.parent.injectorIndex;let i=0,r=null,n=t;for(;n!==null;){if(r=XU(n),r===null)return Om;if(i++,n=n[rh],r.injectorIndex!==-1)return r.injectorIndex|i<<16}return Om}function dI(e,t,i){p7(e,t,i)}function ZU(e,t,i){if(i&8||e!==void 0)return e;Ab(t,"NodeInjector")}function QU(e,t,i,r){if(i&8&&r===void 0&&(r=null),(i&3)===0){let n=e[ih],s=Ls(void 0);try{return n?n.get(t,r,i&8):CS(t,r,i&8)}finally{Ls(s)}}return ZU(r,t,i)}function YU(e,t,i,r=0,n){if(e!==null){if(t[vt]&2048&&!(r&2)){let o=_7(e,t,i,r,nl);if(o!==nl)return o}let s=KU(e,t,i,r,nl);if(s!==nl)return s}return QU(t,i,r,n)}function KU(e,t,i,r,n){let s=f7(i);if(typeof s=="function"){if(!$S(t,e,r))return r&1?ZU(n,i,r):QU(t,i,r,n);try{let o;if(o=s(r),o==null&&!(r&8))Ab(i);else return o}finally{ZS()}}else if(typeof s=="number"){let o=null,a=$U(e,t),l=Om,c=r&1?t[Do][Eo]:null;for((a===-1||r&4)&&(l=a===-1?kI(e,t):t[a+8],l===Om||!uU(r,!1)?a=-1:(o=t[Dt],a=eC(l),t=tC(l,t)));a!==-1;){let h=t[Dt];if(cU(s,a,h.data)){let p=m7(a,t,i,o,r,c);if(p!==nl)return p}l=t[a+8],l!==Om&&uU(r,t[Dt].data[a+8]===c)&&cU(s,a,t)?(o=h,a=eC(l),t=tC(l,t)):a=-1}}return n}function m7(e,t,i,r,n,s){let o=t[Dt],a=o.data[e+8],l=r==null?wu(a)&&uI:r!=o&&(a.type&3)!==0,c=n&1&&s===a,h=Kb(a,o,i,l,c);return h!==null?A_(t,o,h,a):nl}function Kb(e,t,i,r,n){let s=e.providerIndexes,o=t.data,a=s&1048575,l=e.directiveStart,c=e.directiveEnd,h=s>>20,p=r?a:a+h,m=n?a+h:c;for(let f=p;f<m;f++){let g=o[f];if(f<l&&i===g||f>=l&&g.type===i)return f}if(n){let f=o[l];if(f&&il(f)&&f.type===i)return l}return null}function A_(e,t,i,r){let n=e[i],s=t.data;if(n instanceof hh){let o=n;o.resolving&&bS(fB(s[i]));let a=lU(o.canSeeViewProviders);o.resolving=!0;let l=s[i].type||s[i],c,h=o.injectImpl?Ls(o.injectImpl):null,p=$S(e,r,0);try{n=e[i]=o.factory(void 0,s,e,r),t.firstCreatePass&&i>=r.directiveStart&&r7(i,s[i],t)}finally{h!==null&&Ls(h),lU(a),o.resolving=!1,ZS()}}return n}function f7(e){if(typeof e=="string")return e.charCodeAt(0)||0;let t=e.hasOwnProperty(Jd)?e[Jd]:void 0;return typeof t=="number"?t>=0?t&qU:g7:t}function cU(e,t,i){let r=1<<e;return!!(i[t+(e>>WU)]&r)}function uU(e,t){return!(e&2)&&!(e&1&&t)}var dh=class{_tNode;_lView;constructor(t,i){this._tNode=t,this._lView=i}get(t,i,r){return YU(this._tNode,this._lView,t,Qd(r),i)}};function g7(){return new dh(ms(),hi())}function uC(e){return Lm(()=>{let t=e.prototype.constructor,i=t[h_]||hI(t),r=Object.prototype,n=Object.getPrototypeOf(e.prototype).constructor;for(;n&&n!==r;){let s=n[h_]||hI(n);if(s&&s!==i)return s;n=Object.getPrototypeOf(n)}return s=>new s})}function hI(e){return gS(e)?()=>{let t=hI(sn(e));return t&&t()}:Yd(e)}function _7(e,t,i,r,n){let s=e,o=t;for(;s!==null&&o!==null&&o[vt]&2048&&!xm(o);){let a=KU(s,o,i,r|2,nl);if(a!==nl)return a;let l=s.parent;if(!l){let c=o[PS];if(c){let h=c.get(i,nl,r);if(h!==nl)return h}l=XU(o),o=o[rh]}s=l}return n}function XU(e){let t=e[Dt],i=t.type;return i===2?t.declTNode:i===1?e[Eo]:null}function y7(){return Fm(ms(),hi())}function Fm(e,t){return new oc(ga(e,t))}var oc=(()=>{class e{nativeElement;constructor(i){this.nativeElement=i}static __NG_ELEMENT_ID__=y7}return e})();function v7(e){return e instanceof oc?e.nativeElement:e}function w7(){return this._results[Symbol.iterator]()}var rC=class{_emitDistinctChangesOnly;dirty=!0;_onDirty=void 0;_results=[];_changesDetected=!1;_changes=void 0;length=0;first=void 0;last=void 0;get changes(){return this._changes??=new Xa}constructor(t=!1){this._emitDistinctChangesOnly=t}get(t){return this._results[t]}map(t){return this._results.map(t)}filter(t){return this._results.filter(t)}find(t){return this._results.find(t)}reduce(t,i){return this._results.reduce(t,i)}forEach(t){this._results.forEach(t)}some(t){return this._results.some(t)}toArray(){return this._results.slice()}toString(){return this._results.toString()}reset(t,i){this.dirty=!1;let r=yB(t);(this._changesDetected=!_B(this._results,r,i))&&(this._results=r,this.length=r.length,this.last=r[this.length-1],this.first=r[0])}notifyOnChanges(){this._changes!==void 0&&(this._changesDetected||!this._emitDistinctChangesOnly)&&this._changes.next(this)}onDirty(t){this._onDirty=t}setDirty(){this.dirty=!0,this._onDirty?.()}destroy(){this._changes!==void 0&&(this._changes.complete(),this._changes.unsubscribe())}[Symbol.iterator]=w7};function JU(e){return(e.flags&128)===128}var VI=function(e){return e[e.OnPush=0]="OnPush",e[e.Default=1]="Default",e}(VI||{}),e5=new Map,b7=0;function C7(){return b7++}function T7(e){e5.set(e[y_],e)}function pI(e){e5.delete(e[y_])}var dU="__ngContext__";function F_(e,t){tl(t)?(e[dU]=t[y_],T7(t)):e[dU]=t}function t5(e){return r5(e[Dm])}function i5(e){return r5(e[To])}function r5(e){for(;e!==null&&!fa(e);)e=e[To];return e}var mI;function HI(e){mI=e}function n5(){if(mI!==void 0)return mI;if(typeof document<"u")return document;throw new ct(210,!1)}var dC=new ht("",{providedIn:"root",factory:()=>E7}),E7="ng",hC=new ht(""),km=new ht("",{providedIn:"platform",factory:()=>"unknown"});var pC=new ht("",{providedIn:"root",factory:()=>n5().body?.querySelector("[ngCspNonce]")?.getAttribute("ngCspNonce")||null});var D7="h",x7="b";var s5=!1,o5=new ht("",{providedIn:"root",factory:()=>s5});var M7=(e,t,i,r)=>{};function S7(e,t,i,r){M7(e,t,i,r)}var I7=()=>null;function a5(e,t,i=!1){return I7(e,t,i)}function l5(e,t){let i=e.contentQueries;if(i!==null){let r=Et(null);try{for(let n=0;n<i.length;n+=2){let s=i[n],o=i[n+1];if(o!==-1){let a=e.data[o];Hb(s),a.contentQueries(2,t[o],o)}}}finally{Et(r)}}}function fI(e,t,i){Hb(0);let r=Et(null);try{t(e,i)}finally{Et(r)}}function c5(e,t,i){if(OS(t)){let r=Et(null);try{let n=t.directiveStart,s=t.directiveEnd;for(let o=n;o<s;o++){let a=e.data[o];if(a.contentQueries){let l=i[o];a.contentQueries(1,l,o)}}}finally{Et(r)}}}var rc=function(e){return e[e.Emulated=0]="Emulated",e[e.None=2]="None",e[e.ShadowDom=3]="ShadowDom",e}(rc||{});var gI=class{changingThisBreaksApplicationSecurity;constructor(t){this.changingThisBreaksApplicationSecurity=t}toString(){return`SafeValue must use [property]=binding: ${this.changingThisBreaksApplicationSecurity} (see ${pS})`}};function u5(e){return e instanceof gI?e.changingThisBreaksApplicationSecurity:e}function A7(e,t,i){let r=e.length;for(;;){let n=e.indexOf(t,i);if(n===-1)return n;if(n===0||e.charCodeAt(n-1)<=32){let s=t.length;if(n+s===r||e.charCodeAt(n+s)<=32)return n}i=n+1}}var d5="ng-template";function R7(e,t,i,r){let n=0;if(r){for(;n<t.length&&typeof t[n]=="string";n+=2)if(t[n]==="class"&&A7(t[n+1].toLowerCase(),i,0)!==-1)return!0}else if(BI(e))return!1;if(n=t.indexOf(1,n),n>-1){let s;for(;++n<t.length&&typeof(s=t[n])=="string";)if(s.toLowerCase()===i)return!0}return!1}function BI(e){return e.type===4&&e.value!==d5}function P7(e,t,i){let r=e.type===4&&!i?d5:e.value;return t===r}function O7(e,t,i){let r=4,n=e.attrs,s=n!==null?F7(n):0,o=!1;for(let a=0;a<t.length;a++){let l=t[a];if(typeof l=="number"){if(!o&&!_a(r)&&!_a(l))return!1;if(o&&_a(l))continue;o=!1,r=l|r&1;continue}if(!o)if(r&4){if(r=2|r&1,l!==""&&!P7(e,l,i)||l===""&&t.length===1){if(_a(r))return!1;o=!0}}else if(r&8){if(n===null||!R7(e,n,l,i)){if(_a(r))return!1;o=!0}}else{let c=t[++a],h=N7(l,n,BI(e),i);if(h===-1){if(_a(r))return!1;o=!0;continue}if(c!==""){let p;if(h>s?p="":p=n[h+1].toLowerCase(),r&2&&c!==p){if(_a(r))return!1;o=!0}}}}return _a(r)||o}function _a(e){return(e&1)===0}function N7(e,t,i,r){if(t===null)return-1;let n=0;if(r||!i){let s=!1;for(;n<t.length;){let o=t[n];if(o===e)return n;if(o===3||o===6)s=!0;else if(o===1||o===2){let a=t[++n];for(;typeof a=="string";)a=t[++n];continue}else{if(o===4)break;if(o===0){n+=4;continue}}n+=s?1:2}return-1}else return k7(t,e)}function L7(e,t,i=!1){for(let r=0;r<t.length;r++)if(O7(e,t[r],i))return!0;return!1}function F7(e){for(let t=0;t<e.length;t++){let i=e[t];if(l7(i))return t}return e.length}function k7(e,t){let i=e.indexOf(4);if(i>-1)for(i++;i<e.length;){let r=e[i];if(typeof r=="number")return-1;if(r===t)return i;i++}return-1}function hU(e,t){return e?":not("+t.trim()+")":t}function V7(e){let t=e[0],i=1,r=2,n="",s=!1;for(;i<e.length;){let o=e[i];if(typeof o=="string")if(r&2){let a=e[++i];n+="["+o+(a.length>0?'="'+a+'"':"")+"]"}else r&8?n+="."+o:r&4&&(n+=" "+o);else n!==""&&!_a(o)&&(t+=hU(s,n),n=""),r=o,s=s||!_a(r);i++}return n!==""&&(t+=hU(s,n)),t}function H7(e){return e.map(V7).join(",")}function B7(e){let t=[],i=[],r=1,n=2;for(;r<e.length;){let s=e[r];if(typeof s=="string")n===2?s!==""&&t.push(s,e[++r]):n===8&&i.push(s);else{if(!_a(n))break;n=s}r++}return i.length&&t.push(1,...i),t}var ac={};function U7(e,t){return e.createText(t)}function j7(e,t,i){e.setValue(t,i)}function h5(e,t,i){return e.createElement(t,i)}function nC(e,t,i,r,n){e.insertBefore(t,i,r,n)}function p5(e,t,i){e.appendChild(t,i)}function pU(e,t,i,r,n){r!==null?nC(e,t,i,r,n):p5(e,t,i)}function z7(e,t,i){e.removeChild(null,t,i)}function G7(e,t,i){e.setAttribute(t,"style",i)}function q7(e,t,i){i===""?e.removeAttribute(t,"class"):e.setAttribute(t,"class",i)}function m5(e,t,i){let{mergedAttrs:r,classes:n,styles:s}=i;r!==null&&a7(e,t,r),n!==null&&q7(e,t,n),s!==null&&G7(e,t,s)}function UI(e,t,i,r,n,s,o,a,l,c,h){let p=Hs+r,m=p+n,f=W7(p,m),g=typeof c=="function"?c():c;return f[Dt]={type:e,blueprint:f,template:i,queries:null,viewQuery:a,declTNode:t,data:f.slice().fill(null,p),bindingStartIndex:p,expandoStartIndex:m,hostBindingOpCodes:null,firstCreatePass:!0,firstUpdatePass:!0,staticViewQueries:!1,staticContentQueries:!1,preOrderHooks:null,preOrderCheckHooks:null,contentHooks:null,contentCheckHooks:null,viewHooks:null,viewCheckHooks:null,destroyHooks:null,cleanup:null,contentQueries:null,components:null,directiveRegistry:typeof s=="function"?s():s,pipeRegistry:typeof o=="function"?o():o,firstChild:null,schemas:l,consts:g,incompleteFirstPass:!1,ssrId:h}}function W7(e,t){let i=[];for(let r=0;r<t;r++)i.push(r<e?null:ac);return i}function $7(e){let t=e.tView;return t===null||t.incompleteFirstPass?e.tView=UI(1,null,e.template,e.decls,e.vars,e.directiveDefs,e.pipeDefs,e.viewQuery,e.schemas,e.consts,e.id):t}function jI(e,t,i,r,n,s,o,a,l,c,h){let p=t.blueprint.slice();return p[ma]=n,p[vt]=r|4|128|8|64|1024,(c!==null||e&&e[vt]&2048)&&(p[vt]|=2048),LS(p),p[$r]=p[rh]=e,p[on]=i,p[ic]=o||e&&e[ic],p[hr]=a||e&&e[hr],p[ih]=l||e&&e[ih]||null,p[Eo]=s,p[y_]=C7(),p[__]=h,p[PS]=c,p[Do]=t.type==2?e[Do]:p,p}function Z7(e,t,i){let r=ga(t,e),n=$7(i),s=e[ic].rendererFactory,o=zI(e,jI(e,n,null,f5(i),r,t,null,s.createRenderer(r,i),null,null,null));return e[t.index]=o}function f5(e){let t=16;return e.signals?t=4096:e.onPush&&(t=64),t}function g5(e,t,i,r){if(i===0)return-1;let n=t.length;for(let s=0;s<i;s++)t.push(r),e.blueprint.push(r),e.data.push(null);return n}function zI(e,t){return e[Dm]?e[RS][To]=t:e[Dm]=t,e[RS]=t,t}function Nr(e=1){_5(Zr(),hi(),lh()+e,!1)}function _5(e,t,i,r){if(!r)if((t[vt]&3)===3){let s=e.preOrderCheckHooks;s!==null&&Qb(t,s,i)}else{let s=e.preOrderHooks;s!==null&&Yb(t,s,0,i)}bu(i)}var mC=function(e){return e[e.None=0]="None",e[e.SignalBased=1]="SignalBased",e[e.HasDecoratorInputTransform=2]="HasDecoratorInputTransform",e}(mC||{});function _I(e,t,i,r){let n=Et(null);try{let[s,o,a]=e.inputs[i],l=null;(o&mC.SignalBased)!==0&&(l=t[s][ls]),l!==null&&l.transformFn!==void 0?r=l.transformFn(r):a!==null&&(r=a.call(t,r)),e.setInput!==null?e.setInput(t,l,r,i,s):VU(t,l,s,r)}finally{Et(n)}}function y5(e,t,i,r,n){let s=lh(),o=r&2;try{bu(-1),o&&t.length>Hs&&_5(e,t,Hs,!1),Ii(o?2:0,n,i),i(r,n)}finally{bu(s),Ii(o?3:1,n,i)}}function GI(e,t,i){t$(e,t,i),(i.flags&64)===64&&i$(e,t,i)}function v5(e,t,i=ga){let r=t.localNames;if(r!==null){let n=t.index+1;for(let s=0;s<r.length;s+=2){let o=r[s+1],a=o===-1?i(t,e):e[o];e[n++]=a}}}function Q7(e,t,i,r){let s=r.get(o5,s5)||i===rc.ShadowDom,o=e.selectRootElement(t,s);return Y7(o),o}function Y7(e){K7(e)}var K7=()=>null;function X7(e){return e==="class"?"className":e==="for"?"htmlFor":e==="formaction"?"formAction":e==="innerHtml"?"innerHTML":e==="readonly"?"readOnly":e==="tabindex"?"tabIndex":e}function w5(e,t,i,r,n,s){let o=t[Dt];if(qI(e,o,t,i,r)){wu(e)&&e$(t,e.index);return}J7(e,t,i,r,n,s)}function J7(e,t,i,r,n,s){if(e.type&3){let o=ga(e,t);i=X7(i),r=s!=null?s(r,e.value||"",i):r,n.setProperty(o,i,r)}else e.type&12}function e$(e,t){let i=Mo(t,e);i[vt]&16||(i[vt]|=64)}function t$(e,t,i){let r=i.directiveStart,n=i.directiveEnd;wu(i)&&Z7(t,i,e.data[r+i.componentOffset]),e.firstCreatePass||iC(i,t);let s=i.initialInputs;for(let o=r;o<n;o++){let a=e.data[o],l=A_(t,e,o,i);if(F_(l,t),s!==null&&o$(t,o-r,l,a,i,s),il(a)){let c=Mo(i.index,t);c[on]=A_(t,e,o,i)}}}function i$(e,t,i){let r=i.directiveStart,n=i.directiveEnd,s=i.index,o=ZB();try{bu(s);for(let a=r;a<n;a++){let l=e.data[a],c=t[a];Vb(a),(l.hostBindings!==null||l.hostVars!==0||l.hostAttrs!==null)&&r$(l,c)}}finally{bu(-1),Vb(o)}}function r$(e,t){e.hostBindings!==null&&e.hostBindings(1,t)}function b5(e,t){let i=e.directiveRegistry,r=null;if(i)for(let n=0;n<i.length;n++){let s=i[n];L7(t,s.selectors,!1)&&(r??=[],il(s)?r.unshift(s):r.push(s))}return r}function n$(e,t,i,r,n,s){let o=ga(e,t);s$(t[hr],o,s,e.value,i,r,n)}function s$(e,t,i,r,n,s,o){if(s==null)e.removeAttribute(t,n,i);else{let a=o==null?Ib(s):o(s,r||"",n);e.setAttribute(t,n,a,i)}}function o$(e,t,i,r,n,s){let o=s[t];if(o!==null)for(let a=0;a<o.length;a+=2){let l=o[a],c=o[a+1];_I(r,i,l,c)}}function a$(e,t){let i=e[ih];if(!i)return;i.get(rl,null)?.(t)}function qI(e,t,i,r,n){let s=e.inputs?.[r],o=e.hostDirectiveInputs?.[r],a=!1;if(o)for(let l=0;l<o.length;l+=2){let c=o[l],h=o[l+1],p=t.data[c];_I(p,i[c],h,n),a=!0}if(s)for(let l of s){let c=i[l],h=t.data[l];_I(h,c,r,n),a=!0}return a}function l$(e,t){let i=Mo(t,e),r=i[Dt];c$(r,i);let n=i[ma];n!==null&&i[__]===null&&(i[__]=a5(n,i[ih])),Ii(18),WI(r,i,i[on]),Ii(19,i[on])}function c$(e,t){for(let i=t.length;i<e.blueprint.length;i++)t.push(e.blueprint[i])}function WI(e,t,i){Bb(t);try{let r=e.viewQuery;r!==null&&fI(1,r,i);let n=e.template;n!==null&&y5(e,t,n,1,i),e.firstCreatePass&&(e.firstCreatePass=!1),t[el]?.finishViewCreation(e),e.staticContentQueries&&l5(e,t),e.staticViewQueries&&fI(2,e.viewQuery,i);let s=e.components;s!==null&&u$(t,s)}catch(r){throw e.firstCreatePass&&(e.incompleteFirstPass=!0,e.firstCreatePass=!1),r}finally{t[vt]&=-5,Ub()}}function u$(e,t){for(let i=0;i<t.length;i++)l$(e,t[i])}function C5(e,t,i,r){let n=Et(null);try{let s=t.tView,a=e[vt]&4096?4096:16,l=jI(e,s,i,a,null,t,null,null,r?.injector??null,r?.embeddedViewInjector??null,r?.dehydratedView??null),c=e[t.index];l[yu]=c;let h=e[el];return h!==null&&(l[el]=h.createEmbeddedView(s)),WI(s,l,i),l}finally{Et(n)}}function yI(e,t){return!t||t.firstChild===null||JU(e)}var mU=!1,d$=new ht(""),h$;function $I(e,t){return h$(e,t)}var nc=function(e){return e[e.Important=1]="Important",e[e.DashCase=2]="DashCase",e}(nc||{});function ZI(e){return(e.flags&32)===32}function Pm(e,t,i,r,n){if(r!=null){let s,o=!1;fa(r)?s=r:tl(r)&&(o=!0,r=r[ma]);let a=xo(r);e===0&&i!==null?n==null?p5(t,i,a):nC(t,i,a,n||null,!0):e===1&&i!==null?nC(t,i,a,n||null,!0):e===2?z7(t,a,o):e===3&&t.destroyNode(a),s!=null&&E$(t,e,s,i,n)}}function p$(e,t){T5(e,t),t[ma]=null,t[Eo]=null}function m$(e,t,i,r,n,s){r[ma]=n,r[Eo]=t,fC(e,r,i,1,n,s)}function T5(e,t){t[ic].changeDetectionScheduler?.notify(9),fC(e,t,t[hr],2,null,null)}function f$(e){let t=e[Dm];if(!t)return iI(e[Dt],e);for(;t;){let i=null;if(tl(t))i=t[Dm];else{let r=t[bn];r&&(i=r)}if(!i){for(;t&&!t[To]&&t!==e;)tl(t)&&iI(t[Dt],t),t=t[$r];t===null&&(t=e),tl(t)&&iI(t[Dt],t),i=t&&t[To]}t=i}}function QI(e,t){let i=e[sh],r=i.indexOf(t);i.splice(r,1)}function YI(e,t){if(oh(t))return;let i=t[hr];i.destroyNode&&fC(e,t,i,3,null,null),f$(t)}function iI(e,t){if(oh(t))return;let i=Et(null);try{t[vt]&=-129,t[vt]|=256,t[Vs]&&Kw(t[Vs]),_$(e,t),g$(e,t),t[Dt].type===1&&t[hr].destroy();let r=t[yu];if(r!==null&&fa(t[$r])){r!==t[$r]&&QI(r,t);let n=t[el];n!==null&&n.detachView(e)}pI(t)}finally{Et(i)}}function g$(e,t){let i=e.cleanup,r=t[Em];if(i!==null)for(let o=0;o<i.length-1;o+=2)if(typeof i[o]=="string"){let a=i[o+3];a>=0?r[a]():r[-a].unsubscribe(),o+=2}else{let a=r[i[o+1]];i[o].call(a)}r!==null&&(t[Em]=null);let n=t[Xl];if(n!==null){t[Xl]=null;for(let o=0;o<n.length;o++){let a=n[o];a()}}let s=t[v_];if(s!==null){t[v_]=null;for(let o of s)o.destroy()}}function _$(e,t){let i;if(e!=null&&(i=e.destroyHooks)!=null)for(let r=0;r<i.length;r+=2){let n=t[i[r]];if(!(n instanceof hh)){let s=i[r+1];if(Array.isArray(s))for(let o=0;o<s.length;o+=2){let a=n[s[o]],l=s[o+1];Ii(4,a,l);try{l.call(a)}finally{Ii(5,a,l)}}else{Ii(4,n,s);try{s.call(n)}finally{Ii(5,n,s)}}}}}function y$(e,t,i){return v$(e,t.parent,i)}function v$(e,t,i){let r=t;for(;r!==null&&r.type&168;)t=r,r=t.parent;if(r===null)return i[ma];if(wu(r)){let{encapsulation:n}=e.data[r.directiveStart+r.componentOffset];if(n===rc.None||n===rc.Emulated)return null}return ga(r,i)}function w$(e,t,i){return C$(e,t,i)}function b$(e,t,i){return e.type&40?ga(e,i):null}var C$=b$,fU;function KI(e,t,i,r){let n=y$(e,r,t),s=t[hr],o=r.parent||t[Eo],a=w$(o,r,t);if(n!=null)if(Array.isArray(i))for(let l=0;l<i.length;l++)pU(s,n,i[l],a,!1);else pU(s,n,i,a,!1);fU!==void 0&&fU(s,r,t,i,n)}function M_(e,t){if(t!==null){let i=t.type;if(i&3)return ga(t,e);if(i&4)return vI(-1,e[t.index]);if(i&8){let r=t.child;if(r!==null)return M_(e,r);{let n=e[t.index];return fa(n)?vI(-1,n):xo(n)}}else{if(i&128)return M_(e,t.next);if(i&32)return $I(t,e)()||xo(e[t.index]);{let r=E5(e,t);if(r!==null){if(Array.isArray(r))return r[0];let n=mu(e[Do]);return M_(n,r)}else return M_(e,t.next)}}}return null}function E5(e,t){if(t!==null){let r=e[Do][Eo],n=t.projection;return r.projection[n]}return null}function vI(e,t){let i=bn+e+1;if(i<t.length){let r=t[i],n=r[Dt].firstChild;if(n!==null)return M_(r,n)}return t[vu]}function XI(e,t,i,r,n,s,o){for(;i!=null;){if(i.type===128){i=i.next;continue}let a=r[i.index],l=i.type;if(o&&t===0&&(a&&F_(xo(a),r),i.flags|=2),!ZI(i))if(l&8)XI(e,t,i.child,r,n,s,!1),Pm(t,e,n,a,s);else if(l&32){let c=$I(i,r),h;for(;h=c();)Pm(t,e,n,h,s);Pm(t,e,n,a,s)}else l&16?T$(e,t,r,i,n,s):Pm(t,e,n,a,s);i=o?i.projectionNext:i.next}}function fC(e,t,i,r,n,s){XI(i,r,e.firstChild,t,n,s,!1)}function T$(e,t,i,r,n,s){let o=i[Do],l=o[Eo].projection[r.projection];if(Array.isArray(l))for(let c=0;c<l.length;c++){let h=l[c];Pm(t,e,n,h,s)}else{let c=l,h=o[$r];JU(r)&&(c.flags|=128),XI(e,t,c,h,n,s,!0)}}function E$(e,t,i,r,n){let s=i[vu],o=xo(i);s!==o&&Pm(t,e,r,s,n);for(let a=bn;a<i.length;a++){let l=i[a];fC(l[Dt],l,e,t,r,s)}}function D$(e,t,i,r,n){if(t)n?e.addClass(i,r):e.removeClass(i,r);else{let s=r.indexOf("-")===-1?void 0:nc.DashCase;n==null?e.removeStyle(i,r,s):(typeof n=="string"&&n.endsWith("!important")&&(n=n.slice(0,-10),s|=nc.Important),e.setStyle(i,r,n,s))}}function R_(e,t,i,r,n=!1){for(;i!==null;){if(i.type===128){i=n?i.projectionNext:i.next;continue}let s=t[i.index];s!==null&&r.push(xo(s)),fa(s)&&D5(s,r);let o=i.type;if(o&8)R_(e,t,i.child,r);else if(o&32){let a=$I(i,t),l;for(;l=a();)r.push(l)}else if(o&16){let a=E5(t,i);if(Array.isArray(a))r.push(...a);else{let l=mu(t[Do]);R_(l[Dt],l,a,r,!0)}}i=n?i.projectionNext:i.next}return r}function D5(e,t){for(let i=bn;i<e.length;i++){let r=e[i],n=r[Dt].firstChild;n!==null&&R_(r[Dt],r,n,t)}e[vu]!==e[ma]&&t.push(e[vu])}function x5(e){if(e[Nb]!==null){for(let t of e[Nb])t.impl.addSequence(t);e[Nb].length=0}}var M5=[];function x$(e){return e[Vs]??M$(e)}function M$(e){let t=M5.pop()??Object.create(I$);return t.lView=e,t}function S$(e){e.lView[Vs]!==e&&(e.lView=null,M5.push(e))}var I$=be(ie({},zd),{consumerIsAlwaysLive:!0,kind:"template",consumerMarkedDirty:e=>{T_(e.lView)},consumerOnSignalRead(){this.lView[Vs]=this}});function A$(e){let t=e[Vs]??Object.create(R$);return t.lView=e,t}var R$=be(ie({},zd),{consumerIsAlwaysLive:!0,kind:"template",consumerMarkedDirty:e=>{let t=mu(e.lView);for(;t&&!S5(t[Dt]);)t=mu(t);t&&FS(t)},consumerOnSignalRead(){this.lView[Vs]=this}});function S5(e){return e.type!==2}function I5(e){if(e[v_]===null)return;let t=!0;for(;t;){let i=!1;for(let r of e[v_])r.dirty&&(i=!0,r.zone===null||Zone.current===r.zone?r.run():r.zone.run(()=>r.run()));t=i&&!!(e[vt]&8192)}}var P$=100;function JI(e,t=0){let r=e[ic].rendererFactory,n=!1;n||r.begin?.();try{O$(e,t)}finally{n||r.end?.()}}function O$(e,t){let i=GS();try{qS(!0),wI(e,t);let r=0;for(;C_(e);){if(r===P$)throw new ct(103,!1);r++,wI(e,1)}}finally{qS(i)}}function A5(e,t){zS(t?E_.Exhaustive:E_.OnlyDirtyViews);try{JI(e)}finally{zS(E_.Off)}}function N$(e,t,i,r){if(oh(t))return;let n=t[vt],s=!1,o=!1;Bb(t);let a=!0,l=null,c=null;s||(S5(e)?(c=x$(t),l=gm(c)):$w()===null?(a=!1,c=A$(t),l=gm(c)):t[Vs]&&(Kw(t[Vs]),t[Vs]=null));try{LS(t),GB(e.bindingStartIndex),i!==null&&y5(e,t,i,2,r);let h=(n&3)===3;if(!s)if(h){let f=e.preOrderCheckHooks;f!==null&&Qb(t,f,null)}else{let f=e.preOrderHooks;f!==null&&Yb(t,f,0,null),eI(t,0)}if(o||L$(t),I5(t),R5(t,0),e.contentQueries!==null&&l5(e,t),!s)if(h){let f=e.contentCheckHooks;f!==null&&Qb(t,f)}else{let f=e.contentHooks;f!==null&&Yb(t,f,1),eI(t,1)}k$(e,t);let p=e.components;p!==null&&O5(t,p,0);let m=e.viewQuery;if(m!==null&&fI(2,m,r),!s)if(h){let f=e.viewCheckHooks;f!==null&&Qb(t,f)}else{let f=e.viewHooks;f!==null&&Yb(t,f,2),eI(t,2)}if(e.firstUpdatePass===!0&&(e.firstUpdatePass=!1),t[Ob]){for(let f of t[Ob])f();t[Ob]=null}s||(x5(t),t[vt]&=-73)}catch(h){throw s||T_(t),h}finally{c!==null&&(c_(c,l),a&&S$(c)),Ub()}}function R5(e,t){for(let i=t5(e);i!==null;i=i5(i))for(let r=bn;r<i.length;r++){let n=i[r];P5(n,t)}}function L$(e){for(let t=t5(e);t!==null;t=i5(t)){if(!(t[vt]&2))continue;let i=t[sh];for(let r=0;r<i.length;r++){let n=i[r];FS(n)}}}function F$(e,t,i){Ii(18);let r=Mo(t,e);P5(r,i),Ii(19,r[on])}function P5(e,t){Fb(e)&&wI(e,t)}function wI(e,t){let r=e[Dt],n=e[vt],s=e[Vs],o=!!(t===0&&n&16);if(o||=!!(n&64&&t===0),o||=!!(n&1024),o||=!!(s?.dirty&&Yw(s)),o||=!1,s&&(s.dirty=!1),e[vt]&=-9217,o)N$(r,e,r.template,e[on]);else if(n&8192){let a=Et(null);try{I5(e),R5(e,1);let l=r.components;l!==null&&O5(e,l,1),x5(e)}finally{Et(a)}}}function O5(e,t,i){for(let r=0;r<t.length;r++)F$(e,t[r],i)}function k$(e,t){let i=e.hostBindingOpCodes;if(i!==null)try{for(let r=0;r<i.length;r++){let n=i[r];if(n<0)bu(~n);else{let s=n,o=i[++r],a=i[++r];$B(o,s);let l=t[s];Ii(24,l),a(2,l),Ii(25,l)}}}finally{bu(-1)}}function eA(e,t){let i=GS()?64:1088;for(e[ic].changeDetectionScheduler?.notify(t);e;){e[vt]|=i;let r=mu(e);if(xm(e)&&!r)return e;e=r}return null}function N5(e,t,i,r){return[e,!0,0,t,null,r,null,i,null,null]}function V$(e,t){let i=bn+t;if(i<e.length)return e[i]}function L5(e,t,i,r=!0){let n=t[Dt];if(B$(n,t,e,i),r){let o=vI(i,e),a=t[hr],l=a.parentNode(e[vu]);l!==null&&m$(n,e[Eo],a,t,l,o)}let s=t[__];s!==null&&s.firstChild!==null&&(s.firstChild=null)}function H$(e,t){let i=sC(e,t);return i!==void 0&&YI(i[Dt],i),i}function sC(e,t){if(e.length<=bn)return;let i=bn+t,r=e[i];if(r){let n=r[yu];n!==null&&n!==e&&QI(n,r),t>0&&(e[i-1][To]=r[To]);let s=m_(e,bn+t);p$(r[Dt],r);let o=s[el];o!==null&&o.detachView(s[Dt]),r[$r]=null,r[To]=null,r[vt]&=-129}return r}function B$(e,t,i,r){let n=bn+r,s=i.length;r>0&&(i[n-1][To]=t),r<s-bn?(t[To]=i[n],ES(i,bn+r,t)):(i.push(t),t[To]=null),t[$r]=i;let o=t[yu];o!==null&&i!==o&&F5(o,t);let a=t[el];a!==null&&a.insertView(e),kb(t),t[vt]|=128}function F5(e,t){let i=e[sh],r=t[$r];if(tl(r))e[vt]|=2;else{let n=r[$r][Do];t[Do]!==n&&(e[vt]|=2)}i===null?e[sh]=[t]:i.push(t)}var Cu=class{_lView;_cdRefInjectingView;_appRef=null;_attachedToViewContainer=!1;exhaustive;get rootNodes(){let t=this._lView,i=t[Dt];return R_(i,t,i.firstChild,[])}constructor(t,i){this._lView=t,this._cdRefInjectingView=i}get context(){return this._lView[on]}set context(t){this._lView[on]=t}get destroyed(){return oh(this._lView)}destroy(){if(this._appRef)this._appRef.detachView(this);else if(this._attachedToViewContainer){let t=this._lView[$r];if(fa(t)){let i=t[w_],r=i?i.indexOf(this):-1;r>-1&&(sC(t,r),m_(i,r))}this._attachedToViewContainer=!1}YI(this._lView[Dt],this._lView)}onDestroy(t){kS(this._lView,t)}markForCheck(){eA(this._cdRefInjectingView||this._lView,4)}detach(){this._lView[vt]&=-129}reattach(){kb(this._lView),this._lView[vt]|=128}detectChanges(){this._lView[vt]|=1024,JI(this._lView)}checkNoChanges(){return;try{this.exhaustive??=this._lView[ih].get(d$,mU)}catch{this.exhaustive=mU}}attachToViewContainerRef(){if(this._appRef)throw new ct(902,!1);this._attachedToViewContainer=!0}detachFromAppRef(){this._appRef=null;let t=xm(this._lView),i=this._lView[yu];i!==null&&!t&&QI(i,this._lView),T5(this._lView[Dt],this._lView)}attachToAppRef(t){if(this._attachedToViewContainer)throw new ct(902,!1);this._appRef=t;let i=xm(this._lView),r=this._lView[yu];r!==null&&!i&&F5(r,this._lView),kb(this._lView)}};var ph=(()=>{class e{_declarationLView;_declarationTContainer;elementRef;static __NG_ELEMENT_ID__=U$;constructor(i,r,n){this._declarationLView=i,this._declarationTContainer=r,this.elementRef=n}get ssrId(){return this._declarationTContainer.tView?.ssrId||null}createEmbeddedView(i,r){return this.createEmbeddedViewImpl(i,r)}createEmbeddedViewImpl(i,r,n){let s=C5(this._declarationLView,this._declarationTContainer,i,{embeddedViewInjector:r,dehydratedView:n});return new Cu(s)}}return e})();function U$(){return tA(ms(),hi())}function tA(e,t){return e.type&4?new ph(t,e,Fm(e,t)):null}function iA(e,t,i,r,n){let s=e.data[t];if(s===null)s=j$(e,t,i,r,n),WB()&&(s.flags|=32);else if(s.type&64){s.type=i,s.value=r,s.attrs=n;let o=jB();s.injectorIndex=o===null?-1:o.injectorIndex}return Im(s,!0),s}function j$(e,t,i,r,n){let s=US(),o=jS(),a=o?s:s&&s.parent,l=e.data[t]=G$(e,a,i,t,r,n);return z$(e,l,s,o),l}function z$(e,t,i,r){e.firstChild===null&&(e.firstChild=t),i!==null&&(r?i.child==null&&t.parent!==null&&(i.child=t):i.next===null&&(i.next=t,t.prev=i))}function G$(e,t,i,r,n,s){let o=t?t.injectorIndex:-1,a=0;return HB()&&(a|=128),{type:i,index:r,insertBeforeIndex:null,injectorIndex:o,directiveStart:-1,directiveEnd:-1,directiveStylingLast:-1,componentOffset:-1,propertyBindings:null,flags:a,providerIndexes:0,value:n,attrs:s,mergedAttrs:null,localNames:null,initialInputs:null,inputs:null,hostDirectiveInputs:null,outputs:null,hostDirectiveOutputs:null,directiveToIndex:null,tView:null,next:null,prev:null,projectionNext:null,child:null,parent:t,projection:null,styles:null,stylesWithoutHost:null,residualStyles:void 0,classes:null,classesWithoutHost:null,residualClasses:void 0,classBindings:0,styleBindings:0}}var qce=new RegExp(`^(\\d+)*(${x7}|${D7})*(.*)`);var q$=()=>null,W$=()=>null;function gU(e,t){return q$(e,t)}function $$(e,t,i){return W$(e,t,i)}var k5=class{},gC=class{},bI=class{resolveComponentFactory(t){throw new ct(917,!1)}},_C=class{static NULL=new bI},mh=class{},k_=(()=>{class e{destroyNode=null;static __NG_ELEMENT_ID__=()=>Z$()}return e})();function Z$(){let e=hi(),t=ms(),i=Mo(t.index,e);return(tl(i)?i:e)[hr]}var V5=(()=>{class e{static \u0275prov=Zt({token:e,providedIn:"root",factory:()=>null})}return e})();var Xb={},CI=class{injector;parentInjector;constructor(t,i){this.injector=t,this.parentInjector=i}get(t,i,r){let n=this.injector.get(t,Xb,r);return n!==Xb||i===Xb?n:this.parentInjector.get(t,i,r)}};function _U(e,t,i){let r=i?e.styles:null,n=i?e.classes:null,s=0;if(t!==null)for(let o=0;o<t.length;o++){let a=t[o];if(typeof a=="number")s=a;else if(s==1)n=fS(n,a);else if(s==2){let l=a,c=t[++o];r=fS(r,l+": "+c+";")}}i?e.styles=r:e.stylesWithoutHost=r,i?e.classes=n:e.classesWithoutHost=n}function It(e,t=0){let i=hi();if(i===null)return Bt(e,t);let r=ms();return YU(r,i,sn(e),t)}function H5(e,t,i,r,n){let s=r===null?null:{"":-1},o=n(e,i);if(o!==null){let a=o,l=null,c=null;for(let h of o)if(h.resolveHostDirectives!==null){[a,l,c]=h.resolveHostDirectives(o);break}K$(e,t,i,a,s,l,c)}s!==null&&r!==null&&Q$(i,r,s)}function Q$(e,t,i){let r=e.localNames=[];for(let n=0;n<t.length;n+=2){let s=i[t[n+1]];if(s==null)throw new ct(-301,!1);r.push(t[n],s)}}function Y$(e,t,i){t.componentOffset=i,(e.components??=[]).push(t.index)}function K$(e,t,i,r,n,s,o){let a=r.length,l=!1;for(let m=0;m<a;m++){let f=r[m];!l&&il(f)&&(l=!0,Y$(e,i,m)),dI(iC(i,t),e,f.type)}rZ(i,e.data.length,a);for(let m=0;m<a;m++){let f=r[m];f.providersResolver&&f.providersResolver(f)}let c=!1,h=!1,p=g5(e,t,a,null);a>0&&(i.directiveToIndex=new Map);for(let m=0;m<a;m++){let f=r[m];if(i.mergedAttrs=I_(i.mergedAttrs,f.hostAttrs),J$(e,i,t,p,f),iZ(p,f,n),o!==null&&o.has(f)){let[_,v]=o.get(f);i.directiveToIndex.set(f.type,[p,_+i.directiveStart,v+i.directiveStart])}else(s===null||!s.has(f))&&i.directiveToIndex.set(f.type,p);f.contentQueries!==null&&(i.flags|=4),(f.hostBindings!==null||f.hostAttrs!==null||f.hostVars!==0)&&(i.flags|=64);let g=f.type.prototype;!c&&(g.ngOnChanges||g.ngOnInit||g.ngDoCheck)&&((e.preOrderHooks??=[]).push(i.index),c=!0),!h&&(g.ngOnChanges||g.ngDoCheck)&&((e.preOrderCheckHooks??=[]).push(i.index),h=!0),p++}X$(e,i,s)}function X$(e,t,i){for(let r=t.directiveStart;r<t.directiveEnd;r++){let n=e.data[r];if(i===null||!i.has(n))yU(0,t,n,r),yU(1,t,n,r),wU(t,r,!1);else{let s=i.get(n);vU(0,t,s,r),vU(1,t,s,r),wU(t,r,!0)}}}function yU(e,t,i,r){let n=e===0?i.inputs:i.outputs;for(let s in n)if(n.hasOwnProperty(s)){let o;e===0?o=t.inputs??={}:o=t.outputs??={},o[s]??=[],o[s].push(r),B5(t,s)}}function vU(e,t,i,r){let n=e===0?i.inputs:i.outputs;for(let s in n)if(n.hasOwnProperty(s)){let o=n[s],a;e===0?a=t.hostDirectiveInputs??={}:a=t.hostDirectiveOutputs??={},a[o]??=[],a[o].push(r,s),B5(t,o)}}function B5(e,t){t==="class"?e.flags|=8:t==="style"&&(e.flags|=16)}function wU(e,t,i){let{attrs:r,inputs:n,hostDirectiveInputs:s}=e;if(r===null||!i&&n===null||i&&s===null||BI(e)){e.initialInputs??=[],e.initialInputs.push(null);return}let o=null,a=0;for(;a<r.length;){let l=r[a];if(l===0){a+=4;continue}else if(l===5){a+=2;continue}else if(typeof l=="number")break;if(!i&&n.hasOwnProperty(l)){let c=n[l];for(let h of c)if(h===t){o??=[],o.push(l,r[a+1]);break}}else if(i&&s.hasOwnProperty(l)){let c=s[l];for(let h=0;h<c.length;h+=2)if(c[h]===t){o??=[],o.push(c[h+1],r[a+1]);break}}a+=2}e.initialInputs??=[],e.initialInputs.push(o)}function J$(e,t,i,r,n){e.data[r]=n;let s=n.factory||(n.factory=Yd(n.type,!0)),o=new hh(s,il(n),It);e.blueprint[r]=o,i[r]=o,eZ(e,t,r,g5(e,i,n.hostVars,ac),n)}function eZ(e,t,i,r,n){let s=n.hostBindings;if(s){let o=e.hostBindingOpCodes;o===null&&(o=e.hostBindingOpCodes=[]);let a=~t.index;tZ(o)!=a&&o.push(a),o.push(i,r,s)}}function tZ(e){let t=e.length;for(;t>0;){let i=e[--t];if(typeof i=="number"&&i<0)return i}return 0}function iZ(e,t,i){if(i){if(t.exportAs)for(let r=0;r<t.exportAs.length;r++)i[t.exportAs[r]]=e;il(t)&&(i[""]=e)}}function rZ(e,t,i){e.flags|=1,e.directiveStart=t,e.directiveEnd=t+i,e.providerIndexes=t}function U5(e,t,i,r,n,s,o,a){let l=t.consts,c=ah(l,o),h=iA(t,e,2,r,c);return s&&H5(t,i,h,ah(l,a),n),h.mergedAttrs=I_(h.mergedAttrs,h.attrs),h.attrs!==null&&_U(h,h.attrs,!1),h.mergedAttrs!==null&&_U(h,h.mergedAttrs,!0),t.queries!==null&&t.queries.elementStart(t,h),h}function j5(e,t){jU(e,t),OS(t)&&e.queries.elementEnd(t)}function rA(e){return G5(e)?Array.isArray(e)||!(e instanceof Map)&&Symbol.iterator in e:!1}function z5(e,t){if(Array.isArray(e))for(let i=0;i<e.length;i++)t(e[i]);else{let i=e[Symbol.iterator](),r;for(;!(r=i.next()).done;)t(r.value)}}function G5(e){return e!==null&&(typeof e=="function"||typeof e=="object")}function Vm(e,t,i){if(i===ac)return!1;let r=e[t];return Object.is(r,i)?!1:(e[t]=i,!0)}function rI(e,t,i){return function r(n){let s=wu(e)?Mo(e.index,t):t;eA(s,5);let o=t[on],a=bU(t,o,i,n),l=r.__ngNextListenerFn__;for(;l;)a=bU(t,o,l,n)&&a,l=l.__ngNextListenerFn__;return a}}function bU(e,t,i,r){let n=Et(null);try{return Ii(6,t,i),i(r)!==!1}catch(s){return a$(e,s),!1}finally{Ii(7,t,i),Et(n)}}function nZ(e,t,i,r,n,s,o,a){let l=Lb(e),c=!1,h=null;if(!r&&l&&(h=sZ(t,i,s,e.index)),h!==null){let p=h.__ngLastListenerFn__||h;p.__ngNextListenerFn__=o,h.__ngLastListenerFn__=o,c=!0}else{let p=ga(e,i),m=r?r(p):p;S7(i,m,s,a);let f=n.listen(m,s,a),g=r?_=>r(xo(_[e.index])):e.index;q5(g,t,i,s,a,f,!1)}return c}function sZ(e,t,i,r){let n=e.cleanup;if(n!=null)for(let s=0;s<n.length-1;s+=2){let o=n[s];if(o===i&&n[s+1]===r){let a=t[Em],l=n[s+2];return a&&a.length>l?a[l]:null}typeof o=="string"&&(s+=2)}return null}function q5(e,t,i,r,n,s,o){let a=t.firstCreatePass?HS(t):null,l=VS(i),c=l.length;l.push(n,s),a&&a.push(r,e,c,(c+1)*(o?-1:1))}function CU(e,t,i,r,n,s){let o=t[i],a=t[Dt],c=a.data[i].outputs[r],p=o[c].subscribe(s);q5(e.index,a,t,n,s,p,!0)}var TI=Symbol("BINDING");var EI=class extends _C{ngModule;constructor(t){super(),this.ngModule=t}resolveComponentFactory(t){let i=eh(t);return new P_(i,this.ngModule)}};function oZ(e){return Object.keys(e).map(t=>{let[i,r,n]=e[t],s={propName:i,templateName:t,isSignal:(r&mC.SignalBased)!==0};return n&&(s.transform=n),s})}function aZ(e){return Object.keys(e).map(t=>({propName:e[t],templateName:t}))}function lZ(e,t,i){let r=t instanceof ps?t:t?.injector;return r&&e.getStandaloneInjector!==null&&(r=e.getStandaloneInjector(r)||r),r?new CI(i,r):i}function cZ(e){let t=e.get(mh,null);if(t===null)throw new ct(407,!1);let i=e.get(V5,null),r=e.get(Jl,null);return{rendererFactory:t,sanitizer:i,changeDetectionScheduler:r,ngReflect:!1}}function uZ(e,t){let i=(e.selectors[0][0]||"div").toLowerCase();return h5(t,i,i==="svg"?IB:i==="math"?AB:null)}var P_=class extends gC{componentDef;ngModule;selector;componentType;ngContentSelectors;isBoundToModule;cachedInputs=null;cachedOutputs=null;get inputs(){return this.cachedInputs??=oZ(this.componentDef.inputs),this.cachedInputs}get outputs(){return this.cachedOutputs??=aZ(this.componentDef.outputs),this.cachedOutputs}constructor(t,i){super(),this.componentDef=t,this.ngModule=i,this.componentType=t.type,this.selector=H7(t.selectors),this.ngContentSelectors=t.ngContentSelectors??[],this.isBoundToModule=!!i}create(t,i,r,n,s,o){Ii(22);let a=Et(null);try{let l=this.componentDef,c=dZ(r,l,o,s),h=lZ(l,n||this.ngModule,t),p=cZ(h),m=p.rendererFactory.createRenderer(null,l),f=r?Q7(m,r,l.encapsulation,h):uZ(l,m),g=o?.some(TU)||s?.some(b=>typeof b!="function"&&b.bindings.some(TU)),_=jI(null,c,null,512|f5(l),null,null,p,m,h,null,a5(f,h,!0));_[Hs]=f,Bb(_);let v=null;try{let b=U5(Hs,c,_,"#host",()=>c.directiveRegistry,!0,0);f&&(m5(m,f,b),F_(f,_)),GI(c,_,b),c5(c,b,_),j5(c,b),i!==void 0&&pZ(b,this.ngContentSelectors,i),v=Mo(b.index,_),_[on]=v[on],WI(c,_,null)}catch(b){throw v!==null&&pI(v),pI(_),b}finally{Ii(23),Ub()}return new oC(this.componentType,_,!!g)}finally{Et(a)}}};function dZ(e,t,i,r){let n=e?["ng-version","20.0.2"]:B7(t.selectors[0]),s=null,o=null,a=0;if(i)for(let h of i)a+=h[TI].requiredVars,h.create&&(h.targetIdx=0,(s??=[]).push(h)),h.update&&(h.targetIdx=0,(o??=[]).push(h));if(r)for(let h=0;h<r.length;h++){let p=r[h];if(typeof p!="function")for(let m of p.bindings){a+=m[TI].requiredVars;let f=h+1;m.create&&(m.targetIdx=f,(s??=[]).push(m)),m.update&&(m.targetIdx=f,(o??=[]).push(m))}}let l=[t];if(r)for(let h of r){let p=typeof h=="function"?h:h.type,m=MS(p);l.push(m)}return UI(0,null,hZ(s,o),1,a,l,null,null,null,[n],null)}function hZ(e,t){return!e&&!t?null:i=>{if(i&1&&e)for(let r of e)r.create();if(i&2&&t)for(let r of t)r.update()}}function TU(e){let t=e[TI].kind;return t==="input"||t==="twoWay"}var oC=class extends k5{_rootLView;_hasInputBindings;instance;hostView;changeDetectorRef;componentType;location;previousInputValues=null;_tNode;constructor(t,i,r){super(),this._rootLView=i,this._hasInputBindings=r,this._tNode=b_(i[Dt],Hs),this.location=Fm(this._tNode,i),this.instance=Mo(this._tNode.index,i)[on],this.hostView=this.changeDetectorRef=new Cu(i,void 0),this.componentType=t}setInput(t,i){this._hasInputBindings;let r=this._tNode;if(this.previousInputValues??=new Map,this.previousInputValues.has(t)&&Object.is(this.previousInputValues.get(t),i))return;let n=this._rootLView,s=qI(r,n[Dt],n,t,i);this.previousInputValues.set(t,i);let o=Mo(r.index,n);eA(o,1)}get injector(){return new dh(this._tNode,this._rootLView)}destroy(){this.hostView.destroy()}onDestroy(t){this.hostView.onDestroy(t)}};function pZ(e,t,i){let r=e.projection=[];for(let n=0;n<t.length;n++){let s=i[n];r.push(s!=null&&s.length?Array.from(s):null)}}var Hm=(()=>{class e{static __NG_ELEMENT_ID__=mZ}return e})();function mZ(){let e=ms();return $5(e,hi())}var fZ=Hm,W5=class extends fZ{_lContainer;_hostTNode;_hostLView;constructor(t,i,r){super(),this._lContainer=t,this._hostTNode=i,this._hostLView=r}get element(){return Fm(this._hostTNode,this._hostLView)}get injector(){return new dh(this._hostTNode,this._hostLView)}get parentInjector(){let t=kI(this._hostTNode,this._hostLView);if(GU(t)){let i=tC(t,this._hostLView),r=eC(t),n=i[Dt].data[r+8];return new dh(n,i)}else return new dh(null,this._hostLView)}clear(){for(;this.length>0;)this.remove(this.length-1)}get(t){let i=EU(this._lContainer);return i!==null&&i[t]||null}get length(){return this._lContainer.length-bn}createEmbeddedView(t,i,r){let n,s;typeof r=="number"?n=r:r!=null&&(n=r.index,s=r.injector);let o=gU(this._lContainer,t.ssrId),a=t.createEmbeddedViewImpl(i||{},s,o);return this.insertImpl(a,n,yI(this._hostTNode,o)),a}createComponent(t,i,r,n,s,o,a){let l=t&&!J9(t),c;if(l)c=i;else{let v=i||{};c=v.index,r=v.injector,n=v.projectableNodes,s=v.environmentInjector||v.ngModuleRef,o=v.directives,a=v.bindings}let h=l?t:new P_(eh(t)),p=r||this.parentInjector;if(!s&&h.ngModule==null){let b=(l?p:this.parentInjector).get(ps,null);b&&(s=b)}let m=eh(h.componentType??{}),f=gU(this._lContainer,m?.id??null),g=f?.firstChild??null,_=h.create(p,n,g,s,o,a);return this.insertImpl(_.hostView,c,yI(this._hostTNode,f)),_}insert(t,i){return this.insertImpl(t,i,!0)}insertImpl(t,i,r){let n=t._lView;if(PB(n)){let a=this.indexOf(t);if(a!==-1)this.detach(a);else{let l=n[$r],c=new W5(l,l[Eo],l[$r]);c.detach(c.indexOf(t))}}let s=this._adjustIndex(i),o=this._lContainer;return L5(o,n,s,r),t.attachToViewContainerRef(),ES(nI(o),s,t),t}move(t,i){return this.insert(t,i)}indexOf(t){let i=EU(this._lContainer);return i!==null?i.indexOf(t):-1}remove(t){let i=this._adjustIndex(t,-1),r=sC(this._lContainer,i);r&&(m_(nI(this._lContainer),i),YI(r[Dt],r))}detach(t){let i=this._adjustIndex(t,-1),r=sC(this._lContainer,i);return r&&m_(nI(this._lContainer),i)!=null?new Cu(r):null}_adjustIndex(t,i=0){return t??this.length+i}};function EU(e){return e[w_]}function nI(e){return e[w_]||(e[w_]=[])}function $5(e,t){let i,r=t[e.index];return fa(r)?i=r:(i=N5(r,t,null,e),t[e.index]=i,zI(t,i)),_Z(i,t,e,r),new W5(i,e,t)}function gZ(e,t){let i=e[hr],r=i.createComment(""),n=ga(t,e),s=i.parentNode(n);return nC(i,s,r,i.nextSibling(n),!1),r}var _Z=wZ,yZ=()=>!1;function vZ(e,t,i){return yZ(e,t,i)}function wZ(e,t,i,r){if(e[vu])return;let n;i.type&8?n=xo(r):n=gZ(t,i),e[vu]=n}var DI=class e{queryList;matches=null;constructor(t){this.queryList=t}clone(){return new e(this.queryList)}setDirty(){this.queryList.setDirty()}},xI=class e{queries;constructor(t=[]){this.queries=t}createEmbeddedView(t){let i=t.queries;if(i!==null){let r=t.contentQueries!==null?t.contentQueries[0]:i.length,n=[];for(let s=0;s<r;s++){let o=i.getByIndex(s),a=this.queries[o.indexInDeclarationView];n.push(a.clone())}return new e(n)}return null}insertView(t){this.dirtyQueriesWithMatches(t)}detachView(t){this.dirtyQueriesWithMatches(t)}finishViewCreation(t){this.dirtyQueriesWithMatches(t)}dirtyQueriesWithMatches(t){for(let i=0;i<this.queries.length;i++)nA(t,i).matches!==null&&this.queries[i].setDirty()}},MI=class{flags;read;predicate;constructor(t,i,r=null){this.flags=i,this.read=r,typeof t=="string"?this.predicate=SZ(t):this.predicate=t}},SI=class e{queries;constructor(t=[]){this.queries=t}elementStart(t,i){for(let r=0;r<this.queries.length;r++)this.queries[r].elementStart(t,i)}elementEnd(t){for(let i=0;i<this.queries.length;i++)this.queries[i].elementEnd(t)}embeddedTView(t){let i=null;for(let r=0;r<this.length;r++){let n=i!==null?i.length:0,s=this.getByIndex(r).embeddedTView(t,n);s&&(s.indexInDeclarationView=r,i!==null?i.push(s):i=[s])}return i!==null?new e(i):null}template(t,i){for(let r=0;r<this.queries.length;r++)this.queries[r].template(t,i)}getByIndex(t){return this.queries[t]}get length(){return this.queries.length}track(t){this.queries.push(t)}},II=class e{metadata;matches=null;indexInDeclarationView=-1;crossesNgTemplate=!1;_declarationNodeIndex;_appliesToNextNode=!0;constructor(t,i=-1){this.metadata=t,this._declarationNodeIndex=i}elementStart(t,i){this.isApplyingToNode(i)&&this.matchTNode(t,i)}elementEnd(t){this._declarationNodeIndex===t.index&&(this._appliesToNextNode=!1)}template(t,i){this.elementStart(t,i)}embeddedTView(t,i){return this.isApplyingToNode(t)?(this.crossesNgTemplate=!0,this.addMatch(-t.index,i),new e(this.metadata)):null}isApplyingToNode(t){if(this._appliesToNextNode&&(this.metadata.flags&1)!==1){let i=this._declarationNodeIndex,r=t.parent;for(;r!==null&&r.type&8&&r.index!==i;)r=r.parent;return i===(r!==null?r.index:-1)}return this._appliesToNextNode}matchTNode(t,i){let r=this.metadata.predicate;if(Array.isArray(r))for(let n=0;n<r.length;n++){let s=r[n];this.matchTNodeWithReadOption(t,i,bZ(i,s)),this.matchTNodeWithReadOption(t,i,Kb(i,t,s,!1,!1))}else r===ph?i.type&4&&this.matchTNodeWithReadOption(t,i,-1):this.matchTNodeWithReadOption(t,i,Kb(i,t,r,!1,!1))}matchTNodeWithReadOption(t,i,r){if(r!==null){let n=this.metadata.read;if(n!==null)if(n===oc||n===Hm||n===ph&&i.type&4)this.addMatch(i.index,-2);else{let s=Kb(i,t,n,!1,!1);s!==null&&this.addMatch(i.index,s)}else this.addMatch(i.index,r)}}addMatch(t,i){this.matches===null?this.matches=[t,i]:this.matches.push(t,i)}};function bZ(e,t){let i=e.localNames;if(i!==null){for(let r=0;r<i.length;r+=2)if(i[r]===t)return i[r+1]}return null}function CZ(e,t){return e.type&11?Fm(e,t):e.type&4?tA(e,t):null}function TZ(e,t,i,r){return i===-1?CZ(t,e):i===-2?EZ(e,t,r):A_(e,e[Dt],i,t)}function EZ(e,t,i){if(i===oc)return Fm(t,e);if(i===ph)return tA(t,e);if(i===Hm)return $5(t,e)}function Z5(e,t,i,r){let n=t[el].queries[r];if(n.matches===null){let s=e.data,o=i.matches,a=[];for(let l=0;o!==null&&l<o.length;l+=2){let c=o[l];if(c<0)a.push(null);else{let h=s[c];a.push(TZ(t,h,o[l+1],i.metadata.read))}}n.matches=a}return n.matches}function AI(e,t,i,r){let n=e.queries.getByIndex(i),s=n.matches;if(s!==null){let o=Z5(e,t,n,i);for(let a=0;a<s.length;a+=2){let l=s[a];if(l>0)r.push(o[a/2]);else{let c=s[a+1],h=t[-l];for(let p=bn;p<h.length;p++){let m=h[p];m[yu]===m[$r]&&AI(m[Dt],m,c,r)}if(h[sh]!==null){let p=h[sh];for(let m=0;m<p.length;m++){let f=p[m];AI(f[Dt],f,c,r)}}}}}return r}function DZ(e,t){return e[el].queries[t].queryList}function xZ(e,t,i){let r=new rC((i&4)===4);return LB(e,t,r,r.destroy),(t[el]??=new xI).queries.push(new DI(r))-1}function MZ(e,t,i){let r=Zr();return r.firstCreatePass&&(IZ(r,new MI(e,t,i),-1),(t&2)===2&&(r.staticViewQueries=!0)),xZ(r,hi(),t)}function SZ(e){return e.split(",").map(t=>t.trim())}function IZ(e,t,i){e.queries===null&&(e.queries=new SI),e.queries.track(new II(t,i))}function nA(e,t){return e.queries.getByIndex(t)}function AZ(e,t){let i=e[Dt],r=nA(i,t);return r.crossesNgTemplate?AI(i,e,t,[]):Z5(i,e,r,t)}var DU=new Set;function Bm(e){DU.has(e)||(DU.add(e),performance?.mark?.("mark_feature_usage",{detail:{feature:e}}))}var aC=class{};var O_=class extends aC{injector;componentFactoryResolver=new EI(this);instance=null;constructor(t){super();let i=new Xd([...t.providers,{provide:aC,useValue:this},{provide:_C,useValue:this.componentFactoryResolver}],t.parent||g_(),t.debugName,new Set(["environment"]));this.injector=i,t.runEnvironmentInitializers&&i.resolveInjectorInitializers()}destroy(){this.injector.destroy()}onDestroy(t){this.injector.onDestroy(t)}};function Q5(e,t,i=null){return new O_({providers:e,parent:t,debugName:i,runEnvironmentInitializers:!0}).injector}var RZ=(()=>{class e{_injector;cachedInjectors=new Map;constructor(i){this._injector=i}getOrCreateStandaloneInjector(i){if(!i.standalone)return null;if(!this.cachedInjectors.has(i)){let r=SS(!1,i.type),n=r.length>0?Q5([r],this._injector,`Standalone[${i.type.name}]`):null;this.cachedInjectors.set(i,n)}return this.cachedInjectors.get(i)}ngOnDestroy(){try{for(let i of this.cachedInjectors.values())i!==null&&i.destroy()}finally{this.cachedInjectors.clear()}}static \u0275prov=Zt({token:e,providedIn:"environment",factory:()=>new e(Bt(ps))})}return e})();function Bs(e){return Lm(()=>{let t=Y5(e),i=be(ie({},t),{decls:e.decls,vars:e.vars,template:e.template,consts:e.consts||null,ngContentSelectors:e.ngContentSelectors,onPush:e.changeDetection===VI.OnPush,directiveDefs:null,pipeDefs:null,dependencies:t.standalone&&e.dependencies||null,getStandaloneInjector:t.standalone?n=>n.get(RZ).getOrCreateStandaloneInjector(i):null,getExternalStyles:null,signals:e.signals??!1,data:e.data||{},encapsulation:e.encapsulation||rc.Emulated,styles:e.styles||ks,_:null,schemas:e.schemas||null,tView:null,id:""});t.standalone&&Bm("NgStandalone"),K5(i);let r=e.dependencies;return i.directiveDefs=xU(r,!1),i.pipeDefs=xU(r,!0),i.id=FZ(i),i})}function PZ(e){return eh(e)||MS(e)}function OZ(e){return e!==null}function Tu(e){return Lm(()=>({type:e.type,bootstrap:e.bootstrap||ks,declarations:e.declarations||ks,imports:e.imports||ks,exports:e.exports||ks,transitiveCompileScopes:null,schemas:e.schemas||null,id:e.id||null}))}function NZ(e,t){if(e==null)return gu;let i={};for(let r in e)if(e.hasOwnProperty(r)){let n=e[r],s,o,a,l;Array.isArray(n)?(a=n[0],s=n[1],o=n[2]??s,l=n[3]||null):(s=n,o=n,a=mC.None,l=null),i[s]=[r,a,l],t[s]=o}return i}function LZ(e){if(e==null)return gu;let t={};for(let i in e)e.hasOwnProperty(i)&&(t[e[i]]=i);return t}function gs(e){return Lm(()=>{let t=Y5(e);return K5(t),t})}function Y5(e){let t={};return{type:e.type,providersResolver:null,factory:null,hostBindings:e.hostBindings||null,hostVars:e.hostVars||0,hostAttrs:e.hostAttrs||null,contentQueries:e.contentQueries||null,declaredInputs:t,inputConfig:e.inputs||gu,exportAs:e.exportAs||null,standalone:e.standalone??!0,signals:e.signals===!0,selectors:e.selectors||ks,viewQuery:e.viewQuery||null,features:e.features||null,setInput:null,resolveHostDirectives:null,hostDirectives:null,inputs:NZ(e.inputs,t),outputs:LZ(e.outputs),debugInfo:null}}function K5(e){e.features?.forEach(t=>t(e))}function xU(e,t){if(!e)return null;let i=t?bB:PZ;return()=>(typeof e=="function"?e():e).map(r=>i(r)).filter(OZ)}function FZ(e){let t=0,i=typeof e.consts=="function"?"":e.consts,r=[e.selectors,e.ngContentSelectors,e.hostVars,e.hostAttrs,i,e.vars,e.decls,e.encapsulation,e.standalone,e.signals,e.exportAs,JSON.stringify(e.inputs),JSON.stringify(e.outputs),Object.getOwnPropertyNames(e.type.prototype),!!e.contentQueries,!!e.viewQuery];for(let s of r.join("|"))t=Math.imul(31,t)+s.charCodeAt(0)<<0;return t+=2147483648,"c"+t}function kZ(e){return Object.getPrototypeOf(e.prototype).constructor}function sl(e){let t=kZ(e.type),i=!0,r=[e];for(;t;){let n;if(il(e))n=t.\u0275cmp||t.\u0275dir;else{if(t.\u0275cmp)throw new ct(903,!1);n=t.\u0275dir}if(n){if(i){r.push(n);let o=e;o.inputs=sI(e.inputs),o.declaredInputs=sI(e.declaredInputs),o.outputs=sI(e.outputs);let a=n.hostBindings;a&&jZ(e,a);let l=n.viewQuery,c=n.contentQueries;if(l&&BZ(e,l),c&&UZ(e,c),VZ(e,n),pB(e.outputs,n.outputs),il(n)&&n.data.animation){let h=e.data;h.animation=(h.animation||[]).concat(n.data.animation)}}let s=n.features;if(s)for(let o=0;o<s.length;o++){let a=s[o];a&&a.ngInherit&&a(e),a===sl&&(i=!1)}}t=Object.getPrototypeOf(t)}HZ(r)}function VZ(e,t){for(let i in t.inputs){if(!t.inputs.hasOwnProperty(i)||e.inputs.hasOwnProperty(i))continue;let r=t.inputs[i];r!==void 0&&(e.inputs[i]=r,e.declaredInputs[i]=t.declaredInputs[i])}}function HZ(e){let t=0,i=null;for(let r=e.length-1;r>=0;r--){let n=e[r];n.hostVars=t+=n.hostVars,n.hostAttrs=I_(n.hostAttrs,i=I_(i,n.hostAttrs))}}function sI(e){return e===gu?{}:e===ks?[]:e}function BZ(e,t){let i=e.viewQuery;i?e.viewQuery=(r,n)=>{t(r,n),i(r,n)}:e.viewQuery=t}function UZ(e,t){let i=e.contentQueries;i?e.contentQueries=(r,n,s)=>{t(r,n,s),i(r,n,s)}:e.contentQueries=t}function jZ(e,t){let i=e.hostBindings;i?e.hostBindings=(r,n)=>{t(r,n),i(r,n)}:e.hostBindings=t}function zZ(e,t,i,r,n,s,o,a,l){let c=t.consts,h=iA(t,e,4,o||null,a||null);BS()&&H5(t,i,h,ah(c,l),b5),h.mergedAttrs=I_(h.mergedAttrs,h.attrs),jU(t,h);let p=h.tView=UI(2,h,r,n,s,t.directiveRegistry,t.pipeRegistry,null,t.schemas,c,null);return t.queries!==null&&(t.queries.template(t,h),p.queries=t.queries.embeddedTView(h)),h}function sA(e,t,i,r,n,s,o,a,l,c,h){let p=i+Hs,m=t.firstCreatePass?zZ(p,t,e,r,n,s,o,a,c):t.data[p];l&&(m.flags|=l),Im(m,!1);let f=GZ(t,e,m,i);zb()&&KI(t,e,f,m),F_(f,e);let g=N5(f,e,f,m);return e[p]=g,zI(e,g),vZ(g,m,e),Lb(m)&&GI(t,e,m),c!=null&&v5(e,m,h),m}function yC(e,t,i,r,n,s,o,a){let l=hi(),c=Zr(),h=ah(c.consts,s);return sA(l,c,e,t,i,r,n,h,void 0,o,a),yC}var GZ=qZ;function qZ(e,t,i,r){return Gb(!0),t[hr].createComment("")}var oA=function(e){return e[e.CHANGE_DETECTION=0]="CHANGE_DETECTION",e[e.AFTER_NEXT_RENDER=1]="AFTER_NEXT_RENDER",e}(oA||{}),V_=new ht(""),X5=!1,RI=class extends Xa{__isAsync;destroyRef=void 0;pendingTasks=void 0;constructor(t=!1){super(),this.__isAsync=t,MB()&&(this.destroyRef=ot(Rm,{optional:!0})??void 0,this.pendingTasks=ot(uh,{optional:!0})??void 0)}emit(t){let i=Et(null);try{super.next(t)}finally{Et(i)}}subscribe(t,i,r){let n=t,s=i||(()=>null),o=r;if(t&&typeof t=="object"){let l=t;n=l.next?.bind(l),s=l.error?.bind(l),o=l.complete?.bind(l)}this.__isAsync&&(s=this.wrapInTimeout(s),n&&(n=this.wrapInTimeout(n)),o&&(o=this.wrapInTimeout(o)));let a=super.subscribe({next:n,error:s,complete:o});return t instanceof Un&&t.add(a),a}wrapInTimeout(t){return i=>{let r=this.pendingTasks?.add();setTimeout(()=>{try{t(i)}finally{r!==void 0&&this.pendingTasks?.remove(r)}})}}},Qr=RI;function J5(e){let t,i;function r(){e=x_;try{i!==void 0&&typeof cancelAnimationFrame=="function"&&cancelAnimationFrame(i),t!==void 0&&clearTimeout(t)}catch{}}return t=setTimeout(()=>{e(),r()}),typeof requestAnimationFrame=="function"&&(i=requestAnimationFrame(()=>{e(),r()})),()=>r()}function MU(e){return queueMicrotask(()=>e()),()=>{e=x_}}var aA="isAngularZone",lC=aA+"_ID",WZ=0,Or=class e{hasPendingMacrotasks=!1;hasPendingMicrotasks=!1;isStable=!0;onUnstable=new Qr(!1);onMicrotaskEmpty=new Qr(!1);onStable=new Qr(!1);onError=new Qr(!1);constructor(t){let{enableLongStackTrace:i=!1,shouldCoalesceEventChangeDetection:r=!1,shouldCoalesceRunChangeDetection:n=!1,scheduleInRootZone:s=X5}=t;if(typeof Zone>"u")throw new ct(908,!1);Zone.assertZonePatched();let o=this;o._nesting=0,o._outer=o._inner=Zone.current,Zone.TaskTrackingZoneSpec&&(o._inner=o._inner.fork(new Zone.TaskTrackingZoneSpec)),i&&Zone.longStackTraceZoneSpec&&(o._inner=o._inner.fork(Zone.longStackTraceZoneSpec)),o.shouldCoalesceEventChangeDetection=!n&&r,o.shouldCoalesceRunChangeDetection=n,o.callbackScheduled=!1,o.scheduleInRootZone=s,QZ(o)}static isInAngularZone(){return typeof Zone<"u"&&Zone.current.get(aA)===!0}static assertInAngularZone(){if(!e.isInAngularZone())throw new ct(909,!1)}static assertNotInAngularZone(){if(e.isInAngularZone())throw new ct(909,!1)}run(t,i,r){return this._inner.run(t,i,r)}runTask(t,i,r,n){let s=this._inner,o=s.scheduleEventTask("NgZoneEvent: "+n,t,$Z,x_,x_);try{return s.runTask(o,i,r)}finally{s.cancelTask(o)}}runGuarded(t,i,r){return this._inner.runGuarded(t,i,r)}runOutsideAngular(t){return this._outer.run(t)}},$Z={};function lA(e){if(e._nesting==0&&!e.hasPendingMicrotasks&&!e.isStable)try{e._nesting++,e.onMicrotaskEmpty.emit(null)}finally{if(e._nesting--,!e.hasPendingMicrotasks)try{e.runOutsideAngular(()=>e.onStable.emit(null))}finally{e.isStable=!0}}}function ZZ(e){if(e.isCheckStableRunning||e.callbackScheduled)return;e.callbackScheduled=!0;function t(){J5(()=>{e.callbackScheduled=!1,PI(e),e.isCheckStableRunning=!0,lA(e),e.isCheckStableRunning=!1})}e.scheduleInRootZone?Zone.root.run(()=>{t()}):e._outer.run(()=>{t()}),PI(e)}function QZ(e){let t=()=>{ZZ(e)},i=WZ++;e._inner=e._inner.fork({name:"angular",properties:{[aA]:!0,[lC]:i,[lC+i]:!0},onInvokeTask:(r,n,s,o,a,l)=>{if(YZ(l))return r.invokeTask(s,o,a,l);try{return SU(e),r.invokeTask(s,o,a,l)}finally{(e.shouldCoalesceEventChangeDetection&&o.type==="eventTask"||e.shouldCoalesceRunChangeDetection)&&t(),IU(e)}},onInvoke:(r,n,s,o,a,l,c)=>{try{return SU(e),r.invoke(s,o,a,l,c)}finally{e.shouldCoalesceRunChangeDetection&&!e.callbackScheduled&&!KZ(l)&&t(),IU(e)}},onHasTask:(r,n,s,o)=>{r.hasTask(s,o),n===s&&(o.change=="microTask"?(e._hasPendingMicrotasks=o.microTask,PI(e),lA(e)):o.change=="macroTask"&&(e.hasPendingMacrotasks=o.macroTask))},onHandleError:(r,n,s,o)=>(r.handleError(s,o),e.runOutsideAngular(()=>e.onError.emit(o)),!1)})}function PI(e){e._hasPendingMicrotasks||(e.shouldCoalesceEventChangeDetection||e.shouldCoalesceRunChangeDetection)&&e.callbackScheduled===!0?e.hasPendingMicrotasks=!0:e.hasPendingMicrotasks=!1}function SU(e){e._nesting++,e.isStable&&(e.isStable=!1,e.onUnstable.emit(null))}function IU(e){e._nesting--,lA(e)}var N_=class{hasPendingMicrotasks=!1;hasPendingMacrotasks=!1;isStable=!0;onUnstable=new Qr;onMicrotaskEmpty=new Qr;onStable=new Qr;onError=new Qr;run(t,i,r){return t.apply(i,r)}runGuarded(t,i,r){return t.apply(i,r)}runOutsideAngular(t){return t()}runTask(t,i,r,n){return t.apply(i,r)}};function YZ(e){return ej(e,"__ignore_ng_zone__")}function KZ(e){return ej(e,"__scheduler_tick__")}function ej(e,t){return!Array.isArray(e)||e.length!==1?!1:e[0]?.data?.[t]===!0}var tj=(()=>{class e{impl=null;execute(){this.impl?.execute()}static \u0275prov=Zt({token:e,providedIn:"root",factory:()=>new e})}return e})();var cA=new ht("");function H_(e){return!!e&&typeof e.then=="function"}function ij(e){return!!e&&typeof e.subscribe=="function"}var rj=new ht("");var uA=(()=>{class e{resolve;reject;initialized=!1;done=!1;donePromise=new Promise((i,r)=>{this.resolve=i,this.reject=r});appInits=ot(rj,{optional:!0})??[];injector=ot(fu);constructor(){}runInitializers(){if(this.initialized)return;let i=[];for(let n of this.appInits){let s=Tm(this.injector,n);if(H_(s))i.push(s);else if(ij(s)){let o=new Promise((a,l)=>{s.subscribe({complete:a,error:l})});i.push(o)}}let r=()=>{this.done=!0,this.resolve()};Promise.all(i).then(()=>{r()}).catch(n=>{this.reject(n)}),i.length===0&&r(),this.initialized=!0}static \u0275fac=function(r){return new(r||e)};static \u0275prov=Zt({token:e,factory:e.\u0275fac,providedIn:"root"})}return e})(),nj=new ht("");function sj(){BM(()=>{let e="";throw new ct(600,e)})}function oj(e){return e.isBoundToModule}var XZ=10;var B_=(()=>{class e{_runningTick=!1;_destroyed=!1;_destroyListeners=[];_views=[];internalErrorHandler=ot(rl);afterRenderManager=ot(tj);zonelessEnabled=ot(D_);rootEffectScheduler=ot(JS);dirtyFlags=0;tracingSnapshot=null;allTestViews=new Set;autoDetectTestViews=new Set;includeAllTestViews=!1;afterTick=new Xa;get allViews(){return[...(this.includeAllTestViews?this.allTestViews:this.autoDetectTestViews).keys(),...this._views]}get destroyed(){return this._destroyed}componentTypes=[];components=[];internalPendingTask=ot(uh);get isStable(){return this.internalPendingTask.hasPendingTasksObservable.pipe(hs(i=>!i))}constructor(){ot(V_,{optional:!0})}whenStable(){let i;return new Promise(r=>{i=this.isStable.subscribe({next:n=>{n&&r()}})}).finally(()=>{i.unsubscribe()})}_injector=ot(ps);_rendererFactory=null;get injector(){return this._injector}bootstrap(i,r){return this.bootstrapImpl(i,r)}bootstrapImpl(i,r,n=fu.NULL){return this._injector.get(Or).run(()=>{Ii(10);let o=i instanceof gC;if(!this._injector.get(uA).done){let g="";throw new ct(405,g)}let l;o?l=i:l=this._injector.get(_C).resolveComponentFactory(i),this.componentTypes.push(l.componentType);let c=oj(l)?void 0:this._injector.get(aC),h=r||l.selector,p=l.create(n,[],h,c),m=p.location.nativeElement,f=p.injector.get(cA,null);return f?.registerApplication(m),p.onDestroy(()=>{this.detachView(p.hostView),S_(this.components,p),f?.unregisterApplication(m)}),this._loadComponent(p),Ii(11,p),p})}tick(){this.zonelessEnabled||(this.dirtyFlags|=1),this._tick()}_tick(){Ii(12),this.tracingSnapshot!==null?this.tracingSnapshot.run(oA.CHANGE_DETECTION,this.tickImpl):this.tickImpl()}tickImpl=()=>{if(this._runningTick)throw new ct(101,!1);let i=Et(null);try{this._runningTick=!0,this.synchronize()}finally{this._runningTick=!1,this.tracingSnapshot?.dispose(),this.tracingSnapshot=null,Et(i),this.afterTick.next(),Ii(13)}};synchronize(){this._rendererFactory===null&&!this._injector.destroyed&&(this._rendererFactory=this._injector.get(mh,null,{optional:!0}));let i=0;for(;this.dirtyFlags!==0&&i++<XZ;)Ii(14),this.synchronizeOnce(),Ii(15)}synchronizeOnce(){this.dirtyFlags&16&&(this.dirtyFlags&=-17,this.rootEffectScheduler.flush());let i=!1;if(this.dirtyFlags&7){let r=!!(this.dirtyFlags&1);this.dirtyFlags&=-8,this.dirtyFlags|=8;for(let{_lView:n}of this.allViews){if(!r&&!C_(n))continue;let s=r&&!this.zonelessEnabled?0:1;JI(n,s),i=!0}if(this.dirtyFlags&=-5,this.syncDirtyFlagsWithViews(),this.dirtyFlags&23)return}i||(this._rendererFactory?.begin?.(),this._rendererFactory?.end?.()),this.dirtyFlags&8&&(this.dirtyFlags&=-9,this.afterRenderManager.execute()),this.syncDirtyFlagsWithViews()}syncDirtyFlagsWithViews(){if(this.allViews.some(({_lView:i})=>C_(i))){this.dirtyFlags|=2;return}else this.dirtyFlags&=-8}attachView(i){let r=i;this._views.push(r),r.attachToAppRef(this)}detachView(i){let r=i;S_(this._views,r),r.detachFromAppRef()}_loadComponent(i){this.attachView(i.hostView);try{this.tick()}catch(n){this.internalErrorHandler(n)}this.components.push(i),this._injector.get(nj,[]).forEach(n=>n(i))}ngOnDestroy(){if(!this._destroyed)try{this._destroyListeners.forEach(i=>i()),this._views.slice().forEach(i=>i.destroy())}finally{this._destroyed=!0,this._views=[],this._destroyListeners=[]}}onDestroy(i){return this._destroyListeners.push(i),()=>S_(this._destroyListeners,i)}destroy(){if(this._destroyed)throw new ct(406,!1);let i=this._injector;i.destroy&&!i.destroyed&&i.destroy()}get viewCount(){return this._views.length}static \u0275fac=function(r){return new(r||e)};static \u0275prov=Zt({token:e,factory:e.\u0275fac,providedIn:"root"})}return e})();function S_(e,t){let i=e.indexOf(t);i>-1&&e.splice(i,1)}function vC(e,t,i,r){let n=hi(),s=Am();if(Vm(n,s,t)){let o=Zr(),a=jb();n$(a,n,e,t,i,r)}return vC}function gh(e,t,i,r,n,s,o,a){Bm("NgControlFlow");let l=hi(),c=Zr(),h=ah(c.consts,s);return sA(l,c,e,t,i,r,n,h,256,o,a),dA}function dA(e,t,i,r,n,s,o,a){Bm("NgControlFlow");let l=hi(),c=Zr(),h=ah(c.consts,s);return sA(l,c,e,t,i,r,n,h,512,o,a),dA}function _h(e,t){Bm("NgControlFlow");let i=hi(),r=Am(),n=i[r]!==ac?i[r]:-1,s=n!==-1?AU(i,Hs+n):void 0,o=0;if(Vm(i,r,e)){let a=Et(null);try{if(s!==void 0&&H$(s,o),e!==-1){let l=Hs+e,c=AU(i,l),h=JZ(i[Dt],l),p=$$(c,h,i),m=C5(i,h,t,{dehydratedView:p});L5(c,m,o,yI(h,p))}}finally{Et(a)}}else if(s!==void 0){let a=V$(s,o);a!==void 0&&(a[on]=t)}}function AU(e,t){return e[t]}function JZ(e,t){return b_(e,t)}function yh(e,t,i){let r=hi(),n=Am();if(Vm(r,n,t)){let s=Zr(),o=jb();w5(o,r,e,t,r[hr],i)}return yh}function RU(e,t,i,r,n){qI(t,e,i,n?"class":"style",r)}function Ai(e,t,i,r){let n=hi(),s=Zr(),o=Hs+e,a=n[hr],l=s.firstCreatePass?U5(o,s,n,t,b5,BS(),i,r):s.data[o],c=eQ(s,n,l,a,t,e);n[o]=c;let h=Lb(l);return Im(l,!0),m5(a,c,l),!ZI(l)&&zb()&&KI(s,n,c,l),(FB()===0||h)&&F_(c,n),kB(),h&&(GI(s,n,l),c5(s,l,n)),r!==null&&v5(n,l),Ai}function pr(){let e=ms();jS()?zB():(e=e.parent,Im(e,!1));let t=e;BB(t)&&UB(),VB();let i=Zr();return i.firstCreatePass&&j5(i,t),t.classesWithoutHost!=null&&s7(t)&&RU(i,t,hi(),t.classesWithoutHost,!0),t.stylesWithoutHost!=null&&o7(t)&&RU(i,t,hi(),t.stylesWithoutHost,!1),pr}function Lr(e,t,i,r){return Ai(e,t,i,r),pr(),Lr}var eQ=(e,t,i,r,n,s)=>(Gb(!0),h5(r,n,eU()));function U_(){return hi()}var j_="en-US";var tQ=j_;function aj(e){typeof e=="string"&&(tQ=e.toLowerCase().replace(/_/g,"-"))}function _s(e,t,i){let r=hi(),n=Zr(),s=ms();return lj(n,r,r[hr],s,e,t,i),_s}function lj(e,t,i,r,n,s,o){let a=!0,l=null;if((r.type&3||o)&&(l??=rI(r,t,s),nZ(r,e,t,o,i,n,s,l)&&(a=!1)),a){let c=r.outputs?.[n],h=r.hostDirectiveOutputs?.[n];if(h&&h.length)for(let p=0;p<h.length;p+=2){let m=h[p],f=h[p+1];l??=rI(r,t,s),CU(r,t,m,f,n,l)}if(c&&c.length)for(let p of c)l??=rI(r,t,s),CU(r,t,p,n,n,l)}}function vh(e=1){return JB(e)}function hA(e,t,i){MZ(e,t,i)}function pA(e){let t=hi(),i=Zr(),r=WS();Hb(r+1);let n=nA(i,r);if(e.dirty&&RB(t)===((n.metadata.flags&2)===2)){if(n.matches===null)e.reset([]);else{let s=AZ(t,r);e.reset(s,v7),e.notifyOnChanges()}return!0}return!1}function mA(){return DZ(hi(),WS())}function Zb(e,t){return e<<17|t<<2}function fh(e){return e>>17&32767}function iQ(e){return(e&2)==2}function rQ(e,t){return e&131071|t<<17}function OI(e){return e|2}function Nm(e){return(e&131068)>>2}function oI(e,t){return e&-131069|t<<2}function nQ(e){return(e&1)===1}function NI(e){return e|1}function sQ(e,t,i,r,n,s){let o=s?t.classBindings:t.styleBindings,a=fh(o),l=Nm(o);e[r]=i;let c=!1,h;if(Array.isArray(i)){let p=i;h=p[1],(h===null||Cm(p,h)>0)&&(c=!0)}else h=i;if(n)if(l!==0){let m=fh(e[a+1]);e[r+1]=Zb(m,a),m!==0&&(e[m+1]=oI(e[m+1],r)),e[a+1]=rQ(e[a+1],r)}else e[r+1]=Zb(a,0),a!==0&&(e[a+1]=oI(e[a+1],r)),a=r;else e[r+1]=Zb(l,0),a===0?a=r:e[l+1]=oI(e[l+1],r),l=r;c&&(e[r+1]=OI(e[r+1])),PU(e,h,r,!0),PU(e,h,r,!1),oQ(t,h,e,r,s),o=Zb(a,l),s?t.classBindings=o:t.styleBindings=o}function oQ(e,t,i,r,n){let s=n?e.residualClasses:e.residualStyles;s!=null&&typeof t=="string"&&Cm(s,t)>=0&&(i[r+1]=NI(i[r+1]))}function PU(e,t,i,r){let n=e[i+1],s=t===null,o=r?fh(n):Nm(n),a=!1;for(;o!==0&&(a===!1||s);){let l=e[o],c=e[o+1];aQ(l,t)&&(a=!0,e[o+1]=r?NI(c):OI(c)),o=r?fh(c):Nm(c)}a&&(e[i+1]=r?OI(n):NI(n))}function aQ(e,t){return e===null||t==null||(Array.isArray(e)?e[1]:e)===t?!0:Array.isArray(e)&&typeof t=="string"?Cm(e,t)>=0:!1}function ya(e,t){return lQ(e,t,null,!0),ya}function lQ(e,t,i,r){let n=hi(),s=Zr(),o=qB(2);if(s.firstUpdatePass&&uQ(s,e,o,r),t!==ac&&Vm(n,o,t)){let a=s.data[lh()];fQ(s,a,n,n[hr],e,n[o+1]=gQ(t,i),r,o)}}function cQ(e,t){return t>=e.expandoStartIndex}function uQ(e,t,i,r){let n=e.data;if(n[i+1]===null){let s=n[lh()],o=cQ(e,i);_Q(s,r)&&t===null&&!o&&(t=!1),t=dQ(n,s,t,r),sQ(n,s,t,i,o,r)}}function dQ(e,t,i,r){let n=QB(e),s=r?t.residualClasses:t.residualStyles;if(n===null)(r?t.classBindings:t.styleBindings)===0&&(i=aI(null,e,t,i,r),i=L_(i,t.attrs,r),s=null);else{let o=t.directiveStylingLast;if(o===-1||e[o]!==n)if(i=aI(n,e,t,i,r),s===null){let l=hQ(e,t,r);l!==void 0&&Array.isArray(l)&&(l=aI(null,e,t,l[1],r),l=L_(l,t.attrs,r),pQ(e,t,r,l))}else s=mQ(e,t,r)}return s!==void 0&&(r?t.residualClasses=s:t.residualStyles=s),i}function hQ(e,t,i){let r=i?t.classBindings:t.styleBindings;if(Nm(r)!==0)return e[fh(r)]}function pQ(e,t,i,r){let n=i?t.classBindings:t.styleBindings;e[fh(n)]=r}function mQ(e,t,i){let r,n=t.directiveEnd;for(let s=1+t.directiveStylingLast;s<n;s++){let o=e[s].hostAttrs;r=L_(r,o,i)}return L_(r,t.attrs,i)}function aI(e,t,i,r,n){let s=null,o=i.directiveEnd,a=i.directiveStylingLast;for(a===-1?a=i.directiveStart:a++;a<o&&(s=t[a],r=L_(r,s.hostAttrs,n),s!==e);)a++;return e!==null&&(i.directiveStylingLast=a),r}function L_(e,t,i){let r=i?1:2,n=-1;if(t!==null)for(let s=0;s<t.length;s++){let o=t[s];typeof o=="number"?n=o:n===r&&(Array.isArray(e)||(e=e===void 0?[]:["",e]),wB(e,o,i?!0:t[++s]))}return e===void 0?null:e}function fQ(e,t,i,r,n,s,o,a){if(!(t.type&3))return;let l=e.data,c=l[a+1],h=nQ(c)?OU(l,t,i,n,Nm(c),o):void 0;if(!cC(h)){cC(s)||iQ(c)&&(s=OU(l,null,i,n,a,o));let p=NS(lh(),i);D$(r,o,p,n,s)}}function OU(e,t,i,r,n,s){let o=t===null,a;for(;n>0;){let l=e[n],c=Array.isArray(l),h=c?l[1]:l,p=h===null,m=i[n+1];m===ac&&(m=p?ks:void 0);let f=p?Pb(m,r):h===r?m:void 0;if(c&&!cC(f)&&(f=Pb(l,r)),cC(f)&&(a=f,o))return a;let g=e[n+1];n=o?fh(g):Nm(g)}if(t!==null){let l=s?t.residualClasses:t.residualStyles;l!=null&&(a=Pb(l,r))}return a}function cC(e){return e!==void 0}function gQ(e,t){return e==null||e===""||(typeof t=="string"?e=e+t:typeof e=="object"&&(e=Fs(u5(e)))),e}function _Q(e,t){return(e.flags&(t?8:16))!==0}function jn(e,t=""){let i=hi(),r=Zr(),n=e+Hs,s=r.firstCreatePass?iA(r,n,1,t,null):r.data[n],o=yQ(r,i,s,t,e);i[n]=o,zb()&&KI(r,i,o,s),Im(s,!1)}var yQ=(e,t,i,r,n)=>(Gb(!0),U7(t[hr],r));function vQ(e,t,i,r=""){return Vm(e,Am(),i)?t+Ib(i)+r:ac}function Um(e){return fA("",e),Um}function fA(e,t,i){let r=hi(),n=vQ(r,e,t,i);return n!==ac&&wQ(r,lh(),n),fA}function wQ(e,t,i){let r=NS(t,e);j7(e[hr],r,i)}function jm(e,t,i){KS(t)&&(t=t());let r=hi(),n=Am();if(Vm(r,n,t)){let s=Zr(),o=jb();w5(o,r,e,t,r[hr],i)}return jm}function z_(e,t){let i=KS(e);return i&&e.set(t),i}function zm(e,t){let i=hi(),r=Zr(),n=ms();return lj(r,i,i[hr],n,e,t),zm}function bQ(e,t,i){let r=Zr();if(r.firstCreatePass){let n=il(e);LI(i,r.data,r.blueprint,n,!0),LI(t,r.data,r.blueprint,n,!1)}}function LI(e,t,i,r,n){if(e=sn(e),Array.isArray(e))for(let s=0;s<e.length;s++)LI(e[s],t,i,r,n);else{let s=Zr(),o=hi(),a=ms(),l=Kd(e)?e:sn(e.provide),c=AS(e),h=a.providerIndexes&1048575,p=a.directiveStart,m=a.providerIndexes>>20;if(Kd(e)||!e.multi){let f=new hh(c,n,It),g=cI(l,t,n?h:h+m,p);g===-1?(dI(iC(a,o),s,l),lI(s,e,t.length),t.push(l),a.directiveStart++,a.directiveEnd++,n&&(a.providerIndexes+=1048576),i.push(f),o.push(f)):(i[g]=f,o[g]=f)}else{let f=cI(l,t,h+m,p),g=cI(l,t,h,h+m),_=f>=0&&i[f],v=g>=0&&i[g];if(n&&!v||!n&&!_){dI(iC(a,o),s,l);let b=EQ(n?TQ:CQ,i.length,n,r,c);!n&&v&&(i[g].providerFactory=b),lI(s,e,t.length,0),t.push(l),a.directiveStart++,a.directiveEnd++,n&&(a.providerIndexes+=1048576),i.push(b),o.push(b)}else{let b=cj(i[n?g:f],c,!n&&r);lI(s,e,f>-1?f:g,b)}!n&&r&&v&&i[g].componentProviders++}}}function lI(e,t,i,r){let n=Kd(t),s=xB(t);if(n||s){let l=(s?sn(t.useClass):t).prototype.ngOnDestroy;if(l){let c=e.destroyHooks||(e.destroyHooks=[]);if(!n&&t.multi){let h=c.indexOf(i);h===-1?c.push(i,[r,l]):c[h+1].push(r,l)}else c.push(i,l)}}}function cj(e,t,i){return i&&e.componentProviders++,e.multi.push(t)-1}function cI(e,t,i,r){for(let n=i;n<r;n++)if(t[n]===e)return n;return-1}function CQ(e,t,i,r){return FI(this.multi,[])}function TQ(e,t,i,r){let n=this.multi,s;if(this.providerFactory){let o=this.providerFactory.componentProviders,a=A_(i,i[Dt],this.providerFactory.index,r);s=a.slice(0,o),FI(n,s);for(let l=o;l<a.length;l++)s.push(a[l])}else s=[],FI(n,s);return s}function FI(e,t){for(let i=0;i<e.length;i++){let r=e[i];t.push(r())}return t}function EQ(e,t,i,r,n){let s=new hh(e,i,It);return s.multi=[],s.index=t,s.componentProviders=0,cj(s,n,r&&!i),s}function Gm(e,t=[]){return i=>{i.providersResolver=(r,n)=>bQ(r,n?n(e):e,t)}}var DQ=(()=>{class e{zone=ot(Or);changeDetectionScheduler=ot(Jl);applicationRef=ot(B_);applicationErrorHandler=ot(rl);_onMicrotaskEmptySubscription;initialize(){this._onMicrotaskEmptySubscription||(this._onMicrotaskEmptySubscription=this.zone.onMicrotaskEmpty.subscribe({next:()=>{this.changeDetectionScheduler.runningTick||this.zone.run(()=>{try{this.applicationRef.dirtyFlags|=1,this.applicationRef._tick()}catch(i){this.applicationErrorHandler(i)}})}}))}ngOnDestroy(){this._onMicrotaskEmptySubscription?.unsubscribe()}static \u0275fac=function(r){return new(r||e)};static \u0275prov=Zt({token:e,factory:e.\u0275fac,providedIn:"root"})}return e})();function uj({ngZoneFactory:e,ignoreChangesOutsideZone:t,scheduleInRootZone:i}){return e??=()=>new Or(be(ie({},dj()),{scheduleInRootZone:i})),[{provide:Or,useFactory:e},{provide:_u,multi:!0,useFactory:()=>{let r=ot(DQ,{optional:!0});return()=>r.initialize()}},{provide:_u,multi:!0,useFactory:()=>{let r=ot(xQ);return()=>{r.initialize()}}},t===!0?{provide:XS,useValue:!0}:[],{provide:qb,useValue:i??X5},{provide:rl,useFactory:()=>{let r=ot(Or),n=ot(ps),s;return o=>{s??=n.get(Ja),r.runOutsideAngular(()=>s.handleError(o))}}}]}function dj(e){return{enableLongStackTrace:!1,shouldCoalesceEventChangeDetection:e?.eventCoalescing??!1,shouldCoalesceRunChangeDetection:e?.runCoalescing??!1}}var xQ=(()=>{class e{subscription=new Un;initialized=!1;zone=ot(Or);pendingTasks=ot(uh);initialize(){if(this.initialized)return;this.initialized=!0;let i=null;!this.zone.isStable&&!this.zone.hasPendingMacrotasks&&!this.zone.hasPendingMicrotasks&&(i=this.pendingTasks.add()),this.zone.runOutsideAngular(()=>{this.subscription.add(this.zone.onStable.subscribe(()=>{Or.assertNotInAngularZone(),queueMicrotask(()=>{i!==null&&!this.zone.hasPendingMacrotasks&&!this.zone.hasPendingMicrotasks&&(this.pendingTasks.remove(i),i=null)})}))}),this.subscription.add(this.zone.onUnstable.subscribe(()=>{Or.assertInAngularZone(),i??=this.pendingTasks.add()}))}ngOnDestroy(){this.subscription.unsubscribe()}static \u0275fac=function(r){return new(r||e)};static \u0275prov=Zt({token:e,factory:e.\u0275fac,providedIn:"root"})}return e})();var gA=(()=>{class e{applicationErrorHandler=ot(rl);appRef=ot(B_);taskService=ot(uh);ngZone=ot(Or);zonelessEnabled=ot(D_);tracing=ot(V_,{optional:!0});disableScheduling=ot(XS,{optional:!0})??!1;zoneIsDefined=typeof Zone<"u"&&!!Zone.root.run;schedulerTickApplyArgs=[{data:{__scheduler_tick__:!0}}];subscriptions=new Un;angularZoneId=this.zoneIsDefined?this.ngZone._inner?.get(lC):null;scheduleInRootZone=!this.zonelessEnabled&&this.zoneIsDefined&&(ot(qb,{optional:!0})??!1);cancelScheduledCallback=null;useMicrotaskScheduler=!1;runningTick=!1;pendingRenderTaskId=null;constructor(){this.subscriptions.add(this.appRef.afterTick.subscribe(()=>{this.runningTick||this.cleanup()})),this.subscriptions.add(this.ngZone.onUnstable.subscribe(()=>{this.runningTick||this.cleanup()})),this.disableScheduling||=!this.zonelessEnabled&&(this.ngZone instanceof N_||!this.zoneIsDefined)}notify(i){if(!this.zonelessEnabled&&i===5)return;let r=!1;switch(i){case 0:{this.appRef.dirtyFlags|=2;break}case 3:case 2:case 4:case 5:case 1:{this.appRef.dirtyFlags|=4;break}case 6:{this.appRef.dirtyFlags|=2,r=!0;break}case 12:{this.appRef.dirtyFlags|=16,r=!0;break}case 13:{this.appRef.dirtyFlags|=2,r=!0;break}case 11:{r=!0;break}case 9:case 8:case 7:case 10:default:this.appRef.dirtyFlags|=8}if(this.appRef.tracingSnapshot=this.tracing?.snapshot(this.appRef.tracingSnapshot)??null,!this.shouldScheduleTick(r))return;let n=this.useMicrotaskScheduler?MU:J5;this.pendingRenderTaskId=this.taskService.add(),this.scheduleInRootZone?this.cancelScheduledCallback=Zone.root.run(()=>n(()=>this.tick())):this.cancelScheduledCallback=this.ngZone.runOutsideAngular(()=>n(()=>this.tick()))}shouldScheduleTick(i){return!(this.disableScheduling&&!i||this.appRef.destroyed||this.pendingRenderTaskId!==null||this.runningTick||this.appRef._runningTick||!this.zonelessEnabled&&this.zoneIsDefined&&Zone.current.get(lC+this.angularZoneId))}tick(){if(this.runningTick||this.appRef.destroyed)return;if(this.appRef.dirtyFlags===0){this.cleanup();return}!this.zonelessEnabled&&this.appRef.dirtyFlags&7&&(this.appRef.dirtyFlags|=1);let i=this.taskService.add();try{this.ngZone.run(()=>{this.runningTick=!0,this.appRef._tick()},void 0,this.schedulerTickApplyArgs)}catch(r){this.taskService.remove(i),this.applicationErrorHandler(r)}finally{this.cleanup()}this.useMicrotaskScheduler=!0,MU(()=>{this.useMicrotaskScheduler=!1,this.taskService.remove(i)})}ngOnDestroy(){this.subscriptions.unsubscribe(),this.cleanup()}cleanup(){if(this.runningTick=!1,this.cancelScheduledCallback?.(),this.cancelScheduledCallback=null,this.pendingRenderTaskId!==null){let i=this.pendingRenderTaskId;this.pendingRenderTaskId=null,this.taskService.remove(i)}}static \u0275fac=function(r){return new(r||e)};static \u0275prov=Zt({token:e,factory:e.\u0275fac,providedIn:"root"})}return e})();function _A(){return Bm("NgZoneless"),th([{provide:Jl,useExisting:gA},{provide:Or,useClass:N_},{provide:D_,useValue:!0},{provide:qb,useValue:!1},[]])}function MQ(){return typeof $localize<"u"&&$localize.locale||j_}var yA=new ht("",{providedIn:"root",factory:()=>ot(yA,{optional:!0,skipSelf:!0})||MQ()});function lc(e){return cB(e)}function qm(e,t){return tb(e,t?.equal)}var hj=class{[ls];constructor(t){this[ls]=t}destroy(){this[ls].destroy()}};var LQ=new ht("");LQ.__NG_ELEMENT_ID__=e=>{let t=ms();if(t===null)throw new ct(204,!1);if(t.type&2)return t.value;if(e&8)return null;throw new ct(204,!1)};var vA=new ht(""),FQ=new ht("");function G_(e){return!e.moduleRef}function kQ(e){let t=G_(e)?e.r3Injector:e.moduleRef.injector,i=t.get(Or);return i.run(()=>{G_(e)?e.r3Injector.resolveInjectorInitializers():e.moduleRef.resolveInjectorInitializers();let r=t.get(rl),n;if(i.runOutsideAngular(()=>{n=i.onError.subscribe({next:r})}),G_(e)){let s=()=>t.destroy(),o=e.platformInjector.get(vA);o.add(s),t.onDestroy(()=>{n.unsubscribe(),o.delete(s)})}else{let s=()=>e.moduleRef.destroy(),o=e.platformInjector.get(vA);o.add(s),e.moduleRef.onDestroy(()=>{S_(e.allPlatformModules,e.moduleRef),n.unsubscribe(),o.delete(s)})}return HQ(r,i,()=>{let s=t.get(uA);return s.runInitializers(),s.donePromise.then(()=>{let o=t.get(yA,j_);if(aj(o||j_),!t.get(FQ,!0))return G_(e)?t.get(B_):(e.allPlatformModules.push(e.moduleRef),e.moduleRef);if(G_(e)){let l=t.get(B_);return e.rootComponent!==void 0&&l.bootstrap(e.rootComponent),l}else return VQ?.(e.moduleRef,e.allPlatformModules),e.moduleRef})})})}var VQ;function HQ(e,t,i){try{let r=i();return H_(r)?r.catch(n=>{throw t.runOutsideAngular(()=>e(n)),n}):r}catch(r){throw t.runOutsideAngular(()=>e(r)),r}}var wC=null;function BQ(e=[],t){return fu.create({name:t,providers:[{provide:f_,useValue:"platform"},{provide:vA,useValue:new Set([()=>wC=null])},...e]})}function UQ(e=[]){if(wC)return wC;let t=BQ(e);return wC=t,sj(),jQ(t),t}function jQ(e){let t=e.get(hC,null);Tm(e,()=>{t?.forEach(i=>i())})}var cc=(()=>{class e{static __NG_ELEMENT_ID__=zQ}return e})();function zQ(e){return GQ(ms(),hi(),(e&16)===16)}function GQ(e,t,i){if(wu(e)&&!i){let r=Mo(e.index,t);return new Cu(r,r)}else if(e.type&175){let r=t[Do];return new Cu(r,t)}return null}var wA=class{constructor(){}supports(t){return rA(t)}create(t){return new bA(t)}},qQ=(e,t)=>t,bA=class{length=0;collection;_linkedRecords=null;_unlinkedRecords=null;_previousItHead=null;_itHead=null;_itTail=null;_additionsHead=null;_additionsTail=null;_movesHead=null;_movesTail=null;_removalsHead=null;_removalsTail=null;_identityChangesHead=null;_identityChangesTail=null;_trackByFn;constructor(t){this._trackByFn=t||qQ}forEachItem(t){let i;for(i=this._itHead;i!==null;i=i._next)t(i)}forEachOperation(t){let i=this._itHead,r=this._removalsHead,n=0,s=null;for(;i||r;){let o=!r||i&&i.currentIndex<pj(r,n,s)?i:r,a=pj(o,n,s),l=o.currentIndex;if(o===r)n--,r=r._nextRemoved;else if(i=i._next,o.previousIndex==null)n++;else{s||(s=[]);let c=a-n,h=l-n;if(c!=h){for(let m=0;m<c;m++){let f=m<s.length?s[m]:s[m]=0,g=f+m;h<=g&&g<c&&(s[m]=f+1)}let p=o.previousIndex;s[p]=h-c}}a!==l&&t(o,a,l)}}forEachPreviousItem(t){let i;for(i=this._previousItHead;i!==null;i=i._nextPrevious)t(i)}forEachAddedItem(t){let i;for(i=this._additionsHead;i!==null;i=i._nextAdded)t(i)}forEachMovedItem(t){let i;for(i=this._movesHead;i!==null;i=i._nextMoved)t(i)}forEachRemovedItem(t){let i;for(i=this._removalsHead;i!==null;i=i._nextRemoved)t(i)}forEachIdentityChange(t){let i;for(i=this._identityChangesHead;i!==null;i=i._nextIdentityChange)t(i)}diff(t){if(t==null&&(t=[]),!rA(t))throw new ct(900,!1);return this.check(t)?this:null}onDestroy(){}check(t){this._reset();let i=this._itHead,r=!1,n,s,o;if(Array.isArray(t)){this.length=t.length;for(let a=0;a<this.length;a++)s=t[a],o=this._trackByFn(a,s),i===null||!Object.is(i.trackById,o)?(i=this._mismatch(i,s,o,a),r=!0):(r&&(i=this._verifyReinsertion(i,s,o,a)),Object.is(i.item,s)||this._addIdentityChange(i,s)),i=i._next}else n=0,z5(t,a=>{o=this._trackByFn(n,a),i===null||!Object.is(i.trackById,o)?(i=this._mismatch(i,a,o,n),r=!0):(r&&(i=this._verifyReinsertion(i,a,o,n)),Object.is(i.item,a)||this._addIdentityChange(i,a)),i=i._next,n++}),this.length=n;return this._truncate(i),this.collection=t,this.isDirty}get isDirty(){return this._additionsHead!==null||this._movesHead!==null||this._removalsHead!==null||this._identityChangesHead!==null}_reset(){if(this.isDirty){let t;for(t=this._previousItHead=this._itHead;t!==null;t=t._next)t._nextPrevious=t._next;for(t=this._additionsHead;t!==null;t=t._nextAdded)t.previousIndex=t.currentIndex;for(this._additionsHead=this._additionsTail=null,t=this._movesHead;t!==null;t=t._nextMoved)t.previousIndex=t.currentIndex;this._movesHead=this._movesTail=null,this._removalsHead=this._removalsTail=null,this._identityChangesHead=this._identityChangesTail=null}}_mismatch(t,i,r,n){let s;return t===null?s=this._itTail:(s=t._prev,this._remove(t)),t=this._unlinkedRecords===null?null:this._unlinkedRecords.get(r,null),t!==null?(Object.is(t.item,i)||this._addIdentityChange(t,i),this._reinsertAfter(t,s,n)):(t=this._linkedRecords===null?null:this._linkedRecords.get(r,n),t!==null?(Object.is(t.item,i)||this._addIdentityChange(t,i),this._moveAfter(t,s,n)):t=this._addAfter(new CA(i,r),s,n)),t}_verifyReinsertion(t,i,r,n){let s=this._unlinkedRecords===null?null:this._unlinkedRecords.get(r,null);return s!==null?t=this._reinsertAfter(s,t._prev,n):t.currentIndex!=n&&(t.currentIndex=n,this._addToMoves(t,n)),t}_truncate(t){for(;t!==null;){let i=t._next;this._addToRemovals(this._unlink(t)),t=i}this._unlinkedRecords!==null&&this._unlinkedRecords.clear(),this._additionsTail!==null&&(this._additionsTail._nextAdded=null),this._movesTail!==null&&(this._movesTail._nextMoved=null),this._itTail!==null&&(this._itTail._next=null),this._removalsTail!==null&&(this._removalsTail._nextRemoved=null),this._identityChangesTail!==null&&(this._identityChangesTail._nextIdentityChange=null)}_reinsertAfter(t,i,r){this._unlinkedRecords!==null&&this._unlinkedRecords.remove(t);let n=t._prevRemoved,s=t._nextRemoved;return n===null?this._removalsHead=s:n._nextRemoved=s,s===null?this._removalsTail=n:s._prevRemoved=n,this._insertAfter(t,i,r),this._addToMoves(t,r),t}_moveAfter(t,i,r){return this._unlink(t),this._insertAfter(t,i,r),this._addToMoves(t,r),t}_addAfter(t,i,r){return this._insertAfter(t,i,r),this._additionsTail===null?this._additionsTail=this._additionsHead=t:this._additionsTail=this._additionsTail._nextAdded=t,t}_insertAfter(t,i,r){let n=i===null?this._itHead:i._next;return t._next=n,t._prev=i,n===null?this._itTail=t:n._prev=t,i===null?this._itHead=t:i._next=t,this._linkedRecords===null&&(this._linkedRecords=new bC),this._linkedRecords.put(t),t.currentIndex=r,t}_remove(t){return this._addToRemovals(this._unlink(t))}_unlink(t){this._linkedRecords!==null&&this._linkedRecords.remove(t);let i=t._prev,r=t._next;return i===null?this._itHead=r:i._next=r,r===null?this._itTail=i:r._prev=i,t}_addToMoves(t,i){return t.previousIndex===i||(this._movesTail===null?this._movesTail=this._movesHead=t:this._movesTail=this._movesTail._nextMoved=t),t}_addToRemovals(t){return this._unlinkedRecords===null&&(this._unlinkedRecords=new bC),this._unlinkedRecords.put(t),t.currentIndex=null,t._nextRemoved=null,this._removalsTail===null?(this._removalsTail=this._removalsHead=t,t._prevRemoved=null):(t._prevRemoved=this._removalsTail,this._removalsTail=this._removalsTail._nextRemoved=t),t}_addIdentityChange(t,i){return t.item=i,this._identityChangesTail===null?this._identityChangesTail=this._identityChangesHead=t:this._identityChangesTail=this._identityChangesTail._nextIdentityChange=t,t}},CA=class{item;trackById;currentIndex=null;previousIndex=null;_nextPrevious=null;_prev=null;_next=null;_prevDup=null;_nextDup=null;_prevRemoved=null;_nextRemoved=null;_nextAdded=null;_nextMoved=null;_nextIdentityChange=null;constructor(t,i){this.item=t,this.trackById=i}},TA=class{_head=null;_tail=null;add(t){this._head===null?(this._head=this._tail=t,t._nextDup=null,t._prevDup=null):(this._tail._nextDup=t,t._prevDup=this._tail,t._nextDup=null,this._tail=t)}get(t,i){let r;for(r=this._head;r!==null;r=r._nextDup)if((i===null||i<=r.currentIndex)&&Object.is(r.trackById,t))return r;return null}remove(t){let i=t._prevDup,r=t._nextDup;return i===null?this._head=r:i._nextDup=r,r===null?this._tail=i:r._prevDup=i,this._head===null}},bC=class{map=new Map;put(t){let i=t.trackById,r=this.map.get(i);r||(r=new TA,this.map.set(i,r)),r.add(t)}get(t,i){let r=t,n=this.map.get(r);return n?n.get(t,i):null}remove(t){let i=t.trackById;return this.map.get(i).remove(t)&&this.map.delete(i),t}get isEmpty(){return this.map.size===0}clear(){this.map.clear()}};function pj(e,t,i){let r=e.previousIndex;if(r===null)return r;let n=0;return i&&r<i.length&&(n=i[r]),r+t+n}function mj(){return new EA([new wA])}var EA=(()=>{class e{factories;static \u0275prov=Zt({token:e,providedIn:"root",factory:mj});constructor(i){this.factories=i}static create(i,r){if(r!=null){let n=r.factories.slice();i=i.concat(n)}return new e(i)}static extend(i){return{provide:e,useFactory:r=>e.create(i,r||mj()),deps:[[e,new kU,new FU]]}}find(i){let r=this.factories.find(n=>n.supports(i));if(r!=null)return r;throw new ct(901,!1)}}return e})();function fj(e){Ii(8);try{let{rootComponent:t,appProviders:i,platformProviders:r}=e,n=UQ(r),s=[uj({}),{provide:Jl,useExisting:gA},rU,...i||[]],o=new O_({providers:s,parent:n,debugName:"",runEnvironmentInitializers:!1});return kQ({r3Injector:o.injector,platformInjector:n,rootComponent:t})}catch(t){return Promise.reject(t)}finally{Ii(9)}}function DA(e){return typeof e=="boolean"?e:e!=null&&e!=="false"}var gj=null;function Eu(){return gj}function xA(e){gj??=e}var q_=class{};var CC=class{$implicit;ngForOf;index;count;constructor(t,i,r,n){this.$implicit=t,this.ngForOf=i,this.index=r,this.count=n}get first(){return this.index===0}get last(){return this.index===this.count-1}get even(){return this.index%2===0}get odd(){return!this.even}},TC=(()=>{class e{_viewContainer;_template;_differs;set ngForOf(i){this._ngForOf=i,this._ngForOfDirty=!0}set ngForTrackBy(i){this._trackByFn=i}get ngForTrackBy(){return this._trackByFn}_ngForOf=null;_ngForOfDirty=!0;_differ=null;_trackByFn;constructor(i,r,n){this._viewContainer=i,this._template=r,this._differs=n}set ngForTemplate(i){i&&(this._template=i)}ngDoCheck(){if(this._ngForOfDirty){this._ngForOfDirty=!1;let i=this._ngForOf;!this._differ&&i&&(this._differ=this._differs.find(i).create(this.ngForTrackBy))}if(this._differ){let i=this._differ.diff(this._ngForOf);i&&this._applyChanges(i)}}_applyChanges(i){let r=this._viewContainer;i.forEachOperation((n,s,o)=>{if(n.previousIndex==null)r.createEmbeddedView(this._template,new CC(n.item,this._ngForOf,-1,-1),o===null?void 0:o);else if(o==null)r.remove(s===null?void 0:s);else if(s!==null){let a=r.get(s);r.move(a,o),_j(a,n)}});for(let n=0,s=r.length;n<s;n++){let a=r.get(n).context;a.index=n,a.count=s,a.ngForOf=this._ngForOf}i.forEachIdentityChange(n=>{let s=r.get(n.currentIndex);_j(s,n)})}static ngTemplateContextGuard(i,r){return!0}static \u0275fac=function(r){return new(r||e)(It(Hm),It(ph),It(EA))};static \u0275dir=gs({type:e,selectors:[["","ngFor","","ngForOf",""]],inputs:{ngForOf:"ngForOf",ngForTrackBy:"ngForTrackBy",ngForTemplate:"ngForTemplate"}})}return e})();function _j(e,t){e.context.$implicit=t.item}var $m=(()=>{class e{static \u0275fac=function(r){return new(r||e)};static \u0275mod=Tu({type:e});static \u0275inj=tc({})}return e})();function W_(e,t){t=encodeURIComponent(t);for(let i of e.split(";")){let r=i.indexOf("="),[n,s]=r==-1?[i,""]:[i.slice(0,r),i.slice(r+1)];if(n.trim()===t)return decodeURIComponent(s)}return null}var wh=class{};var yj="browser",WQ="server";function vj(e){return e===WQ}var xC=new ht(""),AA=(()=>{class e{_zone;_plugins;_eventNameToPlugin=new Map;constructor(i,r){this._zone=r,i.forEach(n=>{n.manager=this}),this._plugins=i.slice().reverse()}addEventListener(i,r,n,s){return this._findPluginFor(r).addEventListener(i,r,n,s)}getZone(){return this._zone}_findPluginFor(i){let r=this._eventNameToPlugin.get(i);if(r)return r;if(r=this._plugins.find(s=>s.supports(i)),!r)throw new ct(5101,!1);return this._eventNameToPlugin.set(i,r),r}static \u0275fac=function(r){return new(r||e)(Bt(xC),Bt(Or))};static \u0275prov=Zt({token:e,factory:e.\u0275fac})}return e})(),$_=class{_doc;constructor(t){this._doc=t}manager},EC="ng-app-id";function wj(e){for(let t of e)t.remove()}function bj(e,t){let i=t.createElement("style");return i.textContent=e,i}function ZQ(e,t,i,r){let n=e.head?.querySelectorAll(`style[${EC}="${t}"],link[${EC}="${t}"]`);if(n)for(let s of n)s.removeAttribute(EC),s instanceof HTMLLinkElement?r.set(s.href.slice(s.href.lastIndexOf("/")+1),{usage:0,elements:[s]}):s.textContent&&i.set(s.textContent,{usage:0,elements:[s]})}function SA(e,t){let i=t.createElement("link");return i.setAttribute("rel","stylesheet"),i.setAttribute("href",e),i}var RA=(()=>{class e{doc;appId;nonce;inline=new Map;external=new Map;hosts=new Set;isServer;constructor(i,r,n,s={}){this.doc=i,this.appId=r,this.nonce=n,this.isServer=vj(s),ZQ(i,r,this.inline,this.external),this.hosts.add(i.head)}addStyles(i,r){for(let n of i)this.addUsage(n,this.inline,bj);r?.forEach(n=>this.addUsage(n,this.external,SA))}removeStyles(i,r){for(let n of i)this.removeUsage(n,this.inline);r?.forEach(n=>this.removeUsage(n,this.external))}addUsage(i,r,n){let s=r.get(i);s?s.usage++:r.set(i,{usage:1,elements:[...this.hosts].map(o=>this.addElement(o,n(i,this.doc)))})}removeUsage(i,r){let n=r.get(i);n&&(n.usage--,n.usage<=0&&(wj(n.elements),r.delete(i)))}ngOnDestroy(){for(let[,{elements:i}]of[...this.inline,...this.external])wj(i);this.hosts.clear()}addHost(i){this.hosts.add(i);for(let[r,{elements:n}]of this.inline)n.push(this.addElement(i,bj(r,this.doc)));for(let[r,{elements:n}]of this.external)n.push(this.addElement(i,SA(r,this.doc)))}removeHost(i){this.hosts.delete(i)}addElement(i,r){return this.nonce&&r.setAttribute("nonce",this.nonce),this.isServer&&r.setAttribute(EC,this.appId),i.appendChild(r)}static \u0275fac=function(r){return new(r||e)(Bt(fs),Bt(dC),Bt(pC,8),Bt(km))};static \u0275prov=Zt({token:e,factory:e.\u0275fac})}return e})(),MA={svg:"http://www.w3.org/2000/svg",xhtml:"http://www.w3.org/1999/xhtml",xlink:"http://www.w3.org/1999/xlink",xml:"http://www.w3.org/XML/1998/namespace",xmlns:"http://www.w3.org/2000/xmlns/",math:"http://www.w3.org/1998/Math/MathML"},PA=/%COMP%/g;var Tj="%COMP%",QQ=`_nghost-${Tj}`,YQ=`_ngcontent-${Tj}`,KQ=!0,XQ=new ht("",{providedIn:"root",factory:()=>KQ});function JQ(e){return YQ.replace(PA,e)}function eY(e){return QQ.replace(PA,e)}function Ej(e,t){return t.map(i=>i.replace(PA,e))}var OA=(()=>{class e{eventManager;sharedStylesHost;appId;removeStylesOnCompDestroy;doc;platformId;ngZone;nonce;tracingService;rendererByCompId=new Map;defaultRenderer;platformIsServer;constructor(i,r,n,s,o,a,l,c=null,h=null){this.eventManager=i,this.sharedStylesHost=r,this.appId=n,this.removeStylesOnCompDestroy=s,this.doc=o,this.platformId=a,this.ngZone=l,this.nonce=c,this.tracingService=h,this.platformIsServer=!1,this.defaultRenderer=new Z_(i,o,l,this.platformIsServer,this.tracingService)}createRenderer(i,r){if(!i||!r)return this.defaultRenderer;let n=this.getOrCreateRenderer(i,r);return n instanceof DC?n.applyToHost(i):n instanceof Q_&&n.applyStyles(),n}getOrCreateRenderer(i,r){let n=this.rendererByCompId,s=n.get(r.id);if(!s){let o=this.doc,a=this.ngZone,l=this.eventManager,c=this.sharedStylesHost,h=this.removeStylesOnCompDestroy,p=this.platformIsServer,m=this.tracingService;switch(r.encapsulation){case rc.Emulated:s=new DC(l,c,r,this.appId,h,o,a,p,m);break;case rc.ShadowDom:return new IA(l,c,i,r,o,a,this.nonce,p,m);default:s=new Q_(l,c,r,h,o,a,p,m);break}n.set(r.id,s)}return s}ngOnDestroy(){this.rendererByCompId.clear()}componentReplaced(i){this.rendererByCompId.delete(i)}static \u0275fac=function(r){return new(r||e)(Bt(AA),Bt(RA),Bt(dC),Bt(XQ),Bt(fs),Bt(km),Bt(Or),Bt(pC),Bt(V_,8))};static \u0275prov=Zt({token:e,factory:e.\u0275fac})}return e})(),Z_=class{eventManager;doc;ngZone;platformIsServer;tracingService;data=Object.create(null);throwOnSyntheticProps=!0;constructor(t,i,r,n,s){this.eventManager=t,this.doc=i,this.ngZone=r,this.platformIsServer=n,this.tracingService=s}destroy(){}destroyNode=null;createElement(t,i){return i?this.doc.createElementNS(MA[i]||i,t):this.doc.createElement(t)}createComment(t){return this.doc.createComment(t)}createText(t){return this.doc.createTextNode(t)}appendChild(t,i){(Cj(t)?t.content:t).appendChild(i)}insertBefore(t,i,r){t&&(Cj(t)?t.content:t).insertBefore(i,r)}removeChild(t,i){i.remove()}selectRootElement(t,i){let r=typeof t=="string"?this.doc.querySelector(t):t;if(!r)throw new ct(-5104,!1);return i||(r.textContent=""),r}parentNode(t){return t.parentNode}nextSibling(t){return t.nextSibling}setAttribute(t,i,r,n){if(n){i=n+":"+i;let s=MA[n];s?t.setAttributeNS(s,i,r):t.setAttribute(i,r)}else t.setAttribute(i,r)}removeAttribute(t,i,r){if(r){let n=MA[r];n?t.removeAttributeNS(n,i):t.removeAttribute(`${r}:${i}`)}else t.removeAttribute(i)}addClass(t,i){t.classList.add(i)}removeClass(t,i){t.classList.remove(i)}setStyle(t,i,r,n){n&(nc.DashCase|nc.Important)?t.style.setProperty(i,r,n&nc.Important?"important":""):t.style[i]=r}removeStyle(t,i,r){r&nc.DashCase?t.style.removeProperty(i):t.style[i]=""}setProperty(t,i,r){t!=null&&(t[i]=r)}setValue(t,i){t.nodeValue=i}listen(t,i,r,n){if(typeof t=="string"&&(t=Eu().getGlobalEventTarget(this.doc,t),!t))throw new ct(5102,!1);let s=this.decoratePreventDefault(r);return this.tracingService?.wrapEventListener&&(s=this.tracingService.wrapEventListener(t,i,s)),this.eventManager.addEventListener(t,i,s,n)}decoratePreventDefault(t){return i=>{if(i==="__ngUnwrap__")return t;t(i)===!1&&i.preventDefault()}}};function Cj(e){return e.tagName==="TEMPLATE"&&e.content!==void 0}var IA=class extends Z_{sharedStylesHost;hostEl;shadowRoot;constructor(t,i,r,n,s,o,a,l,c){super(t,s,o,l,c),this.sharedStylesHost=i,this.hostEl=r,this.shadowRoot=r.attachShadow({mode:"open"}),this.sharedStylesHost.addHost(this.shadowRoot);let h=n.styles;h=Ej(n.id,h);for(let m of h){let f=document.createElement("style");a&&f.setAttribute("nonce",a),f.textContent=m,this.shadowRoot.appendChild(f)}let p=n.getExternalStyles?.();if(p)for(let m of p){let f=SA(m,s);a&&f.setAttribute("nonce",a),this.shadowRoot.appendChild(f)}}nodeOrShadowRoot(t){return t===this.hostEl?this.shadowRoot:t}appendChild(t,i){return super.appendChild(this.nodeOrShadowRoot(t),i)}insertBefore(t,i,r){return super.insertBefore(this.nodeOrShadowRoot(t),i,r)}removeChild(t,i){return super.removeChild(null,i)}parentNode(t){return this.nodeOrShadowRoot(super.parentNode(this.nodeOrShadowRoot(t)))}destroy(){this.sharedStylesHost.removeHost(this.shadowRoot)}},Q_=class extends Z_{sharedStylesHost;removeStylesOnCompDestroy;styles;styleUrls;constructor(t,i,r,n,s,o,a,l,c){super(t,s,o,a,l),this.sharedStylesHost=i,this.removeStylesOnCompDestroy=n;let h=r.styles;this.styles=c?Ej(c,h):h,this.styleUrls=r.getExternalStyles?.(c)}applyStyles(){this.sharedStylesHost.addStyles(this.styles,this.styleUrls)}destroy(){this.removeStylesOnCompDestroy&&this.sharedStylesHost.removeStyles(this.styles,this.styleUrls)}},DC=class extends Q_{contentAttr;hostAttr;constructor(t,i,r,n,s,o,a,l,c){let h=n+"-"+r.id;super(t,i,r,s,o,a,l,c,h),this.contentAttr=JQ(h),this.hostAttr=eY(h)}applyToHost(t){this.applyStyles(),this.setAttribute(t,this.hostAttr,"")}createElement(t,i){let r=super.createElement(t,i);return super.setAttribute(r,this.contentAttr,""),r}};var MC=class e extends q_{supportsDOMEvents=!0;static makeCurrent(){xA(new e)}onAndCancel(t,i,r,n){return t.addEventListener(i,r,n),()=>{t.removeEventListener(i,r,n)}}dispatchEvent(t,i){t.dispatchEvent(i)}remove(t){t.remove()}createElement(t,i){return i=i||this.getDefaultDocument(),i.createElement(t)}createHtmlDocument(){return document.implementation.createHTMLDocument("fakeTitle")}getDefaultDocument(){return document}isElementNode(t){return t.nodeType===Node.ELEMENT_NODE}isShadowRoot(t){return t instanceof DocumentFragment}getGlobalEventTarget(t,i){return i==="window"?window:i==="document"?t:i==="body"?t.body:null}getBaseHref(t){let i=tY();return i==null?null:iY(i)}resetBaseElement(){Y_=null}getUserAgent(){return window.navigator.userAgent}getCookie(t){return W_(document.cookie,t)}},Y_=null;function tY(){return Y_=Y_||document.head.querySelector("base"),Y_?Y_.getAttribute("href"):null}function iY(e){return new URL(e,document.baseURI).pathname}var rY=(()=>{class e{build(){return new XMLHttpRequest}static \u0275fac=function(r){return new(r||e)};static \u0275prov=Zt({token:e,factory:e.\u0275fac})}return e})(),xj=(()=>{class e extends $_{constructor(i){super(i)}supports(i){return!0}addEventListener(i,r,n,s){return i.addEventListener(r,n,s),()=>this.removeEventListener(i,r,n,s)}removeEventListener(i,r,n,s){return i.removeEventListener(r,n,s)}static \u0275fac=function(r){return new(r||e)(Bt(fs))};static \u0275prov=Zt({token:e,factory:e.\u0275fac})}return e})(),Dj=["alt","control","meta","shift"],nY={"\b":"Backspace","	":"Tab","\x7F":"Delete","\x1B":"Escape",Del:"Delete",Esc:"Escape",Left:"ArrowLeft",Right:"ArrowRight",Up:"ArrowUp",Down:"ArrowDown",Menu:"ContextMenu",Scroll:"ScrollLock",Win:"OS"},sY={alt:e=>e.altKey,control:e=>e.ctrlKey,meta:e=>e.metaKey,shift:e=>e.shiftKey},Mj=(()=>{class e extends $_{constructor(i){super(i)}supports(i){return e.parseEventName(i)!=null}addEventListener(i,r,n,s){let o=e.parseEventName(r),a=e.eventCallback(o.fullKey,n,this.manager.getZone());return this.manager.getZone().runOutsideAngular(()=>Eu().onAndCancel(i,o.domEventName,a,s))}static parseEventName(i){let r=i.toLowerCase().split("."),n=r.shift();if(r.length===0||!(n==="keydown"||n==="keyup"))return null;let s=e._normalizeKey(r.pop()),o="",a=r.indexOf("code");if(a>-1&&(r.splice(a,1),o="code."),Dj.forEach(c=>{let h=r.indexOf(c);h>-1&&(r.splice(h,1),o+=c+".")}),o+=s,r.length!=0||s.length===0)return null;let l={};return l.domEventName=n,l.fullKey=o,l}static matchEventFullKeyCode(i,r){let n=nY[i.key]||i.key,s="";return r.indexOf("code.")>-1&&(n=i.code,s="code."),n==null||!n?!1:(n=n.toLowerCase(),n===" "?n="space":n==="."&&(n="dot"),Dj.forEach(o=>{if(o!==n){let a=sY[o];a(i)&&(s+=o+".")}}),s+=n,s===r)}static eventCallback(i,r,n){return s=>{e.matchEventFullKeyCode(s,i)&&n.runGuarded(()=>r(s))}}static _normalizeKey(i){return i==="esc"?"escape":i}static \u0275fac=function(r){return new(r||e)(Bt(fs))};static \u0275prov=Zt({token:e,factory:e.\u0275fac})}return e})();function NA(e,t){return fj(ie({rootComponent:e},oY(t)))}function oY(e){return{appProviders:[...dY,...e?.providers??[]],platformProviders:uY}}function aY(){MC.makeCurrent()}function lY(){return new Ja}function cY(){return HI(document),document}var uY=[{provide:km,useValue:yj},{provide:hC,useValue:aY,multi:!0},{provide:fs,useFactory:cY}];var dY=[{provide:f_,useValue:"root"},{provide:Ja,useFactory:lY},{provide:xC,useClass:xj,multi:!0,deps:[fs]},{provide:xC,useClass:Mj,multi:!0,deps:[fs]},OA,RA,AA,{provide:mh,useExisting:OA},{provide:wh,useClass:rY},[]];var Qm=class{},K_=class{},Du=class e{headers;normalizedNames=new Map;lazyInit;lazyUpdate=null;constructor(t){t?typeof t=="string"?this.lazyInit=()=>{this.headers=new Map,t.split(`
`).forEach(i=>{let r=i.indexOf(":");if(r>0){let n=i.slice(0,r),s=i.slice(r+1).trim();this.addHeaderEntry(n,s)}})}:typeof Headers<"u"&&t instanceof Headers?(this.headers=new Map,t.forEach((i,r)=>{this.addHeaderEntry(r,i)})):this.lazyInit=()=>{this.headers=new Map,Object.entries(t).forEach(([i,r])=>{this.setHeaderEntries(i,r)})}:this.headers=new Map}has(t){return this.init(),this.headers.has(t.toLowerCase())}get(t){this.init();let i=this.headers.get(t.toLowerCase());return i&&i.length>0?i[0]:null}keys(){return this.init(),Array.from(this.normalizedNames.values())}getAll(t){return this.init(),this.headers.get(t.toLowerCase())||null}append(t,i){return this.clone({name:t,value:i,op:"a"})}set(t,i){return this.clone({name:t,value:i,op:"s"})}delete(t,i){return this.clone({name:t,value:i,op:"d"})}maybeSetNormalizedName(t,i){this.normalizedNames.has(i)||this.normalizedNames.set(i,t)}init(){this.lazyInit&&(this.lazyInit instanceof e?this.copyFrom(this.lazyInit):this.lazyInit(),this.lazyInit=null,this.lazyUpdate&&(this.lazyUpdate.forEach(t=>this.applyUpdate(t)),this.lazyUpdate=null))}copyFrom(t){t.init(),Array.from(t.headers.keys()).forEach(i=>{this.headers.set(i,t.headers.get(i)),this.normalizedNames.set(i,t.normalizedNames.get(i))})}clone(t){let i=new e;return i.lazyInit=this.lazyInit&&this.lazyInit instanceof e?this.lazyInit:this,i.lazyUpdate=(this.lazyUpdate||[]).concat([t]),i}applyUpdate(t){let i=t.name.toLowerCase();switch(t.op){case"a":case"s":let r=t.value;if(typeof r=="string"&&(r=[r]),r.length===0)return;this.maybeSetNormalizedName(t.name,i);let n=(t.op==="a"?this.headers.get(i):void 0)||[];n.push(...r),this.headers.set(i,n);break;case"d":let s=t.value;if(!s)this.headers.delete(i),this.normalizedNames.delete(i);else{let o=this.headers.get(i);if(!o)return;o=o.filter(a=>s.indexOf(a)===-1),o.length===0?(this.headers.delete(i),this.normalizedNames.delete(i)):this.headers.set(i,o)}break}}addHeaderEntry(t,i){let r=t.toLowerCase();this.maybeSetNormalizedName(t,r),this.headers.has(r)?this.headers.get(r).push(i):this.headers.set(r,[i])}setHeaderEntries(t,i){let r=(Array.isArray(i)?i:[i]).map(s=>s.toString()),n=t.toLowerCase();this.headers.set(n,r),this.maybeSetNormalizedName(t,n)}forEach(t){this.init(),Array.from(this.normalizedNames.keys()).forEach(i=>t(this.normalizedNames.get(i),this.headers.get(i)))}};var IC=class{encodeKey(t){return Sj(t)}encodeValue(t){return Sj(t)}decodeKey(t){return decodeURIComponent(t)}decodeValue(t){return decodeURIComponent(t)}};function hY(e,t){let i=new Map;return e.length>0&&e.replace(/^\?/,"").split("&").forEach(n=>{let s=n.indexOf("="),[o,a]=s==-1?[t.decodeKey(n),""]:[t.decodeKey(n.slice(0,s)),t.decodeValue(n.slice(s+1))],l=i.get(o)||[];l.push(a),i.set(o,l)}),i}var pY=/%(\d[a-f0-9])/gi,mY={40:"@","3A":":",24:"$","2C":",","3B":";","3D":"=","3F":"?","2F":"/"};function Sj(e){return encodeURIComponent(e).replace(pY,(t,i)=>mY[i]??t)}function SC(e){return`${e}`}var uc=class e{map;encoder;updates=null;cloneFrom=null;constructor(t={}){if(this.encoder=t.encoder||new IC,t.fromString){if(t.fromObject)throw new ct(2805,!1);this.map=hY(t.fromString,this.encoder)}else t.fromObject?(this.map=new Map,Object.keys(t.fromObject).forEach(i=>{let r=t.fromObject[i],n=Array.isArray(r)?r.map(SC):[SC(r)];this.map.set(i,n)})):this.map=null}has(t){return this.init(),this.map.has(t)}get(t){this.init();let i=this.map.get(t);return i?i[0]:null}getAll(t){return this.init(),this.map.get(t)||null}keys(){return this.init(),Array.from(this.map.keys())}append(t,i){return this.clone({param:t,value:i,op:"a"})}appendAll(t){let i=[];return Object.keys(t).forEach(r=>{let n=t[r];Array.isArray(n)?n.forEach(s=>{i.push({param:r,value:s,op:"a"})}):i.push({param:r,value:n,op:"a"})}),this.clone(i)}set(t,i){return this.clone({param:t,value:i,op:"s"})}delete(t,i){return this.clone({param:t,value:i,op:"d"})}toString(){return this.init(),this.keys().map(t=>{let i=this.encoder.encodeKey(t);return this.map.get(t).map(r=>i+"="+this.encoder.encodeValue(r)).join("&")}).filter(t=>t!=="").join("&")}clone(t){let i=new e({encoder:this.encoder});return i.cloneFrom=this.cloneFrom||this,i.updates=(this.updates||[]).concat(t),i}init(){this.map===null&&(this.map=new Map),this.cloneFrom!==null&&(this.cloneFrom.init(),this.cloneFrom.keys().forEach(t=>this.map.set(t,this.cloneFrom.map.get(t))),this.updates.forEach(t=>{switch(t.op){case"a":case"s":let i=(t.op==="a"?this.map.get(t.param):void 0)||[];i.push(SC(t.value)),this.map.set(t.param,i);break;case"d":if(t.value!==void 0){let r=this.map.get(t.param)||[],n=r.indexOf(SC(t.value));n!==-1&&r.splice(n,1),r.length>0?this.map.set(t.param,r):this.map.delete(t.param)}else{this.map.delete(t.param);break}}}),this.cloneFrom=this.updates=null)}};var AC=class{map=new Map;set(t,i){return this.map.set(t,i),this}get(t){return this.map.has(t)||this.map.set(t,t.defaultValue()),this.map.get(t)}delete(t){return this.map.delete(t),this}has(t){return this.map.has(t)}keys(){return this.map.keys()}};function fY(e){switch(e){case"DELETE":case"GET":case"HEAD":case"OPTIONS":case"JSONP":return!1;default:return!0}}function Ij(e){return typeof ArrayBuffer<"u"&&e instanceof ArrayBuffer}function Aj(e){return typeof Blob<"u"&&e instanceof Blob}function Rj(e){return typeof FormData<"u"&&e instanceof FormData}function gY(e){return typeof URLSearchParams<"u"&&e instanceof URLSearchParams}var Pj="Content-Type",Oj="Accept",Nj="X-Request-URL",Lj="text/plain",Fj="application/json",_Y=`${Fj}, ${Lj}, */*`,Zm=class e{url;body=null;headers;context;reportProgress=!1;withCredentials=!1;keepalive=!1;responseType="json";method;params;urlWithParams;transferCache;constructor(t,i,r,n){this.url=i,this.method=t.toUpperCase();let s;if(fY(this.method)||n?(this.body=r!==void 0?r:null,s=n):s=r,s&&(this.reportProgress=!!s.reportProgress,this.withCredentials=!!s.withCredentials,this.keepalive=!!s.keepalive,s.responseType&&(this.responseType=s.responseType),s.headers&&(this.headers=s.headers),s.context&&(this.context=s.context),s.params&&(this.params=s.params),this.transferCache=s.transferCache),this.headers??=new Du,this.context??=new AC,!this.params)this.params=new uc,this.urlWithParams=i;else{let o=this.params.toString();if(o.length===0)this.urlWithParams=i;else{let a=i.indexOf("?"),l=a===-1?"?":a<i.length-1?"&":"";this.urlWithParams=i+l+o}}}serializeBody(){return this.body===null?null:typeof this.body=="string"||Ij(this.body)||Aj(this.body)||Rj(this.body)||gY(this.body)?this.body:this.body instanceof uc?this.body.toString():typeof this.body=="object"||typeof this.body=="boolean"||Array.isArray(this.body)?JSON.stringify(this.body):this.body.toString()}detectContentTypeHeader(){return this.body===null||Rj(this.body)?null:Aj(this.body)?this.body.type||null:Ij(this.body)?null:typeof this.body=="string"?Lj:this.body instanceof uc?"application/x-www-form-urlencoded;charset=UTF-8":typeof this.body=="object"||typeof this.body=="number"||typeof this.body=="boolean"?Fj:null}clone(t={}){let i=t.method||this.method,r=t.url||this.url,n=t.responseType||this.responseType,s=t.keepalive??this.keepalive,o=t.transferCache??this.transferCache,a=t.body!==void 0?t.body:this.body,l=t.withCredentials??this.withCredentials,c=t.reportProgress??this.reportProgress,h=t.headers||this.headers,p=t.params||this.params,m=t.context??this.context;return t.setHeaders!==void 0&&(h=Object.keys(t.setHeaders).reduce((f,g)=>f.set(g,t.setHeaders[g]),h)),t.setParams&&(p=Object.keys(t.setParams).reduce((f,g)=>f.set(g,t.setParams[g]),p)),new e(i,r,a,{params:p,headers:h,context:m,reportProgress:c,responseType:n,withCredentials:l,transferCache:o,keepalive:s})}},bh=function(e){return e[e.Sent=0]="Sent",e[e.UploadProgress=1]="UploadProgress",e[e.ResponseHeader=2]="ResponseHeader",e[e.DownloadProgress=3]="DownloadProgress",e[e.Response=4]="Response",e[e.User=5]="User",e}(bh||{}),Ym=class{headers;status;statusText;url;ok;type;constructor(t,i=200,r="OK"){this.headers=t.headers||new Du,this.status=t.status!==void 0?t.status:i,this.statusText=t.statusText||r,this.url=t.url||null,this.ok=this.status>=200&&this.status<300}},RC=class e extends Ym{constructor(t={}){super(t)}type=bh.ResponseHeader;clone(t={}){return new e({headers:t.headers||this.headers,status:t.status!==void 0?t.status:this.status,statusText:t.statusText||this.statusText,url:t.url||this.url||void 0})}},X_=class e extends Ym{body;constructor(t={}){super(t),this.body=t.body!==void 0?t.body:null}type=bh.Response;clone(t={}){return new e({body:t.body!==void 0?t.body:this.body,headers:t.headers||this.headers,status:t.status!==void 0?t.status:this.status,statusText:t.statusText||this.statusText,url:t.url||this.url||void 0})}},J_=class extends Ym{name="HttpErrorResponse";message;error;ok=!1;constructor(t){super(t,0,"Unknown Error"),this.status>=200&&this.status<300?this.message=`Http failure during parsing for ${t.url||"(unknown url)"}`:this.message=`Http failure response for ${t.url||"(unknown url)"}: ${t.status} ${t.statusText}`,this.error=t.error||null}},yY=200,vY=204;function LA(e,t){return{body:t,headers:e.headers,context:e.context,observe:e.observe,params:e.params,reportProgress:e.reportProgress,responseType:e.responseType,withCredentials:e.withCredentials,transferCache:e.transferCache,keepalive:e.keepalive}}var OC=(()=>{class e{handler;constructor(i){this.handler=i}request(i,r,n={}){let s;if(i instanceof Zm)s=i;else{let l;n.headers instanceof Du?l=n.headers:l=new Du(n.headers);let c;n.params&&(n.params instanceof uc?c=n.params:c=new uc({fromObject:n.params})),s=new Zm(i,r,n.body!==void 0?n.body:null,{headers:l,context:n.context,params:c,reportProgress:n.reportProgress,responseType:n.responseType||"json",withCredentials:n.withCredentials,transferCache:n.transferCache,keepalive:n.keepalive})}let o=bb(s).pipe(XM(l=>this.handler.handle(l)));if(i instanceof Zm||n.observe==="events")return o;let a=o.pipe(KM(l=>l instanceof X_));switch(n.observe||"body"){case"body":switch(s.responseType){case"arraybuffer":return a.pipe(hs(l=>{if(l.body!==null&&!(l.body instanceof ArrayBuffer))throw new ct(2806,!1);return l.body}));case"blob":return a.pipe(hs(l=>{if(l.body!==null&&!(l.body instanceof Blob))throw new ct(2807,!1);return l.body}));case"text":return a.pipe(hs(l=>{if(l.body!==null&&typeof l.body!="string")throw new ct(2808,!1);return l.body}));case"json":default:return a.pipe(hs(l=>l.body))}case"response":return a;default:throw new ct(2809,!1)}}delete(i,r={}){return this.request("DELETE",i,r)}get(i,r={}){return this.request("GET",i,r)}head(i,r={}){return this.request("HEAD",i,r)}jsonp(i,r){return this.request("JSONP",i,{params:new uc().append(r,"JSONP_CALLBACK"),observe:"body",responseType:"json"})}options(i,r={}){return this.request("OPTIONS",i,r)}patch(i,r,n={}){return this.request("PATCH",i,LA(n,r))}post(i,r,n={}){return this.request("POST",i,LA(n,r))}put(i,r,n={}){return this.request("PUT",i,LA(n,r))}static \u0275fac=function(r){return new(r||e)(Bt(Qm))};static \u0275prov=Zt({token:e,factory:e.\u0275fac})}return e})();var wY=new ht("");function bY(e,t){return t(e)}function CY(e,t,i){return(r,n)=>Tm(i,()=>t(r,s=>e(s,n)))}var kj=new ht(""),Vj=new ht(""),Hj=new ht("",{providedIn:"root",factory:()=>!0});var PC=(()=>{class e extends Qm{backend;injector;chain=null;pendingTasks=ot(Wb);contributeToStability=ot(Hj);constructor(i,r){super(),this.backend=i,this.injector=r}handle(i){if(this.chain===null){let r=Array.from(new Set([...this.injector.get(kj),...this.injector.get(Vj,[])]));this.chain=r.reduceRight((n,s)=>CY(n,s,this.injector),bY)}if(this.contributeToStability){let r=this.pendingTasks.add();return this.chain(i,n=>this.backend.handle(n)).pipe(JM(r))}else return this.chain(i,r=>this.backend.handle(r))}static \u0275fac=function(r){return new(r||e)(Bt(K_),Bt(ps))};static \u0275prov=Zt({token:e,factory:e.\u0275fac})}return e})();var TY=/^\)\]\}',?\n/,EY=RegExp(`^${Nj}:`,"m");function DY(e){return"responseURL"in e&&e.responseURL?e.responseURL:EY.test(e.getAllResponseHeaders())?e.getResponseHeader(Nj):null}var FA=(()=>{class e{xhrFactory;constructor(i){this.xhrFactory=i}handle(i){if(i.method==="JSONP")throw new ct(-2800,!1);i.keepalive;let r=this.xhrFactory;return(r.\u0275loadImpl?$d(r.\u0275loadImpl()):bb(null)).pipe(eS(()=>new Xi(s=>{let o=r.build();if(o.open(i.method,i.urlWithParams),i.withCredentials&&(o.withCredentials=!0),i.headers.forEach((_,v)=>o.setRequestHeader(_,v.join(","))),i.headers.has(Oj)||o.setRequestHeader(Oj,_Y),!i.headers.has(Pj)){let _=i.detectContentTypeHeader();_!==null&&o.setRequestHeader(Pj,_)}if(i.responseType){let _=i.responseType.toLowerCase();o.responseType=_!=="json"?_:"text"}let a=i.serializeBody(),l=null,c=()=>{if(l!==null)return l;let _=o.statusText||"OK",v=new Du(o.getAllResponseHeaders()),b=DY(o)||i.url;return l=new RC({headers:v,status:o.status,statusText:_,url:b}),l},h=()=>{let{headers:_,status:v,statusText:b,url:x}=c(),E=null;v!==vY&&(E=typeof o.response>"u"?o.responseText:o.response),v===0&&(v=E?yY:0);let D=v>=200&&v<300;if(i.responseType==="json"&&typeof E=="string"){let M=E;E=E.replace(TY,"");try{E=E!==""?JSON.parse(E):null}catch(T){E=M,D&&(D=!1,E={error:T,text:E})}}D?(s.next(new X_({body:E,headers:_,status:v,statusText:b,url:x||void 0})),s.complete()):s.error(new J_({error:E,headers:_,status:v,statusText:b,url:x||void 0}))},p=_=>{let{url:v}=c(),b=new J_({error:_,status:o.status||0,statusText:o.statusText||"Unknown Error",url:v||void 0});s.error(b)},m=!1,f=_=>{m||(s.next(c()),m=!0);let v={type:bh.DownloadProgress,loaded:_.loaded};_.lengthComputable&&(v.total=_.total),i.responseType==="text"&&o.responseText&&(v.partialText=o.responseText),s.next(v)},g=_=>{let v={type:bh.UploadProgress,loaded:_.loaded};_.lengthComputable&&(v.total=_.total),s.next(v)};return o.addEventListener("load",h),o.addEventListener("error",p),o.addEventListener("timeout",p),o.addEventListener("abort",p),i.reportProgress&&(o.addEventListener("progress",f),a!==null&&o.upload&&o.upload.addEventListener("progress",g)),o.send(a),s.next({type:bh.Sent}),()=>{o.removeEventListener("error",p),o.removeEventListener("abort",p),o.removeEventListener("load",h),o.removeEventListener("timeout",p),i.reportProgress&&(o.removeEventListener("progress",f),a!==null&&o.upload&&o.upload.removeEventListener("progress",g)),o.readyState!==o.DONE&&o.abort()}})))}static \u0275fac=function(r){return new(r||e)(Bt(wh))};static \u0275prov=Zt({token:e,factory:e.\u0275fac})}return e})(),Bj=new ht(""),xY="XSRF-TOKEN",MY=new ht("",{providedIn:"root",factory:()=>xY}),SY="X-XSRF-TOKEN",IY=new ht("",{providedIn:"root",factory:()=>SY}),ey=class{},AY=(()=>{class e{doc;cookieName;lastCookieString="";lastToken=null;parseCount=0;constructor(i,r){this.doc=i,this.cookieName=r}getToken(){let i=this.doc.cookie||"";return i!==this.lastCookieString&&(this.parseCount++,this.lastToken=W_(i,this.cookieName),this.lastCookieString=i),this.lastToken}static \u0275fac=function(r){return new(r||e)(Bt(fs),Bt(MY))};static \u0275prov=Zt({token:e,factory:e.\u0275fac})}return e})();function RY(e,t){let i=e.url.toLowerCase();if(!ot(Bj)||e.method==="GET"||e.method==="HEAD"||i.startsWith("http://")||i.startsWith("https://"))return t(e);let r=ot(ey).getToken(),n=ot(IY);return r!=null&&!e.headers.has(n)&&(e=e.clone({headers:e.headers.set(n,r)})),t(e)}function kA(...e){let t=[OC,FA,PC,{provide:Qm,useExisting:PC},{provide:K_,useFactory:()=>ot(wY,{optional:!0})??ot(FA)},{provide:kj,useValue:RY,multi:!0},{provide:Bj,useValue:!0},{provide:ey,useClass:AY}];for(let i of e)t.push(...i.\u0275providers);return th(t)}var Uj={providers:[QS(),_A(),kA()]};var ol=class e{_positions=new pa([]);getPositions(){return this._positions.asObservable()}updatePositions(t){let r=[be(ie({},t),{time:this.formatDate(t.time)}),...this._positions.getValue()];this._positions.next(r)}formatDate(t){return t.toLocaleString("it-IT",{day:"2-digit",month:"2-digit",year:"numeric",hour:"2-digit",minute:"2-digit",second:"2-digit"})}static \u0275fac=function(i){return new(i||e)};static \u0275prov=Zt({token:e,factory:e.\u0275fac,providedIn:"root"})};function OY(e,t){if(e&1){let i=U_();Ai(0,"tr",2),_s("mouseenter",function(){let n=Mm(i).$implicit,s=vh();return Sm(s.onMouseEnter(n))}),Ai(1,"td"),Lr(2,"img",3),pr(),Ai(3,"td"),jn(4),pr(),Ai(5,"td"),jn(6),pr(),Ai(7,"td"),jn(8),pr()()}if(e&2){let i=t.$implicit,r=t.index;ya("highlight",i.i===r),Nr(4),Um(i.latitude),Nr(2),Um(i.longitude),Nr(2),Um(i.time)}}var LC=class e{constructor(t,i){this.positionService=t;this.cdRef=i}positions=[];highlight=new Qr;ngOnInit(){this.positionService.getPositions().subscribe(t=>{this.positions=[...t],this.cdRef.detectChanges()})}onMouseEnter(t){this.highlight.emit(t)}onMouseOut(t){}static \u0275fac=function(i){return new(i||e)(It(ol),It(cc))};static \u0275cmp=Bs({type:e,selectors:[["app-history"]],outputs:{highlight:"highlight"},decls:3,vars:1,consts:[[1,"history"],[3,"highlight","mouseenter",4,"ngFor","ngForOf"],[3,"mouseenter"],["src","/satellite.svg","width","16"]],template:function(i,r){i&1&&(Ai(0,"div",0)(1,"table"),yC(2,OY,9,5,"tr",1),pr()()),i&2&&(Nr(2),yh("ngForOf",r.positions))},dependencies:[$m,TC],styles:[".history[_ngcontent-%COMP%]{width:100%;height:100%;overflow-y:auto}table[_ngcontent-%COMP%]{width:100%}tr[_ngcontent-%COMP%]:hover{background-color:#ff0}"]})};var VA,ty=VA=class extends dn{constructor(e){super(e),this.type="none"}clone(){return new VA({type:this.type})}};u([y0({none:"none",stayAbove:"stay-above"}),d({json:{write:{isRequired:!0}}})],ty.prototype,"type",void 0),ty=VA=u([C("esri.ground.NavigationConstraint")],ty);var jj=Symbol("GroundInstance");var Gj,HA,dc=HA=class extends dn.JSONSupportMixin(Ag){constructor(e){super(e),this[Gj]=!0,this.opacity=1,this.surfaceColor=null,this.navigationConstraint=null,this.layers=new lt;let t=r=>{r.parent&&r.parent!==this&&"remove"in r.parent&&r.parent.remove(r),r.parent=this,r.type!=="elevation"&&r.type!=="base-elevation"&&W.getLogger(this).error(`Layer '${r.title}, id:${r.id}' of type '${r.type}' is not supported as a ground layer and will therefore be ignored. Only layers of type 'elevation' are supported.`)},i=r=>{r.parent=null};this.addHandles([this.layers.on("after-add",r=>t(r.item)),this.layers.on("after-remove",r=>i(r.item))])}initialize(){this.when().catch(e=>{qr(e)||W.getLogger(this).error("#load()","Failed to load ground",e)}),this.resourceInfo&&this.read(this.resourceInfo.data,this.resourceInfo.context)}destroy(){let e=this.layers.removeAll();for(let t of e)G(t);this.layers.destroy()}normalizeCtorArgs(e){return e&&"resourceInfo"in e&&(this._set("resourceInfo",e.resourceInfo),delete(e=ie({},e)).resourceInfo),e}get layers(){return this._get("layers")}set layers(e){this._set("layers",Cp(e,this._get("layers")))}writeLayers(e,t,i,r){let n=[];e&&(r=be(ie({},r),{layerContainerType:"ground"}),e.forEach(s=>{if("write"in s){let o={};UN(s)().write(o,r)&&n.push(o)}else r?.messages&&r.messages.push(new Be("layer:unsupported",`Layers (${s.title}, ${s.id}) of type '${s.declaredClass}' cannot be persisted in the ground`,{layer:s}))})),t.layers=n}load(e){return this.addResolvingPromise(this._loadFromSource(e)),Promise.resolve(this)}loadAll(){return f2(this,e=>{e(this.layers)})}async queryElevation(e,t){await this.load({signal:t?.signal});let{ElevationQuery:i}=await import("./chunk-FYJYETJV.js");Ht(t);let r=new i,n=this.layers.filter(zj).toArray();return r.queryAll(n,e,t)}async createElevationSampler(e,t){await this.load({signal:t?.signal});let{ElevationQuery:i}=await import("./chunk-FYJYETJV.js");Ht(t);let r=new i,n=this.layers.filter(zj).toArray();return r.createSamplerAll(n,e,t)}clone(){let e={opacity:this.opacity,surfaceColor:ro(this.surfaceColor),navigationConstraint:ro(this.navigationConstraint),layers:this.layers.slice()};return this.loaded&&(e.loadStatus="loaded"),new HA({resourceInfo:this.resourceInfo}).set(e)}read(e,t){this.resourceInfo||this._set("resourceInfo",{data:e,context:t}),super.read(e,t)}_loadFromSource(e){let t=this.resourceInfo;return t?this._loadLayersFromJSON(t.data,t.context,e):Promise.resolve()}async _loadLayersFromJSON(e,t,i){let r=t?.origin||"web-scene",n=t?.portal||null,s=t?.url||null,{populateOperationalLayers:o}=await import("./chunk-MUUZ75J7.js");Ht(i);let a=[];if(e.layers&&Array.isArray(e.layers)){let l={context:{origin:r,url:s,portal:n,layerContainerType:"ground"},defaultLayerType:"ArcGISTiledElevationServiceLayer"};a.push(o(this.layers,e.layers,l))}await Promise.allSettled(a)}};function NY(e){return e&&"createElevationSampler"in e}function zj(e){return e.type==="elevation"||NY(e)}Gj=jj,u([d({json:{read:!1,write:{isRequired:!0}}})],dc.prototype,"layers",null),u([Tp("layers")],dc.prototype,"writeLayers",null),u([d({readOnly:!0})],dc.prototype,"resourceInfo",void 0),u([d({type:Number,nonNullable:!0,range:{min:0,max:1},json:{type:Tx,read:{reader:YL,source:"transparency"},write:{writer:(e,t)=>{t.transparency=QL(e)},target:"transparency"}}})],dc.prototype,"opacity",void 0),u([d({type:_n,json:{type:[Tx],write:(e,t)=>{t.surfaceColor=e.toJSON().slice(0,3)}}})],dc.prototype,"surfaceColor",void 0),u([d({type:ty,json:{write:!0}})],dc.prototype,"navigationConstraint",void 0),dc=HA=u([C("esri.Ground")],dc);var Km=dc;var FC=new WeakMap;function BA(e){return!e.destroyed&&(FC.has(e)||e.addHandles([S(()=>{let t=e.parent;return!(!t||!("type"in t))&&(t.type==="catalog-dynamic-group"||BA(t))},t=>FC.set(e,t),Ce),_r(()=>FC.delete(e))]),FC.get(e))}function LY(e){return typeof e=="object"&&e!=null&&"loaded"in e&&e.loaded===!0&&"type"in e}function qj(e){return!(!LY(e)||!I2(e)?.operations?.supportsEditing||"editingEnabled"in e&&!A2(e)||BA(e))}var UA=()=>W.getLogger("esri.support.basemapUtils");function Wj(){return{}}function $j(e){for(let t in e){let i=e[t];G(i),delete e[t]}}function Zj(e,t){let i;if(typeof e=="string"){let r=e in Ux,n=!r&&e.includes("/");if(!r&&!n){if(qN.apiKey)UA().warn(`Unable to find basemap definition for: ${e}. See available styles at https://developers.arcgis.com/rest/basemap-styles/`);else{let s=Object.entries(Ux).filter(([o,a])=>a.classic||a.is3d).map(([o])=>`"${o}"`).sort().join(", ");UA().warn(`Unable to find basemap definition for: ${e}. Try one of these: ${s}`)}return null}t&&(i=t[e]),i||(i=r?Kp.fromId(e):new Kp({style:{id:e}}),t&&(t[e]=i))}else i=yp(Kp,e);return i?.destroyed&&(UA().warn("The provided basemap is already destroyed",{basemap:i}),i=null),i}var Qj={"world-elevation":{id:"worldElevation",url:"//elevation3d.arcgis.com/arcgis/rest/services/WorldElevation3D/Terrain3D/ImageServer",layerType:"ArcGISTiledElevationServiceLayer"},"world-topobathymetry":{id:"worldTopoBathymetry",url:"//elevation3d.arcgis.com/arcgis/rest/services/WorldElevation3D/TopoBathy3D/ImageServer",layerType:"ArcGISTiledElevationServiceLayer"}};function Yj(e){let t=null;if(typeof e=="string")if(e in Qj){let i=Qj[e];t=new Km({resourceInfo:{data:{layers:[i]}}})}else W.getLogger("esri.support.groundUtils").warn(`Unable to find ground definition for: ${e}. Try "world-elevation"`);else t=yp(Km,e);return t}var va=class extends vk(yk(oi.EventedMixin(P))){constructor(e){super(e),this.allLayers=new $l({getCollections:()=>[this.basemap?.baseLayers,this.ground?.layers,this.layers,this.basemap?.referenceLayers],getChildrenFunction:t=>"layers"in t?t.layers:null}),this.allTables=_k(this),this.basemap=null,this.editableLayers=new $l({getCollections:()=>[this.allLayers],itemFilterFunction:qj}),this.ground=new Km,this._basemapCache=Wj()}destroy(){$j(this._basemapCache),this._basemapCache=null,this.allLayers.destroy(),this.allTables.destroy(),this.editableLayers.destroy(),this.basemap=G(this.basemap),G(this.ground),this._set("ground",null)}castBasemap(e){return Zj(e,this._basemapCache)}castGround(e){return Yj(e)??this._get("ground")}findLayerById(e){return this.allLayers.find(t=>t.id===e)}findTableById(e){return this.allTables.find(t=>t.id===e)}};u([d({readOnly:!0,dependsOn:[]})],va.prototype,"allLayers",void 0),u([d({readOnly:!0})],va.prototype,"allTables",void 0),u([d({type:Kp,json:{read:{source:"baseMap"},write:{target:"baseMap"}}})],va.prototype,"basemap",void 0),u([Sr("basemap")],va.prototype,"castBasemap",null),u([d({readOnly:!0})],va.prototype,"editableLayers",void 0),u([d({type:Km,nonNullable:!0})],va.prototype,"ground",void 0),u([Sr("ground")],va.prototype,"castGround",null),u([d()],va.prototype,"undoRedo",void 0),va=u([C("esri.Map")],va);var xu=va;var kC={widthBreakpoint:{getValue(e){let t=e.viewSize[0],i=e.breakpoints,r=this.values;return t<=i.xsmall?r.xsmall:t<=i.small?r.small:t<=i.medium?r.medium:t<=i.large?r.large:r.xlarge},values:{xsmall:"xsmall",small:"small",medium:"medium",large:"large",xlarge:"xlarge"},valueToClassName:{xsmall:"esri-view-width-xsmall esri-view-width-less-than-small esri-view-width-less-than-medium esri-view-width-less-than-large esri-view-width-less-than-xlarge",small:"esri-view-width-small esri-view-width-greater-than-xsmall esri-view-width-less-than-medium esri-view-width-less-than-large esri-view-width-less-than-xlarge",medium:"esri-view-width-medium esri-view-width-greater-than-xsmall esri-view-width-greater-than-small esri-view-width-less-than-large esri-view-width-less-than-xlarge",large:"esri-view-width-large esri-view-width-greater-than-xsmall esri-view-width-greater-than-small esri-view-width-greater-than-medium esri-view-width-less-than-xlarge",xlarge:"esri-view-width-xlarge esri-view-width-greater-than-xsmall esri-view-width-greater-than-small esri-view-width-greater-than-medium esri-view-width-greater-than-large"}},heightBreakpoint:{getValue(e){let t=e.viewSize[1],i=e.breakpoints,r=this.values;return t<=i.xsmall?r.xsmall:t<=i.small?r.small:t<=i.medium?r.medium:t<=i.large?r.large:r.xlarge},values:{xsmall:"xsmall",small:"small",medium:"medium",large:"large",xlarge:"xlarge"},valueToClassName:{xsmall:"esri-view-height-xsmall esri-view-height-less-than-small esri-view-height-less-than-medium esri-view-height-less-than-large esri-view-height-less-than-xlarge",small:"esri-view-height-small esri-view-height-greater-than-xsmall esri-view-height-less-than-medium esri-view-height-less-than-large esri-view-height-less-than-xlarge",medium:"esri-view-height-medium esri-view-height-greater-than-xsmall esri-view-height-greater-than-small esri-view-height-less-than-large esri-view-height-less-than-xlarge",large:"esri-view-height-large esri-view-height-greater-than-xsmall esri-view-height-greater-than-small esri-view-height-greater-than-medium esri-view-height-less-than-xlarge",xlarge:"esri-view-height-xlarge esri-view-height-greater-than-xsmall esri-view-height-greater-than-small esri-view-height-greater-than-medium esri-view-height-greater-than-large"}},orientation:{getValue(e){let t=e.viewSize,i=t[0],r=t[1],n=this.values;return r>=i?n.portrait:n.landscape},values:{portrait:"portrait",landscape:"landscape"},valueToClassName:{portrait:"esri-view-orientation-portrait",landscape:"esri-view-orientation-landscape"}}},jA={xsmall:544,small:768,medium:992,large:1200};function FY(e){let t=e;return t&&t.xsmall<t.small&&t.small<t.medium&&t.medium<t.large}function zA(e,t){return t?kC[e].valueToClassName[t].split(" "):[]}var VC=e=>{let t=class extends e{constructor(...i){super(...i),this.orientation=null,this.widthBreakpoint=null,this.heightBreakpoint=null,this.breakpoints=jA}initialize(){this.addHandles(S(()=>[this.breakpoints,this.size],()=>this._updateClassNames(),Re))}destroy(){this.destroyed||this._removeActiveClassNames()}set breakpoints(i){if(i!==this._get("breakpoints")){if(!FY(i)){let r=JSON.stringify(jA,null,2);console.warn("provided breakpoints are not valid, using defaults:"+r),i=jA}this._set("breakpoints",ie({},i))}}_updateClassNames(){if(!this.container)return;let i=Mg.acquire(),r=Mg.acquire(),n,s=!1;for(n in kC){let o=this[n],a=kC[n].getValue({viewSize:this.size,breakpoints:this.breakpoints});o!==a&&(s=!0,this[n]=a,zA(n,o).forEach(l=>r.push(l)),zA(n,a).forEach(l=>i.push(l)))}s&&(this._applyClassNameChanges(i,r),Mg.release(i),Mg.release(r))}_applyClassNameChanges(i,r){let n=this.container;n&&(r.forEach(s=>n.classList.remove(s)),i.forEach(s=>n.classList.add(s)))}_removeActiveClassNames(){let i=this.container;if(!i)return;let r;for(r in kC)zA(r,this[r]).forEach(n=>i.classList.remove(n))}};return u([d()],t.prototype,"breakpoints",null),u([d()],t.prototype,"orientation",void 0),u([d()],t.prototype,"widthBreakpoint",void 0),u([d()],t.prototype,"heightBreakpoint",void 0),t=u([C("esri.views.BreakpointsOwner")],t),t};var Mu=class extends P{constructor(){super(...arguments),this.items=new lt,this._watchUpdatingTracking=new mo,this._callbacks=new Map,this._projector=Sx(),this._hiddenProjector=Sx()}get needsRender(){return this.items.length>0}get updating(){return this._watchUpdatingTracking?.updating??!1}initialize(){let e=document.createElement("div");e.className="esri-overlay-surface",this._set("surface",e),this._hiddenSurface=document.createElement("div"),this._hiddenSurface.setAttribute("style","visibility: hidden;"),e.appendChild(this._hiddenSurface),this._watchUpdatingTracking.addOnCollectionChange(()=>this.items,t=>{for(let i of t.added){let r=()=>i.render();this._callbacks.set(i,r),this._projector.append(this.surface,r)}for(let i of t.removed){let r=this._projector.detach(this._callbacks.get(i));this.surface.removeChild(r.domNode),this._callbacks.delete(i)}})}addItem(e){this.items.add(e)}removeItem(e){this.items.remove(e)}destroy(){this.items.removeAll(),this._callbacks.forEach(e=>this._projector.detach(e)),this._callbacks=null,this._projector=null,this._watchUpdatingTracking.destroy()}render(){this._projector.renderNow()}computeBoundingRect(e){let t=this._hiddenSurface,i=this._hiddenProjector,r,n=()=>(r=e.render(),r);i.append(t,n),i.renderNow();let s={left:0,top:0,right:0,bottom:0};if(r?.domNode){let o=r.domNode.getBoundingClientRect();s.left=o.left,s.top=o.top,s.right=o.right,s.bottom=o.bottom}for(i.detach(n);t.firstChild;)t.removeChild(t.firstChild);return s}overlaps(e,t){let i=this.computeBoundingRect(e),r=this.computeBoundingRect(t);return Math.max(i.left,r.left)<=Math.min(i.right,r.right)&&Math.max(i.top,r.top)<=Math.min(i.bottom,r.bottom)}get hasVisibleItems(){return this.items.some(e=>e.visible)}async prepare(){await document.fonts.load(this._fontString()).catch(()=>{})}renderCanvas(e,t){let i=!!t?.disableDecorations;if(!this.items.some(n=>n.visible&&!(i&&n.isDecoration)))return;let r=e.getContext("2d");r.save(),r.font=this._fontString(),this.items.forEach(n=>{i&&n.isDecoration||(r.save(),n.renderCanvas(r),r.restore())}),r.restore()}_fontString(){return`10px ${getComputedStyle(this.surface).fontFamily}`}};u([d({readOnly:!0})],Mu.prototype,"surface",void 0),u([d({readOnly:!0})],Mu.prototype,"items",void 0),u([d({readOnly:!0})],Mu.prototype,"needsRender",null),u([d({readOnly:!0})],Mu.prototype,"_watchUpdatingTracking",void 0),u([d({readOnly:!0})],Mu.prototype,"updating",null),Mu=u([C("esri.views.overlay.ViewOverlay")],Mu);var GA=Mu;var qA=[0,0];function kY(e){let t=(e.ownerDocument||window.document).defaultView,i=e.getBoundingClientRect();return qA[0]=i.left+(t?.pageXOffset??0),qA[1]=i.top+(t?.pageYOffset??0),qA}function Kj(e){e&&(e.textContent="",e.parentNode&&e.parentNode.removeChild(e))}function VY(e){let t=document.createElement("div");return e.appendChild(t),t}var Xm=16,iy=750,HY=512,BY=2,HC=e=>{let t=class extends e{constructor(...i){super(...i),this._freqInfo={freq:Xm,time:iy},this._overlayRenderTaskHandle=null,this.height=0,this.messagesCommon=null,this.overlay=null,this.position=null,this.resizing=!1,this.root=null,this.surface=null,this.suspended=!0,this.ui=null,this.userContent=null,this.width=0,this.widthBreakpoint=null,this.addHandles([S(()=>this.cursor,r=>{let{surface:n}=this;n&&n.setAttribute("data-cursor",r)}),S(()=>this.navigating,r=>{let{surface:n}=this;n&&n.setAttribute("data-navigating",r.toString())})])}initialize(){this.addHandles([S(()=>this.ui,(i,r)=>this._handleUIChange(i,r),Re),this.on("focus",()=>this.notifyChange("focused")),this.on("blur",()=>this.notifyChange("focused"))])}destroy(){this.destroyed||(this.ui?.destroy(),this.container=null)}get container(){return this._get("container")??null}set container(i){let r=this._get("container"),n=vp(i);if(n||typeof i!="string"||W.getLogger(this).error("#container",`element with id '${i}' not found`),r===n)return;if(this._stopMeasuring(),r&&(r.classList.remove("esri-view"),this._overlayRenderTaskHandle&&(this._overlayRenderTaskHandle.remove(),this._overlayRenderTaskHandle=null),this.overlay&&(this.overlay.destroy(),this._set("overlay",null)),this.root&&(Kj(this.root),this._set("root",null)),this.userContent&&(xx(this.userContent,r),Kj(this.userContent),this._set("userContent",null))),!n)return this._set("width",0),this._set("height",0),this._set("position",null),this._set("suspended",!0),this._set("surface",null),void this._set("container",null);n.classList.add("esri-view");let s=document.createElement("div");s.className="esri-view-user-storage",xx(n,s),n.appendChild(s),this._set("userContent",s);let o=document.createElement("div");o.className="esri-view-root",n.insertBefore(o,n.firstChild),this._set("root",o);let a=document.createElement("div");a.className="esri-view-surface",a.setAttribute("role","application"),a.tabIndex=0,o.appendChild(a),this._set("surface",a);let l=new GA;o.appendChild(l.surface),this._set("overlay",l),this.addHandles(S(()=>l.needsRender,c=>{c&&!this._overlayRenderTaskHandle?this._overlayRenderTaskHandle=Jr({render:()=>this.overlay?.render()}):this._overlayRenderTaskHandle=Ft(this._overlayRenderTaskHandle)})),this.forceDOMReadyCycle(),this._set("container",n),this._startMeasuring()}get focused(){let i=document.activeElement===this.surface;return document.hasFocus()&&i}get size(){return[this.width,this.height]}blur(){this.surface?.blur()}focus(){this.surface?.focus()}pageToContainer(i,r,n){let s=this.position;return i-=s?s[0]:0,r-=s?s[1]:0,n?(n[0]=i,n[1]=r):n=[i,r],n}containerToPage(i,r,n){let s=this.position;return i+=s?s[0]:0,r+=s?s[1]:0,n?(n[0]=i,n[1]=r):n=[i,r],n}_handleUIChange(i,r){this.removeHandles("ui"),r&&r!==i&&r.destroy(),i&&(i.view=this,this.addHandles(S(()=>this.root,n=>{i.container=n?VY(n):null},Re),"ui")),this._set("ui",i)}_stopMeasuring(){this.removeHandles("measuring"),this._get("resizing")&&this._set("resizing",!1)}_startMeasuring(){let i=this._freqInfo;i.freq=Xm,i.time=iy;let r=Jr({prepare:o=>{let a=this._measure(),l=this._freqInfo;if(l.time+=o.deltaTime,a&&(l.freq=Xm,this._get("resizing")||this._set("resizing",!0)),l.time<l.freq)return;l.time=0;let c=this._position();l.freq=c||a?Xm:Math.min(iy,l.freq*BY),!a&&l.freq>=HY&&(r.pause(),this._get("resizing")&&this._set("resizing",!1))}}),n=new ResizeObserver(o=>{i.freq=Xm,i.time=iy,r.resume()});this.container!=null&&n.observe(this.container);let s=_r(()=>n.disconnect());this.addHandles([e0(window,"resize",()=>{i.freq=Xm,i.time=iy,r.resume()}),s,r],"measuring"),this._measure(),this._position()}_measure(){let i=this.container,r=i?i.clientWidth:0,n=i?i.clientHeight:0;if(r===0||n===0)return this.suspended||this._set("suspended",!0),!1;let s=this.width,o=this.height;return r===s&&n===o?(this.suspended&&this._set("suspended",!1),!1):(this._set("width",r),this._set("height",n),this.suspended&&this._set("suspended",!1),this.emit("resize",{oldWidth:s,oldHeight:o,width:r,height:n}),!0)}_position(){let i=this.container,r=this.position,n=i&&kY(i);return!!n&&(!r||n[0]!==r[0]||n[1]!==r[1])&&(this._set("position",[n[0],n[1]]),!0)}forceDOMReadyCycle(){}};return u([d()],t.prototype,"container",null),u([d({readOnly:!0})],t.prototype,"focused",null),u([d({readOnly:!0})],t.prototype,"height",void 0),u([d()],t.prototype,"messagesCommon",void 0),u([d({type:GA})],t.prototype,"overlay",void 0),u([d({readOnly:!0})],t.prototype,"position",void 0),u([d({readOnly:!0})],t.prototype,"resizing",void 0),u([d({readOnly:!0})],t.prototype,"root",void 0),u([d({value:null,readOnly:!0})],t.prototype,"size",null),u([d({readOnly:!0})],t.prototype,"surface",void 0),u([d({readOnly:!0})],t.prototype,"suspended",void 0),u([d({nonNullable:!0})],t.prototype,"ui",void 0),u([d({readOnly:!0})],t.prototype,"userContent",void 0),u([d({readOnly:!0})],t.prototype,"width",void 0),u([d()],t.prototype,"widthBreakpoint",void 0),t=u([C("esri.views.DOMContainer")],t),t};function Su(e){return e!=null&&"open"in e&&"declaredClass"in e}function Xj(e){return e!=null&&"declaredClass"in e&&"dockOptions"in e}var BC=e=>{let t=class extends e{constructor(){super(...arguments),this._popupSetupTask=null,this.popup={},this.popupEnabled=!0}initialize(){this.addHandles([S(()=>[this.ui,this.popup],([i,r],n)=>{let s="popup",o="manual";if(n){let[a,l]=n;a&&Su(l)&&(l.view=null,Xj(l)&&a.remove(l,s))}i&&Su(r)&&(r.view=this,Xj(r)&&i.add(r,{key:s,position:o,internal:!0}))},Re),this.on("click",i=>{this.popup&&this.popupEnabled&&(i.pointerType!=="mouse"||i.button===0)&&(Su(this.popup)?this.popup.viewModel.handleViewClick(i):i.async(async()=>{await this.setupPopup(),Su(this.popup)&&!this.destroyed&&this.ready&&this.popupEnabled&&this.popup.viewModel.handleViewClick(i)}))},qa.WIDGET)]),Zo(()=>this.ready&&this.popupEnabled&&!this.updating).then(()=>{import("./chunk-3QYOZGHH.js")})}destroy(){this.destroyed||this.closePopup()}async openPopup(i){if(Su(this.popup))return this.popup.open(i);try{if(await this.setupPopup(),!this.popup)return void W.getLogger(this).error(new Be("view:null-popup","Popup is null and can't be opened"));this.popup.open(i)}catch{}}closePopup(){this._popupSetupTask?.abort(),Su(this.popup)&&this.popup.close()}async fetchPopupFeatures(i,r){return await this.when(),this._popupHitsToFeatures(await this._getPopupHits(i,r),r)}async setupPopup(){if(this._popupSetupTask?.abort(),this.popup&&!Su(this.popup))return this._popupSetupTask=hn(async i=>{let{default:r}=await import("./chunk-3QYOZGHH.js");if(Ht(i),!this.popup||Su(this.popup))return;let n=this.popup;delete n.open,delete n.close,this.popup=new r(n)}),this._popupSetupTask.promise}async _popupHitsToFeatures({location:i,hits:r},n){let s=[],o=[],a=!1,l=JN(n,Ct("popup-view-fetch-timeout")??UY),c=m=>{let f=new WA(m);return o.push(f),s.push(f.promise),f},h=m=>{let f=o.at(-1);return f&&f.layerView===m&&!a?f:c(m)};for(let m of r)"graphic"in m?(h(m.layerView).graphics.push(m.graphic),a=!1):(s.push(m.layerView.fetchPopupFeaturesAtLocation(m.mapPoint,l)),a=!0);o.map(m=>m.resolve(l));let p=KN(s).then(m=>m.filter(f=>!!f).flat());return{pendingFeatures:s,allGraphicsPromise:p,location:i}}async _getPopupHits(i,r){let{hits:n,location:s}=await this.popupHitTest(i);Ht(r);let o=[];for(let a of n)if("graphic"in a){if(this._isValidPopupGraphic(a.graphic,r)){let l=this._isValidPopupGraphicsLayerView(a.layerView)?a.layerView:void 0;o.push({graphic:a.graphic,layerView:l})}}else this._isValidPopupLocationLayerView(a.layerView)&&o.push({mapPoint:a.mapPoint,layerView:a.layerView});return{hits:o,location:s}}_isValidPopupGraphic(i,r){return i&&!!i.getEffectivePopupTemplate(r?.defaultPopupTemplateEnabled)}_isValidPopupGraphicsLayerView(i){return!i||(!("layer"in i)||!i.suspended)&&"fetchPopupFeaturesFromGraphics"in i}_isValidPopupLocationLayerView(i){return(!("layer"in i)||!i.suspended)&&"fetchPopupFeaturesAtLocation"in i}};return u([d()],t.prototype,"popup",void 0),u([d()],t.prototype,"popupEnabled",void 0),t=u([C("esri.views.PopupView")],t),t},WA=class{constructor(t){this.layerView=t,this._resolver=As(),this.graphics=[]}get promise(){return this._resolver.promise}resolve(t){let{layerView:i,graphics:r,_resolver:n}=this;if(!i)return n.resolve(r),n.promise;let s;return i.fetchPopupFeaturesFromGraphics(r,t).catch(o=>(s=o,null)).then(o=>{o?n.resolve(o):n.reject(s)}),n.promise}},UY=5e3;var Iu=class extends bk{constructor(e){super(e),this.addHandles(this.on("before-add",t=>{t.item!=null&&t.item.parent===this.owner&&(W.getLogger(this).warn("Analysis inside the collection must be unique. Not adding this element again."),t.preventDefault())}))}_own(e){e.parent=this.owner}_release(e){e.parent=null}};Iu=u([C("esri.support.AnalysesCollection")],Iu);var Au=class extends P{constructor(e){super(e),this.view=null,this.baseLayerViews=new lt,this.referenceLayerViews=new lt,this._loadingHandle=S(()=>this.view?.map?.basemap,t=>{t&&t.load().catch(()=>{})},Re)}destroy(){this._set("view",null),this._loadingHandle&&(this._loadingHandle.remove(),this._loadingHandle=null);for(let e of this.baseLayerViews)e.destroy();this.baseLayerViews.length=0;for(let e of this.referenceLayerViews)e.destroy();this.referenceLayerViews.length=0}get suspended(){return this.view?.suspended??!0}get updating(){return this.view?.suspended?!1:!!this.view?.map?.basemap?.loaded&&(this.baseLayerViews.some(t=>t.updating)||this.referenceLayerViews.some(t=>t.updating))}};u([d({constructOnly:!0})],Au.prototype,"view",void 0),u([d({readOnly:!0})],Au.prototype,"baseLayerViews",void 0),u([d({readOnly:!0})],Au.prototype,"referenceLayerViews",void 0),u([d({readOnly:!0})],Au.prototype,"suspended",null),u([d({type:Boolean,readOnly:!0})],Au.prototype,"updating",null),Au=u([C("esri.views.BasemapView")],Au);var Jj=Au;function jY(e){return"tryRecycleWith"in e}function zY(e){return e!=null&&typeof e=="object"&&"layerViews"in e}var $A=class{constructor(t,i,r){this.layer=t,this.view=i,this.layerViewImporter=r,this._controller=new AbortController,this._deferred=As(),this._started=!1,this.done=!1,this.promise=this._deferred.promise,so(this._controller.signal,()=>{let n=new Be("cancelled:layerview-create","layerview creation cancelled",{layer:t});this._deferred.reject(n)})}tryRecycle(t){if(!this.done||!this.layerView||!jY(this.layerView))return null;let i=this.layer.type,r=this._controller.signal;for(let n=0;n<t.length;n++){let s=t[n];if(s.type!==i)continue;let o=this.layerView.tryRecycleWith(s,{signal:r});if(o){t.splice(n,1),this.layer=s;let a=this.layerView,l=a.view;return this.promise=Promise.race([o.then(()=>(Ht(this._controller.signal),s.emit("layerview-destroy",{view:l,layerView:a}),l.emit("layerview-destroy",{view:l,layerView:a}),s.emit("layerview-create",{view:l,layerView:a}),l.emit("layerview-create",{view:l,layerView:a}),a)),new Promise((c,h)=>so(this._controller.signal,()=>h(Mr())))]),this.promise}}return null}destroy(){this._controller.abort();let{layerView:t}=this;if(t){let{layer:i,view:r}=this;i.emit("layerview-destroy",{view:r,layerView:t}),r.emit("layerview-destroy",{layer:i,layerView:t})}this.done=!0,this.layer=null,this.layerView=null,this.view=null,this.layerViewImporter=null,this._map=null}async start(){if(this._started)return;this._started=!0;let{_controller:{signal:t},layer:i,view:r}=this;this._map=r.map;try{let n,s;if(await i.load({signal:t}),i.prefetchResources&&await i.prefetchResources({signal:t}),GY(i))n=await i.createLayerView(r,{signal:t});else{if(!this.layerViewImporter.hasLayerViewModule(i))throw new Be("layer:view-not-supported","No layerview implementation was found");let l=await this.layerViewImporter.importLayerView(i);Ht(t),n="default"in l?new l.default({layer:i,view:r}):new l({layer:i,view:r})}let o=()=>{s=Ft(s),n.destroyed||n.destroy(),n.layer=null,n.parent=null,n.view=null,this.done=!0};s=so(t,o),Ht(t);try{await n.when()}catch(l){throw o(),l}if(!this._map?.allLayers?.includes(i))return o(),void this._deferred.reject(new Be("view:no-layerview-for-layer","The layer has been removed from the map",{layer:i}));this.layerView=n,i.emit("layerview-create",{view:r,layerView:n}),r.emit("layerview-create",{layer:i,layerView:n}),this.done=!0,this._deferred.resolve(n)}catch(n){i.emit("layerview-create-error",{view:r,error:n}),r.emit("layerview-create-error",{layer:i,error:n}),this.done=!0,this._deferred.reject(new Be("layerview:create-error","layerview creation failed",{layer:i,error:n}))}}},So=class extends P{constructor(e){super(e),this._layerLayerViewInfoMap=new Map,this._recyclingInfoMap=new Map,this._watchUpdatingTracking=new mo,this.supportsGround=!0,this._preloadLayerViewModules=()=>{let t=this.view.map?.allLayers;if(t)for(let i of t)this.layerViewImporter.hasLayerViewModule(i)&&this.layerViewImporter.importLayerView(i)},this._reschedule=()=>this.destroyed?Promise.reject():(this._workPromise==null&&(this._workPromise=As(),this._workPromise.promise.catch(()=>{})),this.removeHandles("reschedule"),this.addHandles(n0(this._doWork),"reschedule"),this._workPromise.promise),this._doWork=()=>{if(this.destroyed)return;let t=this.view.map;if(this._map!==t&&(this.clear(),this._map=t),this._workPromise==null)return void this.notifyChange("updating");this.removeHandles("reschedule"),this.removeHandles("collection-change");let i=new Set,r=[],n=this.view.ready,s=a=>{if(a!=null){for(let l of a)if(l){i.add(l);let c=this._layerLayerViewInfoMap.get(l);c&&n?c.start():c||this._recyclingInfoMap.has(l)||r.push(l),"layers"in l&&l.layers&&s(l.layers)}}};for(let a of this._rootCollectionNames)s(Jv(this,a));for(let[a,l]of this._layerLayerViewInfoMap)if(!i.has(a)){this._layerLayerViewInfoMap.delete(l.layer);let c=l.tryRecycle(r);c?(this.notifyChange("updating"),this._recyclingInfoMap.set(l.layer,l),c.then(()=>{this.notifyChange("updating"),this._recyclingInfoMap.delete(l.layer),this._layerLayerViewInfoMap.set(l.layer,l),this._reschedule()}).catch(()=>{this.notifyChange("updating"),this._recyclingInfoMap.delete(l.layer),l.destroy(),this._reschedule()})):l.destroy()}for(let[a,l]of this._recyclingInfoMap)i.has(a)||(this.notifyChange("updating"),this._recyclingInfoMap.delete(l.layer),l.destroy());for(let a of r)this._createLayerView(a);this._refreshCollections();let o=[t?.ground?.layers,t?.basemap?.baseLayers,t?.basemap?.referenceLayers,t?.layers].filter(a=>!!a);i.forEach(a=>"layers"in a&&o.push(a.layers)),this.addHandles(o.map(a=>this._watchUpdatingTracking.addOnCollectionChange(()=>a,this._reschedule)),"collection-change"),this._workPromise.resolve(),this._workPromise=null}}initialize(){this.addHandles([tr(()=>this.view?.map?.allLayers,"change",this._preloadLayerViewModules,{onListenerAdd:this._preloadLayerViewModules}),S(()=>{let e=this.view,t=e?.map;return[t?.basemap,t?.ground,t?.layers,e?.ready]},()=>this._reschedule(),Ce)]),this._preloadLayerViewModules(),this._reschedule()}destroy(){this.clear(),iw(this._recyclingInfoMap),iw(this._layerLayerViewInfoMap),this._watchUpdatingTracking.destroy(),this._map=null,this._workPromise!=null&&(this._workPromise.reject(Mr()),this._workPromise=null)}get _layersToLayerViews(){let e=[["view.map.basemap.baseLayers","view.basemapView.baseLayerViews"],["view.map.layers","view.layerViews"],["view.map.basemap.referenceLayers","view.basemapView.referenceLayerViews"]];return this.supportsGround&&e.push(["view.map.ground.layers","view.groundView.layerViews"]),new Map(e)}get _rootCollectionNames(){return Array.from(this._layersToLayerViews.keys())}get updating(){return this._workPromise!=null||this._watchUpdatingTracking.updating||s0(this._layerLayerViewInfoMap,e=>!e.done)||this._recyclingInfoMap.size>0}get updatingRemaining(){let e=0;for(let t of this._layerLayerViewInfoMap.values())t.done||++e;return e}clear(){this.destroyed||(iw(this._layerLayerViewInfoMap),this._refreshCollections())}async whenLayerView(e){if(await this._reschedule(),!this._layerLayerViewInfoMap.has(e)){if(this._recyclingInfoMap.has(e))return this._recyclingInfoMap.get(e).promise;throw new Be("view:no-layerview-for-layer","No layerview has been found for the layer",{layer:e})}return this._layerLayerViewInfoMap.get(e).promise}isCreatingLayerViewsForLayer(e,t){this.commitProperty("updatingRemaining");let i=this._layerLayerViewInfoMap.get(e);if(!i?.done)return!0;let r=i.layerView;return!(!r||!t||r.parent===t)||!!(i.done&&r&&"layers"in e&&e.layers?.length)&&e.layers.some(n=>this.isCreatingLayerViewsForLayer(n,r))}_refreshCollections(){for(let[e,t]of this._layersToLayerViews)this._populateLayerViewsOwners(Jv(this,e),Jv(this,t),this.view);this.notifyChange("updating"),this.notifyChange("updatingRemaining")}_populateLayerViewsOwners(e,t,i){if(!e||!t)return void(t&&t.removeAll());let r=0;for(let n of e){let s=this._layerLayerViewInfoMap.get(n);if(!s?.layerView)continue;let o=s.layerView;o.layer=n,o.parent=i,t.at(r)!==o&&t.splice(r,0,o),"layers"in n&&zY(o)&&this._populateLayerViewsOwners(n.layers,o.layerViews,o),r+=1}r<t.length&&t.splice(r,t.length)}_createLayerView(e){e.load().catch(()=>{}),this.layerViewImporter.hasLayerViewModule(e)&&this.layerViewImporter.importLayerView(e);let t=new $A(e,this.view,this.layerViewImporter);t.promise.then(()=>this._refreshCollections(),i=>{i&&(qr(i)||i.name==="cancelled:layerview-create")||W.getLogger(this).error(`Failed to create layerview for layer title:'${e.title??"no title"}', id:'${e.id??"no id"}' of type '${e.type}'.`,{layer:e,error:i}),this._refreshCollections()}),this._layerLayerViewInfoMap.set(e,t),this.view.ready&&t.start(),this.notifyChange("updating"),this.notifyChange("updatingRemaining")}};u([d()],So.prototype,"_workPromise",void 0),u([d({readOnly:!0})],So.prototype,"_watchUpdatingTracking",void 0),u([d({readOnly:!0})],So.prototype,"_layersToLayerViews",null),u([d({readOnly:!0})],So.prototype,"_rootCollectionNames",null),u([d()],So.prototype,"layerViewImporter",void 0),u([d()],So.prototype,"supportsGround",void 0),u([d({readOnly:!0})],So.prototype,"updating",null),u([d({readOnly:!0})],So.prototype,"updatingRemaining",null),u([d({constructOnly:!0})],So.prototype,"view",void 0),So=u([C("esri.views.LayerViewManager")],So);var ez=So;function GY(e){return e.createLayerView!==Tk.prototype.createLayerView}var js=class extends P{constructor(e){super(e),this.factor=1.5,this.offset=Zi(0,0),this.position=null,this.size=120,this.maskUrl=null,this.maskEnabled=!0,this.overlayUrl=null,this.overlayEnabled=!0,this.visible=!0}get version(){return this.commitProperty("factor"),this.commitProperty("offset"),this.commitProperty("position"),this.commitProperty("visible"),this.commitProperty("size"),this.commitProperty("maskUrl"),this.commitProperty("maskEnabled"),this.commitProperty("overlayUrl"),this.commitProperty("overlayEnabled"),(this._get("version")||0)+1}};u([d({type:Number})],js.prototype,"factor",void 0),u([d({nonNullable:!0})],js.prototype,"offset",void 0),u([d()],js.prototype,"position",void 0),u([d({type:Number,range:{min:0}})],js.prototype,"size",void 0),u([d()],js.prototype,"maskUrl",void 0),u([d()],js.prototype,"maskEnabled",void 0),u([d()],js.prototype,"overlayUrl",void 0),u([d()],js.prototype,"overlayEnabled",void 0),u([d({readOnly:!0})],js.prototype,"version",null),u([d({type:Boolean})],js.prototype,"visible",void 0),js=u([C("esri.views.Magnifier")],js);var ZA=js;function ry(e){return!!(e!=null&&typeof e=="object"&&"createQuery"in e&&e.createQuery&&"on"in e&&e.on)}var al=class extends oi.EventedAccessor{constructor(e){super(e),this._selectionMap=new m2,this._sources=new lt,this._trashCan=[],this._layerEditHandles=new lt,this._vizTaskId=0,this.showHighlight=!0,this.highlightName="default"}initialize(){this.addHandles([S(()=>[this.view,this.showHighlight],()=>this._refreshVisualization()),tr(()=>this.sources,"change",t=>{let i=this._selectionMap;for(let r of t.removed)i.delete(r);this._refreshListeners(),this._refreshVisualization()},{onListenerAdd:()=>this._refreshListeners()})]);let e=new lt;this.view.when().then(()=>{this.view.map&&(this.view.map.allLayers.flatten(t=>"sublayers"in t&&t.sublayers?t.sublayers:null).forEach(t=>{(ry(t)&&!M2(t)||Hc(t))&&e.add(t)}),this.sources=e)})}destroy(){this._layerEditHandles.drain(Ft)}get selections(){return Array.from(this._selectionMap.entries()).map(e=>{let[t,i]=e;return{layer:t,selection:[...i.selection]}})}get count(){let e=0;for(let t of this._selectionMap.values())e+=t.selection.length;return e}get hasSelection(){return this.count>0}get sources(){return this._sources}set sources(e){Cp(e,this._sources)}async getSelectedFeatures(e,t={},i="layerView"){let{view:r,selections:n}=this,s=(e!==void 0?n.filter(o=>e.includes(o.layer)):n).filter(o=>o.selection.length>0).map(async o=>{let{layer:a,selection:l}=o,c=Hc(a)?a.parent:a;if(c==null||!iz(c))return null;if(i==="layer")return rz(c,l,t);if(tz(c))return null;let h=await r.whenLayerView(c).catch(()=>null);return h?rz(h,l,t):null});return(await Promise.all(s)).filter(o=>o!=null)}updateSelection(e){let t=new Map;for(let[n,s]of this._selectionMap)t.set(n,[...s.selection]);let i=!1,r=e.current.concat(e.added);for(let n of r){let s=n.sourceLayer,o=n.getObjectId();if(this.sources.includes(s)&&(ry(s)||Hc(s))&&o!==null){let a=_p(t,s,()=>[]);a.includes(o)||(a.push(o),i=!0)}}for(let n of e.removed){let s=n.sourceLayer,o=n.getObjectId();if(this.sources.includes(s)&&(ry(s)||Hc(s))&&o!==null){let a=t.get(s),l=a?.indexOf(o);l!==void 0&&l>=0&&(a?.splice(l,1),i=!0)}}if(i){let{_selectionMap:n,_trashCan:s}=this,o=[];for(let[a,l]of t){let c=n.get(a);c!==void 0&&s.push(c),n.set(a,{selection:l}),o.push(ie({layer:a,selection:l},xg(c!==void 0?c.selection:[],l)))}this._onSelectionChange(o)}}setSelection(e,t){this._setSelection(e,t)}getSelection(e){return this._selectionMap.get(e)?.selection}appendToSelection(e,t){let i=this._selectionMap.get(e),r=i!==void 0?[...i.selection]:[];for(let n of t)r.includes(n)||r.push(n);this._setSelection(e,r)}removeFromSelection(e,t){let i=this._selectionMap.get(e);if(!i)return;let r=[];for(let n of i.selection)t.includes(n)||r.push(n);this._setSelection(e,r)}toggleInSelection(e,t){let i=this._selectionMap.get(e);if(!i||i.selection.length===0)return void this._setSelection(e,t);let r=new Set(i.selection),n=new Set(t),s=t2(r,n);this._setSelection(e,Array.from(s))}clear(){let e=this._selectionMap.values();this._trashCan.push(...e);let t=[];for(let[i,r]of this._selectionMap.entries())t.push({layer:i,added:[],removed:[...r.selection],selection:[]});this._selectionMap.clear(),this._onSelectionChange(t)}_onSelectionChange(e){this._refreshVisualization(),this.emit("selection-change",{view:this.view,changes:e})}_refreshVisualization(){if(this.view==null||this.sources==null)return;for(this._vizTaskId++;this._trashCan.length>0;)this._trashCan.pop()?.highlightHandle?.remove();let{sources:e,view:t,_selectionMap:i,showHighlight:r}=this,n=this._vizTaskId;for(let s of e){let o=i.get(s),a=Hc(s)?s.parent:s;if(a!=null&&iz(a)){if(tz(a))continue;t.whenLayerView(a).then(l=>{o?.highlightHandle?.remove(),o!=null&&r&&n===this._vizTaskId&&"highlight"in l&&typeof l.highlight=="function"&&o.selection.length>0&&(o.highlightHandle=l.highlight(o.selection,this.highlightName))}).catch(()=>{o?.highlightHandle?.remove()})}}}_refreshListeners(){this._layerEditHandles.drain(Ft);for(let e of this.sources){let t=Hc(e)?e.parent:e;if(t!=null&&ry(t)){let i=t.on("edits",r=>{this._handleEditChanges(r,e)});this._layerEditHandles.push(i)}}}_handleEditChanges(e,t){if(e.deletedFeatures!==void 0&&e.deletedFeatures.length>0&&this._selectionMap.has(t)){let i=e.deletedFeatures.filter(r=>r.error==null).map(r=>r.objectId).filter(vd);this.removeFromSelection(t,i)}}_setSelection(e,t){if(!this.sources.includes(e))throw new Error(`Cannot set selection on layer ${e.title} because it is not in 'sources'`);let i=this._selectionMap.get(e);if(i===void 0||!WY(i,{selection:t})){i!==void 0&&this._trashCan.push(i),this._selectionMap.set(e,{selection:[...t]});let r=ie({layer:e,selection:[...t]},xg(i!==void 0?i.selection:[],t));this._onSelectionChange([r])}}};u([d({readOnly:!0,nonNullable:!0})],al.prototype,"selections",null),u([d({readOnly:!0,nonNullable:!0})],al.prototype,"count",null),u([d({constructOnly:!0,nonNullable:!0})],al.prototype,"view",void 0),u([d({readOnly:!0,nonNullable:!0})],al.prototype,"hasSelection",null),u([d()],al.prototype,"showHighlight",void 0),u([d()],al.prototype,"sources",null),u([d()],al.prototype,"highlightName",void 0),al=u([C("esri.views.SelectionManager")],al);var tz=e=>Hc(e)?e.parent?.isTable===!0:e.isTable,qY=e=>e.layer!==void 0,iz=e=>e?.when!==void 0,WY=(e,t)=>{if(e==null&&t==null)return!0;if(e!=null&&t==null||e==null&&t!=null)return!1;if(e!=null&&t!=null&&e.selection!=null&&t.selection!=null){let i=[...e.selection],r=[...t.selection];if(i.length!==r.length)return!1;i.sort(),r.sort();for(let n=0;n<i.length;n++)if(i[n]!==r[n])return!1}return!0},rz=async(e,t,i={})=>{let r;if(qY(e)){let n=e;r=n===void 0?null:await n.queryFeatures(new Wx(be(ie({},i),{objectIds:t}))).then(s=>({data:s,layer:e.layer}))}else{let n=e;r=n===void 0?null:await n.queryFeatures(new Wx(be(ie({},i),{objectIds:t}))).then(s=>({data:s,layer:n}))}return r},nz=al;var ny=class extends Ha.ClonableMixin(P){constructor(e){super(e),this.accentColor=new _n([255,127,0]),this.textColor=new _n([255,255,255])}};u([d({type:_n,nonNullable:!0})],ny.prototype,"accentColor",void 0),u([d({type:_n,nonNullable:!0})],ny.prototype,"textColor",void 0),ny=u([C("esri.views.Theme")],ny);var UC=ny;function sz(e){return[e.on("before-add",t=>{let i=t.item;if(i==null||e.includes(i))return W.getLogger("esri.views.interactive.interactiveToolUtils").warn("Tool is either already in the list of tools or tool is `null`. Not adding tool."),void t.preventDefault();i.onAdd()}),e.on("after-remove",t=>{let i=t.item;i.active&&(i.view.activeTool=null),i.destroy()})]}function sy(e){return e.visible&&e.getEditableFlag!=null&&e.getEditableFlag(Yg.USER)&&e.getEditableFlag(Yg.MANAGER)}var jC=class{constructor(){this._pointerLocations=new Map,this._hoveredManipulators=new Map,this._grabbedManipulators=new Map,this._draggedManipulators=new Map,this._stopDrag=!1,this._externallyDragging=!1,this._revertToNullActiveTool=!1,this._cursor=null}get cursor(){return this._cursor}hasFocusedManipulators(){return this._grabbedManipulators.size>0||this._draggedManipulators.size>0}handleInputEvent(t,i){let r=()=>t.stopPropagation();switch(t.type){case"pointer-move":az(t.pointerType)&&this._pointerLocations.set(t.pointerId,{x:t.x,y:t.y,pointerType:t.pointerType});break;case"drag":this._grabbedManipulators.size>0?this._stopDrag=!0:t.action==="start"?this._externallyDragging=!0:t.action==="end"&&(this._externallyDragging=!1),this._stopDrag&&(r(),t.action==="end"&&(this._stopDrag=!1));break;case"pointer-down":{if(!lz(t))break;let n=Wa(t),s=Jm(n,t.pointerType,i.forEachTool);if(s==null)break;let o=s.manipulator,a=s.tool;o==null||a==null||!o.interactive||o.grabbable&&o.grabbableForEvent(t)||!o.grabbing||o.dragging||this._releaseManipulatorBeforeDragging(o,t,i),o!=null&&a!=null&&o.interactive&&o.grabbable&&o.grabbableForEvent(t)&&!o.grabbing&&(this._grabbedManipulators.set(t.pointerId,{manipulator:o,tool:a,start:n,pointerType:t.pointerType}),this._grabbedManipulators.size===1&&i.activeTool==null&&(this._revertToNullActiveTool=!0,i.setActiveTool(s.tool)),o.grabbing=!0,o.events.emit("grab-changed",{action:"start",pointerType:t.pointerType,screenPoint:n}),r());break}case"pointer-up":this._draggedManipulators.has(t.pointerId)||this._handlePointerEnd(t,i);break;case"pointer-drag":{if(!lz(t))break;let n=this._grabbedManipulators.get(t.pointerId),s=n?.manipulator,o=n?.tool;if(s==null||o==null)break;let a=Wa(t);a.x=q(a.x,0,i.view.width),a.y=q(a.y,0,i.view.height);let l=n.start,c=this._draggedManipulators.get(t.pointerId);switch(t.action){case"start":case"update":t.action!=="update"&&this._grabbedManipulators.size!==1||(s.dragging=!0,c?s.events.emit("drag",{action:"update",start:l,screenPoint:a}):s.events.emit("drag",{action:"start",start:l,screenPoint:a,pointerType:t.pointerType}),this._draggedManipulators.set(t.pointerId,{tool:o,manipulator:s,start:l}));break;case"end":s.dragging=!1,c&&s.events.emit("drag",{action:"end",start:l,screenPoint:a}),this._draggedManipulators.delete(t.pointerId),this._handlePointerEnd(t,i)}r();break}case"immediate-click":{let n=Wa(t),s=Jm(n,t.pointerType,i.forEachTool);if($Y(t)||i.forEachTool(c=>{if((s==null||s.tool!==c||c.automaticManipulatorSelection)&&c.manipulators){let h=!1;c.manipulators.forEach(({manipulator:p})=>{p.selected&&(p.selected=!1,h=!0)}),h&&c.onManipulatorSelectionChanged&&c.onManipulatorSelectionChanged()}}),s==null)break;let{manipulator:o,tool:a}=s;if(!o.interactive)break;o.selectable&&a.automaticManipulatorSelection&&(o.selected=!o.selected,a.onManipulatorSelectionChanged&&a.onManipulatorSelectionChanged());let l=t.native.shiftKey;o.events.emit("immediate-click",{screenPoint:n,button:t.button,pointerType:t.pointerType,shiftKey:l,stopPropagation:r}),QA(o,r);break}case"click":{let n=Wa(t),s=Jm(n,t.pointerType,i.forEachTool),o=s?.manipulator;if(o==null||!o.interactive)break;let a=t.native.shiftKey;o.events.emit(t.type,{screenPoint:n,button:t.button,pointerType:t.pointerType,shiftKey:a}),r();break}case"double-click":{let n=Wa(t),s=Jm(n,t.pointerType,i.forEachTool),o=s!=null?s.manipulator:null;if(o==null||!o.interactive)break;let a=t.native.shiftKey;o.events.emit("double-click",{screenPoint:n,button:t.button,pointerType:t.pointerType,shiftKey:a,stopPropagation:r}),QA(o,r);break}case"immediate-double-click":{let n=Wa(t),s=Jm(n,t.pointerType,i.forEachTool),o=s!=null?s.manipulator:null;if(o==null||!o.interactive)break;let a=t.native.shiftKey;o.events.emit("immediate-double-click",{screenPoint:n,button:t.button,pointerType:t.pointerType,shiftKey:a,stopPropagation:r}),t.pointerType==="mouse"&&QA(o,r);break}}this._onFocusChange(i.forEachTool)}_releaseManipulatorBeforeDragging(t,i,r){t.grabbing=!1,t.events.emit("grab-changed",{action:"end",pointerType:i.pointerType,screenPoint:Wa(i)}),this._grabbedManipulators.forEach(({manipulator:n},s)=>{n===t&&this._grabbedManipulators.delete(s)}),this._afterManipulatorRelease(r.setActiveTool)}_handlePointerEnd(t,i){let r=this._grabbedManipulators.get(t.pointerId)?.manipulator;r!=null&&r.grabbing&&(r.grabbing=!1,r.events.emit("grab-changed",{action:"end",pointerType:t.pointerType,screenPoint:Wa(t)}),this._grabbedManipulators.delete(t.pointerId),this._afterManipulatorRelease(i.setActiveTool))}_onFocusChange(t){this._updateCursor(),this._updateFocusedManipulatorTools(t)}_updateCursor(){this._grabbedManipulators.size>0?this._cursor=oz(this._grabbedManipulators)||"grabbing":this._hoveredManipulators.size>0?this._cursor=oz(this._hoveredManipulators)||"pointer":this._cursor=null}_updateFocusedManipulatorTools(t){let i=new Set,r=new Set;this._grabbedManipulators.forEach(({tool:n})=>{i.add(n)}),this._hoveredManipulators.forEach(({tool:n})=>{r.add(n)}),t(n=>{n.hasGrabbedManipulators=i.has(n),n.hasHoveredManipulators=r.has(n);let s=this._grabbedManipulators.values(),o=$N(s,({tool:a})=>a===n);n.firstGrabbedManipulator=o!=null?o.manipulator:null})}clearPointers(t,{forEachTool:i,setActiveTool:r},n=!0,s){let o=(a,l)=>a===t&&(s==null||s===l);this._grabbedManipulators.forEach(({tool:a,manipulator:l,pointerType:c},h)=>{o(a,l)&&(this._grabbedManipulators.delete(h),l.grabbing=!1,l.events.emit("grab-changed",{action:"end",screenPoint:null,pointerType:c}))}),this._draggedManipulators.forEach(({tool:a,manipulator:l},c)=>{o(a,l)&&(this._draggedManipulators.delete(c),l.dragging=!1,l.events.emit("drag",{action:"cancel"}))}),n&&this._hoveredManipulators.forEach(({tool:a,manipulator:l},c)=>{o(a,l)&&(this._hoveredManipulators.delete(c),l.hovering=!1)}),this._afterManipulatorRelease(r),this._onFocusChange(i)}updateHoveredStateFromKnownPointers(t){this._pointerLocations.forEach((i,r)=>{this._updateHoveredStateForPointerAtScreenPosition(Zi(i.x,i.y),r,i.pointerType,t)})}handleHoverEvent(t,i){let r=t.type;r!=="pointer-up"&&r!=="immediate-click"&&r!=="pointer-move"||!az(t.pointerType)||(r!=="pointer-up"&&this._externallyDragging?this._clearHoveredManipulatorStates(t.pointerId):this._updateHoveredStateForPointerAtScreenPosition(Wa(t),t.pointerId,t.pointerType,i))}_updateHoveredStateForPointerAtScreenPosition(t,i,r,n){let s=Jm(t,r,n),o=this._hoveredManipulators.get(i)?.manipulator;s==null||s.manipulator.interactive||(s=null),s!=null&&o===s.manipulator||(o!=null&&(o.hovering=!1),s!=null?(s.manipulator.hovering=!0,this._hoveredManipulators.set(i,s)):this._hoveredManipulators.delete(i),this._onFocusChange(n))}_afterManipulatorRelease(t){this._grabbedManipulators.size===0&&this._revertToNullActiveTool&&(t(null),this._revertToNullActiveTool=!1)}_clearHoveredManipulatorStates(t){this._hoveredManipulators.forEach(({manipulator:i},r)=>{t===r&&(this._hoveredManipulators.delete(t),i.hovering=!1)})}};function oz(e){for(let{manipulator:t}of e.values())if(t!=null&&t.interactive){if(t.grabbing&&t.grabCursor)return t.grabCursor;if(t.cursor)return t.cursor}return null}function Jm(e,t,i){let r=null;return i(n=>{if(n.manipulators==null||!sy(n))return!1;let s=n.manipulators.intersect(e,t);return s!=null&&(r={tool:n,manipulator:s},!0)}),r}function az(e){return e==="mouse"}function lz(e){return e.pointerType!=="mouse"||e.button===0}function $Y(e){return!!e.native.shiftKey}function QA(e,t){e?.consumesClicks&&t()}var cz="attached",YA="tools",ZY=1e3,wa=class extends P{constructor(e){super(e),this._updatingHandles=new mo,this._clock=Oa,this._manipulatorState=new jC,this.tools=new lt,this.cursor=null,this._interacting=!1,this._interactingTimeout=ZY,this._interactingTimeoutHandle=null,this._forEachTool=t=>{for(let i of this.tools.items)if(t(i))return}}initialize(){this.addHandles([this.view.on($k,e=>{this._handleInputEvent(e)},qa.TOOL),...sz(this.tools),this.tools.on("before-add",({item:e})=>{this._updateToolEditableFlag(e)}),this.tools.on("before-remove",({item:e})=>{this._manipulatorState.clearPointers(e,this._manipulatorStateEventArgs),this._updateCursor()}),this.tools.on("change",()=>{this._refreshToolWatchers()})])}destroy(){this.activeTool=null,this.tools.drain(e=>e.destroy()),this._clearInteractingTimeout(),this._interacting=!1,this._updatingHandles.destroy()}get _manipulatorStateEventArgs(){return{forEachTool:this._forEachTool,activeTool:this.activeTool,setActiveTool:e=>{this.activeTool=e},view:this.view}}set activeTool(e){if(e!=null&&!this.view.ready)return void W.getLogger(this).error("Cannot set active tool while view is not ready.");if(e===this.activeTool)return;let t=this.activeTool;this._set("activeTool",e),t?.deactivate(),e?.activate(),this._removeIncompleteTools(e);for(let i of this.tools){this._updateToolEditableFlag(i);let r=sy(i);this.activeTool!=null&&r||this._manipulatorState.clearPointers(i,this._manipulatorStateEventArgs,!r)}this._updateCursor()}get updating(){return this._updatingHandles.updating||this.tools.some(e=>e.updating)}get interacting(){return this._interacting}_clearInteractingTimeout(){this._interactingTimeoutHandle=Ft(this._interactingTimeoutHandle)}_startInteractingTimeout(){this._clearInteractingTimeout(),this._interactingTimeoutHandle=this._clock.setTimeout(()=>this._interacting=!1,this._interactingTimeout)}attach(){this.view.type==="3d"?this.addHandles([S(()=>{let{state:e}=this.view;return"camera"in e&&e.camera},()=>this._forEachManipulator(e=>e.onViewChange())),this.view.elevationProvider?.on("elevation-change",e=>this._forEachManipulator(t=>t.onElevationChange(e)))],cz):this.addHandles(S(()=>this.view.extent,()=>this._forEachManipulator(e=>e.onViewChange())))}detach(){this.activeTool=null,this.tools.removeAll(),this.removeHandles(cz),this._clearInteractingTimeout(),this._interacting=!1}_forEachManipulator(e){this._forEachTool(t=>{t.manipulators&&t.manipulators.forEach(({manipulator:i})=>e(i,t))})}_handleInputEvent(e){let t=!1,i=be(ie({},e),{stopPropagation:()=>{t=!0,e.stopPropagation()}});this.activeTool!=null?this.activeTool.handleInputEvent&&this.activeTool.handleInputEvent(i):this._forEachTool(r=>{!t&&r.visible&&r.handleInputEvent(i)}),!t&&e.type==="key-down"&&e.key==="Escape"&&this.activeTool&&(e.stopPropagation(),this.activeTool=null),this._manipulatorState.handleInputEvent(i,this._manipulatorStateEventArgs),t||this.activeTool==null||this.activeTool.handleInputEventAfter(i),this._manipulatorState.handleHoverEvent(i,this._forEachTool),this._updateCursor(),e.type==="pointer-move"&&(this._manipulatorState.hasFocusedManipulators()||this.activeTool)&&(this._interacting=!0,this._startInteractingTimeout())}_refreshToolWatchers(){this.removeHandles(YA),this._forEachTool(e=>{if(e instanceof P){let t=S(()=>[e.cursor,e.visible,e.editable],()=>{sy(e)||this._manipulatorState.clearPointers(e,this._manipulatorStateEventArgs),this._updateCursor()});this.addHandles(t,YA)}e.manipulators&&this.addHandles([e.manipulators.on("after-remove",t=>{this._manipulatorState.clearPointers(e,this._manipulatorStateEventArgs,!0,t.item.manipulator)}),e.manipulators.on("change",()=>{this._manipulatorState.updateHoveredStateFromKnownPointers(this._forEachTool),this._updateCursor()})],YA)}),this._manipulatorState.updateHoveredStateFromKnownPointers(this._forEachTool),this._updateCursor()}_updateToolEditableFlag(e){e.setEditableFlag?.(Yg.MANAGER,this.activeTool==null||e===this.activeTool)}_updateCursor(){let e=this._manipulatorState.cursor;e==null&&this._forEachTool(t=>!(t.cursor==null||!t.visible)&&(e=t.cursor,!0)),this._get("cursor")!==e&&this._set("cursor",e)}_removeIncompleteTools(e){this.tools.filter(t=>(e==null||t!==e)&&!t.created&&t.removeIncompleteOnCancel).forEach(t=>{this.tools.remove(t)})}get test(){}};u([d({constructOnly:!0,nonNullable:!0})],wa.prototype,"view",void 0),u([d({value:null})],wa.prototype,"activeTool",null),u([d({readOnly:!0,type:lt})],wa.prototype,"tools",void 0),u([d({readOnly:!0})],wa.prototype,"cursor",void 0),u([d({readOnly:!0})],wa.prototype,"updating",null),u([d()],wa.prototype,"_interacting",void 0),u([d({readOnly:!0})],wa.prototype,"interacting",null),wa=u([C("esri.views.ToolViewManager")],wa);function uz(){return new(lt.ofType(_o))([new _o({name:Ld}),new _o({name:JF,color:ek})])}var ef=class extends P{constructor(e){super(),this.nativeIndex=null,this._detectedDeviceType="unknown",e.mapping==="standard"?this._detectedDeviceType="standard":QY.test(e.id)?this._detectedDeviceType="spacemouse":this._detectedDeviceType="unknown",this.nativeIndex=e.index}get native(){let e=navigator.getGamepads?navigator.getGamepads():[];return this.nativeIndex!=null&&this.nativeIndex<e.length?e[this.nativeIndex]:null}get deviceType(){return this._detectedDeviceType}get axisThreshold(){return YY[this.deviceType]}};u([d({nonNullable:!0,readOnly:!0})],ef.prototype,"nativeIndex",void 0),u([d({type:String,readOnly:!0})],ef.prototype,"deviceType",null),u([d({type:Number,readOnly:!0})],ef.prototype,"axisThreshold",null),ef=u([C("esri.views.input.gamepad.GamepadInputDevice")],ef);var tf=ef,QY=new RegExp("^(3dconnexion|space(mouse|navigator|pilot|explorer))","i"),YY={standard:.15,spacemouse:.025,unknown:0};var oy=class extends P{constructor(...e){super(...e),this.devices=new lt,this.enabledFocusMode="document"}};u([d({type:lt.ofType(tf),readOnly:!0})],oy.prototype,"devices",void 0),u([d({type:["document","view","none"]})],oy.prototype,"enabledFocusMode",void 0),oy=u([C("esri.views.input.gamepad.GamepadSettings")],oy);var dz=oy;var zC=class extends P{constructor(){super(...arguments),this.gamepad=new dz}};u([d({readOnly:!0})],zC.prototype,"gamepad",void 0),zC=u([C("esri.views.input.Input")],zC);var hz=zC;var KA=()=>d({type:["pan","rotate","zoom","none"],nonNullable:!0}),Ch=class extends P{constructor(e){super(e),this.dragPrimary="pan",this.dragSecondary="rotate",this.dragTertiary="zoom",this.mouseWheel="zoom"}};u([KA()],Ch.prototype,"dragPrimary",void 0),u([KA()],Ch.prototype,"dragSecondary",void 0),u([KA()],Ch.prototype,"dragTertiary",void 0),u([d({type:["zoom","none"],nonNullable:!0})],Ch.prototype,"mouseWheel",void 0),Ch=u([C("esri.views.navigation.NavigationActionMap")],Ch);var ay=Ch;var Ru=class extends P{constructor(e){super(e),this.enabled=!0,this.device=null,this.mode="pan",this.tiltDirection="forward-down",this.velocityFactor=1}};u([d({type:Boolean,nonNullable:!0})],Ru.prototype,"enabled",void 0),u([d({type:tf})],Ru.prototype,"device",void 0),u([d({type:["pan","zoom"],nonNullable:!0})],Ru.prototype,"mode",void 0),u([d({type:["forward-down","forward-up"],nonNullable:!0})],Ru.prototype,"tiltDirection",void 0),u([d({type:Number,nonNullable:!0})],Ru.prototype,"velocityFactor",void 0),Ru=u([C("esri.views.navigation.gamepad.GamepadSettings")],Ru);var XA=Ru;var Pu=class extends P{constructor(e){super(e),this.actionMap=new ay,this.browserTouchPanEnabled=!0,this.gamepad=new XA,this.momentumEnabled=!0}get effectiveMomentumEnabled(){return this.momentumEnabled&&!nw()}get mouseWheelZoomEnabled(){return this.actionMap.mouseWheel==="zoom"}set mouseWheelZoomEnabled(e){WN(W.getLogger(this),"mouseWheelZoomEnabled",{replacement:"actionMap.mouseWheel",version:"4.32",warnOnce:!0}),this.actionMap.mouseWheel=e?"zoom":"none"}};u([d({type:ay,nonNullable:!0})],Pu.prototype,"actionMap",void 0),u([d({type:Boolean})],Pu.prototype,"browserTouchPanEnabled",void 0),u([d({type:XA,nonNullable:!0})],Pu.prototype,"gamepad",void 0),u([d({type:Boolean})],Pu.prototype,"momentumEnabled",void 0),u([d({type:Boolean})],Pu.prototype,"mouseWheelZoomEnabled",null),Pu=u([C("esri.views.navigation.Navigation")],Pu);var rf=Pu;var eR,JA=null;async function KY(e){JA||(JA=import("./chunk-BCQE4SZA.js").then(t=>eR=t)),await JA,Ht(e)}async function tR(e,t,i,r){if(!e)return null;let n=e.spatialReference;return yL()||b0(n,t)?jl(e,t):eR?eR.projectGeometry(e,t,i,r):(await Promise.race([KY(r),wL(r)]),tR(e,t,i,r))}var wi=class extends P{constructor(e){super(e),this.required={extent:!1,heightModelInfo:!1,tileInfo:!1},this.defaultSpatialReference=null,this.userSpatialReference=null,this.sourcePreloadCount=10,this.priorityCollection=null,this.requiresExtentInSpatialReference=!0,this.suspended=!1,this._projectExtentTask={task:null,input:null,output:null,spatialReference:null}}destroy(){this._projectExtentTask.task&&(this._projectExtentTask.task=xr(this._projectExtentTask.task)),this._set("map",null)}get ready(){return!this._spatialReferenceTask.updating&&!this._tileInfoTask.updating&&!this._extentTask.updating}get heightModelInfoReady(){return!this._heightModelInfoTask.updating}get spatialReference(){return this.userSpatialReference??this._spatialReferenceTask.spatialReference}get extent(){return this._extentTask.extent}get heightModelInfo(){return this._heightModelInfoTask.heightModelInfo}get vcsWkid(){return this._heightModelInfoTask.vcsWkid}get latestVcsWkid(){return this._heightModelInfoTask.latestVcsWkid}get viewingMode(){return this.userSpatialReference==null||this.userSpatialReference.equals(this._spatialReferenceTask.spatialReference)?this._spatialReferenceTask.viewingMode:null}get tileInfo(){return this._tileInfoTask.tileInfo}get mapCollections(){let e=this.map?.(),t=[];return this.priorityCollection!=null&&t.push(this.priorityCollection),t.push({parent:e?.basemap,layers:e?.basemap?.baseLayers},{layers:e?.layers},{parent:e?.ground,layers:e?.ground?.layers},{parent:e?.basemap,layers:e?.basemap?.referenceLayers}),t}get _spatialReferenceTask(){if(this.suspended)return this._get("_spatialReferenceTask")??{updating:!1};let e;if(this._collectLayers(this.mapCollections,i=>{let r=this._getSupportedSpatialReferences(i);if(r.length>0){let n=this._narrowDownSpatialReferenceCandidates(e,r);n!=null&&(e=n)}return e?.length===1})&&e?.length!==1)return{updating:!0};let t=this._pickSpatialReferenceCandidate(e);return{spatialReference:t?.spatialReference??null,viewingMode:t?.viewingMode??null,updating:!1}}get _tileInfoTask(){if(!this.required.tileInfo)return this._get("_tileInfoTask")??{updating:!1};let e=this.map?.(),t=this.spatialReference;if(!t)return{updating:this._spatialReferenceTask.updating};let i,r=this._collectLayers([{parent:e?.basemap,layers:e?.basemap?.baseLayers},{layers:e?.layers}],n=>!(!("tileInfo"in n)||!n.tileInfo?.spatialReference.equals(t))&&(i=n,!0),n=>"tileInfo"in n);return i?{tileInfo:i.tileInfo,updating:!1}:{updating:r}}get _heightModelInfoTask(){if(!this.required.heightModelInfo||this.suspended&&this._get("_heightModelInfoTask")?.heightModelInfo)return this._get("_heightModelInfoTask")??{updating:!1};let e={},t=this._collectLayers(this.mapCollections,i=>{let r=Qk(i);return!!r&&(e={heightModelInfo:r,vcsWkid:i.spatialReference?.vcsWkid,latestVcsWkid:i.spatialReference?.latestVcsWkid},!0)},i=>Yk(i));return be(ie({},e),{updating:t})}get _extentCandidatesTask(){if(this.suspended||!this.required.extent)return this._get("_extentCandidatesTask")??{updating:!1};if(!this.spatialReference)return{updating:this._spatialReferenceTask.updating};let e=[],t=this._collectLayers(this.mapCollections,i=>{let r="fullExtents"in i&&i.fullExtents||(i.fullExtent!=null?[i.fullExtent]:[]),n=this.requiresExtentInSpatialReference?null:r[0],s=r.find(o=>o.spatialReference.equals(this.spatialReference))??n;if(s)return e.push({extent:s,layer:i}),!0;if(this._getSupportedSpatialReferences(i).length>0)for(let o of r)e.push({extent:o,layer:i});return!1});return{candidates:e,updating:t}}get _extentTask(){let{candidates:e,updating:t}=this._extentCandidatesTask;if(t)return{updating:t};if(e==null||e.length===0)return{updating:!1};if(!this.spatialReference)return{updating:this._spatialReferenceTask.updating};let i=this._pickExtentCandidate(e),r=this.spatialReference;return i.extent.equals(this._projectExtentTask.input)&&r.equals(this._projectExtentTask.spatialReference)?{extent:this._projectExtentTask.output,updating:this._projectExtentTask.task!=null&&!this._projectExtentTask.task.finished}:(this._projectExtentTask.task!=null&&(this._projectExtentTask.task=xr(this._projectExtentTask.task)),this._projectExtentTask={input:i.extent.clone(),output:null,spatialReference:r.clone(),task:hn(async n=>{try{let s=await tR(i.extent,r,"portalItem"in i.layer?i.layer.portalItem:void 0,n);this._projectExtentTask=be(ie({},this._projectExtentTask),{task:null,output:s})}catch{if(Fl(n))return;this._projectExtentTask=be(ie({},this._projectExtentTask),{task:null})}})},{updating:!0})}_narrowDownSpatialReferenceCandidates(e,t){if(e==null)return t;let i=new Array;for(let r of e)for(let n of t){if(!r.spatialReference.equals(n.spatialReference))continue;let s=XY(r.viewingMode,n.viewingMode);if(s!==!1){i.push({spatialReference:r.spatialReference,viewingMode:s});break}}return i.length>0?i:null}_pickSpatialReferenceCandidate(e){let t=this.defaultSpatialReference;return e==null||e.length<1?t?{spatialReference:t,viewingMode:null}:null:(t!=null&&e.length>1&&e.some(({spatialReference:i})=>i.equals(t))&&(e=e.filter(({spatialReference:i})=>i.equals(t))),e.length>1&&e.some(({viewingMode:i})=>i!==Se.Local)&&(e=e.filter(({viewingMode:i})=>i!==Se.Local)),e[0])}_getSupportedSpatialReferences(e){let t="supportedSpatialReferences"in e&&e.supportedSpatialReferences||(e.spatialReference?[e.spatialReference]:[]);if(t.length===0)return[];let i=[];for(let r of t){let n=this.getSpatialReferenceSupport(r,e);if(n!=null){let s=n.constraints??[{spatialReference:r,viewingMode:null}];for(let{spatialReference:o,viewingMode:a}of s)this.requiresExtentInSpatialReference&&this.userSpatialReference!=null&&!o.equals(this.userSpatialReference)||i.push({spatialReference:o,viewingMode:a})}}return i}_pickExtentCandidate(e){let t=this.spatialReference;return e.find(({extent:i})=>t.equals(i.spatialReference))||e[0]}_collectLayers(e,t,i=()=>!0){switch(this._loadMaybe(this.map?.())){case"loading":return!0;case"failed":return!1}let r=new iR(i,t);for(let n of e)if(this._collectCollection(n,r),r.done||r.preloading===this.sourcePreloadCount)break;return r.updating}_collectCollection(e,t){if(e.layers){switch(this._loadMaybe(e.parent)){case"loading":return t.updating=!0,void++t.preloading;case"failed":return}for(let i of e.layers)if(t.layerFilter(i)){switch(this._loadMaybe(i)){case"failed":continue;case"loading":t.updating=!0,++t.preloading;break;case"loaded":if(t.updating||(t.done=t.pushLayer(i)),t.done||t.preloading===this.sourcePreloadCount)break;"layers"in i&&this._collectCollection({layers:i.layers},t)}if(t.done||t.preloading===this.sourcePreloadCount)break}}}_loadMaybe(e){return e&&"loadStatus"in e&&e.loadStatus!=null?e.loadStatus==="not-loaded"?(e.load().catch(t=>{qr(t)}),"loading"):e.loadStatus:"loaded"}};u([d()],wi.prototype,"required",void 0),u([d({constructOnly:!0})],wi.prototype,"map",void 0),u([d({constructOnly:!0})],wi.prototype,"getSpatialReferenceSupport",void 0),u([d()],wi.prototype,"defaultSpatialReference",void 0),u([d()],wi.prototype,"userSpatialReference",void 0),u([d()],wi.prototype,"sourcePreloadCount",void 0),u([d()],wi.prototype,"priorityCollection",void 0),u([d()],wi.prototype,"requiresExtentInSpatialReference",void 0),u([d()],wi.prototype,"suspended",void 0),u([d({readOnly:!0})],wi.prototype,"ready",null),u([d({readOnly:!0})],wi.prototype,"heightModelInfoReady",null),u([d({readOnly:!0})],wi.prototype,"spatialReference",null),u([d({readOnly:!0})],wi.prototype,"extent",null),u([d({readOnly:!0})],wi.prototype,"heightModelInfo",null),u([d({readOnly:!0})],wi.prototype,"vcsWkid",null),u([d({readOnly:!0})],wi.prototype,"latestVcsWkid",null),u([d({readOnly:!0})],wi.prototype,"viewingMode",null),u([d({readOnly:!0})],wi.prototype,"tileInfo",null),u([d({readOnly:!0})],wi.prototype,"mapCollections",null),u([d({readOnly:!0})],wi.prototype,"_spatialReferenceTask",null),u([d({readOnly:!0})],wi.prototype,"_tileInfoTask",null),u([d({readOnly:!0})],wi.prototype,"_heightModelInfoTask",null),u([d({readOnly:!0})],wi.prototype,"_extentCandidatesTask",null),u([d()],wi.prototype,"_extentTask",null),u([d()],wi.prototype,"_projectExtentTask",void 0),wi=u([C("esri.views.support.DefaultsFromMap")],wi);var iR=class{constructor(t,i){this.layerFilter=t,this.pushLayer=i,this.preloading=-1,this.updating=!1,this.done=!1}};function XY(e,t){return e!=null?t!=null?e===t&&e:e:t}var nf=class extends P{constructor(e){super(e),this.featureTitleFields=!1,this.utilityNetworkFields=!1,this.globalIdField=!1}};u([d()],nf.prototype,"featureTitleFields",void 0),u([d()],nf.prototype,"utilityNetworkFields",void 0),u([d()],nf.prototype,"globalIdField",void 0),nf=u([C("esri.views.support.RequiredFieldsOptions")],nf);var pz=nf;var ly,ke=ly=class extends oi.EventedMixin(l0.EsriPromiseMixin(P)){constructor(e){super(e),this._userSpatialReference=null,this._cursor=null,this.handles=new Pa,this.updatingHandles=new mo,this.allLayerViews=new $l({getCollections:()=>[this.basemapView?.baseLayerViews,this.groundView?.layerViews,this.layerViews,this.basemapView?.referenceLayerViews],getChildrenFunction:JY}),this.groundView=null,this.basemapView=null,this.displayFilterEnabled=!0,this.fatalError=null,this.graphics=new aM,this.analyses=new Iu,this.typeSpecificPreconditionsReady=!0,this.layerViews=new lt,this.magnifier=new ZA,this.padding={left:0,top:0,right:0,bottom:0},this.ready=!1,this._readyStateWaitingTask=null,this.supportsGround=!0,this.type=null,this.scale=null,this.updating=!1,this.initialExtentRequired=!0,this.input=new hz,this.navigation=new rf,this.layerViewManager=null,this.analysisViewManager=null,this.isHeightModelInfoRequired=!1,this.width=null,this.height=null,this.resizing=!1,this.suspended=!1,this.viewEvents=new aw(this),this.persistableViewModels=new lt,this.requiredFieldsOptions=new pz,this._isValid=!1,this._readyCycleForced=!1,this._lockedSpatialReference=null,this._userTimeZone=null,this._lockedTimeZone=null,this._userTimeExtent=null,this._lockedTimeExtent=null,this.theme=null,this.handles.add(S(()=>this.preconditionsReady,t=>{let i=this.ready;if(t?(this._lockedSpatialReference=this.spatialReference,this._lockedTimeZone=this.timeZone,this._lockedTimeExtent=this.timeExtent,ly.views.add(this)):(this._lockedSpatialReference=null,ly.views.remove(this)),this.notifyChange("spatialReference"),!t&&i)this.toolViewManager?.detach(),this.analysisViewManager!=null&&this.analysisViewManager.detach(),this.layerViewManager?.clear(),this._teardown();else if(t&&!i){try{this._startup()}catch(r){return void queueMicrotask(()=>{this.fatalError=new Be("startup-error",null,r)})}this.analysisViewManager!=null&&this.analysisViewManager.attach(),this.toolViewManager.attach()}},Fe))}initialize(){this.addResolvingPromise(Promise.all([this.loadAsyncDependencies(),this.validate()]).then(()=>(this._isValid=!0,Zo(()=>this.ready)))),this.basemapView=new Jj({view:this}),this.layerViewManager=new ez({view:this,layerViewImporter:{importLayerView:e=>this.importLayerView(e),hasLayerViewModule:e=>this.hasLayerViewModule(e)},supportsGround:this.supportsGround}),this.toolViewManager=new wa({view:this}),this.selectionManager=new nz({view:this}),this.addHandles([Wi(()=>this.readyState==="map-content-error"&&!this.spatialReference,()=>{W.getLogger(this).warn("#spatialReference","no spatial reference could be derived from the currently added map layers")}),S(()=>this.initialExtentRequired,e=>this.defaultsFromMap.required=be(ie({},this.defaultsFromMap.required),{extent:e}),Ce),S(()=>this.ready,e=>{this.defaultsFromMap&&(this.defaultsFromMap.suspended=e,this.defaultsFromMap.userSpatialReference=e?this.spatialReference:this._userSpatialReference)},Fe),S(()=>this._userSpatialReference,e=>{this.defaultsFromMap&&(this.defaultsFromMap.userSpatialReference=e)},Ce)])}destroy(){this.destroyed||(ly.views.remove(this),this.viewEvents.destroy(),this.allLayerViews.destroy(),this.navigation&&(this.navigation.destroy(),this._set("navigation",null)),this.graphics=G(this.graphics),this.analyses=G(this.analyses),this.defaultsFromMap.destroy(),this._set("defaultsFromMap",null),G(this.analysisViewManager),this.toolViewManager=G(this.toolViewManager),this.layerViewManager=G(this.layerViewManager),this.selectionManager=G(this.selectionManager),this.basemapView=G(this.basemapView),this.groundView?.destroy(),this.layerViews?.forEach(e=>e.destroy()),this.layerViews.length=0,this.invalidate(),this._emitter.clear(),this.handles.destroy(),this.map=G(this.map),this.updatingHandles.destroy())}_startup(){this._set("ready",!0)}_teardown(){this._set("ready",!1)}whenReady(){return Promise.resolve(this)}toMap(){return W.getLogger(this).error("#toMap()","Not implemented on this instance of View"),null}get activeTool(){return this.toolViewManager?.activeTool}set activeTool(e){this.toolViewManager&&(this.toolViewManager.activeTool=e)}get animation(){return this._get("animation")}set animation(e){this._set("animation",e)}get center(){return null}get defaultsFromMapSettings(){return{}}get defaultsFromMap(){return new wi(ie({required:{tileInfo:!1,heightModelInfo:!1,extent:!1},map:()=>this.map,getSpatialReferenceSupport:(e,t)=>this.getSpatialReferenceSupport(e,t)},this.defaultsFromMapSettings))}get extent(){return this._get("extent")}set extent(e){this._set("extent",e)}get heightModelInfo(){return this.getDefaultHeightModelInfo()}get highlights(){return this._get("highlights")??uz()}set highlights(e){this._set("highlights",Cp(e,this._get("highlights"),lt.ofType(_o)))}get interacting(){return this.navigating}get navigating(){return!1}get preconditionsReady(){return!(this.fatalError||!this._isValid||this._readyCycleForced||!this.map||Ag.isLoadable(this.map)&&!this.map.loaded||this.width===0||this.height===0||!this.spatialReference||!this._validateSpatialReference(this.spatialReference)||!this._lockedSpatialReference&&!this.defaultsFromMap?.ready||!this.typeSpecificPreconditionsReady)}get resolution(){return 0}set map(e){e!==this._get("map")&&(e?.destroyed&&(W.getLogger(this).warn("#map","The provided map is already destroyed",{map:e}),e=null),Ag.isLoadable(e)&&e.load().catch(()=>{}),this.constructed&&!this.destroyed&&(this.forceReadyCycle(),this._lockedSpatialReference=null),this._set("map",e))}get readyState(){if(this.destroyed)return this._get("readyState");if(!this.map)return"missing-map";if("container"in this&&!this.container)return"missing-container";if(this.fatalError)return"rendering-error";if((this.defaultsFromMap?.ready??!1)&&!this.spatialReference){let e=!("loaded"in this.map)||this.map.loaded,t=this.map.ground.loaded,i=this.map.basemap?.loaded??!0;return e&&i&&t&&!this.map?.allLayers.length?"empty-map":(this._readyStateWaitingTask||(this._readyStateWaitingTask=hn(r=>XN(Ct("view-readyState-waiting-delay"),null,r)),this.addHandles(this._readyStateWaitingTask),this.addHandles(this._readyStateWaitingTask,"ready-state-task")),this._readyStateWaitingTask?.finished?"map-content-error":"loading")}return this._readyStateWaitingTask=xr(this._readyStateWaitingTask),this.removeHandles("ready-state-task"),this.ready?"ready":"loading"}get spatialReference(){let e=this._userSpatialReference||this._lockedSpatialReference||this.getDefaultSpatialReference()||null;if(e&&this.defaultsFromMap?.required?.heightModelInfo){let t=e.clone();return t.vcsWkid=this.defaultsFromMap.vcsWkid,t.latestVcsWkid=this.defaultsFromMap.latestVcsWkid,t}return e}set spatialReference(e){let t=!Fa(e,this._get("spatialReference"));this._set("_userSpatialReference",e),t&&(this._set("spatialReference",e),this._spatialReferenceChanged(e))}_spatialReferenceChanged(e){}get stationary(){return!this.animation&&!this.navigating&&!this.resizing}get timeExtent(){return this._userTimeExtent??this._lockedTimeExtent??this.getDefaultTimeExtent()??null}set timeExtent(e){this._userTimeExtent=e}get timeZone(){return this._userTimeZone??this._lockedTimeZone??this.getDefaultTimeZone()??l2}set timeZone(e){this._userTimeZone=e,c2(e)||W.getLogger(this).warn("#timeZone",`the parsed value '${e}' may not be a valid IANA time zone`)}get tools(){return this.toolViewManager?.tools}get initialExtent(){return this.defaultsFromMap?.extent}get cursor(){return this.toolViewManager?.cursor??this._cursor??"default"}set cursor(e){this._cursor=e,this.notifyChange("cursor")}get size(){return[this.width,this.height]}get effectiveTheme(){return this.theme??new UC}whenLayerView(e){return this.layerViewManager?.whenLayerView(e)??Promise.reject()}getDefaultSpatialReference(){return this.defaultsFromMap?.spatialReference}getDefaultHeightModelInfo(){return(this.map&&"heightModelInfo"in this.map?this.map.heightModelInfo:void 0)??this.defaultsFromMap?.heightModelInfo??null}getDefaultTimeZone(){return null}getDefaultTimeExtent(){return null}importLayerView(e){throw new Be("importLayerView() not implemented")}hasLayerViewModule(e){return!1}async validate(){}async loadAsyncDependencies(){}invalidate(){this._isValid=!1}getSpatialReferenceSupport(){return{constraints:null}}_validateSpatialReference(e){return this.getSpatialReferenceSupport(e)!=null}when(e,t){return this.isResolved()&&!this.ready&&W.getLogger(this).warn("#when()","Calling view.when() while the view is no longer ready but was already resolved once will resolve immediately. Use reactiveUtils.whenOnce(() => view.ready).then(...) instead."),super.when(e,t)}forceReadyCycle(){this.ready&&(Wi(()=>this.destroyed||this.preconditionsReady===!1,()=>this._readyCycleForced=!1,{once:!0}),this._readyCycleForced=!0)}addAndActivateTool(e){this.toolViewManager.tools.add(e),this.activeTool=e}tryFatalErrorRecovery(){this.fatalError=null}};ke.views=new lt,u([d()],ke.prototype,"_userSpatialReference",void 0),u([d()],ke.prototype,"activeTool",null),u([d({readOnly:!0})],ke.prototype,"allLayerViews",void 0),u([d()],ke.prototype,"groundView",void 0),u([d()],ke.prototype,"animation",null),u([d()],ke.prototype,"basemapView",void 0),u([d()],ke.prototype,"center",null),u([d()],ke.prototype,"defaultsFromMapSettings",null),u([d()],ke.prototype,"defaultsFromMap",null),u([d()],ke.prototype,"displayFilterEnabled",void 0),u([d()],ke.prototype,"fatalError",void 0),u([d({type:Vi})],ke.prototype,"extent",null),u([d(Zg(aM,"graphics"))],ke.prototype,"graphics",void 0),u([d(Zg(Iu,"analyses"))],ke.prototype,"analyses",void 0),u([d({readOnly:!0,type:p0})],ke.prototype,"heightModelInfo",null),u([d({type:lt.ofType(_o)})],ke.prototype,"highlights",null),u([d({readOnly:!0})],ke.prototype,"interacting",null),u([d({readOnly:!0})],ke.prototype,"navigating",null),u([d({readOnly:!0,dependsOn:["fatalError","_isValid","_readyCycleForced","map","map.loaded?","width","height","spatialReference","_lockedSpatialReference","defaultsFromMap.ready","typeSpecificPreconditionsReady"]})],ke.prototype,"preconditionsReady",null),u([d({readOnly:!0})],ke.prototype,"typeSpecificPreconditionsReady",void 0),u([d({type:lt,readOnly:!0})],ke.prototype,"layerViews",void 0),u([d()],ke.prototype,"resolution",null),u([d({type:ZA})],ke.prototype,"magnifier",void 0),u([d({value:null,type:xu})],ke.prototype,"map",null),u([d()],ke.prototype,"padding",void 0),u([d({readOnly:!0})],ke.prototype,"ready",void 0),u([d()],ke.prototype,"_readyStateWaitingTask",void 0),u([d({readOnly:!0})],ke.prototype,"readyState",null),u([d({type:Qt})],ke.prototype,"spatialReference",null),u([d()],ke.prototype,"stationary",null),u([d({readOnly:!0})],ke.prototype,"supportsGround",void 0),u([d({type:VL})],ke.prototype,"timeExtent",null),u([d({type:String,nonNullable:!0})],ke.prototype,"timeZone",null),u([d()],ke.prototype,"tools",null),u([d()],ke.prototype,"toolViewManager",void 0),u([d({readOnly:!0})],ke.prototype,"type",void 0),u([d({type:Number})],ke.prototype,"scale",void 0),u([d({readOnly:!0})],ke.prototype,"updating",void 0),u([d({readOnly:!0})],ke.prototype,"initialExtentRequired",void 0),u([d({readOnly:!0})],ke.prototype,"initialExtent",null),u([d()],ke.prototype,"cursor",null),u([d({readOnly:!0})],ke.prototype,"input",void 0),u([d({type:rf,nonNullable:!0})],ke.prototype,"navigation",void 0),u([d()],ke.prototype,"layerViewManager",void 0),u([d()],ke.prototype,"analysisViewManager",void 0),u([d()],ke.prototype,"selectionManager",void 0),u([d()],ke.prototype,"width",void 0),u([d()],ke.prototype,"height",void 0),u([d({readOnly:!0})],ke.prototype,"resizing",void 0),u([d({value:null,readOnly:!0})],ke.prototype,"size",null),u([d({readOnly:!0})],ke.prototype,"suspended",void 0),u([d({readOnly:!0})],ke.prototype,"viewEvents",void 0),u([d({readOnly:!0})],ke.prototype,"persistableViewModels",void 0),u([d()],ke.prototype,"_isValid",void 0),u([d()],ke.prototype,"_readyCycleForced",void 0),u([d()],ke.prototype,"_lockedSpatialReference",void 0),u([d()],ke.prototype,"_userTimeZone",void 0),u([d()],ke.prototype,"_lockedTimeZone",void 0),u([d()],ke.prototype,"_userTimeExtent",void 0),u([d()],ke.prototype,"_lockedTimeExtent",void 0),u([d({type:UC})],ke.prototype,"theme",void 0),u([d({readOnly:!0,type:UC})],ke.prototype,"effectiveTheme",null),ke=ly=u([C("esri.views.View")],ke);var rR=globalThis.$arcgis;rR&&!rR.views&&Object.defineProperty(rR,"views",{configurable:!1,enumerable:!0,writable:!1,value:ke.views});var GC=ke;function JY(e){return e.layerViews}function eK(e){return e instanceof Float32Array&&e.length>=2}function tK(e){return Array.isArray(e)&&e.length>=2}function qC(e){return eK(e)||tK(e)}var nR,hc=[0,0],pc=nR=class extends dn{constructor(e){super(e),this._viewpoint2D={center:Hi(),rotation:0,scale:0,spatialReference:void 0},this.center=[0,0],this.extent=new Vi,this.id=0,this.inverseTransform=sw(),this.resolution=0,this.rotation=0,this.scale=0,this.transform=sw(),this.transformNoRotation=sw(),this.displayMat3=Xp(),this.displayViewMat3=Xp(),this.viewMat3=Xp(),this.viewMat2d=$L(),this.worldScreenWidth=0,this.size=[0,0]}set pixelRatio(e){this._set("pixelRatio",e),this._update()}set size(e){this._set("size",e),this._update()}set viewpoint(e){if(e){let t=this._viewpoint2D,i=e.targetGeometry;t.center[0]=i.x,t.center[1]=i.y,t.rotation=e.rotation,t.scale=e.scale,t.spatialReference=i.spatialReference}this._update()}get visibleArea(){let[e,t]=this.size;return[this.toMap([0,0],0,0),this.toMap([0,0],0,t),this.toMap([0,0],e,t),this.toMap([0,0],e,0)]}copy(e){let t=this.size,i=this.viewpoint;return i&&t?(this.viewpoint=go(i,e.viewpoint),this._set("size",Yi(t,e.size))):(this.viewpoint=e.viewpoint.clone(),this._set("size",[e.size[0],e.size[1]])),this._set("pixelRatio",e.pixelRatio),this}clone(){return new nR({size:this.size,viewpoint:this.viewpoint.clone(),pixelRatio:this.pixelRatio})}toMap(e,t,i){return qC(t)?xd(e,t,this.inverseTransform):(hc[0]=t,hc[1]=i,xd(e,hc,this.inverseTransform))}toScreen(e,t,i){return qC(t)?xd(e,t,this.transform):(hc[0]=t,hc[1]=i,xd(e,hc,this.transform))}toScreenNoRotation(e,t,i){return qC(t)?xd(e,t,this.transformNoRotation):(hc[0]=t,hc[1]=i,xd(e,hc,this.transformNoRotation))}wrapMapCoordinate(e,t){Yi(e,t);let[i]=t,[r]=this.center,{extent:n,spatialReference:s}=this,{xmin:o,xmax:a}=n;if(s.isWrappable){let l=kk(s)/2;o=Math.max(o,r-l),a=Math.min(a,r+l)}return(i<o||i>a)&&(e[0]=CL(i,r,s)),e}getScreenTransform(e,t){let{center:i}=this._viewpoint2D,r=this._get("pixelRatio")||1,n=this._get("size");return Nk(e,i,n,t,0,r),e}_update(){let{center:e,spatialReference:t,scale:i,rotation:r}=this._viewpoint2D,n=this._get("pixelRatio")||1,s=this._get("size"),o=new Si({targetGeometry:new pt(e[0],e[1],t),scale:i,rotation:r});if(this._set("viewpoint",o),!s||!t||!i)return;this.resolution=Pk(o),this.rotation=r,this.scale=i,this.spatialReference=t,Yi(this.center,e);let a=s[0]!==0?2/s[0]:0,l=s[1]!==0?-2/s[1]:0;I0(this.displayMat3,a,0,0,0,l,0,-1,1,1);let c=Np(this.viewMat3),h=$x(s[0]/2,s[1]/2),p=$x(-s[0]/2,-s[1]/2),m=Mp(r);zl(c,c,h),Lp(c,c,m),zl(c,c,p),R0(this.displayViewMat3,this.displayMat3,c);let f=WL(this.viewMat2d,h);return GL(f,f,m),qL(f,f,p),Ak(this.extent,o,s),Lk(this.transform,o,s,n),zL(this.inverseTransform,this.transform),Fk(this.transformNoRotation,o,s,n),this.worldScreenWidth=Vk(this.spatialReference,this.resolution),this._set("id",this.id+1),this.notifyChange("visibleArea"),this}};u([d({readOnly:!0})],pc.prototype,"id",void 0),u([d({value:1,json:{write:!0}})],pc.prototype,"pixelRatio",null),u([d({json:{write:!0}})],pc.prototype,"size",null),u([d()],pc.prototype,"spatialReference",void 0),u([d({type:Si,json:{write:!0}})],pc.prototype,"viewpoint",null),u([d({readOnly:!0})],pc.prototype,"visibleArea",null),pc=nR=u([C("esri.views.2d.ViewState")],pc);var sR=pc;var oR,aR,mc=oR=class extends P{constructor(){super(...arguments),this.left=0,this.top=0,this.right=0,this.bottom=0}clone(){return new oR({left:this.left,top:this.top,right:this.right,bottom:this.bottom})}};u([d()],mc.prototype,"left",void 0),u([d()],mc.prototype,"top",void 0),u([d()],mc.prototype,"right",void 0),u([d()],mc.prototype,"bottom",void 0),mc=oR=u([C("esri.views.2d.PaddedViewState.Padding")],mc);var sf=aR=class extends sR{constructor(...e){super(...e),this.paddedViewState=new sR,this._updateContent=(()=>{let t=Hi();return()=>{let i=this._get("size"),r=this._get("padding");if(!i||!r)return;let n=this.paddedViewState;es(t,r.left+r.right,r.top+r.bottom),T0(t,i,t),Yi(n.size,t);let s=n.viewpoint;s&&(this.viewpoint=s)}})(),this.addHandles(S(()=>[this.size,this.padding],()=>this._updateContent(),Fe)),this.padding=new mc,this.size=[0,0]}set padding(e){this._set("padding",e||new mc)}set viewpoint(e){if(e){this.paddedViewState.viewpoint=e;let t=e,i=this._get("padding");i&&(t=Bk(e.clone(),e,this._get("size"),i));let{targetGeometry:r,rotation:n,scale:s}=t,{x:o,y:a,spatialReference:l}=r,c=this._viewpoint2D;c.center[0]=o,c.center[1]=a,c.rotation=n,c.scale=s,c.spatialReference=l,this._update()}}clone(){return new aR({padding:this.padding.clone(),size:this.size.slice(),viewpoint:this.paddedViewState.viewpoint.clone(),pixelRatio:this.pixelRatio})}};u([d()],sf.prototype,"paddedViewState",void 0),u([d({type:mc})],sf.prototype,"padding",null),u([d()],sf.prototype,"viewpoint",null),sf=aR=u([C("esri.views.2d.PaddedViewState")],sf);var of=sf;var WC=class{constructor(t){this.view=t,this._stationaryHandle=null,this._frameTaskHandle=null,this._updateParameters=null,this._updateRequested=!1,this._scheduler=C0(),this._schedulerHandle=Wi(()=>this._scheduler.updating,()=>this.requestFrame()),this.stationary=!0,this.prepare=()=>{this._updateParameters&&(this._updateParameters.state=this.view.state,this._updateParameters.stationary=this.view.stationary,this._updateParameters.pixelRatio=window.devicePixelRatio,this._updateParameters.renderingOptions=this.view.renderingOptions,this._updateParameters.targetState.copy(this.view.state),this.view.animation?.target==null||Na(this.view.animation.target)||(this._updateParameters.targetState.viewpoint=this.view.animation.target))},this.update=i=>{if(this._updateRequested=!1,this.view?.destroyed)return;let{allLayerViews:r,graphicsView:n,labelManager:s,state:{id:o}}=this.view;r?.forEach(this._updateLayerView,this),s!=null&&(s.lastUpdateId!==o&&(s.viewChange(),s.lastUpdateId=o),s.updateRequested&&s.processUpdate(this._updateParameters)),n!=null&&(n.lastUpdateId!==o&&(n.viewChange(),n.lastUpdateId=o),n.updateRequested&&n.processUpdate(this._updateParameters)),this.view.graphicsTileStore?.setViewState(this._updateParameters.state),this.view.animation?this._scheduler.state=pi.ANIMATING:this.view.interacting?this._scheduler.state=pi.INTERACTING:this._scheduler.state=pi.IDLE,this._scheduler.frame(i)||this._updateRequested||this._scheduler.state!==pi.IDLE||this._frameTaskHandle?.pause()}}destroy(){this.stop(),this._schedulerHandle.remove(),this._scheduler.destroy()}get scheduler(){return this._scheduler}start(){if(this._frameTaskHandle)return;let t=this.view;this.stationary=t.stationary,this._updateParameters={state:t.state,targetState:new of,pixelRatio:window.devicePixelRatio,stationary:this.stationary,renderingOptions:t.renderingOptions},this._stationaryHandle=S(()=>t.stationary,i=>{this.stationary=i,this.requestFrame()}),this._frameTaskHandle=Jr(this),this.requestUpdate()}stop(){this._frameTaskHandle&&(this._updateRequested=!1,this._stationaryHandle?.remove(),this._frameTaskHandle.remove(),this._updateParameters=this._stationaryHandle=this._frameTaskHandle=null,this.stationary=!0)}requestUpdate(){this._updateRequested||(this._updateRequested=!0,this.requestFrame())}requestFrame(){this._frameTaskHandle&&this._frameTaskHandle.resume()}_updateLayerView(t){if(!t.attached)return void this.requestUpdate();let i=this.view.state,r=t.lastUpdateId;r!=null&&(this.stationary||t.moving)||(t.moving=!0),r!==i.id&&t.viewChange(),this.stationary&&t.moving&&(t.moving=!1,t.moveEnd()),t.lastUpdateId=i.id,t.updateRequested&&t.processUpdate(this._updateParameters),"layerViews"in t&&t.layerViews?.forEach(this._updateLayerView,this)}};var Ou=class extends l0{constructor(e){super(e),this.state="running",this.target=null,this._resolver=null}initialize(){this._resolver=As(),this.addResolvingPromise(this._resolver.promise)}get done(){return this.state==="finished"||this.state==="stopped"}stop(){this.state!=="stopped"&&this.state!=="finished"&&(this._set("state","stopped"),this._resolver?.reject(new Be("ViewAnimation stopped")))}finish(){this.state!=="stopped"&&this.state!=="finished"&&(this._set("state","finished"),this._resolver?.resolve())}update(e,t){t||(t=Na(e)?"waiting-for-target":"running"),this._set("target",e),this._set("state",t)}};u([d({readOnly:!0})],Ou.prototype,"done",null),u([d({readOnly:!0,type:String})],Ou.prototype,"state",void 0),u([d()],Ou.prototype,"target",void 0),Ou=u([C("esri.views.ViewAnimation")],Ou),function(e){e.State={RUNNING:"running",STOPPED:"stopped",FINISHED:"finished",WAITING_FOR_TARGET:"waiting-for-target"}}(Ou||(Ou={}));var Cn=Ou;var cy=class extends P{constructor(e){super(e),this._gotoTask=null}destroy(){this._gotoTask=null}async goTo(e,t){if(!e)return void W.getLogger(this).error("#goTo()","target cannot be null or undefined");let i=new Cn;this.view.animation=i,await Zo(()=>this.view.ready,t);let r=be(ie({},t),{animate:t?.animate??!nw(),animationMode:t?.animationMode??"auto"}),{extent:n,spatialReference:s,size:o,viewpoint:a,constraints:l,padding:c,allLayerViews:h}=this.view,p=Ik(e,{extent:n,spatialReference:s,size:o,viewpoint:a,constraints:l,padding:c,allLayerViews:h,pickClosestTarget:t?.pickClosestTarget??!0});return i?.update(p),this._gotoTask={},r.animate?this._gotoAnimated(p,r):this._gotoImmediate(p,r)}_gotoImmediate(e,t){let i=this._gotoTask,r=this.view.animation,n=e.then(s=>{if(Ht(t),i!==this._gotoTask)throw new Be("view:goto-interrupted","Goto was interrupted");this.view.viewpoint=r.target=s,r.finish()});return this._cancellableGoTo(i,r,n,t)}_gotoAnimated(e,t){let i=this._gotoTask,r=this.view.animation;if(!r)return Promise.resolve();let n=e.then(s=>{if(Ht(t),i!==this._gotoTask)throw new Be("view:goto-interrupted","Goto was interrupted");return r.update(s),this.view.animationManager.animate(r,this.view.viewpoint,t),r.when().then(()=>{},()=>{})});return this._cancellableGoTo(i,r,n,t)}_cancellableGoTo(e,t,i,r){let n=()=>e===this._gotoTask;return t0(i,r).finally(()=>{n()&&(t.done||t.stop())})}};u([d({constructOnly:!0})],cy.prototype,"view",void 0),cy=u([C("esri.views.2d.GoToManager")],cy);function mz(e,t){let{spatialReference:i}=t,r=[t.x,t.y],n,s,o,a,l=[0,0],c=iK(e);for(let m=0;m<c.length;m++){let f=c[m];for(let g=0;g<f.length-1;g++){tL(l,r,f,g);let _=ea(r,l);(n==null||_<n)&&(n=_,s=[...l],o=m,a=g)}}if(n==null||!s||o==null||a==null)throw new Be("nearest-coordinate:failed","Failed to find the nearest coordinate");let[h,p]=s;return{coordinate:new pt({x:h,y:p,spatialReference:i}),distance:n}}function iK(e){switch(e.type){case"extent":return[[[e.xmin,e.ymin],[e.xmin,e.ymax],[e.xmax,e.ymax],[e.xmax,e.ymin],[e.xmin,e.ymin]]];case"polygon":return e.rings;case"polyline":return e.paths}}var lR,Nu=lR=class extends Ep.NumericIdentifiableMixin(P){constructor(e){super(e),this.geometry=null,this.spatialReference=null}get normalizedGeometry(){if(this.geometry==null||!this.spatialReference)return null;if(!this.spatialReference.equals(this.geometry.spatialReference))try{return jl(this.geometry,this.spatialReference)}catch(e){return W.getLogger(this).error("#constraints.geometry","could not project the geometry to the view's spatial reference",{geometry:this.geometry,spatialReference:this.spatialReference,error:e}),null}return this.geometry}constrain(e,t){if(this.normalizedGeometry==null)return e;let i=e.targetGeometry;if(this.normalizedGeometry.type==="extent"?h0(this.normalizedGeometry,i):x2(this.normalizedGeometry,i))return e;let{coordinate:r}=mz(this.normalizedGeometry,i);return r&&(e.targetGeometry=r),e}clone(){return new lR({geometry:this.geometry?.clone(),spatialReference:this.spatialReference?.clone()})}};u([d({constructOnly:!0})],Nu.prototype,"geometry",void 0),u([d({readOnly:!0})],Nu.prototype,"normalizedGeometry",null),u([d({constructOnly:!0})],Nu.prototype,"spatialReference",void 0),Nu=lR=u([C("esri.views.2d.constraints.GeometryConstraint")],Nu);var cR,uy=cR=class extends Ep.NumericIdentifiableMixin(P){constructor(){super(...arguments),this.enabled=!0,this.rotationEnabled=!0}constrain(e,t){return this.enabled&&t&&(this.rotationEnabled||(e.rotation=t.rotation)),e}clone(){return new cR({enabled:this.enabled,rotationEnabled:this.rotationEnabled})}};u([d()],uy.prototype,"enabled",void 0),u([d()],uy.prototype,"rotationEnabled",void 0),uy=cR=u([C("esri.views.2d.constraints.RotationConstraint")],uy);var uR=uy;var dR,ys=dR=class extends Ep.NumericIdentifiableMixin(P){constructor(e){super(e),this._lodByScale={},this._scales=[],this.effectiveLODs=null,this.effectiveMinZoom=-1,this.effectiveMaxZoom=-1,this.effectiveMinScale=0,this.effectiveMaxScale=0,this.lods=null,this.minZoom=-1,this.maxZoom=-1,this.minScale=0,this.maxScale=0,this.snapToZoom=!0}initialize(){let e,{lods:t,minScale:i,maxScale:r,minZoom:n,maxZoom:s}=this,o=-1,a=-1,l=!1,c=!1;if(i!==0&&r!==0&&i<r&&([i,r]=[r,i]),!t?.length)return this._set("effectiveMinScale",i),void this._set("effectiveMaxScale",r);t=t.map(h=>h.clone()),t.sort((h,p)=>p.scale-h.scale),t.forEach((h,p)=>h.level=p);for(let h of t)!l&&i>0&&i>=h.scale&&(o=h.level,l=!0),!c&&r>0&&r>=h.scale&&(a=e?e.level:-1,c=!0),e=h;n===-1&&(n=i===0?0:o),s===-1&&(s=r===0?t.length-1:a),n=Math.max(n,0),n=Math.min(n,t.length-1),s=Math.max(s,0),s=Math.min(s,t.length-1),n>s&&([n,s]=[s,n]),i=t[n].scale,r=t[s].scale,t.splice(0,n),t.splice(s-n+1,t.length),t.forEach((h,p)=>{this._lodByScale[h.scale]=h,this._scales[p]=h.scale}),this._set("effectiveLODs",t),this._set("effectiveMinZoom",n),this._set("effectiveMaxZoom",s),this._set("effectiveMinScale",i),this._set("effectiveMaxScale",r)}constrain(e,t){if(t&&e.scale===t.scale)return e;let i=this.effectiveMinScale,r=this.effectiveMaxScale,n=e.targetGeometry,s=t&&t.targetGeometry,o=r!==0&&e.scale<r,a=i!==0&&e.scale>i;if(o||a){let l=a?i:r;if(t&&s){let c=(l-t.scale)/(e.scale-t.scale);n.x=s.x+(n.x-s.x)*c,n.y=s.y+(n.y-s.y)*c}e.scale=l}return this.snapToZoom&&this.effectiveLODs&&(e.scale=this._getClosestScale(e.scale)),e}fit(e){if(!this.effectiveLODs||!this.snapToZoom)return this.constrain(e,null);let t=this.scaleToZoom(e.scale),i=Math.abs(t-Math.floor(t));return e.scale=this.zoomToScale(i>.99?Math.round(t):Math.floor(t)),e}zoomToScale(e){if(!this.effectiveLODs)return 0;e-=this.effectiveMinZoom,e=Math.max(0,e);let t=this._scales;if(e<=0)return t[0];if(e>=t.length)return t[t.length-1];let i=Math.floor(e),r=Math.ceil(e);return t[i]+(e-i)*(t[r]-t[i])}scaleToZoom(e){if(!this.effectiveLODs)return-1;let t=this._scales,i,r;if(e>=t[0])return this.effectiveMinZoom;if(e<=t[t.length-1])return this.effectiveMaxZoom;for(let n=0;n<t.length-1;n++){if(i=t[n],r=t[n+1],r===e)return n+this.effectiveMinZoom+1;if(i>e&&r<e)return n+this.effectiveMinZoom+1-(e-r)/(i-r)}return-1}snapToClosestScale(e){if(!this.effectiveLODs)return e;let t=this.scaleToZoom(e);return this.zoomToScale(Math.round(t))}snapToNextScale(e,t=.5){if(!this.effectiveLODs)return e*t;let i=Math.round(this.scaleToZoom(e));return this.zoomToScale(i+1)}snapToPreviousScale(e,t=2){if(!this.effectiveLODs)return e*t;let i=Math.round(this.scaleToZoom(e));return this.zoomToScale(i-1)}clone(){return new dR({lods:this.lods,minZoom:this.minZoom,maxZoom:this.maxZoom,minScale:this.minScale,maxScale:this.maxScale})}_getClosestScale(e){return this._lodByScale[e]||(e=this._scales.reduce((t,i)=>Math.abs(i-e)<=Math.abs(t-e)?i:t,this._scales[0])),this._lodByScale[e].scale}};u([d({readOnly:!0})],ys.prototype,"effectiveLODs",void 0),u([d({readOnly:!0})],ys.prototype,"effectiveMinZoom",void 0),u([d({readOnly:!0})],ys.prototype,"effectiveMaxZoom",void 0),u([d({readOnly:!0})],ys.prototype,"effectiveMinScale",void 0),u([d({readOnly:!0})],ys.prototype,"effectiveMaxScale",void 0),u([d()],ys.prototype,"lods",void 0),u([d()],ys.prototype,"minZoom",void 0),u([d()],ys.prototype,"maxZoom",void 0),u([d()],ys.prototype,"minScale",void 0),u([d()],ys.prototype,"maxScale",void 0),u([d()],ys.prototype,"snapToZoom",void 0),ys=dR=u([C("esri.views.2d.constraints.ZoomConstraint")],ys);var hR=ys;var rK={base:null,key:"type",typeMap:{extent:Vi,polygon:Ip}},nr=class extends P{constructor(e){super(e),this.lods=null,this.minScale=0,this.maxScale=0,this.minZoom=-1,this.maxZoom=-1,this.rotationEnabled=!0,this.snapToZoom=!0,this.customConstraints=new lt}destroy(){this.view=null}get effectiveLODs(){return this._zoom.effectiveLODs}get effectiveMinScale(){return this._zoom.effectiveMinScale}get effectiveMaxScale(){return this._zoom.effectiveMaxScale}get effectiveMinZoom(){return this._zoom.effectiveMinZoom}get effectiveMaxZoom(){return this._zoom.effectiveMaxZoom}set geometry(e){e?this._set("geometry",e):this._set("geometry",null)}get version(){return`${this._zoom?.uid}/${this._rotation?.uid}/${this._geometry?.uid}`}get _geometry(){let e=this._get("_geometry");return e&&this.geometry===e.geometry&&this.view?.constraintsInfo.spatialReference===e.spatialReference?e:new Nu({geometry:this.geometry,spatialReference:this.view?.constraintsInfo.spatialReference})}get _rotation(){return new uR({rotationEnabled:this.rotationEnabled})}get _zoom(){let e=this._get("_zoom"),t=this.lods||this.view?.constraintsInfo.lods,i=this.minZoom,r=this.maxZoom,n=this.minScale,s=this.maxScale,o=this.snapToZoom;return e&&e.lods===t&&e.minZoom===i&&e.maxZoom===r&&e.minScale===n&&e.maxScale===s&&e.snapToZoom===o?e:new hR({lods:t,minZoom:i,maxZoom:r,minScale:n,maxScale:s,snapToZoom:o})}canZoomInTo(e){let t=this.effectiveMaxScale;return t===0||e>=t}canZoomOutTo(e){let t=this.effectiveMinScale;return t===0||e<=t}constrain(e,t){return this._zoom.constrain(e,t),this._rotation.constrain(e,t),this._geometry.constrain(e,t),this.customConstraints.forEach(i=>i.constrain(e,t)),e}constrainByGeometry(e){return this._geometry.constrain(e),this.customConstraints.forEach(t=>t.applyPanConstraint?.(e)),e}fit(e){return this._zoom.fit(e)}zoomToScale(e){return this._zoom.zoomToScale(e)}scaleToZoom(e){return this._zoom.scaleToZoom(e)}snapScale(e){return this._zoom.snapToClosestScale(e)}snapToNextScale(e){return this._zoom.snapToNextScale(e)}snapToPreviousScale(e){return this._zoom.snapToPreviousScale(e)}};u([d({readOnly:!0})],nr.prototype,"effectiveLODs",null),u([d({readOnly:!0})],nr.prototype,"effectiveMinScale",null),u([d({readOnly:!0})],nr.prototype,"effectiveMaxScale",null),u([d({readOnly:!0})],nr.prototype,"effectiveMinZoom",null),u([d({readOnly:!0})],nr.prototype,"effectiveMaxZoom",null),u([d({types:rK,value:null})],nr.prototype,"geometry",null),u([d({type:[K2]})],nr.prototype,"lods",void 0),u([d()],nr.prototype,"minScale",void 0),u([d()],nr.prototype,"maxScale",void 0),u([d()],nr.prototype,"minZoom",void 0),u([d()],nr.prototype,"maxZoom",void 0),u([d()],nr.prototype,"rotationEnabled",void 0),u([d()],nr.prototype,"snapToZoom",void 0),u([d({type:lt})],nr.prototype,"customConstraints",void 0),u([d()],nr.prototype,"view",void 0),u([d({readOnly:!0})],nr.prototype,"version",null),u([d({type:Nu,readOnly:!0})],nr.prototype,"_geometry",null),u([d({type:uR})],nr.prototype,"_rotation",null),u([d({readOnly:!0,type:hR})],nr.prototype,"_zoom",null),nr=u([C("esri.views.2d.MapViewConstraints")],nr);var pR=nr;var an=class extends P{constructor(e){super(e),this.constraints=null,this.ready=!1,this.resizeAlign="center",this.addHandles([S(()=>this.constraints?.version,t=>{this.constraints&&t&&this.ready&&(this.state.viewpoint=this.constraints.fit(this.state.paddedViewState.viewpoint))},Fe)])}get center(){if(!this.ready)return this._get("center");let{center:e,spatialReference:t}=this.state.paddedViewState;return this.state.commitProperty("id"),new pt({x:e[0],y:e[1],spatialReference:t})}set center(e){if(e==null)return;if(!this.ready)return void this._set("center",e);let t;try{t=this._project(e,this.state.spatialReference)}catch(r){return void W.getLogger(this).error(new Be("mapview:invalid-center","could not project the value in the view's spatial reference",{input:e,error:r}))}let i=this.viewpoint;lM(i,i,t),this.viewpoint=i}get extent(){return this.ready?(this.state.commitProperty("id"),this.state.paddedViewState.extent.clone()):this._get("extent")}set extent(e){if(e==null)return;if(!e.width||!e.height)return void W.getLogger(this).error(new Be("mapview:invalid-extent","invalid extent size"));if(!this.ready)return this._set("extent",e),this._set("center",void 0),this._set("viewpoint",void 0),this._set("scale",void 0),void this._set("zoom",void 0);let t;try{t=this._project(e,this.state.spatialReference)}catch(r){return void W.getLogger(this).error(new Be("mapview:invalid-extent","could not project the value in the view's spatial reference",{error:r}))}let i=this.viewpoint;Rk(i,i,t,this.state.size,{constraints:this.constraints}),this.viewpoint=i}get padding(){return this.ready?this.state.padding:this._get("padding")}set padding(e){this.ready?(this.state.padding=e,this._set("padding",this.state.padding)):this._set("padding",e)}get resolution(){return this.ready?(this.state.commitProperty("id"),this.state.resolution):0}get rotation(){return this.ready?(this.state.commitProperty("id"),this.state.rotation):this._get("rotation")}set rotation(e){if(isNaN(e))return;if(!this.ready)return void this._set("rotation",e);let t=this.viewpoint;jk(t,t,e),this.viewpoint=t}get scale(){return this.ready?(this.state.commitProperty("id"),this.state.scale):this._get("scale")}set scale(e){if(!e||isNaN(e))return;if(!this.ready){this._set("scale",e),this._set("zoom",void 0);let i=this._get("extent");return void(i&&(this._set("extent",void 0),this._set("center",i.center)))}let t=this.viewpoint;cM(t,t,e),this.viewpoint=t}get viewpoint(){return this.ready?this.state.paddedViewState.viewpoint.clone():this._get("viewpoint")}set viewpoint(e){if(e==null)return;if(!this.ready)return this._set("viewpoint",e),this._set("extent",void 0),this._set("center",void 0),this._set("zoom",void 0),void this._set("scale",void 0);let t,i;try{t=this._project(e,this.state.spatialReference),!e.scale||isNaN(e.scale)?i=new Be("mapview:invalid-viewpoint",`invalid scale value of ${e.scale}`):e.targetGeometry==null&&(i=new Be("mapview:invalid-viewpoint","geometry not defined"))}catch(n){i=new Be("mapview:invalid-viewpoint","could not project the value in the view's spatial reference",{error:n})}if(i)return void W.getLogger(this).error(i);this._scaleBeforeChangingSpatialReference=null;let r=new Si({targetGeometry:new pt,scale:0,rotation:0});go(r,t),this.constraints?.constrain(r,this.state.paddedViewState.viewpoint),this.state.viewpoint=r,this._set("viewpoint",r)}get visibleArea(){return this.ready?this.state.visibleArea:null}get zoom(){return this.ready?this.constraints?.scaleToZoom(this.scale)??-1:this._get("zoom")}set zoom(e){if(!(e>=0))return;if(!this.ready){this._set("zoom",e),this._set("scale",void 0);let r=this._get("extent");return void(r&&(this._set("extent",void 0),this._set("center",r.center)))}let t=this.constraints?.zoomToScale(e)??0;if(!t)return void this._set("zoom",-1);let i=this.viewpoint;cM(i,i,t),this.viewpoint=i,this._set("zoom",this.constraints?.scaleToZoom(this.scale)??-1)}getUserStartupOptions(e){if(!e[0]&&!e[1])return{center:void 0,rotation:void 0,scale:void 0};let{padding:t,constraints:i}=this,r=this._get("center"),n=this._get("extent"),s=this._get("scale"),o=this._get("rotation"),a=this._get("viewpoint"),l=this._get("zoom"),c=l!=null&&i!=null&&i.zoomToScale(l)||void 0,h,p,m,f=a?.rotation,g=a?.targetGeometry;g?.type==="extent"?h=g:g?.type==="point"&&(p=g,m=a?.scale);let _=n??h;return{center:r??p??_?.center,rotation:o??f,scale:(s??c??m??(_&&ow(_,[e[0]-t.left-t.right,e[1]-t.top-t.bottom])))||void 0}}startup(e,t,i,r){let n=e.targetGeometry;try{this._project(e,i)}catch(s){W.getLogger(this).warn(new Ex("mapview:startup-projection-error","projection of initial viewpoint to the view's spatial reference, defaulting to the initial viewpoint.",{center:n.toJSON(),spatialReference:i,error:s})),e.targetGeometry=r||new pt({x:0,y:0,spatialReference:i})}this.constraints?.fit(e),this._set("state",new of({padding:this.padding,size:t,viewpoint:e})),this._set("ready",!0)}teardown(){this._set("ready",!1);let{center:[e,t],spatialReference:i,rotation:r,scale:n}=this.state.paddedViewState,s=new pt({x:e,y:t,spatialReference:i});this._set("viewpoint",null),this._set("extent",null),this._set("center",s),this._set("zoom",-1),this._set("rotation",r),this._set("scale",n),this._set("state",null)}changeSpatialReference(e){let t=this.state.paddedViewState.clone();if(this._scaleBeforeChangingSpatialReference==null)this._scaleBeforeChangingSpatialReference=t.scale;else{let a=t.viewpoint.clone();a.scale=this._scaleBeforeChangingSpatialReference,t.viewpoint=a}let i=t.clone(),[r,n]=t.center,s=null;try{s=this._project(new pt({x:r,y:n,spatialReference:t.spatialReference}),e)}catch(a){g2()||W.getLogger(this).warn(new Ex("mapview:spatial-reference-change","could not project the view's center to the new spatial reference",{center:s?.toJSON(),spatialReference:e,error:a}))}s||(s=new pt({x:0,y:0,spatialReference:e}));let o=lM(new Si({targetGeometry:new pt,scale:0,rotation:0}),t.viewpoint,s);i.viewpoint=o;try{let l=[t.size[0]/2,t.size[1]/2],c=[l[0]+20,l[1]],h=t.toMap([0,0],c),{x:p,y:m}=this._project(new pt({x:h[0],y:h[1],spatialReference:t.spatialReference}),e);h[0]=p,h[1]=m,i.toScreen(h,h);let f=Hk(l,h,c),g=Math.hypot(h[0]-l[0],h[1]-l[1])/20;!Number.isFinite(g)||Math.abs(g)>4?(o.rotation=0,o.targetGeometry=new pt({x:0,y:0,spatialReference:e})):(o.scale*=g,o.scale>Ct("mapview-srswitch-adjust-rotation-scale-threshold")?o.rotation=0:o.rotation+=Number.isFinite(f)?f:0)}catch{}this._get("constraints")?.constrain(o,void 0),this._get("state").viewpoint=o}resize(e,t){if(!this.ready)return;let i=this.state,r=this.state.paddedViewState.viewpoint,n=this.state.paddedViewState.size.slice();i.size=[e,t],Uk(r,r,n,this.state.paddedViewState.size,this.resizeAlign),r=this.constraints?.constrain(r,void 0)??r,this.state.viewpoint=r}toMap(e){if(!this.ready)return null;let t=[0,0],[i,r]=this.state.toMap(t,[e.x,e.y]),n=this.state.spatialReference;return new pt({x:i,y:r,spatialReference:n})}toScreen(e,t){if(!this.ready)return null;let i=this._project(e,this.state.spatialReference),r=[i.x,i.y];return t?.pickClosestTarget===!1||this.state.paddedViewState.wrapMapCoordinate(r,r),this.state.toScreen(r,r),Zi(r[0],r[1])}_project(e,t){let i=e?.targetGeometry||e;if(!t)return e;if(!i)return null;if(t.imageCoordinateSystem||i.spatialReference?.imageCoordinateSystem||Fa(t,i.spatialReference))return e;let r=jl(i,t);if(!r)throw new Be("mapview:projection-not-possible","projecting input geometry to target spatial reference returned a null value",{geometry:i,spatialReference:t});return nK(e)?(e.targetGeometry=r,e):r}};function nK(e){return e?.declaredClass==="esri.Viewpoint"}u([d({type:pt})],an.prototype,"center",null),u([d()],an.prototype,"constraints",void 0),u([d({type:Vi})],an.prototype,"extent",null),u([d({value:{top:0,right:0,bottom:0,left:0},cast:e=>ie({top:0,right:0,bottom:0,left:0},e)})],an.prototype,"padding",null),u([d()],an.prototype,"ready",void 0),u([d()],an.prototype,"resizeAlign",void 0),u([d({readOnly:!0})],an.prototype,"resolution",null),u([d({type:Number})],an.prototype,"rotation",null),u([d({type:Number})],an.prototype,"scale",null),u([d({readOnly:!0})],an.prototype,"state",void 0),u([d({type:Si})],an.prototype,"viewpoint",null),u([d({readOnly:!0})],an.prototype,"visibleArea",null),u([d()],an.prototype,"zoom",null),an=u([C("esri.views.2d.ViewStateManager")],an);function dy(e,t){switch(t){case"primary":return e.pointerType==="touch"||e.button===0;case"secondary":return e.pointerType!=="touch"&&e.button===2;case"tertiary":return e.pointerType!=="touch"&&e.button===1}}function $C(e,t){return t.some(i=>dy(e,i))}function af(e,t){let{button:i,pointerType:r}=e;return r!=="touch"&&t.some(n=>n==="primary"&&i===0||n==="secondary"&&i===2||n==="tertiary"&&i===1)}function Th(e,{dragPrimary:t,dragSecondary:i,dragTertiary:r}){return[{key:"primary",value:t},{key:"secondary",value:i},{key:"tertiary",value:r}].filter(n=>n.value===e).map(n=>n.key)}var hy=class extends rt{constructor(t,i){super(!0),this._view=t,this.registerIncoming("double-click",i,r=>this._handleDoubleClick(r,i))}_handleDoubleClick(t,i){dy(t.data,"primary")&&(t.stopPropagation(),i?this._view.mapViewNavigation.zoomOut([t.data.x,t.data.y]):this._view.mapViewNavigation.zoomIn([t.data.x,t.data.y]))}};var ZC=class extends rt{constructor(t,i,r){super(!0),this.view=t,this.pointerType=i,this.registerIncoming("double-tap-drag",r,n=>this._handleDoubleTapDrag(n))}_handleDoubleTapDrag(t){let{data:i}=t,{pointerType:r}=i;if(r!==this.pointerType)return;t.stopPropagation();let{action:n,delta:s}=i,{view:o}=this,{mapViewNavigation:a}=o;switch(n){case"begin":{let{scale:l}=o;this._startScale=l,this._currentScale=l,this._previousDelta=s,a.begin();break}case"update":{if(this._previousDelta.y===s.y)return;this._previousDelta=s;let l=1.015**s.y,c=this._startScale*l,h=c/this._currentScale;a.setViewpointImmediate(h),this._currentScale=c;break}case"end":{let{constraints:l}=o,{effectiveLODs:c,snapToZoom:h}=l;if(!h||!c)return void a.end();let p=l.snapScale(this._currentScale),m=(s.y>0?Math.max(p,l.snapToPreviousScale(this._startScale)):Math.min(p,l.snapToNextScale(this._startScale)))/this._currentScale;a.zoom(m).then(()=>{a.end()});break}}}};var Io=class{constructor(t){this._callbacks=t,this._currentCount=0,this._callbacks.condition||(this._callbacks.condition=()=>!0)}handle(t){let i=t.data,r=i.pointers.size;switch(i.action){case"start":this._currentCount=r,this._emitStart(t);break;case"added":this._emitEnd(this._previousEvent),this._currentCount=r,this._emitStart(t);break;case"update":this._emitUpdate(t);break;case"removed":this._startEvent&&this._emitEnd(this._previousEvent),this._currentCount=r,this._emitStart(t);break;case"end":this._emitEnd(t),this._currentCount=0}this._previousEvent=t}_emitStart(t){this._startEvent=t,this._callbacks.condition?.(this._currentCount,t)&&this._callbacks.start(this._currentCount,t,this._startEvent)}_emitUpdate(t){this._callbacks.condition?.(this._currentCount,t)&&this._callbacks.update(this._currentCount,t,this._startEvent)}_emitEnd(t){this._callbacks.condition?.(this._currentCount,t)&&this._callbacks.end(this._currentCount,t,this._startEvent),this._startEvent=null}};var QC=class extends rt{constructor(t,i,r){super(!0),this.view=t,this.pointerActions=i,this.registerIncoming("drag",r,n=>this._handleDrag(n)),this.registerIncoming("pointer-down",()=>this.stopMomentumNavigation())}onInstall(t){super.onInstall(t),this._dragEventSeparator=new Io({start:(i,r)=>{this.view.mapViewNavigation.pan.begin(this.view,r.data),r.stopPropagation()},update:(i,r)=>{this.view.mapViewNavigation.pan.update(this.view,r.data),r.stopPropagation()},end:(i,r)=>{this.view.mapViewNavigation.pan.end(this.view,r.data),r.stopPropagation()},condition:(i,r)=>i===1&&$C(r.data,this.pointerActions)})}_handleDrag(t){let i=this.view.mapViewNavigation;i.pinch.zoomMomentum||i.pinch.rotateMomentum?this.stopMomentumNavigation():this._dragEventSeparator.handle(t)}stopMomentumNavigation(){this.view.mapViewNavigation.pan.stopMomentumNavigation()}};var YC=class extends rt{constructor(t,i,r){super(!0),this._view=t,this.pointerActions=i;let n=this._view.mapViewNavigation;this._dragEventSeparator=new Io({start:(s,o)=>{n.rotate.begin(this._view,o.data),o.stopPropagation()},update:(s,o)=>{n.rotate.update(this._view,o.data),o.stopPropagation()},end:(s,o)=>{n.rotate.end(),o.stopPropagation()},condition:(s,o)=>s===1&&$C(o.data,this.pointerActions)}),this.registerIncoming("drag",r,s=>this._dragEventSeparator.handle(s))}};function ba(e){let t=e*e;return e<0&&(t*=-1),t}function fz(e){return e.translation[0]=0,e.translation[1]=0,e.translation[2]=0,e.heading=0,e.tilt=0,e}function py(e,t,i){let r=i,n=e.state,s=e.device,o=t.tiltDirection==="forward-down"?1:-1,a=1;return s.deviceType==="standard"?(r.translation[0]=ba(n.axes[0]),r.translation[1]=ba(n.axes[1]),r.translation[2]=ba(n.buttons[7])-ba(n.buttons[6]),r.heading=ba(n.axes[2]),r.tilt=ba(n.axes[3])):s.deviceType==="spacemouse"&&(r.translation[0]=1.2*ba(n.axes[0]),r.translation[1]=1.2*ba(n.axes[1]),r.translation[2]=2*-ba(n.axes[2]),r.heading=1.2*ba(n.axes[5]),r.tilt=1.2*ba(n.axes[3])),r.tilt*=o,X(r.translation,r.translation,a),r}function mR(e,t){let i=t;return i.translation[0]=e[1]-e[0],i.translation[1]=e[3]-e[2],i.translation[2]=e[4]-e[5],i.heading=e[7]-e[6],i.tilt=e[8]-e[9],i.zoom=e[10]-e[11],i}function lf(e){return e.translation[0]===0&&e.translation[1]===0&&e.translation[2]===0&&e.heading===0&&e.tilt===0&&e.zoom===0}var KC=class extends rt{constructor(t){super(!0),this._view=t,this._frameTask=null,this._watchHandles=new Pa,this._currentDevice=null,this._transformation={translation:[0,0,0],heading:0,tilt:0,zoom:0},this._handle=this.registerIncoming("gamepad",i=>this._handleGamePadEvent(i)),this._handle.pause()}onInstall(t){super.onInstall(t),this._watchHandles.add([S(()=>this._view.navigation.gamepad?.enabled,i=>{i?(this._handle.resume(),this._frameTask||(this._frameTask=Jr({update:r=>this._frameUpdate(r.deltaTime)}))):(this._handle.pause(),this._frameTask&&(this._frameTask.remove(),this._frameTask=null))},Re)])}onUninstall(){this._watchHandles.removeAll(),this._frameTask&&(this._frameTask.remove(),this._frameTask=null),super.onUninstall()}_handleGamePadEvent(t){let i=this._view.navigation.gamepad.device;i&&t.data.device!==i||this._currentDevice&&this._currentDevice!==t.data.device||(t.data.action==="end"?(this._currentDevice=null,fz(this._transformation)):(this._currentDevice=t.data.device,py(t.data,this._view.navigation.gamepad,this._transformation)),this._frameTask?.resume())}_frameUpdate(t){let i=this._transformation;if(lf(i))return void this._frameTask?.pause();let r=this._view.viewpoint.clone(),n=this._view.navigation.gamepad.velocityFactor,s=oK*n*t;Gk(r,r,[i.translation[0]*s,-i.translation[1]*s]);let o=1+i.translation[2]*aK*t,a=this._view.constraints.rotationEnabled?-i.heading*sK*t:0,l=this._view.size,c=[l[0]/2,l[1]];zk(r,r,o,a,c,l);let h=this._view.constraints.constrain(r,this._view.viewpoint);this._view.viewpoint=h}},sK=.06,oK=.7,aK=6e-4;function cf(e){let t=()=>e(document.visibilityState==="visible");return document.addEventListener("visibilitychange",t),_r(()=>document.removeEventListener("visibilitychange",t))}var XC=class extends rt{constructor(t,i,r){super(!0),this.view=t,this.keys=i,this._isSticky=!1,this._pressedKeys=new Set,this._timeout=void 0,this._currentDirection=void 0,this._stickyKeyDuration=200,this._handleKey=n=>{let s=this._keyMap[n.data.key];if(n.modifiers.has("Meta")||n.modifiers.has("Control"))return void this._stopMovement();if(s==null)return;n.stopPropagation(),n.preventDefault();let o=n.type==="key-down";if(this._pressedKeys[o?"add":"delete"](s),o){if(this._direction===s)return;this._direction=s,this._isSticky=!1,this._setTimeout(()=>{this._isSticky&&this._handlePopKey()})}else{let a=this._timeout===void 0,l=this._pressedKeys.size>0;a||l?this._handlePopKey():this._isSticky=!0}},this._handlePopKey=()=>{this._direction=Array.from(this._pressedKeys).pop(),this._direction==null&&this._stopMovement()},this._stopMovement=()=>{this._isSticky=!1,this._direction=void 0,this._pressedKeys.clear(),this._setTimeout(void 0)},this._keyMap={[i.left]:"left",[i.right]:"right",[i.up]:"up",[i.down]:"down"},this.registerIncoming("key-down",r,this._handleKey),this.registerIncoming("key-up",r,this._handleKey),this.registerIncoming("blur",r,this._stopMovement),this._visibilityHandle=cf(n=>n?null:this._stopMovement())}onUninstall(){this._stopMovement(),this._visibilityHandle?.remove()}get _direction(){return this._currentDirection}set _direction(t){let i=this._currentDirection!=null;if(t!=null){if(i||this.view.mapViewNavigation.begin(),this._currentDirection!==t)switch(t){case"left":this.view.mapViewNavigation.continuousPanLeft();break;case"right":this.view.mapViewNavigation.continuousPanRight();break;case"up":this.view.mapViewNavigation.continuousPanUp();break;case"down":this.view.mapViewNavigation.continuousPanDown()}}else i&&this.view.mapViewNavigation.stop();this._currentDirection=t}_setTimeout(t){clearTimeout(this._timeout),this._timeout=t===void 0?void 0:setTimeout(()=>{this._timeout=void 0,t()},this._stickyKeyDuration)}};var JC=class extends rt{constructor(t,i,r){super(!0),this.view=t,this.keys=i,this._keyToDirection=new Map,this._pressed=!1,this._addKeysMapping(i),this.registerIncoming("key-down",r,n=>this._handleKeyDown(n)),this.registerIncoming("key-up",r,n=>this._handleKeyUp(n)),this.registerIncoming("blur",r,()=>this._handleStop()),this._visibilityHandle=cf(n=>n?null:this._handleStop())}onUninstall(){this._visibilityHandle?.remove(),this._handleStop()}_addKeysMapping(t){this._addKeyMapping(t.clockwise,"clockwise"),this._addKeyMapping(t.counterClockwise,"counterClockwise"),this._addKeyMapping(t.reset,"reset")}_addKeyMapping(t,i){for(let r of t)this._keyToDirection.set(r,i)}_handleKeyDown(t){t.data.repeat||this._handleKey(t,!0)}_handleKeyUp(t){this._handleKey(t,!1)}_handleStop(){this._pressed&&(this._pressed=!1,this.view.mapViewNavigation.stop())}_handleKey(t,i){let r=t.modifiers;if(r.size>0&&!r.has("Shift")||!this.view.constraints.rotationEnabled)return;let n=this._keyToDirection.get(t.data.key);if(this._pressed=n!=null,this._pressed){if(t.preventDefault(),i)switch(this.view.mapViewNavigation.begin(),n){case"clockwise":this.view.mapViewNavigation.continuousRotateClockwise();break;case"counterClockwise":this.view.mapViewNavigation.continuousRotateCounterclockwise();break;case"reset":this.view.mapViewNavigation.resetRotation()}else this._pressed=!1,this.view.mapViewNavigation.stop();t.stopPropagation()}}};var uf;(function(e){e[e.IN=0]="IN",e[e.OUT=1]="OUT"})(uf||(uf={}));var eT=class extends rt{constructor(t,i,r){super(!0),this.view=t,this.keys=i,this._keysToZoomAction={},this.registerIncoming("key-down",r,n=>this._handleKeyDown(n)),i.zoomIn.forEach(n=>this._keysToZoomAction[n]=uf.IN),i.zoomOut.forEach(n=>this._keysToZoomAction[n]=uf.OUT)}_handleKeyDown(t){this._handleKey(t)}_handleKey(t){let i=t.modifiers;if(i.size>0&&!i.has("Shift"))return;let{key:r}=t.data;if(!(r in this._keysToZoomAction))return;let n=this._keysToZoomAction[r],{mapViewNavigation:s}=this.view,o=null;switch(n){case uf.IN:o=s.zoomIn();break;case uf.OUT:o=s.zoomOut();break;default:return}s.begin(),o.then(()=>s.end()),t.stopPropagation()}};var lK=.6,tT=class extends rt{constructor(t,i){super(!0),this._view=t,this._canZoom=!0,this.registerIncoming("mouse-wheel",i,r=>this._handleMouseWheel(r))}_handleMouseWheel(t){if(this._view.navigation.actionMap.mouseWheel!=="zoom"||(t.preventDefault(),t.stopPropagation(),!this._canZoom))return;let i=this._view.mapViewNavigation,{x:r,y:n,deltaY:s}=t.data,o=1/lK**(1/60*s),a=i.zoom(o,[r,n]);a&&(this._canZoom=!1,a.catch(()=>{}).then(()=>{this._canZoom=!0,i.end()}))}};var iT=class extends rt{constructor(t){super(!0),this.view=t,this.registerIncoming("drag",r=>this._handleDrag(r)),this.registerIncoming("pointer-down",()=>this._stopMomentumNavigation());let i=this.view.mapViewNavigation;this._dragEventSeparator=new Io({start:(r,n)=>{i.pinch.begin(this.view,n.data),n.stopPropagation()},update:(r,n)=>{i.pinch.update(this.view,n.data),n.stopPropagation()},end:(r,n)=>{i.pinch.end(this.view),n.stopPropagation()},condition:r=>r>=2})}_handleDrag(t){this._dragEventSeparator.handle(t)}_stopMomentumNavigation(){this.view.mapViewNavigation.pinch.stopMomentumNavigation()}};function fR(e){let t=e.native;return t?{buttons:t.buttons.map(i=>i.pressed?i.value||1:0),axes:t.axes.map(i=>cK(i,e.axisThreshold))}:{buttons:[],axes:[]}}function gz(e,t){if(e.axes.length!==t.axes.length||e.buttons.length!==t.buttons.length)return!1;for(let i=0;i<e.axes.length;i++)if(e.axes[i]!==t.axes[i])return!1;for(let i=0;i<e.buttons.length;i++)if(e.buttons[i]!==t.buttons[i])return!1;return!0}function _z(e){for(let t=0;t<e.axes.length;t++)if(e.axes[t]!==0)return!1;for(let t=0;t<e.buttons.length;t++)if(e.buttons[t]!==0)return!1;return!0}function cK(e,t){let i=Math.abs(e);return i<t?0:Math.sign(e)*(i-t)/(1-t)}var rT=class{constructor(t,i){this._element=t,this._input=i,this._hasEventListeners=!1,this._onConnectGamepad=s=>{this._connectGamepad(s.gamepad)},this._onDisconnectGamepad=s=>{let o=s.gamepad,a=o.index,l=this._inputDevices[a];l&&(this._emitGamepadEvent(o,fR(l),!1),this._inputDevices.splice(a,1),this._latestUpdate.splice(a,1),this._input.gamepad.devices.remove(l),this.ensurePollingState())},this._frameTask=null,this._latestUpdate=new Array,this._inputDevices=new Array,this._callback=null;let r="getGamepads"in window.navigator,n=window.isSecureContext;this.supported=r&&n,this.supported&&(yz(s=>this._connectGamepad(s)),window.addEventListener("gamepadconnected",this._onConnectGamepad),window.addEventListener("gamepaddisconnected",this._onDisconnectGamepad),this.ensurePollingState())}destroy(){this.hasEventListeners=!1,this.supported&&(window.removeEventListener("gamepadconnected",this._onConnectGamepad),window.removeEventListener("gamepaddisconnected",this._onDisconnectGamepad))}set hasEventListeners(t){this._hasEventListeners!==t&&(this._hasEventListeners=t,this.ensurePollingState())}get _eventsEnabled(){return this.supported&&this._inputDevices.length>0&&this._hasEventListeners}set onEvent(t){this._callback=t}_connectGamepad(t){let i=new tf(t);i.deviceType!=="unknown"&&(this._inputDevices[t.index]=i,this._input.gamepad.devices.add(i)),this.ensurePollingState()}ensurePollingState(){this._eventsEnabled?this._startPolling():this._stopPolling()}_startPolling(){this._frameTask==null&&(this._frameTask=Jr({update:()=>this._readGamepadState()}))}_stopPolling(){this._frameTask!=null&&(this._frameTask.remove(),this._frameTask=null,this._latestUpdate=new Array)}_readGamepadState(){let t=document.hasFocus(),i=this._element.contains(document.activeElement),r=this._input.gamepad.enabledFocusMode==="document"&&!t||this._input.gamepad.enabledFocusMode==="view"&&!i;yz(n=>{let s=this._inputDevices[n.index];if(!s)return;let o=this._latestUpdate[n.index],a=fR(s),l=r||_z(a);o&&(o.timestamp===n.timestamp||!o.active&&l||gz(o.state,a))||this._emitGamepadEvent(n,a,!l)})}_emitGamepadEvent(t,i,r){let n=this._latestUpdate[t.index],s=n&&n.active;if(!s&&!r)return;let o=!s&&r?"start":s&&r?"update":"end";this._latestUpdate[t.index]={timestamp:t.timestamp,state:i,active:r},this._callback&&this._callback({device:this._inputDevices[t.index],state:i,action:o})}};function uK(e){if(!e||!e.connected)return!1;for(let t=0;t<e.axes.length;t++)if(isNaN(e.axes[t]))return!1;return!0}function yz(e){for(let t of navigator.getGamepads())uK(t)&&e(t)}var vz=Ct("edge"),dK=Ct("chrome"),hK=Ct("ff"),pK=Ct("safari"),wz="esri-view-surface",df={touchNone:`${wz}--touch-none`,touchPan:`${wz}--touch-pan`},nT=(()=>{class e{constructor(i,r){this._active={},this._callback=()=>{},this._activePointerCaptures=new Set,this._keyDownState=new Set,this._eventId=1,this._browserTouchPanningEnabled=!1,this._element=i,i.getAttribute("tabindex")||i.setAttribute("tabindex","0"),this._eventHandlers={"key-down":this._handleKey,"key-up":this._handleKey,"pointer-down":this._handlePointer,"pointer-move":this._handlePointerPreventDefault,"pointer-up":this._handlePointerPreventDefault,"pointer-enter":this._handlePointer,"pointer-leave":this._handlePointer,"pointer-cancel":this._handlePointer,"mouse-wheel":this._handleMouseWheel,"pointer-capture-lost":this._handlePointerCaptureLost},this._updateTouchAction(),this._element.addEventListener("keydown",this._preventAltKeyDefault),this._gamepadSource=new rT(i,r),this._gamepadSource.onEvent=n=>this._callback("gamepad",n)}destroy(){this._callback=()=>{},this.activeEvents=null,this._activePointerCaptures.forEach(i=>this._releasePointerCaptureSafe(i)),this._activePointerCaptures.clear(),this._gamepadSource=G(this._gamepadSource),this._removeTouchAction(),this._element.removeEventListener("keydown",this._preventAltKeyDefault)}get browserTouchPanningEnabled(){return this._browserTouchPanningEnabled}set browserTouchPanningEnabled(i){this._browserTouchPanningEnabled=i,this._updateTouchAction(),this._updateTouchEventHandling()}set onEventReceived(i){this._callback=i}set activeEvents(i){for(let r in this._active)if(!i||!i.has(r)){let n=this._active[r];this._element.removeEventListener(gR[r],n),delete this._active[r]}i&&i.forEach(r=>{if(!this._active[r]&&gR[r]){let n=(this._eventHandlers[r]||this._handleDefault).bind(this,r);this._element.addEventListener(gR[r],n),this._active[r]=n}}),this._gamepadSource&&(this._gamepadSource.hasEventListeners=i?.has("gamepad")??!1)}setPointerCapture(i,r){r?this._setPointerCaptureSafe(i.pointerId):(this._releasePointerCaptureSafe(i.pointerId),this._activePointerCaptures.delete(i.pointerId))}_updateTouchAction(){this._element.classList.remove(this._browserTouchPanningEnabled?df.touchNone:df.touchPan),this._element.classList.add(this._browserTouchPanningEnabled?df.touchPan:df.touchNone)}_updateTouchEventHandling(){this._browserTouchPanningEnabled?this._element.addEventListener("touchmove",this._preventMultiTouchPanning):this._element.removeEventListener("touchmove",this._preventMultiTouchPanning)}_removeTouchAction(){this._element.classList.remove(df.touchNone),this._element.classList.remove(df.touchPan),this._element.removeEventListener("touchmove",this._preventMultiTouchPanning)}_setPointerCaptureSafe(i){try{this._element.setPointerCapture(i),this._activePointerCaptures.add(i)}catch{}}_releasePointerCaptureSafe(i){try{if(this._element.hasPointerCapture&&!this._element.hasPointerCapture(i))return;this._element.releasePointerCapture(i)}catch{}}_updateNormalizedPointerLikeEvent(i,r){let n=Zk(this._element,i);return e.test.disableSubpixelCoordinates&&(n.x=Math.round(n.x),n.y=Math.round(n.y)),r.x=n.x,r.y=n.y,r}_handleKey(i,r){let{key:n}=r;n&&i==="key-up"&&this._keyDownState.delete(n);let s={native:r,key:n,repeat:!!n&&this._keyDownState.has(n)};n&&i==="key-down"&&this._keyDownState.add(s.key),this._callback(i,s)}_handlePointer(i,r){let n=this._updateNormalizedPointerLikeEvent(r,{native:r,x:0,y:0,pointerType:r.pointerType,button:r.button,buttons:r.buttons,eventId:this._eventId++});this._callback(i,n)}_handlePointerPreventDefault(i,r){let n=this._updateNormalizedPointerLikeEvent(r,{native:r,x:0,y:0,pointerType:r.pointerType,button:r.button,buttons:r.buttons,eventId:this._eventId++});r.preventDefault(),this._callback(i,n)}_getDeltaFromTrackpadOrMouseWheel(i){return i.shiftKey&&Ct("mac")&&i.deltaY===0?i.deltaX:i.deltaY}_handleMouseWheel(i,r){let n=this._getDeltaFromTrackpadOrMouseWheel(r);switch(r.deltaMode){case 0:vz&&(n=n/document.documentElement.clientHeight*600);break;case 1:n*=30;break;case 2:n*=900}vz?n*=.7:dK||pK?n*=.6:hK&&(n*=1.375);let s=100,o=Math.abs(n);o>s&&(n=n/o*200/(1+Math.exp(-.02*(o-s))));let a=this._updateNormalizedPointerLikeEvent(r,{native:r,x:0,y:0,deltaY:n});this._callback(i,a)}_handlePointerCaptureLost(i,r){this._activePointerCaptures.delete(r.pointerId),this._handleDefault(i,r)}_handleDefault(i,r){let n={native:r};r.preventDefault(),this._callback(i,n)}_preventAltKeyDefault(i){i.key==="Alt"&&i.preventDefault()}_preventMultiTouchPanning(i){i.touches.length>1&&i.preventDefault()}}return e.test={disableSubpixelCoordinates:!1},e})(),gR={"key-down":"keydown","key-up":"keyup","pointer-down":"pointerdown","pointer-up":"pointerup","pointer-move":"pointermove","mouse-wheel":"wheel","pointer-capture-got":"gotpointercapture","pointer-capture-lost":"lostpointercapture","context-menu":"contextmenu","pointer-enter":"pointerenter","pointer-leave":"pointerleave","pointer-cancel":"pointercancel",focus:"focus",blur:"blur"};var hf=class extends rt{constructor(){super(!0),this.registerIncoming("context-menu",t=>t.data.native.preventDefault())}};var mr={maximumClickDelay:300,movementUntilMouseDrag:1.5,movementUntilPenDrag:6,movementUntilTouchDrag:6,holdDelay:500,maximumDoubleClickDelay:250,maximumDoubleClickDistance:10,maximumDoubleTouchDelay:350,maximumDoubleTouchDistance:35};function Eh(e,t){return Math.abs(t.x-e.x)+Math.abs(t.y-e.y)}function bz(e,t){let i=t.x-e.x,r=t.y-e.y;return Math.sqrt(i*i+r*r)}function Cz(e,t){if(t?(t.radius=0,t.center.x=0,t.center.y=0):t={radius:0,center:Zi()},e.length===0)return t;if(e.length===1)return t.center.x=e[0].x,t.center.y=e[0].y,t;if(e.length===2){let[E,D]=e,[M,T]=[D.x-E.x,D.y-E.y];return t.radius=Math.sqrt(M*M+T*T)/2,t.center.x=(E.x+D.x)/2,t.center.y=(E.y+D.y)/2,t}let i=0,r=0;for(let E=0;E<e.length;E++)i+=e[E].x,r+=e[E].y;i/=e.length,r/=e.length;let n=e.map(E=>E.x-i),s=e.map(E=>E.y-r),o=0,a=0,l=0,c=0,h=0,p=0,m=0;for(let E=0;E<n.length;E++){let D=n[E],M=s[E],T=D*D,I=M*M;o+=T,a+=I,l+=D*M,c+=T*D,h+=I*M,p+=D*I,m+=M*T}let f=.5*(c+p),g=.5*(h+m),_=o*a-l*l,v=(f*a-g*l)/_,b=(o*g-l*f)/_,x=Zi(v+i,b+r);return{radius:Math.sqrt(v*v+b*b+(o+a)/e.length),center:x}}function ll(e){let{native:t}=e,{pointerId:i,button:r,pointerType:n}=t;return n==="mouse"?`${i}:${r}`:`${n}`}var sT=class extends rt{constructor(t=mr.maximumDoubleClickDelay,i=mr.maximumDoubleClickDistance,r=mr.maximumDoubleTouchDelay,n=mr.maximumDoubleTouchDistance,s=Oa){super(!1),this._maximumDoubleClickDelay=t,this._maximumDoubleClickDistance=i,this._maximumDoubleTouchDelay=r,this._maximumDoubleTouchDistance=n,this._clock=s,this._doubleTapDragReady=!1,this._doubleTapDragActive=!1,this._dragStartCenter=Zi(0,0),this._pointerState=new Map,this._doubleTapDrag=this.registerOutgoing("double-tap-drag"),this._dragEventSeparator=new Io({start:(o,a)=>this._dragStart(o,a),update:(o,a)=>this._dragUpdate(a),end:(o,a)=>this._dragEnd(a)}),this.registerIncoming("drag",o=>this._dragEventSeparator.handle(o)),this.registerIncoming("pointer-down",o=>this._handlePointerDown(o)),this.registerIncoming("pointer-up",()=>this._handlePointerUp())}onUninstall(){this._pointerState.forEach(t=>{t.doubleTapTimeout=Ft(t.doubleTapTimeout)})}get hasPendingInputs(){for(let t of this._pointerState.values())if(t.doubleTapTimeout!=null)return!0;return!1}_clearPointerDown(t){let i=this._pointerState.get(t);i&&(i.doubleTapTimeout=Ft(i.doubleTapTimeout),this._pointerState.delete(t),this.refreshHasPendingInputs())}_dragStart(t,i){if(!this._doubleTapDragReady||t!==1)return;this._doubleTapDragReady=!1,this._doubleTapDragActive=!0;let{data:r,modifiers:n}=i,{center:s}=r;this._dragStartCenter=s;let o=_R("begin",Zi(0,0),r);this._doubleTapDrag.emit(o,void 0,n),i.stopPropagation()}_dragUpdate(t){if(!this._doubleTapDragActive)return;let{data:i,modifiers:r}=t,{center:n}=i,s=_R("update",Zi(n.x-this._dragStartCenter.x,n.y-this._dragStartCenter.y),i);this._doubleTapDrag.emit(s,void 0,r),t.stopPropagation()}_dragEnd(t){if(!this._doubleTapDragActive)return;let{data:i,modifiers:r}=t,{center:n}=i,s=_R("end",Zi(n.x-this._dragStartCenter.x,n.y-this._dragStartCenter.y),i);this._doubleTapDrag.emit(s,void 0,r),this._doubleTapDragActive=!1,t.stopPropagation()}_handlePointerDown(t){let{data:i}=t,r=ll(i),n=this._pointerState.get(r),{pointerType:s}=i.native;if(n){let o=s==="touch"?this._maximumDoubleTouchDistance:this._maximumDoubleClickDistance;this._clearPointerDown(r),Eh(n.event.data,i)>o?this._storePointerDown(t):this._doubleTapDragReady=!0}else this._storePointerDown(t)}_handlePointerUp(){this._doubleTapDragReady=!1}_storePointerDown(t){let{data:i}=t,{pointerType:r}=i.native,n=ll(i),s=r==="touch"?this._maximumDoubleTouchDelay:this._maximumDoubleClickDelay,o=this._clock.setTimeout(()=>this._clearPointerDown(n),s);this._pointerState.set(n,{event:t,doubleTapTimeout:o}),this.refreshHasPendingInputs()}};function _R(e,t,i){let{button:r,buttons:n,pointer:s,pointers:o,pointerType:a,timestamp:l}=i;return{action:e,delta:t,button:r,buttons:n,pointer:s,pointers:o,pointerType:a,timestamp:l}}var pf=class extends rt{constructor(t){super(!1),this._navigationTouch=t,this._startStateModifiers=new Set,this._activePointerMap=new Map,this._isDragging=!1,this._isCurrentDragSuppressed=!1,this._drag=this.registerOutgoing("drag"),this.registerIncoming("pointer-drag",this._handlePointerDrag.bind(this)),this.registerIncoming("pointer-up",this._handlePointerUpAndPointerLost.bind(this)),this.registerIncoming("pointer-capture-lost",this._handlePointerUpAndPointerLost.bind(this)),this.registerIncoming("pointer-cancel",this._handlePointerUpAndPointerLost.bind(this))}_createPayload(t,i,r,n){return{action:t,pointerType:this._pointerType,button:this._mouseButton,buttons:i.buttons,timestamp:n,pointers:mK(this._activePointerMap),pointer:i,angle:r.angle,radius:r.radius,center:r.center}}_addPointer(t){let i=t.native.pointerId,r=oT(this._activePointerMap).angle,n={event:t,initialAngle:0,lastAngle:0};this._activePointerMap.set(i,n);let s=aT(n,Ez(this._activePointerMap));n.initialAngle=s,n.lastAngle=s,this._updatePointerAngles(r)}_updatePointer(t){if(t&&t.x==null&&t.y==null)return;let i=t.native.pointerId,r=this._activePointerMap.get(i);r?r.event=t:this._addPointer(t)}_removePointer(t){let i=oT(this._activePointerMap).angle;this._activePointerMap.delete(t),this._updatePointerAngles(i)}_updatePointerAngles(t){let i=oT(this._activePointerMap);this._activePointerMap.forEach(r=>{r.initialAngle=aT(r,i)-t,r.lastAngle=aT(r,i)-t})}_emitEvent(t,i,r){let n=oT(this._activePointerMap);this._drag.emit(this._createPayload(t,i,n,r),void 0,this._startStateModifiers)}_handlePointerUpAndPointerLost(t){let i=t.data.native.pointerId,r=t.timestamp;this._activePointerMap.get(i)&&(this._activePointerMap.size===1?(this._updatePointer(t.data),!this._isCurrentDragSuppressed&&this._emitEvent("end",t.data,r),this._isDragging=!1,this._isCurrentDragSuppressed=!1,this._removePointer(i)):(this._removePointer(i),this._emitEvent("removed",t.data,t.timestamp)))}_handlePointerDrag(t){let i=t.data,r=i.currentEvent,n=t.timestamp;switch(i.action){case"start":case"update":this._isDragging?this._activePointerMap.has(r.native.pointerId)?(this._updatePointer(r),!this._isCurrentDragSuppressed&&this._emitEvent("update",r,n)):(this._addPointer(r),this._emitEvent("added",r,n),this._isCurrentDragSuppressed=this._isSuppressed):(this._updatePointer(r),this._pointerType=t.data.startEvent.pointerType,this._mouseButton=t.data.startEvent.button,this._startStateModifiers=t.modifiers,this._isDragging=!0,this._isCurrentDragSuppressed=this._isSuppressed,!this._isCurrentDragSuppressed&&this._emitEvent("start",r,n))}}get _isSuppressed(){return!!this._navigationTouch&&!this._navigationTouch.browserTouchPanEnabled&&this._pointerType==="touch"&&this._activePointerMap.size===1}};function Ez(e){let t=[];return e.forEach(i=>{t.push(Zi(i.event.x,i.event.y))}),Cz(t)}function oT(e){let t=Ez(e),i=0;return e.forEach(r=>{let n=aT(r,t),s=n-r.lastAngle;for(;s>Math.PI;)s-=2*Math.PI;for(;s<-Math.PI;)s+=2*Math.PI;n=r.lastAngle+s,r.lastAngle=n;let o=n-r.initialAngle;i+=o}),i/=e.size||1,{angle:i,radius:t.radius,center:t.center}}function mK(e){let t=new Map;return e.forEach((i,r)=>t.set(r,i.event)),t}function aT(e,t){let i=e.event,r=i.x-t.center.x,n=i.y-t.center.y;return Math.atan2(n,r)}var Tz;(function(e){e[e.Left=0]="Left",e[e.Middle=1]="Middle",e[e.Right=2]="Right",e[e.Back=3]="Back",e[e.Forward=4]="Forward",e[e.Undefined=-1]="Undefined"})(Tz||(Tz={}));var mf=class extends rt{constructor(t=mr.maximumDoubleClickDelay,i=mr.maximumDoubleClickDistance,r=mr.maximumDoubleTouchDelay,n=mr.maximumDoubleTouchDistance,s=Oa){super(!1),this._maximumDoubleClickDelay=t,this._maximumDoubleClickDistance=i,this._maximumDoubleTouchDelay=r,this._maximumDoubleTouchDistance=n,this._clock=s,this._pointerState=new Map,this._immediateDoubleClick=this.registerOutgoing("immediate-double-click"),this.registerIncoming("pointer-down",this._handlePointerDown.bind(this)),this.registerIncoming("pointer-up",this._handlePointerUp.bind(this))}onUninstall(){this._pointerState.forEach(t=>{t.immediateDoubleClick&&t.immediateDoubleClick.timeoutHandle.remove()}),super.onUninstall()}_handlePointerDown(t){let i=t.data,r=ll(i);if(!this._pointerState.has(r)){let n={downButton:i.native.button,x:i.x,y:i.y,immediateDoubleClick:null};this._pointerState.set(r,n),this.startCapturingPointer(i.native)}}_handlePointerUp(t){let i=t.data,r=ll(i),n=this._pointerState.get(r);if(n&&n.downButton===i.native.button){let s=n.immediateDoubleClick,o=t.data.native.pointerType==="touch"?this._maximumDoubleTouchDistance:this._maximumDoubleClickDistance;s?(s.timeoutHandle.remove(),Eh(s,t.data)>o?this._startImmediateDoubleClick(t,n):(this._immediateDoubleClick.emit(t.data,void 0,s.modifiers),this._removeState(i))):Eh(n,t.data)>o?this._removeState(i):this._startImmediateDoubleClick(t,n)}}_startImmediateDoubleClick(t,i){let r=t.data.native.pointerType==="touch"?this._maximumDoubleTouchDelay:this._maximumDoubleClickDelay;i.immediateDoubleClick={x:t.data.x,y:t.data.y,modifiers:t.modifiers,timeoutHandle:this._clock.setTimeout(()=>this._removeState(t.data),r)}}_removeState(t){let i=ll(t);this._pointerState.delete(i),this.stopCapturingPointer(t.native),this.refreshHasPendingInputs()}};var ff=class extends rt{constructor(t=mr.maximumClickDelay,i=mr.movementUntilMouseDrag,r=mr.movementUntilPenDrag,n=mr.movementUntilTouchDrag,s=mr.holdDelay,o=Oa){super(!1),this._maximumClickDelay=t,this._movementUntilMouseDrag=i,this._movementUntilPenDrag=r,this._movementUntilTouchDrag=n,this._holdDelay=s,this._clock=o,this._pointerState=new Map,this._pointerDrag=this.registerOutgoing("pointer-drag"),this._immediateClick=this.registerOutgoing("immediate-click"),this._pointerHold=this.registerOutgoing("hold"),this.registerIncoming("pointer-down",a=>this._handlePointerDown(a)),this.registerIncoming("pointer-up",a=>this._handlePointerLoss(a,"pointer-up")),this.registerIncoming("pointer-capture-lost",a=>this._handlePointerLoss(a,"pointer-capture-lost")),this.registerIncoming("pointer-cancel",a=>this._handlePointerLoss(a,"pointer-cancel")),this._moveHandle=this.registerIncoming("pointer-move",a=>this._handlePointerMove(a)),this._moveHandle.pause()}onUninstall(){this._pointerState.forEach(t=>{t.holdTimeout=Ft(t.holdTimeout)}),super.onUninstall()}_handlePointerDown(t){let i=t.data,r=i.native.pointerId,n=null;this._pointerState.size===0&&(n=this._clock.setTimeout(()=>{let o=this._pointerState.get(r);if(o){if(!o.isDragging){let a=o.previousEvent;this._pointerHold.emit(a,void 0,t.modifiers),o.holdEmitted=!0}o.holdTimeout=null}},this._holdDelay));let s={startEvent:i,previousEvent:i,startTimestamp:t.timestamp,isDragging:!1,downButton:i.native.button,holdTimeout:n,modifiers:new Set};this._pointerState.set(r,s),this.startCapturingPointer(i.native),this._moveHandle.resume(),this._pointerState.size>1&&this._startDragging(t)}_handlePointerMove(t){let i=t.data,r=i.native.pointerId,n=this._pointerState.get(r);n&&(n.isDragging?this._pointerDrag.emit(lT("update",n,i),void 0,n.modifiers):bz(i,n.startEvent)>this._getDragThreshold(i.native.pointerType)&&this._startDragging(t),n.previousEvent=i)}_getDragThreshold(t){switch(t){case"touch":return this._movementUntilTouchDrag;case"pen":return this._movementUntilPenDrag;default:return this._movementUntilMouseDrag}}_startDragging(t){let i=t.data,r=i.native.pointerId;this._pointerState.forEach(n=>{n.holdTimeout!=null&&(n.holdTimeout.remove(),n.holdTimeout=null),n.isDragging||(n.modifiers=t.modifiers,n.isDragging=!0,r===n.startEvent.native.pointerId?this._pointerDrag.emit(lT("start",n,i)):this._pointerDrag.emit(lT("start",n,n.previousEvent),t.timestamp))})}_handlePointerLoss(t,i){let r=t.data,n=r.native.pointerId,s=this._pointerState.get(n);s&&(s.holdTimeout!=null&&(s.holdTimeout.remove(),s.holdTimeout=null),s.isDragging?this._pointerDrag.emit(lT("end",s,i==="pointer-up"?r:s.previousEvent),void 0,s.modifiers):i==="pointer-up"&&s.downButton===r.native.button&&t.timestamp-s.startTimestamp<=this._maximumClickDelay&&!s.holdEmitted&&this._immediateClick.emit(r),this._pointerState.delete(n),this.stopCapturingPointer(r.native),this._pointerState.size===0&&this._moveHandle.pause())}};function lT(e,t,i){return{action:e,startEvent:t.startEvent,previousEvent:t.previousEvent,currentEvent:i}}var gf=class extends rt{constructor(t=mr.maximumDoubleClickDelay,i=mr.maximumDoubleClickDistance,r=mr.maximumDoubleTouchDelay,n=mr.maximumDoubleTouchDistance,s=Oa){super(!1),this._maximumDoubleClickDelay=t,this._maximumDoubleClickDistance=i,this._maximumDoubleTouchDelay=r,this._maximumDoubleTouchDistance=n,this._clock=s,this._pointerState=new Map,this._click=this.registerOutgoing("click"),this._doubleClick=this.registerOutgoing("double-click"),this.registerIncoming("immediate-click",o=>this._handleImmediateClick(o)),this.registerIncoming("pointer-down",o=>this._handlePointerDown(o))}onUninstall(){this._pointerState.forEach(t=>t.doubleClickTimer=Ft(t.doubleClickTimer))}get hasPendingInputs(){for(let t of this._pointerState.values())if(t.doubleClickTimer!=null)return!0;return!1}_clearDoubleClickTimer(t,i){let r=this._pointerState.get(t);r&&(r.doubleClickTimer=Ft(r.doubleClickTimer),i&&this._click.emit(r.event.data,void 0,r.event.modifiers),this._pointerState.delete(t),this.refreshHasPendingInputs())}_doubleClickTimeoutExceeded(t){let i=this._pointerState.get(t);i.pointerDownCount===1&&this._click.emit(i.event.data,void 0,i.event.modifiers),i.doubleClickTimer=null,this._pointerState.delete(t),this.refreshHasPendingInputs()}_handleImmediateClick(t){let i=t.data,{pointerType:r}=i.native,n=fK(i);if(!this._pointerState.has(n))return void this._startClick(t);let s=this._pointerState.get(n),{data:o,modifiers:a}=s.event,l=r==="touch"?this._maximumDoubleTouchDistance:this._maximumDoubleClickDistance;Eh(o,i)>l?(this._clearDoubleClickTimer(n,!0),this._startClick(t)):(this._clearDoubleClickTimer(n,!1),s.pointerDownCount===2&&this._doubleClick.emit(o,void 0,a))}_handlePointerDown(t){let i=ll(t.data),r=this._pointerState.get(i);r&&(r.pointerDownCount+=1)}_startClick(t){let{data:i}=t,{native:{pointerType:r}}=i,n=ll(i),s=r==="touch"?this._maximumDoubleTouchDelay:this._maximumDoubleClickDelay,o=this._clock.setTimeout(()=>this._doubleClickTimeoutExceeded(n),s);this._pointerState.set(n,{event:t,doubleClickTimer:o,pointerDownCount:1}),this.refreshHasPendingInputs()}};function fK(e){let{pointerId:t,pointerType:i,button:r}=e.native;return i==="mouse"?`${t}:${r}`:`${i}`}var cT={counter:"Control",pan:{left:"ArrowLeft",right:"ArrowRight",up:"ArrowUp",down:"ArrowDown"},zoom:{zoomIn:["=","+"],zoomOut:["-","_"]},rotate:{clockwise:["a","A"],counterClockwise:["d","D"],reset:["n","N"]}},Dz=Symbol("handles"),Dh=class extends P{initialize(){let e=()=>this.view?.ready;this.addHandles([Wi(()=>!e(),()=>this._disconnect()),Wi(e,()=>this._connect())])}destroy(){this._disconnect()}get latestPointerType(){return this._inputManager?.latestPointerType}get latestPointerLocation(){return this._inputManager?.latestPointerLocation}get multiTouchActive(){return this._inputManager?.multiTouchActive??!1}isModifierKeyDown(e){return this._inputManager?.isModifierKeyDown(e)??!1}_disconnect(){this.view.viewEvents.disconnect(),this.removeHandles(Dz),this._inputManager=G(this._inputManager)}_connect(){let e=this.view.surface,t=new nT(e,this.view.input),i=[new mf,new ff,new gf,new pf(this.view.navigation),new sT],r=new rw({eventSource:t,recognizers:i}),n=new QC(this.view,["primary"]),s=new YC(this.view,["secondary"]);r.installHandlers("prevent-context-menu",[new hf],qa.INTERNAL),r.installHandlers("navigation",[new iT(this.view),new KC(this.view),new tT(this.view),new hy(this.view),new hy(this.view,[cT.counter]),n,new XC(this.view,cT.pan),new eT(this.view,cT.zoom),new JC(this.view,cT.rotate),s,new ZC(this.view,"touch")],qa.INTERNAL),this.view.viewEvents.connect(r),this._source=t,this._inputManager=r,this.addHandles([S(()=>this.view?.navigation?.browserTouchPanEnabled,o=>{this._source&&(this._source.browserTouchPanningEnabled=!o)},Re),S(()=>{let{actionMap:o}=this.view.navigation;return{panActions:Th("pan",o),rotateActions:Th("rotate",o)}},({panActions:o,rotateActions:a})=>{n.pointerActions=o,s.pointerActions=a},Ce)],Dz)}get test(){}};u([d()],Dh.prototype,"view",void 0),u([d()],Dh.prototype,"latestPointerType",null),u([d()],Dh.prototype,"latestPointerLocation",null),u([d()],Dh.prototype,"multiTouchActive",null),Dh=u([C("esri.views.2d.input.MapViewInputManager")],Dh);var xz=Dh;var Mz=160,_f=class extends P{constructor(){super(...arguments),this._timer=void 0}get stationary(){return!this._timer}flip(){this._timestamp=performance.now(),this._timer==null&&(this._timer=setInterval(()=>{performance.now()-this._timestamp>=Mz&&this.clear()},Mz))}clear(){this._timer&&(clearInterval(this._timer),this._timer=void 0)}};u([d()],_f.prototype,"_timer",void 0),u([d()],_f.prototype,"stationary",null),_f=u([C("esri.views.2d.support.StationaryManager")],_f);var Sz=e=>{let t=class extends e{constructor(...i){super(...i),this.fullOpacity=1,this.stateManager=new an({constraints:new pR({view:this})}),this.goToManager=new cy({view:this}),this.stationaryManager=new _f,this.mapViewNavigation=null,this.renderingOptions={samplingMode:"dynamic",edgeLabelsVisible:!1,labelsAnimationTime:0,labelCollisionsEnabled:!1},this.frameTask=new WC(this),this.inputManager=new xz({view:this}),this.viewEvents=new aw(this),this.padding={top:0,right:0,bottom:0,left:0},this.addHandles([S(()=>this.viewpoint,()=>this.stationaryManager.flip(),Fe),this.on("resize",r=>this.stateManager.resize(r.width,r.height))])}get constraintsInfo(){return{lods:null,spatialReference:null}}get extent(){return this.stateManager?.extent??null}set extent(i){this.stateManager.extent=i}get state(){return this.stateManager.state}get interacting(){return this.navigating}get stationary(){return!this.animation&&!this.navigating&&!this.resizing&&this.stationaryManager.stationary}set animation(i){let r=this._get("animation");if(i===r)return;if(r&&r.stop(),i!==this.animationManager.animation&&this.animationManager.stop(),!i||i.isFulfilled())return void this._set("animation",null);this._set("animation",i);let n=()=>{this.destroyed||i===this._get("animation")&&(this._set("animation",null),this.frameTask?.requestFrame())};i.when(n,n)}get constraints(){return this.stateManager?.constraints}set constraints(i){i.view=this;let r=this.stateManager.constraints;this.stateManager.constraints=i,r?.destroy()}get padding(){return this.stateManager?.padding}set padding(i){this.stateManager&&(this.stateManager.padding=i)}get resizeAlign(){return this.stateManager.resizeAlign}set resizeAlign(i){this.stateManager.resizeAlign=i}get rotation(){return this.stateManager.rotation??0}set rotation(i){let{rotationEnabled:r}=this.constraints;this.constraints.rotationEnabled=!0,this.stateManager.rotation=i,this.constraints.rotationEnabled=r}get viewpoint(){return this.stateManager.viewpoint??null}set viewpoint(i){this.stateManager.viewpoint=i,this.frameTask.requestFrame()}on(i,r,n,s){return this.inputManager&&this.viewEvents.on(i,r,n,s)||super.on(i,r)}hasEventListener(i){return super.hasEventListener(i)||this.viewEvents.hasHandler(i)}goTo(i,r){return this.goToManager.goTo(i,r)}};return u([d({readOnly:!0})],t.prototype,"animationManager",void 0),u([d({readOnly:!0})],t.prototype,"fullOpacity",void 0),u([d()],t.prototype,"stateManager",void 0),u([d()],t.prototype,"constraintsInfo",null),u([d()],t.prototype,"extent",null),u([d()],t.prototype,"goToManager",void 0),u([d({readOnly:!0})],t.prototype,"state",null),u([d({readOnly:!0})],t.prototype,"mapViewNavigation",void 0),u([d()],t.prototype,"renderingOptions",void 0),u([d({readOnly:!0})],t.prototype,"interacting",null),u([d()],t.prototype,"stationary",null),u([d()],t.prototype,"animation",null),u([d({type:pR})],t.prototype,"constraints",null),u([d({readOnly:!0})],t.prototype,"inputManager",void 0),u([d()],t.prototype,"padding",null),u([d()],t.prototype,"resizeAlign",null),u([d()],t.prototype,"rotation",null),u([d({readOnly:!0})],t.prototype,"viewEvents",void 0),u([d({type:Si})],t.prototype,"viewpoint",null),t=u([C("esri.views.Viewport2DMixin")],t),t};var my=class{constructor(t){this._view=t,this.viewpoint=new Si({targetGeometry:new pt,scale:0,rotation:0})}get view(){return this._view}get size(){let[t,i]=this._view.size;return Math.sqrt(t*t+i*i)}get scale(){return this.viewpoint.scale}get rotation(){return this.viewpoint.rotation}get center(){return this.viewpoint.targetGeometry}get scaleToResolutionFactor(){return Ok(this.center.spatialReference)}pixelsPerPanAtZoom(t){return 1/(t*this.scaleToResolutionFactor)}zoomAtPixelsPerPan(t){return 1/(t*this.scaleToResolutionFactor)}pixelsPerRotate(){return this.size/2}compareTo(t,i){i.pan=E2(this.center,t.center);let r=Math.abs(t.rotation-this.rotation);r=r>=180?360-r:r,i.rotate=kt(r),i.sourceZoom=this.scale,i.targetZoom=t.scale}interpolate(t,i,r){let{pan:n,rotate:s,zoom:o,zoomOffset:a}=r,{center:l}=this;l.spatialReference=t.center.spatialReference,l.x=Xe(t.center.x,i.center.x,n),l.y=Xe(t.center.y,i.center.y,n),this.viewpoint.scale=Xe(t.scale,i.scale+a,o);let c=t.rotation,h=i.rotation;Math.abs(h-c)>=180&&(c+=360*(c<h?1:-1)),this.viewpoint.rotation=Xe(c,h,s)}copyFrom(t){go(this.viewpoint,t.viewpoint),this._view=t.view}};var gK=e=>e,fy=e=>e*e,uT=e=>1-fy(1-e),_K=e=>e<.5?fy(2*e)/2:(uT(2*(e-.5))+1)/2,yR=e=>e*e*e,Iz=e=>1-yR(1-e),vR=e=>e<.5?yR(2*e)/2:(Iz(2*(e-.5))+1)/2,wR=e=>e*e*e*e,Az=e=>1-wR(1-e),yK=e=>e<.5?wR(2*e)/2:(Az(2*(e-.5))+1)/2,bR=e=>e*e*e*e*e,Rz=e=>1-bR(1-e),vK=e=>e<.5?bR(2*e)/2:(Rz(2*(e-.5))+1)/2,CR=e=>1-Math.cos(e*Math.PI/2),Pz=e=>1-CR(1-e),wK=e=>e<.5?CR(2*e)/2:(Pz(2*(e-.5))+1)/2,TR=e=>2**(10*(e-1)),Lu=e=>1-TR(1-e),bK=e=>e<.5?TR(2*e)/2:(Lu(2*(e-.5))+1)/2,ER=e=>-(Math.sqrt(1-e*e)-1),Oz=e=>1-ER(1-e),CK=e=>e<.5?ER(2*e)/2:(Oz(2*(e-.5))+1)/2;function Ao(e){let t=2*(e-Math.sqrt((e-1)*e)),i=t/2/e;return r=>r<i?e*r*r:t*r-t+1}function Ro(e,t){return(i,r)=>i<t?t*e(i/t,r):1-e((1-i)/(1-t),r)*(1-t)}var TK=Ro(Ao(1),1),EK=Ro(Ao(1),0),dT=Ro(Ao(1),.5),DK=Ro(Ao(2),1),xK=Ro(Ao(2),0),MK=Ro(Ao(2),.5),SK=Ro(Ao(3),1),IK=Ro(Ao(3),0),AK=Ro(Ao(3),.5),RK=Ro(Ao(4),1),PK=Ro(Ao(4),0),OK=Ro(Ao(4),.5),gy={linear:gK,"in-quad":fy,"out-quad":uT,"in-out-quad":_K,"in-coast-quad":TK,"out-coast-quad":EK,"in-out-coast-quad":dT,"in-cubic":yR,"out-cubic":Iz,"in-out-cubic":vR,"in-coast-cubic":DK,"out-coast-cubic":xK,"in-out-coast-cubic":MK,"in-quart":wR,"out-quart":Az,"in-out-quart":yK,"in-coast-quart":SK,"out-coast-quart":IK,"in-out-coast-quart":AK,"in-quint":bR,"out-quint":Rz,"in-out-quint":vK,"in-coast-quint":RK,"out-coast-quint":PK,"in-out-coast-quint":OK,"in-sine":CR,"out-sine":Pz,"in-out-sine":wK,"in-expo":TR,"out-expo":Lu,"in-out-expo":bK,"in-circ":ER,"out-circ":Oz,"in-out-circ":CK,ease:e=>qg.ease(e),"ease-in":e=>qg.easeIn(e),"ease-out":e=>qg.easeOut(e),"ease-in-out":e=>qg.easeInOut(e)};var hT=class{constructor(){this.pan=0,this.rotate=0,this.fov=0,this.sourceZoom=0,this.targetZoom=0}};var xh={desiredScreenFlow:2,minDuration:500,maxDuration:8e3},DR=be(ie({},xh),{maxDuration:4e3});var pT=class e{constructor(t){this._createCamera=t,this.compared=new hT,this.segmentStart=0,this.segmentEnd=1,this.settings={desiredScreenFlow:xh.desiredScreenFlow},this.source=t(),this.target=t()}clone(){let t=new e(this._createCamera);return t.copyFrom(this),t}copyFrom(t){this.update(t.source,t.target,t.settings)}update(t,i,r){this.source!==t&&this.source.copyFrom(t),this.target!==i&&this.target.copyFrom(i),this.source.compareTo(this.target,this.compared),this.settings.desiredScreenFlow=r.desiredScreenFlow??xh.desiredScreenFlow,this.desiredPixelFlow=this.settings.desiredScreenFlow*this.target.size,this.halfWindowSize=this.target.size/2}halfWindowPanAtZoom(t){let i=this.target.pixelsPerPanAtZoom(t);return this.halfWindowSize/i}get hasZoom(){return Math.abs(this.compared.sourceZoom-this.compared.targetZoom)>1e-5}get hasPan(){return this.compared.pan>_0()}get hasFov(){return Math.abs(this.compared.fov)>_0()}get hasRotate(){return this.compared.rotate>_0()}};var mT=class{constructor(){this.pan=0,this.rotate=0,this.zoom=0,this.fov=0,this.zoomOffset=0}};var Lz=class{constructor(){this.segments=new Array}get time(){return this.segments.reduce((e,t)=>e+t.time,0)}interpolateComponentsAt(e,t){e=Math.min(Math.max(e,0),1),e*=this.time;let i=0,r=0,n=this.definition,s=this.segments.reduce((o,a)=>o||a.definition.hasZoom,!1);for(let o=0;o<this.segments.length;o++){let a=this.segments[o],l=a.definition;if(e<=a.time||o===this.segments.length-1){if(this.segmentInterpolateComponentsAt(a,a.time===0?0:e/a.time,t),n.hasPan&&!isNaN(t.pan)&&isFinite(n.compared.pan)?t.pan=(i+l.compared.pan*t.pan)/n.compared.pan:t.pan=1,n.hasRotate&&!isNaN(t.rotate)&&isFinite(n.compared.rotate)?t.rotate=(r+l.compared.rotate*t.rotate)/n.compared.rotate:t.rotate=1,s&&!isNaN(t.zoom)&&isFinite(l.compared.targetZoom)){let{sourceZoom:c,targetZoom:h}=l.compared,p=t.zoom*(h-c)+c,m=this.segments[0].definition.compared.sourceZoom,f=this.segments[this.segments.length-1].definition.compared.targetZoom,g=Math.abs(h-m)>Math.abs(c-m)?h:c;t.zoomOffset=g-f,t.zoom=(p-m)/(g-m)}else t.zoom=1;return t}e-=a.time,i+=l.compared.pan,r+=l.compared.rotate}}segmentInterpolateComponentsAt(e,t,i){e.interpolateComponentsAt(t,i)}};var yf=class{get time(){return this._time}constructor(t){t&&this.update(t)}update(t){t&&(this.definition?this.definition.copyFrom(t):this.definition=t.clone()),this._updatePrecomputedVariables(),this._updatePixelFlow()}_updatePrecomputedVariables(){let t=this.definition,i=t.compared,r=i.sourceZoom,n=i.targetZoom;this._zoomSign=r>n?1:-1,this._panPixelsAtSource=i.pan*t.source.pixelsPerPanAtZoom(r);let s=(t.source.pixelsPerRotate()+t.target.pixelsPerRotate())/2;this._rotatePixels=i.rotate*s}_updatePixelFlow(){let t=this.definition.compared.sourceZoom,i=this.definition.compared.targetZoom,{hasZoom:r,hasPan:n,hasRotate:s}=this.definition,o=0,a=0;r&&(n&&(o=(i/t-1)/(-1/(this._zoomSign*this.definition.halfWindowSize)*Math.LN2*this._panPixelsAtSource)),s&&(a=this._zoomSign*(Math.log(t/i)/Math.LN2)*this.definition.halfWindowSize/this._rotatePixels)),this._zoomPixelFlow=0,this._panPixelFlow=0,this._rotatePixelFlow=0;let l=this.definition.desiredPixelFlow;if(r&&n&&s){let c=o+a+o*a;this._zoomPixelFlow=o*a/c*l,this._panPixelFlow=a/c*l,this._rotatePixelFlow=o/c*l}else if(r&&n){let c=1+o;this._zoomPixelFlow=o/c*l,this._panPixelFlow=1/c*l}else if(r&&s){let c=1+a;this._zoomPixelFlow=a/c*l,this._rotatePixelFlow=1/c*l}else if(n&&s){let c=this._panPixelsAtSource/this._rotatePixels,h=1+c;this._panPixelFlow=c/h*l,this._rotatePixelFlow=1/h*l}else n?this._panPixelFlow=l:r?this._zoomPixelFlow=l:s&&(this._rotatePixelFlow=l);if(this._time=Math.max(this.rotateTime,this.zoomTime,this.panTime),this.fovTime>this._time){let c=this.fovTime/this._time;this._time=this.fovTime,this._zoomPixelFlow/=c,this._panPixelFlow/=c,this._rotatePixelFlow/=c}}get rotateTime(){return this.definition.hasRotate?this._rotatePixels/this._rotatePixelFlow:0}get zoomTime(){return this.definition.hasZoom?this._zoomSign*(Math.log(this.definition.compared.sourceZoom/this.definition.compared.targetZoom)/Math.LN2)*this.definition.halfWindowSize/this._zoomPixelFlow:0}get fovTime(){return this.definition.hasFov?Math.abs(this.definition.compared.fov)/NK:0}get panTime(){if(!this.definition.hasPan)return 0;if(this.definition.hasZoom){let t=-1/(this._zoomSign*this.definition.halfWindowSize)*Math.LN2,i=t*this._panPixelsAtSource;return Math.log(i*(this._zoomPixelFlow/this._panPixelFlow)+1)/(t*this._zoomPixelFlow)}return this._panPixelsAtSource/this._panPixelFlow}_interpolateComponentsZoom(t){if(t===0||t===1)return t;if(this.definition.hasZoom){let i=this.definition.compared.sourceZoom,r=this.definition.compared.targetZoom;return(i*(i/r)**-t-i)/(r-i)}return t}_interpolateComponentsFov(t){if(t===0)return this.definition.segmentStart;if(t===1)return this.definition.segmentEnd;if(this.definition.hasFov){let{segmentStart:i,segmentEnd:r}=this.definition;return i+t*(r-i)}return this.definition.segmentStart}_interpolateComponentsPan(t){if(t===0||t===1)return t;if(this.definition.hasPan&&this.definition.hasZoom){let i=-1/(this._zoomSign*this.definition.halfWindowSize)*this._zoomPixelFlow;return 1/this._panPixelsAtSource*(this._panPixelFlow*(2**(i*t*this._time)-1))/(i*Math.LN2)}return t}_interpolateComponentsRotate(t){return t}interpolateComponentsAt(t,i){t=Math.min(Math.max(t,0),1),i.zoom=this._interpolateComponentsZoom(t),i.pan=this._interpolateComponentsPan(t),i.rotate=this._interpolateComponentsRotate(t),i.zoomOffset=0,i.fov=this._interpolateComponentsFov(t)}},NK=kt(45);function Fz(e,t,i){let r=t-e.compared.sourceZoom,n=e.halfWindowPanAtZoom(r);return-e.halfWindowSize*(i.ascensionFactor*Math.LN2*e.compared.pan+n)*Math.log(e.compared.sourceZoom/t)/(e.desiredPixelFlow*Math.LN2*n)}function kz(e,t,i){let r=1/t,n=Math.log(e.compared.sourceZoom*r),s=1/e.desiredPixelFlow,o=1/Math.LN2,a=t-e.compared.sourceZoom,l=1/a,c=(i.ascensionFactor*Math.LN2*e.compared.pan+e.halfWindowPanAtZoom(a))/e.halfWindowPanAtZoom(1);return e.halfWindowSize*r*s*o*l*c-e.halfWindowSize*n*s*o*l+e.halfWindowSize*n*s*o*c/(a*a)}function Vz(e,t,i){let r=t-e.compared.sourceZoom,n=1/r,s=1/t,o=Math.log(e.compared.sourceZoom*s),a=(i.ascensionFactor*Math.LN2*e.compared.pan+e.halfWindowPanAtZoom(r))/e.halfWindowPanAtZoom(1);return e.halfWindowSize*n*(-2*n*s*a+2*n*o+2*s-2*o*a/(r*r)-a/(t*t))/(e.desiredPixelFlow*Math.LN2)}function Hz(e,t){return-e.halfWindowSize*Math.log(e.compared.sourceZoom/t)/(e.desiredPixelFlow*Math.LN2)}function Bz(e,t){return e.halfWindowSize/(t*e.desiredPixelFlow*Math.LN2)}function Uz(e,t){return-e.halfWindowSize/(t*t*e.desiredPixelFlow*Math.LN2)}function jz(e,t,i){return-e.compared.pan*e.halfWindowSize*(i.ascensionFactor+i.descensionFactor-1)/(e.desiredPixelFlow*e.halfWindowPanAtZoom(t))}function zz(e,t,i){return e.compared.pan*e.halfWindowSize*(i.ascensionFactor+i.descensionFactor-1)/(e.desiredPixelFlow*e.halfWindowPanAtZoom(t*t))}function Gz(e,t,i){return-2*e.compared.pan*e.halfWindowSize*(i.ascensionFactor+i.descensionFactor-1)/(e.desiredPixelFlow*e.halfWindowPanAtZoom(t*t*t))}function qz(e,t,i){return e.halfWindowSize*(-e.halfWindowPanAtZoom(t)-i.descensionFactor*Math.LN2*e.compared.pan+e.halfWindowPanAtZoom(e.compared.targetZoom))*Math.log(t/e.compared.targetZoom)/(e.desiredPixelFlow*Math.LN2*e.halfWindowPanAtZoom(-t+e.compared.targetZoom))}function Wz(e,t,i){let r=Math.log(t/e.compared.targetZoom),n=1/e.desiredPixelFlow,s=1/Math.LN2,o=-t+e.compared.targetZoom,a=1/o,l=(-e.halfWindowPanAtZoom(t)-i.descensionFactor*Math.LN2*e.compared.pan+e.halfWindowPanAtZoom(e.compared.targetZoom))/e.halfWindowPanAtZoom(1);return-e.halfWindowSize*r*n*s*a+e.halfWindowSize*r*n*s*l/(o*o)+e.halfWindowSize*n*s*a*l/t}function $z(e,t,i){let r=t-e.compared.targetZoom,n=1/r,s=1/t,o=Math.log(t/e.compared.targetZoom),a=(e.halfWindowPanAtZoom(t)+i.descensionFactor*Math.LN2*e.compared.pan-e.halfWindowPanAtZoom(e.compared.targetZoom))/e.halfWindowPanAtZoom(1);return e.halfWindowSize*n*(-2*n*s*a-2*n*o+2*s+2*o*a/(r*r)-a/(t*t))/(e.desiredPixelFlow*Math.LN2)}function Zz(e,t){return e.halfWindowSize*Math.log(t/e.compared.targetZoom)/(e.desiredPixelFlow*Math.LN2)}function Qz(e,t){return e.halfWindowSize/(t*e.desiredPixelFlow*Math.LN2)}function Yz(e,t){return-e.halfWindowSize/(t*t*e.desiredPixelFlow*Math.LN2)}function Kz(e){let t=e.compared.sourceZoom-e.compared.targetZoom;if(t===0)return e.compared.pan*e.halfWindowSize/(e.desiredPixelFlow*e.halfWindowPanAtZoom(e.compared.sourceZoom));let i=Math.LN2*e.compared.pan,r=t,n=e.halfWindowPanAtZoom(r),s=e.halfWindowSize*Math.log(e.compared.sourceZoom/e.compared.targetZoom)/(e.desiredPixelFlow*Math.LN2*n);return e.compared.sourceZoom<=e.compared.targetZoom?s*(i-n):s*(i+n)}function Xz(e,t){let i=LK(e,t),r={ascensionFactor:t.ascensionFactor!=null?t.ascensionFactor:.5,descensionFactor:t.descensionFactor!=null?t.descensionFactor:.5},n=r.ascensionFactor===0,s=r.descensionFactor===0,o=n?Hz:Fz,a=n?Bz:kz,l=n?Uz:Vz,c=s?Zz:qz,h=s?Qz:Wz,p=s?Yz:$z,m=D=>o(e,D,r)+jz(e,D,r)+c(e,D,r),f=D=>a(e,D,r)+zz(e,D,r)+h(e,D,r),g=D=>l(e,D,r)+Gz(e,D,r)+p(e,D,r),_=m(i),v=Kz(e),b,x=t.maximumIterations||20,E=t.maximumDistance!=null?t.maximumDistance:1/0;for(b=0;b<x;b++){let D=t.desiredSlope??1e-6,M=f(i);Math.abs(M)>D&&(M+=D);let T=M/g(i);if(isNaN(T)||i>=E&&T<0){if(!isFinite(E))return null;i=E,_=m(i);break}if(i-=T,i<e.compared.sourceZoom||i<e.compared.targetZoom)return null;let I=m(i);if(Math.abs(I-_)/_<=.005)break;_=I}return _>v*(1-.3)||i<e.compared.sourceZoom||i<e.compared.targetZoom?null:i}function LK(e,t){let i=Math.max(e.compared.sourceZoom,e.compared.targetZoom),r=e.source.zoomAtPixelsPerPan(e.desiredPixelFlow/e.compared.pan)/2;return r<i?t.maximumDistance!=null?i+(t.maximumDistance-i)/2:1.5*i:t.maximumDistance?Math.min(t.maximumDistance,r):r}var fT=class extends Lz{constructor(t,i){super(),this._preallocSegments=[new yf,new yf,new yf],this._ascensionSegment=null,this._descensionSegment=null,this.update(t,i)}update(t,i){if(!t)return;this.definition?this.definition.copyFrom(t):this.definition=t.clone();let r=i?.apex?Xz(t,i.apex):null;this.segments.length=0,this._ascensionSegment=null,this._descensionSegment=null,r?this._updateWithApex(r,i?.apex):this._updateWithoutApex()}segmentInterpolateComponentsAt(t,i,r){t.interpolateComponentsAt(i,r),t===this._ascensionSegment?r.zoom=uT(r.zoom):t===this._descensionSegment&&(r.zoom=fy(r.zoom))}_updateWithApex(t,i){let[r,n,s]=this._preallocSegments,o=i?.ascensionFactor??.5,a=Math.min(1-o,i?.ascensionFactor!=null&&i.descensionFactor!=null?i.descensionFactor:.5),l=1-o-a;r.definition?r.definition.copyFrom(this.definition):r.definition=this.definition.clone(),r.definition.compared.targetZoom=t,r.definition.compared.pan=this.definition.compared.pan*o,r.definition.compared.rotate=this.definition.compared.rotate*o,r.definition.segmentEnd=o,r.update(),this._ascensionSegment=r,this.segments.push(r),l>0&&(n.definition?n.definition.copyFrom(this.definition):n.definition=this.definition.clone(),n.definition.copyFrom(this.definition),n.definition.compared.sourceZoom=t,n.definition.compared.targetZoom=t,n.definition.compared.pan=this.definition.compared.pan*l,n.definition.compared.rotate=this.definition.compared.rotate*l,n.definition.segmentStart=r.definition.segmentEnd,n.definition.segmentEnd=r.definition.segmentEnd+l,n.update(),this.segments.push(n)),s.definition?s.definition.copyFrom(this.definition):s.definition=this.definition.clone(),s.definition.compared.sourceZoom=t,s.definition.compared.pan=this.definition.compared.pan*a,s.definition.compared.rotate=this.definition.compared.rotate*a,s.definition.segmentStart=o+l,s.update(),this._descensionSegment=s,this.segments.push(s)}_updateWithoutApex(){let[t]=this._preallocSegments;t.update(this.definition),this.segments.push(t)}};var FK=new mT,gT=class{get time(){return this._time}get isLinear(){return this.path.segments.length===1}constructor(e){this._time=0,this._easing=dT,this.definition=new pT(e),this.path=new fT}update(e,t,i){this.definition.update(e,t,i),this.path.update(this.definition,i),this._time=this._applyTimeSettings(i0(isFinite(this.path.time)?this.path.time:0),i),this._easing=i.easing??(this._time>=1e3?dT:Lu)}cameraAt(e,t){e=Math.min(Math.max(0,e),1),e=this._normalizedEasing(e);let i=this.path.interpolateComponentsAt(e,FK);t.interpolate(this.definition.source,this.definition.target,i)}_normalizedEasing(e){let t=this._easing(0,this._time),i=this._easing(1,this._time);return(this._easing(e,this._time)-t)/(i-t)}_applyTimeSettings(e,t){let i=t.speedFactor!=null?t.speedFactor:1,r=t.minDuration??xh.minDuration/i,n=t.maxDuration??xh.maxDuration/i;return e=t.duration!=null?t.duration:Math.min(Math.max(e/i,r),n)}};var kK=2e3,VK=64,xR=class{constructor(t){this._view=t,this._animation=new gT(()=>new my(this._view)),this._current=new my(this._view)}get _source(){return this._animation.definition.source}get _target(){return this._animation.definition.target}get duration(){return this._animation.time}get animation(){return this._animation}update(t,i,r={}){go(this._current.viewpoint,t),go(this._source.viewpoint,t),go(this._target.viewpoint,i),this._animation.update(this._source,this._target,r)}applyRatio(t,i){this._animation.cameraAt(i,this._current),go(t,this._current.viewpoint)}},vf=class extends P{constructor(e){super(e),this._animation=null,this._destinationViewState=new of,this.updateFunction=null,this.easing=gy.ease,this.viewpoint=new Si({targetGeometry:new pt,scale:0,rotation:0}),this._updateTask=Jr({postRender:this._postRender.bind(this)}),this._updateTask.pause(),this._transition=new xR(e.view)}destroy(){this._updateTask=Ft(this._updateTask)}get animation(){return this._animation}set animation(e){this._animation=e,this.view.animation=e}animate(e,t,i){this.stop();let r=this.viewpoint;go(r,t);let n=e.target;this._transition.update(this.viewpoint,n,{apex:{maximumDistance:Math.min(Math.min(t.scale,n.scale)*VK,this.view.constraints.effectiveMinScale),desiredSlope:5e-8},duration:i?.duration,maxDuration:i?.animationMode==="auto"?1/0:i?.maxDuration??DR.maxDuration,speedFactor:i?.speedFactor,easing:(typeof i?.easing=="string"?gy[i.easing]:i?.easing)||this.easing}),i?.animationMode==="auto"&&(this._destinationViewState.copy(this.view.state),this._destinationViewState.viewpoint=n,HK(this._transition.animation,i,this.view.state,this._destinationViewState)||this._transition.update(this.viewpoint,n,{duration:0}));let s=()=>{this.animation===e&&this._updateTask&&(e.state==="finished"&&(this._transition.applyRatio(this.viewpoint,1),this.view.state&&(this.view.state.viewpoint=this.viewpoint.clone())),this.animation=null,this.updateFunction=null)};return e.when(s,s),this._startTime=performance.now(),this._updateTask.resume(),this.animation=e,e}animateContinuous(e,t){this.stop(),this.updateFunction=t,this.viewpoint=e;let i=new Cn({target:e.clone()}),r=()=>{this.animation===i&&this._updateTask&&(this.animation=null,this.updateFunction=null)};return i.when(r,r),this._startTime=performance.now(),this._updateTask.resume(),this.animation=i,i}stop(){this.animation&&(this.animation.stop(),this.animation=null,this.updateFunction=null)}_postRender(e){let t=this.animation;if(t&&t.state!==Cn.State.STOPPED){if(this.updateFunction)this.updateFunction(this.viewpoint,e.deltaTime),this.animation?.update(this.viewpoint);else{let i=performance.now()-this._startTime,r=this._transition.duration,n=r>0?i/r:1,s=n>=1;this._transition.applyRatio(this.viewpoint,n),s&&this.animation?.finish()}this.view.state&&(this.view.state.viewpoint=this.viewpoint.clone())}else this._updateTask.pause()}};function HK(e,t,i,r){if(t?.duration!=null)return!0;let{time:n,isLinear:s}=e,o=t?.speedFactor||1;if(n>(t?.maxDuration??DR.maxDuration/o))return!1;if(s){let l=Hi(),c=Zi(...r.toScreen(l,...i.center)),h=Zi(...i.toScreen(l,...r.center)),p=h!=null&&h.x>-1*i.size[0]&&h.x<(1.5+.5)*i.size[0]&&h.y>-1*i.size[1]&&h.y<(1.5+.5)*i.size[1],m=c!=null&&c.x>-1*r.size[0]&&c.x<(1.5+.5)*r.size[0]&&c.y>-1*r.size[1]&&c.y<(1.5+.5)*r.size[1];if(n>kK/o&&!p&&!m)return!1}return!0}u([d()],vf.prototype,"easing",void 0),u([d()],vf.prototype,"view",void 0),u([d()],vf.prototype,"viewpoint",void 0),vf=u([C("esri.views.2d.AnimationManager")],vf);var Jz=vf;function Oi(){return Promise.all([import("./chunk-KNLVA5SZ.js"),import("./chunk-2K6JY746.js")])}var _y=()=>Oi().then(()=>import("./chunk-4QUOG5O4.js")),Mh=()=>Oi().then(()=>import("./chunk-FRN2ZXE6.js")),e4={"base-dynamic":()=>Oi().then(()=>import("./chunk-PY6IBGHY.js")),"base-tile":_y,"bing-maps":_y,catalog:()=>Oi().then(()=>import("./chunk-UXRKY3CE.js")),"catalog-dynamic-group":()=>Oi().then(()=>import("./chunk-WEYYXRKO.js")),"catalog-footprint":()=>Oi().then(()=>import("./chunk-DEVWNJ5E.js")),csv:Mh,"geo-rss":()=>Oi().then(()=>import("./chunk-GKSWWYIB.js")),feature:Mh,geojson:Mh,parquet:Mh,graphics:()=>Oi().then(()=>import("./chunk-56VS4PUY.js")),group:()=>Oi().then(()=>import("./chunk-Z7EW2RGL.js")),imagery:()=>Oi().then(()=>import("./chunk-QUM2FGVT.js")),"imagery-tile":()=>Oi().then(()=>import("./chunk-6I3Z6LZR.js")),kml:()=>Oi().then(()=>import("./chunk-AWHWCJ7R.js")),"knowledge-graph":()=>Oi().then(()=>import("./chunk-YH3W7XBG.js")),"link-chart":()=>Oi().then(()=>import("./chunk-YH3W7XBG.js")),"knowledge-graph-sublayer":Mh,"map-image":()=>Oi().then(()=>import("./chunk-WHEKUNVF.js")),"map-notes":()=>Oi().then(()=>import("./chunk-SQTCCJH3.js")),media:()=>Oi().then(()=>import("./chunk-3K57EZNW.js")),"ogc-feature":()=>Oi().then(()=>import("./chunk-VJRU2QAJ.js")),"open-street-map":_y,"oriented-imagery":Mh,route:()=>Oi().then(()=>import("./chunk-DJBEDGAS.js")),stream:()=>Oi().then(()=>import("./chunk-SQTNHM3B.js")),"subtype-group":()=>Oi().then(()=>import("./chunk-TO7GLMHP.js")),tile:_y,"vector-tile":()=>Oi().then(()=>import("./chunk-GTBJVJQN.js")),video:()=>Oi().then(()=>import("./chunk-5BC4N56B.js")),wcs:()=>Oi().then(()=>import("./chunk-6I3Z6LZR.js")),"web-tile":_y,wfs:Mh,wms:()=>Oi().then(()=>import("./chunk-MUU5RLHZ.js")),wmts:()=>Oi().then(()=>import("./chunk-P3U77DLP.js")),"line-of-sight":null,"base-elevation":null,"building-scene":null,dimension:null,elevation:null,"integrated-mesh":null,"integrated-mesh-3dtiles":null,"point-cloud":null,viewshed:null,voxel:null,scene:null,unknown:null,unsupported:null};function BK(e){let t=e.declaredClass?e.declaredClass.slice(e.declaredClass.lastIndexOf(".")+1):"Unknown",i=t.replaceAll(/([a-z])([A-Z])/g,"$1-$2").toLowerCase();return new Be(`${i}:view-not-supported`,`${t} is not supported in 2D`)}var MR={hasLayerViewModule:e=>e4[e.type]!=null,importLayerView:e=>{let t=e4[e.type];if(t==null)throw BK(e);return t(e)}};var Sh={added:[],removed:[]},SR=new Set,UK=new N0(0,0,0,0);function jK(e,t){let i=_2(t);if(!i)return null;let[r,n]=i.valid;return e[2]>n?[Yt([e[0],e[1],n,e[3]]),Yt([r,e[1],r+e[2]-n,e[3]])]:e[0]<r?[Yt([r,e[1],e[2],e[3]]),Yt([n-(r-e[0]),e[1],n,e[3]])]:null}var _T=class extends oi{constructor(t){super(),this._tiles=new Map,this._index=ZL(9,Ct("esri-csp-restrictions")?i=>({minX:i.bounds[0],minY:i.bounds[1],maxX:i.bounds[2],maxY:i.bounds[3]}):[".bounds[0]",".bounds[1]",".bounds[2]",".bounds[3]"]),this.tiles=[],this.tileScheme=t}destroy(){this.clear()}clear(){this.tiles.length=0,this._tiles.clear(),this._index.clear()}has(t){return this._tiles.has(t)}get(t){return this._tiles.get(t)}getIntersectingTiles(t){if(!t||ao(t)===0||Hl(t)===0)return[];let i=jK(t,this.tileScheme.spatialReference);return i!=null?[...new Set([...this.boundsIntersections(i[0]),...this.boundsIntersections(i[1])])]:this.boundsIntersections(t)}boundsIntersections(t){return this._index.search({minX:t[0],minY:t[1],maxX:t[2],maxY:t[3]})}updateTiles(t){let i={added:[],removed:[]};for(let r of t.added)if(!this.has(r)){let n=new Yx(this.tileScheme,r);this._tiles.set(r,n),this._index.insert(n),i.added.push(n)}for(let r of t.removed)if(this.has(r)){let n=this.get(r);this._tiles.delete(r),this._index.remove(n),i.removed.push(n)}this.tiles.length=0,this._tiles.forEach(r=>this.tiles.push(r)),(i.added.length||i.removed.length)&&this.emit("update",i)}setViewState(t){let i=this.tileScheme.getTileCoverage(t,0);if(!i)return;let{spans:r,lodInfo:n}=i,{level:s}=n;if(r.length>0)for(let{row:o,colFrom:a,colTo:l}of r)for(let c=a;c<=l;c++){let h=UK.set(s,o,n.normalizeCol(c),n.getWorldForColumn(c)).id;if(SR.add(h),!this.has(h)){let p=new Yx(this.tileScheme,h);this._tiles.set(h,p),this._index.insert(p),this.tiles.push(p),Sh.added.push(p)}}for(let o=this.tiles.length-1;o>=0;o--){let a=this.tiles[o];SR.has(a.id)||(this._tiles.delete(a.id),this.tiles.splice(o,1),this._index.remove(a),Sh.removed.push(a))}(Sh.added.length||Sh.removed.length)&&this.emit("update",Sh),BL.pool.release(i),SR.clear(),Sh.added.length=0,Sh.removed.length=0}};async function r4(e,t,i){let r=kd(t)?Fd(e,t):t;if(!e.ready||isNaN(r.x)||isNaN(r.y))return{screenPoint:r,results:[]};let n=new Set,s=new Set,o=!1,a=null,l=null;i?.include?i4(i.include,t4(e,m=>{n.add(m),IR(m,f=>s.add(f))},(m,f)=>{s.add(m),n.add(f)},m=>{a||(a=new Set),a.add(m)},m=>n.add(m),()=>o=!0)):(o=!0,n=new Set(e.allLayerViews),n.forEach(m=>{IR(m,f=>s.add(f))})),i?.exclude&&i4(i.exclude,t4(e,m=>{n.delete(m),IR(m,f=>s.delete(f))},m=>s.delete(m),m=>{l||(l=new Set),l.add(m)}));let c=e.toMap(r),h=e.allLayerViews.filter(m=>!m.suspended&&n.has(m)&&m.clips.every(f=>uw(e,f,r,c))).reverse(),p=[...o?e.graphicsView.hitTest(c).map(m=>({type:"graphic",graphic:m,layer:null,mapPoint:c})):[],...await Promise.all(h.map(m=>m.hitTest(c,r)).toArray())].filter(vd).flat().filter(vd);return p=p.filter(m=>m.type!=="graphic"||m.layer?.type!=="subtype-group"||s.has(m.graphic.layer)),a&&(p=p.filter(m=>!("graphic"in m)||!m.graphic||a?.has(AR(m.graphic)))),l&&(p=p.filter(m=>!("graphic"in m)||!m.graphic||!l?.has(AR(m.graphic)))),{screenPoint:r,results:p}}function t4(e,t,i,r,n,s){return o=>{if(o instanceof rs){if(o.layer===e)s?.();else{let a=e.allLayerViews.find(l=>l.layer===o.layer);a&&n?.(a)}r(AR(o))}else if(!("layer"in o&&"element"in o))if(o.type==="subtype-sublayer"){let a=e.allLayerViews.find(l=>l.layer===o.parent);a&&i(o,a)}else{let a=e.allLayerViews.find(l=>l.layer===o);a&&t(a)}}}function i4(e,t){if(e)if(yx(e))for(let i of e)if(yx(i))for(let r of i)t(r);else t(i);else t(e)}function AR(e){let t=e.getObjectId();return t?`${e.layer?.uid??e.sourceLayer?.uid??"MapView"}/${t}`:`"MapView/${e.uid}`}function IR({layer:e},t){e?.type==="subtype-group"&&e.sublayers.forEach(i=>{t(i)})}var n4={flipY:!0,premultipliedAlpha:!0};async function s4(e,t){let i=await a4(e,t),{format:r,quality:n}=nV(t?.format,t?.quality);return iV(i,{format:r,quality:n},n4)}async function o4(e,t){let i=await a4(e,t);return rV(i,n4)}function a4(e,t){let i=qK(t||{},GK(e.stage,e.size),e.size,e.padding),r=zK(t,e.allLayerViews);return e.stage.takeScreenshot(i,r,e.backgroundColor,t?.rotation)}function zK(e={},t){if(!e.layers)return;let i=[];return e.layers.forEach(r=>{let n=t.find(s=>s.layer.id===r.id);n?.container&&i.push(n.container)}),i}function GK(e,t){return Math.min(4,sV(t,Math.min(4096,e.context.parameters.maxTextureSize)))}function qK(e,t,i,r){e.ignorePadding&&(r={left:0,right:0,top:0,bottom:0});let n=null;e.width!=null&&e.height!=null?n=[e.width,e.height]:e.width==null&&e.height!=null?n=[e.height,e.height]:e.width!=null&&e.height==null?n=[e.width,e.width]:e.width==null&&e.height==null&&(n=null);let s=i[0]-(r.left+r.right),o=i[1]-(r.top+r.bottom),a,l,c=e.area||{x:0,y:0,width:s,height:o};if(n){let h=s/o,p=n[0]/n[1];if(p>h){let m=c.width/p;c={x:c.x,y:Math.round(c.y+(c.height-m)/2),width:c.width,height:Math.round(m)}}else{let m=c.height*p;c={x:Math.round(c.x+(c.width-m)/2),y:c.y,width:Math.round(m),height:c.height}}}else n=[c.width,c.height];return n[0]>c.width?(a=Math.min(n[0]/c.width,t),l=n[0]/c.width/a):(a=1,l=n[0]/c.width),{cropArea:{x:Math.round((c.x+r.left)*a),y:Math.round((c.y+r.top)*a),width:Math.round(c.width*a),height:Math.round(c.height*a)},outputScale:l,resolutionScale:a}}function yT(e){let t=Ck();return t.available?e==="3d"&&t.majorPerformanceCaveat?new Be("webgl:major-performance-caveat-detected",`Your WebGL implementation (${t.unmaskedRenderer}) doesn't seem to support hardware accelerated rendering. Check your browser settings or if your GPU is in a blocklist.`):t.supportsHighPrecisionFragment?t.supportsVertexShaderSamplers?null:new Be("webgl:vertex-shader-samplers-required","WebGL support for vertex shader samplers is required but not supported."):new Be("webgl:high-precision-fragment-required","WebGL support for high precision fragment shaders is required but not supported."):new Be("webgl:required","WebGL2 is required but not supported.",new Error().stack)}function WK(e){return e&&"nodeType"in e}function $K(e){return e&&typeof e.render=="function"}var l4={component:"esri-component"},Ih=class extends P{constructor(){super(...arguments),this.widget=null}destroy(){this.node=null,this.widget?.destroy()}get id(){return this._get("id")??this.widget?.id??this.node?.id}set id(e){this._set("id",e)}set node(e){let t=this._get("node");e!==t&&(e&&e.classList.add(l4.component),t&&t.classList.remove(l4.component),this._set("node",e))}castNode(e){return this.widget?.destroy(),e?typeof e=="string"||WK(e)?(this._set("widget",null),vp(e)):($K(e)&&!e.domNode&&(e.domNode=document.createElement("div")),this._set("widget",e),e.domNode):(this._set("widget",null),null)}};u([d()],Ih.prototype,"id",null),u([d()],Ih.prototype,"node",null),u([Sr("node")],Ih.prototype,"castNode",null),u([d({readOnly:!0})],Ih.prototype,"widget",void 0),Ih=u([C("esri.views.ui.Component")],Ih);var Fu=Ih;var ZK={left:0,top:0,bottom:0,right:0},c4={bottom:30,top:15,right:15,left:15},fc="esri-ui",vs={ui:fc,corner:`${fc}-corner`,innerContainer:`${fc}-inner-container`,manualContainer:`${fc}-manual-container`,cornerContainer:`${fc}-corner-container`,topLeft:`${fc}-top-left`,topRight:`${fc}-top-right`,bottomLeft:`${fc}-bottom-left`,bottomRight:`${fc}-bottom-right`};function QK(e){return e&&!e._started&&typeof e.postMixInProperties=="function"&&typeof e.buildRendering=="function"&&typeof e.postCreate=="function"&&typeof e.startup=="function"}function vT(e){return e===0?"0":`${e}px`}function RR(e){let t=typeof e=="object"&&e!==null&&Object.getPrototypeOf(e);return(t===null||t===Object.prototype)&&("component"in e||"index"in e||"position"in e)?e:null}function PR(e,{top:t,bottom:i,left:r,right:n}){e.style.top=t,e.style.bottom=i,e.style.left=r,e.style.right=n}var cl=class extends oi.EventedAccessor{constructor(e){super(e),this._cornerNameToContainerLookup={},this._positionNameToContainerLookup={},this._components=new Array,this._componentMap=new Map,this._removeWidgetHandleKey=Symbol("componentOnRemoveSymbol"),this._locale=o2(),this.view=null,this._applyViewPadding=()=>{let t=this.container;t&&PR(t,this._toPixelPosition(this._getViewPadding()))},this._applyUIPadding=()=>{let t=this._innerContainer;t&&PR(t,this._toPixelPosition(this.padding))},this._initContainers()}initialize(){this.addHandles([S(()=>[this.view?.padding,this.container],this._applyViewPadding,Re),S(()=>this.padding,this._applyUIPadding,Re),S(()=>[this.container,this._locale],([e,t])=>{e&&e.setAttribute("lang",t)},Re),a2(e=>{this._locale=e})])}destroy(){this.container=null;for(let e of this._components)e.destroy();this._components.length=0,this._componentMap.clear()}set container(e){let t=this._get("container");e!==t&&(e&&(e.classList.add(vs.ui),p2(e),this._attachContainers(e)),t&&(t.classList.remove(vs.ui),PR(t,{top:"",bottom:"",left:"",right:""}),t.textContent=""),this._set("container",e))}get height(){let e=this.view?.height??0;if(e===0)return e;let t=this._getViewPadding(),{top:i,bottom:r}=t;return Math.max(e-i-r,0)}get padding(){return this._get("padding")}set padding(e){this._overrideIfSome("padding",e)}castPadding(e){return typeof e=="number"?{bottom:e,top:e,right:e,left:e}:ie(ie({},c4),e)}get width(){let e=this.view?.width??0;if(e===0)return e;let t=this._getViewPadding(),{left:i,right:r}=t;return Math.max(e-i-r,0)}add(e,t){let i,r,n;if(Array.isArray(e))return void e.forEach(o=>this.add(o,t));let s=RR(e);s&&({index:i,position:t,component:e,key:r}=s),t&&typeof t=="object"&&({index:i,key:r,position:t,internal:n}=t),!e||t&&!this._isValidPosition(t)||this._add(e,t,i,r,n)}remove(e,t){if(!e)return;if(Array.isArray(e))return e.map(r=>this.remove(r,t));let i=this._find(e);if(i){if(this._componentMap.has(i)&&this._componentMap.get(i)?.key!==t)return;let r=this._components.indexOf(i);return i.node.parentNode?.removeChild(i.node),this._componentMap.delete(i),i.widget?.removeHandlesReference(this._removeWidgetHandleKey),this._components.splice(r,1)[0]}}empty(e,t={removeInternal:!1}){if(Array.isArray(e)){for(let n of e)this.empty(n,t);return}let i=this._positionNameToContainerLookup[e??"manual"],r=Array.prototype.slice.call(i.children).map(n=>this._findByNode(n)).filter(n=>n==null?!1:!(this._componentMap.get(n)?.internal??!1)||t.removeInternal);for(let n of r)this.remove(n)}move(e,t){if(Array.isArray(e)&&e.forEach(s=>this.move(s,t)),!e)return;let i,r=RR(e)||RR(t);if(r&&(i=r.index,t=r.position,e=r.component||e),t&&!this._isValidPosition(t))return;let n=this.remove(e);n&&this.add(n,{position:t,index:i})}find(e){if(!e)return null;let t=this._findById(e);return t&&(t.widget||t.node)}getComponents(e,t={includeInternal:!1}){return e?Array.isArray(e)?e.flatMap(i=>this._getComponentsAtPosition(i,t)):this._getComponentsAtPosition(e,t):this._components.filter(i=>t.includeInternal||!this._componentMap.get(i)?.internal).map(({widget:i,node:r})=>i??r)}getPosition(e){for(let t in this._positionNameToContainerLookup)if(this._positionNameToContainerLookup[t].contains(e))return t;return null}_add(e,t,i,r,n){e instanceof Fu||(e=new Fu({node:e}));let{widget:s}=e;s!=null&&s instanceof P&&s.addHandles(_r(()=>{queueMicrotask(()=>this.remove(e))}),this._removeWidgetHandleKey),this._place({component:e,position:t,index:i}),this._components.push(e),this._componentMap.set(e,{key:r,internal:n})}_find(e){return e?e instanceof Fu?this._findByComponent(e):typeof e=="string"?this._findById(e):this._findByNode(e.domNode||e):null}_getViewPadding(){return this.view?.padding??ZK}_attachContainers(e){e.appendChild(this._innerContainer),e.appendChild(this._manualContainer)}_initContainers(){let e=document.createElement("div");e.classList.add(vs.innerContainer,vs.cornerContainer);let t=document.createElement("div");t.classList.add(vs.innerContainer,vs.manualContainer);let i=document.createElement("div");i.classList.add(vs.topLeft,vs.corner),e.appendChild(i);let r=document.createElement("div");r.classList.add(vs.topRight,vs.corner),e.appendChild(r);let n=document.createElement("div");n.classList.add(vs.bottomLeft,vs.corner),e.appendChild(n);let s=document.createElement("div");s.classList.add(vs.bottomRight,vs.corner),e.appendChild(s),this._innerContainer=e,this._manualContainer=t;let o=d2();this._cornerNameToContainerLookup={"top-left":i,"top-right":r,"bottom-left":n,"bottom-right":s,"top-leading":o?r:i,"top-trailing":o?i:r,"bottom-leading":o?s:n,"bottom-trailing":o?n:s},this._positionNameToContainerLookup=ie({manual:t},this._cornerNameToContainerLookup)}_isValidPosition(e){return!!this._positionNameToContainerLookup[e]}_place(e){let t=e.position??"manual",{component:i,index:r}=e,n=this._positionNameToContainerLookup[t],s=r!=null&&r>-1;if(QK(i.widget)&&i.widget.startup(),!s)return void n.appendChild(i.node);let o=Array.from(n.children);if(r===0){let{firstChild:l}=n;return void(l?l.parentNode?.insertBefore(i.node,l):n.appendChild(i.node))}if(r>=o.length)return void n.appendChild(i.node);let a=o[r];a.parentNode?.insertBefore(i.node,a)}_toPixelPosition(e){return{top:vT(e.top),left:vT(e.left),right:vT(e.right),bottom:vT(e.bottom)}}_findByComponent(e){return this._components.find(t=>t===e)??null}_findById(e){return this._components.find(({id:t})=>t===e)??null}_findByNode(e){return this._components.find(({node:t})=>t===e)??null}_getComponentsAtPosition(e,t){let i=this._positionNameToContainerLookup[e];return Array.prototype.slice.call(i.children).map(r=>this._findByNode(r)).filter(vd).filter(r=>t.includeInternal||!this._componentMap.get(r)?.internal).map(({widget:r,node:n})=>r??n)}};u([d()],cl.prototype,"_locale",void 0),u([d()],cl.prototype,"container",null),u([d()],cl.prototype,"height",null),u([d({value:c4})],cl.prototype,"padding",null),u([Sr("padding")],cl.prototype,"castPadding",null),u([d()],cl.prototype,"view",void 0),u([d()],cl.prototype,"width",null),cl=u([C("esri.views.ui.UI")],cl);var u4=cl;function d4(e,t){return e&&"copyright"in e&&(!t||typeof e.originOf=="function"&&e.originOf("copyright")==="user")}function YK(e,t){return e.length!==t.length||e.some((i,r)=>i.text!==t[r].text)}function yy(e,t,i){!i||!t||e.find(r=>r.layerView===t&&r.text===i)||e.push({text:i,layerView:t})}function KK(e){return e.type==="bing-maps"}var gc=[],wf=class extends P{constructor(e){super(e),this._clear=()=>{this._fetchedAttributionData.clear(),this._pendingAttributions.clear(),this.removeHandles("suspension"),this.notifyChange("state")},this._pendingAttributions=new Set,this._fetchedAttributionData=new Map,this.items=new lt,this.view=null,this._allLayerViewsChange=t=>{this.removeHandles("suspension"),this.removeHandles("visible-geometry-changed");let i=this.view?.allLayerViews;i&&(this.addHandles(i.map(r=>S(()=>[r.suspended,r.layer?.attributionVisible],()=>this._updateAttributionItems())).toArray(),"suspension"),i.forEach(r=>{r.declaredClass==="esri.views.3d.layers.Tiles3DLayerView3D"&&this.addHandles(r.on("visible-geometry-changed",()=>this._updateAttributionItems()),"visible-geometry-changed")})),t?.removed&&t.removed.forEach(r=>{this._pendingAttributions.delete(r),this._fetchedAttributionData.delete(r)}),this._updateAttributionItems()},this.addHandles([tr(()=>this.view?.allLayerViews,"change",t=>this._allLayerViewsChange(t),{onListenerAdd:()=>this._allLayerViewsChange(),onListenerRemove:this._clear}),Wi(()=>this.view?.stationary===!0,()=>this._updateAttributionItems())])}destroy(){this.view=null,this._fetchedAttributionData.clear(),this._pendingAttributions.clear(),this.items.removeAll()}get state(){return this.view?.ready?this._pendingAttributions.size>0?"loading":"ready":"disabled"}_updateAttributionItems(){let e=this.view,t=e?.allLayerViews;if(gc.length=0,!e||!t)return void this._clear();t.forEach(r=>{if(r.suspended||!r.layer?.attributionVisible)return;let n=r.layer;if(d4(n,"user"))return void yy(gc,r,n.copyright);if(n.hasAttributionData){if(this._fetchedAttributionData.has(r)){let o=this._fetchedAttributionData.get(r);return void(o?yy(gc,r,this._getDynamicAttribution(o,e,n)):d4(n)&&yy(gc,r,n.copyright))}return void this._fetchAttributionData(r)}let s="portalItem"in n?n.portalItem?.accessInformation:void 0;yy(gc,r,s||n.copyright)});let i=t.find(r=>r.layer?.type==="integrated-mesh-3dtiles");if(this.view&&i){let r=qV(this.view);if(r){let n=r.getAttributionText();for(let s=0;s<n.length;++s)yy(gc,i,n[s])}}YK(this.items,gc)&&(this.items.removeAll(),this.items.addMany(gc)),gc.length=0,this.notifyChange("state")}async _fetchAttributionData(e){if(this._pendingAttributions.has(e))return;this._pendingAttributions.add(e);let t=await Ig(e.layer.fetchAttributionData());if(this._pendingAttributions.has(e)){let i=t.ok?this._createContributionIndex(t.value,KK(e.layer)):null;this._pendingAttributions.delete(e),this._fetchedAttributionData.set(e,i)}this._updateAttributionItems()}_createContributionIndex(e,t){let i=e.contributors,r={};if(!i)return r;for(let n=0;n<i.length;n++){let s=i[n],o=s.coverageAreas;if(!o)return;for(let a of o){let l=a.bbox,c=a.zoomMin-(t&&a.zoomMin?1:0),h=a.zoomMax-(t&&a.zoomMax?1:0),p=new Vi({xmin:l[1],ymin:l[0],xmax:l[3],ymax:l[2],spatialReference:Qt.WGS84}),m={extent:T2(p),attribution:s.attribution||"",score:a.score!=null?a.score:100,id:n};for(let f=c;f<=h;f++)r[f]??=[],r[f].push(m)}}return r.maxKey=Math.max.apply(null,Object.keys(r)),r}_getDynamicAttribution(e,t,i){let{extent:r,scale:n}=t,s=i.tileInfo?.scaleToZoom(n)??0;if(s=Math.min(e.maxKey??0,Math.round(s)),!r||s==null||s<=-1)return"";let o=e[s],a=C2(r.center.clone().normalize(),Qt.WebMercator),l=new Set;return o?o.filter(c=>{let h=c.id,p=!l.has(h)&&a&&c.extent&&h0(c.extent,a);return p&&l.add(h),p}).sort((c,h)=>h.score-c.score||c.objectId-h.objectId).map(c=>c.attribution).join(", "):""}};u([d({readOnly:!0,type:lt})],wf.prototype,"items",void 0),u([d({readOnly:!0})],wf.prototype,"state",null),u([d()],wf.prototype,"view",void 0),wf=u([C("esri.widgets.Attribution.AttributionViewModel")],wf);var OR=wf;var bf="esri-attribution",Cf={base:bf,poweredBy:`${bf}__powered-by`,sources:`${bf}__sources`,open:`${bf}--open`,sourcesOpen:`${bf}__sources--open`,link:`${bf}__link`},zn=class extends La{constructor(e,t){super(e,t),this._isOpen=!1,this._attributionTextOverflowed=!1,this._prevSourceNodeHeight=0,this._resizeObserver=new ResizeObserver(i=>i.forEach(({target:r})=>this._checkSourceTextOverflow(r))),this.itemDelimiter=" | ",this.messages=null,this.viewModel=new OR}initialize(){this.addHandles(tr(()=>this.viewModel?.items,"change",()=>this.scheduleRender()))}destroy(){this._resizeObserver?.disconnect()}get _isInteractive(){return this._isOpen||this._attributionTextOverflowed}get attributionText(){return this.viewModel.items.reduce((e,t)=>(e.includes(t.text)||e.push(t.text),e),[]).join(this.itemDelimiter)}get icon(){return"description"}set icon(e){this._overrideIfSome("icon",e)}get label(){return this.messages?.widgetLabel??""}set label(e){this._overrideIfSome("label",e)}get view(){return this.viewModel.view}set view(e){this.viewModel.view=e}render(){let e={[Cf.open]:this._isOpen};return $i("div",{bind:this,class:this.classes(Cf.base,os.widget,e),dir:"ltr",onclick:this._toggleState,onkeydown:this._toggleState},this._renderSourcesNode(),this._renderPoweredBy())}_renderPoweredBy(){return $i("div",{class:Cf.poweredBy},"Powered by"," ",$i("a",{class:Cf.link,href:"https://www.esri.com/",rel:"noreferrer",target:"_blank"},"Esri"))}_renderSourcesNode(){let e=this._isOpen,t=this._isInteractive,i=t?0:void 0,{attributionText:r}=this,n={[Cf.sourcesOpen]:e,[os.interactive]:t};return $i("div",{afterCreate:this._afterSourcesNodeCreate,bind:this,class:this.classes(Cf.sources,n),innerHTML:r,tabIndex:i})}_afterSourcesNodeCreate(e){this._prevSourceNodeHeight=e.clientWidth,this._resizeObserver.observe(e)}_checkSourceTextOverflow(e){let t=!1,{clientHeight:i,clientWidth:r,scrollWidth:n}=e,s=n>r,o=this._attributionTextOverflowed!==s;if(this._attributionTextOverflowed=s,o&&(t=!0),this._isOpen){let a=i<this._prevSourceNodeHeight;this._prevSourceNodeHeight=i,a&&(this._isOpen=!1,t=!0)}t&&this.scheduleRender()}_toggleState(){this._isInteractive&&(this._isOpen=!this._isOpen)}};u([d()],zn.prototype,"_isOpen",void 0),u([d()],zn.prototype,"_isInteractive",null),u([d()],zn.prototype,"_attributionTextOverflowed",void 0),u([d()],zn.prototype,"_prevSourceNodeHeight",void 0),u([d({readOnly:!0,dependsOn:["viewModel.items.length","itemDelimiter"]})],zn.prototype,"attributionText",null),u([d()],zn.prototype,"icon",null),u([d()],zn.prototype,"itemDelimiter",void 0),u([d()],zn.prototype,"label",null),u([d(),Qo("esri/widgets/Attribution/t9n/Attribution")],zn.prototype,"messages",void 0),u([d()],zn.prototype,"view",null),u([d({type:OR})],zn.prototype,"viewModel",void 0),u([Sk()],zn.prototype,"_toggleState",null),zn=u([C("esri.widgets.Attribution")],zn);var h4=zn;function p4(e){return e?.spatialReference?.isWebMercator||e?.spatialReference?.isGeographic||!1}var Ah=class extends qk(P){constructor(e){super(e),this.orientation={x:0,y:0,z:0},this.view=null,this._updateForCamera=this._updateForCamera.bind(this),this._updateForRotation=this._updateForRotation.bind(this),this._updateRotationWatcher=this._updateRotationWatcher.bind(this)}initialize(){this._watchForView(Re)}destroy(){this.view=null}get canShowNorth(){return p4(this.view)}get state(){return!this.view?.ready||this.view.type==="2d"&&!this.view.constraints.rotationEnabled?"disabled":this.canShowNorth?"compass":"rotation"}reset(){this.view?.ready&&(this.view?.type==="2d"?this.callGoTo({target:{rotation:0},options:{animationMode:"always",duration:lV()}}):this.callGoTo({target:{heading:0}}))}_updateForRotation(e){e!=null&&this._set("orientation",{z:e})}_updateForCamera(e){if(!e)return;let t=-e.heading;this._set("orientation",{x:0,y:0,z:t})}_updateRotationWatcher(e){this.removeAllHandles(),this._watchForView(),e&&this.addHandles(e.type==="2d"?S(()=>e?.rotation,this._updateForRotation,Re):S(()=>e?.camera,this._updateForCamera,Re))}_watchForView(e){this.addHandles(S(()=>this.view,this._updateRotationWatcher,e))}};u([d({readOnly:!0})],Ah.prototype,"canShowNorth",null),u([d({readOnly:!0})],Ah.prototype,"orientation",void 0),u([d({readOnly:!0})],Ah.prototype,"state",null),u([d()],Ah.prototype,"view",void 0),Ah=u([C("esri.widgets.Compass.CompassViewModel")],Ah);var NR=Ah;var m4="esri-compass",LR={base:m4,iconContainer:`${m4}__icon-container`};var _c=class extends La{constructor(e,t){super(e,t),this.messages=null,this.viewModel=new NR,this._reset=()=>{this.viewModel.reset()},this._toRotationTransform=i=>({transform:`rotateZ(${i.z}deg)`})}loadDependencies(){return wp({button:()=>import("./chunk-B2M6LCNQ.js"),icon:()=>import("./chunk-A7SCRTXK.js")})}get goToOverride(){return this.viewModel.goToOverride}set goToOverride(e){this.viewModel.goToOverride=e}get icon(){return this.viewModel.state==="rotation"?"arrow-up":"compass-needle"}set icon(e){this._overrideIfSome("icon",e)}get label(){return this.messages?.widgetLabel??""}set label(e){this._overrideIfSome("label",e)}get view(){return this.viewModel.view}set view(e){this.viewModel.view=e}reset(){return this.viewModel.reset()}render(){let{orientation:e,state:t}=this.viewModel,{messages:i}=this;return $i("div",{class:this.classes(LR.base,os.widget)},$i("calcite-button",{class:os.widgetButton,disabled:t==="disabled",kind:"neutral",label:i.reset,onclick:this._reset,round:!0,scale:"s",title:i.reset},$i("div",{"aria-hidden":"true",class:LR.iconContainer,title:i.reset},$i("calcite-icon",{icon:this.icon,styles:this._toRotationTransform(e)}))))}};u([d()],_c.prototype,"goToOverride",null),u([d()],_c.prototype,"icon",null),u([d()],_c.prototype,"label",null),u([d(),Qo("esri/widgets/Compass/t9n/Compass")],_c.prototype,"messages",void 0),u([d()],_c.prototype,"view",null),u([d({type:NR})],_c.prototype,"viewModel",void 0),_c=u([C("esri.widgets.Compass")],_c);var f4=_c;var g4="esri-navigation-toggle",FR={base:g4,isLayoutHorizontal:`${g4}--horizontal`};var Tf=class extends P{constructor(e){super(e),this._navigationMode="pan",this.view=null}initialize(){this.addHandles(Wi(()=>this.view?.navigation?.actionMap,()=>this._updateNavigationActionMap()))}destroy(){this.view=null}get state(){return this.view?.ready&&this.view?.type==="3d"?"ready":"disabled"}get navigationMode(){return this._navigationMode}set navigationMode(e){this._navigationMode=e,this._updateNavigationActionMap()}toggle(){this.state!=="disabled"&&(this.navigationMode=this.navigationMode!=="pan"?"pan":"rotate")}_updateNavigationActionMap(){let e=this.view?.navigation?.actionMap;if(!e)return;let t=this._navigationMode==="pan";e.dragPrimary=t?"pan":"rotate",e.dragSecondary=t?"rotate":"pan"}};u([d({readOnly:!0})],Tf.prototype,"state",null),u([d()],Tf.prototype,"_navigationMode",void 0),u([d()],Tf.prototype,"view",void 0),Tf=u([C("esri.widgets.NavigationToggle.NavigationToggleViewModel")],Tf);var kR=Tf;var yc=class extends La{constructor(e,t){super(e,t),this.messages=null,this.viewModel=new kR,this.toggle=()=>this.viewModel.toggle(),this._panButton=null,this._rotateButton=null,this._toggle=()=>{let i=this.viewModel?.navigationMode==="pan"?this._rotateButton:this._panButton;h2(i),this.toggle()}}loadDependencies(){return wp({button:()=>import("./chunk-B2M6LCNQ.js")})}get icon(){return"move"}set icon(e){this._overrideIfSome("icon",e)}get label(){return this.messages?.widgetLabel??""}set label(e){this._overrideIfSome("label",e)}set layout(e){e!=="horizontal"&&(e="vertical"),this._set("layout",e)}get view(){return this.viewModel.view}set view(e){this.viewModel.view=e}render(){let e=this.viewModel?.state==="disabled",t=this.viewModel?.navigationMode==="pan",i=this.messages.toggle;return $i("div",{class:this.classes(FR.base,os.widget,{[FR.isLayoutHorizontal]:this.layout==="horizontal"})},$i("calcite-button",{afterCreate:r=>{this._panButton=r},appearance:t?"outline-fill":"solid",class:os.widgetButton,disabled:e,iconStart:"move",kind:"neutral",label:i,onclick:this._toggle,tabIndex:t?void 0:-1,title:i}),$i("calcite-button",{afterCreate:r=>{this._rotateButton=r},appearance:t?"solid":"outline-fill",class:os.widgetButton,disabled:e,iconStart:"rotate",kind:"neutral",label:i,onclick:this._toggle,tabIndex:t?-1:void 0,title:i}))}};u([d()],yc.prototype,"icon",null),u([d()],yc.prototype,"label",null),u([d({value:"vertical"})],yc.prototype,"layout",null),u([d(),Qo("esri/widgets/NavigationToggle/t9n/NavigationToggle")],yc.prototype,"messages",void 0),u([d()],yc.prototype,"view",null),u([d({type:kR})],yc.prototype,"viewModel",void 0),yc=u([C("esri.widgets.NavigationToggle")],yc);var _4=yc;var Rh=class extends P{get canZoomIn(){if(!this.view?.ready)return!1;let t=this.view?.constraints?.effectiveMaxScale;return t===0||this._scale>t}get canZoomOut(){let{view:e}=this;if(!e?.ready)return!1;let i=e.constraints?.effectiveMinScale;return i===0||this._scale<i}get _scale(){let e=this.view?.animation?.target;return(e&&"then"in e?void 0:e?.scale)??this.view?.scale??0}};u([d({readOnly:!0})],Rh.prototype,"canZoomIn",null),u([d({readOnly:!0})],Rh.prototype,"canZoomOut",null),u([d()],Rh.prototype,"view",void 0),u([d()],Rh.prototype,"_scale",null),Rh=u([C("esri.widgets.Zoom.ZoomConditions2D")],Rh);var y4=Rh;var Ef=class extends P{get canZoomIn(){return!!this.view.ready}get canZoomOut(){return!!this.view.ready}};u([d({readOnly:!0})],Ef.prototype,"canZoomIn",null),u([d({readOnly:!0})],Ef.prototype,"canZoomOut",null),u([d()],Ef.prototype,"view",void 0),Ef=u([C("esri.widgets.Zoom.ZoomConditions3D")],Ef);var v4=Ef;var ku=class extends P{constructor(e){super(e)}destroy(){this.view=null}get canZoomIn(){return this._zoomConditions!=null&&this._zoomConditions.canZoomIn}get canZoomOut(){return this._zoomConditions!=null&&this._zoomConditions?.canZoomOut}get state(){return this.view?.ready?"ready":"disabled"}set view(e){e?e.type==="2d"?this._zoomConditions=new y4({view:e}):e.type==="3d"&&(this._zoomConditions=new v4({view:e})):this._zoomConditions=null,this._set("view",e)}zoomIn(){let e=this.view;this.canZoomIn&&e&&(e.type==="2d"?e.mapViewNavigation.zoomIn():Cx(e.goTo({zoomFactor:2})))}zoomOut(){let e=this.view;this.canZoomOut&&e&&(e.type==="2d"?e.mapViewNavigation.zoomOut():Cx(e.goTo({zoomFactor:.5})))}};u([d()],ku.prototype,"_zoomConditions",void 0),u([d()],ku.prototype,"canZoomIn",null),u([d()],ku.prototype,"canZoomOut",null),u([d({readOnly:!0})],ku.prototype,"state",null),u([d()],ku.prototype,"view",null),ku=u([C("esri.widgets.Zoom.ZoomViewModel")],ku);var VR=ku;var w4={base:"esri-zoom",horizontalLayout:"esri-zoom--horizontal"},vc=class extends La{constructor(e,t){super(e,t),this.messages=null,this.viewModel=new VR,this.zoomIn=()=>this.viewModel.zoomIn(),this.zoomOut=()=>this.viewModel.zoomOut()}loadDependencies(){return wp({button:()=>import("./chunk-B2M6LCNQ.js")})}get icon(){return"magnifying-glass-plus"}set icon(e){this._overrideIfSome("icon",e)}get label(){return this.messages?.widgetLabel??""}set label(e){this._overrideIfSome("label",e)}set layout(e){e!=="horizontal"&&(e="vertical"),this._set("layout",e)}set view(e){this.viewModel.view=e}get view(){return this.viewModel.view}render(){let e={[w4.horizontalLayout]:this.layout==="horizontal"},{canZoomIn:t,canZoomOut:i}=this.viewModel,{zoomIn:r,zoomOut:n}=this.messages;return $i("div",{class:this.classes(w4.base,os.widget,e)},$i("calcite-button",{class:os.widgetButton,disabled:!t,iconStart:"plus",kind:"neutral",label:r,onclick:this.zoomIn,title:r}),$i("calcite-button",{class:os.widgetButton,disabled:!i,iconStart:"minus",kind:"neutral",label:n,onclick:this.zoomOut,title:n}))}};u([d()],vc.prototype,"icon",null),u([d()],vc.prototype,"label",null),u([d({value:"vertical"})],vc.prototype,"layout",null),u([d(),Qo("esri/widgets/Zoom/t9n/Zoom")],vc.prototype,"messages",void 0),u([d()],vc.prototype,"view",null),u([d({type:VR})],vc.prototype,"viewModel",void 0),vc=u([C("esri.widgets.Zoom")],vc);var b4=vc;function XK(e){return e?.view!==void 0}var wT=class extends u4{constructor(e){super(e),this._defaultPositionLookup={attribution:"manual",compass:"top-left","navigation-toggle":"top-left",zoom:"top-left"},this.components=[],this._updateViewAwareWidgets=t=>{this.components.forEach(i=>{let r=this._find(i),n=r?.widget;XK(n)&&(n.view=t)})},this._componentsWatcher=(t,i)=>{this._removeComponents(i),this._addComponents(t),this._adjustPadding(t)}}initialize(){this.addHandles([S(()=>this.components,this._componentsWatcher,Re),S(()=>this.view,this._updateViewAwareWidgets,Re)])}_add(e,t,i,r,n){let s=e;if(typeof e=="string"&&this._defaultPositionLookup[e]){if(this._find(e))return;s=this._createComponent(e)}super._add(s,t,i,r,n)}_removeComponents(e){e.forEach(t=>{let i=this._find(t);i&&(this.remove(i),i.destroy())})}_adjustPadding(e){if(!e.includes("attribution")&&!this._isOverridden("padding")){let{top:t}=this.padding;this.padding=t}}_addComponents(e){this.constructed&&e.forEach(t=>this.add(this._createComponent(t),this._defaultPositionLookup[t]))}_createComponent(e){let t=this._createWidget(e);return new Fu({id:e,node:t})}_createWidget(e){let t=this.view;switch(e){case"attribution":return new h4({view:t});case"compass":return new f4({view:t});case"navigation-toggle":return new _4({view:t});case"zoom":return new b4({view:t})}}};u([d()],wT.prototype,"components",void 0),wT=u([C("esri.views.ui.DefaultUI")],wT);var Vu=wT;var bT=class extends Vu{constructor(e){super(e),this.components=["attribution","zoom"]}};u([d()],bT.prototype,"components",void 0),bT=u([C("esri.views.ui.2d.DefaultUI2D")],bT);var HR=bT;var BR,CT=BR=class extends dn{constructor(e){super(e),this.color=new _n([0,0,0,1])}clone(){return new BR(ro({color:this.color}))}};u([d({type:_n,json:{write:!0}})],CT.prototype,"color",void 0),CT=BR=u([C("esri.webmap.background.ColorBackground")],CT);var C4=CT;var T4,E4,D4,x4,M4,S4,I4;async function JK(){let[,{GraphicsView2D:e,GraphicContainer:t,LabelManager:i,MapViewNavigation:r,MagnifierView2D:n,GridView2D:s,Stage:o}]=await Promise.all([import("./chunk-KNLVA5SZ.js"),import("./chunk-2K6JY746.js")]);E4=e,D4=t,x4=i,M4=r,S4=n,I4=s,T4=o}var Lt=class extends Sz(VC(BC(HC(GC)))){constructor(e){super(e),this._magnifierView=null,this._gridView=null,this.stage=null,this._resolveWhenReady=[],this.rootLayerViews=new $l({getCollections:()=>[this.basemapView?.baseLayerViews,this.layerViews,this.basemapView?.referenceLayerViews],getChildrenFunction:()=>null}),this.featuresTilingScheme=null,this.graphicsView=null,this.labelManager=null,this.navigation=new rf({actionMap:new ay({dragTertiary:"none"})}),this.renderingOptions={samplingMode:"dynamic",edgeLabelsVisible:!0,labelsAnimationTime:125,labelCollisionsEnabled:!0},this.supersampleScreenshotsEnabled=!0,this.supportsGround=!1,this.floors=new lt,this.grid=null,this.map=null,this.spatialReferenceLocked=!1,this.timeline=new uM,this.type="2d",this.view2dType=null,this.ui=new HR,this.test={takeScreenshot:async t=>o4(this._getScreenshotView(t),t)},this.padding={top:0,right:0,bottom:0,left:0},tw()}destroy(){this.layerViewManager.clear(),this._set("preconditionsReady",!1),this.frameTask=G(this.frameTask),this.goToManager.destroy(),this.rootLayerViews.destroy(),this.inputManager.destroy(),this._set("inputManager",null)}get graphicsTileStore(){return new _T(this.featuresTilingScheme)}get constraintsInfo(){let e=this.defaultsFromMap?.tileInfo,t=this.spatialReference;return{lods:e?.spatialReference?.equals(t)?e.lods:null,spatialReference:t}}get initialExtentRequired(){if(!this.stateManager)return!1;let{scale:e,constraints:t,center:i,viewpoint:r,extent:n}=this,s=this.zoom;return!(this.map&&"initialViewProperties"in this.map&&this.map.initialViewProperties?.viewpoint)&&!n&&(t?.effectiveLODs||(s=-1),(!i||e===0&&s===-1)&&(r?.targetGeometry==null||r.targetGeometry.type!=="extent"&&!r.scale))}get defaultsFromMapSettings(){return{required:{extent:!1,heightModelInfo:!1,tileInfo:!0},requiresExtentInSpatialReference:this.spatialReferenceLocked}}get scheduler(){return this.frameTask.scheduler}get typeSpecificPreconditionsReady(){let e=this._getDefaultViewpoint();if(!e)return!1;let t=e.targetGeometry,i=this.spatialReference;return Va(t.spatialReference,i)}get background(){return fw(this.map)?this.map.initialViewProperties.background:null}set background(e){this._override("background",e)}get center(){return this.stateManager?.center??null}set center(e){this.stateManager.center=e}get highlightOptions(){return dV(this)}set highlightOptions(e){hV(this,e)}get padding(){return this.stateManager?.padding}set padding(e){this.stateManager&&(this.stateManager.padding=e)}get rendering(){return this.stage?.renderRequested??!1}get resolution(){return this.stateManager.resolution??0}get scale(){return this.stateManager?.scale??0}set scale(e){this.stateManager&&(this.stateManager.scale=e)}get tileInfo(){return this.featuresTilingScheme?.tileInfo}get updating(){let e=!(!this.magnifier.visible||this.magnifier.position===null||!this._magnifierView?.updatingHandles.updating),t=!this.destroyed&&(!this.layerViewManager||!this.labelManager||!this.graphicsView||this.layerViewManager.updating===!0||this.labelManager.updating===!0||this.graphicsView.updating===!0||this.allLayerViews.some(i=>!i.destroyed&&!("layerViews"in i)&&i.updating===!0)||e);if(Ct("esri-2d-log-updating")){let i=this.allLayerViews.reduce((r,n)=>be(ie({},r),{[`${n.layer.id}(${n.layer.type})`]:!n.destroyed&&!("layerViews"in n)&&n.updating}),{});console.log(`Updating MapView: ${t}
-> Null LayerViewManager: ${!this.layerViewManager}
-> Null LabelManager: ${!this.labelManager}
-> Null GraphicsView: ${!this.graphicsView}
-> layerViewManager.updating: ${this.layerViewManager?.updating}
-> labelManager.updating: ${this.labelManager?.updating}
-> graphicsView.updating: ${this.graphicsView?.updating}
-> allLayerViews: ${JSON.stringify(i)}
-> updatingMagnifier: ${e}
`)}return t}get visibleArea(){let e=this.stateManager.visibleArea;return e&&new Ip({rings:[e.map(t=>[t[0],t[1]])],spatialReference:this.spatialReference})}get zoom(){return this.stateManager.zoom??-1}set zoom(e){this.stateManager.zoom=e}get navigating(){return this.mapViewNavigation?.interacting??!1}async hitTest(e,t){return r4(this,e,t)}async takeScreenshot(e){return s4(this._getScreenshotView(e),e)}toMap(e){if(!this.ready)return null;let t=kd(e)?Fd(this,e):e;return this.stateManager.toMap(t)}toScreen(e,t){return this.stateManager.toScreen(e,t)}whenLayerView(e){return super.whenLayerView(e)}graphicChanged(e){this.graphicsView&&this.graphicsView.graphicUpdateHandler(e)}whenReady(){return new Promise(e=>{this.ready?e(this):this._resolveWhenReady.push(e)})}forceDOMReadyCycle(){this.forceReadyCycle()}getDefaultSpatialReference(){return this.map&&"initialViewProperties"in this.map&&this.map.initialViewProperties.spatialReference||this.defaultsFromMap?.spatialReference||null}getDefaultTimeZone(){return fw(this.map)?this.map.initialViewProperties.timeZone:null}getDefaultTimeExtent(){return fw(this.map)?this.map.initialViewProperties.timeExtent:null}hasLayerViewModule(e){return MR.hasLayerViewModule(e)}importLayerView(e){return MR.importLayerView(e)}pixelSizeAt(){return this.ready?this.resolution:(W.getLogger(this).error("#pixelSizeAt()","Map view cannot be used before it is ready"),null)}async popupHitTest(e){let t=this.toMap(e),i=await this.hitTest(e),r=this.allLayerViews.toArray().filter(l=>l.clips.every(c=>uw(this,c,e,t))).reverse(),n=new globalThis.Map(r.map(l=>[l.layer.uid,l])),s=[],o=0,a=0;for(;o<i.results.length||a<r.length;){let l=i.results.at(o);if(l&&l.type!=="graphic"){++o;continue}let c=n.get((l?.layer??l?.graphic.layer)?.uid);if((!l||c)&&a<r.length&&r.at(a)!==c){let h=r.at(a);"fetchPopupFeaturesAtLocation"in h&&s.push({mapPoint:t,layerView:h}),++a}else l&&(s.push({graphic:l.graphic,layerView:c}),++o)}return{hits:s,location:t}}requestUpdate(){this.ready&&this.frameTask.requestUpdate()}async validate(){let e=yT(this.type);if(Ct("safari")&&Ct("safari")<9&&(e=new Be("mapview:browser-not-supported","This browser is not supported by MapView (Safari < 9)",{type:"safari",requiredVersion:9,detectedVersion:Ct("safari")})),e!=null)throw W.getLogger(this).warn("#validate()",e.message),e}loadAsyncDependencies(){return JK()}_getDefaultViewpoint(){let{constraints:e,initialExtent:t,map:i,padding:r,size:n}=this;if(!e)return null;let s=i&&"initialViewProperties"in i?i.initialViewProperties:void 0,o=this.stateManager.getUserStartupOptions(this.size),a=s?.viewpoint,l=a?.targetGeometry?.extent??t,c=l?.center,h=a?.rotation??0,p=a?.scale||l&&ow(l,[n[0]-r.left-r.right,n[1]-r.top-r.bottom]),m=o.center??c,f=o.rotation??h,g=o.scale??p;return m&&g?new Si({targetGeometry:m,scale:g,rotation:f}):null}_startup(){this.timeline.begin("MapView Startup");let e=this._getDefaultViewpoint();this.stateManager.startup(e,this.size,this.spatialReference,this.defaultsFromMap.extent?.center),this.graphics.owner=this;let t=new T4(this.surface,{canvas:this.renderCanvas,contextOptions:{disabledExtensions:this.deactivatedWebGLExtensions,debugWebGLExtensions:this.debugWebGLExtensions},renderingOptions:this.renderingOptions,timeline:this.timeline});this.stage=t,this._magnifierView=new S4,this._magnifierView.magnifier=this.magnifier,this._gridView=new I4;let i=new x4({view:this});this._set("labelManager",i);let r=new Jz({view:this});this._set("animationManager",r);let n=new M4({view:this,animationManager:r});this._set("mapViewNavigation",n),this._setupSpatialReferenceDependentProperties(),this.addHandles([this.rootLayerViews.on("change",()=>this._updateStageChildren()),t.on("webgl-error",o=>this.fatalError=o.error),S(()=>this.stationary,o=>t.stationary=o,Ce),S(()=>this.background,o=>{t.backgroundColor=o?.color,this._magnifierView.backgroundColor=o?.color},Ce),S(()=>this.magnifier,o=>this._magnifierView.magnifier=o,Ce),S(()=>this.grid,o=>this._gridView.grid=o,Ce),S(()=>this.renderingOptions,o=>t.renderingOptions=o,Ce),S(()=>this.highlights.items.map(o=>({name:o.name,options:{fillColor:o.color,haloColor:o.haloColor,fillOpacity:o.fillOpacity,haloOpacity:o.haloOpacity,haloWidth:o.haloWidth,haloBlur:o.haloBlur}})),()=>{t.highlightGradient=aV(t.highlightGradient,this.highlights.items)},Ce),S(()=>this.state.id,()=>t.state=this.state,Ce)],"map-view"),this._updateStageChildren();let s=this._resolveWhenReady;this._resolveWhenReady=[],s.forEach(o=>o(this)),this.timeline.end("MapView Startup"),this.frameTask.start(),this._set("ready",!0)}_teardown(){this._destroySpatialReferenceDependentProperties(),this.removeHandles("map-view"),this.mapViewNavigation.destroy(),this._set("mapViewNavigation",null),this.animation=null,this.animationManager.destroy(),this._set("animationManager",null),this.layerViewManager.clear(),this.labelManager.destroy(),this._magnifierView.destroy(),this._gridView.destroy(),this.stage.destroy(),this.stage=null,this._set("graphicsView",null),this._magnifierView=null,this._gridView=null,this._set("labelManager",null),this._set("mapViewNavigation",null),this.graphics.owner=null,this.frameTask.stop(),this.stationaryManager.clear(),this._set("ready",!1),this.stateManager.teardown()}_updateStageChildren(){this.stage.removeAllChildren(),this.rootLayerViews.forEach(t=>{this.stage.addChild(t.container)});let e=this.graphicsView;this.stage.addChild(e.container),this.stage.addChild(this._magnifierView),this.stage.addChild(this._gridView)}_setupSpatialReferenceDependentProperties(){let e=new UL(X2.create({spatialReference:this.spatialReference,size:512,numLODs:36}));this._set("featuresTilingScheme",e);let t=new E4({view:this,graphics:this.graphics,requestUpdateCallback:()=>this.requestUpdate(),container:new D4(e)});this._set("graphicsView",t)}_destroySpatialReferenceDependentProperties(){let e=this.graphicsView;this._set("graphicsView",null),e.destroy(),this._set("featuresTilingScheme",null)}_getScreenshotView(e){let{allLayerViews:t,padding:i,size:r,stage:n}=this;return{allLayerViews:t,backgroundColor:e?.ignoreBackground?null:this.background?.color,padding:i,size:r,stage:n}}_spatialReferenceChanged(e){if(this.ready){this.frameTask.stop();for(let t of this.allLayerViews)t.processDetach();this._destroySpatialReferenceDependentProperties(),this.stateManager.changeSpatialReference(e),this.stage.state=this.state,this._setupSpatialReferenceDependentProperties();for(let t of this.allLayerViews)t.processAttach();this.frameTask.requestFrame(),this.frameTask.start(),this._updateStageChildren()}}};Lt.type="2d",u([d({constructOnly:!0})],Lt.prototype,"deactivatedWebGLExtensions",void 0),u([d({constructOnly:!0})],Lt.prototype,"debugWebGLExtensions",void 0),u([d({readOnly:!0})],Lt.prototype,"featuresTilingScheme",void 0),u([d({readOnly:!0})],Lt.prototype,"graphicsTileStore",null),u([d()],Lt.prototype,"graphicsView",void 0),u([d()],Lt.prototype,"constraintsInfo",null),u([d()],Lt.prototype,"initialExtentRequired",null),u([d()],Lt.prototype,"labelManager",void 0),u([d({type:rf,nonNullable:!0})],Lt.prototype,"navigation",void 0),u([d({constructOnly:!0})],Lt.prototype,"renderCanvas",void 0),u([d()],Lt.prototype,"renderingOptions",void 0),u([d({constructOnly:!0})],Lt.prototype,"supersampleScreenshotsEnabled",void 0),u([d({readOnly:!0})],Lt.prototype,"supportsGround",void 0),u([d()],Lt.prototype,"defaultsFromMapSettings",null),u([d({readOnly:!0})],Lt.prototype,"typeSpecificPreconditionsReady",null),u([d({type:C4})],Lt.prototype,"background",null),u([d()],Lt.prototype,"center",null),u([d({type:lt})],Lt.prototype,"floors",void 0),u([d()],Lt.prototype,"grid",void 0),u([d({type:_o})],Lt.prototype,"highlightOptions",null),u([d()],Lt.prototype,"map",void 0),u([d()],Lt.prototype,"padding",null),u([d({readOnly:!0})],Lt.prototype,"rendering",null),u([d({readOnly:!0})],Lt.prototype,"resolution",null),u([d()],Lt.prototype,"scale",null),u([d({constructOnly:!0})],Lt.prototype,"spatialReferenceLocked",void 0),u([d({readOnly:!0})],Lt.prototype,"tileInfo",null),u([d({type:uM,readOnly:!0})],Lt.prototype,"timeline",void 0),u([d({readOnly:!0})],Lt.prototype,"type",void 0),u([d({readOnly:!0})],Lt.prototype,"updating",null),u([d({readOnly:!0})],Lt.prototype,"view2dType",void 0),u([d({readOnly:!0})],Lt.prototype,"visibleArea",null),u([d()],Lt.prototype,"zoom",null),u([d({readOnly:!0})],Lt.prototype,"navigating",null),u([d(),Sr(e=>e instanceof Vu?e:o0(HR,e))],Lt.prototype,"ui",void 0),Lt=u([C("esri.views.View2D")],Lt);var A4=Lt;var TT=class extends A4{constructor(e){super(e),this.view2dType="map"}};u([d({readOnly:!0})],TT.prototype,"view2dType",void 0),TT=u([C("esri.views.MapView")],TT);var ET=TT;var DT=class e{constructor(t,i){this.positionService=t;this.cdRef=i}positions=[];highlighted=null;view=null;graphicsLayer=new Qg;ngOnInit(){let t=new xu({basemap:"satellite",layers:[this.graphicsLayer]});this.view=new ET({container:"viewDiv",map:t,center:[0,0],zoom:2,popupEnabled:!0}),this.positionService.getPositions().subscribe(i=>{this.positions=[...i],this.cdRef.detectChanges(),this.updateGraphics()})}ngOnChanges(t){t.highlighted&&this.positions?.length>0&&(console.log("ngOnChanges called",t),this.updateGraphics())}updateGraphics(){this.graphicsLayer.removeAll(),this.positions.forEach((i,r)=>{let n=new pt({longitude:parseFloat(i.longitude),latitude:parseFloat(i.latitude)}),s=this.highlighted===i,o=r===0,a;s?a=new Fp({color:[255,255,0],size:"14px",outline:{color:[255,255,255],width:2}}):o?a=new F0({url:"https://developers.arcgis.com/javascript/latest/sample-code/satellites-3d/live/satellite.png",width:"36px",height:"36px"}):a=new Fp({color:[0,122,255],size:"10px",outline:{color:[255,255,255],width:1}});let l=new L0({title:`ISS Position ${o?"(Latest)":`#${r+1}`}`,content:`
          <div style="padding: 10px;">
            <p><strong>Posizione:</strong></p>
            <p>Latitudine: ${i.latitude}\xB0</p>
            <p>Longitudine: ${i.longitude}\xB0</p>
            <p><strong>Data:</strong> ${i.time}</p>
            ${o?"<p><em>Posizione pi\xF9 recente</em></p>":""}
          </div>
        `}),c=new rs({geometry:n,symbol:a,popupTemplate:l,attributes:{index:r,isLatest:o}});this.graphicsLayer.add(c)});let t=this.positions[0];t&&this.view?.goTo({center:[parseFloat(t.longitude),parseFloat(t.latitude)],zoom:3}).catch(i=>console.error("GoTo error:",i))}static \u0275fac=function(i){return new(i||e)(It(ol),It(cc))};static \u0275cmp=Bs({type:e,selectors:[["app-map"]],inputs:{highlighted:"highlighted"},features:[sc],decls:1,vars:0,consts:[["id","viewDiv"]],template:function(i,r){i&1&&Lr(0,"div",0)},styles:["#viewDiv[_ngcontent-%COMP%]{width:100%;height:100%}"]})};var xT=class e{constructor(t,i){this.positionService=t;this.cdRef=i}positions=[];map=null;highlighted=null;view=null;featureLayer=null;ngOnInit(){this.initializeMap(),this.loadPositions()}ngOnChanges(t){t.highlighted&&this.positions?.length>0&&this.updateGraphics()}initializeMap(){this.map=new xu({basemap:"satellite"}),this.view=new ET({container:"viewDiv",map:this.map,center:[0,0],zoom:2,popupEnabled:!0})}loadPositions(){this.positionService.getPositions().subscribe(t=>{this.positions=[...t],this.cdRef.detectChanges(),this.createFeatureLayer()})}createFeatureLayer(){this.featureLayer&&this.map?.remove(this.featureLayer);let t=this.createGraphicsFromPositions(),i=[{name:"ObjectID",alias:"ID",type:"oid"},{name:"latitude",alias:"Latitude",type:"double"},{name:"longitude",alias:"Longitude",type:"double"},{name:"formatted",alias:"Date",type:"string"},{name:"symbolType",alias:"Symbol Type",type:"string"}];this.featureLayer=new dF({source:t,fields:i,objectIdField:"ObjectID",geometryType:"point",spatialReference:{wkid:4326},title:"ISS Positions",renderer:{type:"unique-value",field:"symbolType",uniqueValueInfos:[{value:"latest",symbol:new F0({url:"/satellite.svg",width:"24px",height:"24px"})},{value:"highlighted",symbol:new Fp({color:[255,255,0],size:"14px",outline:{color:[255,255,255],width:2}})},{value:"normal",symbol:new Fp({color:[0,122,255],size:"10px",outline:{color:[255,255,255],width:1}})}]},popupTemplate:new L0({title:"ISS Position",content:`
          <div style="padding: 10px;">
            <p><strong>Latitude:</strong> {latitude}&#176;</p>
            <p><strong>Longitude:</strong> {longitude}&#176;</p>
            <p><strong>Date:</strong> {formatted}</p>
          </div>
        `})}),this.map?.add(this.featureLayer),this.goToLatestPosition()}createGraphicsFromPositions(){return this.positions.map((t,i)=>{let r=new pt({longitude:parseFloat(t.longitude),latitude:parseFloat(t.latitude)}),n=i===0,s=this.highlighted?.time===t.time,o="normal";return n&&(o="latest"),s&&(o="highlighted"),new rs({geometry:r,attributes:{ObjectID:i+1,latitude:parseFloat(t.latitude),longitude:parseFloat(t.longitude),formatted:t.time,symbolType:o}})})}updateGraphics(){if(!this.featureLayer||!this.positions.length)return;let t=this.createGraphicsFromPositions();this.featureLayer.applyEdits({deleteFeatures:this.featureLayer.source.toArray(),addFeatures:t}).catch(i=>console.error("ApplyEdits error:",i))}goToLatestPosition(){let t=this.positions[0];t&&this.view&&this.view.goTo({center:[parseFloat(t.longitude),parseFloat(t.latitude)],zoom:3}).catch(i=>console.error("GoTo error:",i))}highlightPosition(t){this.highlighted=t,this.updateGraphics(),t&&this.view&&this.view.goTo({center:[parseFloat(t.longitude),parseFloat(t.latitude)],zoom:5}).catch(i=>console.error("GoTo error:",i))}clearHighlight(){this.highlighted=null,this.updateGraphics()}static \u0275fac=function(i){return new(i||e)(It(ol),It(cc))};static \u0275cmp=Bs({type:e,selectors:[["app-map-feature"]],inputs:{highlighted:"highlighted"},features:[sc],decls:1,vars:0,consts:[["id","viewDiv"]],template:function(i,r){i&1&&Lr(0,"div",0)},styles:["#viewDiv[_ngcontent-%COMP%]{width:100%;height:100%}"]})};function UR(e,t){let i=wx(e),r=wx(t),n=i.store,s=r.store,o=r.metadata;for(let a in o){let l=o[a],c=n.originOf(a),h=s.originOf(a);if(!l.readOnly&&h!==bx.DEFAULTS)if(c===bx.DEFAULTS)e.set(a,s.get(a));else{let p=n.get(a),m=s.get(a);p&&m&&m instanceof P&&p instanceof P&&p instanceof m.constructor&&UR(p,m)}}}var Hu=class extends oi.EventedAccessor{constructor(e){super(e),this.demResolution={min:-1,max:-1},this.noDataValue=t_}initialize(){this.view.basemapTerrain.on("elevation-change",()=>this.emit("changed",{}))}get extent(){let e=this.view.basemapTerrain;if(e?.extent==null||e.spatialReference==null)return null;let t=m0(e.extent,e.spatialReference);return t.zmin=e.visibleElevationBounds.min,t.zmax=e.visibleElevationBounds.max,t}get spatialReference(){return this.view.basemapTerrain?.spatialReference??Qt.WGS84}elevationAt(e,t){if(this.extent==null||!D2(this.extent,e,t)){let i=this.extent!=null?`${this.extent.xmin}, ${this.extent.ymin}, ${this.extent.xmax}, ${this.extent.ymax}`:null;return W.getLogger(this).warn("#elevationAt()",`Point used to sample elevation (${e}, ${t}) is outside of the sampler extent (${i})`),this.noDataValue}return this.view.elevationProvider?.getElevation(e,t,0,this.spatialReference,"ground")??this.noDataValue}queryElevation(e){return Ek(e.clone(),this)}};u([d({readOnly:!0})],Hu.prototype,"demResolution",void 0),u([d({readOnly:!0})],Hu.prototype,"extent",null),u([d({readOnly:!0})],Hu.prototype,"noDataValue",void 0),u([d()],Hu.prototype,"spatialReference",null),u([d({constructOnly:!0})],Hu.prototype,"view",void 0),Hu=u([C("esri.views.support.GroundViewElevationSampler")],Hu);var R4=Hu;var wc=class extends P{constructor(e){super(e),this.view=null,this.layerViews=new lt}initialize(){this.addHandles(Wi(()=>this.view?.map?.ground,e=>e.load())),this.addHandles(this.layerViews.on("after-changes",()=>this._layerViewsAfterChangesHandler()))}destroy(){this._set("view",null);for(let e of this.layerViews)e.destroy();this.layerViews.length=0}get elevationSampler(){return this.view?this.view.type==="2d"?null:this.view.ready&&this.view.basemapTerrain&&this.view.basemapTerrain.ready?new R4({view:this.view}):null:null}get extent(){let e=this.view;return e&&e.type!=="2d"&&e.ready?Sw(e,e.state.camera,e.pointsOfInterest.centerOnSurfaceFrequent.renderLocation):null}get updating(){return!this.suspended&&this.layerViews.some(e=>e.updating)}get suspended(){return this.view?.suspended??!0}_layerViewsAfterChangesHandler(){this.removeHandles("updating"),this.addHandles(this.layerViews.map(e=>S(()=>e.updating,()=>this._updateUpdating(),Fe)).toArray(),"updating"),this._updateUpdating()}_updateUpdating(){this.notifyChange("updating")}};u([d({readOnly:!0})],wc.prototype,"elevationSampler",null),u([d({readOnly:!0})],wc.prototype,"extent",null),u([d({type:Boolean,readOnly:!0})],wc.prototype,"updating",null),u([d({constructOnly:!0})],wc.prototype,"view",void 0),u([d({type:lt,readOnly:!0})],wc.prototype,"layerViews",void 0),u([d({readOnly:!0})],wc.prototype,"suspended",null),wc=u([C("esri.views.GroundView")],wc);var P4=wc;var vy=()=>import("./chunk-26P46EUC.js"),O4=()=>import("./chunk-X5ZWBC5P.js"),N4={"base-dynamic":()=>import("./chunk-KTODZOYW.js"),"base-elevation":O4,"base-tile":vy,"bing-maps":vy,"building-scene":()=>import("./chunk-7XKCMY2Y.js"),catalog:()=>import("./chunk-335EF7QR.js"),"catalog-dynamic-group":()=>import("./chunk-53P6Y2AF.js"),"catalog-footprint":()=>import("./chunk-BSIHNVUL.js"),csv:()=>import("./chunk-4OYQLV3Z.js"),dimension:()=>import("./chunk-V4I3ODWE.js"),elevation:O4,feature:()=>import("./chunk-5XK6PHJE.js"),geojson:()=>import("./chunk-O3ZSLQIQ.js"),graphics:()=>import("./chunk-HVBHXIBY.js"),group:()=>import("./chunk-D2FOSHOX.js"),imagery:()=>import("./chunk-2EU3PE5F.js"),"integrated-mesh":()=>import("./chunk-PNDDH7U4.js"),"integrated-mesh-3dtiles":()=>import("./chunk-N7LMND5Z.js"),"line-of-sight":()=>import("./chunk-Z4RILFQ6.js"),"map-image":()=>import("./chunk-Z5F4T2DQ.js"),media:()=>import("./chunk-KOY3LJ4N.js"),"ogc-feature":()=>import("./chunk-Z6WGCQC4.js"),"open-street-map":vy,"oriented-imagery":()=>import("./chunk-5XK6PHJE.js"),"point-cloud":()=>import("./chunk-UKR4IQWW.js"),viewshed:()=>import("./chunk-EHCFNQV3.js"),voxel:()=>import("./chunk-SV7P5JOQ.js"),route:()=>import("./chunk-ITKNZC66.js"),scene:e=>e.profile==null||e.profile==="mesh-pyramids"?import("./chunk-U6PV7FZZ.js"):import("./chunk-UXSBHYRX.js"),stream:()=>import("./chunk-RP3WMVLV.js"),tile:vy,"imagery-tile":()=>import("./chunk-LVGOHIOJ.js"),"vector-tile":()=>import("./chunk-QKW2AF5F.js"),wcs:()=>import("./chunk-LVGOHIOJ.js"),"web-tile":vy,wfs:()=>import("./chunk-ETEFQMCC.js"),wms:()=>import("./chunk-NSGUGUXJ.js"),wmts:()=>import("./chunk-TEGY3VX3.js"),parquet:null,"geo-rss":null,kml:null,"knowledge-graph":null,"link-chart":null,"knowledge-graph-sublayer":null,"map-notes":null,"subtype-group":null,unknown:null,unsupported:null,video:null};function eX(e){let t=e.declaredClass?e.declaredClass.slice(e.declaredClass.lastIndexOf(".")+1):"Unknown",i=t.replaceAll(/([a-z])([A-Z])/g,"$1-$2").toLowerCase();return new Be(`${i}:view-not-supported`,`${t} is not supported in 3D`)}var jR={hasLayerViewModule:e=>N4[e.type]!=null,importLayerView:e=>{let t=N4[e.type];if(t==null)throw eX(e);return t(e)}};var L4="analyses-owner-handles",Df,Oh;(function(e){e[e.PENDING=0]="PENDING",e[e.CREATED=1]="CREATED"})(Df||(Df={})),function(e){e[e.ADDED=0]="ADDED",e[e.REMOVED=1]="REMOVED"}(Oh||(Oh={}));var Ph=class extends P{constructor(e){super(e),this._allAnalysisViews=new lt,this._creatingViewCount=0,this._items=new Map,this._scheduledUpdateHandle=null,this._attachedToViewResolver=F4(),this._analysisModules={"area-measurement":{module:null},dimension:{module:null},"direct-line-measurement":{module:null},"line-of-sight":{module:null},slice:{module:null},viewshed:{module:null}}}destroy(){this._disconnectOwners(),this._attachedToViewResolver.reject(Mr("AnalysisViewManager was destroyed"))}attach(){this._connectOwners(),this._attachedToViewResolver.resolve()}detach(){this._disconnectOwners(),this._attachedToViewResolver.reject(Mr()),this._attachedToViewResolver=F4()}get updating(){return!this.view.ready||this._creatingViewCount!==0||this._allAnalysisViews.some(e=>e.updating)}get testInfo(){}async whenAnalysisView(e){await this._attachedToViewResolver.promise;let t=this._items.get(e);if(t==null||t.state.list===Oh.REMOVED)throw new Be("AnalysisViewManager:no-analysisview-for-analysis","The analysis has not been added to view.analyses",{analysis:e});return t.createAnalysisViewTask.promise}_connectOwners(){this.addHandles(this._connectAnalysesCollection(this.view.analyses),L4)}_disconnectOwners(){this.removeHandles(L4),this._update(),this._creatingViewCount=0}_connectAnalysesCollection(e){for(let r of e)this._addAnalysis(r);let t=e.on("after-add",r=>this._addAnalysis(r.item)),i=e.on("after-remove",r=>this._removeAnalysis(r.item));return _r(()=>{t.remove(),i.remove();for(let r of e)this._removeAnalysis(r)})}_addAnalysis(e){let t=this._items.get(e);if(t==null){let i={state:{view:Df.PENDING,list:Oh.ADDED},analysis:e,view:null,createAnalysisViewTask:null};this._items.set(e,i),i.createAnalysisViewTask=hn(r=>this._createAnalysisViewPromise(i,r))}else t.state.list=Oh.ADDED}_removeAnalysis(e){let t=this._items.get(e);t!=null?(t.state.list=Oh.REMOVED,this._scheduleUpdate()):W.getLogger(this).error("Trying to remove analysis which was not added")}_scheduleUpdate(){this._scheduledUpdateHandle==null&&(this._scheduledUpdateHandle=n0(()=>this._update()))}_update(){this._scheduledUpdateHandle=Ft(this._scheduledUpdateHandle),this._items.forEach(e=>{if(e.state.list===Oh.REMOVED)switch(this._items.delete(e.analysis),e.state.view){case Df.PENDING:e.createAnalysisViewTask=xr(e.createAnalysisViewTask);break;case Df.CREATED:e.view!=null&&(this._allAnalysisViews.remove(e.view),e.view=G(e.view),e.createAnalysisViewTask=null)}})}async _createAnalysisViewPromise(e,t){let i=e.analysis,r=i.type,n=this._analysisModules[r];if(this._creatingViewCount+=1,n.module==null)try{n.module=await this._loadAnalysisModule(r)}catch(a){throw this._creatingViewCount-=1,a}if(Fl(t))throw this._creatingViewCount-=1,Mr("AnalysisView creation aborted");let s=new n.module.default({analysis:i,view:this.view}),o=!0;so(t,()=>{o&&(this._creatingViewCount-=1,s.destroy())});try{await s.when()}catch(a){throw o=!1,s.destroyed||(this._creatingViewCount-=1,s.destroy()),a}if(Fl(t))throw Mr();return o=!1,e.view=s,e.state.view=Df.CREATED,this._allAnalysisViews.add(s),this._creatingViewCount-=1,s}_loadAnalysisModule(e){switch(e){case"area-measurement":return import("./chunk-RH73QE42.js");case"dimension":return import("./chunk-TSB42FUC.js");case"direct-line-measurement":return import("./chunk-Z74676RP.js");case"line-of-sight":return import("./chunk-DTKKCWET.js");case"slice":return import("./chunk-HDKS5TMJ.js");case"viewshed":return import("./chunk-ELHTFDPG.js")}}};function F4(){let e=As();return e.promise.catch(()=>{}),e}u([d()],Ph.prototype,"updating",null),u([d({constructOnly:!0})],Ph.prototype,"view",void 0),u([d()],Ph.prototype,"_allAnalysisViews",void 0),u([d()],Ph.prototype,"_creatingViewCount",void 0),Ph=u([C("esri.views.3d.analysis.AnalysisViewManager3D")],Ph);var k4=Ph;var ul=class extends P{constructor(e){super(e),this.collision=new wy,this.distance=1/0,this.minimumPoiDistance=4,this.tilt=null}get altitude(){return this.mode===Se.Local?null:this._get("altitude")||null}set altitude(e){this.mode!==Se.Local?this._set("altitude",e):W.getLogger(this).warn("Altitude constraint is ignored in local scenes")}get mode(){return this.state.viewingMode}clampAltitude(e){return this.altitude?q(e,this.altitude.min,this.altitude.max):e}clampTilt(e,t){if(!this.tilt)return t;let i=this.tilt(e);return q(t,i.min,i.max)}clampDistance(e){return Math.min(e,this.distance)}createDefaultTilt(){return this.mode===Se.Local?this._createDefaultTiltLocal():this._createDefaultTiltGlobal()}createConstantMaxTilt(e){return(t,i=zR)=>(i.min=fr.min,i.max=e,i)}_createDefaultTiltLocal(){let e=this.collision.enabled?Hp([[4e3,fr.max],[1e4,kt(88)],[6e6,kt(88)]]):()=>fr.max;return(t,i=zR)=>(i.min=fr.min,i.max=e(t),i)}_createDefaultTiltGlobal(){let e=this.collision.enabled?Hp([[4e3,fr.max],[5e4,kt(88)],[6e6,kt(88)],[2e7,fr.min]]):Hp([[3e5,fr.max],[3e6,kt(88)],[6e6,kt(88)],[2e7,fr.min]]);return(t,i=zR)=>(i.min=fr.min,i.max=e(t),i)}};function tX(e){return{min:-2e5,max:4*e.radius}}u([d()],ul.prototype,"altitude",null),u([d({readOnly:!0})],ul.prototype,"collision",void 0),u([d()],ul.prototype,"distance",void 0),u([d({readOnly:!0})],ul.prototype,"minimumPoiDistance",void 0),u([d()],ul.prototype,"tilt",void 0),u([d({constructOnly:!0})],ul.prototype,"state",void 0),ul=u([C("esri.views.3d.state.Constraints")],ul);var GR=tX(pn),fr={min:kt(.5),max:kt(179.5)},zR={min:0,max:0},wy=class extends P{constructor(){super(...arguments),this.enabled=!0,this.elevationMargin=5}};u([d({type:Boolean})],wy.prototype,"enabled",void 0),u([d({type:Number})],wy.prototype,"elevationMargin",void 0),wy=u([C("esri.views.3d.state.Constraints.CollisionConstraint")],wy);var Nh=class extends Ha{constructor(){super(...arguments),this.min=GR.min,this.max=GR.max}};u([d({type:Number})],Nh.prototype,"min",void 0),u([d({type:Number})],Nh.prototype,"max",void 0),Nh=u([C("esri.views.3d.constraints.AltitudeConstraint")],Nh);var dl=class extends Ha{constructor(){super(...arguments),this.mode="auto"}get near(){return this._get("near")}set near(e){this._set("near",e),e>=this._get("far")&&(this.far=e+1e-9),this.mode="manual"}castNear(e){return Math.max(1e-8,e)}get far(){return this._get("far")}set far(e){this._set("far",e),e<=this._get("near")&&(this.near=e-1e-9),this.mode="manual"}castFar(e){return Math.max(1e-8,e)}autoUpdate(e,t){this.mode==="auto"&&(this._get("near")!==e&&this._set("near",e),this._get("far")!==t&&this._set("far",t))}};u([d({type:Number,value:1e-8})],dl.prototype,"near",null),u([Sr("near")],dl.prototype,"castNear",null),u([d({type:Number,value:1e-8})],dl.prototype,"far",null),u([Sr("far")],dl.prototype,"castFar",null),u([d({type:["auto","manual"]})],dl.prototype,"mode",void 0),dl=u([C("esri.views.3d.constraints.ClipDistanceConstraint")],dl);var qR={min:kl(fr.min),max:kl(fr.max)},Bu=class extends Ha{constructor(e){super(e),this.mode="auto"}get max(){return this._get("max")}set max(e){this._set("max",e),this.mode="manual"}castMax(e){return q(e,qR.min,qR.max)}autoUpdate(e){this.mode==="auto"&&this._get("max")!==e&&this._set("max",e)}};u([d({type:["auto","manual"]})],Bu.prototype,"mode",void 0),u([d({type:Number,value:qR.max})],Bu.prototype,"max",null),u([Sr("max")],Bu.prototype,"castMax",null),Bu=u([C("esri.views.3d.constraints.TiltConstraint")],Bu);var Uu=class extends Ha{constructor(e){super(e),this.tilt=new Bu,this.altitude=new Nh,this.clipDistance=new dl}};u([d({type:Bu})],Uu.prototype,"tilt",void 0),u([d({type:Nh})],Uu.prototype,"altitude",void 0),u([d({type:dl})],Uu.prototype,"clipDistance",void 0),Uu=u([C("esri.views.3d.constraints.Constraints")],Uu);function WR(e){return Fa(e,OL)||u0(e)?{wkid:Ix.GCSMARS2000}:Fa(e,NL)||d0(e)?{wkid:Ix.GCSMOON2000}:Qt.WGS84}var Lh=class{constructor(t,i,r,n,s,o,a,l,c=.5){this.coverage=t,this.density=i,this.absorption=r,this.cloudSize=n,this.detailSize=s,this.smoothness=o,this.cloudHeight=a,this.raymarchingSteps=l,this.median=c}},br={sunny:new Lh([0,.6],[.03,.03],[0,0],[.9,.9],[.8,.8],[.7,.7],[.05,.05],da.SIXTEEN),cloudy:new Lh([.3,.65],[.2,.4],[0,0],[.85,.85],[.75,.75],[.3,.4],[1,1],da.TWOHUNDRED,.6),rainy:new Lh([.6,.8],[.5,.8],[.1,.5],[.9,.9],[.75,.75],[.5,.5],[1,1],da.TWOHUNDRED,.4),snowy:new Lh([.25,.75],[.3,.3],[0,0],[.95,.95],[.7,.7],[.69,.75],[.3,1],da.HUNDRED,.65),foggy:new Lh([.8,.8],[.5,.5],[0,0],[.95,.95],[.9,.9],[.55,.55],[.3,.3],da.SIXTEEN)};br.default=br.sunny;var xf=class extends ft{constructor(t,i){super(t,i,new mt(W3,()=>import("./chunk-ZAAPIOMZ.js")))}initializePipeline(t){return Tt({blending:qp(ei.CONSTANT_COLOR,ei.ONE_MINUS_CONSTANT_COLOR,ML.ADD,t.writeTextureChannels===Kg.RG?[1,1,0,0]:[0,0,1,1]),depthTest:{func:Ei.LEQUAL},colorWrite:St})}};var Mf=class extends ft{constructor(t,i){super(t,i,new mt(Z3,()=>import("./chunk-5ODXXIYL.js")))}initializePipeline(t){return Tt({blending:t.mode===hm.Full?Wp:za(ei.ZERO,ei.ONE,ei.ONE,ei.ZERO),depthTest:{func:Ei.ALWAYS},colorWrite:St})}};var by=class extends P{constructor(e){super(e),this._needsRender=!0,this._passParameters=new $3,this._configuration=new kw,this._fbo=new $a(e.context.renderContext.rctx,new vi(Lw)),e.context.techniques.precompile(Mf,new kw);let t=new kw;t.mode=hm.WeatherMap,e.context.techniques.precompile(Mf,t)}get textureAtlas(){if(this._texture&&!this._needsRender)return this._texture;this._configuration.mode=this._texture?hm.WeatherMap:hm.Full;let e=this.context.techniques.get(Mf,this._configuration);return e.compiled&&(this._texture=this._render(e)),this._texture}updateWeatherMap(e){E0(this._passParameters.weatherTile,e)||(Yi(this._passParameters.weatherTile,e),this._needsRender=!0)}destroy(){this._fbo=We(this._fbo)}_render(e){if(!this._fbo)return null;let t=this.context.renderContext.rctx,i=t.getViewport();return t.setViewport(0,0,Lw,Lw),t.bindFramebuffer(this._fbo),t.bindTechnique(e,this.context.renderContext.bind,this._passParameters),t.screen.draw(),t.setViewport(i.x,i.y,i.width,i.height),this._needsRender=!1,this._fbo.colorTexture}};u([d({constructOnly:!0})],by.prototype,"context",void 0),by=u([C("esri.views.3d.environment.NoiseTextureAtlas")],by);var Tn=class extends P{constructor(e){super(e),this._state=On(Vd.Idle),this._passParameters=new q3,this._weatherTileCount=128,this._faceIndex=0,this._tileIndex=0,this._tilesPerFace=1,this.coverage=Xe(br.default.coverage[0],br.default.coverage[1],.5),this.density=Xe(br.default.density[0],br.default.density[1],.5),this.absorption=Xe(br.default.absorption[0],br.default.absorption[1],.5),this.cloudSize=Xe(br.default.cloudSize[0],br.default.cloudSize[1],.5),this.detailSize=Xe(br.default.detailSize[0],br.default.detailSize[1],.5),this.smoothness=Xe(br.default.smoothness[0],br.default.smoothness[1],.5),this.cloudHeight=Xe(br.default.cloudHeight[0],br.default.cloudHeight[1],.5),this.raymarchingSteps=br.default.raymarchingSteps,this._viewMatrix=Wt(),this._dirty=!0,this.running=!0,this._configuration=new G3}initialize(){let e=_t(this.view.spatialReference);this._passParameters.cloudRadius=.5*e.radius;let t=()=>this.setDirty();this.addHandles([this.view.resourceController.scheduler.registerTask(Xt.CLOUDS_GENERATOR,this),S(()=>this.coverage,t,Re),S(()=>this.density,t,Re),S(()=>this.absorption,t,Re),S(()=>this.cloudSize,t,Re),S(()=>this.detailSize,t,Re),S(()=>this.smoothness,t,Re),S(()=>this.cloudHeight,t,Re),S(()=>this.raymarchingSteps,t,Re)]);let i=DL(this._computeWeatherTile()),r=0;this.addHandles(S(()=>{let n=this._computeWeatherTile();return E0(i,n)||(++r,Yi(i,n)),r},t))}destroy(){this.destroyCubeMap(),this._passParameters.noiseTexture=G(this._passParameters.noiseTexture)}_precompileTechniques(){this._configuration.steps=this.raymarchingSteps,this._configuration.writeTextureChannels=Kg.RG,this.context.techniques.precompile(xf,this._configuration),this._configuration.writeTextureChannels=Kg.BA,this.context.techniques.precompile(xf,this._configuration)}_acquireTechnique(){switch(this.raymarchingSteps){case da.SIXTEEN:this._tilesPerFace=1;break;case da.HUNDRED:this._tilesPerFace=4;break;case da.COUNT:case da.TWOHUNDRED:this._tilesPerFace=8;break;default:this.raymarchingSteps}return this._configuration.writeTextureChannels=1-this.parameters.readChannels,this._configuration.steps=this.raymarchingSteps,this.context.techniques.get(xf,this._configuration)}_computeWeatherTile(){let{camera:e,environment:t}=this.view,{latitude:i,longitude:r}=e.position;if(i==null||r==null)return Sd;es(Ca,(i+90)/180,(r+180)/360);let n=Math.floor(this._weatherTileCount*Math.abs(2*Ca[0]-1));Ca[0]=Math.floor(2*this._weatherTileCount*Ca[0]),Ca[1]=Math.floor(4*(this._weatherTileCount-n)*Ca[1]);let s=0,o=0;if(t?.lighting?.type!=="virtual"&&t?.lighting?.date!=null){let a=new Date(t.lighting.date);a.setUTCHours(t.lighting.date.getUTCHours()+(t.lighting.displayUTCOffset??0)),s=31*a.getUTCMonth()+a.getUTCDate(),o=a.getUTCFullYear()}return Ca[0]=(Ca[0]+s)%(2*this._weatherTileCount),Ca[1]=(Ca[1]+o%100)%(4*this._weatherTileCount),Ca}get state(){return this._state.value}set state(e){this._state.value=e}get usedMemory(){return(this._fbo?.usedMemory??0)+(this._passParameters.noiseTexture?.textureAtlas?.usedMemory??0)}_ensureNoiseTexture(){return this._passParameters.noiseTexture??=new by({context:this.context}),this._passParameters.noiseTexture}_ensureFrameBufferCube(e){let t=this.context.renderContext.rctx;if(this._fbo==null){let i=new vi(e);i.target=Bg.TEXTURE_CUBE_MAP,i.wrapMode=ji.CLAMP_TO_EDGE,this._fbo=new $a(t,i),this.parameters.data=this}return t.unbindTexture(this._fbo.colorTexture),this._fbo}get cubeMap(){return this._fbo}get parameters(){return this.context.renderContext.bind.clouds}destroyCubeMap(){this._fbo=We(this._fbo),this.parameters.data=null}applyPreset(e,t){let i=e.median,r=n=>{let s=Xe(n[0],n[1],i);return t<.5?Xe(n[0],s,2*t):Xe(s,n[1],2*(t-.5))};this.coverage=r(e.coverage),this.density=r(e.density),this.absorption=r(e.absorption),this.cloudSize=r(e.cloudSize),this.detailSize=r(e.detailSize),this.smoothness=r(e.smoothness),this.cloudHeight=r(e.cloudHeight),this.raymarchingSteps=e.raymarchingSteps,this._precompileTechniques()}setDirty(){this._dirty=this.running=!0}runTask(e){if(this.state===Vd.Fading)return Ui;this._dirty&&(this._faceIndex=this._tileIndex=0,this.state=Vd.Rendering,this._passParameters.absorption=this.absorption,this._passParameters.density=this.density,this._passParameters.cloudSize=this.cloudSize,this._passParameters.detailSize=this.detailSize,this._passParameters.smoothness=this.smoothness,this._passParameters.cloudHeight=this.cloudHeight,this._passParameters.coverage=this.coverage,this._ensureNoiseTexture().updateWeatherMap(this._computeWeatherTile()),this._dirty=!1);let t=this._acquireTechnique();if(!this._ensureNoiseTexture().textureAtlas||!t.compiled)return Ui;let i=iX[this._faceIndex],r=rX[this._faceIndex];Z2(this._viewMatrix,nX,i,r),Op(this._passParameters.viewMatrix,this._viewMatrix);let n=this.context.renderContext.rctx,s=n.getViewport(),o=Fw/this._tilesPerFace,a=this._tileIndex*o;n.setViewport(0,a,Fw,o);let l=this._ensureFrameBufferCube(Fw);n.bindFramebuffer(l),n.bindTechnique(t,this.context.renderContext.bind,this._passParameters);let c=Bg.TEXTURE_CUBE_MAP_POSITIVE_X+this._faceIndex;return l.setColorTextureTarget(c),n.screen.draw(),n.gl.flush(),n.setViewport(s.x,s.y,s.width,s.height),this.requestRender(),++this._tileIndex,this._faceIndex===4&&this._tileIndex===this._tilesPerFace?(this._faceIndex=this._tileIndex=0,this.state=Vd.Ready,this.running=!1):this._tileIndex===this._tilesPerFace&&(++this._faceIndex,this._tileIndex=0),e.madeProgress(),Ui}};u([d({constructOnly:!0})],Tn.prototype,"context",void 0),u([d({constructOnly:!0})],Tn.prototype,"view",void 0),u([d({constructOnly:!0})],Tn.prototype,"requestRender",void 0),u([d()],Tn.prototype,"coverage",void 0),u([d()],Tn.prototype,"density",void 0),u([d()],Tn.prototype,"absorption",void 0),u([d()],Tn.prototype,"cloudSize",void 0),u([d()],Tn.prototype,"detailSize",void 0),u([d()],Tn.prototype,"smoothness",void 0),u([d()],Tn.prototype,"cloudHeight",void 0),u([d()],Tn.prototype,"raymarchingSteps",void 0),u([d()],Tn.prototype,"running",void 0),Tn=u([C("esri.views.3d.environment.CloudsRenderer")],Tn);var iX=[ta(1,0,0),ta(-1,0,0),ta(0,1,0),ta(0,-1,0),ta(0,0,1)],rX=[ta(0,1,0),ta(0,1,0),ta(0,0,-1),ta(0,0,1),ta(0,1,0)],nX=B2(),Ca=xL();var MT=class extends Jc{constructor(){super(...arguments),this.time=0,this.radius=1,this.width=500,this.opacity=0}},Cy=class extends ft{constructor(t,i){super(t,i,new mt(Y3,()=>import("./chunk-S25APQSR.js")),new Map([[yi.POSITION,0],[yi.INSTANCEFEATUREATTRIBUTE,1]]))}initializePipeline(){return Tt({blending:$p,depthTest:{func:Ei.LEQUAL},colorWrite:St})}};var Fh=class extends ss{constructor(e){super(e),this.consumes={required:[Oe.TRANSPARENT_ENVIRONMENT]},this.produces=Oe.TRANSPARENT_ENVIRONMENT,this._rainSpeed=.1,this._snowSpeed=.01,this._numParticles=0,this._passParameters=new MT,this._configuration=new Q3;let{view:t,type:i}=e;this._configuration.type=i==="rainy"?OM.Rain:OM.Snow,t._stage.renderView.techniques.precompile(Cy,this._configuration),this._passParameters.time=0,this._passParameters.radius=_t(t.spatialReference).radius,this.addHandles(S(()=>t.environment.weather,r=>{r.type===i&&this.addHandles(S(()=>r.precipitation,n=>this._adjustParticles(n),Ce))},Ce)),this.addHandles(S(()=>t._stage?.renderer.renderContext.bind.clouds.fadeFactor??1,r=>{this._passParameters.opacity=r,r===1&&(this.removeHandles("opacity"),this.addHandles(S(()=>t._stage?.renderer.renderContext.bind.clouds.opacity??1,n=>this._passParameters.opacity=n,Ce),"opacity"))},Fe),"opacity")}_adjustParticles(e){let i=e<.5?Xe(0,.35,2*e):Xe(.35,1,2*(e-.5));this._numParticles=V4*i}destroy(){this._numParticles=0,this._vao=We(this._vao),this._instanceIdBuffer=We(this._instanceIdBuffer)}fadeOut(e){this.removeAllHandles(),this.addHandles(S(()=>this.renderContext?.bind.clouds.fadeFactor??1,t=>{this._passParameters.opacity=1-t,t===1&&(this.removeAllHandles(),e())}),"opacity")}updateAnimation(e){let t=(this.type==="rainy"?this._rainSpeed:this._snowSpeed)*r0(e.time)%1e5;return this._passParameters.time!==t&&(this._passParameters.time=t,!0)}render(e){let t=this.renderingContext;this._instanceIdBuffer??=this._createInstanceIndices(t);let i=Math.round(this._numParticles*this._passParameters.opacity),r=e.find(({name:o})=>o===Oe.TRANSPARENT_ENVIRONMENT);if(i<1)return r;let n=this.techniques.get(Cy,this._configuration);if(!n.compiled)return this.requestRender(Pe.UPDATE),r;let s=t.bindTechnique(n,this.bindParameters,this._passParameters);return this._vao??=sX(t,n.locations),t.bindVAO(this._vao),s.assertCompatibleVertexAttributeLocations(this._vao),PF(t,n.locations,this._instanceIdBuffer,H4,0),t.drawArraysInstanced(Jt.TRIANGLES,0,3,i),OF(t,n.locations,this._instanceIdBuffer,H4),r}_createInstanceIndices(e){let t=[];for(let i=0;i<V4;i++)t.push(i);return vr.createVertex(e,tn.STATIC_DRAW,new Float32Array(t))}};function sX(e,t){let i=new Float32Array([-1,0,1,1,0,-1,1,0,1]);return new ns(e,t,new Map([["geometry",is(oX)]]),new Map([["geometry",vr.createVertex(e,tn.STATIC_DRAW,i)]]))}u([d()],Fh.prototype,"consumes",void 0),u([d()],Fh.prototype,"produces",void 0),u([d({constructOnly:!0})],Fh.prototype,"type",void 0),Fh=u([C("esri.views.3d.environment.Precipitation")],Fh);var V4=25e4,oX=Ps().vec3f(yi.POSITION),H4=is(Ps().f32(yi.INSTANCEFEATUREATTRIBUTE),1);var ju=class extends zp{constructor(e){super(e),this.produces=new Map([]),this._clouds=On(null),this._incarnation=0,this._precipitation=null}initialize(){this.view._stage.addRenderPlugin(this)}destroy(){this.removeHandles(),this.uninitializeRenderContext(),this.view?._stage?.removeRenderPlugin(this),this._set("view",null)}get updating(){return!!this._clouds.value?.running}get weatherAvailable(){return xe(this.view.state.camera.eye)-_t(this.view.spatialReference).radius<=Xg}get usedMemory(){return this._clouds.value?.usedMemory??0}_fadeOutPrecipitation(){this._precipitation&&(this._precipitationOutgoing?.destroy(),this._precipitationOutgoing=this._precipitation,this._precipitationOutgoing.fadeOut(()=>{this._precipitationOutgoing=G(this._precipitationOutgoing)}),this._precipitation=null,++this._incarnation)}get weather(){return this.view?.environmentManager?.weatherEnabled?this.view.environment.weather:null}initializeRenderContext(e){this._context=e;let t=this.view,i=()=>this._requestRender();this.addHandles([S(()=>this._precipitation,i,Fe),S(()=>this._clouds.value?.state,i,Fe),S(()=>t.state.mode,i,Fe),S(()=>this._updateClouds(),i,Fe),S(()=>this._updatePrecipitation(),i,Fe),S(()=>this.weather,r=>this._initWeather(r))])}uninitializeRenderContext(){this._context=null,this._clouds.value=G(this._clouds.value),this._precipitation=G(this._precipitation),this._precipitationOutgoing=G(this._precipitationOutgoing)}prepareRender(e){let{bind:t,time:i}=e;if(this.view.viewingMode!=="local"&&t.clouds.data){t.clouds.fade(t.camera,i,this.view.qualitySettings.fadeDuration);let r=this._clouds.value;r&&r.state===Vd.Idle&&r.coverage===0&&!r.running&&r.destroyCubeMap()}}acquireTechniques(){return[]}render(){}_requestRender(){this._context?.requestRender()}_initWeather(e){let t=this._context;if(!e||!t)return void(this._clouds.value=G(this._clouds.value));if(this._clouds.value)return;let i=this.view;this._clouds.value=new Tn({context:t,view:i,requestRender:()=>this._requestRender()})}_updateClouds(){let e=this.view.environment.weather;return e==null||this._clouds.value==null||this._clouds.value.applyPreset(br[e.type],aX(e)),++this._incarnation}_updatePrecipitation(){let e=this.view.environment.weather;if(e.type===this._precipitation?.type)return this._incarnation;this._fadeOutPrecipitation();let t=e.type==="rainy"||e.type==="snowy",i=this._context;return t&&i&&(this._precipitation=new Fh({view:this.view,type:e.type}),++this._incarnation),this._incarnation}get test(){}hasHighlightOptions(e){return!1}};function aX(e){switch(e.type){case"rainy":case"snowy":case"cloudy":case"sunny":return e.cloudCover;case"foggy":return e.fogStrength}}u([d({constructOnly:!0})],ju.prototype,"view",void 0),u([d({type:Boolean,readOnly:!0})],ju.prototype,"updating",null),u([d()],ju.prototype,"weatherAvailable",null),u([d()],ju.prototype,"_context",void 0),ju=u([C("esri.views.3d.environment.EnvironmentRenderer")],ju);var PT=Math.PI,Bi=Math.sin,Fr=Math.cos,ZR=Math.tan,z4=Math.asin,QR=Math.atan2,G4=Math.acos,gr=PT/180,q4=864e5,W4=2440588,$4=2451545,lX={dec:0,ra:0};function cX(e){return e.valueOf()/q4-.5+W4}function ST(e){return new Date((e+.5-W4)*q4)}function IT(e){return cX(e)-$4}var RT=23.4397*gr;function Z4(e,t){return QR(Bi(e)*Fr(RT)-ZR(t)*Bi(RT),Fr(e))}function YR(e,t){return z4(Bi(t)*Fr(RT)+Fr(t)*Bi(RT)*Bi(e))}function Q4(e,t,i){return QR(Bi(e),Fr(e)*Bi(t)-ZR(i)*Fr(t))}function Y4(e,t,i){return z4(Bi(t)*Bi(i)+Fr(t)*Fr(i)*Fr(e))}function K4(e,t){return gr*(280.16+360.9856235*e)-t}function X4(e){return gr*(357.5291+.98560028*e)}function J4(e){return gr*(1.9148*Bi(e)+.02*Bi(2*e)+3e-4*Bi(3*e))}function eG(e,t){return e+t+102.9372*gr+PT}function tG(e,t){var i=X4(e),r=eG(i,J4(i));return t||(t={dec:0,ra:0}),t.dec=YR(r,0),t.ra=Z4(r,0),t}var En={PolarException:{NORMAL:0,MIDNIGHT_SUN:1,POLAR_NIGHT:2},getPosition:function(e,t,i,r){var n=gr*-i,s=gr*t,o=IT(e),a=tG(o,lX),l=K4(o,n)-a.ra;return r||(r={azimuth:0,altitude:0}),r.azimuth=Q4(l,s,a.dec),r.altitude=Y4(l,s,a.dec),r}},AT=[[-.83,"sunrise","sunset"]];En.addTime=function(e,t,i){AT.push([e,t,i])};var iG=9e-4;function uX(e,t){return Math.round(e-iG-t/(2*PT))}function B4(e,t,i){return iG+(e+t)/(2*PT)+i}function U4(e,t,i){return $4+e+.0053*Bi(t)-.0069*Bi(2*i)}function dX(e,t,i){return G4((Bi(e)-Bi(t)*Bi(i))/(Fr(t)*Fr(i)))}function j4(e){var t=gr*(134.963+13.064993*e),i=gr*(93.272+13.22935*e),r=gr*(218.316+13.176396*e)+6.289*gr*Bi(t),n=5.128*gr*Bi(i),s=385001-20905*Fr(t);return{ra:Z4(r,n),dec:YR(r,n),dist:s}}En.getTimes=function(e,t,i){var r=gr*-i,n=gr*t,s=uX(IT(e),r),o=B4(0,r,s),a=X4(o),l=J4(a),c=eG(a,l),h=YR(c,0),p=U4(o,a,c);function m(D){return U4(B4(dX(D,n,h),r,s),a,c)}function f(D){var M=(Bi(D)-Bi(n)*Bi(h))/(Fr(n)*Fr(h));return M<-1?En.PolarException.MIDNIGHT_SUN:M>1?En.PolarException.POLAR_NIGHT:En.PolarException.NORMAL}var g,_,v,b,x,E={solarNoon:ST(p),nadir:ST(p-.5),polarException:En.PolarException.NORMAL};for(g=0,_=AT.length;g<_;g+=1)x=p-((b=m((v=AT[g])[0]*gr))-p),E[v[1]]=ST(x),E[v[2]]=ST(b);return E.polarException=f(AT[0][0]*gr),E},En.getMoonPosition=function(e,t,i){var r=gr*-i,n=gr*t,s=IT(e),o=j4(s),a=K4(s,r)-o.ra,l=Y4(a,n,o.dec);return l+=.017*gr/ZR(l+10.26*gr/(l+5.1*gr)),{azimuth:Q4(a,n,o.dec),altitude:l,distance:o.dist}},En.getMoonFraction=function(e){var t=IT(e),i=tG(t),r=j4(t),n=149598e3,s=G4(Bi(i.dec)*Bi(r.dec)+Fr(i.dec)*Fr(r.dec)*Fr(i.ra-r.ra)),o=QR(n*Bi(s),r.dist-n*Fr(s));return(1+Fr(o))/2};var Dn={local:{altitude:1500,ambientAtNight:.1,ambientAtNoon:.45,ambientAtTwilight:.2,directAtNoon:.65,directAtTwilight:.7},global:{altitude:8e5,ambient:.015,direct:.75},planarDirection:{localAltitude:1e4,globalAltitude:1e6,globalAngles:{azimuth:1.3*Math.PI,altitude:.6*Math.PI}}},Sf=class{constructor(t,i){this.direct=t,this.ambient=i}};function mG(e,t,i,r,n,s){Te(s.ambient.color,1,1,1),s.ambient.intensity=Dn.global.ambient,Te(s.direct.color,1,1,1),s.direct.intensity=Dn.global.direct;let o=t[2],a=q((Math.abs(o)-Dn.local.altitude)/(Dn.global.altitude-Dn.local.altitude),0,1),l;if(s.globalFactor=a,e!=null&&(l=En.getTimes(e,t[1],t[0])),a<1){let c;if(e!=null)c=_X(e,l,r);else{let h=gG(r);c={direct:{intensity:Dn.local.directAtNoon*h.direct,color:yt(1,1,1)},ambient:{intensity:Dn.local.ambientAtNoon*h.ambient,color:yt(1,1,1)},timeOfDay:"early afternoon"}}ni(s.ambient.color,c.ambient.color,s.ambient.color,a),s.ambient.intensity=Xe(c.ambient.intensity,s.ambient.intensity,a),ni(s.direct.color,c.direct.color,s.direct.color,a),s.direct.intensity=Xe(c.direct.intensity,s.direct.intensity,a),s.specularStrength=r==="rainy"||r==="snowy"||r==="foggy"?0:1,s.environmentStrength=r==="rainy"?.7:r==="snowy"||r==="foggy"?.75:1}s.noonFactor=e!=null?gX(e,l):1,e!=null?hX(e,t,i,s.direct.directionToLightSource):cP(n,i,s.direct.directionToLightSource)}function cP(e,t,i){t===Se.Global?ne(eP,e.eye):Te(eP,0,0,1),X(tP,e.viewForward,-1);let r=Vp(tP,eP),n=Math.max(r-2*iP,0),s=.85*n/(n+1),o=Math.max(iP,r-iP-s);uo(pG,-o,e.viewRight),si(i,tP,pG),he(i,i,X(yX,e.viewRight,vX)),ne(i,i)}function hX(e,t,i,r){let n=fX,s=Cd(mX);if(i===Se.Global)En.getPosition(e,0,0,n),Te(r,0,0,-1),Vx(s,s,-n.azimuth),W2(s,s,-n.altitude),si(r,r,s);else{let o=Dn.planarDirection,a=o.globalAngles,l=t[2],c=(Math.abs(l)-o.localAltitude)/(o.globalAltitude-o.localAltitude);c=q(c,0,1),c<1?(En.getPosition(e,t[1],t[0],n),n.azimuth=(1-c)*n.azimuth+c*a.azimuth,n.altitude=(1-c)*n.altitude+c*a.altitude):(n.azimuth=a.azimuth,n.altitude=a.altitude),Te(r,0,-1,0),Fg(s,s,-n.azimuth),Vx(s,s,-n.altitude),si(r,r,s)}}function fG(e,t){if(t===Se.Global)return!0;let i=Dn.planarDirection;return Math.abs(e)<i.localAltitude}var pX=yt(.5773502691896258,-.5773502691896258,.5773502691896258),Ty=class{constructor(){this.ambient={color:yt(1,1,1),intensity:.55},this.direct={color:yt(1,1,1),intensity:.55,directionToLightSource:mn(pX)},this.noonFactor=.5,this.globalFactor=0,this.specularStrength=1,this.environmentStrength=1}},mX=Wt(),fX={azimuth:0,altitude:0};function gX(e,t){let i=e.valueOf(),r,n;t.polarException===En.PolarException.MIDNIGHT_SUN?(r=i-60*(e.getHours()+48)*60*1e3-60*e.getMinutes()*1e3,n=r+432e6):t.polarException===En.PolarException.POLAR_NIGHT?(r=i-2,n=i-1):(r=t.sunrise.valueOf(),n=t.sunset.valueOf());let s=r+(n-r)/2;return 1-q(Math.abs(i-s)/432e5,0,1)}function gG(e){switch(e){case"disabled":case"sunny":case"cloudy":return new Sf(1,1);case"rainy":return new Sf(.4,1.2);case"snowy":return new Sf(.5,1.3);case"foggy":return new Sf(.2,1.6)}}function rG(e,t){let i=(e[0]+e[1]+e[2])/3;e[0]+=(i-e[0])*t,e[1]+=(i-e[1])*t,e[2]+=(i-e[2])*t}var KR=yt(.01,.01,.01),rP=yt(1,.6,.5),nP=yt(1,.98,.98),nG=yt(1,1,1),XR=yt(.8,.8,1),sP=yt(.8,.8,1),oP=yt(.98,.98,1),sG=yt(1,1,1),JR=Hg(.01,Dn.local.ambientAtNight),aP=Hg(Dn.local.directAtTwilight,Dn.local.ambientAtTwilight),lP=Hg(.9*Dn.local.directAtNoon,Dn.local.ambientAtNoon),oG=Hg(Dn.local.directAtNoon,Dn.local.ambientAtNoon),aG=lP,lG=nP,cG=oP,uG=aP,dG=rP,hG=sP;function _X(e,t,i){let r=e.valueOf(),n,s;t.polarException===En.PolarException.MIDNIGHT_SUN?(n=r-60*(e.getHours()+48)*60*1e3-60*e.getMinutes()*1e3,s=n+432e6):t.polarException===En.PolarException.POLAR_NIGHT?(n=r-2,s=r-1):(n=t.sunrise.valueOf(),s=t.sunset.valueOf());let o=s-n,a=n+o/2,l=o/4,c=a-l,h=a+l,p=.06*o,m=n-p/2,f=n+p/2,g=s-p/2,_=s+p/2,v=Hi(),b=w(),x=w(),E="";if(r<m||r>_)Yi(v,JR),ee(b,KR),ee(x,XR),E="night";else if(r<f){let T=(r-m)/(f-m);Dd(v,JR,aP,T),ni(b,KR,rP,T),ni(x,XR,sP,T),E="sun rising"}else if(r<c){let T=(r-f)/(c-f);Dd(v,aP,lP,T),ni(b,rP,nP,T),ni(x,sP,oP,T),E="early morning"}else if(r<a){let T=(r-c)/(a-c);Dd(v,lP,oG,T),ni(b,nP,nG,T),ni(x,oP,sG,T),E="late morning"}else if(r<h){let T=(r-a)/(h-a);Dd(v,oG,aG,T),ni(b,nG,lG,T),ni(x,sG,cG,T),E="early afternoon"}else if(r<g){let T=(r-h)/(g-h);Dd(v,aG,uG,T),ni(b,lG,dG,T),ni(x,cG,hG,T),E="late afternoon"}else if(r<_){let T=(r-g)/(_-g);Dd(v,uG,JR,T),ni(b,dG,KR,T),ni(x,hG,XR,T),E="sun setting"}let D=0;switch(i){case"rainy":case"foggy":D=.8;break;case"snowy":D=.5}D>0&&(rG(b,D),rG(x,D));let M=gG(i);return{direct:{intensity:v[0]*M.direct,color:b},ambient:{intensity:v[1]*M.ambient,color:x},timeOfDay:E}}var pG=Wt(),eP=w(),tP=w(),yX=w(),iP=.25,vX=.2;var Gs=class extends oi.EventedAccessor{constructor(){super(),this._tmpLightParameters=new Ty,this._defaultLightParameters=new Ty,this._tmpDate=new Date,this._tmpTz={hours:0,minutes:0,seconds:0},this._viewHandlesKey="viewHandles",this._trackingEnabled=!1,this._mainLight=new QF,this._ambientLight=new $F,this._moonLight=new ZF,this._disableProjectionEngineAutoLoad=!1,this._disableWeather=!1,this._renderer=null,this._referencePositionGeographic=null,this._resetReferencePosition()}destroy(){this.disconnectView()}get _view(){return this._renderer?.view}get updating(){return!!this._renderer?.updating||!this._canProjectCameraPosition}get weatherEnabled(){return this._view?.environment.atmosphereEnabled&&!this._disableWeather&&this._view?.state?.viewingMode===Se.Global&&y2(this._view.spatialReference)}get _weatherAvailable(){return this.weatherEnabled&&this._renderer?.weatherAvailable}get referencePositionGeographic(){return this._referencePositionGeographic}get _canProjectCameraPosition(){let e=this._view?.stateManager?.camera?.position?.spatialReference??Qt.WGS84,t=WR(e);return this._disableProjectionEngineAutoLoad||Va(e,t)}connectView(e){if(this._renderer)return;this._renderer=new ju({view:e});let t=()=>this._updateRenderParameters(),i=()=>this._cameraHandler();this.addHandles([S(()=>e.environment.lighting,r=>this._updateLightingHandler(r),Fe),S(()=>e.environment.lighting.type!=="virtual"?e.environment.lighting.date:null,r=>this._lightingDateHandler(r),Fe),S(()=>e.environment.lighting.directShadowsEnabled,t,Fe),S(()=>e.qualitySettings.ambientOcclusion,t,Fe),S(()=>e.qualitySettings.reflections,t,Fe),S(()=>e.spatialReference,()=>this._resetReferencePosition(!0),Fe),S(()=>[e.environment.weather.type,this.weatherEnabled],()=>this._updateLighting(null,yw.FadeWithWeather),Fe),S(()=>e.environment,r=>r.setComputeWeatherAvailable(()=>this._weatherAvailable),Ce),S(()=>e.viewingMode,()=>this._resetReferencePosition(!0),Ce),S(()=>e.environment.lighting.type!=="virtual"&&e.environment.lighting.cameraTrackingEnabled,r=>this._updateCameraTracking(r),Ce),S(()=>e.state.camera,i,Ce),Wi(()=>this._canProjectCameraPosition,i,Fe)],this._viewHandlesKey),this._updateRenderParameters(),this._updateLighting(),this._cameraHandler(),this.notifyChange("updating")}disconnectView(){this.removeHandles(this._viewHandlesKey),this._resetReferencePosition(),this._renderer=G(this._renderer)}_updateLightingHandler(e){this._updateCameraTracking(e.type!=="virtual"&&e.cameraTrackingEnabled),this._lightingDateHandler(e.type!=="virtual"?e.date:null),this._updateRenderParameters()}_updateCameraTracking(e){if(this._trackingEnabled=e,e)this._cameraHandler();else{let t=this._view.environment.lighting;t?.type!=="virtual"&&(t.positionTimezoneInfo.autoUpdated=!1)}}_lightingDateHandler(e){let t=this._view.environment.lighting;if(t?.type!=="virtual"){if(e){if(!t.positionTimezoneInfo.autoUpdated&&(this._preupdateTracking(e),this._referencePositionGeographic!=null)){let i=fM(this._referencePositionGeographic,this._tmpTz);i!=null&&(t.autoUpdate(null,i),this._trackingEnabled&&(t.positionTimezoneInfo.autoUpdated=!0))}this._updateLighting(e)}}else this._updateLighting()}_preupdateTracking(e){!this._trackingEnabled&&this._view.environment.lighting.type!=="virtual"&&this._view.environment.lighting.cameraTrackingEnabled&&this._cameraHandler(e)}_cameraHandler(e=null){let t=this._view;if(!t.ready)return;let i=t.stateManager.camera;if(!i)return;let{position:r}=i,n=r.spatialReference??Qt.WGS84,s=WR(n),o=this._referencePositionGeographic??w();if(!$c(r,o,s))return this._referencePositionGeographic=null,void this._updateLighting();this._referencePositionGeographic=o,this.notifyChange("referencePositionGeographic"),this._autoUpdateTimezone(o,e)||this._updateLighting(e)}_updateLighting(e,t=yw.Immediate){let i=this._view,{lighting:r}=i.environment,n=r.type==="virtual",s=this._referencePositionGeographic,o=s!=null?this._tmpLightParameters:this._defaultLightParameters;if(s){e??=n?null:r.date;let m=this._weatherAvailable?i.environment.weather.type:"disabled";mG(e,s,i.state.viewingMode,m,i.state.camera,o)}else n&&cP(i.state.camera,i.state.viewingMode,o.direct.directionToLightSource);let a=this._mainLight,l=o.direct;X(a.intensity,l.color,l.intensity*Math.PI),ee(a.direction,l.directionToLightSource),a.specularStrength=o.specularStrength,a.environmentStrength=o.environmentStrength;let c=this._ambientLight;X(c.intensity,o.ambient.color,o.ambient.intensity);let h=this._moonLight;ni(h.intensity,wX,bX,o.globalFactor);let p=(1-.5*o.globalFactor)*(1-.4*o.noonFactor*(1-o.globalFactor));X(h.intensity,h.intensity,p),ee(h.direction,l.directionToLightSource),this._view._stage.renderer.updateLighting([a,c,h],o.noonFactor,o.globalFactor,this._weatherAvailable?t:yw.Immediate),this._updateRenderParameters()}_autoUpdateTimezone(e,t=null){if(this._view.environment.lighting.type==="virtual"||!this._view.environment.lighting.cameraTrackingEnabled||e==null)return!1;let i=this._tmpDate;i.setTime((t||this._view.environment.lighting.date).getTime());let r=fM(e,this._tmpTz);if(r==null)return!1;let n=this._view.environment.lighting.positionTimezoneInfo;if(n.autoUpdated){if(n.hours===r.hours&&n.minutes===r.minutes&&n.seconds===r.seconds)return!1}else n=r;let s=i.getUTCHours()-(r.hours-n.hours),o=i.getUTCMinutes()-(r.minutes-n.minutes),a=i.getUTCSeconds()-(r.seconds-n.seconds);return i.setUTCHours(s),i.setUTCMinutes(o),i.setUTCSeconds(a),!t&&this._view.environment.lighting.autoUpdate(i,r)}_updateRenderParameters(){let e=this._view._stage;if(!e)return;let t=this._referencePositionGeographic==null||fG(this._referencePositionGeographic[2],this._view.state.viewingMode);e.renderer.setParameters({shadowMap:this._view.environment.lighting.directShadowsEnabled&&t,environment:this._view.environment,weatherVisible:this._weatherAvailable,qualitySettings:this._view.qualitySettings})}_resetReferencePosition(e=!1){this._referencePositionGeographic=null,e&&this._cameraHandler()}get test(){}};u([d({type:Boolean,readOnly:!0})],Gs.prototype,"updating",null),u([d()],Gs.prototype,"_disableProjectionEngineAutoLoad",void 0),u([d()],Gs.prototype,"_disableWeather",void 0),u([d()],Gs.prototype,"weatherEnabled",null),u([d()],Gs.prototype,"_weatherAvailable",null),u([d()],Gs.prototype,"referencePositionGeographic",null),u([d()],Gs.prototype,"_renderer",void 0),u([d()],Gs.prototype,"_referencePositionGeographic",void 0),u([d()],Gs.prototype,"_canProjectCameraPosition",null),Gs=u([C("esri.views.3d.environment.EnvironmentManager")],Gs);var wX=yt(.22,.22,.33),bX=yt(.22,.22,.22);var uP,Po=uP=class extends dn{constructor(e){super(e),this.type="sun",this.date=null,this.directShadowsEnabled=!1,this.displayUTCOffset=null}readDate(e,t){return t.datetime!=null&&new Date(t.datetime)||null}writeDate(e,t,i){t[i]=e.getTime()}readDirectShadowsEnabled(e,t){return!!t.directShadows}writedirectShadowsEnabled(e,t,i){e&&(t[i]=e)}writeDisplayUTCOffset(e,t){e!=null&&(t.displayUTCOffset=e)}clone(){return new uP(this.cloneConstructProperties())}cloneConstructProperties(){let e={directShadowsEnabled:this.directShadowsEnabled,displayUTCOffset:this.displayUTCOffset!=null?this.displayUTCOffset:null};return this.date!=null&&(e.date=new Date(this.date.getTime())),e}};u([d({readOnly:!0,type:["sun"],json:{write:!0}})],Po.prototype,"type",void 0),u([d({type:Date,json:{type:Number,write:{target:"datetime"}}})],Po.prototype,"date",void 0),u([Ax("date",["datetime"])],Po.prototype,"readDate",null),u([Tp("date")],Po.prototype,"writeDate",null),u([d({type:Boolean,json:{default:!1,write:{target:"directShadows"}}})],Po.prototype,"directShadowsEnabled",void 0),u([Ax("directShadowsEnabled",["directShadows"])],Po.prototype,"readDirectShadowsEnabled",null),u([Tp("directShadowsEnabled")],Po.prototype,"writedirectShadowsEnabled",null),u([d({type:Number,json:{write:!0}})],Po.prototype,"displayUTCOffset",void 0),u([Tp("displayUTCOffset")],Po.prototype,"writeDisplayUTCOffset",null),Po=uP=u([C("esri.webscene.SunLighting")],Po);var bc=Po;var If,zu=If=class extends oi.EventedMixin(bc){constructor(e){super(e),this.cameraTrackingEnabled=!0,this.positionTimezoneInfo={hours:0,minutes:0,seconds:0,autoUpdated:!0};let t=new Date().getFullYear(),i=new Date("March 15, "+t+" 12:00:00 UTC");this._set("defaultDate",i),this._set("date",i)}get defaultDate(){return new Date(this._get("defaultDate").getTime())}static fromWebsceneLighting(e){return new If(e.cloneConstructProperties())}set defaultDate(e){let t=this._get("date")===this._get("defaultDate");e=new Date(e.getTime()),this._set("defaultDate",e),t&&this._set("date",e)}set date(e){e!=null&&(this.positionTimezoneInfo.autoUpdated=!1,this._set("date",new Date(e.getTime())))}autoUpdate(e,t){let i=If.calculateTimezoneOffset(this.positionTimezoneInfo);this.positionTimezoneInfo.hours=t.hours,this.positionTimezoneInfo.minutes=t.minutes,this.positionTimezoneInfo.seconds=t.seconds;let r=null;e!=null&&(this.positionTimezoneInfo.autoUpdated=!0,isNaN(e.getTime())?(r=this.defaultDate.getTime(),this._set("date",this.defaultDate)):(r=this.date&&this.date.getTime(),this._set("date",new Date(e.getTime()))));let n=If.calculateTimezoneOffset(this.positionTimezoneInfo);if(i!==n&&(OT.target=this,OT.timezoneOffset=n,this.emit("timezone-will-change",OT),OT.target=null),e!=null)return isNaN(e.getTime())||r!==e.getTime()}clone(){let e=this._get("date")===this._get("defaultDate"),t=new If(be(ie({},this.cloneConstructProperties()),{defaultDate:this.defaultDate,cameraTrackingEnabled:this.cameraTrackingEnabled}));return e&&t._set("date",t._get("defaultDate")),t.positionTimezoneInfo.autoUpdated=this.positionTimezoneInfo.autoUpdated,t.positionTimezoneInfo.hours=this.positionTimezoneInfo.hours,t.positionTimezoneInfo.minutes=this.positionTimezoneInfo.minutes,t.positionTimezoneInfo.seconds=this.positionTimezoneInfo.seconds,t}cloneWithWebsceneLighting(e){let t=this.clone();return e.date!=null&&(t.date=e.date),t.directShadowsEnabled=e.directShadowsEnabled,t.displayUTCOffset=e.displayUTCOffset,t}cloneNonPersistentConstructProperties(){return{cameraTrackingEnabled:this.cameraTrackingEnabled}}};u([d({type:Boolean})],zu.prototype,"cameraTrackingEnabled",void 0),u([d({type:Date})],zu.prototype,"defaultDate",null),u([d({type:Date})],zu.prototype,"date",null),zu=If=u([C("esri.views.3d.environment.SunLighting")],zu),function(e){function t({hours:i,minutes:r,seconds:n}){return Math.round(i+r/60+n/3600)}e.calculateTimezoneOffset=t}(zu||(zu={}));var OT={target:null,timezoneOffset:0},Cc=zu;var dP,Ey=dP=class extends dn{constructor(e){super(e),this.type="virtual",this.directShadowsEnabled=!1}clone(){return new dP(this.cloneConstructProperties())}cloneConstructProperties(){return{directShadowsEnabled:this.directShadowsEnabled}}};u([d({readOnly:!0,type:["virtual"],json:{write:{isRequired:!0}}})],Ey.prototype,"type",void 0),u([d({type:Boolean,json:{default:!1,name:"directShadows",write:!0}})],Ey.prototype,"directShadowsEnabled",void 0),Ey=dP=u([C("esri.webscene.VirtualLighting")],Ey);var Gu=Ey;var NT,LT=NT=class extends oi.EventedMixin(Gu){constructor(e){super(e),this.cameraTrackingEnabled=!0}clone(){return new NT(be(ie({},this.cloneConstructProperties()),{cameraTrackingEnabled:this.cameraTrackingEnabled}))}static fromWebsceneLighting(e){return new NT(e.cloneConstructProperties())}cloneWithWebsceneLighting(e){let t=this.clone();return t.directShadowsEnabled=e.directShadowsEnabled,t}cloneNonPersistentConstructProperties(){return{cameraTrackingEnabled:this.cameraTrackingEnabled}}};u([d({type:Boolean})],LT.prototype,"cameraTrackingEnabled",void 0),LT=NT=u([C("esri.views.3d.environment.VirtualLighting")],LT);var kh=LT;var _G={key:"type",defaultKeyValue:"sun",base:null,typeMap:{sun:Cc,virtual:kh}};var yG={key:"type",defaultKeyValue:"sun",base:null,typeMap:{sun:bc,virtual:Gu}};var FT=class extends dn{constructor(e){super(e)}clone(){throw new Error("Subclasses of Background should implement their own clone method.")}};u([d({readOnly:!0,json:{read:!1}})],FT.prototype,"type",void 0),FT=u([C("esri.webscene.background.Background")],FT);var kT=FT;var hP,Dy=hP=class extends kT{constructor(e){super(e),this.type="color",this.color=new _n([0,0,0,1])}clone(){return new hP(this.cloneProperties())}cloneProperties(){return{color:this.color.clone()}}};u([y0({color:"color"},{readOnly:!0})],Dy.prototype,"type",void 0),u([d(KL({nonNullable:!0}))],Dy.prototype,"color",void 0),Dy=hP=u([C("esri.webscene.background.ColorBackground")],Dy);var VT=Dy;var vG={base:kT,key:"type",typeMap:{color:VT}};function CX(e){return(t,i,r)=>{if(!t)return t;for(let n in e.typeMap)if(t.type===n){let s=new e.typeMap[n];return s.read(t,r),s}}}var wG={types:vG,json:{read:CX(vG),write:{overridePolicy:(e,t,i)=>({enabled:!i?.isPresentation})}}};var pP,bG=(e,t,i)=>({enabled:!i?.isPresentation}),qu=pP=class extends dn{constructor(e){super(e),this.lighting=new bc,this.background=null,this.atmosphereEnabled=!0,this.starsEnabled=!0}set weather(e){vV(e?.type,W.getLogger(this))&&this._set("weather",e)}clone(){return new pP(this.cloneConstructProperties())}cloneConstructProperties(){return{lighting:this.lighting&&this.lighting.type==="virtual"?Gu.prototype.clone.call(this.lighting):bc.prototype.clone.call(this.lighting),background:ro(this.background),atmosphereEnabled:this.atmosphereEnabled,starsEnabled:this.starsEnabled,weather:this.weather.clone()}}};u([d({types:yG,nonNullable:!0,json:{write:!0}})],qu.prototype,"lighting",void 0),u([d(wG)],qu.prototype,"background",void 0),u([d({type:Boolean,nonNullable:!0,json:{write:{overridePolicy:bG}}})],qu.prototype,"atmosphereEnabled",void 0),u([d({type:Boolean,nonNullable:!0,json:{write:{overridePolicy:bG}}})],qu.prototype,"starsEnabled",void 0),u([d({types:yV,nonNullable:!0,json:{write:!0},value:new _V})],qu.prototype,"weather",null),qu=pP=u([C("esri.webscene.Environment")],qu);var HT=qu;var xy,Vh=xy=class extends HT{constructor(e){super(e),this.lighting=this.castLighting(),this._computeWeatherAvailable=void 0,this.cachedCameraTrackingEnabled=null}static fromWebsceneEnvironment(e){let t=e.cloneConstructProperties();return new xy(be(ie({},t),{lighting:t.lighting?t.lighting.type==="virtual"?kh.fromWebsceneLighting(t.lighting):Cc.fromWebsceneLighting(t.lighting):void 0}))}get weatherAvailable(){return this._computeWeatherAvailable?.()??!1}setComputeWeatherAvailable(e){this._computeWeatherAvailable=e}castLighting(e){return this._convertLightingWithDestroy(e)}applyLighting(e){this.lighting=this._convertLightingWithDestroy(e)}_convertLightingWithDestroy(e){let t=this._convertLighting(e);return t!==e&&this.addHandles(QN(t)),t}_convertLighting(e){return e?e instanceof Cc||e instanceof kh?e:e instanceof bc?this.lighting&&this.lighting.type!=="virtual"?this.lighting.cloneWithWebsceneLighting(e):new Cc(ie(ie({},e.cloneConstructProperties()),this.lighting?.cloneNonPersistentConstructProperties())):e instanceof Gu?this.lighting&&this.lighting.type==="virtual"?this.lighting.cloneWithWebsceneLighting(e):new kh(ie(ie({},e.cloneConstructProperties()),this.lighting?.cloneNonPersistentConstructProperties())):s2(_G,e):new Cc}clone(){return new xy({lighting:this.lighting.clone(),weather:this.weather.clone(),atmosphereEnabled:this.atmosphereEnabled,starsEnabled:this.starsEnabled,background:ro(this.background)})}cloneWithWebsceneEnvironment(e){return new xy(be(ie({weather:this.weather.clone(),atmosphereEnabled:this.atmosphereEnabled,starsEnabled:this.starsEnabled,background:ro(this.background)},e.cloneConstructProperties()),{lighting:this._getLighting(e)}))}_getLighting(e){switch(e.lighting.type){case"sun":return this.lighting&&this.lighting.type==="sun"?this.lighting.cloneWithWebsceneLighting(e.lighting):Cc.fromWebsceneLighting(e.lighting);case"virtual":return this.lighting&&this.lighting.type==="virtual"?this.lighting.cloneWithWebsceneLighting(e.lighting):kh.fromWebsceneLighting(e.lighting);default:return e.lighting,Cc.fromWebsceneLighting(e.lighting)}}};u([d({nonNullable:!0})],Vh.prototype,"lighting",void 0),u([d()],Vh.prototype,"_computeWeatherAvailable",void 0),u([d({readOnly:!0})],Vh.prototype,"weatherAvailable",null),u([Sr("lighting")],Vh.prototype,"castLighting",null),Vh=xy=u([C("esri.views.3d.environment.SceneViewEnvironment")],Vh);var Hh=Vh;var ut;(function(e){e[e.NONE=0]="NONE",e[e.TILT=1]="TILT",e[e.ALTITUDE=2]="ALTITUDE",e[e.DISTANCE=4]="DISTANCE",e[e.COLLISION=8]="COLLISION",e[e.ALL=15]="ALL",e[e.ALL_EXCEPT_COLLISION=7]="ALL_EXCEPT_COLLISION"})(ut||(ut={}));var Ne;(function(e){e[e.NONE=0]="NONE",e[e.ZOOM=1]="ZOOM",e[e.TUMBLE=2]="TUMBLE",e[e.LOOK_AROUND=3]="LOOK_AROUND",e[e.PAN=4]="PAN",e[e.ASCEND=5]="ASCEND"})(Ne||(Ne={}));var ws;(function(e){e[e.TUMBLE=0]="TUMBLE",e[e.LOOK_AROUND=1]="LOOK_AROUND"})(ws||(ws={}));var xi=class{constructor(t=ut.ALL,i=Ne.NONE,r=0,n=null,s=null,o=ws.TUMBLE){this.selection=t,this.interactionType=i,this.interactionFactor=r,this.interactionStartCamera=n,this.interactionDirection=s,this.tiltMode=o}};function Wu(e,t){return!!(e&t)}function Bh(e,t,i,r,n,s){e!==0&&(i?(s.min=Math.min(s.min,t),s.max=Math.max(s.max,t)):r!=null?(s.min-=Math.max(0,(t-s.min)*(1-r)),s.max+=Math.max(0,(t-s.max)*(1-r))):n&&(s.min-=Math.max(0,t-s.min-n),s.max+=Math.max(0,t-s.max-n)))}var hl=new xi(ut.NONE);function BT(e,t,i,r){return t=t||e.viewForward,ee(r,t),X(r,r,Math.sign(ae(t,i))),r}function CG(e,t,i=hl){let r=UT(e,t,i);if(r===0)return!1;let n=e.renderCoordsHelper,s=n.getAltitude(t.eye)+r,o=BT(t,i.interactionDirection,DX(e,t,Math.sign(r),IX),SX),a=ee(AX,t.viewForward),l=n.intersectInfiniteManifold(ia(t.eye,o),s,mP);return t.eye=l??n.setAltitude(mP,s,t.eye),t.center=FV(mP,t.eye,a,t.center),!0}function UT(e,t,i=hl){if(!TX(e,i)||!e.state.constraints.altitude)return 0;let r=xX(e.state.constraints.altitude,MX);EX(e,i,r);let n=e.renderCoordsHelper.getAltitude(t.eye),s=q(n,r.min,r.max)-n;return Math.abs(s)<=1e-6?0:s}function TX(e,t){let i=e.state.constraints.altitude;return!(!e.state.isGlobal||!i)&&(t.interactionType!==Ne.TUMBLE||!Wu(t.selection,ut.TILT))}function EX(e,t,i){let r=t.interactionType;if(r===Ne.NONE)return;let{min:n,max:s}=i,{interactionStartCamera:o,interactionFactor:a}=t;if(!o)return;let l=r===Ne.TUMBLE||r===Ne.ZOOM,c=UT(e,o),h=c===0?0:e.renderCoordsHelper.getAltitude(o.eye);i.min=n,i.max=s,Bh(c,h,l,a,.05*h,i)}function DX(e,t,i,r){return e.renderCoordsHelper.worldUpAtPosition(t.eye,r),X(r,r,i),r}function xX(e,t){return t.min=e.min,t.max=e.max,t}var MX={min:0,max:0},SX=w(),IX=w(),AX=w(),mP=w();function GT(e,t,i=hl){if(!e.state.isLocal)return 0;let r=e.state.constraints.distance;if(!e.pointsOfInterest.surfaceOrigin.renderLocation||r===1/0)return 0;jT.min=0,jT.max=r,RX(e,i,jT);let n=fP(e,t),s=jT.max-n;return s>=-1e-6?0:s}function TG(e,t,i=hl){let r=GT(e,t,i);if(r===0)return!1;let n=e.pointsOfInterest.surfaceOrigin;if(!n.renderLocation)return!1;let s=fP(e,t)+r,o=ee(OX,t.eye),a=BT(t,i.interactionDirection,PX(t,n.renderLocation,FX),LX);if(!Zc(gF(n.renderLocation,s),ia(t.eye,a),zT))return!1;t.eye=zT;let l=ve(NX,t.eye,o);t.center=he(zT,t.center,l);let c=e.renderCoordsHelper.getAltitude(t.center),h=e.renderCoordsHelper.intersectInfiniteManifold(t.ray,c,zT);return h!=null&&(t.center=h),!0}function RX(e,t,i){let r=t.interactionType;if(r===Ne.NONE)return;let{min:n,max:s}=i,{interactionStartCamera:o,interactionFactor:a}=t;if(!o)return;let l=r===Ne.ZOOM||r===Ne.PAN,c=GT(e,o),h=c===0?0:fP(e,o);i.min=n,i.max=s,Bh(c,h,l,a,.05*h,i)}function fP(e,t){let i=e.pointsOfInterest.surfaceOrigin;return i.renderLocation?ui(t.eye,i.renderLocation):0}function PX(e,t,i){return Pp(i,e.eye,t)}var jT={min:0,max:0},OX=w(),NX=w(),LX=w(),FX=w(),zT=w();function Oo(e,t,i=xn.EYE){let r=e.state.constraints;if(!r.collision.enabled)return!1;let n=im(e,t.eye),s=e.renderCoordsHelper.getAltitude(t.eye),o=n+r.collision.elevationMargin;if(s>=o)return!1;let a=xe(t.eye);if(ve(qT,t.center,t.eye),t.eye=e.renderCoordsHelper.setAltitude(kX,o,t.eye),i===xn.EYE_AND_CENTER)t.center=he(qT,t.eye,qT);else if(i===xn.EYE_AND_CENTER_SCALE){let l=(a-s+o)/a;t.center=X(qT,t.center,l)}return!0}var xn;(function(e){e[e.EYE=0]="EYE",e[e.EYE_AND_CENTER=1]="EYE_AND_CENTER",e[e.EYE_AND_CENTER_SCALE=2]="EYE_AND_CENTER_SCALE"})(xn||(xn={}));var qT=w(),kX=w();function _P(e,t,i,r=!0){My.eyeCenterDistance=0,My.requiresTwoSteps=!1;let n=ZT(e,t,i,hl,My);if(n===0)return!1;switch(uo(WT,-n,t.viewRight),i.tiltMode){case ws.LOOK_AROUND:si($u,t.viewForward,WT),X($u,$u,My.eyeCenterDistance),t.center=he(Zu,t.eye,$u);break;case ws.TUMBLE:ve($u,t.center,t.eye),si($u,$u,WT),t.eye=ve(Zu,t.center,$u);break;default:i.tiltMode}return t.up=si(Zu,t.up,WT),!My.requiresTwoSteps||!r||_P(e,t,i,!1)}function ZT(e,t,i,r=hl,n){if(!e.state.constraints.tilt)return 0;let s=Math.min(t.relativeElevation*$T,t.distance),o=e.state.constraints.tilt(s,$X);return WX(e,i,o),r.interactionType===Ne.TUMBLE&&Wu(r.selection,ut.ALTITUDE)&&DG(e,r.interactionStartCamera,o),i.tiltMode===ws.LOOK_AROUND||r.tiltMode===ws.LOOK_AROUND?HX(e,t,o,n):VX(e,t,o)}function VX(e,t,i){let r=la(e.renderCoordsHelper,t.center,t.eye),n=r-q(r,i.min,i.max);return Sy(n)?n:0}function HX(e,t,i,r){switch(r&&(r.requiresTwoSteps=!1),e.viewingMode){case"global":return UX(e,t,i,r);case"local":return BX(e,t,i,r)}}function BX(e,t,i,r){let n=la(e.renderCoordsHelper,t.center,t.eye),s=q(n,i.min,i.max),o=n-s;if(!Sy(o))return 0;if(r){let a=Math.abs(e.pointsOfInterest.centerOnSurfaceFrequent.estimatedSurfaceAltitude),l=e.renderCoordsHelper.getAltitude(t.eye)-a,c=Math.max(Math.cos(s),1e-4);Math.abs(c)>1e-4?r.eyeCenterDistance=l/c:r.eyeCenterDistance=t.distance}return o}function UX(e,t,i,r){let n=jX(e,t,ZX),s=q(n.tiltAtCenter,i.min,i.max);if(!Sy(n.tiltAtCenter-s))return 0;let o,a;return n.centerIsOnSurface?(o=zX(n),a=GX(n,o)):(o=n.constraints.clampTilt(n.distance,n.tiltAtCenter),r&&o<Math.PI/2&&(r.requiresTwoSteps=!0,o=Math.PI/2-1e-5),a=qX(n,o)),r&&(r.eyeCenterDistance=gP(n,o)),a}function jX(e,t,i){let r=e.pointsOfInterest.centerOnSurfaceFrequent.estimatedSurfaceAltitude,n=r+_t(e.spatialReference).radius,s=e.renderCoordsHelper.intersectManifold(t.ray,r,Zu);return i.distance=Math.min(t.relativeElevation*$T,t.distance),i.centerIsOnSurface=!1,s!=null?(i.distance=Math.min(t.relativeElevation*$T,ui(t.eye,s)),i.tiltAtCenter=la(e.renderCoordsHelper,s,t.eye),i.centerIsOnSurface=!0):e.state.isLocal?i.tiltAtCenter=la(e.renderCoordsHelper,t.center,t.eye):(Qc(Bp(Up,n),t.ray,Zu),i.distance=Math.min(t.relativeElevation*$T,ui(t.eye,Zu)),i.tiltAtCenter=oo(-ae(t.viewForward,ne(Zu,Zu)))),i.radius=n,i.eyeRadius=xe(t.eye),i.constraints=e.state.constraints,i}function Sy(e){return Math.abs(e)>1e-9}function zX(e){let{constraints:t,distance:i,tiltAtCenter:r}=e,n=r,s=t.clampTilt(i,r),o=gP(e,s);if(t.clampTilt(o,r)===s)return s;let a=0;for(;a<10&&Sy(s-n);){let l=(n+s)/2,c=gP(e,l);Sy(t.clampTilt(c,l)-l)?n=l:s=l,a++}return s}function gP(e,t){if(!e.centerIsOnSurface)return e.distance;let i=Math.PI-q(t,0,Math.PI),r=xp(e.radius/e.eyeRadius*Math.sin(i)),n=Math.PI-i-r,s=Math.sin(n)/Math.sin(i);if(e.eyeRadius<e.radius&&s>1){let o=Math.PI-r,a=Math.PI-i-o;return Math.sin(a)/Math.sin(i)*e.eyeRadius}return s*e.eyeRadius}function GX(e,t){let i=xp(e.radius/e.eyeRadius*Math.sin(e.tiltAtCenter)),r=xp(e.radius/e.eyeRadius*Math.sin(t));return e.eyeRadius>e.radius?i-r:r-i}function qX(e,t){return e.tiltAtCenter-Math.PI/2-(t-Math.PI/2)}function WX(e,t,i){if(t.interactionType===Ne.NONE)return;let{interactionStartCamera:r,interactionFactor:n}=t;if(!r)return;let{min:s,max:o}=i,a=ZT(e,r,hl,t),l=a===0?0:la(e.renderCoordsHelper,r.center,r.eye);i.min=s,i.max=o,t.interactionType===Ne.TUMBLE?(Wu(t.selection,ut.ALTITUDE)&&DG(e,r,i),Bh(a,l,!0,n,EG,i)):Bh(a,l,!1,n,EG,i)}function DG(e,t,i){let r=e.state.constraints;if(e.state.isLocal||!r.altitude||!t)return;let n=Ir(t.center),s=Math.sqrt(n),o=t.distance,a=_t(e.spatialReference).radius,l=r.altitude.min+a,c=r.altitude.max+a,h=(l*l-o*o-n)/(-2*s*o),p=(c*c-o*o-n)/(-2*s*o);i.min=Math.max(i.min,Math.min(Math.PI-oo(p),i.max)),i.max=Math.min(i.max,Math.PI-oo(h))}var $u=w(),WT=Wt(),Zu=w(),EG=kt(5),$T=30,$X={min:0,max:0},ZX={constraints:null,radius:0,eyeRadius:0,centerIsOnSurface:!0,distance:0,tiltAtCenter:0},My={eyeCenterDistance:0,requiresTwoSteps:!1};function Pt(e,t,i=XX,r=t){r!==t&&r.copyFrom(t),r.computeUp(e.state.viewingMode);let n=!1;for(let a=0;a<JX;a++){let l=0;for(let c of KX)if(Wu(i.selection,c.type)){let h=Math.abs(c.error(e,r,i));c.apply(e,r,i)&&(n=!0,l+=h)}if(l===0)break}let s=Wu(i.selection,ut.COLLISION),o=QX(i.interactionType,e);return s&&Oo(e,r,o)&&(n=!0),n&&r.computeUp(e.state.viewingMode),n}function QX(e,t){switch(e){case Ne.PAN:return xn.EYE_AND_CENTER;case Ne.ASCEND:return t.state.isGlobal?xn.EYE_AND_CENTER_SCALE:xn.EYE_AND_CENTER;default:return xn.EYE}}function ln(e){let t=Math.min(1,e/150);return vR(t)}function YX(e,t,i){return ZT(e,t,i)*t.distance}var KX=[{type:ut.TILT,error:YX,apply:_P},{type:ut.ALTITUDE,error:UT,apply:CG},{type:ut.DISTANCE,error:GT,apply:TG}],XX=new xi,JX=5;var Iy=class{get pitch(){return this._pitch}get yaw(){return this._yaw}get distance(){return this._distance}get fov(){return this._fov}get size(){return this._size}constructor(t){this.viewingMode=t,this.center=w(),this._pitch=0,this._yaw=0,this._distance=0,this.direction=mn(xG),this._fov=55,this._size=1}pixelsPerPanAtZoom(t){return this._size/2/(this._zoomToPanScale*t)}zoomAtPixelsPerPan(t){return this._size/2/(this._zoomToPanScale*t)}pixelsPerRotate(){let t=Math.max(Math.cos(Math.abs(this._pitch)),.5);return this._size/2/t}compareTo(t,i){if(this.viewingMode===Se.Global){let s=(xe(this.center)+xe(t.center))/2;i.pan=Vp(this.center,t.center)*s}else i.pan=ui(this.center,t.center);let r=Math.abs(t._yaw-this._yaw);r>=Math.PI&&(r=2*Math.PI-r);let n=Math.abs(t._pitch-this._pitch);i.rotate=Math.max(r,n),i.fov=t.fov-this.fov,i.sourceZoom=this._distance,i.targetZoom=t._distance}interpolate(t,i,r){this.viewingMode===Se.Global?aF(t.center,i.center,r.pan,this.center):ni(this.center,t.center,i.center,r.pan),this._distance=isFinite(i.distance)?Xe(t.distance,i.distance+r.zoomOffset,r.zoom):t.distance,this._pitch=Xe(t.pitch,i.pitch,r.rotate);let n=t._yaw,s=i._yaw;Math.abs(s-n)>=Math.PI&&(n+=2*(n<s?1:-1)*Math.PI),this._yaw=Xe(n,s,r.rotate),this._fov=Xe(t.fov,i.fov,r.fov)}copyFrom(t){ee(this.center,t.center),this._pitch=t.pitch,this._yaw=t.yaw,this._distance=t.distance,ee(this.direction,t.direction),this._size=t.size,this._fov=t.fov,this._zoomToPanScale=Math.atan(.5*this._fov),this.viewingMode=t.viewingMode}copyFromRenderCamera(t){let i=this._lookAtOrientation(t.center,MG);ee(this.center,t.center),ve(Yr,t.center,t.eye),ts(Yr,Yr,i),ts(Yu,t.up,i),this._distance=xe(Yr),this._distance!==0&&(Yr[0]/=this._distance,Yr[1]/=this._distance,Yr[2]/=this._distance),this._pitch=eJ(Yr),this._yaw=tJ(Yr,Yu),this._size=Math.sqrt(t.width*t.width+t.height*t.height),this._fov=t.fov,this._zoomToPanScale=Math.atan(.5*this._fov)}copyToRenderCamera(t){let i=this._lookAtOrientation(this.center,MG);qc(i,i),this._axisAngleVec3(QT,this._pitch-Math.PI/2,xG,Yr),this._axisAngleVec3(Uh,this._yaw,Yr,Yr),this._axisAngleVec3(QT,this._pitch-Math.PI/2,Uh,Yu),this._axisAngleVec3(Uh,this._yaw,Yu,Yu),X(Yr,Yr,this._distance),ts(Yr,Yr,i),ts(Yu,Yu,i),t.center=this.center,t.eye=ve(Yr,this.center,Yr),t.up=Yu,t.fov=this._fov}_axisAngleVec3(t,i,r,n){let s=Math.cos(i),o=Math.sin(i);return X(qs,r,s),At(bs,t,r),X(bs,bs,o),X(Qu,t,(1-s)*ae(t,r)),he(n,he(n,qs,bs),Qu)}_lookAtOrientation(t,i=Ln()){return this._upAtLookAt(t,Qu),At(qs,this.direction,Qu),ne(qs,qs),qs[0]===0&&qs[1]===0&&qs[2]===0&&ee(qs,QT),At(bs,Qu,qs),ne(bs,bs),i[0]=qs[0],i[1]=bs[0],i[2]=Qu[0],i[3]=qs[1],i[4]=bs[1],i[5]=Qu[1],i[6]=qs[2],i[7]=bs[2],i[8]=Qu[2],i}_upAtLookAt(t,i){return this.viewingMode===Se.Local?ee(i,Uh):ne(i,t)}};function eJ(e){return Math.PI-Vp(Uh,e)}function tJ(e,t){let i=iJ;return Math.abs(t[2])<.5?(ee(i,t),e[2]>0&&X(i,i,-1)):ee(i,e),At(bs,i,Uh),ne(bs,bs),Vp(QT,bs,Uh)}var qs=w(),bs=w(),Qu=w(),Yr=w(),Yu=w(),iJ=w(),Uh=G2,xG=z2,QT=j2,MG=Ln();var YT=class{get finished(){return this.currentTime>=this._animation.time}get time(){return this._animation.time}constructor(t){this.currentTime=0,this._animation=new gT(()=>new Iy(t)),this._current=new Iy(t)}update(t,i,r){let{source:n,target:s}=this._animation.definition,o=ve(rJ,i.center,t.center),a=xe(o);a>=1e-5?(o[0]/=a,o[1]/=a,o[2]/=a):(o[0]=0,o[1]=1,o[0]=0),ee(n.direction,o),ee(s.direction,o),n.copyFromRenderCamera(t),s.copyFromRenderCamera(i),this._current.copyFrom(n),this._animation.update(n,s,r),this.currentTime=0,t.almostEquals(i)&&(this.currentTime=this._animation.time)}cameraAt(t,i){this._animation.cameraAt(t,this._current),this._current.copyToRenderCamera(i)}step(t,i){this.finished||(this.currentTime=this.currentTime+i0(t),this.currentTime>=this.time&&(this.currentTime=this.time)),this.cameraAt(this.currentTime/this.time,i)}},rJ=w();var Vt;(function(e){e[e.Ready=0]="Ready",e[e.Rejected=1]="Rejected",e[e.Running=2]="Running",e[e.Stopped=3]="Stopped",e[e.Finished=4]="Finished"})(Vt||(Vt={}));var No=class extends P{constructor(e){super(e),this.state=Vt.Ready}get running(){return this.state===Vt.Running}get isInteractive(){return!1}get canStop(){return!1}stopController(){return!!this.canStop&&(this.state=Vt.Stopped,!0)}finishController(){this.state=Vt.Finished}get steppingFinished(){return!1}};u([d({constructOnly:!0})],No.prototype,"view",void 0),u([d({readOnly:!0})],No.prototype,"running",null),u([d()],No.prototype,"state",void 0),u([d({readOnly:!0})],No.prototype,"isInteractive",null),No=u([C("esri.views.3d.state.controllers.CameraController")],No);var Ku=class extends No{constructor(){super(...arguments),this._asyncResult=null}get canStop(){return!0}set asyncResult(e){this._asyncResult&&(this._asyncResult.reject(Mr()),this._asyncResult=null),this.state===Vt.Finished||this.state===Vt.Stopped?(ZN(e),this.state===Vt.Finished?e.resolve():e.reject(Mr())):this._asyncResult=e}get asyncResult(){return this._asyncResult}onControllerStart(){this.state=Vt.Running,this.viewAnimation!=null&&this.viewAnimation.when(()=>this.updateStateFromViewAnimation(),()=>this.updateStateFromViewAnimation())}updateStateFromViewAnimation(){!this.viewAnimation||this.state!==Vt.Ready&&this.state!==Vt.Running||(this.viewAnimation.state===Cn.State.FINISHED?this.finish():this.viewAnimation.state===Cn.State.STOPPED&&(this.state=Vt.Stopped))}onControllerEnd(e){this.viewAnimation==null||this.viewAnimation.done||(this.state===Vt.Finished?this.viewAnimation.finish():this.state===Vt.Stopped&&this.viewAnimation.stop()),this._asyncResult&&(this.state===Vt.Finished?this._asyncResult.resolve():this._asyncResult.reject(Mr()))}finish(){this.finishController()}};Ku=u([C("esri.views.3d.state.controllers.AnimationController")],Ku);var pl=class extends Ku{get _intersectionHelper(){return this.view.sceneIntersectionHelper}constructor(e){super(e),this.type="point-to-point",this.mode="interaction",this._hasTarget=!1}initialize(){this.animation=new YT(this.view.state.viewingMode),this.viewAnimation=this.mode==="interaction"?null:new Cn}get isInteractive(){return this.mode==="interaction"}begin(e,t){this._hasTarget=!0;let i=this.animationSettings(t);KT.copyFrom(this.view.state.camera);let r=nn(this.view.state.viewingMode);this._intersectionHelper.intersectRay(KT.ray,r,SG)&&(KT.center=SG),this.animation.update(KT,e,i),this.animation.finished&&this.finish()}finish(){this.animation.currentTime=this.animation.time,super.finish()}get steppingFinished(){return this._hasTarget&&this.animation.finished}stepController(e,t){this._hasTarget&&this.animation.step(e,t)}onControllerEnd(e){this._hasTarget&&(this.animation.cameraAt(this.animation.currentTime/this.animation.time,e),this.animation.currentTime=this.animation.time),super.onControllerEnd(e)}animationSettings(e={}){return be(ie({apex:{maximumDistance:this.view.state.constraints.clampAltitude(1/0)/6,ascensionFactor:void 0,descensionFactor:void 0}},e),{easing:typeof e.easing=="string"?gy[e.easing]:e.easing})}};u([d({constructOnly:!0})],pl.prototype,"mode",void 0),u([d({readOnly:!0})],pl.prototype,"isInteractive",null),pl=u([C("esri.views.3d.state.controllers.PointToPointAnimationController")],pl);var KT=new Rt,SG=w();function yP(e){return e!=null&&"type"in e&&e.type==="point-to-point"}function jh(e=sJ){return[e[0],e[1],e[2],e[3]]}function Tc(e,t){return nJ(e[0],e[1],e[2],t,sF.get())}function nJ(e,t,i,r,n=jh()){return n[0]=e,n[1]=t,n[2]=i,n[3]=r,n}function Af(e,t,i){return At(i,e,t),ne(i,i),i[3]=V0(e,t),i}var sJ=[0,0,1,0],lje=Ug(),cje=Ug();function Ay(e,t,i,r){let n=Qa(t,i,oJ);return Zc(e,n,r)}var oJ=Os();var Ju;(function(e){e[e.Ellipsoid=0]="Ellipsoid",e[e.Silhouette=1]="Silhouette"})(Ju||(Ju={}));var aE=30,Nf=[1,3e8],ml=80,lE=8,cE=200,uE=1508e5,dE=5,hE=50,VG=5,HG=10,pE=90,Cs={exclude:new Set([Wl])};function fl(e,t,i){return i[0]=t[0]/(e.fullWidth/e.pixelRatio),i[1]=t[1]/(e.fullHeight/e.pixelRatio),i}function Py(e){for(;e>Math.PI;)e-=2*Math.PI;for(;e<-Math.PI;)e+=2*Math.PI;return e}function Ws(e,t,i){let r=uo(oF.get(),i[3],i);r==null||Q2(r,Wc)||(ve(qt,e.eye,t),si(qt,qt,r),e.eye=he(qt,qt,t),ve(qt,e.center,t),si(qt,qt,r),e.center=he(qt,qt,t),e.up=si(qt,e.up,r))}function BG(e,t,i,r){return j0(e,bw(t,i,MP),r)}function Oy(e,t,i,r){return j0(e,Qa(t,i,MP),r)}function Lf(e,t,i,r){let n=fi.get(),s=1-i;ve(n,t,e.eye);let o=xe(n),a=o*(1-s);s>=0&&a<r&&(a=r,s=-(a-o)/o),Math.abs(o-a)<1e-6||(X(n,n,s),e.eye=he(qt,e.eye,n),e.center=ni(qt,e.center,t,s))}function mE(e,t,i){t.getScreenCenter(IG),Ay(e,t,IG,qt)&&(t.center=qt);let r=t.distance,n=r*i;if(Math.abs(r-n)<1e-6)return;let s=X(fi.get(),t.viewForward,n);t.eye=ve(qt,t.center,s)}var IG=Kt();function fE(e,t){Te(t,0,0,0);for(let i of e)he(t,t,i);X(t,t,1/e.length)}function Ny(e,t,i,r){return Math.sin(e/xe(t))*(i+r.radius)}function bP(e,t,i,r){return Ny(Math.PI/2,t,i,r)+(e-Math.PI/2)}var Ji;(function(e){e[e.Vertical=0]="Vertical",e[e.Horizontal=1]="Horizontal"})(Ji||(Ji={}));var AG={Elevation:3e4,Angle:kt(16)},UG=kt(80);function gE(e,t,i,r,n,s){let o=w(),a=cr(),l=!0,c=!0;return e.intersectScreen(i,o,s)?a[3]=xe(o):(c=!1,t.aboveGround&&n!==Ju.Ellipsoid?a[3]=Math.max(xe(t.center),.9*r.radius):a[3]=xe(t.eye)-t.relativeElevation,n===Ju.Silhouette?ed(a,t,i,o):l=Ay(a,t,i,o)),{sphere:a,scenePickPoint:l?o:null,hasGeometryIntersection:c}}function gl(e,t,i,r){let n=e.relativeElevation;if(n>AG.Elevation&&r==="global")return Ji.Horizontal;Qa(e,t,wP);let s=Math.sign(n),o=i.worldUpAtPosition(e.eye,qt);return-s*ae(o,wP.direction)<Math.sin(AG.Angle)*xe(wP.direction)?Ji.Vertical:Ji.Horizontal}function _E(e,t,i){ve(vP,i,t),e.eye=ve(qt,e.eye,vP),e.center=ve(qt,e.center,vP)}var vP=w();function ed(e,t,i,r){let n=Qa(t,i,MP);return n!=null&&(Qc(e,n,XT),Zc(e,n,r)?!(po(XT,n.origin)<po(r,n.origin))||(ee(r,XT),!1):(ve(Rf,t.eye,t.center),ne(Rf,Rf),B0(Rf,-ae(ne(Rf,Rf),XT),RG),j0(RG,n,r),!1))}var XT=w(),Rf=w(),RG=Gl();function CP(e,t,i,r,n,s){let o=0;if(At(oE,e,t),ve(iE,e,t),xe(e)<=n||!r.aboveGround){At(i,iE,r.eye);let a=ae(e,t)/(xe(e)*xe(t));if(a<.9999)o=oo(a);else{let c=xe(At(w(),e,t))/(xe(e)*xe(t));o=xp(c)}let l=Math.cos(q(oa.normalize(kt(s)),0,UG));o=-o-Math.max(0,xe(t)-n)/(l*n)}else ve(PG,r.eye,r.center),At(i,iE,PG),o=-xe(iE)/n;return ne(i,i),X(i,i,xe(oE)),o}var PG=w();function OG(e,t,i,r){let n,s,o=Math.cos(q(oa.normalize(kt(r)),0,UG));return n=t>i?-(t-i)/(o*i):t<-i?Math.PI-(t+i)/(o*i):oo(t/i),s=e>i?-(e-i)/(o*i):e<-i?Math.PI-(e+i)/(o*i):oo(e/i),(s-n)*i}function aJ(e,t,i,r,n,s,o,a,l,c){let h=OG(e[2],t[2],s[3],a),p=l?OG(e[0],t[0],s[3],180):t[0]-e[0],m=Math.sin(o)*p-Math.cos(o)*h,f=Math.cos(o)*p+Math.sin(o)*h;ne(qt,n);let g=l?m/Math.sqrt(Math.abs(s[3]**2-ae(i,qt)**2)):m/s[3],_=f/Math.sqrt(Math.abs(s[3]**2-ae(i,r)**2));es(c,g,_)}function TP(e,t,i,r,n,s,o,a,l,c){At(oE,e,t),ew(s.up,s.eye,JT,eE,tE),ew([0,0,1],s.eye,Ec,Xu,GG),ee(i,Xu),ee(r,Ec),ne(i,i),X(i,i,xe(oE)),nM(e,ne(eE,eE),ne(tE,tE),ne(JT,JT),NG),nM(t,eE,tE,JT,LG),aJ(NG,LG,e,Ec,Xu,o,a,l,c,n)}function lJ(e,t,i,r,n,s,o){uo(nE,n,r),uo(sE,o,s),lo(Of,nE,sE),ve(t,e,i),si(t,t,Of),he(t,t,i)}function EP(e,t,i,r,n,s){uo(nE,r,i),uo(sE,s,n),lo(Of,nE,sE),ve(qt,e.eye,t),si(qt,qt,Of),e.eye=he(qt,qt,t),ve(qt,e.center,t),si(qt,qt,Of),e.center=he(qt,qt,t),ve(qt,e.up,t),si(qt,qt,Of),e.up=he(qt,qt,t)}var zh={Pole:.95,Angle:kt(18),Tilt:45,TiltHysteresisMargin:1e-7},Pf=!1;function yE(e,t,i,r,n,s){let o=Math.abs(r)>Math.PI-zh.Angle||Math.abs(r)<zh.Angle,a=(Math.abs(e[2])<i*zh.Pole||Math.abs(t)>i)&&s;return o&&a?!Pf&&n<zh.Tilt-zh.TiltHysteresisMargin?Pf=!0:Pf&&n>zh.Tilt+zh.TiltHysteresisMargin&&(Pf=!1):Pf=!1,Pf}function DP(e,t,i,r,n,s){if(s)Af(i,r,FG),Ws(t,e,FG);else{let o=CP(i,r,kG,t,e[3],n);Ws(t,e,Tc(kG,o))}}function xP(e,t,i,r,n,s,o){let a=o?20:1,l=1e-12,c,h;ee(Gh,r),rE.copyFrom(t);for(let p=0;p<a&&po(i,Gh)>l&&(c=po(i,Gh),TP(i,Gh,Xu,Ec,Ry,rE,e,n,s,o),EP(rE,e,Ec,Ry[1],Xu,Ry[0]),lJ(Gh,Gh,e,Ec,Ry[1],Xu,Ry[0]),h=po(i,Gh),h<c||p===0);p++)t.copyFrom(rE)}function jG(e,t,i,r,n,s,o){yE(i,ae(t.up,i),e[3],-oa.normalize(kt(n)),s,t.aboveGround)?xP(e,t,i,r,-oa.normalize(kt(n)),s,o):DP(e,t,i,r,s,o)}function cJ(e,t,i,r,n,s){let{eye:o}=e;ew([0,0,1],o,Ec,Xu,GG);let a=t.translation[0]*i.pan,l=n.mode==="zoom"?0:t.translation[1]*i.pan,c=Math.max(Math.sqrt(Math.abs(1-ae(e.center,Ec)**2/xe(e.center)**2)),.5),h=(Math.sin(s)*l+Math.cos(s)*a)/c,p=-Math.cos(s)*l+Math.sin(s)*a;switch(co(r.pan.matrix,r.pan.matrix,h,Ec),r.pan.enabled=!0,n.mode){case"pan":co(r.pan.matrix,r.pan.matrix,p,Xu),r.pan.enabled=!0;break;case"zoom":r.zoom=-t.translation[1]*i.zoom}}function uJ(e,t,i,r,n){let{eye:s,viewRight:o}=e,a=At(fi.get(),o,s),l=t.translation[0]*i.pan;switch(l!==0&&(co(r.pan.matrix,r.pan.matrix,-l,a),r.pan.enabled=!0),n.mode){case"pan":{let c=t.translation[1]*i.pan;c!==0&&(co(r.pan.matrix,r.pan.matrix,c,o),r.pan.enabled=!0);break}case"zoom":r.zoom=-t.translation[1]*i.zoom}}function zG(e,t,i,r,n,s,o,a,l){yE(e.center,ae(e.up,e.center),xe(e.center),-oa.normalize(kt(s)),o,t.aboveGround)?cJ(t,i,r,a,l,-oa.normalize(kt(n))):uJ(t,i,r,a,l)}var Ec=w(),Xu=w(),GG=w(),JT=w(),eE=w(),tE=w(),NG=w(),LG=w(),Ry=Hi(),FG=jh(),nE=Wt(),sE=Wt(),Of=Wt(),Gh=w(),qt=w(),iE=w(),rE=new Rt,oE=w(),kG=w(),MP={origin:w(),direction:w()},wP={origin:w(),direction:w()};var qG=.6,SP=4,dJ=60,Ff=class extends pl{constructor(){super(...arguments),this._zoomLocation=w(),this._tmpCamera=new Rt,this._tmpViewDir=w(),this._tmpRayDir=Os(),this._targetOnSphere=w(),this._tmpCenter=w(),this._beginCamera=new Rt,this._constraintOptions=new xi(ut.ALL_EXCEPT_COLLISION,Ne.ZOOM,null,this._beginCamera),this._sphere=cr()}initialize(){this._intersector=nn(this.view.state.viewingMode)}step(e,t){if(!this.running)return;let i=this.view.state;this.animation.finished?this._beginCamera.copyFrom(i.camera):this.animation.cameraAt(1,this._beginCamera);let r=!1,n=!1;this._intersectionHelper.intersectScreen(t,this._zoomLocation,this.view.map.ground.opacity===0?Cs:{})&&(r=e>0,n=!0),this._tmpCamera.copyFrom(i.camera),r?this._intersectionHelper.intersectRay(this._tmpCamera.ray,this._intersector,this._tmpCenter)&&(this._tmpCamera.center=this._tmpCenter):this._intersectionHelper.intersectRay(this._tmpCamera.ray,this._intersector,this._zoomLocation)?this._tmpCamera.center=this._zoomLocation:ee(this._zoomLocation,this._tmpCamera.center),this._updateCamera(this._tmpCamera,e,t,n),this.begin(this._tmpCamera)}animationSettings(){return{duration:600,easing:Lu}}_updateCamera(e,t,i,r){let n=gl(e,i,this.view.renderCoordsHelper,this.view.viewingMode),s=Math.abs(this.view.camera.position.z),o=this._zoomLocation;ne(wE,e.eye),X(wE,wE,-1),Qa(e,i,this._tmpRayDir),ne(this._tmpRayDir.direction,this._tmpRayDir.direction);let a=q(Math.min(lE,1/Math.abs(ae(wE,this._tmpRayDir.direction)))*s,cE,uE);if(n===Ji.Horizontal){let l=qG**t;this._sphere[3]=xe(o),ve(this._tmpViewDir,e.center,e.eye);let c=Math.min(xe(this._tmpViewDir),a),h=c*l;if(l<=1&&h<SP&&(h=SP,l=h/c),Math.abs(c-h)<1e-6)return;let p=xe(e.center);if(this._sphere[3]!==p){let m=this._sphere[3]+l*(p-this._sphere[3]);e.center=X(vE,e.center,m/p)}X(this._tmpViewDir,this._tmpViewDir,-l),e.eye=he(vE,e.center,this._tmpViewDir),Pt(this.view,e,this._constraintOptions),po(o,e.center)>1e-12&&Ay(this._sphere,e,i,this._targetOnSphere)&&jG(this._sphere,e,o,this._targetOnSphere,this.view.camera.heading,this.view.camera.tilt,!0)}else{let l=qG**Math.abs(t),c=t>0?1:-1;ve(this._tmpViewDir,o,e.eye);let h=xe(this._tmpViewDir),p=this.view._stage.renderView.getMinimalDepthForArea(null,i[0],i[1],this.view.state.camera,dJ),m=p??a;m=r&&t>0?Math.min(m,h):m,X(this._tmpRayDir.direction,this._tmpRayDir.direction,m),he(o,this._tmpRayDir.origin,this._tmpRayDir.direction);let f=m*l,g=Math.max(SP,1.01*e.nearFar[0]);if(t>0&&f<g&&(f=g,l=f/m),Math.abs(m-f)<1e-6)return;X(this._tmpRayDir.direction,this._tmpRayDir.direction,c*(1-l)),e.eye=he(vE,e.eye,this._tmpRayDir.direction),e.center=he(vE,e.center,this._tmpRayDir.direction)}Oo(this.view,e)}};Ff=u([C("esri.views.3d.state.controllers.ZoomStepControllerGlobal")],Ff);var vE=w(),wE=w();var hJ=.6,pJ=4,mJ=60,kf=class extends pl{constructor(){super(...arguments),this._zoomLocation=w(),this._tmpCamera=new Rt,this._tmpRayDir=w(),this._tmpCenter=w(),this._beginCamera=new Rt,this._constraintOptions=new xi(ut.ALL,Ne.ZOOM,null,this._beginCamera)}step(e,t){if(!this.running)return;let i=this.view.state;this.animation.finished?this._beginCamera.copyFrom(i.camera):this.animation.cameraAt(1,this._beginCamera),this._tmpCamera.copyFrom(i.camera);let r=nn(this.view.state.viewingMode),n=!1;e>0?(n=this._intersectionHelper.intersectScreenFreePointFallback(t,this._zoomLocation,this.view.map.ground.opacity===0?Cs:{}),this._intersectionHelper.intersectRay(this._tmpCamera.ray,r,this._tmpCenter)&&(this._tmpCamera.center=this._tmpCenter)):this._intersectionHelper.intersectRay(this._tmpCamera.ray,r,this._zoomLocation)?this._tmpCamera.center=this._zoomLocation:ee(this._zoomLocation,this._tmpCamera.center);let s=hJ**e,o=this.view._stage.renderView.getMinimalDepthForArea(Yl(this.view),t[0],t[1],this.view.state.camera,mJ);ve(bE,this._tmpCamera.eye,this._zoomLocation),ne(bE,bE);let a=q(Math.min(lE,1/Math.abs(ae(fJ,bE)))*Math.abs(this.view.camera.position.z),cE,uE);if(o=o??a,o){let l=w();ve(l,this._zoomLocation,this._tmpCamera.eye),(o<xe(l)||!n)&&(ne(l,l),he(this._zoomLocation,this._tmpCamera.eye,X(l,l,o)))}this._updateCamera(this._tmpCamera,s,this._zoomLocation),this.begin(this._tmpCamera)}animationSettings(){return{duration:600,easing:Lu}}_updateCamera(e,t,i){ve(this._tmpRayDir,i,e.eye);let r=xe(this._tmpRayDir),n=r*t,s=t<=1,o=Math.max(pJ,1.01*e.nearFar[0]);n!==0&&(s&&n<o&&(n=o,t=n/r),Math.abs(r-n)<1e-6||(X(this._tmpRayDir,this._tmpRayDir,t),e.eye=ve(WG,i,this._tmpRayDir),e.center=ni(WG,e.center,i,1-t),Pt(this.view,e,this._constraintOptions)))}};kf=u([C("esri.views.3d.state.controllers.ZoomStepControllerLocal")],kf);var WG=w(),fJ=yt(0,0,1),bE=w();var CE=class extends rt{constructor(t,i){super(!0),this._view=t,this.registerIncoming("double-click",i,r=>this._handleDoubleClick(r))}_handleDoubleClick(t){let i=t.data;if(dy(i,"primary")){let r=this._view.state.isGlobal?new Ff({view:this._view,mode:"animation"}):new kf({view:this._view,mode:"animation"});this._view.state.switchCameraController(r),r.step(Math.log(.5)/Math.log(.6),Kt(i.x,i.y)),t.stopPropagation()}}};function QG(e,t,i){return e===Se.Global?new AP(i):new IP(t,i)}var IP=class{constructor(t,i){this._elevationProvider=t,this._referenceEllipsoid=_t(i),this._unitInMeters=Rg(i,this._referenceEllipsoid.metersPerDegree)}compute(t,i,r,n,s){s||(s={near:0,far:0});let o=t[2]*this._unitInMeters,a=o,l=o-n,c=this._elevationProvider?.visibleElevationBounds;c&&(o=l>=0?a-this._unitInMeters*c.min:this._unitInMeters*c.max-a);let h={x:(r=r??new Vi({xmin:0,ymin:0,zmin:0,xmax:0,ymax:0,zmax:0})).xmax-r.xmin,y:r.ymax-r.ymin,z:4*Math.max(r.xmax-r.xmin,r.ymax-r.ymin)},p=Math.max(h.x,h.y,h.z);ve(qh,i,t),Vf[0]=qh[0]>0?r.xmax:r.xmin,Vf[1]=qh[1]>0?r.ymax:r.ymin,Vf[2]=qh[2]>0?p/2:-p/2,ve(Vf,Vf,t),ne(qh,qh);let m=1.1*ae(Vf,qh)*this._unitInMeters,f=Math.sqrt(o*(o+2*this._referenceEllipsoid.radius)),g=Math.max(r.xmax-r.xmin,r.ymax-r.ymin),_=g*yJ*this._unitInMeters,v=g*vJ*this._unitInMeters,b=q((o-v)/(_-v),0,1)**3,x=Math.min(Xe(f,m,b),f)*Math.max(Math.log(Math.abs(l)),1);return YG(Math.min(x,Math.max(34064e4,p))/this._unitInMeters,TE,this._unitInMeters,s)}},AP=class{constructor(t){this._referenceEllipsoid=_t(t)}compute(t,i,r,n,s){s||(s={near:0,far:0});let o=xe(t),a=o-this._referenceEllipsoid.radius,l=this._referenceEllipsoid.radius+Math.min(0,n),c=Math.abs(a-n),h=Math.max(c,Math.abs(a)),p=Math.sqrt(h*(h+2*l)),m=o+this._referenceEllipsoid.radius,f=1.2*Xe(p,m,pm(h)),g=(Math.log(h)-$G)/(gJ-$G);return YG(f,q(TE-g*(TE-ZG),ZG,TE),1,s)}};function YG(e,t,i,r){let n=_J/i,s=e/t;return s>n?(r.far=e,r.near=s):(r.near=n,r.far=r.near*t),r}var $G=7.983,gJ=16.994,TE=2e4,ZG=100,_J=2,yJ=.001,vJ=1e-4,Vf=w(),qh=w();var Ly=class extends P{constructor(e){super(e)}initialize(){this.addHandles(this.view.basemapTerrain.on("elevation-change",e=>this._handleElevationChangeEvent(e)))}_handleElevationChangeEvent(e){if(this.view.state.cameraController)return;let t=this.view.state.camera;e.spatialReference!=null&&Dw(this.view,t,e.extent,e.spatialReference)&&this._applyToCurrentCamera()}_applyToCurrentCamera(){this.view.state.updateCamera(e=>Oo(this.view,e,xn.EYE_AND_CENTER))}};u([d({constructOnly:!0})],Ly.prototype,"view",void 0),Ly=u([C("esri.views.3d.state.SurfaceCollisionConstraint")],Ly);var Hf=class extends P{constructor(e){super(e),this.nearFarHeuristic=QG(e.view.state.viewingMode,e.view.basemapTerrain,e.view.renderCoordsHelper.spatialReference)}initialize(){this.addHandles([S(()=>[this.view.constraints?.clipDistance?.near,this.view.constraints?.clipDistance?.far],()=>this._clipDistanceNearFarChanged()),S(()=>this.view.constraints?.clipDistance?.mode,()=>this._updateNearFar()),this.view.state.events.on("before-camera-change",e=>this._updateCameraNearFar(e)),S(()=>this.view.renderDataExtent,()=>this._updateNearFar(),Fe),S(()=>[this.view.constraints?.altitude?.min,this.view.constraints?.altitude?.max],()=>this._updateAltitude(),Fe),S(()=>this.view.constraints?.tilt?.max,()=>this._updateTiltMax(),Fe),S(()=>this.view.constraints?.tilt?.mode,()=>this._updateTilt(),Fe),S(()=>this.view.state?.camera,()=>this._updateTiltAutoMax(),Fe),S(()=>[this.view.map?.ground?.navigationConstraint?.type,this.view.state?.constraints?.collision?.enabled],()=>this._updateCollision(),Fe)]),this.view.state.isLocal&&this.addHandles(S(()=>this.view.renderDataExtent,e=>this._updateLocalSurfaceDistance(e),Re)),this._updateNearFar(),this.view.state.viewingMode!==Se.Local&&this._updateAltitude(),this._updateTilt(),this._updateCollision(),this._set("surfaceCollisionConstraint",new Ly({view:this.view}))}destroy(){this.surfaceCollisionConstraint&&(this.surfaceCollisionConstraint.destroy(),this._set("surfaceCollisionConstraint",null))}_clipDistanceNearFarChanged(){let e=this.view.constraints?.clipDistance;e&&e.mode!=="auto"&&this.view.state.updateCamera(t=>KG(t,e))}_updateNearFar(){this.view.state.updateCamera(e=>this._updateCameraNearFar(e))}_updateCameraNearFar(e){let t=this.view.constraints&&this.view.constraints.clipDistance;(t?t.mode:"auto")==="manual"?KG(e,t):this._updateCameraNearFarAuto(e,t)}_updateCameraNearFarAuto(e,t){this.nearFarHeuristic.compute(e.eye,e.center,this.view.renderDataExtent,im(this.view,e.eye),e),t&&t.autoUpdate(e.near,e.far)}_updateCollision(){let e=this.view.map?.ground?.navigationConstraint?.type,t=!e||e==="stay-above",i=this.view.state.constraints.collision;if(t!==i.enabled){i.enabled=t,t&&this._reapplyConstraints(ut.COLLISION);let r=this.view.constraints&&this.view.constraints.tilt;r&&r.mode!=="auto"||this._updateTiltAuto()}}_updateAltitude(){let e=this.view.constraints&&this.view.constraints.altitude;e&&this.view.state.viewingMode!==Se.Local?this.view.state.constraints.altitude={min:e.min,max:e.max}:this.view.state.constraints.altitude=null,this._reapplyConstraints()}_updateTiltMax(){let e=this.view.constraints&&this.view.constraints.tilt;e&&e.mode!=="auto"&&(this._updateTiltManual(e),this._reapplyConstraints())}_updateTilt(){let e=this.view.constraints&&this.view.constraints.tilt;(e?e.mode:"auto")==="manual"?this._updateTiltManual(e):this._updateTiltAuto(),this._reapplyConstraints()}_updateTiltManual(e){let t=this.view.state.constraints;t.tilt=t.createConstantMaxTilt(kt(e.max))}_updateTiltAuto(){let e=this.view.state.constraints;e.tilt=e.createDefaultTilt(),this._updateTiltAutoMax()}_updateTiltAutoMax(){let e=this.view.constraints&&this.view.constraints.tilt;if(!e||e.mode!=="auto")return;let t=this.view.state.constraints;if(t.tilt){let i=t.tilt(this.view.state.camera.distance).max;e.autoUpdate(kl(i))}}_updateLocalSurfaceDistance(e){if(e==null)return;let t=Math.max(e.width,e.height);if(t<=0)return;e.zmax!=null&&e.zmin!=null&&(t=Math.max(t,e.zmax-e.zmin));let i=this.view.state,r=3*t/Math.atan(i.camera.fov/2);r!==i.constraints.distance&&(i.constraints.distance=r)}_reapplyConstraints(e=ut.ALL){this.view.state.updateCamera(t=>Pt(this.view,t,new xi(e,Ne.NONE,null)))}};function KG(e,t){t&&(e.near=t.near,e.far=t.far)}u([d({constructOnly:!0})],Hf.prototype,"view",void 0),u([d({readOnly:!0})],Hf.prototype,"surfaceCollisionConstraint",void 0),Hf=u([C("esri.views.3d.state.ConstraintsManager")],Hf);var Wh=class extends No{set desiredCamera(e){this._set("desiredCamera",e.clone())}constructor(e){super(e)}get canStop(){return!0}get constraintEnabled(){return this.view.state.constraints.collision.enabled}onControllerStart(){this.state=Vt.Running,this.addHandles(this.view.basemapTerrain.on("elevation-change",e=>this._handleElevationChangeEvent(e))),this._applyCorrection()}onControllerEnd(){this.removeAllHandles()}stepController(){}_handleElevationChangeEvent(e){(e.spatialReference==null||Dw(this.view,this.desiredCamera,e.extent,e.spatialReference))&&this._applyCorrection()}_applyCorrection(){this.view.state.updateCamera(e=>{e.copyViewFrom(this.desiredCamera),Oo(this.view,e,xn.EYE_AND_CENTER)||this.constraintEnabled||(this.state=Vt.Stopped)})}};u([d({constructOnly:!0})],Wh.prototype,"desiredCamera",null),Wh=u([C("esri.views.3d.state.controllers.SurfaceCollisionCorrectionController")],Wh);var wJ=.66;function JG(e){return 360-oM.normalize(e)}function SE(e){return oM.normalize(360-e)}function eq(e,t,i){let r=t.camera;if(r!=null)return CJ(r,_M(e));let{targetGeometry:n}=t;if(n==null)return null;let{camera:s,mode:o}=tq(e,t.rotation,i);if(n.type==="point")return EJ(e,t,n,s,o);let a=n.extent;return a==null?null:rm(e,a,s.heading,s.tilt,o)}async function bJ(e,t,i,r){let n=t.camera;if(n!=null)return TJ(n,_M(e),r);let{targetGeometry:s}=t;if(s==null)throw new Error("Viewpoint has no targetGeometry!");let{camera:o,mode:a}=tq(e,t.rotation,i);if(s.type==="point")return DJ(e,t,s,o,a,r);let l=s.extent;if(l==null)throw new Error("Target geometry has no extent!");return wM(e,l,o.heading,o.tilt,a,r)}function CJ(e,t){let i=e.position,r;try{r=jx(i,t)}catch{return null}if(!r)return null;let n=e.clone();return n.position=r.clone(),n}async function TJ(e,t,i){let r=e.position,n=await Td(r,t,{signal:i});Ht(i);let s=e.clone();return s.position=n.clone(),s}function tq(e,t,i){let r=ou(e,e.state.camera),n=as.ADJUST;return t!=null&&(r.heading=JG(t),n=as.LOCKED),i!=null&&(r.tilt=i),{camera:r,mode:n}}function EJ(e,t,i,r,n){let s=e.spatialReference,o;try{o=jx(i.clone(),s)}catch{return null}if(!o)return null;let a=t.scale!=null?yM(e,t.scale):e.state.camera.distance;return KV(e,o,a,r,n)}async function DJ(e,t,i,r,n,s){let o=e.spatialReference,a=await Td(i.clone(),o,{signal:s});Ht(s);let l=t.scale!=null?yM(e,t.scale):e.state.camera.distance;return Mw(e,a,l,r,n,s)}function iq(e,t,i=null){return i==null&&(i=new Si),FP(e,null,t.clone(),i)}async function rq(e,t,i){let r=LJ(e,t);if(!r)throw new Be("viewpointutils-create:no-target","Missing target for creating viewpoint");let n=new kn({fov:e.camera.fov}),s=new Si({camera:n});if(r.target instanceof Si)return $h(await SJ(e,r.target,r,i,s));if(r.target instanceof kn)return $h(await sq(e,r.target,i,s));let o=r.scale!=null||r.zoom!=null;if(r.target instanceof Vi){let c=r.target.xmin===r.target.xmax||r.target.ymin===r.target.ymax;return $h(o||c?await OP(e,r,r.target.center,n,i,s):await PJ(e,r,r.target,n,i,s))}let a=new NP,l=o?xJ(e,r):void 0;if(await nq(e,r.target,l,a,i),isFinite(a.boundingBox[0])){let c;if(aL(a.boundingBox,Ni),$s.x=Ni[0],$s.y=Ni[1],$s.z=Ni[2],$s.spatialReference=e.spatialReference,isFinite($s.z)&&a.hasZ?c=uL(a.boundingBox):($s.z=void 0,c=F2(cL(a.boundingBox,kJ))),o||c)return $h(await OP(e,r,$s,n,i,s));let h=FJ(e,a.screenSpaceObjects);return $h(await NJ(e,r,$s,a.boundingBox,h,n,i,s))}return r.position?$h(await AJ(e,r,n,s,i)):$h(await RJ(e,r,n,i,s))}function LP(e,t){return t.scale==null&&t.zoom!=null?Iw(e,t.zoom):t.scale}function xJ(e,t){let i=LP(e,t);return i?iF(i):void 0}function IE(e,t){let i=!1;return t.heading!=null?(e.heading=t.heading,i=!0):t.rotation!=null&&(e.heading=JG(t.rotation),i=!0),t.tilt!=null&&(e.tilt=t.tilt,i=!0),t.fov!=null&&(e.fov=t.fov),i}function FP(e,t,i,r){let n=e.spatialReference||Qt.WGS84;if(t??=vo(e,i),t==null)return r;let s=new pt({spatialReference:n});return rM(t.center,e.renderSpatialReference,s)&&(r.targetGeometry=s,r.scale=au(e,t.distance),r.rotation=SE(i.heading),r.camera=i),r}async function xE(e,t,i,r){let n=()=>new Be("viewpointutils:invalid-geometry","The target is missing a valid geometry");if(!t)throw n();t.type==="mesh"&&(t=t.extent);let s=e.basemapTerrain.spatialReference;if(!t.hasZ&&e.basemapTerrain){let p;switch(t.type){case"point":p=t;break;case"multipoint":case"polyline":p=t.extent?.center;break;case"extent":p=t.center;break;case"polygon":p=t.centroid}p!=null&&s&&e.elevationProvider?(p=await Td(p,s,{signal:r}),Ni[2]=Jg(e.elevationProvider,p)??0):Ni[2]=0}let o=VJ[t.type],a=new Array;if(o(t,t.hasZ?p=>{a.push([p[0],p[1],p[2]])}:p=>{a.push([p[0],p[1]])},Ni),a.length===0)throw n();let l=t.spatialReference,c=e.spatialReference,h=await Td(new eL({spatialReference:l,hasZ:t.hasZ,hasM:!1,points:a}),c,{signal:r});if(t.hasZ&&(i.hasZ=!0),t.hasZ)for(let[p,m,f]of h.points)Ni[0]=p,Ni[1]=m,Ni[2]=f,v0(i.boundingBox,Ni);else for(let[p,m]of h.points)Ni[0]=p,Ni[1]=m,v0(i.boundingBox,Ni)}async function MJ(e,t,i,r,n){let s=await Ig(e.whenViewForGraphic(t));if(s.ok===!1||s.value==null||!("whenGraphicBounds"in s.value))return void await xE(e,t.geometry,r,n);let o=s.value,a=await Ig(o.whenGraphicBounds(t,{minDemResolution:i}));if(a.ok===!1||!a.value)return void await xE(e,t.geometry,r,n);let{screenSpaceObjects:l,boundingBox:c}=a.value;rL(r.boundingBox,c),l&&l.forEach(h=>{r.screenSpaceObjects.push(h)}),isFinite(c[2])&&(r.hasZ=!0)}async function nq(e,t,i,r,n){if(Array.isArray(t)&&t.length===2){let s=t[0],o=t[1];if(typeof s=="number"&&typeof o=="number")return $s.x=s,$s.y=o,$s.z=void 0,$s.spatialReference=e.spatialReference?.isGeographic?e.spatialReference:Qt.WGS84,void await xE(e,$s,r,n)}t&&"map"in t&&typeof t.map=="function"?await Promise.allSettled(t.map(s=>nq(e,s,i,r,n))):t instanceof w2?await xE(e,t,r,n):t instanceof rs&&await MJ(e,t,i,r,n)}async function SJ(e,t,i,r,n){if(t.camera)return sq(e,t.camera,r,n);n.scale=t.scale,n.rotation=t.rotation,n.targetGeometry=t.targetGeometry!=null?t.targetGeometry.clone():null,n.camera=null,i.heading!=null?n.rotation=SE(i.heading):i.rotation!=null&&(n.rotation=i.rotation);let s=LP(e,i);return s!=null&&(n.scale=s),n.camera=await bJ(e,n,i.tilt,r),n}async function sq(e,t,i,r){let n=e.spatialReference,s=await Td(t.position,n,{signal:i}),o=t.clone();return o.position=s,FP(e,null,o,r)}async function IJ(e,t,i,r,n,s,o){let a=e.renderSpatialReference;return await O0(t,RP,a,0,{signal:o}),await O0(i,DE,a,0,{signal:o}),s.targetGeometry=new pt(t),n.position=new pt(i),ve(ME,RP,DE),vM(e,DE,ME,r.up,n),s.scale=au(e,ui(DE,RP)),s.rotation=SE(n.heading),s.camera=n,s}async function OP(e,t,i,r,n,s){s.targetGeometry=i.clone();let o=su(e);if(t.position)return IJ(e,s.targetGeometry,t.position,o,r,s,n);if(t.zoomFactor){let l=o.distance/t.zoomFactor,c=X(Ni,o.viewForward,-l);o.eye=he(Ni,o.center,c),s.scale=au(e,l)}ou(e,o,r);let a=IE(r,t)?as.LOCKED:as.ADJUST;if(!t.zoomFactor){let l=LP(e,t);if(l==null){await O0(s.targetGeometry,Ni,e.renderSpatialReference,0,{signal:n});let c=Od(o.frustum,Ni)?ui(o.eye,Ni):o.distance;s.camera=await Mw(e,s.targetGeometry,c,r,a),s.scale=au(e,c)}else s.scale=l,s.camera=await YV(e,s.targetGeometry,s.scale,r,a,n)}return s}async function AJ(e,t,i,r,n){let s=su(e);ee(ME,s.viewForward),vM(e,s.eye,ME,s.up,PP);let o=e.spatialReference,{position:a}=t;if(a){let l=await Td(a,o,{signal:n});i.position=l}else i.position=new pt;return i.heading=t.heading!=null?t.heading:PP.heading,i.tilt=t.tilt!=null?t.tilt:PP.tilt,FP(e,null,i,r)}async function RJ(e,t,i,r,n){if(t.heading!=null||t.rotation!=null||t.scale!=null||t.tilt!=null||t.zoom!=null||t.zoomFactor!=null){let s=su(e),{spatialReference:o,renderSpatialReference:a}=e,l=new pt({spatialReference:o});return rM(s.center,a,l)?OP(e,t,l,i,r,n):n}return n.scale=e.scale,n.camera=e.camera.clone(),IE(n.camera,t),n}async function PJ(e,t,i,r,n,s){s.targetGeometry=i.clone();let o=su(e);ou(e,o,r);let a=IE(r,t)?as.LOCKED:as.ADJUST;return s.camera=await wM(e,i,r.heading,r.tilt,a,n),s}function OJ(e,t,i,r,n){let s=0;i.z!=null?s=i.z:e.basemapTerrain&&e.elevationProvider&&(s=Jg(e.elevationProvider,i)),Te(Ni,i.x,i.y,s),FL(e.spatialReference,Ni,XG,e.renderSpatialReference),Op(EE,XG),qc(EE,EE),Ul(Fy);let o=[[0,1,2],[3,1,2],[0,4,2],[3,4,2],[0,1,5],[3,1,5],[0,4,5],[3,4,5]];for(let g=0;g<o.length;g++){let _=o[g],v=r[_[2]];isFinite(v)||(v=s),Te(Ni,r[_[0]],r[_[1]],v),Ua(Ni,e.spatialReference,Ni,e.renderSpatialReference),v0(Fy,ts(Ni,Ni,EE))}let a=nL(Fy),l=oL(Fy),c=sL(Fy),h=1/Math.tan(t.fovX/2),p=1/Math.tan(t.fovY/2),m=.5*Math.sqrt(a*a+c*c)*Math.max(p,h)+.5*l,f=.5*l*p+.5*Math.max(a,c);return Math.max(m,f)/n}async function NJ(e,t,i,r,n,s,o,a){a.targetGeometry=i.clone();let l=su(e),c=OJ(e,l,i,r,n);ou(e,l,s);let h=IE(s,t)?as.LOCKED:as.ADJUST;return a.camera=await Mw(e,a.targetGeometry,c,s,h,o),a.scale=au(e,c),a}function LJ(e,t){if(!t||!e.spatialReference)return null;let i={target:void 0};return"declaredClass"in t||Array.isArray(t)?i.target=t:(Object.assign(i,t),!i.target&&"center"in t&&t.center&&(i.target=t.center)),i}function $h(e){return e?.camera!=null&&(e.rotation=SE(e.camera.heading)),e}function FJ(e,t){let i=wJ;if(!t.length)return i;let r=Number.NEGATIVE_INFINITY;for(let n=0;n<t.length;n++){let s=t[n].screenSpaceBoundingRect;r=Math.max(r,Math.abs(s[0]),Math.abs(s[1]),Math.abs(s[2]),Math.abs(s[3]))}return i-r/Math.min(e.width,e.height)*2}var NP=class{constructor(){this.hasZ=!1,this.boundingBox=Ul(),this.screenSpaceObjects=new Array}},Ni=w(),XG=Wt(),EE=Ln(),Fy=jc(),kJ=Yt(),ME=w(),DE=w(),RP=w(),PP={heading:0,tilt:0},$s=new pt,VJ={point(e,t,i){i[0]=e.x,i[1]=e.y,e.z!=null&&(i[2]=e.z),t(i)},polygon(e,t,i){let r=e.hasZ;for(let n=0;n<e.rings.length;n++){let s=e.rings[n];for(let o=0;o<s.length;o++)i[0]=s[o][0],i[1]=s[o][1],r&&(i[2]=s[o][2]),t(i)}},polyline(e,t,i){let r=e.hasZ;for(let n=0;n<e.paths.length;n++){let s=e.paths[n];for(let o=0;o<s.length;o++)i[0]=s[o][0],i[1]=s[o][1],r&&(i[2]=s[o][2]),t(i)}},multipoint(e,t,i){let r=e.points,n=e.hasZ;for(let s=0;s<r.length;s++)i[0]=r[s][0],i[1]=r[s][1],n&&(i[2]=r[s][2]),t(i)},extent(e,t,i){e.zmin!=null&&e.zmax!=null?(t(Te(i,e.xmin,e.ymin,e.zmin)),t(Te(i,e.xmax,e.ymin,e.zmin)),t(Te(i,e.xmin,e.ymax,e.zmin)),t(Te(i,e.xmax,e.ymax,e.zmin)),t(Te(i,e.xmin,e.ymin,e.zmax)),t(Te(i,e.xmax,e.ymin,e.zmax)),t(Te(i,e.xmin,e.ymax,e.zmax)),t(Te(i,e.xmax,e.ymax,e.zmax))):(t(Te(i,e.xmin,e.ymin,i[2])),t(Te(i,e.xmax,e.ymin,i[2])),t(Te(i,e.xmin,e.ymax,i[2])),t(Te(i,e.xmax,e.ymax,i[2])))}};var AE=class{constructor(t,i,r){this._target=t,this._options=i,this.view=r,this.state="pending",this._animationController=null,this.promise=new Promise((n,s)=>{this._resolveCallback=n,this._rejectCallback=s;let o=new AbortController;this._options.signal!=null&&so(this._options.signal,()=>this.abort()),this._abortController=o,this._waitForReady()})}_resolve(t){if(this.state!=="finished")return this.state="finished",this._resolveCallback(t)}_reject(t){if(this.state!=="finished")return this.state="finished",this._rejectCallback(t)}abort(t=!1){this._abortController.abort(),this.state==="wait-for-animation-finish"&&!t&&this._animationController!=null&&this.view.state.cameraController===this._animationController&&this._animationController.running&&this._animationController.stopController(),this._reject(Mr())}async _waitForReady(){if(this.state="wait-for-ready",!this.view.ready)try{await Zo(()=>this.view.ready,this._abortController.signal)}catch(t){return this._reject(t)}this._createViewPoint()}async _createViewPoint(){if(this.state!=="finished"){this.state="wait-for-viewpoint",this._animationController=this._options.animate?this._getAnimationController():null;try{let t=await rq(this.view,this._target,this._abortController.signal);if(this.state==="finished")return;let i=t?this._getCameraFromViewpoint(t):null;if(i==null)return;if(this._options.animate){if(this._animationController==null)return;this._startAnimation(i,this._animationController)}else this.view.stateManager.setStateCamera(i.camera,{applyConstraints:!i.isFullySpecified,positionAndOrientationOnly:!0,doNotCancelGoToOperation:!0}),this._resolve()}catch(t){this._reject(t)}}}_getCameraFromViewpoint(t){let i=!!(this._target instanceof Si&&this._target.camera||this._target instanceof kn),r=t.camera;if(r==null)return null;if(!this.view.stateManager.isCompatible(r)){let s=r.position,o=s&&s.spatialReference,a=o?o.wkid:"none",l=this.view.spatialReference?.wkid;return this._reject(new Be("GotoAnimation:incompatible-spatialreference",`Resulting camera has an incompatible spatial reference (camera: ${a}, view: ${l})`,{camera:r})),null}let n=vo(this.view,r);return n==null?(this._reject(new Be("GotoAnimation:invalid-camera","Resulting camera is invalid")),null):{viewpoint:t,camera:n,isFullySpecified:i}}_startAnimation(t,i){this.state="wait-for-animation-finish";let r=i.viewAnimation;if(r==null)return void this._reject(new Be("GotoAnimation:missing-animation","Unreachable code in view.stateManager"));if(r.update(t.viewpoint,"running"),!i.running||i.viewAnimation==null||i.viewAnimation.target!==t.viewpoint||this.view.state.cameraController!==i)return this.abort();let n;t.isFullySpecified?(n=new Wh({view:this.view,desiredCamera:t.camera}),Oo(this.view,t.camera,xn.EYE_AND_CENTER)):Pt(this.view,t.camera),i.begin(t.camera,this._options);let s=()=>{let a=this.view.state.cameraController;n&&(a&&a.running?yP(a)&&a.viewAnimation!=null&&a.viewAnimation.target===t.viewpoint&&(this.view.state.cameraController=n):i.viewAnimation!=null&&i.viewAnimation.target===t.viewpoint&&i.state===Vt.Finished&&(this.view.state.cameraController=n))},o=a=>{if(this.view.state!=null)switch(i.state){case Vt.Finished:switch(this.state){case"pending":case"wait-for-ready":case"wait-for-viewpoint":case"wait-for-animation-finish":this._resolve()}break;case Vt.Ready:case Vt.Rejected:case Vt.Running:case Vt.Stopped:switch(this.state){case"pending":case"wait-for-ready":case"wait-for-viewpoint":case"wait-for-animation-finish":this._reject(a)}}};r.when(s,a=>o(a)),i.asyncResult={resolve:()=>o(),reject:a=>o(a)}}_getAnimationController(){let t=null,i=null,r=this.view.state.cameraController;return yP(r)&&(r.updateStateFromViewAnimation(),r.running&&(t=r,i=t.viewAnimation)),t==null&&(t=new pl({view:this.view,mode:"animation"}),i=t.viewAnimation,this.view.state.switchCameraController(t),t.state===Vt.Rejected)?(i?.stop(),this._reject(new Be("GotoAnimation:goto-cannot-interrupt","Cannot start an animation while interacting")),null):t}};var Li=class extends P{constructor(e){super(e),this.ready=!1,this._windowDevicePixelRatio=1,this._devicePixelRatioOverride=null,this._idleTimeout=oq,this.test={viewStateManager:this,contentCameraResetState:new Map,setDevicePixelRatio:t=>this._devicePixelRatioOverride=t,renderState:null,get maximumPixelRatio(){return this.viewStateManager.view.qualitySettings.maximumPixelRatio},get updatingIgnoreRenderState(){return this.renderState!=null},get idleTimeoutEnabled(){return this.viewStateManager._idleTimeout>0},set idleTimeoutEnabled(t){this.viewStateManager._idleTimeout=t?oq:0}},this._propertiesPool=new Vn({frustum:xw},this),this._cameraSetByUser=!1,this._gotoOperation=null,this._cameraChangeTime=0,this._tmpCanvasSize=new HP}initialize(){this._cameraChangeTime=performance.now(),this.addHandles([tr(()=>this.view.state.events,"before-camera-change",e=>e&&this._updateElevation(e)),S(()=>this.view.state?.camera,(e,t)=>this._cameraChangedHandler(e,t),Fe)]),Wi(()=>this.view.state?.camera,e=>this._updateElevation(e),{once:!0,sync:!0}),this.addHandles([Jr({prepare:()=>this._prepareFrame()}),S(()=>this.view.state.cameraController,()=>{this._cameraSetByUser=!0,this.removeHandles(PE)}),tr(()=>this.view.state.events,"camera-projection-changed",()=>this.notifyChange("scale"))])}destroy(){this.exit(),this._propertiesPool=G(this._propertiesPool)}get camera(){let e=this._get("camera");if(!this.ready)return e;let t=ou(this.view,this.view.state.camera,kP);return t&&e&&t.equals(e)?e:t.clone()}set camera(e){this._updatePropertyBeforeReady("camera",e)||(this.view.elevationProvider?.enableCache(!0),this.setStateCamera(vo(this.view,e),{applyConstraints:!1})||W.getLogger(this).error("#camera=","Invalid camera",e),this.view.elevationProvider?.enableCache(!1))}get contentCamera(){let e=this._get("contentCamera");if(!this.ready)return e;let t=ou(this.view,this.view.state.contentCamera,kP);return t&&e&&t.equals(e)?e:t.clone()}set contentCamera(e){if(this._updatePropertyBeforeReady("contentCamera",e))return;let t=vo(this.view,e);t!=null?(this._updateElevation(t),this.view.state.contentCamera=t):this.view.state.contentCamera=null}installContentCameraReset(e){if(this.removeHandles(VP),this.test.contentCameraResetState.clear(),!this.view.state.fixedContentCamera)return!1;let t=this.zoom,i=this.view.state.camera.distance**2,r=H2(this.view.state.camera.center),n=e.sticky?this.contentCamera.clone():null;return this.addHandles([S(()=>this.contentCamera,()=>{e.sticky||(this.removeHandles(VP),this.test.contentCameraResetState.clear())}),S(()=>this.zoom,s=>{s!==void 0&&t!==void 0&&(this.test.contentCameraResetState.set("view.zoom",Math.abs(s-t)/2),Math.abs(s-t)>2?this.contentCamera=null:this.view.state.fixedContentCamera||(this.contentCamera=n))}),S(()=>this.view.state.camera,s=>{let o=po(r,s.center);this.test.contentCameraResetState.set("camera.center",o/i),o>i?this.contentCamera=null:this.view.state.fixedContentCamera||(this.contentCamera=n)})],VP),!0}get center(){return this.ready?this.view.pointsOfInterest.centerOnContent.location:this._get("center")}set center(e){this._updatePropertyBeforeReady("center",e)||(e?this.isCompatible(e)?this.setStateCamera(this._centerToCamera(e),{applyConstraints:!0})?this.view.pointsOfInterest.centerOnContent.runTask():W.getLogger(this).error("#center=","Invalid center",e):W.getLogger(this).error("#center=","Center has an incompatible spatial reference (center: "+(e.spatialReference?e.spatialReference.wkid:"none")+", view: "+this.view.spatialReference?.wkid+")",e):W.getLogger(this).error("#center=","Center may not be null or undefined"))}get visibleArea(){if(!this.ready){let e=this._get("extent");return e?Ip.fromExtent(e):null}return JV(this.view,this.view.pointsOfInterest.focus.renderLocation)}get extent(){if(!this.ready)return this._get("extent");let e=this.view,t=Sw(e,e.state.camera,e.pointsOfInterest.centerOnContent.renderLocation);return t??this._get("extent")}set extent(e){this._updatePropertyBeforeReady("extent",e)||(e?this.isCompatible(e)?this.setStateCamera(this._extentToCamera(e),{applyConstraints:!0})||W.getLogger(this).error("#extent=","Invalid extent",e):W.getLogger(this).error("#extent=","Extent has an incompatible spatial reference (extent: "+(e.spatialReference?e.spatialReference.wkid:"none")+", view: "+this.view.spatialReference?.wkid+")",e):W.getLogger(this).error("#extent=","Extent may not be null or undefined"))}get frustum(){let e=this._propertiesPool.get("frustum");return e.renderCoordsHelper=this.view.renderCoordsHelper,e.update(this.view.state.camera),e}get constraintsManager(){return this._constraintsManager}get _initialViewpoint(){let e=this.view.map;return e&&"initialViewProperties"in e?e.initialViewProperties?.viewpoint:void 0}get hasInitialView(){return!!this._initialViewpoint}get scale(){if(!this.ready)return this._get("scale");let e=this.view.basemapTerrain.tilingScheme,t=this.view.pointsOfInterest.cameraOnSurface.scale;return e&&t?ZV(this.view,t,this.view.state.contentCamera,e):this._get("scale")}set scale(e){this._updatePropertyBeforeReady("scale",e)||this.setStateCamera(this._scaleToCamera(e),{applyConstraints:!0})||W.getLogger(this).error("#scale=","Invalid scale",e)}get padding(){if(!this.ready)return this._get("padding");let e=this.view.state.camera,t=e.padding,i=e.pixelRatio,r=this._get("padding"),n=Math.round(t[rn.TOP]/i),s=Math.round(t[rn.RIGHT]/i),o=Math.round(t[rn.BOTTOM]/i),a=Math.round(t[rn.LEFT]/i);return r!=null&&r.top===n&&r.right===s&&r.bottom===o&&r.left===a?r:{top:n,right:s,bottom:o,left:a}}set padding(e){this._updatePropertyBeforeReady("padding",e)||(this._paddingToArray(e,this.view.state.camera.pixelRatio,RE),this.view.state.updateCamera(t=>t.padding=RE))}_paddingToArray(e,t,i){e?ho(i,e.top||0,e.right||0,e.bottom||0,e.left||0):ho(i,0,0,0,0);for(let r=0;r<4;r++)i[r]=Math.round(i[r]*t)}get screenCenter(){let e=this.padding;return Zi((this.view.width-(e.left+e.right))/2+e.left,(this.view.height-(e.top+e.bottom))/2+e.top)}get viewpoint(){return this.ready?iq(this.view,this.camera):this._get("viewpoint")}set viewpoint(e){if(!this._updatePropertyBeforeReady("viewpoint",e))if(e)if(this.isCompatible(e))this.setStateCamera(this._viewpointToCamera(e),{applyConstraints:!e.camera})||W.getLogger(this).error("#viewpoint=","Invalid viewpoint",e);else{let t=e.camera!=null?e.camera.position:e.targetGeometry,i=t!=null&&t.spatialReference;W.getLogger(this).error("#viewpoint=","Viewpoint has an incompatible spatial reference (viewpoint: "+(i?i.wkid:"none")+", view: "+this.view.spatialReference?.wkid+")",e)}else W.getLogger(this).error("#viewpoint=","Viewpoint may not be null or undefined")}get zoom(){return this.ready?e3(this.view,this.scale):this._get("zoom")}set zoom(e){this._updatePropertyBeforeReady("zoom",e)||e===void 0||this.setStateCamera(this._zoomToCamera(e),{applyConstraints:!0})||W.getLogger(this).error("#zoom=","Invalid zoom",e)}_computeCanvasSize(){if(this._devicePixelRatioOverride)return this.view.state.contentPixelRatio=this._devicePixelRatioOverride,this._tmpCanvasSize.width=Math.round(this.view.surface.clientWidth*this._devicePixelRatioOverride),this._tmpCanvasSize.height=Math.round(this.view.surface.clientHeight*this._devicePixelRatioOverride),this._tmpCanvasSize.pixelRatio=this._devicePixelRatioOverride,this._tmpCanvasSize;let e=Math.min(this._windowDevicePixelRatio,this.view.qualitySettings.maximumPixelRatio),t=(this._usePhysicalPixelRendering?this._windowDevicePixelRatio:e)*this.view.resolutionScale;this._tmpCanvasSize.width=Math.round(this.view.surface.clientWidth*t),this._tmpCanvasSize.height=Math.round(this.view.surface.clientHeight*t);let i=this.view._stage.renderView.renderingContext?.parameters.maxTextureSize;return i&&Jp(this._tmpCanvasSize,i),this._tmpCanvasSize.pixelRatio=this._tmpCanvasSize.width>0?this._tmpCanvasSize.width/this.view.surface.clientWidth*.5+this._tmpCanvasSize.height/this.view.surface.clientHeight*.5:t,this.view.state&&(this.view.state.contentPixelRatio=Math.min(this._windowDevicePixelRatio,this.view.qualitySettings.maximumPixelRatio)),this._tmpCanvasSize}get _rasterPixelRatio(){return this._devicePixelRatioOverride!=null?this._devicePixelRatioOverride:this._usePhysicalPixelRenderingAny?this._windowDevicePixelRatio:Math.min(this._windowDevicePixelRatio,this.view.qualitySettings.maximumPixelRatio)}get _usePhysicalPixelRendering(){return this.view?._stage?.renderer.isFeatureEnabled(bo.PhysicalPixelRendering)??!1}get _usePhysicalPixelRenderingAny(){let e=this.view?._stage?.renderer;return e&&(e.isFeatureEnabled(bo.PhysicalPixelRendering,pi.IDLE)||e.isFeatureEnabled(bo.PhysicalPixelRendering,pi.INTERACTING)||e.isFeatureEnabled(bo.PhysicalPixelRendering,pi.ANIMATING))}preinit(e){return!(this._isOverridden("center")&&!Va(this.center.spatialReference,e))&&!(this._isOverridden("camera")&&!Va(this.camera.position.spatialReference,e))&&!(this._isOverridden("extent")&&!Va(this.extent.spatialReference,e))&&!!(!this._isOverridden("viewpoint")||Va(this.viewpoint.targetGeometry?.spatialReference,e)&&Va(this.viewpoint.camera?.position?.spatialReference,e))}init(){this._constraintsManager=new Hf({view:this.view}),this._prepareFrame();let e=this._getInitialProperties();this._cameraSetByUser=!1,this._set("ready",!0);for(let t of e)this.set(t.name,t.value);if(!this._cameraSetByUser){let t=this._initialViewpoint||this.view.initialExtent;t&&this.isCompatible(t)?this._setInitialView(t):this.view.state.viewingMode===Se.Local&&this.addHandles(Wi(()=>this.view.basemapTerrain.ready,()=>{this.removeHandles(PE),this._setInitialView(this.view.dataExtent)},{once:!0,initial:!0}),PE)}}exit(){this._cancelGoToOperation(),this.ready&&(this._override("padding",this.padding),this._set("ready",!1),this._clearOverride("hasInitialView"),this._cameraSetByUser=!1,this.removeHandles(PE),this._constraintsManager=G(this._constraintsManager))}async goTo(e,t){return t=ie({animate:!0},t),this._gotoOperation!=null&&this._gotoOperation.abort(t.animate),this._gotoOperation=new AE(e,t,this.view),this.view.resourceController.scheduler.stopFrame(),this._gotoOperation.promise}debugSetCameraOnContent(){this.setStateCamera(su(this.view),{applyConstraints:!1})}step(e){let t=this.view.state,i=t?.cameraController;i&&(t.updateCamera(r=>i.stepController(e,r)),i.steppingFinished&&i.finishController())}_cancelGoToOperation(){this._gotoOperation!=null&&(this._gotoOperation.abort(),this._gotoOperation=null)}_getInitialProperties(){let e=new Set,t=[];for(let{propertyName:i,overrides:r}of BJ){let n=e.has(i),s=this._isOverridden(i);!n&&s&&t.push({name:i,value:this._get(i)}),this._clearOverride(i),(n||s)&&r.forEach(o=>e.add(o))}return t}_setInitialView(e){if(e==null||this._cameraSetByUser)return;if(e instanceof kn)return void this.setStateCamera(vo(this.view,e),{applyConstraints:!1});if(e instanceof Si){if(e.targetGeometry instanceof Vi){let n=rm(this.view,e.targetGeometry,0,.5,as.LOCKED);return void(n!=null&&this.setStateCamera(vo(this.view,n),{applyConstraints:!0}))}let i={applyConstraints:!e.camera},r=this._viewpointToCamera(e);return void this.setStateCamera(r,i)}let t=rm(this.view,e,0,.5,as.LOCKED);t!=null&&this.setStateCamera(vo(this.view,t),{applyConstraints:!0})}_updatePropertyBeforeReady(e,t){return!this.ready&&(this._override(e,t),t&&HJ.has(e)&&this._override("hasInitialView",!0),!0)}isCompatible(e){return e!=null&&(e instanceof Si?e.camera?this.isCompatible(e.camera):this.isCompatible(e.targetGeometry):e instanceof kn?this.isCompatible(e.position):e.spatialReference&&!vL(e.spatialReference,this.view.spatialReference))}_getPreservingHeadingTilt(e=UJ){return this._cameraSetByUser?(e.heading=this.camera.heading,e.tilt=this.camera.tilt):(e.heading=0,e.tilt=.5),e}_centerPointAtDistanceToCamera(e,t,i=td){let{heading:r,tilt:n}=this._getPreservingHeadingTilt(),s=XV(this.view,r,n,e,t,as.ADJUST);return s==null?null:(i.copyFrom(this.view.state.camera),i.eye=s.eye,i.center=s.center,i.up=s.up,i)}_centerToCamera(e){let t;if(e.hasZ)t=this.view.state.camera.distance;else{let{centerOnContent:i}=this.view.pointsOfInterest;i.runTask(),t=i.distance}return this._centerPointAtDistanceToCamera(e,t)}_extentToCamera(e){let{heading:t,tilt:i}=this._getPreservingHeadingTilt(),r=rm(this.view,e,t,i,as.ADJUST,kP);return r?vo(this.view,r):null}_scaleToCamera(e){if(e==null)return null;let t=this.view,i=t.pointsOfInterest.centerOnContent;i.runTask();let r=i.renderLocation,n=t.pointsOfInterest.cameraOnSurface.renderLocation,s=QV(t,e,t.state.contentCamera,r,n);return this._centerPointAtDistanceToCamera(r,s)}_zoomToCamera(e){return this._scaleToCamera(Iw(this.view,e))}_viewpointToCamera(e){return vo(this.view,eq(this.view,e))}setStateCamera(e,t){return!(e==null||!this.view.state.stopActiveCameraController())&&(this._cameraSetByUser=!0,t.doNotCancelGoToOperation||this._cancelGoToOperation(),this.view.state.updateCamera(i=>{t.positionAndOrientationOnly?(i.eye=e.eye,i.center=e.center,i.up=e.up,i.fov=e.fov):i.copyFrom(e),t.applyConstraints&&Pt(this.view,i)}),t.applyConstraints||(this.view.state.cameraController=new Wh({view:this.view,desiredCamera:e})),!0)}_prepareFrame(){let{surface:e,canvas:t}=this.view;if(!e||!t)return;this._windowDevicePixelRatio=window.devicePixelRatio;let i=this._computeCanvasSize();if(i.width!==0&&i.height!==0&&(t.width===i.width&&t.height===i.height||(t.width=i.width,t.height=i.height),this.view.state)){let r=this.view.state.camera;r.fullWidth===i.width&&r.fullHeight===i.height&&r.pixelRatio===i.pixelRatio||(td.copyFrom(r),td.pixelRatio!==i.pixelRatio&&(this._paddingToArray(this.padding,i.pixelRatio,RE),td.padding=RE),td.fullWidth=i.width,td.fullHeight=i.height,td.pixelRatio=i.pixelRatio,this.view.state.camera=td),this._updateViewState()}}_updateElevation(e){let t=this.view.basemapTerrain?.spatialReference,i=this.view.renderCoordsHelper?.getAltitude(e.eye)??0,r=t?im(this.view,e.eye):0;e.relativeElevation=i-r}_updateViewState(){this.test.renderState!=null?this.view.state.mode=this.test.renderState:this.view.animation?this.view.state.mode=pi.ANIMATING:this.view.interacting?this.view.state.mode=pi.INTERACTING:(this.view.state.mode===pi.ANIMATING&&(this._cameraChangeTime=0),performance.now()-this._cameraChangeTime<this._idleTimeout?this.view.state.mode=pi.INTERACTING:this.view.state.mode=pi.IDLE),this.view.state.rasterPixelRatio=this._rasterPixelRatio}_cameraChangedHandler(e,t){e&&t&&e.almostEquals(t)||(this._cameraChangeTime=performance.now(),this._updateViewState())}};u([d({type:kn,dependsOn:["view.state.camera","ready"]})],Li.prototype,"camera",null),u([d({type:kn,dependsOn:["view.state.contentCamera","ready"]})],Li.prototype,"contentCamera",null),u([d({type:pt})],Li.prototype,"center",null),u([d()],Li.prototype,"visibleArea",null),u([d({type:Vi})],Li.prototype,"extent",null),u([d({readOnly:!0})],Li.prototype,"frustum",null),u([d()],Li.prototype,"_constraintsManager",void 0),u([d({readOnly:!0})],Li.prototype,"constraintsManager",null),u([d()],Li.prototype,"_initialViewpoint",null),u([d({readOnly:!0})],Li.prototype,"hasInitialView",null),u([d({readOnly:!0,type:Boolean})],Li.prototype,"ready",void 0),u([d({type:Number})],Li.prototype,"scale",null),u([d()],Li.prototype,"padding",null),u([d({readOnly:!0})],Li.prototype,"screenCenter",null),u([d({constructOnly:!0})],Li.prototype,"view",void 0),u([d({type:Si})],Li.prototype,"viewpoint",null),u([d({type:Number})],Li.prototype,"zoom",null),u([d({readOnly:!0})],Li.prototype,"_rasterPixelRatio",null),u([d({readOnly:!0})],Li.prototype,"_usePhysicalPixelRendering",null),u([d({readOnly:!0})],Li.prototype,"_usePhysicalPixelRenderingAny",null),u([d()],Li.prototype,"_windowDevicePixelRatio",void 0),u([d()],Li.prototype,"_devicePixelRatioOverride",void 0),Li=u([C("esri.views.3d.state.ViewStateManager")],Li);var HP=class{constructor(){this.width=0,this.height=0,this.pixelRatio=1}},HJ=new Set(["camera","viewpoint","extent","scale","center","zoom"]),BJ=[{propertyName:"camera",overrides:["viewpoint"]},{propertyName:"viewpoint",overrides:["extent"]},{propertyName:"extent",overrides:["center","scale"]},{propertyName:"center",overrides:[]},{propertyName:"scale",overrides:["zoom"]},{propertyName:"zoom",overrides:[]},{propertyName:"padding",overrides:[]}],UJ={heading:0,tilt:0},kP=new kn,td=new Rt,RE=Qi(),PE="pending-initial-view",VP="content-camera-reset",oq=300,BP=100;var Kr=class extends No{constructor(){super(...arguments),this.startCamera=new Rt,this.currentCamera=new Rt,this._lastInteraction=0}get isInteractive(){return performance.now()-this._lastInteraction<BP}stepController(e,t){t.copyViewFrom(this.currentCamera),this.currentCamera.copyFrom(t)}onControllerStart(e){this.state=Vt.Running,this.startCamera.copyFrom(e),this.currentCamera.copyFrom(e)}onControllerEnd(e){e.copyViewFrom(this.currentCamera)}commitCamera(){this._lastInteraction=performance.now(),setTimeout(()=>this.notifyChange("isInteractive"),BP),this.view.state.updateCamera(e=>this.stepController(0,e)),this.steppingFinished&&this.finishController()}};u([d({readOnly:!0})],Kr.prototype,"isInteractive",null),u([d()],Kr.prototype,"_lastInteraction",void 0),Kr=u([C("esri.views.3d.state.controllers.InteractiveController")],Kr);var cn;(function(e){e[e.CENTER=0]="CENTER",e[e.EYE=1]="EYE"})(cn||(cn={}));var Zh=class extends Kr{get _intersectionHelper(){return this.view.sceneIntersectionHelper}constructor(e){super(e),this.pivot=cn.CENTER,this._rotScale=0,this._lastPoint=Hi(),this._tmpWorldUp=w(),this._tmpViewDir=w(),this._tmpRotCurPoint=Hi(),this._tmpTransf=Wt(),this._tmpAxis=w(),this._tmpPivotPoint=w(),this._pivotPos=w(),this._constraintOptions=new xi(ut.ALL,Ne.TUMBLE,0,this.startCamera)}initialize(){this._rotScale=this.pivot===cn.CENTER?3:1.5}begin(e){if(this.running){switch(this.pivot){case cn.EYE:ee(this._pivotPos,this.startCamera.eye),this._constraintOptions.interactionType=Ne.LOOK_AROUND,this._constraintOptions.tiltMode=ws.LOOK_AROUND,this._constraintOptions.selection=ut.NONE;break;case cn.CENTER:{let t=this._intersectionHelper.intersectRayFreePointFallback(this.startCamera.ray,this._pivotPos,this.view.map.ground.opacity===0?Cs:{});t||ee(this._pivotPos,this.startCamera.center),this._constrainPivotPoint(e,t),this.startCamera.center=this._pivotPos,this._constraintOptions.interactionType=Ne.TUMBLE,this._constraintOptions.tiltMode=ws.TUMBLE,this._constraintOptions.selection=ut.ALL&~ut.DISTANCE;break}}fl(this.startCamera,e,this._lastPoint)}}_constrainPivotPoint(e,t){let i=this.startCamera,r=w();ve(r,this._pivotPos,i.eye);let n=xe(r),s=Math.abs(this.view.camera.position.z);this.view.renderCoordsHelper.worldUpAtPosition(i.eye,aq);let o=Math.max(Math.min(VG,1/Math.abs(ae(aq,i.viewForward)))*s,HG);t&&(o=Math.min(n,o));let a=Kt(i.width/i.pixelRatio*.5,i.height/i.pixelRatio*.5),l=gl(this.startCamera,a,this.view.renderCoordsHelper,this.view.viewingMode),c=this.view._stage.renderView.getMinimalDepthForArea(Yl(this.view),i.fullWidth/i.pixelRatio*.5,i.fullHeight/i.pixelRatio*.5,i,2.5*pE,pE),h=this.view._stage.renderView.getMinimalDepthForArea(Yl(this.view),e[0],e[1],i,pE);c==null&&h==null||(c=c??h??0,h=h==null||l===Ji.Horizontal?c:h,o=c>h?h:c,o=t?Math.min(o,n):o),ne(r,r),ee(this._pivotPos,he(this._tmpPivotPoint,i.eye,X(this._tmpPivotPoint,r,o)))}update(e){if(this.running){switch(this.pivot){case cn.EYE:this.currentCamera.center=this._applyRotation(this.currentCamera,e,this.currentCamera.center,this._pivotPos);break;case cn.CENTER:this.currentCamera.center=this._pivotPos,this.currentCamera.eye=this._applyRotation(this.currentCamera,e,this.currentCamera.eye,this._pivotPos)}Pt(this.view,this.currentCamera,this._constraintOptions),this.commitCamera()}}end(){this.running&&this.finishController()}_applyRotation(e,t,i,r){this.view.renderCoordsHelper.worldUpAtPosition(r,this._tmpWorldUp),fl(e,t,this._tmpRotCurPoint);let n=(this._lastPoint[1]-this._tmpRotCurPoint[1])*this._rotScale,s=(this._tmpRotCurPoint[0]-this._lastPoint[0])*this._rotScale;ve(this._tmpViewDir,i,r);let o=xe(this._tmpViewDir),a=oo(ae(this._tmpViewDir,this._tmpWorldUp)/o);if(this.pivot===cn.EYE){n*=-.5;let l=.5*Math.PI-a,c=.5*Math.PI*.99;n=l-Math.max(-c,Math.min(c,l+n))}return n=q(n+a,fr.min,fr.max)-a,At(this._tmpAxis,e.up,this._tmpViewDir),this.pivot===cn.CENTER&&(s=-s),uo(this._tmpTransf,s,this._tmpWorldUp),co(this._tmpTransf,this._tmpTransf,n,this._tmpAxis),si(this._tmpViewDir,this._tmpViewDir,this._tmpTransf),e.up=si(UP,e.up,this._tmpTransf),he(UP,r,this._tmpViewDir),Yi(this._lastPoint,this._tmpRotCurPoint),UP}};u([d()],Zh.prototype,"pivot",void 0),Zh=u([C("esri.views.3d.state.controllers.RotateController")],Zh);var UP=w(),aq=w();var Bf=class extends rt{constructor(t,i,r,n){super(!0),this._view=t,this.pointerActions=i,this._pivot=r,this.registerIncoming("drag",n,s=>this._handleDrag(s))}_handleDrag(t){let i=t.data;if(i.pointers.size>1||!af(t.data,this.pointerActions))return;let r=Kt(i.center.x,i.center.y);switch(i.action){case"start":this._cameraController&&(this._cameraController.end(),this._cameraController=null),this._cameraController=new Zh({view:this._view,pivot:this._pivot}),this._view.state.switchCameraController(this._cameraController),this._cameraController.begin(r);break;case"update":this._cameraController&&this._cameraController.update(r);break;case"end":this._cameraController&&(this._cameraController.end(),this._cameraController=null)}t.stopPropagation()}};var OE="esri-fov-overlay",NE={base:OE,outer:`${OE}-outer`,reset:`${OE}-reset`,text:`${OE}-text`},_l=class extends La{constructor(e){super(e),this.onReset=()=>{},this._messagesCommon=null,this._messagesUnits=null,this.fov=null}render(){return $i("div",{class:NE.outer},$i("div",{class:NE.base},$i("p",{class:NE.text},this._overlay),$i("p",{class:NE.reset,onclick:this.onReset,title:this._messagesCommon.reset},this._reset)))}get _overlay(){let{fov:e,_messagesUnits:t}=this;if(!t||e==null)return"";let i=Mk(kl(e),"degrees","arithmetic","arithmetic",0),r=jJ/(2*Math.tan(e/2));return`${i} | ${xk(t,r,"millimeters",0,"abbr")} |`}get _reset(){return this._messagesUnits&&this.fov!=null?"\u21BA":""}};u([d()],_l.prototype,"onReset",void 0),u([d(),Qo("esri/t9n/common")],_l.prototype,"_messagesCommon",void 0),u([d(),Qo("esri/core/t9n/Units")],_l.prototype,"_messagesUnits",void 0),u([d()],_l.prototype,"fov",void 0),u([d()],_l.prototype,"_overlay",null),u([d()],_l.prototype,"_reset",null),_l=u([C("esri.widgets.FovOverlay")],_l);var jJ=Math.sqrt(1872);var id=class extends Kr{constructor(e){super(e),this.onStop=null,this._timeOutId=void 0,this._onReset=()=>{this._startSize=this._lastDrag=null,this._setFov(zJ),this.updateTimeout()},this._center=w(),this._viewForward=w(),this._constraints=new xi(ut.ALL,Ne.ZOOM)}begin(e){WJ(e)?this._showOverlay().fov=e.fov:(this._lastDrag=e[1],this._startSize=null,this._ensureStartSize(this.view.state.camera))}updateTimeout(){clearTimeout(this._timeOutId),this._timeOutId=setTimeout(this.onStop,1500)}update(e){if(this._lastDrag==null)return this._lastDrag=e[1],this._startSize=null,void this._ensureStartSize(this.view.state.camera);let t=-(this._lastDrag-e[1])/2;this._lastDrag=e[1],this.step(t)}step(e){if(!this.running)return void(this._startSize=this._lastDrag=null);let t=this.view.state,i=this.currentCamera.copyFrom(t.camera),r=kl(i.fov)+e,n=kt(q(r,GJ,qJ));n!==i.fov?this._setFov(n):this._showOverlay().fov=i.fov}finish(){this.running&&(this._startSize=this._lastDrag=null,this.finishController())}destroy(){this.hideOverlay()}onControllerEnd(e){super.onControllerEnd(e),this._startSize=this._lastDrag=null,this.hideOverlay()}_showOverlay(){return this._overlay||(this._overlay=new Fu({id:"esri.FovOverlay",node:new _l({onReset:this._onReset})}),this.view.ui.add(this._overlay)),this._overlay.widget}hideOverlay(){this._overlay&&(this.view.ui.remove(this._overlay),this._overlay=G(this._overlay))}_setFov(e){let t=this.view.state,i=this.currentCamera.copyFrom(t.camera),r=this._ensureStartSize(i)/Math.tan(e/2),n=he(jP,this._center,X(jP,this._viewForward,-r));i.eye=n,i.fov=e,this._constraints.interactionStartCamera=t.camera,this._constraints.interactionFactor=ln(this.currentCamera.height-t.camera.height),Pt(this.view,this.currentCamera,this._constraints),this.begin(i),this.commitCamera()}_ensureStartSize(e){if(this._startSize==null){ee(this._viewForward,e.viewForward);let t=this.view._stage.renderView.getMinimalDepthForArea(null,e.fullWidth/e.pixelRatio*.5,e.fullHeight/e.pixelRatio*.5,e,ml),i=ui(e.eye,this.view.pointsOfInterest.centerOnContent.renderLocation),r=t??i;he(this._center,e.eye,X(jP,this._viewForward,r)),this._startSize=r*Math.tan(e.fov/2)}return this._startSize}};u([d()],id.prototype,"onStop",void 0),id=u([C("esri.views.3d.state.controllers.FovController")],id);var zJ=kt(new kn().fov),GJ=10,qJ=150,jP=w();function WJ(e){return!Array.isArray(e)}var FE=class extends Kr{constructor(){super(...arguments),this._pickPoint=w(),this._tmpP0=Hi(),this._panAxisAngle=jh(),this._tmpRayDir=w(),this._tmpRayDirPick=w(),this._targetOnSphere=w(),this._navMode=Ji.Horizontal,this._tmpRay={origin:w(),direction:w()},this.dragBeginPoint=Kt(),this._normalizedAnchorPoint=Hi(),this._constraintOptions=new xi(ut.ALL_EXCEPT_COLLISION,Ne.ZOOM,0,this.startCamera),this._sphere=cr(),this._hasPickPoint=!1}get _intersectionHelper(){return this.view.sceneIntersectionHelper}begin(e){if(!this.running)return;Yi(this.dragBeginPoint,e),fl(this.startCamera,e,this._normalizedAnchorPoint);let t=_t(this.view.spatialReference),i=gE(this._intersectionHelper,this.startCamera,e,t,Ju.Ellipsoid,this.view.map.ground.opacity===0?Cs:{});if(this._navMode=gl(this.startCamera,e,this.view.renderCoordsHelper,this.view.viewingMode),this._navMode===Ji.Horizontal)this._hasPickPoint=!!i.scenePickPoint,this._pickPoint=i.scenePickPoint??this._pickPoint,this._sphere=i.sphere;else{let r;Qa(this.startCamera,e,this._tmpRay),ne(this._tmpRay.direction,this._tmpRay.direction),i.scenePickPoint!=null&&(ve(this._tmpRayDirPick,this.startCamera.eye,i.scenePickPoint),r=xe(this._tmpRayDirPick));let n=Math.abs(this.view.camera.position.z);this.view.renderCoordsHelper.worldUpAtPosition(this.startCamera.eye,lq);let s=q(Math.min(aE,1/Math.abs(ae(lq,this._tmpRay.direction)))*n,Nf[0],Nf[1]),o=this.view._stage.renderView.getMinimalDepthForArea(null,e[0],e[1],this.view.state.camera,ml);s=o??s,s=r!=null?Math.min(s,r):s,this._hasPickPoint=!0,X(this._tmpRay.direction,this._tmpRay.direction,s),he(this._pickPoint,this._tmpRay.origin,this._tmpRay.direction)}}update(e){if(this.running){if(this.currentCamera.eye=this.startCamera.eye,this.currentCamera.center=this.startCamera.center,this.currentCamera.up=this.startCamera.up,this._navMode===Ji.Horizontal){ve(this._tmpRayDir,this.currentCamera.center,this.currentCamera.eye);let t=xe(this._tmpRayDir);fl(this.currentCamera,e,this._tmpP0);let i=12*(this._normalizedAnchorPoint[1]-this._tmpP0[1]),r=t*2**i,n=this.view.state.constraints.minimumPoiDistance;if(i<0&&r<n&&(r=n),Math.abs(t-r)<1e-6)return;if(this._hasPickPoint&&r<t){let s=1-(1-r/t)*(1-this._sphere[3]/xe(this.currentCamera.center));this.currentCamera.center=X(LE,this.currentCamera.center,s)}X(this._tmpRayDir,this._tmpRayDir,-r/t),this.currentCamera.eye=he(LE,this.currentCamera.center,this._tmpRayDir),this._constraintOptions.interactionFactor=ln(ea(this.dragBeginPoint,e)),Pt(this.view,this.currentCamera,this._constraintOptions),this._hasPickPoint&&(ed(this._sphere,this.currentCamera,this.dragBeginPoint,this._targetOnSphere),Af(this._pickPoint,this._targetOnSphere,this._panAxisAngle),Ws(this.currentCamera,this._sphere,this._panAxisAngle))}else{let t=xe(this._tmpRay.direction);fl(this.currentCamera,e,this._tmpP0);let i=12*(this._normalizedAnchorPoint[1]-this._tmpP0[1]),r=t*2**i,n=this.view.state.constraints.minimumPoiDistance;if(i<0&&r<n&&(r=n),Math.abs(t-r)<1e-6)return;X(this._tmpRayDir,this._tmpRay.direction,1-r/t),this.currentCamera.eye=he(LE,this.currentCamera.eye,this._tmpRayDir),this.currentCamera.center=he(LE,this.currentCamera.center,this._tmpRayDir)}Oo(this.view,this.currentCamera),this.commitCamera()}}finish(){this.running&&this.finishController()}};FE=u([C("esri.views.3d.state.controllers.ZoomControllerGlobal")],FE);var LE=w(),lq=w();var kE=class extends Kr{constructor(){super(...arguments),this._tmpP=w(),this._tmpDir=w(),this._tmpN=w(),this._tmpP0=Hi(),this._tmpPoi=w(),this._tmpRayDir=w(),this.dragBeginPoint=Kt(),this._normalizedAnchorPoint=Hi(),this._constraintOptions=new xi(ut.ALL,Ne.ZOOM,0,this.startCamera,w()),this._plane=Gl()}get _intersectionHelper(){return this.view.sceneIntersectionHelper}begin(e){if(!this.running)return;Yi(this.dragBeginPoint,e),fl(this.startCamera,e,this._normalizedAnchorPoint);let t=this._intersectionHelper.intersectScreenFreePointFallback(e,this._tmpP,this.view.map.ground.opacity===0?Cs:{});ve(this._tmpDir,this._tmpP,this.startCamera.eye);let i=xe(this._tmpDir);ne(this._tmpDir,this._tmpDir);let r=Math.abs(this.view.camera.position.z),n=q(Math.min(aE,1/Math.abs(ae($J,this._tmpDir)))*r,Nf[0],Nf[1]),s=this.view._stage.renderView.getMinimalDepthForArea(Yl(this.view),e[0],e[1],this.view.state.camera,ml);n=s??n,n=t?Math.min(n,i):n,X(this._tmpDir,this._tmpDir,n),he(this._tmpP,this.startCamera.eye,this._tmpDir),ve(this._tmpN,this.startCamera.eye,this.startCamera.center),ne(this._tmpN,this._tmpN),this._tmpN[1]<0&&Rs(this._tmpN,this._tmpN),U0(this._tmpP,this._tmpN,this._plane)}update(e){if(!this.running)return;BG(this._plane,this.currentCamera,this.dragBeginPoint,this._tmpPoi)||ee(this._tmpPoi,this.currentCamera.center),fl(this.currentCamera,e,this._tmpP0);let t=4*(this._tmpP0[1]-this._normalizedAnchorPoint[1]);Yi(this._normalizedAnchorPoint,this._tmpP0),ve(this._tmpRayDir,this._tmpPoi,this.currentCamera.eye);let i=xe(this._tmpRayDir),r=i*(1-t);this._constraintOptions.interactionDirection&&(ee(this._constraintOptions.interactionDirection,this._tmpRayDir),X(this._constraintOptions.interactionDirection,this._constraintOptions.interactionDirection,Math.sign(t)/i));let n=this.view.state.constraints.minimumPoiDistance;t>=0&&r<n&&(r=n,t=-(r-i)/i),Math.abs(i-r)<1e-6||(X(this._tmpRayDir,this._tmpRayDir,t),this.currentCamera.eye=he(Qh,this.currentCamera.eye,this._tmpRayDir),ni(Qh,this.currentCamera.center,this._tmpPoi,t),this._tmpPoi[2]>this.startCamera.center[2]?Qh[2]=Math.max(this.startCamera.center[2],Qh[2]):Qh[2]=Math.min(this.startCamera.center[2],Qh[2]),this.currentCamera.center=Qh,this._constraintOptions.interactionFactor=ln(ea(this.dragBeginPoint,e)),Pt(this.view,this.currentCamera,this._constraintOptions),this.commitCamera())}finish(){this.running&&this.finishController()}};kE=u([C("esri.views.3d.state.controllers.ZoomControllerLocal")],kE);var Qh=w(),$J=yt(0,0,1);var VE=class extends rt{constructor(t,i,r){super(!0),this._view=t,this.pointerActions=i,this._fovModifier=r,this.registerIncoming("drag",[r],n=>this._handleZoom(n)),this.registerIncoming("drag",n=>this._handleZoom(n))}_handleZoom(t){let i=t.data;if(i.pointers.size>1||!af(t.data,this.pointerActions))return;let r=Kt(i.center.x,i.center.y);switch(i.action){case"start":{this._cameraController?.finish();let n=this._view,s=t.modifiers.has(this._fovModifier);this._cameraController=s?new id({view:n,onStop:()=>this._stopController()}):n.state.isGlobal?new FE({view:n}):new kE({view:n}),this._view.state.switchCameraController(this._cameraController),this._cameraController.begin(r);break}case"update":this._cameraController?.update(r);break;case"end":this._cameraController instanceof id?this._cameraController.updateTimeout():this._stopController()}t.stopPropagation()}_stopController(){this._cameraController?.finish(),this._cameraController=null}};var xc=class extends Kr{constructor(e){super(e),this._filteredSurfaceElevation=0,this._transformation={translation:[0,0,0],heading:0,tilt:0,zoom:0},this._keysButtonState=[0,0,0,0,0,0,0,0,0,0,0,0],this._tmpCamera=new Rt,this._headingStart=0,this._constraintOptions=new xi(ut.ALL,Ne.NONE,0,new Rt,null,ws.LOOK_AROUND)}handleEventGamepad(e){let t=py(e,this.view.navigation.gamepad,this._transformation);(e.action==="end"||lf(t))&&this.finishController()}activateDirection(e){this._keysButtonState[e]=1,mR(this._keysButtonState,this._transformation)}directionActive(e){return this._keysButtonState[e]===1}countActiveDirections(){return this._keysButtonState.reduce((e,t)=>t>0?e+1:e,0)}deactivateDirection(e){this._keysButtonState[e]=0;let t=mR(this._keysButtonState,this._transformation);lf(t)&&this.finishController()}onControllerStart(e){this._filteredSurfaceElevation=this.view.pointsOfInterest.cameraOnSurface.location.z,this._headingStart=this.view.camera.heading,super.onControllerStart(e)}_updateFilteredSurfaceElevation(e){let t=this.view.pointsOfInterest.cameraOnSurface.location.z,i=1;this._filteredSurfaceElevation+=i*(t-this._filteredSurfaceElevation)*e}stepController(e,t){this._updateStartHeading(),this._updateFilteredSurfaceElevation(e),this.currentCamera.copyViewFrom(t),this._updateCameraCenter(),this._constraintOptions.interactionStartCamera?.copyFrom(this.currentCamera),this._calculateControlTransformation(e,this.currentCamera,Yh),this._applyDisabledMovementTypes(Yh),this._applyPan(Yh.pan),this._applyRotate(Yh.rotate),this._applyZoom(Yh.zoom),this._applyAscend(Yh.ascend),this._constraintOptions.interactionType=Ne.NONE,this._constraintOptions.selection=ut.COLLISION,Pt(this.view,this.currentCamera,this._constraintOptions),super.stepController(e,t)}_updateStartHeading(){this._transformation.heading!==0&&(this._headingStart=this.view.camera.heading)}_applyRotate(e){if(!e.enabled)return;let t=this.currentCamera;ve(Gn,t.center,t.eye),si(Gn,Gn,e.matrix),t.center=he(Gn,Gn,t.eye),t.up=si(Gn,t.up,e.matrix),this._constraintOptions.interactionType=Ne.LOOK_AROUND,this._constraintOptions.selection=ut.ALL_EXCEPT_COLLISION,Pt(this.view,t,this._constraintOptions)}_applyPan(e,t=this.currentCamera){e.enabled&&(t.eye=si(Gn,t.eye,e.matrix),t.center=si(Gn,t.center,e.matrix),this.view.state.isGlobal&&(t.up=si(Gn,t.up,e.matrix)),this._constraintOptions.interactionType=Ne.PAN,this._constraintOptions.selection=ut.ALL,Pt(this.view,t,this._constraintOptions))}_applyZoom(e){if(!e)return;let t=this.currentCamera.viewForward;this.currentCamera.eye=he(Gn,this.currentCamera.eye,X(fi.get(),t,e)),ee(ky,t),Rs(ky,ky),this._constraintOptions.interactionDirection=ky,this._constraintOptions.interactionType=Ne.ZOOM,this._constraintOptions.selection=ut.ALL_EXCEPT_COLLISION,Pt(this.view,this.currentCamera,this._constraintOptions),this._constraintOptions.interactionDirection=null}_applyAscend(e){if(!e)return;let t=this.view.renderCoordsHelper.worldUpAtPosition(this.currentCamera.eye,fi.get());if(this._constraintOptions.interactionDirection=ee(ky,t),this.view.state.isGlobal){let i=xe(this.currentCamera.eye),r=(i+e)/i;this.currentCamera.eye=X(Gn,this.currentCamera.eye,r),this.currentCamera.center=X(Gn,this.currentCamera.center,r)}else{let i=X(fi.get(),t,e);this.currentCamera.eye=he(Gn,this.currentCamera.eye,i),this.currentCamera.center=he(Gn,this.currentCamera.center,i)}this._updateCameraCenter(),this._constraintOptions.interactionType=Ne.ASCEND,this._constraintOptions.selection=ut.COLLISION,Pt(this.view,this.currentCamera,this._constraintOptions)&&this._updateCameraCenter(),this._constraintOptions.selection=ut.ALL_EXCEPT_COLLISION,Pt(this.view,this.currentCamera,this._constraintOptions),this._constraintOptions.interactionDirection=null}_calculateControlTransformation(e,t,i){eee(i);let r=this._computeVelocities(e);this.view.state.isLocal?this._calculateControlTransformationLocal(r,t,i):this._calculateControlTransformationGlobal(r,t,i)}_updateCameraCenter(){let e=this.view.pointsOfInterest.centerOnSurfaceFrequent.estimatedSurfaceAltitude,t=this.view.renderCoordsHelper,i=this.currentCamera.ray;this.currentCamera.center=t.intersectManifoldClosestSilhouette(i,e,Gn)}_calculateControlTransformationLocal(e,t,i){let{viewRight:r,viewForward:n}=t,s=this._transformation,o=this.view.navigation.gamepad,a=Te(fi.get(),n[0],n[1],0);ne(a,a);let l=s.translation[0]*e.pan;if(l!==0){let g=X(fi.get(),r,l);kx(i.pan.matrix,i.pan.matrix,g),i.pan.enabled=!0}switch(o.mode){case"pan":{let g=-s.translation[1]*e.pan;if(g!==0){let _=X(fi.get(),a,g);kx(i.pan.matrix,i.pan.matrix,_),i.pan.enabled=!0}i.zoom=s.zoom*e.zoom;break}case"zoom":i.zoom=(-s.translation[1]+s.zoom)*e.zoom;break;default:o.mode}let c=s.translation[2]*e.ascend;i.ascend=c;let h=-s.heading*e.rotate;h!==0&&(co(i.rotate.matrix,i.rotate.matrix,h,this.view.renderCoordsHelper.worldUpAtPosition(t.eye,fi.get())),i.rotate.enabled=!0);let p=s.tilt*e.rotate,m=la(this.view.renderCoordsHelper,t.center,t.eye),f=q(m+p,fr.min,fr.max)-m;f&&(co(i.rotate.matrix,i.rotate.matrix,f,r),i.rotate.enabled=!0)}_calculateControlTransformationGlobal(e,t,i){let{eye:r,viewRight:n}=t,s=this._transformation,o=this.view.navigation.gamepad,a=At(fi.get(),n,r);ne(a,a),Rs(a,a),zG(this.startCamera,t,s,e,this.view.camera.heading,this._headingStart,this.view.camera.tilt,i,o),this._tmpCamera.copyFrom(this.currentCamera),this._applyPan(Yh.pan,this._tmpCamera);let l=this.view.pointsOfInterest.centerOnSurfaceFrequent.estimatedSurfaceAltitude,c=s.translation[2]*e.ascend;i.ascend=c;let h=-s.heading*e.rotate;h!==0&&(co(i.rotate.matrix,i.rotate.matrix,h,this._tmpCamera.eye),i.rotate.enabled=!0);let p=s.tilt*e.rotate,m=this._clampTiltDeltaGlobalToValidRange(p,t.ray,l);m!==0&&(co(i.rotate.matrix,i.rotate.matrix,m,this._tmpCamera.viewRight),i.rotate.enabled=!0),i.zoom+=s.zoom*e.zoom}_clampTiltDeltaGlobalToValidRange(e,t,i){let r=_t(this.view.spatialReference),n=Ny(fr.min,t.origin,i,r),s=0,o=0,a=fi.get();if(this.view.renderCoordsHelper.intersectManifold(t,i,a)){let l=la(this.view.renderCoordsHelper,a,t.origin);s=Ny(l,t.origin,i,r),o=Ny(fr.max,t.origin,i,r)}else{Qc(Bp(Up,i+r.radius),t,a);let l=Math.PI+V0(t.direction,a);s=bP(l,t.origin,i,r),o=bP(fr.max,t.origin,i,r)}return q(s+e,n,o)-s}_getPointAbsoluteSurfaceElevation(e,t,i){let{renderCoordsHelper:r}=this.view,n=r.getAltitude(e),s=t+Math.abs(n-t);return r.setAltitude(i,s,e),s}_clampedDistanceToSurface(e,t){let{renderCoordsHelper:i}=this.view,{camera:r}=this.view.state,{direction:n}=$V(this.view,t,0,uq,JJ),s=i.intersectManifoldClosestSilhouette(ia(t,n),e,fi.get()),o=ui(t,s),a=i.intersectManifoldClosestSilhouette(ia(t,Pp(fi.get(),t,r.center)),e,fi.get()),l=ui(t,a);return Math.min(o,l)}_computeHeadingRotateRadius(e){let{renderCoordsHelper:t,state:i}=this.view,{camera:r,isGlobal:n}=i,s=t.intersectManifoldClosestSilhouette(r.ray,this._filteredSurfaceElevation,fi.get());if(n){let o=ve(fi.get(),e,s),a=xe(o);X(o,o,1/a);let l=ne(fi.get(),e),c=oo(ae(l,o));return a*Math.sin(Math.min(QJ,c))}{let o=ee(fi.get(),e);return t.setAltitude(o,this._filteredSurfaceElevation),ui(s,o)}}_minimumAscendVelocity(){return this.view.state.constraints.collision.enabled?0:YJ}_computeVelocities(e){let t=this._filteredSurfaceElevation,i=t+_t(this.view.spatialReference).radius,{camera:r,isGlobal:n}=this.view.state,s=fi.get(),o=this._getPointAbsoluteSurfaceElevation(r.eye,t,s),a=this._clampedDistanceToSurface(t,s),l=r.width/2,c=cq*r.width,h=cq*r.width,p=a*Math.tan(.5*r.fovX)/l,m=p/i,f=p/this._computeHeadingRotateRadius(s),g=o-t;return{pan:(n?m:p)*c*e,ascend:Math.max(this._minimumAscendVelocity()*e,2**(c*e/l)*g-g),zoom:2**(c*e/l)*a-a,rotate:q(f*h,KJ,XJ)*e}}_applyDisabledMovementTypes(e){this.disableMovements==null||this.disableMovements.mode!==void 0&&this.view.state.viewingMode!==this.disableMovements.mode||(e.zoom=this.disableMovements.zoom?0:e.zoom,e.ascend=this.disableMovements.ascend?0:e.ascend,e.pan.enabled=!this.disableMovements.pan,this.disableMovements.pan&&Cd(e.pan.matrix),e.rotate.enabled=!this.disableMovements.rotate,this.disableMovements.rotate&&Cd(e.rotate.matrix))}static activatesFor(e,t){let i=py(t,e.navigation.gamepad,ZJ);return!(t.action==="end"||lf(i))}};u([d({constructOnly:!0})],xc.prototype,"gamepadDevice",void 0),u([d({constructOnly:!0})],xc.prototype,"disableMovements",void 0),xc=u([C("esri.views.3d.state.controllers.GamepadKeyboardController")],xc);var ZJ={translation:[0,0,0],heading:0,tilt:0,zoom:0},uq=80,QJ=kt(uq),cq=.75,YJ=5,KJ=kt(30),XJ=kt(80),Yh={zoom:0,ascend:0,pan:{enabled:!1,matrix:Wt()},rotate:{enabled:!1,matrix:Wt()}},Gn=w(),ky=w(),JJ=WV();function eee(e){e.zoom=0,e.ascend=0,e.pan.enabled=!1,Cd(e.pan.matrix),e.rotate.enabled=!1,Cd(e.rotate.matrix)}var HE=class extends rt{constructor(t){super(!0),this._view=t,this._watchHandles=new Pa,this._handle=this.registerIncoming("gamepad",i=>this._handleEventGamepad(i)),this._handle.pause()}onInstall(t){super.onInstall(t),this._watchHandles.add([S(()=>this._view.navigation.gamepad.enabled,i=>{i?this._handle.resume():(this._handle.pause(),this._cameraControllerGamepad&&(this._cameraControllerGamepad.finishController(),this._cameraControllerGamepad=null))},Re),S(()=>this._view.navigation.gamepad.device,i=>{this._cameraControllerGamepad&&i&&this._cameraControllerGamepad.gamepadDevice!==i&&(this._cameraControllerGamepad.finishController(),this._cameraControllerGamepad=null)})])}onUninstall(){this._watchHandles.removeAll(),super.onUninstall()}_handleEventGamepad(t){let i=this._view.navigation.gamepad.device;if(i&&t.data.device!==i)return;let r=this._cameraControllerGamepad?.running;if(r||xc.activatesFor(this._view,t.data)){if(!r){let n=new xc({view:this._view,gamepadDevice:t.data.device});this._view.state.switchCameraController(n),n.state!==Vt.Rejected&&(this._cameraControllerGamepad=n)}this._cameraControllerGamepad&&this._cameraControllerGamepad.running&&this._cameraControllerGamepad.gamepadDevice===t.data.device&&this._cameraControllerGamepad.handleEventGamepad(t.data)}}};var Ts;(function(e){e[e.LEFT=0]="LEFT",e[e.RIGHT=1]="RIGHT",e[e.FORWARD=2]="FORWARD",e[e.BACKWARD=3]="BACKWARD",e[e.UP=4]="UP",e[e.DOWN=5]="DOWN",e[e.HEADINGLEFT=6]="HEADINGLEFT",e[e.HEADINGRIGHT=7]="HEADINGRIGHT",e[e.TILTUP=8]="TILTUP",e[e.TILTDOWN=9]="TILTDOWN",e[e.ZOOMIN=10]="ZOOMIN",e[e.ZOOMOUT=11]="ZOOMOUT"})(Ts||(Ts={}));var BE=class extends rt{constructor(t,i){super(!0),this._view=t,this._keyToDirection=new Map,this._keyToAction=new Map,this._disableMovements={pan:!0,zoom:!1,ascend:!0,rotate:!1,mode:Se.Local},this._stickyKeyTimeoutHandle=void 0,this._stickyKeyDuration=200,this._addKeysMapping(i),this.registerIncoming("key-down",null,r=>this._handleKeyDown(r)),this.registerIncoming("key-up",null,r=>this._handleKeyUp(r)),this.registerIncoming("blur",null,()=>this._handleStop()),this._visibilityHandle=cf(r=>r?null:this._handleStop())}onUninstall(){this._visibilityHandle?.remove(),this._handleStop()}setStickyKeyDuration(t){this._stickyKeyDuration=t}_addKeysMapping(t){this._addKeyMapping(t.pan.left,Ts.LEFT),this._addKeyMapping(t.pan.right,Ts.RIGHT),this._addKeyMapping(t.pan.forward,Ts.FORWARD),this._addKeyMapping(t.pan.backward,Ts.BACKWARD),this._addKeyMapping(t.pan.up,Ts.UP),this._addKeyMapping(t.pan.down,Ts.DOWN),this._addKeyMapping(t.lookAround.headingLeft,Ts.HEADINGLEFT),this._addKeyMapping(t.lookAround.headingRight,Ts.HEADINGRIGHT),this._addKeyMapping(t.lookAround.tiltUp,Ts.TILTUP),this._addKeyMapping(t.lookAround.tiltDown,Ts.TILTDOWN),this._addKeyMapping(t.zoom.zoomIn,Ts.ZOOMIN),this._addKeyMapping(t.zoom.zoomOut,Ts.ZOOMOUT),this._addKeyAction(t.reset.heading,()=>this._resetHeading()),this._addKeyAction(t.reset.tilt,()=>this._resetTilt())}_addKeyMapping(t,i){for(let r of this._eachKey(t))this._keyToDirection.set(r,i)}*_eachKey(t){typeof t=="string"?yield t:yield*t}_addKeyAction(t,i){for(let r of this._eachKey(t))this._keyToAction.set(r,i)}_handleKeyDown(t){if(t.data.native.ctrlKey||t.data.native.metaKey)return;let i=this._keyToAction.get(t.data.key);if(i!=null)return t.stopPropagation(),void i();let r=this._keyToDirection.get(t.data.key);if(r!=null&&(this._cameraControllerKeyboard&&this._cameraControllerKeyboard.running||(this._cameraControllerKeyboard=new xc({view:this._view,disableMovements:this._disableMovements}),this._view.state.switchCameraController(this._cameraControllerKeyboard)),this._cameraControllerKeyboard.running)){if(t.stopPropagation(),this._cameraControllerKeyboard.directionActive(r)||(this._cameraControllerKeyboard.activateDirection(r),this._cameraControllerKeyboard.countActiveDirections()>1||!this._isPanning(r)))return;this._stickyKeyDuration>0&&(this._stickyKeyTimeoutHandle=setTimeout(()=>{this._stickyKeyTimeoutHandle=void 0,this._stickyDirection!=null&&this._stickyDirection!==void 0&&(this._cameraControllerKeyboard?.deactivateDirection(this._stickyDirection),this._stickyDirection=void 0)},this._stickyKeyDuration))}}_handleStop(){this._cameraControllerKeyboard?.running&&(this._cameraControllerKeyboard.finishController(),this._cameraControllerKeyboard=null)}_handleKeyUp(t){if(t.data.native.ctrlKey||t.data.native.metaKey||!this._cameraControllerKeyboard?.running)return;let i=this._keyToDirection.get(t.data.key);if(i==null)return;t.stopPropagation();let r=this._stickyKeyTimeoutHandle===void 0;this._stickyKeyTimeoutHandle===void 0||this._cameraControllerKeyboard?.countActiveDirections()!==1?(this._cameraControllerKeyboard?.deactivateDirection(i),r&&(this._stickyDirection=void 0)):this._stickyDirection=i}_isPanning(t){return t<=3}_resetHeading(){this._view.goTo({heading:0}).catch(()=>{})}_resetTilt(){this._view.goTo({tilt:0}).catch(()=>{})}};var UE=class extends rt{constructor(t,i){super(!0),this._view=t,this.registerIncoming("mouse-wheel",[i],r=>this._handleFov(r)),this.registerIncoming("mouse-wheel",r=>this._handleZoom(r))}_handleZoom(t){if(!this._mouseWheelZoomEnabled)return;let i=t.data;this._zoomController?.running||(this._stopFovController(),this._zoomController=this._view.state.isGlobal?new Ff({view:this._view,mode:"interaction"}):new kf({view:this._view,mode:"interaction"}),this._view.state.switchCameraController(this._zoomController)),this._zoomController.step(-i.deltaY/60,Kt(i.x,i.y)),t.preventDefault(),t.stopPropagation()}_handleFov(t){this._mouseWheelZoomEnabled&&(this._fovController?.running||(this._zoomController?.finish(),this._fovController?.hideOverlay(),this._fovController=new id({view:this._view,onStop:()=>this._stopFovController()}),this._view.state.switchCameraController(this._fovController),this._fovController.state!==Vt.Rejected)?(this._fovController.updateTimeout(),this._fovController.step(t.data.deltaY/20),t.preventDefault(),t.stopPropagation()):this._stopFovController())}get _mouseWheelZoomEnabled(){return this._view.navigation.actionMap.mouseWheel==="zoom"}_stopFovController(){this._fovController?.finish(),this._fovController=null}};var rd=class{constructor(t){this._gain=t}reset(t){this._value=t}set gain(t){this._gain=t}get value(){return this._value===void 0?0:this._value}update(t){this._value===void 0?this._value=t:this._value=this._gain*t+(1-this._gain)*this._value}};var Lo=class extends Ku{constructor(){super(...arguments),this._beginCamera=new Rt,this._elapsedTimeSec=0,this.constraintOptions=new xi(ut.ALL,Ne.PAN,0,this._beginCamera)}initialize(){this.constraintOptions.interactionType=this.interactionType,this.viewAnimation=new Cn}get steppingFinished(){return this.momentum.isFinished(this._elapsedTimeSec)}onControllerStart(e){this._beginCamera.copyFrom(e),super.onControllerStart(e)}stepController(e,t){t.copyViewFrom(this._beginCamera),this._elapsedTimeSec+=e,this.momentumStep(this._elapsedTimeSec,t),Pt(this.view,t,this.constraintOptions)}};Lo=u([C("esri.views.3d.state.controllers.momentum.MomentumController")],Lo);var Kh=class extends Lo{constructor(e){super(e),this.interactionType=Ne.PAN,this._tmpPan=w()}momentumStep(e,t){let i=this.momentum.value(e);X(this._tmpPan,this.momentum.direction,i),t.eye=ve(dq,t.eye,this._tmpPan),t.center=ve(dq,t.center,this._tmpPan),this.constraintOptions.interactionDirection=this._tmpPan}};u([d({constructOnly:!0})],Kh.prototype,"momentum",void 0),Kh=u([C("esri.views.3d.state.controllers.momentum.PanPlanarMomentumController")],Kh);var dq=w();var tee=w(),jE=w(),Vy=class extends Lo{constructor(e){super(e),this.interactionType=Ne.PAN}momentumStep(e,t){let i=this.momentum.value1(e),r=this.momentum.value2(e);ee(jE,t.eye),ne(jE,jE),At(this.momentum.axis2,jE,this.momentum.axis1),EP(t,tee,this.momentum.axis1,i,this.momentum.axis2,r)}};u([d({constructOnly:!0})],Vy.prototype,"momentum",void 0),Vy=u([C("esri.views.3d.state.controllers.momentum.PanSphericalMomentumController")],Vy);var Mc=class extends Lo{set center(e){this._set("center",mn(e))}set axis(e){this._set("axis",mn(e))}constructor(e){super(e),this.interactionType=Ne.TUMBLE}momentumStep(e,t){let i=this.momentum.value(e);Ws(t,this.center,Tc(this.axis,i))}};u([d({constructOnly:!0})],Mc.prototype,"momentum",void 0),u([d({constructOnly:!0})],Mc.prototype,"center",null),u([d({constructOnly:!0})],Mc.prototype,"axis",null),Mc=u([C("esri.views.3d.state.controllers.momentum.RotationMomentumController")],Mc);var nd=class extends Lo{set zoomCenter(e){this._set("zoomCenter",mn(e))}constructor(e){super(e),this.interactionType=Ne.ZOOM,this.constraintOptions.interactionDirection=w()}momentumStep(e,t){let{interactionDirection:i}=this.constraintOptions;if(!i)return;ee(i,t.eye);let r=this.momentum.valueDelta(0,e);Lf(t,this.zoomCenter,r,this.view.state.constraints.minimumPoiDistance),Pp(i,t.eye,i)}};u([d({constructOnly:!0})],nd.prototype,"momentum",void 0),u([d({constructOnly:!0})],nd.prototype,"zoomCenter",null),nd=u([C("esri.views.3d.state.controllers.momentum.ZoomPlanarMomentumController")],nd);var sd=class extends Lo{set screenCenter(e){this._set("screenCenter",Kt(e[0],e[1]))}set sceneCenter(e){this._set("sceneCenter",mn(e))}constructor(e){super(e),this.interactionType=Ne.ZOOM,this.radius=0,this._tmpSceneCenter=w(),this._tmpZoomAxisAngle=jh(),this._sphere=cr()}initialize(){this._sphere[3]=this.radius}momentumStep(e,t){let i=this.momentum.valueDelta(0,e);mE(this._sphere,t,i),this.constraintOptions.interactionType=Ne.ZOOM,Pt(this.view,t,this.constraintOptions),ed(this._sphere,t,this.screenCenter,this._tmpSceneCenter),Af(this.sceneCenter,this._tmpSceneCenter,this._tmpZoomAxisAngle),Ws(t,this._sphere,this._tmpZoomAxisAngle),this.constraintOptions.interactionType=Ne.PAN}};u([d({constructOnly:!0})],sd.prototype,"momentum",void 0),u([d({constructOnly:!0})],sd.prototype,"screenCenter",null),u([d({constructOnly:!0})],sd.prototype,"sceneCenter",null),u([d({constructOnly:!0})],sd.prototype,"radius",void 0),sd=u([C("esri.views.3d.state.controllers.momentum.ZoomSphericalMomentumController")],sd);var Hy=class{constructor(t){this._gain=t}update(t){this.filteredValue!==void 0?this.filteredValue=(1-this._gain)*this.filteredValue+this._gain*t:this.filteredValue=t}reset(){this.filteredValue=void 0}get hasFilteredValue(){return this.filteredValue!==void 0}};var hq=1e-5,zP=class extends cV{constructor(t,i,r,n,s,o=0,a){super(t,i,r),this._angularVelocity1=n,this.axis1=s,this.angularVelocity2=o,this.axis2=a}value1(t){return super.valueFromInitialVelocity(this._angularVelocity1,t)}value2(t){return super.valueFromInitialVelocity(this.angularVelocity2,t)}},zE=class{constructor(t=300,i=12,r=.84){this._minimumInitialVelocity=t,this._stopVelocity=i,this._friction=r,this.enabled=!0,this._tmpAxis1=w(),this._tmpAxis2=w(),this._tmpAngles=Hi(),this._time=new dw(.3),this._screen=[new dw(.4),new dw(.4)],this._angle1=new Hy(.6),this._angle2=new Hy(.6),this._axis1=w(),this._axis2=w(),this._lastScene=w()}addMomentumDirectRotation(t,i,r,n,s,o){if(this.enabled){if(this._time.hasLastValue()){if(this._time.computeDelta(r)<.01)return;let a=CP(this._lastScene,i,this._tmpAxis2,n,s,o);this._angle2.update(0),Ir(this._tmpAxis2)<hq?a=0:ne(this._axis1,this._tmpAxis2),this._angle1.update(a),ee(this._lastScene,i)}this._screen[0].update(t[0]),this._screen[1].update(t[1]),this._time.update(r)}}addMomentumPreserveHeading(t,i,r,n,s,o,a){if(this.enabled){if(this._time.hasLastValue()){if(this._time.computeDelta(r)<.01)return;TP(this._lastScene,i,this._tmpAxis2,this._tmpAxis1,this._tmpAngles,n,s,o,a,!1),Ir(this._tmpAxis2)<hq?(this._angle1.update(0),this._angle2.update(0)):(this._angle1.update(this._tmpAngles[1]),this._angle2.update(this._tmpAngles[0]),ne(this._axis1,this._tmpAxis1),ne(this._axis2,this._tmpAxis2)),ee(this._lastScene,i)}this._screen[0].update(t[0]),this._screen[1].update(t[1]),this._time.update(r)}}reset(){this._screen[0].reset(),this._screen[1].reset(),this._angle1.reset(),this._angle2.reset(),this._time.reset()}evaluateMomentum(){if(!this.enabled||!this._screen[0].hasFilteredDelta())return null;let t=this._screen[0].filteredDelta,i=this._screen[1].filteredDelta,r=t==null||i==null?null:Math.sqrt(t*t+i*i),n=this._time.filteredDelta,s=r==null||n==null?0:r/n;return Math.abs(s)<this._minimumInitialVelocity?null:this.createMomentum(s,this._stopVelocity,this._friction)}createMomentum(t,i,r){let n=this._time.filteredDelta,s=this._angle1.filteredValue,o=this._angle2.filteredValue,a=n==null||o==null?0:o/n;return new zP(t,i,r,n==null||s==null?0:s/n,this._axis1,a,this._axis2)}};var GE=class extends Kr{constructor(){super(...arguments),this._smoothRotation=new rd(.05),this._rotationAxis=w(),this._beginAngle=0,this._beginHeading=0,this._panningPlane=Gl(),this._beginRadius=0,this._smoothScaling=new rd(.05),this._zoomCenterScreen=Kt(),this._zoomMomentumEstimator=new mw,this._rotationMomentumEstimator=new pw,this._panSphericalMomentumEstimator=new zE,this._panPlanarMomentumEstimator=new hw,this._adjustedSphere=cr(),this._tmp3d=w(),this._tmpScreenPointArray=Kt(),this._beginScreenPoint=Kt(),this._beginScenePoint=w(),this._screenPickPoint=Kt(),this._scenePickPoint=w(),this._navMode=Ji.Horizontal,this._sphere=cr(),this._pointerCount=0,this._tmpInteractionDirection=w(),this._beginCamera=new Rt,this._constraintOptions=new xi(ut.ALL,Ne.NONE,0,this._beginCamera)}get _intersectionHelper(){return this.view.sceneIntersectionHelper}begin(e){if(!this.running)return;this._zoomMomentumEstimator.enabled=this._rotationMomentumEstimator.enabled=this._panPlanarMomentumEstimator.enabled=this._panSphericalMomentumEstimator.enabled=this.view.navigation.momentumEnabled,this._beginHeading=-oa.normalize(kt(this.view.camera.heading)),this._beginRadius=e.radius,this._pointerCount=e.pointers.size,this._beginAngle=e.angle,this._smoothRotation.reset(),Xo(e.center,this._screenPickPoint),Yi(this._beginScreenPoint,this._screenPickPoint);let t=_t(this.view.spatialReference),i=gE(this._intersectionHelper,this.startCamera,this._screenPickPoint,t,Ju.Silhouette,this.view.map.ground.opacity===0?Cs:{});i.scenePickPoint!=null&&(this._scenePickPoint=i.scenePickPoint,this._sphere=i.sphere,ee(this._beginScenePoint,this._scenePickPoint),this._navMode=gl(this.startCamera,this._screenPickPoint,this.view.renderCoordsHelper,this.view.viewingMode),this._navMode===Ji.Vertical&&this._preparePlanarPanMode(e,i.hasGeometryIntersection),this._beginCamera.copyFrom(this.startCamera))}update(e){if(!this.running)return;this.currentCamera.copyFrom(this.startCamera);let t=e.pointers.size>1;this._navMode===Ji.Horizontal?(t&&this._zoomSpherical(e),this._panningSpherical(e),t&&this._rotateSpherical(e)):(t&&this._zoomPlanar(e),this._panningPlanar(e),t&&this._rotatePlanar(e)),this.commitCamera()}end(e){e.pointers.size===this._pointerCount&&this.update(e),this.finishController();let t=this._zoomMomentumEstimator.evaluateMomentum();if(t)return this._navMode===Ji.Horizontal?new sd({view:this.view,momentum:t,screenCenter:this._zoomCenterScreen,sceneCenter:this._beginScenePoint,radius:this._sphere[3]}):new nd({view:this.view,momentum:t,zoomCenter:this._beginScenePoint});let i=this._rotationMomentumEstimator.evaluateMomentum();if(i)return new Mc({view:this.view,momentum:i,center:this._sphere,axis:this._rotationAxis});if(this._navMode===Ji.Horizontal){let r=this._panSphericalMomentumEstimator.evaluateMomentum();if(r)return new Vy({view:this.view,momentum:r})}else{let r=this._panPlanarMomentumEstimator.evaluateMomentum();if(r)return new Kh({view:this.view,momentum:r})}return null}_preparePlanarPanMode(e,t){let i=Rs(this._tmp3d,this.startCamera.viewForward);U0(this._scenePickPoint,i,this._panningPlane);let r=Kt(this._screenPickPoint[0],0),n=w(),s=xe(this.startCamera.eye);this._adjustedSphere[3]=s<this._sphere[3]?s-100:this._sphere[3],ed(this._adjustedSphere,this.startCamera,r,n);let o=bd();this.startCamera.projectToRenderScreen(n,o);let a=w(),l=w(),c=w();ve(a,this._scenePickPoint,this.currentCamera.eye);let h=xe(a);ne(a,a);let p=dE*Math.max(Math.abs(this.view.camera.position.z),hE),m=this.view._stage.renderView.getMinimalDepthForArea(null,this._screenPickPoint[0],this._screenPickPoint[1],this.view.state.camera,ml),f=m??p;f=t?Math.min(f,h):f,ee(c,he(l,this.currentCamera.eye,X(l,a,f))),this._panningPlane[3]=-ae(this._panningPlane,c),this.startCamera.center=he(l,this.startCamera.eye,X(l,this.startCamera.viewForward,f));let g=Xo(e.center,this._tmpScreenPointArray);Oy(this._panningPlane,this.startCamera,g,this._beginScenePoint)}_zoomSpherical(e){let t=this._beginRadius/e.radius,i=.001875*Math.min(Math.max(e.radius,40),120);this._smoothScaling.gain=i,this._smoothScaling.update(t),mE(this._sphere,this.currentCamera,this._smoothScaling.value),Xo(e.center,this._zoomCenterScreen),this._zoomMomentumEstimator.add(this._smoothScaling.value,.001*e.timestamp),this._constraintOptions.interactionType=Ne.ZOOM,this._constraintOptions.interactionFactor=ln(e.radius-this._beginRadius),Pt(this.view,this.currentCamera,this._constraintOptions)}_panningSpherical(e){let t=Xo(e.center,this._tmpScreenPointArray);ed(this._sphere,this.currentCamera,t,this._tmp3d),yE(this._beginScenePoint,ae(this.currentCamera.up,this._beginScenePoint),this._sphere[3],this._beginHeading,this.view.camera.tilt,this.startCamera.aboveGround)?(xP(this._sphere,this.currentCamera,this._beginScenePoint,this._tmp3d,this._beginHeading,this.view.camera.tilt,!1),this._panSphericalMomentumEstimator.addMomentumPreserveHeading(t,this._tmp3d,.001*e.timestamp,this.startCamera,this._sphere,this._beginHeading,this.view.camera.tilt)):(DP(this._sphere,this.currentCamera,this._beginScenePoint,this._tmp3d,this.view.camera.tilt,!1),this._panSphericalMomentumEstimator.addMomentumDirectRotation(t,this._tmp3d,.001*e.timestamp,this.startCamera,this._sphere[3],this.view.camera.tilt)),this._constraintOptions.interactionType=Ne.PAN,this._constraintOptions.interactionFactor=ln(ea(this._screenPickPoint,t)),Pt(this.view,this.currentCamera,this._constraintOptions)}_rotateSpherical(e){ne(this._rotationAxis,this._scenePickPoint),this.currentCamera.aboveGround||Rs(this._rotationAxis,this._rotationAxis);let t=this._smoothRotation.value,i=t+Py(e.angle-t),r=.00125*Math.min(Math.max(e.radius,40),120);this._smoothRotation.gain=r,this._smoothRotation.update(i);let n=this._smoothRotation.value-this._beginAngle;this._rotationMomentumEstimator.add(n,.001*e.timestamp),Ws(this.currentCamera,this._sphere,Tc(this._rotationAxis,n)),this._constraintOptions.interactionType=Ne.TUMBLE,this._constraintOptions.interactionFactor=ln(e.radius*i),Pt(this.view,this.currentCamera,this._constraintOptions)}_panningPlanar(e){let t=Xo(e.center,this._tmpScreenPointArray);Oy(this._panningPlane,this.currentCamera,t,this._tmp3d)&&(_E(this.currentCamera,this._beginScenePoint,this._tmp3d),this._panPlanarMomentumEstimator.add(t,this._tmp3d,.001*e.timestamp),this._constraintOptions.interactionType=Ne.PAN,this._constraintOptions.interactionFactor=ln(ea(this._beginScreenPoint,t)),this._constraintOptions.interactionDirection=this.view.renderCoordsHelper.worldUpAtPosition(this.currentCamera.eye,this._tmpInteractionDirection),Pt(this.view,this.currentCamera,this._constraintOptions),this._constraintOptions.interactionDirection=null)}_zoomPlanar(e){let t=this._beginRadius/e.radius,i=.001875*Math.min(Math.max(e.radius,40),120);this._smoothScaling.gain=i,this._smoothScaling.update(t),this._zoomMomentumEstimator.add(this._smoothScaling.value,.001*e.timestamp),Lf(this.currentCamera,this._beginScenePoint,this._smoothScaling.value,this.view.state.constraints.minimumPoiDistance),this._constraintOptions.interactionType=Ne.ZOOM,this._constraintOptions.interactionFactor=ln(e.radius-this._beginRadius),Pt(this.view,this.currentCamera,this._constraintOptions)}_rotatePlanar(e){ee(this._rotationAxis,this._beginScenePoint),this.currentCamera.aboveGround||Rs(this._rotationAxis,this._rotationAxis);let t=this._smoothRotation.value,i=e.angle-t;i=Py(i);let r=t+i,n=.00125*Math.min(Math.max(e.radius,40),120);this._smoothRotation.gain=n,this._smoothRotation.update(r);let s=this._smoothRotation.value-this._beginAngle;this._rotationMomentumEstimator.add(s,.001*e.timestamp),Ws(this.currentCamera,this._sphere,Tc(this._rotationAxis,s)),this._constraintOptions.interactionType=Ne.TUMBLE,this._constraintOptions.interactionFactor=ln(e.radius*s),Pt(this.view,this.currentCamera,this._constraintOptions)}};GE=u([C("esri.views.3d.state.controllers.PinchAndPanControllerGlobal")],GE);var pq=yt(0,0,1),qE=class extends Kr{constructor(){super(...arguments),this._rotationValueSmooth=new rd(.05),this._scalingValueSmooth=new rd(.05),this._planeHorizontal=Gl(),this._planeVertical=Gl(),this._rotationMomentumEstimator=new pw,this._panMomentumEstimator=new hw(300,12,.9),this._zoomMomentumEstimator=new mw,this._beginRadius=0,this._beginCenter=w(),this._beginAngle=0,this._tmpPoints=[],this._navMode=Ji.Horizontal,this._beginCenterScreen=Kt(),this._tmpCentroid3d=w(),this._tmpCentroid2d=Kt(),this._tmp2d=Kt(),this._pointerCount=0,this._beginCamera=new Rt,this._constraintOptions=new xi(ut.ALL,Ne.NONE,0,this._beginCamera)}begin(e){if(!this.running)return;let t=this.view.navigation.momentumEnabled;this._zoomMomentumEstimator.enabled=t,this._rotationMomentumEstimator.enabled=t,this._panMomentumEstimator.enabled=t,this._beginRadius=e.radius,this._pointerCount=e.pointers.size,this._beginAngle=e.angle,this._rotationValueSmooth.reset(),this._scalingValueSmooth.reset(),Xo(e.center,this._beginCenterScreen),B0(pq,0,this._planeHorizontal);let i=w(),r=this._intersectionHelper.intersectScreenFreePointFallback(this._beginCenterScreen,i,this.view.map.ground.opacity===0?Cs:{}),n=w();Rs(n,this.startCamera.viewForward);let s=w();ee(s,pq);let o=ae(n,s);this._navMode=gl(this.startCamera,this._beginCenterScreen,this.view.renderCoordsHelper,this.view.viewingMode);let a=Math.min(dE,1/Math.abs(ae(s,this.startCamera.viewForward)))*Math.max(Math.abs(this.view.camera.position.z),hE);Zx(this._planeHorizontal,this._planeHorizontal,i),this.startCamera.aboveGround||lF(this._planeHorizontal,this._planeHorizontal);let l=w(),c=w(),h=w();ve(l,i,this.currentCamera.eye);let p=xe(l);if(ne(l,l),this._navMode===Ji.Vertical){X(s,s,o),ve(this._planeVertical,n,s),ne(this._planeVertical,this._planeVertical),Zx(this._planeVertical,this._planeVertical,i);let m=this.view._stage.renderView.getMinimalDepthForArea(Yl(this.view),this._beginCenterScreen[0],this._beginCenterScreen[1],this.view.state.camera,ml),f=m??a;f=r?Math.min(f,p):f,ee(h,he(c,this.currentCamera.eye,X(c,l,f))),this._planeVertical[3]=-ae(this._planeVertical,h),this._computePlanePoints(e.pointers,this._planeVertical,this.startCamera,this._tmpPoints),fE(this._tmpPoints,this._beginCenter)}else{let m=r?p:a;ee(h,he(c,this.currentCamera.eye,X(c,l,m))),this._planeHorizontal[3]=-ae(this._planeHorizontal,h),this._computePlanePoints(e.pointers,this._planeHorizontal,this.startCamera,this._tmpPoints),fE(this._tmpPoints,this._beginCenter)}this._beginCamera.copyFrom(this.startCamera)}update(e){if(!this.running)return;this.currentCamera.copyFrom(this.startCamera);let t=e.pointers.size>1,i=this._navMode===Ji.Horizontal?this._planeHorizontal:this._planeVertical,r=this._beginCenter;if(t){let n=this._beginRadius/e.radius,s=.001875*Math.min(Math.max(e.radius,40),120);this._scalingValueSmooth.gain=s,this._scalingValueSmooth.update(n),Lf(this.currentCamera,r,this._scalingValueSmooth.value,this.view.state.constraints.minimumPoiDistance),this._zoomMomentumEstimator.add(this._scalingValueSmooth.value,.001*e.timestamp),this._constraintOptions.interactionType=Ne.ZOOM,this._constraintOptions.interactionFactor=ln(Math.abs(e.radius-this._beginRadius)),Pt(this.view,this.currentCamera,this._constraintOptions)}if(this._computePlanePoints(e.pointers,i,this.currentCamera,this._tmpPoints),fE(this._tmpPoints,this._tmpCentroid3d),Xo(e.center,this._tmpCentroid2d),_E(this.currentCamera,r,this._tmpCentroid3d),this._panMomentumEstimator.add(this._tmpCentroid2d,this._tmpCentroid3d,.001*e.timestamp),this._constraintOptions.interactionType=Ne.PAN,this._constraintOptions.interactionFactor=ln(ea(this._beginCenterScreen,this._tmpCentroid2d)),Pt(this.view,this.currentCamera,this._constraintOptions),t){let n=r,s=this._rotationValueSmooth.value,o=s+Py(e.angle-s),a=.00125*Math.min(Math.max(e.radius,40),120);this._rotationValueSmooth.gain=a,this._rotationValueSmooth.update(o);let l=this._rotationValueSmooth.value-this._beginAngle;this._rotationMomentumEstimator.add(l,.001*e.timestamp);let c=this._planeHorizontal;Ws(this.currentCamera,n,Tc(c,l)),this._constraintOptions.interactionType=Ne.TUMBLE,this._constraintOptions.interactionFactor=ln(Math.abs(e.radius*l)),Pt(this.view,this.currentCamera,this._constraintOptions)}this.commitCamera()}end(e){e.pointers.size===this._pointerCount&&this.update(e),this.finishController();let t=this._zoomMomentumEstimator.evaluateMomentum();if(t)return new nd({view:this.view,momentum:t,zoomCenter:this._beginCenter});let i=this._rotationMomentumEstimator.evaluateMomentum();if(i)return new Mc({view:this.view,momentum:i,center:this._beginCenter,axis:this._planeHorizontal});let r=this._panMomentumEstimator.evaluateMomentum();return r?new Kh({view:this.view,momentum:r}):null}_computePlanePoints(e,t,i,r){r.length=e.size;let n=this._tmp2d,s=0;return e.forEach(o=>{n[0]=o.x,n[1]=o.y,r[s]===void 0&&(r[s]=w()),Oy(t,i,n,r[s]),s+=1}),r}get _intersectionHelper(){return this.view.sceneIntersectionHelper}};qE=u([C("esri.views.3d.state.controllers.PinchAndPanControllerLocal")],qE);var By=class extends rt{constructor(t,i,r){super(!0),this._view=t,this.pointerActions=i,this._lastEndTimestamp=0,this._lastTimestamp=0,this.registerIncoming("drag",r,n=>this._handleDrag(n))}_handleDrag(t){if(t.data.pointerType==="mouse"&&!af(t.data,this.pointerActions))return;let i=t.timestamp-this._lastEndTimestamp,r=40,n=this._momentum&&this._momentum.running&&i<r;switch(t.data.action){case"start":case"update":if(n)break;this._controller&&this._controller.running?t.data.timestamp-this._lastTimestamp>2&&(this._controller.update(t.data),this._lastTimestamp=t.timestamp):this._startController(t);break;case"end":case"removed":this._endController(t,!0);break;case"added":this._endController(t,!1),this._startController(t)}t.stopPropagation()}_endController(t,i){if(this._controller?.running){this._lastEndTimestamp=t.timestamp;let r=this._controller.end(t.data);i&&r&&(this._momentum=r,this._view.state.switchCameraController(this._momentum))}this._controller=null}_startController(t){this._controller=this._createController(),this._view.state.switchCameraController(this._controller),this._controller.begin(t.data),this._lastTimestamp=t.timestamp}_createController(){return this._view.state.isGlobal?new GE({view:this._view}):new qE({view:this._view})}};var WE=class extends rt{constructor(t,i){super(!0),this.view=t,this.registerIncoming("pointer-down",i,()=>this.view.state.stopActiveCameraController())}};var $E=class extends rt{constructor(t,i=!1){super(!0),this._view=t,this._invert=i,this.registerIncoming("vertical-two-finger-drag",r=>this._handleTwoFinger(r))}_handleTwoFinger(t){let i=this._invert?-1:1,r=Kt(0,t.data.delta*i);switch(t.data.action){case"begin":this._cameraController?.end(),this._cameraController=new Zh({view:this._view,pivot:cn.CENTER}),this._view.state.switchCameraController(this._cameraController),this._cameraController.begin(r);break;case"update":this._cameraController?.update(r);break;case"end":this._cameraController?.end(),this._cameraController=null}}};var ZE=class extends rt{constructor(t=20,i=40){super(!1),this._threshold=t,this._maxDelta=i,this._state="ready",this._emittedArtificalEnd2=!1,this._vertical=this.registerOutgoing("vertical-two-finger-drag"),this._artificalDrag=this.registerOutgoing("drag"),this._dragEventSeparator=new Io({start:(r,n)=>this._observeStart(r,n),update:(r,n,s)=>this._observeUpdate(r,n,s),end:(r,n)=>this._observeEnd(n)}),this.registerIncoming("drag",r=>this._dragEventSeparator.handle(r))}get failed(){return this._state==="failed"}_observeStart(t,i){t===1&&this._emittedArtificalEnd2&&(this._emittedArtificalEnd2=!1,this._artificalDrag.emit({action:"start",button:i.data.button,buttons:i.data.buttons,pointerType:i.data.pointerType,timestamp:i.data.timestamp,pointers:i.data.pointers,pointer:i.data.pointer,angle:i.data.angle,radius:i.data.radius,center:i.data.center}),i.stopPropagation()),this._state=t===2?"ready":"failed"}_observeUpdate(t,i,r){if(this._state!=="failed"&&t===2)return this._state==="active"?(this._vertical.emit({delta:i.data.center.y-this._thresholdReachedCenter.y,action:"update"}),void i.stopPropagation()):void(this._checkMovementWithinLimits(i.data,r.data)?this._checkVerticalThresholdReached(i.data,r.data)&&(this._state="active",this._emittedArtificalEnd2=!0,this._thresholdReachedCenter=i.data.center,this._artificalDrag.emit({action:"end",button:i.data.button,buttons:i.data.buttons,pointerType:i.data.pointerType,timestamp:i.data.timestamp,pointers:i.data.pointers,pointer:i.data.pointer,angle:i.data.angle,radius:i.data.radius,center:i.data.center}),this._vertical.emit({delta:i.data.center.y-this._thresholdReachedCenter.y,action:"begin"}),i.stopPropagation()):this._state="failed")}_observeEnd(t){this._state==="active"&&(this._vertical.emit({delta:t.data.center.y-this._thresholdReachedCenter.y,action:"end"}),this._state="ready",t.stopPropagation())}_checkMovementWithinLimits(t,i){let r=-1/0,n=1/0,s=-1/0,o=1/0;for(let{x:_,y:v}of i.pointers.values())r=Math.max(r,_),n=Math.min(n,_),s=Math.max(s,v),o=Math.min(o,v);let a=-1/0,l=1/0,c=-1/0,h=1/0;for(let{x:_,y:v}of t.pointers.values())a=Math.max(a,_),l=Math.min(l,_),c=Math.max(c,v),h=Math.min(h,v);let p=r-n,m=s-o,f=a-l,g=c-h;return Math.abs(t.center.x-i.center.x)<this._threshold&&Math.abs(f-p)<=this._maxDelta&&Math.abs(g-m)<=this._maxDelta}_checkVerticalThresholdReached(t,i){let r=Math.abs(t.center.y-i.center.y);return t.pointers.forEach((n,s)=>{let o=i.pointers.get(s);r=Math.min(r,Math.abs(n.y-o.y))}),r>=this._threshold}};var yl=class extends P{constructor(){super(...arguments),this.mode="default",this._updateMode=({mode:e,dragPrimary:t,dragSecondary:i,dragTertiary:r})=>{e==="pro"&&(i="zoom",r=t==="pan"?"rotate":"pan");let n={dragPrimary:t,dragSecondary:i,dragTertiary:r};this._modeDragPan&&(this._modeDragPan.pointerActions=Th("pan",n)),this._modeDragRotate&&(this._modeDragRotate.pointerActions=Th("rotate",n)),this._modeDragZoom&&(this._modeDragZoom.pointerActions=Th("zoom",n))}}destroy(){this.disconnect()}get primaryDragAction(){return this.view.navigation.actionMap.dragPrimary}set primaryDragAction(e){let{actionMap:t}=this.view.navigation;t.dragPrimary=e,t.dragSecondary=e==="pan"?"rotate":"pan"}get updating(){return!!this._inputManager?.updating}get latestPointerType(){return this._inputManager?.latestPointerType}get latestPointerLocation(){return this._inputManager?.latestPointerLocation}get multiTouchActive(){return this._inputManager?.multiTouchActive??!1}disconnect(){this.removeAllHandles(),this.view.viewEvents.disconnect(),this._modeDragPan=null,this._modeDragRotate=null,this._modeDragZoom=null,this._modeKeyboardNavigation=null,this._inputManager=G(this._inputManager),this._source=G(this._source)}connect(){let e=this.view;this._source=new nT(this.view.surface,e.input);let t=[new mf,new ff,new gf,new pf(this.view.navigation),new ZE],i=new rw({eventSource:this._source,recognizers:t});this._inputManager=i,i.installHandlers("prevent-context-menu",[new hf],qa.INTERNAL);let r={fov:"Shift",pan:{left:"ArrowLeft",right:"ArrowRight",forward:"ArrowUp",backward:"ArrowDown",up:["u","U"],down:["j","J"]},lookAround:{headingLeft:["a","A"],headingRight:["d","D"],tiltUp:["w","W"],tiltDown:["s","S"],modifier:"b"},zoom:{zoomIn:["+","="],zoomOut:["-","_"]},reset:{heading:["n","N"],tilt:["p","P"]}};this._modeDragPan=new By(e,["primary"]),this._modeDragRotate=new Bf(e,["secondary"],cn.CENTER),this._modeDragZoom=new VE(e,["tertiary"],r.fov),this._modeKeyboardNavigation=new BE(e,r),i.installHandlers("navigation",[new WE(e),new CE(e),new HE(e),new UE(e,r.fov),new Bf(e,["primary"],cn.EYE,[r.lookAround.modifier]),new Bf(e,["secondary"],cn.CENTER,[r.lookAround.modifier]),new By(e,["tertiary"],[r.lookAround.modifier]),this._modeDragRotate,this._modeDragZoom,this._modeDragPan,this._modeKeyboardNavigation,new $E(e)],qa.INTERNAL),this.view.viewEvents.connect(i),this.addHandles([S(()=>this.view.navigation?.browserTouchPanEnabled,n=>{this._source.browserTouchPanningEnabled=!n},Re),S(()=>{let{actionMap:n}=this.view.navigation,{dragPrimary:s,dragSecondary:o,dragTertiary:a}=n;return{mode:this.mode,dragPrimary:s,dragSecondary:o,dragTertiary:a}},this._updateMode,Ce)])}isModifierKeyDown(e){return this._inputManager?.isModifierKeyDown(e)??!1}get test(){}};u([d()],yl.prototype,"view",void 0),u([d({type:["default","pro"]})],yl.prototype,"mode",void 0),u([d({readOnly:!0})],yl.prototype,"updating",null),u([d()],yl.prototype,"latestPointerType",null),u([d()],yl.prototype,"latestPointerLocation",null),u([d()],yl.prototype,"multiTouchActive",null),u([d()],yl.prototype,"_inputManager",void 0),yl=u([C("esri.views.3d.input.SceneInputManager")],yl);var mq=yl;var Zs,Uf,GP=!1,qP=!1,WP=!1,$P=!1,Uy=null;function fq(e,t){if(!qP||!Uf)return;_q();let i=Uf,r=0;for(let n=0;n<e.accBinsNumX;n++)for(let s=0;s<e.accBinsNumY;s++){let o=e.accBins[n][e.accBinsNumY-1-s];r+=o.length;let a=n*e.accBinsSizeX,l=(n+1)*e.accBinsSizeX,c=s*e.accBinsSizeY,h=(s+1)*e.accBinsSizeY;i.fillText(o.length.toFixed(),a+5,c+15),yq(a,l,c,h,"blue")}i.fillText("total totalShownLabels: "+r,70,40),i.fillText("total visible labels: "+t.size,70,50),i.fillText("total numTests: "+e.accNumTests,70,30)}function gq(e){WP=ur.DECONFLICTOR_SHOW_VISIBLE,$P=ur.DECONFLICTOR_SHOW_INVISIBLE,GP=WP||$P,qP=ur.DECONFLICTOR_SHOW_GRID,Uy=null,GP||qP?Uy=()=>ree(e):Zs&&(Zs.parentElement.removeChild(Zs),Zs=null)}function _q(){Uy&&(Uy(),Uy=null)}function ree(e){Zs==null&&(Zs=document.createElement("canvas"),Zs.setAttribute("id","debugCanvas2d"),e.surface.parentElement.style.position="relative",e.surface.parentElement.appendChild(Zs));let{state:t}=e,{camera:i,pixelRatio:r}=t,{width:n,height:s}=i,o=n*r,a=s*r;Zs.setAttribute("width",`${o}px`),Zs.setAttribute("height",`${a}px`),Zs.setAttribute("style",`position:absolute;left:0px;top:0px;display:block;pointer-events:none;width:${n}px;height:${s}px`),Uf=Zs.getContext("2d"),Uf.clearRect(0,0,n,s),Uf.font="12px Arial"}function yq(e,t,i,r,n){_q();let s=Zs.height,o=Uf;o.beginPath(),o.lineWidth=1,o.strokeStyle=n,o.moveTo(e,s-i),o.lineTo(t,s-i),o.stroke(),o.lineTo(t,s-r),o.stroke(),o.lineTo(t,s-i),o.stroke(),o.lineTo(e,s-i),o.stroke(),o.lineTo(e,s-i),o.stroke(),o.closePath()}function vq(e,t){GP&&(t&&WP||!t&&$P)&&yq(e.aabr[0],e.aabr[2],e.aabr[1],e.aabr[3],t?"green":"red")}var vl=w(),QE=w(),jf=Qi(),jy=Qi(),ZP=w(),wq=Wt(),nee=cr(),QP=Os(),see=w(),oee=Yt(),YP=class{constructor(){this.aabr=Yt(),this.distance=0,this.distanceToTerrain=0,this.culled=!1,this.visible=!1}},YE=class{constructor(t,i){this.graphics3DGraphic=t,this.slicePlaneEnabled=i,this.info={}}},qn;(function(e){e[e.Idle=0]="Idle",e[e.Process=1]="Process",e[e.Sort=2]="Sort",e[e.Deconflict=3]="Deconflict",e[e.NumStates=4]="NumStates"})(qn||(qn={}));var KP=class{constructor(){this.camera=new Rt,this.slicePlane=Wg(),this.slicePlaneEnabled=!1}copyFrom(t){this.camera.copyFrom(t.camera),Gp(t.slicePlane,this.slicePlane),this.slicePlaneEnabled=t.slicePlaneEnabled}},Sc=class extends P{get dirty(){return this._dirty}get state(){return this._state}constructor(e){super(e),this._dirty=!1,this._viewState=new KP,this._state=qn.Idle,this._active=new Map,this._visible=new Map,this._iterators=new JP,this._accBinsNumX=15,this._accBinsNumY=20,this._accBinsSizeX=0,this._accBinsSizeY=0,this._accBins=null,this.accNumTests=0,this._updatingHandles=new mo}destroy(){this._updatingHandles.destroy(),this._active.clear(),this._visible.clear(),this._iterators=null}setDirty(){!this._dirty&&this._active.size>0&&(this._dirty=!0,this.notifyChange("updating"))}get updating(){return this._state!==qn.Idle||this._dirty||this._updatingHandles.updating}get updatingProgress(){if(!this.updating)return 1;let e=this._state/qn.NumStates;return this._dirty?.5*e:e}get running(){return this.view.ready&&this.view.state!=null&&this.updating}runTask(e){switch(this._state){case qn.Idle:this._startUpdate(),e.madeProgress();case qn.Process:if(this._state=qn.Process,!this._processActiveGraphics(e))return;case qn.Sort:if(this._state=qn.Sort,!this._sortVisibleGraphics(e))return;case qn.Deconflict:if(this._state=qn.Deconflict,!this._deconflictVisibleGraphics(e))return;default:fq(this,this._visible),this._state=qn.Idle,this.notifyChange("updating")}}modifyGraphics(e,t){t?e.forEach(i=>this.addToActiveGraphics(i)):e.forEach(i=>this.removeFromActiveGraphics(i)),this.setDirty()}layerSupportsDeconfliction(e){if(e==null||e.type!=="object3d")return!1;let t=e.stageObject;return(t?.geometries.length??0)!==1?!1:t?.geometries[0]?.material instanceof J0}_startUpdate(){gq(this.view),this._dirty=!1,this._viewState.copyFrom(this.viewState);let{fullWidth:e,fullHeight:t}=this._viewState.camera;this._initBins(e,t),this._resetIterators()}addToActiveGraphics(e){e.info[this.visibilityGroup]=new YP,this._active.set(e.graphics3DGraphic.graphic.uid,e),this.setDirty()}removeFromActiveGraphics(e){this._visible.delete(e.graphics3DGraphic.graphic.uid),aee(e,this.visibilityGroup),delete e.info[this.visibilityGroup],this._active.delete(e.graphics3DGraphic.graphic.uid),this.setDirty()}_createTerrainIntersector(){let e=nn(this.view.state.viewingMode);e.options.store=fo.MIN;let t=this.view.basemapTerrain,i=this.view.state.camera;return q2(wq,this._viewState.camera.viewInverseTransposeMatrix),r=>{si(QE,r,wq),e.reset(i.eye,QE,i),t.intersect(e,null,i.eye,QE);let n=e.results.ground.dist;return n!=null?n*ui(QE,i.eye):0}}_processActiveGraphics(e){let t=this._ensureActiveGraphicsIterator(),i=this._viewState.camera.inverseProjectionMatrix,r=this.view.viewingMode==="global"&&this.view.map.ground.opacity===1&&this._viewState.camera.relativeElevation>0,n=Ct("enable-feature:non-occluded-hud")&&this.view.map.ground.opacity>0?this._createTerrainIntersector():null,s=r?nee:null,o=0;for(s!=null&&(si(s,Jo,this._viewState.camera.viewMatrix),s[3]=_t(this.view.spatialReference).radius,o=yF(s,Jo));!e.done;){e.madeProgress();let a=t.next();if(a.done===!0)return this._resetActiveGraphicsIterator(),!0;let l=a.value,c=l?.info[this.visibilityGroup];c&&(this._collectGraphics3DGraphics(l,i,s,o,n),c.culled?(this._setGraphicVisibility(l,!1),this._visible.delete(l.graphics3DGraphic.graphic.uid)):this._visible.set(l.graphics3DGraphic.graphic.uid,l))}return!1}_sortVisibleGraphics(e){let t=this._ensureSortGraphicsIterator();for(;!e.done;){let i=t.next();if(e.madeProgress(),i.done===!0)return this._resetSortGraphicsIterator(),!0}return!1}_deconflictVisibleGraphics(e){let t=this._ensureVisibleGraphicsIterator(),i=this.visibilityGroup===Ya.LABEL;for(;!e.done;){e.madeProgress();let r=t.next();if(r.done===!0)return this._resetVisibleGraphicsIterator(),!0;let n=r.value,s=n.info[this.visibilityGroup];if(!s||s.culled){this._setGraphicVisibility(n,!1);continue}let o=n.graphics3DGraphic,a=!i||o.isVisible();s.visible=a&&!this._isConflicted(n),s.visible&&this._addToBins(n),this._setGraphicVisibility(n,s.visible),vq(s,s.visible)}return!1}_resetIterators(){this._iterators.active=null,this._iterators.visible=null,this._iterators.sort=null}_ensureActiveGraphicsIterator(){return this._iterators.active||(this._iterators.active=bq(this._active)),this._iterators.active}_resetActiveGraphicsIterator(){this._iterators.active=null}_ensureVisibleGraphicsIterator(){return this._iterators.visible||(this._iterators.visible=bq(this._visible)),this._iterators.visible}_resetVisibleGraphicsIterator(){this._iterators.visible=null}_ensureSortGraphicsIterator(){return this._iterators.sort||(this._iterators.sort=lee(this._visible,this._iterators.sortArray,this.visibilityGroup)),this._iterators.sort}_resetSortGraphicsIterator(){this._iterators.sort=null}_collectGraphics3DGraphics(e,t,i,r,n){let s=e.graphics3DGraphic;if(s.destroyed)return;let o=e.info[this.visibilityGroup];if(!s.isVisible(Ya.GRAPHIC,nu.DECONFLICTION))return void(o.culled=!0);let a=this.getGraphicsLayers(s);Yo(o.aabr);let l=null;for(let c of a){if(!this.layerSupportsDeconfliction(c))continue;let h=c.stageObject.geometries[0].material;if(l==null){if(l=dee,this._getProjectionInfo(c,t,l),l.isOutsideScreen||this._isCulledBySlice(e,vl)||i!=null&&uee(l,i,r))return void(o.culled=!0);l.distanceToTerrain=n?.(l.positionView)??0}this._expandBoundingRect(o,c,h,l)}l==null?o.culled=!0:(o.distance=l.distance,o.distanceToTerrain=l.distanceToTerrain,o.culled=!1)}_getProjectionInfo(e,t,i){let r=this._viewState.camera,n=e.stageObject,s=n.geometries[0],o=s.material,a=n.boundingVolumeWorldSpace.bounds;si(vl,a,r.viewMatrix);let l=s.attributes,c=l.get(yi.NORMAL).data,h=l.get(yi.CENTEROFFSETANDDISTANCE).data;o.applyShaderOffsetsView(vl,c,n.transformation,h,r,i.scaleInfo,vl),ho(jf,vl[0],vl[1],vl[2],1),kg(jy,jf,r.projectionMatrix),X(i.positionNDC,jy,1/jy[3]),o.applyShaderOffsetsNDC(i.positionNDC,h,r,i.positionNDC,ZP),i.distanceWithoutPolygonOffset=r.depthNDCToWorld(ZP[2]),i.distance=ZP[2]===i.positionNDC[2]?i.distanceWithoutPolygonOffset:r.depthNDCToWorld(i.positionNDC[2]),ho(jy,i.positionNDC[0],i.positionNDC[1],i.positionNDC[2],1),kg(jf,jy,t),w0(jf,jf,1/jf[3]),Te(i.positionView,vl[0],vl[1],vl[2])}_isCulledBySlice(e,t){return e.slicePlaneEnabled&&this._viewState.slicePlaneEnabled&&FF(this._viewState.slicePlane,t)}_expandBoundingRect(e,t,i,{positionNDC:r,scaleInfo:n}){let{fullWidth:s,fullHeight:o,pixelRatio:a}=this._viewState.camera,l=t.getScreenSize(cee);HF(l,n.factor,l),l[0]*=a,l[1]*=a;let c=g0(i.calculateRelativeScreenBounds(l,n.factorAlignment.scale*a,oee),Xe(0,s,.5+.5*r[0]),Xe(0,o,.5+.5*r[1])),h=this.marginFactor;if(h!==0){let p=h*Math.min(ao(c),Hl(c));c[0]-=p,c[1]-=p,c[2]+=p,c[3]+=p}ka(e.aabr,c,e.aabr)}_isConflicted(e){let t=e.graphics3DGraphic.graphic.uid,i=e.info[this.visibilityGroup],r=!0;for(let n=Math.floor(i.aabr[0]/this._accBinsSizeX);n<=Math.floor(i.aabr[2]/this._accBinsSizeX);n++)if(!(n<0||n>=this._accBinsNumX))for(let s=Math.floor(i.aabr[1]/this._accBinsSizeY);s<=Math.floor(i.aabr[3]/this._accBinsSizeY);s++){if(s<0||s>=this._accBinsNumY)continue;r=!1;let o=this._accBins[n][s];for(let a=0;a<o.length;a++){let l=o.data[a],c=l.info[this.visibilityGroup];if(c&&c.visible&&l.graphics3DGraphic.graphic.uid!==t&&(this.accNumTests++,Bl(c.aabr,i.aabr)))return!0}}return r}_initBins(e,t){if(this._accBins==null){this._accBins=[];for(let i=0;i<this._accBinsNumX;i++){this._accBins.push([]);let r=this._accBins[this._accBins.length-1];for(let n=0;n<this._accBinsNumY;n++)r.push(new Nt)}}else for(let i=0;i<this._accBinsNumX;i++)for(let r=0;r<this._accBinsNumY;r++)this._accBins[i][r].clear();this._accBinsSizeX=e/this._accBinsNumX,this._accBinsSizeY=t/this._accBinsNumY,this.accNumTests=0}_addToBins(e){let t=e.info[this.visibilityGroup],i=Math.floor(t.aabr[0]/this._accBinsSizeX),r=Math.floor(t.aabr[2]/this._accBinsSizeX),n=Math.floor(t.aabr[1]/this._accBinsSizeY),s=Math.floor(t.aabr[3]/this._accBinsSizeY);for(let o=i;o<=r;o++)if(!(o<0||o>=this._accBinsNumX))for(let a=n;a<=s;a++)a<0||a>=this._accBinsNumY||this._accBins[o][a].push(e)}_setGraphicVisibility(e,t){let i=e.graphics3DGraphic;i.destroyed||(i.setVisibilityFlag(this.visibilityGroup,nu.DECONFLICTION,t),this.visibilityGroup===Ya.LABEL&&this.view.labeler.setLabelGraphicVisibility(i,t))}};function aee(e,t){let i=e.graphics3DGraphic;i.destroyed||i.setVisibilityFlag(t,nu.DECONFLICTION,!0)}function*bq(e){if(Map.prototype.entries){let t=e.entries();for(let i=t.next();!i.done;i=t.next())yield i.value[1]}else yield*e.values()}function*lee(e,t,i){t.clear(),e.forEach((n,s)=>{let o=t.pushNew();o.id=s,o.visible=n.graphics3DGraphic.getVisibilityFlag(i,nu.DECONFLICTION);let a=n.info?.[i];o.prio=n.graphics3DGraphic.deconflictionPriority,o.distance=a?a.distance:Number.MAX_VALUE,o.behindTerrain=!!a&&a.distanceToTerrain!==0&&a.distance>a.distanceToTerrain}),yield;let r=t.iterableSort((n,s)=>n.behindTerrain!==s.behindTerrain?+n.behindTerrain-+s.behindTerrain:n.prio!==s.prio?s.prio-n.prio:n.distance!==s.distance?n.distance-s.distance:n.visible!==s.visible?+s.visible-+n.visible:n.id-s.id);for(let n=r.next();!n.done;n=r.next())yield;t.forAll(n=>{let s=e.get(n.id);s&&(e.delete(n.id),e.set(n.id,s))}),t.clear()}u([d({constructOnly:!0})],Sc.prototype,"view",void 0),u([d({type:Boolean,readOnly:!0})],Sc.prototype,"updating",null),u([d({readOnly:!0})],Sc.prototype,"_updatingHandles",void 0),Sc=u([C("esri.views.3d.layers.graphics.Deconflictor")],Sc);var XP=class{constructor(){this.id=0,this.visible=!1,this.behindTerrain=!1,this.prio=0,this.distance=0}},JP=class{constructor(t=null,i=null,r=null){this.active=t,this.visible=i,this.sort=r,this.sortArray=new Nt({allocator:n=>n||new XP})}},cee=Hi(),eO=class{constructor(){this.positionView=w(),this.positionNDC=w(),this.distance=0,this.distanceToTerrain=0,this.distanceWithoutPolygonOffset=0,this.scaleInfo=new dk}get isOutsideScreen(){let t=this.positionNDC;return t[0]<-1||t[1]<-1||t[2]<-1||t[0]>=1||t[1]>=1||t[2]>=1}};function uee(e,t,i){return ee(QP.direction,e.positionView),Te(QP.origin,0,0,0),!!Zc(t,QP,see)&&e.distanceWithoutPolygonOffset>i}var dee=new eO;var hee=2e3,zy=class extends Sc{constructor(e){super(e),this.visibilityGroup=Ya.LABEL,this.marginFactor=.05,this._lastDeconfliction=0}initialize(){this._updatingHandles.add(()=>(this.view?.map?.ground?.opacity??0)===0,()=>this.setDirty())}get viewState(){return this.parent.viewState}runTask(e){if(this.parent.running)return Ui;let t=performance.now();if(e.state!==pi.IDLE&&t-this._lastDeconfliction<hee)return Ui;super.runTask(e),this.state===qn.Idle&&(this._lastDeconfliction=t)}enabledChanged(e,t){this.modifyGraphics(t,e.labelsEnabled)}getGraphicsLayers(e){return e.labelLayers}};u([d({constructOnly:!0})],zy.prototype,"parent",void 0),zy=u([C("esri.views.3d.layers.graphics.LabelDeconflictor")],zy);var KE=class extends Sc{constructor(){super(...arguments),this._contexts=new Map,this.visibilityGroup=Ya.GRAPHIC,this._marginFactor=-.1,this.test={overrideMarginFactor:e=>{this._marginFactor=e,this.setDirty()}}}get labels(){return this._labels}get viewState(){return this._viewState}initialize(){this._updatingHandles.add(()=>this.view?.state?.camera,()=>{this._updateViewState(),this.setDirty()}),this._updatingHandles.add(()=>this.view?.map?.ground?.opacity===1,()=>this.setDirty()),this._updatingHandles.add(()=>this.view?.slicePlane,()=>{this._updateSlicePlane(),this._slicePlaneChanged()},Re),this._frameTask=this.view.resourceController.scheduler.registerTask(Xt.GRAPHICS_DECONFLICTOR,this),this._labels=new zy({view:this.view,parent:this})}destroy(){this._labels=G(this._labels),this._frameTask=Ft(this._frameTask)}get marginFactor(){return this._marginFactor}setDirty(){this._contexts.size>0&&(super.setDirty(),this._labels.setDirty())}runTask(e){super.runTask(e),this.running||this._labels.setDirty()}_updateViewState(){this.view?.state&&(this._viewState.camera.copyFrom(this.view.state.camera),this._updateSlicePlane())}_updateSlicePlane(){let e=this.view?this.view.slicePlane:null;e!=null&&kF(e,this._viewState.camera.viewMatrix,this._viewState.slicePlane),this._viewState.slicePlaneEnabled=e!=null}_slicePlaneChanged(){for(let e of this._contexts.keys())if(e.symbolCreationContext.slicePlaneEnabled)return void this.setDirty()}addGraphicsOwner(e){let t=this._getGraphicsContext(e);return{addGraphic:i=>this._addGraphic(e,t,i),removeGraphic:i=>this._removeGraphic(t,i),labelingInfoChange:()=>this._labels.enabledChanged(e,t),featureReductionChange:()=>this.enabledChanged(e,t),slicePlaneEnabledChange:()=>this._slicePlaneEnabledChanged(e,t),clear:()=>t.forEach(i=>this._removeGraphic(t,i.graphics3DGraphic)),remove:()=>this._removeGraphicsOwner(e),setDirty:()=>this.setDirty()}}_removeGraphicsOwner(e){let t=this._contexts.get(e);t&&(t.forEach(i=>this._removeGraphic(t,i.graphics3DGraphic)),this._contexts.delete(e),this.setDirty())}_addGraphic(e,t,i){let r=i.graphic.uid,n=new YE(i,e.symbolCreationContext.slicePlaneEnabled);t.set(r,n),tO(e)&&this.addToActiveGraphics(n),e.labelsEnabled&&this._labels.addToActiveGraphics(n);let s=!this._graphicSupportsDeconfliction(i)||!tO(e);i.setVisibilityFlag(Ya.GRAPHIC,nu.DECONFLICTION,s)}_removeGraphic(e,t){let i=t.graphic.uid,r=e.get(i);r&&(this.removeFromActiveGraphics(r),this._labels.removeFromActiveGraphics(r),e.delete(i),this.setDirty())}enabledChanged(e,t){let i=tO(e);i||pee(e),this.modifyGraphics(t,i)}_slicePlaneEnabledChanged(e,t){let i=e.symbolCreationContext.slicePlaneEnabled;t.forEach(r=>r.slicePlaneEnabled=i),this.setDirty()}getGraphicsLayers(e){return e.layers}_graphicSupportsDeconfliction(e){if(e.isDraped)return!1;let t=e.layers;if(!t?.length)return!1;for(let i of t)if(this.layerSupportsDeconfliction(i))return!0;return!1}_getGraphicsContext(e){let t=this._contexts.get(e);if(t)return t;let i=new Map;return this._contexts.set(e,i),this.setDirty(),i}};function tO(e){let t=e.layer;return!(!t?.featureReduction||t.featureReduction.type!=="selection")}function pee(e){let t=e.graphics3DGraphics;t&&t.forEach(i=>i.setVisibilityFlag(Ya.GRAPHIC,nu.DECONFLICTION,!0))}KE=u([C("esri.views.3d.layers.graphics.GraphicsDeconflictor")],KE);function Cq(e,t,i,r,n,s,o=1){let a=Vg(t,n);if(a==null)return!1;if(a===gL){if(e===r&&i===s)return!0;let c=i+o;for(let h=i,p=s;h<c;++h,++p)ee(r[p],e[h]);return!0}let l=i+o;for(let c=i,h=s;c<l;++c,++h)a(e[c],0,r[h],0);return!0}var tD=class{constructor(t,i){this._renderCoordsHelper=t,this.opaqueGround=i,this._cache=new Map,this._cameraForward=w(),this._cameraEye=w(),this._cameraFovY=55*Math.PI/180,this._frustumBoundingSphereCenter=w(),this._frustumBoundingSphereRadius=0,this._frustum=new xw(t),this._renderSR=t.spatialReference;let r=LL(this._renderSR);this._renderSREllipsoidRadius=_t(r).radius}setup(t){this._aboveGround=t.aboveGround,this._frustum.update(t),ne(this._cameraForward,t.viewForward),ee(this._cameraEye,t.eye),this._cameraFovY=t.fovY,this._updateFrustumBoundingSphere()}done(){this._cache.clear()}compute(t){if(this._cache.has(t.id))return this._cache.get(t.id);let i=this._isVisibleInFrustum(t);return this._cache.set(t.id,i),i}_isVisibleInFrustum(t){return this._renderCoordsHelper.viewingMode===Se.Local?this._isTileVisibleInFrustumLocal(t):this._isTileVisibleInFrustumGlobal(t)}_updateFrustumBoundingSphere(){let t=this._frustum,i=t.origin,r=bee;ne(r,t.direction);let n=t.points,s=Cee;ai(s,n[4],i);let o=.5*ae(s,s)/ae(r,s),a=this._frustumBoundingSphereCenter;Md(a,i,r,o);let l=1+o;this._frustumBoundingSphereRadius=l}_isTileVisibleInFrustumLocal(t){let i=t.spatialReference,r=t.extent,n=this._renderSR;if(sr[0]=r[0],sr[1]=r[1],sr[2]=0,sr[3]=r[2],sr[4]=r[3],sr[5]=0,!_L(sr,i,0,sr,n,0))return!1;Te(Mn[0],sr[0],sr[1],0),Te(Mn[1],sr[3],sr[1],0),Te(Mn[2],sr[3],sr[4],0),Te(Mn[3],sr[0],sr[4],0),Te(XE,.5*(sr[0]+sr[3]),.5*(sr[1]+sr[4]),.5*(sr[2]+sr[5]));let s=Sq,o=.5*Ar(Mn[0],Mn[2]),a=this._frustum,l=this._frustumBoundingSphereRadius,c=this._frustumBoundingSphereCenter,h=Eee;ai(h,c,XE);let p=ae(s,h),m=Tee;if(Md(m,XE,s,p),Ar(m,c)>o+l)return!1;let f=this._cameraForward,g=ae(f,Sq),_=this._cameraFovY,v=this._cameraEye;if(Math.abs(g)<Math.abs(Math.cos(.5*_))){let T=!0,I=Te(Yee,f[0],f[1],0),A=ae(v,I);for(let O=0;O<4;++O){let $=Mn[O];if(ae($,I)-A>0){T=!1;break}}if(T)return!1}{let T=Mn[0],I=Mn[2];if(T[0]<=v[0]&&v[0]<=I[0]&&T[1]<=v[1]&&v[1]<=I[1])return!0}let b=gee,x=this.opaqueGround&&this._aboveGround,E=this.opaqueGround&&!this._aboveGround,D=Math.min(E?JE:1/0,p+l),M=Math.max(x?-430:-1/0,p-l);for(let T=0;T<4;++T)Md(b[T],Mn[T],s,D),Md(b[T+4],Mn[T],s,M);if(Eq(a.planes,b,8))return!1;if(iO(a.planes,b,8))return!0;for(let T=0;T<4;++T){let I=b[T],A=b[T+4];if(sO(a.planes,I,A))return!0;let O=b[(T+1)%4];if(sO(a.planes,I,O))return!0;let $=b[4+(T+1)%4];if(sO(a.planes,A,$))return!0}if(wl[0][3]=+Mn[0][0],wl[1][3]=-Mn[2][0],wl[2][3]=+Mn[0][1],wl[3][3]=-Mn[2][1],wl[4][3]=+M,wl[5][3]=-D,iO(wl,a.points)||iO(wl,a.points))return!0;for(let T=0;T<4;++T){let I=v,A=a.points[T+4];if(Iq(wl,I,A))return!0;let O=a.points[4+(T+1)%4];if(Iq(wl,A,O))return!0}return!1}_isTileVisibleInFrustumGlobal(t){if(t.level<qy)return!0;let i=t.spatialReference,r=t.extent,n=this.opaqueGround&&this._aboveGround,s=this.opaqueGround&&!this._aboveGround,o=Mn,a=.5*(r[0]+r[2]);if(Te(o[0],r[0],r[1],0),Te(o[1],r[2],r[1],0),Te(o[2],r[2],r[3],0),Te(o[3],r[0],r[3],0),Te(o[4],a,r[1],0),Te(o[5],a,r[3],0),!Cq(o,i,0,o,this._renderSR,0,6))return!1;let l=o[0][2]>0,c=o[3][2]<0,h=l||c,p=this._renderSREllipsoidRadius;if(h){let _e=_ee;od(_e,eD,o[0]);let L=yee;if(od(L,eD,o[1]),l){let N=Dq,V=o[4],U=xq;od(U,V,eD),od(N,U,V);let Y=o[0];At(Y,_e,N),Gy(Y,p);let re=o[1];At(re,L,N),Gy(re,p)}else if(c){let N=Dq,V=o[5],U=xq;od(U,V,eD),od(N,V,U);let Y=o[3];At(Y,N,_e),Gy(Y,p);let re=o[2];At(re,N,L),Gy(re,p)}}let m=XE,f=ai(See,o[3],o[0]);ne(f,f);let g=he(Iee,o[0],o[3]);X(g,g,.5);let _=-ae(g,f),v=he(Aee,o[0],o[1]);X(v,v,.5);let b=he(Ree,o[2],o[3]);X(b,b,.5);let x=ai(Pee,b,v);ne(x,x);let E=-(_+ae(f,v))/ae(f,x);Md(m,v,x,E),Gy(m,p);let D=this._frustumBoundingSphereRadius,M=this._frustumBoundingSphereCenter,T=this._frustum,I=T.planes,A=vee;ne(A,m);let O=ae(o[0],A)/yr(o[0]),$=T.origin,H=T.points,k=!1;if(n){{k=!0;let L=ne(Mq,$);for(let N=0;N<4;++N){let V=H[4+N],U=ai(w(),V,$);ne(U,U);let Y=At(w(),L,U);ne(Y,Y);let re=At(w(),U,Y);if(ne(re,re),ae($,re)>p){k=!1;break}}}if(k&&ae($,A)<p*O-JE)return!1;let _e=ne(Mq,T.origin);if(ae(_e,A)<0)return!1;{let L=ne(Zee,T.direction);if(ae(L,A)>Qee)return!1}}let K=Math.sqrt(1-O*O);if(K>.9)return!0;let F=!1,R=ae(A,M),j=yr(M);if(j<=D&&!I.some(_e=>ql(_e,rO)>0)){if(!n)return!0;F=!0}let B=R/j;if(!F&&R<=0&&-R>D)return!1;let z=D/j;if(Math.sqrt(1-B*B)*Math.sqrt(1-z*z)-z*B>K)return!1;if(!k&&(o.some(_e=>T.intersectsPoint(_e))||T.intersectsPoint(m)))return!0;let ce=Dee;ai(ce,M,rO);let ue=ae(ce,A),Ie=wee;X(Ie,A,ue);let le=Ar(Ie,M),ze=i.isWGS84,Le=t.lij,de=ze&&Le[2]===2**Le[0]-1,fe=ze&&Le[2]===0,st=fe?jee:de?Bee:Vee,De=fe?zee:de?Uee:Hee;if(!F){let _e=o,L=Gee,N=Oee,V=Nee,U=rO;for(let Y of st){let re=_e[Y];if(Tq(N,_e[(Y+1)%4],re),Tq(V,U,re),od(L,V,N),fee(L,H,1))return!1}}let Ee=null;if(!n&&ue<1.01*D){let _e=2.5*D;if(le>O*_e+D)return!1;let L=Mee,N=_e/O;for(let V=0;V<4;++V)X(L[V],o[V],N/p);Te(L[4],0,0,0),Ee=L}else{let _e=(s?p+JE:ue+D)/O,L=n?p-JE:(ue-D)/O,N=xee;for(let V=0;V<4;++V){let U=o[V];X(N[V],U,L/p),X(N[V+4],U,_e/p)}Ee=N}if(Eq(I,Ee,Ee.length))return!1;let Ae=T.lines,He=Lee,Ve=Fee;for(let _e of Ae){ne(Ve,_e.direction);for(let L of De){let N=Ee[L];if(ne(He,N),nO(Ve,He,Ee,H))return!1;let V=(L+1)%4;if(n){let U=Ee[V];if(ai(He,U,N),ne(He,He),nO(Ve,He,Ee,H))return!1}if(s){let U=Ee[4+L],Y=Ee[4+V];if(ai(He,Y,U),ne(He,He),nO(Ve,He,Ee,H))return!1}}}return!0}};function od(e,t,i){return At(e,t,i),ne(e,e),e}function Tq(e,t,i){return ai(e,t,i),ne(e,e),e}function Gy(e,t){return X(e,e,t/yr(e)),e}var Aq=[Yc.LEFT,Yc.RIGHT,Yc.BOTTOM,Yc.TOP,Yc.FAR];function mee(e,t,i){for(let r=0;r<i;++r)if(ql(e,t[r])<=0)return!1;return!0}function Eq(e,t,i){for(let r of Aq)if(mee(e[r],t,i))return!0;return!1}function iO(e,t,i=t.length){for(let r=0;r<i;++r){let n=t[r],s=!0;for(let o of e)if(ql(o,n)>0){s=!1;break}if(s)return!0}return!1}var qy=2,Rq=4;function fee(e,t,i){for(let r of t)if(ae(r,e)<i)return!1;return!0}var gee=[w(),w(),w(),w(),w(),w(),w(),w()],sr=[0,0,0,0,0,0],Mn=[w(),w(),w(),w(),w(),w()],XE=w(),Dq=w(),_ee=w(),yee=w(),xq=w(),vee=w(),wee=w(),bee=w(),Cee=w(),Tee=w(),Eee=w(),rO=Lg(0,0,0),Dee=w(),xee=[w(),w(),w(),w(),w(),w(),w(),w()],Mee=[w(),w(),w(),w(),w()],See=w(),Iee=w(),Aee=w(),Ree=w(),Pee=w(),Oee=w(),Nee=w(),Lee=w(),Fee=w(),kee=w(),Vee=[0,1,2,3],Hee=[0,1,2,3],Bee=[0,1,3],Uee=[0,1,3],jee=[1,2,3],zee=[1,2,3],Gee=w();function qee(e,t,i){let r=1/0,n=-1/0;for(let s of i){let o=ae(t,s);r=Math.min(r,o),n=Math.max(n,o)}e[0]=r,e[1]=n}function Wee(e,t,i,r){let n=1/0,s=-1/0;for(let o of r){let a=ae(i,o);if(n=Math.min(n,a),s=Math.max(s,a),n<=t&&s>=e)return!1}return!0}var $ee=[0,0];function nO(e,t,i,r){if(i.length===0||r.length===0)return!0;let n=kee;od(n,e,t);let s=r[0]<i[0],o=s?i:r,a=$ee;return qee(a,n,s?r:i),Wee(a[0],a[1],n,o)}var JE=430,Mq=w(),Zee=w(),Qee=Math.cos(.25*Math.PI),Sq=yt(0,0,1),Yee=w();function sO(e,t,i){let r={t0:0,t1:1};for(let n of Aq)if(!Pq(e[n],t,i,r))return!1;return r.t0<r.t1}function Iq(e,t,i){let r={t0:0,t1:1};for(let n of e)if(!Pq(n,t,i,r))return!1;return r.t0<r.t1}function Pq(e,t,i,r){let{t0:n,t1:s}=r,o=ql(e,t),a=ql(e,i);if(o>=0&&a>=0)return!1;if(o<0&&a>=0){let l=-o/(a-o);if(l<n)return!1;l<s&&(s=l)}else if(o>=0&&a<0){let l=o/(o-a);if(l>s)return!1;l>n&&(n=l)}return r.t0=n,r.t1=s,!0}var wl=[Pd(-1,0,0,1),Pd(1,0,0,-1),Pd(0,-1,0,1),Pd(0,1,0,-1),Pd(0,0,-1,1),Pd(0,0,1,-1)],eD=Lg(0,0,1);var Wy=class{constructor(t,i,r){this._renderCoordsHelper=t,this._tilingScheme=i,this._camera=new Rt,this._surfaceElevation=0,this._focusOnMap=[0,0],this._visibility=new tD(t,r)}set opaqueGround(t){this._visibility.opaqueGround=t}setup(t,i,r){this._camera.copyFrom(t),this._surfaceElevation=r,this._focusOnMap[0]=i.x,this._focusOnMap[1]=i.y,this._visibility.setup(this._camera)}done(){this._visibility.done()}update(t){let{measures:i,extent:r,level:n}=t;i.visible=this._visibility.compute(t),i.distance=L2(r,this._focusOnMap),i.mergeable=!0,i.lodLevel=qy,i.splitPriority=Math.max(0,qy-n),i.visible&&(this._isGlobal?this._updateSplitAndLodGlobal(t):this._updateSplitAndLodLocal(t))}_updateSplitAndLodGlobal(t){let i=t.level,r=this._renderCoordsHelper,{eye:n,fov:s}=this._camera,o=r.referenceEllipsoid.radius,a=yr(n)-o;if(2*Math.atan(o/a)<s&&a>0)return void(t.measures.lodLevel=Math.max(i,qy));let l=Oq,{extent:c}=t,{_surfaceElevation:h}=this;Te(l[0],c[0],c[1],h),Te(l[1],c[2],c[1],h),Te(l[2],c[2],c[3],h),Te(l[3],c[0],c[3],h);let p=Te(Nq,.5*(c[0]+c[2]),.5*(c[1]+c[3]),h),m=this._tilingScheme.spatialReference;for(let v=0;v<4;++v)r.toRenderCoords(l[v],m,l[v]);r.toRenderCoords(p,m,p);let f=ne(oO.direction,p),g=ae(n,f),_=X(Lq,f,g);this._updateSplitAndLod(t,l,p,_)}_updateSplitAndLodLocal(t){let i=Oq,{extent:r}=t,{_surfaceElevation:n}=this;Te(i[0],r[0],r[1],n),Te(i[1],r[2],r[1],n),Te(i[2],r[2],r[3],n),Te(i[3],r[0],r[3],n);let s=this._tilingScheme.spatialReference;for(let p=0;p<4;++p)this._renderCoordsHelper.toRenderCoords(i[p],s,i[p]);let o=Te(Nq,.5*(i[0][0]+i[2][0]),.5*(i[0][1]+i[2][1]),.25*(i[0][2]+i[1][2]+i[2][2]+i[3][2])),a=Te(Kee,o[0],o[1],0),{eye:l,far:c}=this._camera,h=Te(Lq,a[0],a[1],l[2]);Te(oO.origin,a[0],a[1],l[2]-2*c),ee(oO.direction,kq),this._updateSplitAndLod(t,i,o,h)}_updateSplitAndLod(t,i,r,n){let s=Math.max(Ar(i[0],i[2]),Ar(i[1],i[3]),Ar(i[0],r)+Ar(r,i[2]),Ar(i[1],r)+Ar(r,i[3])),{eye:o,near:a,fov:l,viewForward:c,width:h,height:p,pixelRatio:m,frustum:f}=this._camera,g=ae(o,c),_=ae(r,c)-g,v=Ar(r,o),b=_,x=_,E=v,D=v,M=(B,z)=>z<a?1:Math.sqrt(B*B-z*z)/z,T=M(v,_);for(let B of i){let z=ae(B,c)-g;b=Math.min(b,z),x=Math.max(x,z);let ce=Ar(B,o);D=Math.max(D,ce),E=Math.min(E,ce);let ue=M(ce,z);T=Math.min(T,ue)}if(x<a)return void(t.measures.lodLevel=0);let I=Math.cos(.5*l),A=Ar(o,n);T>I&&A>Jee*s&&(x=Fq*D,b=Fq*E);let O=.5*Math.sqrt(h*h+p*p)/m,$=2*Math.tan(.5*l),H=B=>Math.max(a,B)*Xee/O*$,k=t.level,K=s*2**k*Math.max(1,$),F=H(b),R=Math.ceil(Math.log2(Math.max(1,K/F)));if(t.measures.lodLevel=Math.max(R,t.measures.lodLevel),t.measures.splitPriority+=t.measures.lodLevel-k,k<R){let B=+Od(f,i[0])+ +Od(f,i[1])+ +Od(f,i[2])+ +Od(f,i[3]);t.measures.splitPriority+=B}let j=H(x)/F;j>2.5&&(t.measures.splitPriority+=j)}get _isGlobal(){return this._renderCoordsHelper.viewingMode===Se.Global}},Oq=[w(),w(),w(),w()],Nq=w(),Kee=w(),Lq=w(),kq=Lg(0,0,1),oO=mF(Jo,kq),Xee=312,Jee=.5,Fq=2;var ete=60,Cr=class extends P{constructor(e){super(e),this.tiles=new lt,this.tileSize=512,this._idToTile=new Map,this._clients=new Set,this._dirty=On(!1),this._pendingTiles=On(null),this._newTiles=new Nt,this._tests=!1,this._measurements=new Wy(e.renderCoordsHelper,e.tilingSchemeOwner.tilingScheme,this._opaqueGround)}initialize(){let e=()=>this._setDirty(),t=()=>this._reset();this.addHandles([S(()=>this.tileSize,t,Ce),S(()=>this.cameraOnSurface?.location,e,Ce),S(()=>this.viewState?.contentCamera,e,Ce),S(()=>this.focus?.location,e,Ce),S(()=>this.terrain?.baseOpacity??1,e),S(()=>this.tilingScheme,i=>{this._reset(),this._measurements=new Wy(this.renderCoordsHelper,i,this._opaqueGround)},Fe),S(()=>this._opaqueGround,i=>this._measurements.opaqueGround=i,Fe)]),this._frameWorker=this.scheduler?.registerTask(Xt.FEATURE_TILE_TREE,this)}destroy(){this._frameWorker=Ft(this._frameWorker)}get tilingScheme(){let e=this.tilingSchemeOwner.tilingScheme;return e?e.clone():null}set filterExtent(e){if(e!=null&&!e.spatialReference.equals(this.viewState.spatialReference))return void W.getLogger(this).error("#extent","extent spatial reference needs to be in the same spatial reference as the view");let t=this._get("filterExtent");if(t===e||t!=null&&e&&t.equals(e))return;let i=e!=null?e.clone():null;this._set("filterExtent",i),this._setDirty()}get _filterExtentRect(){if(this.filterExtent==null)return null;let e=Yt();return Ew(this.filterExtent,e,this.tilingScheme.spatialReference),e}get _rootTileIds(){let{tilingScheme:e}=this;return this._filterExtentRect&&e?e.rootTilesInExtent(this._filterExtentRect):[[0,0,0]]}set suspended(e){e!==this._get("suspended")&&(this._set("suspended",e),this._setDirty())}get updating(){return this._dirty.value||!!this._pendingTiles.value}addClient(){let e=r2();return this._clients.add(e),this._clients.size===1&&this._setDirty(),_r(()=>this._removeClient(e))}_removeClient(e){this._clients.delete(e),this._hasClients||this._clear()}get _hasClients(){return this._clients.size>0}get _opaqueGround(){return(this.terrain?.baseOpacity??1)===1}_setDirty(){this._hasClients&&!this.suspended&&(this._frameWorker?this._dirty.value=!0:this.runTask(Jn))}_clear(){this.tiles.removeAll(),this._idToTile.clear(),this._reset(),this._dirty.value=!1}get running(){return this.updating}_reset(){this._newTiles.clear(),this._pendingTiles.value=null,this._setDirty()}_getRootTiles(){let e=this.tilingScheme;return this._rootTileIds.map(t=>new SM(t[0],t[1],t[2],e))}runTask(e){e=this._tests?Jn:e,this._dirty.value=!1,this._pendingTiles.value||(this._startUpdate(e),this._frameWorker!=null&&(this._frameWorker.priority=Xt.FEATURE_TILE_TREE_ACTIVE)),this._splitPendingTiles(e),this._pendingTiles.value||this._frameWorker==null||(this._frameWorker.priority=Xt.FEATURE_TILE_TREE)}_startUpdate(e){if(this.suspended)return;if(!this.tilingScheme)return void this._clear();let{_measurements:t,_filterExtentRect:i,_newTiles:r}=this;t.setup(this.viewState.contentCamera,this.focus.location,this.cameraOnSurface.location.z??0),this._pendingTiles.value=this._getRootTiles().filter(n=>{if(t.update(n),n.measures.visible&&(!i||Bl(n.extent,i))){if(n.measures.splitPriority>0)return!0;r.push(n)}return!1}).sort(Vq),this._newTiles.clear(),e.madeProgress()}_splitPendingTiles(e){let t=this._pendingTiles.value;if(!t)return;let{tilingScheme:i,_filterExtentRect:r,_newTiles:n,_measurements:s}=this;for(;t.length>0&&this._tileBudgetExceeded<1;){let o=t.pop();if(e.madeProgress(),o.measures.splitPriority>0){i.ensureMaxLod(o.level+1);let a=o.createChildren();for(let l of a)s.update(l),!l.measures.visible||r&&!Bl(l.extent,r)||(l.measures.splitPriority>0?t.push(l):n.push(l));t.sort(Vq),this._tileBudgetExceeded>=1&&(this._mergeNewTiles(),this._tileBudgetExceeded>=1&&this._mergeNewTiles(!0))}else n.push(o);if(e.done)return}n.pushArray(t),this._pendingTiles.value=null,this._updateTiles(),n.clear(),s.done()}get _tileBudgetExceeded(){return Math.max(0,(this._newTiles.length+(this._pendingTiles.value?.length??0))/ete-1)}_mergeNewTiles(e=!1){let{_newTiles:t,_measurements:i}=this,r=new Map(t.map(s=>[s.id,s])),n=!1;return r.forEach(s=>{let{lij:o,measures:a}=s;if(!a.mergeable||o[1]%2!=0||o[2]%2!=0||o[0]<=1||s.lodLevelDelta>=Rq)return;let l=a.lodLevel,c=l,h=!0,p=r.get(Pw(o[0],o[1]+1,o[2])),m=Math.abs((p?.measures.lodLevel??0)-l),f=m===0||e&&p?.measures.mergeable&&m<=1;if(!p||!f)return;c+=p.measures.lodLevel,h&&=m===0;let g=r.get(Pw(o[0],o[1],o[2]+1));if(m=Math.abs((g?.measures.lodLevel??0)-l),f=m===0||e&&g?.measures.mergeable&&m<=1,!g||!f)return;c+=g.measures.lodLevel,h&&=m===0;let _=r.get(Pw(o[0],o[1]+1,o[2]+1));if(m=Math.abs((_?.measures.lodLevel??0)-l),f=m===0||e&&_?.measures.mergeable&&m<=1,!_||!f)return;c+=_.measures.lodLevel,h&&=m===0,t.removeUnordered(s),t.removeUnordered(p),t.removeUnordered(g),t.removeUnordered(_);let v=new SM(o[0]-1,o[1]/2,o[2]/2,this.tilingScheme);i.update(v),v.measures.visible=!0,v.measures.lodLevel=c/4,v.measures.mergeable=h,t.push(v),n=!0}),n}_updateTiles(){for(;this._mergeNewTiles(););for(;this._tileBudgetExceeded&&this._mergeNewTiles(!0););for(let r of this.tiles.items)r.used=!1;let e=!1,t=this._newTiles.filter(r=>{let n=this._idToTile.get(r.id);return n?(e||=n.measures.lodLevel!==r.measures.lodLevel,n.measures=ie({},r.measures),n.used=!0):this._idToTile.set(r.id,r),!n}),i=this.tiles.items.filter(r=>!r.used&&(this._idToTile.delete(r.id),!0));this.tiles.removeMany(i),this.tiles.addMany(t),this._sortTiles(),!e||i.length||t.length||this.tiles.emit("change")}_sortTiles(){this.viewState.fixedContentCamera||this.tiles.sort((e,t)=>e.measures.distance-t.measures.distance),this.tiles.forEach((e,t)=>e.loadPriority=t)}};function Vq(e,t){return e.lodLevelDelta-t.lodLevelDelta||e.measures.splitPriority-t.measures.splitPriority||t.measures.distance-e.measures.distance}u([d({constructOnly:!0})],Cr.prototype,"scheduler",void 0),u([d({constructOnly:!0})],Cr.prototype,"renderCoordsHelper",void 0),u([d({constructOnly:!0})],Cr.prototype,"tilingSchemeOwner",void 0),u([d({constructOnly:!0})],Cr.prototype,"cameraOnSurface",void 0),u([d({constructOnly:!0})],Cr.prototype,"focus",void 0),u([d({constructOnly:!0})],Cr.prototype,"viewState",void 0),u([d({constructOnly:!0})],Cr.prototype,"terrain",void 0),u([d()],Cr.prototype,"tiles",void 0),u([d()],Cr.prototype,"tileSize",void 0),u([d({readOnly:!0})],Cr.prototype,"tilingScheme",null),u([d()],Cr.prototype,"filterExtent",null),u([d({readOnly:!0})],Cr.prototype,"_filterExtentRect",null),u([d({readOnly:!0})],Cr.prototype,"_rootTileIds",null),u([d({value:!1})],Cr.prototype,"suspended",null),u([d({readOnly:!0})],Cr.prototype,"updating",null),Cr=u([C("esri.views.3d.layers.support.FeatureTileTree3D")],Cr);var Mi=class extends P{constructor(e){super(e),this._propertiesPool=new Vn({camera:Rt},this),this._lastSeenCameraProjectionValues=new Rt,this.mode=pi.ANIMATING,this._cssCamera=new Rt,this._camera=new Rt,this.rasterPixelRatio=1,this.contentPixelRatio=1,this.constraints=new ul({state:this}),this.events=new oi,this._cameraChanged=!1,this._updateQueue=new Array,this._processingUpdates=!1}reset(){this.cameraController=null,this._propertiesPool.destroy(),this._propertiesPool=new Vn({camera:Rt},this)}destroy(){this.cameraController=null,this._propertiesPool?.destroy(),this._propertiesPool=null}createInitialCamera(){if(this.viewingMode===Se.Global){let e=_t(this.spatialReference).radius;this.camera=new Rt({eye:yt(4*e,0,0),center:yt(e,0,0),up:yt(0,0,1)})}else this.camera=new Rt({eye:yt(0,0,100),center:yt(0,0,0),up:yt(0,1,0)})}get animation(){return this.cameraController instanceof Ku&&this.cameraController.viewAnimation!=null?this.cameraController.viewAnimation:null}get cssCamera(){let e=this._cssCamera.copyFrom(this.camera),{height:t,width:i,pixelRatio:r}=this.camera;return e.pixelRatio=1,e.height=Math.round(t/r),e.width=Math.round(i/r),e}get camera(){return this._camera}set camera(e){e!==Fo&&Fo.copyFrom(e),Fo.computeUp(this.viewingMode),this.events.emit("before-camera-change",Fo);let t=this._camera;if(tte(this._lastSeenCameraProjectionValues,Fo)&&(this._lastSeenCameraProjectionValues.copyFrom(Fo),this.events.emit("camera-projection-changed",this._lastSeenCameraProjectionValues)),!t.equals(Fo)&&(this._camera=this._propertiesPool.get("camera").copyFrom(Fo),this._cameraChanged=!t.almostEquals(Fo),this._cameraChanged)){let i=n2(()=>{this._cameraChanged=!1,i.remove()})}}get pixelRatio(){return this.camera.pixelRatio}get alignPixelEnabled(){return this.pixelRatio===this.rasterPixelRatio&&this.mode===pi.IDLE}get updating(){return this.mode!==pi.IDLE}get contentCamera(){return this._contentCamera??this.camera}set contentCamera(e){this._contentCamera=e!=null?e.clone():null}get fixedContentCamera(){return this._contentCamera!=null}get isGlobal(){return this.viewingMode===Se.Global}get isLocal(){return this.viewingMode===Se.Local}get viewingMode(){return zg(this.view.viewingMode)}get spatialReference(){return this.view.spatialReference}get highlights(){let e=this.view.highlights.items.slice(0,tk);for(let t=0;t<e.length;){let i=e[t],r=e.findIndex(n=>n.name===i.name);r>=0&&t>r?e.splice(t,1):++t}return e}get highlightOrderMap(){let e=new Map;return this.highlights.forEach((t,i)=>e.set(t.name,i)),e}get navigating(){return!!this.cameraController?.isInteractive}get stationary(){return!this._cameraChanged&&!this.navigating}get cameraController(){return this._get("cameraController")}set cameraController(e){this.stopActiveCameraController()?(this.cameraController?.destroy(),e&&(this.removeHandles(Hq),this.addHandles(Wi(()=>e.state===Vt.Finished||e.state===Vt.Stopped,()=>{this._set("cameraController",null),this.updateCamera(t=>e.onControllerEnd(t))},{sync:!0,once:!0}),Hq),e.onControllerStart(this.camera)),this._set("cameraController",e)):e&&(e.state=Vt.Rejected)}switchCameraController(e){this.cameraController=e}stopActiveCameraController(){return!this.cameraController||this.cameraController.stopController()}updateCamera(e){this._updateQueue.push(e),this._processUpdateQueue()}_processUpdateQueue(){if(this._updateQueue.length===0||this._processingUpdates)return;this._processingUpdates=!0;let e=this._updateQueue.shift();Fo.copyFrom(this._get("camera")),e(Fo),this.camera=Fo,this._processingUpdates=!1,this._processUpdateQueue()}};u([d({constructOnly:!0})],Mi.prototype,"view",void 0),u([d()],Mi.prototype,"mode",void 0),u([d({readOnly:!0,type:Cn})],Mi.prototype,"animation",null),u([d({type:Rt})],Mi.prototype,"cssCamera",null),u([d()],Mi.prototype,"_cssCamera",void 0),u([d({type:Rt})],Mi.prototype,"camera",null),u([d()],Mi.prototype,"_camera",void 0),u([d({readOnly:!0})],Mi.prototype,"pixelRatio",null),u([d()],Mi.prototype,"rasterPixelRatio",void 0),u([d()],Mi.prototype,"contentPixelRatio",void 0),u([d({readOnly:!0})],Mi.prototype,"alignPixelEnabled",null),u([d({readOnly:!0})],Mi.prototype,"updating",null),u([d({})],Mi.prototype,"_contentCamera",void 0),u([d({type:Rt})],Mi.prototype,"contentCamera",null),u([d({readOnly:!0})],Mi.prototype,"fixedContentCamera",null),u([d({readOnly:!0})],Mi.prototype,"events",void 0),u([d({readOnly:!0})],Mi.prototype,"isGlobal",null),u([d({readOnly:!0})],Mi.prototype,"isLocal",null),u([d({readOnly:!0})],Mi.prototype,"viewingMode",null),u([d({readOnly:!0})],Mi.prototype,"highlights",null),u([d({readOnly:!0})],Mi.prototype,"highlightOrderMap",null),u([d({readOnly:!0})],Mi.prototype,"navigating",null),u([d({readOnly:!0})],Mi.prototype,"stationary",null),u([d()],Mi.prototype,"_cameraChanged",void 0),u([d()],Mi.prototype,"cameraController",null),Mi=u([C("esri.views.3d.state.ViewState")],Mi);var Bq=Mi;function tte(e,t){return e.fov!==t.fov||e.fullViewport[0]!==t.fullViewport[0]||e.fullViewport[1]!==t.fullViewport[1]||e.fullViewport[2]!==t.fullViewport[2]||e.fullViewport[3]!==t.fullViewport[3]||e.padding[rn.TOP]!==t.padding[rn.TOP]||e.padding[rn.RIGHT]!==t.padding[rn.RIGHT]||e.padding[rn.BOTTOM]!==t.padding[rn.BOTTOM]||e.padding[rn.LEFT]!==t.padding[rn.LEFT]}var Fo=new Rt,Hq="ViewStateHandles";var nD=class{constructor(t,i,r){this.viewingMode=t,this._forEachLayer=i,this._view=r,this._externalIntersectionHandlers=new Nt,this._tolerance=Qp,this._tmpRay=Os(),this._tmpRegion=Yt(),this._validateHUDIntersector=nn(this.viewingMode),this._validateHUDIntersector.options.hud=!1}intersectScreen(t,i,r){return this.intersectRay(this._getPickRay(t,this._tmpRay),Uq(this.viewingMode),i,r)}intersectScreenFreePointFallback(t,i,r){return this.intersectRayFreePointFallback(this._getPickRay(t,this._tmpRay),i,r)}intersectRayFreePointFallback(t,i,r){return this.intersectRay(t,Uq(this.viewingMode),i,r)||this._intersectRayFreePointLocal(t,i)}intersectRay(t,i,r,n){return i.options.selectionMode=!1,i.options.store=fo.MIN,this.computeIntersection(t,i,n),!!i.results.min&&i.results.min.getIntersectionPoint(r)}getCenterRayWithSubpixelOffset(t,i,r=.5,n=.5){return t.getRenderCenter(rD,r,n),rD[0]+=.0466,rD[1]-=.0123,Cw(t,rD,i)}intersectIntersectorScreen(t,i,r){this.computeIntersection(this._getPickRay(t,this._tmpRay),i,r)}intersectToolIntersectorScreen(t,i,r){let n=this._getPickRay(t,this._tmpRay);this.intersectToolIntersectorRay(n,i,r)}intersectToolIntersectorRay(t,i,r){i.options.selectionMode=!0,this.computeIntersection(t,i,r);let n=i.results.min;this._view.basemapTerrain&&this._view.basemapTerrain.opaque||ik(n)&&n.intersector!==na.TERRAIN||(i.options.selectionMode=!1,this.computeIntersection(t,i,r))}setTolerance(t=Qp){this._tolerance=t}addIntersectionHandler(t){this._externalIntersectionHandlers.push(t),this._externalIntersectionHandlers.sort((i,r)=>i.type===na.TERRAIN?1:r.type===na.TERRAIN?-1:0)}removeIntersectionHandler(t){this._externalIntersectionHandlers.removeUnordered(t)!=null&&this._externalIntersectionHandlers.sort((i,r)=>i.type===na.TERRAIN?1:r.type===na.TERRAIN?-1:0)}_getPickRay(t,i){let r=this._view.state.camera;return bw(r,t,i)}_intersectRayFreePointLocal(t,i){return this.viewingMode!==Se.Local||t==null||he(i,t.origin,ne(fi.get(),t.direction)),!1}intersectElevationFromScreen(t,i,r=0,n=null){return this._intersectElevation(this._getPickRay(t,this._tmpRay),i,r,n)}_intersectElevation(t,i,r=0,n=null){if(t==null)return null;let s=this._view,{renderCoordsHelper:o}=s,a=v2(s.spatialReference),l=i!=null?i.mode:"absolute-height",c=gk(i)/a,h=(l!=="on-the-ground"?c+r:0)*a/o.unitInMeters,{camera:p}=s.state;if(l==="absolute-height"){let D=o?.getAltitude(p.eye),M=ae(ne($y,t.direction),o.worldUpAtPosition(p.eye,rte));if(D<h&&M<0||D>=h&&M>0)return null;if(o.intersectInfiniteManifold(t,h,$y)){let T=AM(s,$y);return T.z??=0,T.z-=c,T}return null}let m=fi.get();p.projectToRenderScreen(t.origin,m);let f=new sD(null,this._forEachLayer),{slicePlane:g}=s,_=g!=null?tM(g):null,v=nn(this.viewingMode);v.options.store=fo.MIN,v.options.verticalOffset=h,v.options.normalRequired=!1;let b=t.origin,x=he(fi.get(),b,t.direction);v.reset(b,x,p),v.point=m;let E=n?"type"in n&&n.type==="graphics"?D=>D.layerUid!==n.uid:D=>D.graphicUid!==n.uid:null;switch(l){case"relative-to-scene":{let D=M=>(!E||E(M))&&!!M.lastValidElevationBB;v.intersect(f.layers,m,this._tolerance,null,D),this._externalIntersectionHandlers.forAll(M=>{if(M.type===na.I3S||M.type===na.TERRAIN||M.type===na.TILES3D){let T=M.slicePlaneEnabled?_:null;M.intersect(v,T,v.rayBegin,v.rayEnd,m)}});break}case"on-the-ground":case"relative-to-ground":this._externalIntersectionHandlers.forAll(D=>{if(D.isGround){let M=D.slicePlaneEnabled?_:null;D.intersect(v,M,v.rayBegin,v.rayEnd,m)}})}if(v.results.min.getIntersectionPoint($y)){let D=AM(s,$y);return D.z=r,D}return null}computeIntersection(t,i,r,n){if(t==null)return;let s=this._view.state.camera,o=fi.get();s.projectToRenderScreen(t.origin,o);let a=new sD(r,this._forEachLayer);i.options.selectOpaqueTerrainOnly=!r||!("include"in r||"exclude"in r);let l=t.origin,c=he(fi.get(),t.origin,t.direction);i.reset(l,c,s),i.intersect(a.layers,o,this._tolerance);let h=this._view.slicePlane,p=h!=null?tM(h):null;i.intersect(a.sliceableLayers,o,this._tolerance,p);let m=r&&(r.requiresGroundFeedback||r.enableDraped);this._externalIntersectionHandlers.forAll(_=>{let v=_.layerUid,b=Array.isArray(v),x=b?v:[v];b&&(i.options.filteredLayerUids=[]);let E=!1;for(let D of x)a.filterLayerUid(D)?E=!0:b&&i.options.filteredLayerUids.push(D);if(i.options.isFiltered=!E,_.isGround&&m||!i.options.isFiltered){let D=_.slicePlaneEnabled?p:null;_.intersect(i,D,l,c,o,n)}});let f=fi.get(),g=this._view.basemapTerrain;if(r&&r.enableDraped&&g.spatialReference!=null&&i.results.ground.getIntersectionPoint(f)){let _=g.overlayManager.renderer,v=this._view.renderCoordsHelper.spatialReference,b=fi.get();this._view.renderCoordsHelper.fromRenderCoords(f,b,g.spatialReference),b[2]=this._view.elevationProvider?.getElevation(f[0],f[1],f[2],v,"ground")??0,_.intersect(i,b,i.results.ground,x=>a.filterRenderGeometry(x))}i.sortResults(),this._processHUDResults(i)}_processHUDResults(t){let i=t.results.hud;Og(this._tmpRegion,k2);let r=this._view.state.camera,n=[],s=this._tmpRegion,o=b=>{let x=new aO(b),E=x.result.target.object.geometries.every(D=>D.material instanceof J0&&D.material.parameters.occlusionTest);n.push({item:x,occlusionTest:E}),E&&(r.projectToRenderScreen(b.target.center,x.screenPoint),x.screenPoint[0]=Math.floor(x.screenPoint[0]),x.screenPoint[1]=Math.floor(x.screenPoint[1]),O2(s,x.screenPoint))};t.sortResults(i.all),i.min.dist!=null&&o(i.min);for(let b of i.all)i.min.target.object!==b.target.object&&i.max.target.object!==b.target.object&&o(b);if(i.max.dist!=null&&i.max.target.object!==i.min.target.object&&o(i.max),!n.length)return;s[0]===s[2]&&(s[2]+=1),s[1]===s[3]&&(s[3]+=1);let a=r.fullWidth,l=r.fullHeight,c=Math.max(0,s[0]-Zy),h=Math.max(0,s[1]-Zy),p=Math.min(ao(s)+2*Zy,a-c),m=Math.min(Hl(s)+2*Zy,l-h),f=p>0&&m>0?new Uint8Array(p*m*4):null;f&&this._view._stage.renderer.readHUDVisibility(c,h,p,m,f);let g=!0,_=t.results.max.dist==null,v=0;for(let{item:b,occlusionTest:x}of n){let E=!x;if(x&&f)for(let D of ite){let M=4*(Math.min(b.screenPoint[0]+D[0],a)-s[0]+(Math.min(b.screenPoint[1]+D[1],l)-s[1])*p);if(M>=0&&M<f.length&&f[M]){E=!0;break}}E&&(g&&(t.results.min.copy(b.result),g=!1),_&&t.results.max.copy(b.result),t.options.store===fo.ALL&&t.results.all.splice(v++,0,b.result))}}},Zy=1,ite=(()=>{let e=[],t=Zy;for(let i=-1;i<=t;i++)for(let r=-1;r<=t;r++)e.push([r+t,i+t]);return e})(),aO=class{constructor(t){this.result=t,this.screenPoint=bd()}},iD;function Uq(e){return iD&&iD.viewingMode===e||(iD=nn(e)),iD}var sD=class{constructor(t,i){this.layers=new Array,this.sliceableLayers=new Array,this.include=t?.include,this.exclude=t?.exclude,i(r=>{r.pickable&&this.filterLayerUid(r.apiLayerUid)&&(r.sliceable?this.sliceableLayers:this.layers).push(r)})}filterLayerUid(t){let{include:i,exclude:r}=this;return t==null?i==null&&r==null:(i==null||i.has(t))&&(r==null||!r.has(t))}filterRenderGeometry(t){return this.filterLayerUid(t.layerUid)}};function lO(e){return typeof e=="object"&&"intersect"in e}var $y=w(),rte=w(),rD=bd();var zf=class extends oi.EventedMixin(P){get spatialReference(){return this.view?.basemapTerrain?.spatialReference}constructor(e){super(e),this._im=new Array,this._ground=new Array,this._scene=new Array,this.lastElevationQuery=null,this._cacheEnabled=!1}destroy(){this._cachedQuery=G(this._cachedQuery)}enableCache(e){e||(this.lastElevationQuery=null),this._cacheEnabled=e}getElevation(e,t,i,r,n){if(this._cacheEnabled&&this.lastElevationQuery!=null){let o=this.lastElevationQuery;if(e===o.x&&t===o.y&&i===o.z&&Fa(r,o.spatialReference)&&n===o.queryContext)return o.result}let s=null;return s=oD(s,this._im,e,t,i,r,n),s==null&&(s=oD(s,this._ground,e,t,i,r,n)),n==="scene"&&(s=oD(s,this._scene,e,t,i,r,n)),this._cacheEnabled&&(this.lastElevationQuery={x:e,y:t,z:i,spatialReference:r,queryContext:n,result:s}),s}getSphereElevationBounds(e,t,i){let r=new jp;function n(s){for(let o of s)if(o.getSphereElevationBounds){let a=o.getSphereElevationBounds(e,t,i);a!=null&&r.expandElevationRangeValues(a.elevationRangeMin,a.elevationRangeMax)}}return n(this._ground),n(this._im),i==="scene"&&n(this._scene),r}getRootElevationBounds(){let e=new jp;for(let t of[this._im,this._ground,this._scene])t.forEach(i=>{if(i.getRootElevationBounds){let r=i.getRootElevationBounds();r!=null&&e.expandElevationRangeValues(r.elevationRangeMin,r.elevationRangeMax)}});return e}async queryElevation(e,t,i,r,n,s=null,o=0){let a=this._getElevationQuery(r);try{let l=await a.queryElevation(e,t,s,o);return n==="scene"?oD(l,this._scene,e,t,i,r,n):l}catch(l){return YN(l),this.getElevation(e,t,i,r,n)}}register(e,t){this.addHandles(t.on("elevation-change",i=>this.emit("elevation-change",i)),t),this._providersFromContext(e).push(t)}unregister(e){this.removeHandles(e);for(let t of[this._im,this._ground,this._scene]){let i=t.indexOf(e);i>-1&&t.splice(i,1)}}_providersFromContext(e){switch(e){case"ground":return this._ground;case"im":return this._im;case"scene":return this._scene}}_getElevationQuery(e=this.view.spatialReference){let t=this._cachedQuery;if(t!=null&&Fa(e,t.spatialReference))return t;t?.destroy({completeTasks:!0});let{wkid:i,wkt:r,wkt2:n,latestWkid:s}=e,o=new OV(this.view.resourceController.scheduler,new Qt({wkid:i,wkt:r,wkt2:n,latestWkid:s}),()=>this.view.map?.ground,{maximumAutoTileRequests:4});return this._cachedQuery=o,o}};function oD(e,t,i,r,n,s,o){for(let a of t){let l=a.getElevation(i,r,n,s,o);l!=null&&(e=e!=null?Math.max(l,e):l)}return e}u([d({constructOnly:!0})],zf.prototype,"view",void 0),u([d()],zf.prototype,"spatialReference",null),zf=u([C("esri.views.3d.support.CombinedElevationProvider")],zf);var Gf=(()=>{class e{static isValidProfile(i){return i in e.profiles}static getDefaultProfile(){return Ct("esri-iPhone")?"low":"medium"}static apply(i,r){let n=e.profiles[i];r.graphics3D.maxTotalNumberOfFeatures=n.graphics3D.maxTotalNumberOfFeatures,r.graphics3D.maxNumberOfDrawCalls=n.graphics3D.maxNumberOfDrawCalls,r.graphics3D.maxTotalNumberOfVertices=n.graphics3D.maxTotalNumberOfVertices,r.graphics3D.polygonLodFactor=n.graphics3D.polygonLodFactor,r.graphics3D.polylineLodFactor=n.graphics3D.polylineLodFactor,r.graphics3D.snapshotAvailable=n.graphics3D.snapshotAvailable,r.graphics3D.skipHighSymbolLods=n.graphics3D.skipHighSymbolLods,r.graphics3D.uncompressedTextureDownsamplingEnabled=n.graphics3D.uncompressedTextureDownsamplingEnabled;let s=r.sceneService.object,o=n.sceneService.object;s.lodFactor=o.lodFactor,r.sceneService.point.lodFactor=n.sceneService.point.lodFactor,r.sceneService.integratedMesh.lodFactor=n.sceneService.integratedMesh.lodFactor,r.sceneService.pointCloud.lodFactor=n.sceneService.pointCloud.lodFactor,r.sceneService.uncompressedTextureDownsamplingEnabled=n.sceneService.uncompressedTextureDownsamplingEnabled,r.tiledSurface.lodBias=n.tiledSurface.lodBias,r.tiledSurface.angledSplitBias=n.tiledSurface.angledSplitBias,r.tiledSurface.vtlContentZoom=n.tiledSurface.vtlContentZoom,r.tiledSurface.elevationLevelDelta=n.tiledSurface.elevationLevelDelta,r.tiledSurface.reduceTileLevelDifferences=n.tiledSurface.reduceTileLevelDifferences,r.heatmap.pixelRatio=n.heatmap.pixelRatio,r.heatmap.maxTotalNumberOfFeatures=n.heatmap.maxTotalNumberOfFeatures,r.fadeDuration=n.fadeDuration,r.antialiasingEnabled=n.antialiasingEnabled,r.physicallyBasedRenderingEnabled=n.physicalBasedRenderingEnabled,r.highQualityTransparency=n.highQualityTransparency,r.highResolutionAtmosphere=n.highResolutionAtmosphere,r.reflections=n.reflections,r.ambientOcclusion=n.ambientOcclusion,r.memoryLimit=n.memoryLimit,r.additionalCacheMemory=n.additionalCacheMemory,r.frameRate=n.frameRate,r.maximumPixelRatio=n.maximumPixelRatio}}return e.test={reset(){let t=jq();for(let i of Object.keys(t))e.profiles[i]=t[i]}},e})(),Qy={IPhone12Pro:120,GalaxyS20:200,FullHD:240,SurfacePro7:300,FullHDRetina:430};function jq(){let e=!!Ct("esri-mobile"),t=!!Ct("ios"),i=400;return{low:{graphics3D:{maxTotalNumberOfFeatures:25e3,maxNumberOfDrawCalls:8e3,maxTotalNumberOfVertices:255e4,polygonLodFactor:.5,polylineLodFactor:1,snapshotAvailable:!1,skipHighSymbolLods:!0,uncompressedTextureDownsamplingEnabled:!0},heatmap:{pixelRatio:.125,maxTotalNumberOfFeatures:5e4},sceneService:{object:{lodFactor:.2},point:{lodFactor:1},integratedMesh:{lodFactor:.6},pointCloud:{lodFactor:.5},uncompressedTextureDownsamplingEnabled:!0},tiledSurface:{lodBias:-1,angledSplitBias:.5,vtlContentZoom:.75,elevationLevelDelta:3,reduceTileLevelDifferences:!0},fadeDuration:0,antialiasingEnabled:!1,physicalBasedRenderingEnabled:!1,highQualityTransparency:!1,highResolutionAtmosphere:!1,reflections:!1,ambientOcclusion:!1,memoryLimit:200+Qy.IPhone12Pro,additionalCacheMemory:0,frameRate:0,maximumPixelRatio:1},medium:{graphics3D:{maxTotalNumberOfFeatures:1e5,maxNumberOfDrawCalls:17e3,maxTotalNumberOfVertices:625e4,polygonLodFactor:e?.8:1,polylineLodFactor:e?1.2:1.5,snapshotAvailable:!t,skipHighSymbolLods:!1,uncompressedTextureDownsamplingEnabled:e},heatmap:{pixelRatio:.25,maxTotalNumberOfFeatures:13e4},sceneService:{object:{lodFactor:1},point:{lodFactor:1},integratedMesh:{lodFactor:1},pointCloud:{lodFactor:1},uncompressedTextureDownsamplingEnabled:e},tiledSurface:{lodBias:0,angledSplitBias:1,vtlContentZoom:1.5,elevationLevelDelta:3,reduceTileLevelDifferences:!Ct("disable-feature:reduce-map-tile-levels")},fadeDuration:i,antialiasingEnabled:!1,physicalBasedRenderingEnabled:!0,highQualityTransparency:!0,highResolutionAtmosphere:!1,reflections:!1,ambientOcclusion:!1,memoryLimit:e?600+Qy.GalaxyS20:750+Qy.FullHD,additionalCacheMemory:e?-100:150,frameRate:0,maximumPixelRatio:1},high:{graphics3D:{maxTotalNumberOfFeatures:1e5,maxNumberOfDrawCalls:17e3,maxTotalNumberOfVertices:125e5,polygonLodFactor:e?1.2:2,polylineLodFactor:e?1.2:2,snapshotAvailable:!t,skipHighSymbolLods:!1,uncompressedTextureDownsamplingEnabled:!1},heatmap:{pixelRatio:.5,maxTotalNumberOfFeatures:23e4},sceneService:{object:{lodFactor:1},point:{lodFactor:1},integratedMesh:{lodFactor:1},pointCloud:{lodFactor:1},uncompressedTextureDownsamplingEnabled:!1},tiledSurface:{lodBias:0,angledSplitBias:1,vtlContentZoom:1.5,elevationLevelDelta:2,reduceTileLevelDifferences:!Ct("disable-feature:reduce-map-tile-levels")},fadeDuration:i,antialiasingEnabled:!0,physicalBasedRenderingEnabled:!0,highQualityTransparency:!0,highResolutionAtmosphere:!0,reflections:!0,ambientOcclusion:!0,memoryLimit:e?900+Qy.SurfacePro7:1500+Qy.FullHDRetina,additionalCacheMemory:e?-150:0,frameRate:0,maximumPixelRatio:e?1:1/0}}}(function(e){e.profiles=jq()})(Gf);var Ue;(function(e){e[e.ELEVATION=0]="ELEVATION",e[e.MAP=1]="MAP"})(Ue||(Ue={}));var ad=[Ue.ELEVATION,Ue.MAP];async function zq(e,t){let{results:i,ground:r}=await pV(e,t),n=(!r.layer||!Pg(r.layer.type))&&r.mapPoint,s=[],o=ote(e),a=n?nte(e,o):ste,l=0,c=0,h=()=>{let m=a.layerViews[c];n&&m&&"fetchPopupFeaturesAtLocation"in m&&s.push({mapPoint:r.mapPoint,layerView:m}),++c},p=null;for(;l<i.length||c<a.layerViews.length;){let m=i[l];if(m&&m.type!=="graphic")++l;else if(m?.layer?.type!=="scene"||m?.layer?.parent!==e?.map?.basemap)if(m){let f=m.layer?.uid,g=a.layerUids.has(f)&&m.distance===r.distance,_=o.get(m.layer?.uid);if(p??=m.mapPoint,c<a.layerViews.length&&(g||(m.distance??0)>r.distance)&&a.layerViews[c]!==_){h();continue}s.push({graphic:m.graphic,layerView:_}),++l}else h();else++l}return p??=r.mapPoint,{hits:s,location:p}}function nte(e,t){let i=new Set,r=[];for(let s=e.basemapTerrain.numLayers(Ue.MAP)-1;s>=0;s--){let o=e.basemapTerrain.layerViewByIndex(s,Ue.MAP);i.add(o.layer.uid),r.push(o)}let n=e.basemapTerrain.overlayManager.renderer.layers;for(let{uid:s}of n){let o=t.get(s);o&&(i.add(s),r.push(o))}return r.reverse(),{layerUids:i,layerViews:r}}var ste={layerUids:new Set,layerViews:[]};function ote(e){let t=new Map;for(let i of e.allLayerViews){let r=i.layer.uid;t.set(r,i)}return t}var Qs=class extends P{constructor(){super(...arguments),this.minTotalNumberOfFeatures=2e3,this.maxTotalNumberOfFeatures=5e4,this.maxNumberOfDrawCalls=17e3,this.maxTotalNumberOfVertices=17e5,this.snapshotAvailable=!0,this.polygonLodFactor=1,this.polylineLodFactor=1,this.skipHighSymbolLods=!1,this.uncompressedTextureDownsamplingEnabled=!1}};u([d()],Qs.prototype,"minTotalNumberOfFeatures",void 0),u([d()],Qs.prototype,"maxTotalNumberOfFeatures",void 0),u([d()],Qs.prototype,"maxNumberOfDrawCalls",void 0),u([d()],Qs.prototype,"maxTotalNumberOfVertices",void 0),u([d()],Qs.prototype,"snapshotAvailable",void 0),u([d()],Qs.prototype,"polygonLodFactor",void 0),u([d()],Qs.prototype,"polylineLodFactor",void 0),u([d()],Qs.prototype,"skipHighSymbolLods",void 0),u([d()],Qs.prototype,"uncompressedTextureDownsamplingEnabled",void 0),Qs=u([C("esri.views.3d.support.QualitySettings.Graphics3DSettings")],Qs);var Ta=class extends P{constructor(){super(...arguments),this.lodFactor=1}};u([d()],Ta.prototype,"lodFactor",void 0),Ta=u([C("esri.views.3d.support.QualitySettings.LoDFactorSettings")],Ta);var Ic=class extends P{constructor(){super(...arguments),this.object=new Ta,this.point=new Ta,this.integratedMesh=new Ta,this.pointCloud=new Ta,this.uncompressedTextureDownsamplingEnabled=!1}};u([d({type:Ta})],Ic.prototype,"object",void 0),u([d({type:Ta})],Ic.prototype,"point",void 0),u([d({type:Ta})],Ic.prototype,"integratedMesh",void 0),u([d({type:Ta})],Ic.prototype,"pointCloud",void 0),u([d()],Ic.prototype,"uncompressedTextureDownsamplingEnabled",void 0),Ic=u([C("esri.views.3d.support.QualitySettings.SceneServiceSettings")],Ic);var Ac=class extends P{constructor(){super(...arguments),this.lodBias=0,this.angledSplitBias=1,this.vtlContentZoom=1,this.elevationLevelDelta=3,this.reduceTileLevelDifferences=!0}};u([d()],Ac.prototype,"lodBias",void 0),u([d()],Ac.prototype,"angledSplitBias",void 0),u([d()],Ac.prototype,"vtlContentZoom",void 0),u([d()],Ac.prototype,"elevationLevelDelta",void 0),u([d()],Ac.prototype,"reduceTileLevelDifferences",void 0),Ac=u([C("esri.views.3d.support.QualitySettings.TiledSurfaceSettings")],Ac);var qf=class extends P{constructor(){super(...arguments),this.pixelRatio=1,this.maxTotalNumberOfFeatures=5e4}};u([d()],qf.prototype,"pixelRatio",void 0),u([d()],qf.prototype,"maxTotalNumberOfFeatures",void 0),qf=u([C("esri.views.3d.support.QualitySettings.HeatmapSettings")],qf);var Xr=class extends P{constructor(){super(...arguments),this.graphics3D=new Qs,this.sceneService=new Ic,this.tiledSurface=new Ac,this.heatmap=new qf,this.fadeDuration=400,this.antialiasingEnabled=!0,this.physicallyBasedRenderingEnabled=!1,this.highQualityTransparency=!0,this.highResolutionAtmosphere=!1,this.reflections=!1,this.ambientOcclusion=!1,this.memoryLimit=750,this.additionalCacheMemory=0,this.frameRate=void 0,this.maximumPixelRatio=1/0}};u([d({type:Qs})],Xr.prototype,"graphics3D",void 0),u([d({type:Ic})],Xr.prototype,"sceneService",void 0),u([d({type:Ac})],Xr.prototype,"tiledSurface",void 0),u([d({type:qf})],Xr.prototype,"heatmap",void 0),u([d()],Xr.prototype,"fadeDuration",void 0),u([d()],Xr.prototype,"antialiasingEnabled",void 0),u([d()],Xr.prototype,"physicallyBasedRenderingEnabled",void 0),u([d()],Xr.prototype,"highQualityTransparency",void 0),u([d()],Xr.prototype,"highResolutionAtmosphere",void 0),u([d()],Xr.prototype,"reflections",void 0),u([d()],Xr.prototype,"ambientOcclusion",void 0),u([d()],Xr.prototype,"memoryLimit",void 0),u([d()],Xr.prototype,"additionalCacheMemory",void 0),u([d()],Xr.prototype,"frameRate",void 0),u([d()],Xr.prototype,"maximumPixelRatio",void 0),Xr=u([C("esri.views.3d.support.QualitySettings")],Xr);var cO=Xr;var aD=class{constructor(t){this.client=t,this._cancelled=!1,this.size=0,this.duration=0}},uO=class{constructor(t){this.typeWorkerQuota=t,this.tasks=new Array,this.numWorkers=0,this.statistics=new dO}},dO=class{constructor(){this.requests=0,this.size=0,this.duration=0,this.speed=0}},lD=class{constructor(t,i,r,n){this._workerFunc=t,this._callbackFunc=i,this._maxTotalNumWorkers=r,this._totalNumWorkers=0,this._clients=n.map(s=>new uO(s))}destroy(){this._clients.length=0}hasQuota(t){let i=this._clients[t];return!!i&&(this._totalNumWorkers<this._maxTotalNumWorkers||i.numWorkers+i.tasks.length<i.typeWorkerQuota)}push(t){let i=this._clients[t.client];i&&(this._totalNumWorkers<this._maxTotalNumWorkers?(i.numWorkers++,this._totalNumWorkers++,this._workerFunc(t,(r,n)=>this._taskCallback(r,n))):i.tasks.push(t))}cancel(t){this._taskFinished(t),t._cancelled=!0}_taskFinished(t){let i=this._clients[t.client];this._totalNumWorkers--,i&&(i.numWorkers--,i.statistics.requests++,i.statistics.size+=t.size||0,i.statistics.duration+=t.duration||0,i.statistics.speed=i.statistics.duration>0?i.statistics.size/i.statistics.duration:0,en(i.numWorkers>=0)),this._next()}_next(){for(let t of this._clients)if(t&&t.numWorkers<t.typeWorkerQuota&&this._processQueue(t))return;for(let t of this._clients)if(t&&this._processQueue(t))return}_processQueue(t){for(;t.tasks.length>0;)if(this._workerFunc(t.tasks.shift(),(i,r)=>this._taskCallback(i,r)))return t.numWorkers++,this._totalNumWorkers++,!0;return!1}_taskCallback(t,i){t._cancelled||(this._callbackFunc(t,i),this._taskFinished(t))}getStatsForType(t){let i=this._clients[t];return i?{quota:i.typeWorkerQuota,workers:i.numWorkers,queueSize:i.tasks.length,requestStats:i.statistics}:null}get test(){}};var cD=class{constructor(t,i){this.element=t,this.type="image+type",this.isOpaque=i==="image/jpeg"}};var Yy=class extends P{constructor(){super(...arguments),this._tasks=new Map,this._onLoadQueue=new Array,this._doneQueue=new Array,this.updating=!1}setup(e,t,i){this._loadQueue=new lD((r,n)=>this._startLoading(r,n),(r,n)=>this._doneLoadingCB(r,n),e,t),i&&(this._frameTask=i.registerTask(Xt.STREAM_DATA_LOADER,this))}destroy(){this._frameTask=Ft(this._frameTask),this._tasks.forEach(e=>xr(e.abortController)),this._loadQueue=G(this._loadQueue),this._onLoadQueue=null,this._doneQueue=null,this._tasks=null}hasDownloadSlots(e){return this._loadQueue.hasQuota(e)}request(e,t,i,r={}){let n=As();n.__signal=r!=null?r.signal:null;let s=this._createOrUpdateTask(e,t,i,r,n);return so(r,()=>this._cancelRequest(s,n)),n.promise}_createTask(e,t,i,r,n,s){let o=new hO(e,t,i,r,n);return this._updateTask(o,s),this._tasks.set(n,o),this._tasks.size===1&&this._set("updating",!0),this._loadQueue.push(o),o}_cancelRequest(e,t){Xv(e.resolvers,t),t.reject(Mr()),e.resolvers.length===0&&(e.status===ko.DOWNLOADING&&(e.status=ko.CANCELLED,this._loadQueue.cancel(e),e.abortController?.abort(),e.request=null,e.abortController=null),e.status=ko.CANCELLED,this._tasks.delete(e.key),this._tasks.size===0&&this._set("updating",!1))}_updateTask(e,t){e.resolvers.push(t)}_createOrUpdateTask(e,t,i,r,n){let s=cte(r?.uid||e,t,i),o=this._tasks.get(s);return o?(this._updateTask(o,n),o):this._createTask(e,r,t,i,s,n)}_doneLoadingCB(e,t){this._loadQueue&&(en(e.status===ko.DOWNLOADING),e.status=ko.DOWNLOADED,this._frameTask?this._doneQueue.push({task:e,err:t}):this._doneLoading(e,t))}get running(){return this._doneQueue.length>0||this._onLoadQueue.length>0}runTask(e){for(;!e.done&&this._onLoadQueue.length>0;){let t=this._onLoadQueue.shift();Ht(t.task.abortController),t.task.abortController=null,t.callback(t.task),e.madeProgress()}for(;!e.done&&this._doneQueue.length>0;){let t=this._doneQueue.shift();t.task.status!==ko.DOWNLOADED&&(t.err=t.err||Mr()),this._doneLoading(t.task,t.err),e.madeProgress()}}_doneLoading(e,t){if(t&&!qr(t)&&e.numRetries>0)return--e.numRetries,void this._loadQueue.push(e);let i=sm(e.result)||e.result instanceof HTMLImageElement?0:e.resolvers.length;for(let r of e.resolvers)if(t)qr(t)?r.reject(t):r.reject(new Be("stream-data-loader:request-error",`Failed to request resource at '${e.url}'. ${t}`,{url:e.url,error:t}));else{--i;let n=i>0?ro(e.result):e.result;r.resolve(n)}this._tasks.delete(e.key),this._tasks.size===0&&this._set("updating",!1)}_startLoading(e,t){if(e.status===ko.CANCELLED)return!1;let i,r;switch(e.startTime=performance.now(),e.status=ko.DOWNLOADING,e.docType){case"binary":r="array-buffer",i=0;break;case"image":r="image";break;case"image+type":r="array-buffer";break;default:r="json"}e.abortController=new AbortController;let n=e.abortController.signal;e.request=bp(e.url,be(ie({},e.options),{responseType:r,timeout:i,signal:n}));let s=a=>{e.duration=performance.now()-e.startTime,e.size=a instanceof ArrayBuffer?a.byteLength:e.size||0,e.result=a,this._frameTask?this._onLoadQueue.push({callback:t,task:e}):(e.abortController=null,t(e))},o=a=>{e.status===ko.DOWNLOADING&&t(e,a)};return e.docType!=="image+type"?(e.request.then(a=>s(a.data),o),!0):(e.request.then(a=>{let l=a.data,c=lte(l);if(r="image",e.size=l.byteLength,c==="unknown")return e.request=bp(e.url,{responseType:r,timeout:i,signal:n}),void e.request.then(m=>s(m.data),o);let h=new Blob([l],{type:c}),p=window.URL.createObjectURL(h);e.request=bp(p,{responseType:r,timeout:i,signal:n}),e.request.then(m=>s(new cD(m.data,c)),o).finally(()=>window.URL.revokeObjectURL(p))},o),!0)}get test(){}};u([d({readOnly:!0})],Yy.prototype,"updating",void 0),Yy=u([C("esri.views.3d.support.StreamDataLoader")],Yy);var ate={numRetries:0};function lte(e){if(e.byteLength<2)return"unknown";let t=new Uint8Array(e,0,e.byteLength);return t[0]===137&&t[1]===80?"image/png":t[0]===71&&t[1]===73?"image/gif":t[0]===66&&t[1]===77?"image/bmp":t[0]===255&&t[1]===216?"image/jpeg":"unknown"}var hO=class extends aD{constructor(t,i,r,n,s){super(n),this.url=t,this.options=i,this.docType=r,this.key=s,this.result=null,this.status=ko.QUEUED,this.request=null,this.abortController=null,this.resolvers=new Array,this.startTime=0,this.numRetries=ate.numRetries}};function cte(e,t,i){return`${e}:${t}:${i}`}var ko;(function(e){e[e.QUEUED=1]="QUEUED",e[e.DOWNLOADING=2]="DOWNLOADING",e[e.DOWNLOADED=3]="DOWNLOADED",e[e.CANCELLED=4]="CANCELLED"})(ko||(ko={}));var uD=class extends P{constructor(){super(...arguments),this.updating=!1}};function Gq(e){return new bl({view:e})}u([d({readOnly:!0})],uD.prototype,"updating",void 0),uD=u([C("esri.views.3d.support.ResourceController.ResourceControllerMain")],uD);var bl=class extends uD{constructor(){super(...arguments),this._immediateTask=Ed,this._normalTask=Ed,this._updatingObjects=On([]),this._frameTask=null}get immediate(){return this._immediateTask}get normal(){return this._normalTask}initialize(){this._scheduler=C0(),this._memoryController=T3(this.view),this._streamDataLoader=new Yy,this._streamDataLoader.setup(C3,b3,this._scheduler),this.addHandles([S(()=>this.view.state?.mode,e=>{e!=null&&(this._scheduler.state=e)},Fe),S(()=>this.view.stationary,()=>this._stationaryChangedHandler())]),this._frameTask=Jr({update:e=>this._frame(e)}),this._immediateTask=this._scheduler.registerTask(Xt.RESOURCE_CONTROLLER_IMMEDIATE),this._normalTask=this._scheduler.registerTask(Xt.RESOURCE_CONTROLLER)}destroy(){this._immediateTask.remove(),this._normalTask.remove(),this._frameTask=Ft(this._frameTask),this._streamDataLoader=G(this._streamDataLoader),this._memoryController=G(this._memoryController),this._scheduler=G(this._scheduler),this.view=null}get updating(){return!!(this._memoryController?.updating||this._streamDataLoader?.updating||this._immediateTask?.updating)||this._updatingObjects?.value.some(e=>e.updating)}get scheduler(){return this._scheduler}get memoryController(){return this._memoryController}createStreamDataRequester(e){let t=this._streamDataLoader;return{request:(i,r,n)=>t.request(i,r,e,n),get busy(){return!t.hasDownloadSlots(e)}}}addUpdatingObject(e){let t=this._updatingObjects;return t.value=[...t.value,e],_r(()=>{t.value=t.value.filter(i=>i!==e)})}_frame(e){this.view.suspended||this.view.stateManager&&(this.view.stateManager.step(r0(e.deltaTime)),!this._scheduler)||(this._memoryController.update(),this._scheduler.frame(e))}_stationaryChangedHandler(){this.memoryController.resetStableQuality()}get test(){}};u([d()],bl.prototype,"view",void 0),u([d()],bl.prototype,"_scheduler",void 0),u([d()],bl.prototype,"_memoryController",void 0),u([d()],bl.prototype,"_streamDataLoader",void 0),u([d()],bl.prototype,"_immediateTask",void 0),u([d()],bl.prototype,"_normalTask",void 0),u([d({readOnly:!0})],bl.prototype,"updating",null),bl=u([C("esri.views.3d.support.ResourceController")],bl);var dD=class{constructor(t){this.layer=null,this.memory=0,this.displayedNumberOfFeatures=0,this.maximumNumberOfFeatures=null,this.totalNumberOfFeatures=null,this.layer=t.layer;let i=t.performanceInfo;this.memory=i.usedMemory,this.displayedNumberOfFeatures=i.displayedFeatures,this.maximumNumberOfFeatures=i.maximumFeatures,this.totalNumberOfFeatures=i.totalFeatures}};var hD=class{constructor(t){if(this.totalMemory=0,this.usedMemory=0,this.quality=1,this.load=0,this.terrainMemory=0,this.edgesMemory=0,this.layerPerformanceInfos=new Array,this.cachedMemory=0,this.fboMemory=0,t.resourceController!=null){let i=t.resourceController.memoryController;this.totalMemory=(i.maxMemory??0)*HL.MEGABYTES,this.usedMemory=Math.round(i.usedMemory*this.totalMemory),this.quality=t.quality,this.load=t.resourceController.scheduler.load,this.cachedMemory=i.usedCacheMemory}this.terrainMemory=t.basemapTerrain?.usedMemory??0,this.edgesMemory=t._stage?.renderer.usedMemory.edges??0,this.fboMemory=t._stage?.renderer.usedMemory.fbos??0,t.allLayerViews?.items.forEach(i=>{kV(i)&&this.layerPerformanceInfos.push(new dD(i))}),this.layerPerformanceInfos.sort((i,r)=>r.memory-i.memory)}};var pD=class{constructor(t){this._gltfLoading=new Map,this._wosrLoading=new Map,this._gltfMemCache=t("gltf-resources",()=>{}),this._wosrMemCache=t("wosr-resources",()=>{})}destroy(){this._gltfLoading.forEach(t=>t.abortController.abort()),this._wosrLoading.forEach(t=>t.abortController.abort()),this._gltfMemCache.destroy(),this._wosrMemCache.destroy()}loadGLTF(t,i,r){let n=r?`gltfPBR:${t}`:`gltf:${t}`,s=this._gltfMemCache.get(n);return s!=null?Promise.resolve(s):qq(this._gltfLoading,this._gltfMemCache,n,async o=>{let{loadGLTF:a}=await import("./chunk-THC27IVH.js");return a(new uF(o.streamDataRequester),t,o,r)},i)}loadWOSR(t,i){let r=`wosr:${t}:${i.disableTextures}`,n=this._wosrMemCache.get(r);return n!=null?Promise.resolve(n):qq(this._wosrLoading,this._wosrMemCache,r,s=>wk(t,s),i)}};async function qq(e,t,i,r,n){Ht(n);let s=so(n,()=>ute(e,i)),o=e.get(i);if(o)o.refCount++;else{let a=new AbortController;o={refCount:1,abortController:a,promise:r(be(ie({},n),{signal:a.signal}))},e.set(i,o)}try{let a=await o.promise;return t.put(i,a),e.delete(i),Ht(n),a}finally{Ft(s)}}function ute(e,t){let i=e.get(t);i!=null&&--i.refCount>0||(e.delete(t),i?.abortController.abort())}var ld=class extends P{constructor(e,t){super({}),this._stage=e,this._textureRequests=new Map,this._frameTask=t?.registerTask(Xt.TEXTURE_UNLOAD)??Ed}normalizeCtorArgs(){return{}}destroy(){super.destroy(),this._frameTask?.remove(),this._textureRequests?.forEach(e=>this._releaseTextureRequest(e)),this._textureRequests?.clear()}get updating(){return this._frameTask.updating}fromData(e,t){let i=this.makeUid(e),r=this._textureRequests.get(i);if(!r){let n=new Xy;n.texture=t(),this._stage&&(n.texture.load(this._stage.renderView.renderingContext),this._stage.add(n.texture)),this._textureRequests.set(i,n),r=n}return r.referenceCount++,new Ky(i,r.texture,()=>this._release(i))}_release(e){let t=this._textureRequests.get(e);t?(t.referenceCount<1&&console.warn("TextureCollection: reference count is < 1 for "+e),t.referenceCount--,t.referenceCount<1&&this._frameTask.schedule(()=>this._releaseNow(e))):console.warn(`TextureCollection: texture doesn't exist: '${e}'`)}get test(){}_releaseNow(e){if(!this._textureRequests)return;let t=this._textureRequests.get(e);!t||t.referenceCount>0||(t.texture?.unload(),this._releaseTextureRequest(t),this._textureRequests.delete(e))}_releaseTextureRequest(e){e.texture?this._stage?.remove(e.texture):e.abortController&&(e.abortController.abort(),e.abortController=null)}makeUid(e,t=null){return t!=null?`${e}.${t}px`:e}};u([d()],ld.prototype,"_frameTask",void 0),u([d()],ld.prototype,"updating",null),ld=u([C("esri.views.3d.support.TextureCollection")],ld);var Ky=class{constructor(t,i,r){this.uid=t,this.texture=i,this.release=r}},Xy=class{constructor(){this.referenceCount=0}};var mD=class extends ld{constructor(t,i,r){super(i,r),this._streamDataRequester=t}async fromUrl(t,i,r){Ht(r);let n=r?.signal,s=this.makeUid(t,i),o=this._textureRequests.get(s);if(!o){let a=new AbortController,l=this._streamDataRequester.request(t,"image",{uid:s,signal:a.signal});o=new Xy,o.abortController=a;let c=o;this._textureRequests.set(s,o),o.textureAsync=l.then(async h=>{let p=this._createTexture(t,h,i);return c.texture=p,c.abortController=null,await p.load(this._stage.renderView.renderingContext),this._stage.add(p),new Ky(s,p,()=>this._release(s))},h=>{throw c.abortController=null,h})}o.referenceCount++;try{return await t0(o.textureAsync,n)}catch(a){throw this._release(s),a}}_createTexture(t,i,r){let n={width:i.width,height:i.height,wrap:{s:ji.CLAMP_TO_EDGE,t:ji.CLAMP_TO_EDGE},preMultiplyAlpha:!0,reloadable:!0};if(a0(t)){if(r||i.width===0&&i.height===0){let s=i.width?i.height/i.width:1;r=r||64,s>1?(i.width=Math.round(r/s),i.height=r):(i.width=r,i.height=Math.round(r*s))}this._stage.renderView?.renderingContext.driverTest.svgPremultipliesAlpha.result&&(n.preMultiplyAlpha=!1)}return new sk(i,n)}};var gD=class{constructor(t){this.streamDataRequester=null,this._graphicsOwners=[],this._screenSizePerspectiveHandles=null,this.cimSymbolRasterizer=null,this._viewState=t.viewState,this._view=t.view,this._pointsOfInterest=t.pointsOfInterest,this.streamDataRequester=t.resourceController.createStreamDataRequester(n_.SYMBOLOGY),this.objectResourceCache=new pD((r,n)=>t.resourceController.memoryController.newCache(r,n)),this.textures=new mD(this.streamDataRequester,t.view._stage,t.resourceController.scheduler);let i=_t(this._view.spatialReference).radius;this.screenSizePerspectiveSettings=$0(t.viewingMode,i),this.screenSizePerspectiveSettingsLabels=VF(t.viewingMode,i)}destroy(){this.textures.destroy(),this.streamDataRequester=null}addGraphicsOwner(t){if(!t)return _r();this._graphicsOwners.push(t);let i=S(()=>t.layer?.screenSizePerspectiveEnabled,()=>this._updateScreenSizePerspectiveEnabled());return this._updateScreenSizePerspectiveEnabled(),_r(()=>{i.remove(),Xv(this._graphicsOwners,t),this._updateScreenSizePerspectiveEnabled()})}_updateScreenSizePerspectiveEnabled(){let t=this._graphicsOwners.some(i=>i.layer?.screenSizePerspectiveEnabled===!0);if(t&&!this._screenSizePerspectiveHandles){this._screenSizePerspectiveHandles=new Pa;let i=()=>this._updateScreenSizePerspectiveSettings();this._screenSizePerspectiveHandles.add([S(()=>this._pointsOfInterest.centerOnSurfaceInfrequent.distance,i,Fe),this._viewState.events.on("camera-projection-changed",i)]),this._updateScreenSizePerspectiveSettings()}else t||(this._screenSizePerspectiveHandles=G(this._screenSizePerspectiveHandles))}_updateScreenSizePerspectiveSettings(){let t=this._pointsOfInterest;fD.distance=t.centerOnSurfaceInfrequent.distance,fD.fovY=this._viewState.camera.fovY,this.screenSizePerspectiveSettings.update(fD),this.screenSizePerspectiveSettingsLabels.update(fD),this._view._stage.renderView.requestRender()}get test(){}},fD={distance:0,fovY:0};var pO=class{constructor(t){this.destination=t}hide(){this.graphic!=null&&(this.destination.remove(this.graphic),this.graphic=null)}},Cl=class extends pO{constructor(t,i,r=""){super(t),this._symbol=new eF({symbolLayers:new lt([new XL({material:{color:i},outline:{color:[255,255,255],size:1},resource:{primitive:"circle"}}),new JL({text:r,halo:{color:"white",size:1/.75},material:{color:i},size:12})])})}show(t,i){if(!i)return;this.hide();let r=new pt({x:t[0],y:t[1],z:t[2],spatialReference:i});this.graphic=new rs({geometry:r,symbol:this._symbol}),this.destination.add(this.graphic)}};var Ea=class extends P{constructor(e){super(e)}};u([d({constructOnly:!0})],Ea.prototype,"renderCoordsHelper",void 0),u([d({constructOnly:!0})],Ea.prototype,"surface",void 0),u([d({constructOnly:!0})],Ea.prototype,"state",void 0),Ea=u([C("esri.views.3d.support.pointsOfInterest.PointOfInterest")],Ea);var dte=Array,Vo=class extends Ea{constructor(e){super(e),this._dirty=!1,this._propertiesPool=new Vn({location:pt,renderLocation:dte},this),this._estimatedSurfaceAltitude=0,this._pendingElevationQueryController=null,this.renderLocation=w(),this._tmpPoint=new pt}initialize(){if(this.scheduler&&this.addHandles(this.scheduler.registerTask(this.task,this)),this.runTask(),this.map){let e=()=>this._setDirty();this.addHandles(tr(()=>this.map?.ground?.layers,"change",e,{onListenerAdd:e,onListenerRemove:e}))}this._updateRenderLocation()}destroy(){this._cancelPendingRequest(),this._propertiesPool=G(this._propertiesPool)}get _camera(){return this.state.contentCamera}get location(){let e=this._propertiesPool.get("location");return e.spatialReference=this.state.spatialReference,this.renderCoordsHelper.fromRenderCoords(this.renderLocation,e),e}get scale(){let e=this._camera,t=ui(e.eye,this.renderLocation),i={renderCoordsHelper:this.renderCoordsHelper,state:{camera:e}};return au(i,t)}get updating(){return this._dirty||this._pendingElevationQueryController!=null}updateRenderLocation(){this._setDirty(),this._updateRenderLocation()}_setDirty(){this._dirty||(this._dirty=!0,this.notifyChange("updating"))}_cancelPendingRequest(){let e=this._pendingElevationQueryController;e&&(this._pendingElevationQueryController=null,e.abort(),this.notifyChange("updating"))}get running(){return!this._pendingElevationQueryController&&this._dirty}runTask(){if(this._cancelPendingRequest(),this._dirty=!1,this.notifyChange("updating"),!this.map?.ground)return this._updateSurfaceAltitude(0),Ui;let e=this.state.spatialReference;this._tmpPoint.spatialReference=e,this.renderCoordsHelper.fromRenderCoords(this._camera.eye,this._tmpPoint);let t=(this._tmpPoint.z??0)>hte&&this.renderCoordsHelper.viewingMode===Se.Global&&(e.isWGS84||e.isWebMercator),i=new AbortController;return this.map.ground.queryElevation(this._tmpPoint,{signal:i.signal,cache:this.cache,minDemResolution:t?pte:0}).then(r=>this._updateSurfaceAltitude(r.geometry.z??0)).catch(r=>{qr(r)||this._updateSurfaceAltitude(0)}).catch(()=>{}).then(()=>{this._pendingElevationQueryController===i&&(this._pendingElevationQueryController=null,this.notifyChange("updating")),i=null}),this._pendingElevationQueryController=i,Ui}_updateSurfaceAltitude(e){this._estimatedSurfaceAltitude!==e&&(this._estimatedSurfaceAltitude=e,this._updateRenderLocation())}_updateRenderLocation(){this.renderCoordsHelper.setAltitude(mO,this._estimatedSurfaceAltitude,this._camera.eye),Rp(this._get("renderLocation"),mO)||(this._set("renderLocation",ee(this._propertiesPool.get("renderLocation"),mO)),this.notifyChange("renderLocation"))}};u([d({constructOnly:!0})],Vo.prototype,"scheduler",void 0),u([d({constructOnly:!0})],Vo.prototype,"cache",void 0),u([d({constructOnly:!0})],Vo.prototype,"task",void 0),u([d()],Vo.prototype,"location",null),u([d({constructOnly:!0})],Vo.prototype,"map",void 0),u([d()],Vo.prototype,"renderLocation",void 0),u([d()],Vo.prototype,"scale",null),u([d()],Vo.prototype,"updating",null),Vo=u([C("esri.views.3d.support.pointsOfInterest.CameraOnSurface")],Vo);var mO=w(),hte=1e5,pte=1e6;var mte=Array,Ys=class extends Ea{constructor(e){super(e),this._propertiesPool=new Vn({location:pt,renderLocation:mte},this),this._currentSurfaceAltitude=0,this._latestSurfaceAltitude=0,this.distance=0,this.renderLocation=w(),this.updating=!1}initialize(){this._frameWorker=this.scheduler.registerTask(this.task,this),this.runTask()}destroy(){this._frameWorker=Ft(this._frameWorker),this._propertiesPool=G(this._propertiesPool)}get _camera(){return this.state.contentCamera}get location(){let e=this._propertiesPool.get("location");return e.spatialReference=this.state.spatialReference,this.renderCoordsHelper.fromRenderCoords(this.renderLocation,e),e}updateRenderLocation(){this.updating=!0,this._updateRenderLocation()}get estimatedSurfaceAltitude(){return this._latestSurfaceAltitude}get running(){return this.updating}runTask(){return this._latestSurfaceAltitude=this.estimateSurfaceAltitudeAtCenter(),this._updateRenderLocation(),this.updating=!1,Ui}_updateRenderLocation(){let e=gte,t=this._calculateSurfaceIntersection(this._currentSurfaceAltitude,e),i=this._currentSurfaceAltitude!==this._latestSurfaceAltitude;!t&&i&&(t=this._calculateSurfaceIntersection(this._latestSurfaceAltitude,e),t&&(this._currentSurfaceAltitude=this._latestSurfaceAltitude));let r=_te;t&&this._latestSurfaceAltitudeChangesDistanceSignificantly(e,r)&&(ee(e,r),this._currentSurfaceAltitude=this._latestSurfaceAltitude),t?this.distance=ui(this._camera.eye,e):(X(e,this._camera.viewForward,this._get("distance")),he(e,e,this._camera.eye)),Rp(this._get("renderLocation"),e)||this._set("renderLocation",ee(this._propertiesPool.get("renderLocation"),e))}_calculateSurfaceIntersection(e,t){let i=this._camera;if(!this.renderCoordsHelper.intersectInfiniteManifold(i.ray,e,t))return!1;if(this.state.isGlobal){let r=_t(this.renderCoordsHelper.spatialReference).radius,n=r+e,s=Ir(i.eye),o=s<n*n,a=ui(i.eye,t);if(o&&a>r/4){let l=n-Math.sqrt(s);return X(t,i.viewForward,l),he(t,t,i.eye),!0}}else{let r=this.surface?.ready?this.surface.extent:null;r!=null&&Tw(r,this.surface?.spatialReference,Jy,this.renderCoordsHelper.spatialReference)&&(t[0]=q(t[0],Jy[0],Jy[2]),t[1]=q(t[1],Jy[1],Jy[3]))}return!0}_latestSurfaceAltitudeChangesDistanceSignificantly(e,t){if(this._latestSurfaceAltitude===this._currentSurfaceAltitude||e==null)return!1;if(this._calculateSurfaceIntersection(this._latestSurfaceAltitude,t)){if(ur.TESTS_DISABLE_OPTIMIZATIONS)return!0;let i=this._camera.eye,r=ui(i,e),n=ui(i,t);if(Math.abs(n-r)/r>fte)return!0}return!1}};u([d({constructOnly:!0})],Ys.prototype,"scheduler",void 0),u([d({constructOnly:!0})],Ys.prototype,"task",void 0),u([d()],Ys.prototype,"distance",void 0),u([d({constructOnly:!0})],Ys.prototype,"estimateSurfaceAltitudeAtCenter",void 0),u([d({readOnly:!0})],Ys.prototype,"location",null),u([d({readOnly:!0})],Ys.prototype,"renderLocation",void 0),u([d()],Ys.prototype,"updating",void 0),Ys=u([C("esri.views.3d.support.pointsOfInterest.CenterOnSurface")],Ys);var fte=.05,gte=w(),_te=w(),Jy=Yt();var _D=class{constructor(t){this._handles=new Pa,this.events=new oi,this._contentLayerViews=t.contentLayerViews,this._handles.add(this._contentLayerViews.on("change",i=>this._layerViewsChanged(i))),this._layerViewsChanged({added:this._contentLayerViews.toArray(),removed:[],moved:[],target:this._contentLayerViews})}destroy(){this._handles=G(this._handles),this._contentLayerViews.destroy()}_layerViewsChanged(t){t.added.forEach(i=>{i.declaredClass==="esri.views.3d.layers.SceneLayerView3D"&&this._handles.add(i.on("visible-geometry-changed",()=>this._contentChanged()),i.uid)}),t.removed.forEach(i=>this._handles.remove(i.uid))}_contentChanged(){this.events.emit("request-update",yte)}},yte={};var vte=Array,Ho=class extends Ea{constructor(e){super(e),this._propertiesPool=new Vn({location:pt,renderLocation:vte},this),this._dirty=!0,this.renderLocation=this._propertiesPool.get("renderLocation")}initialize(){this.addHandles([S(()=>this.centerOnSurface.renderLocation,()=>this.updateRenderLocation()),S(()=>this.state.contentCamera,()=>this.updateRenderLocation())]),this.scheduler&&this.addHandles(this.scheduler.registerTask(Xt.POINT_OF_INTEREST_FREQUENT,this))}destroy(){this._propertiesPool=G(this._propertiesPool)}get updating(){return this._dirty||this.centerOnSurface.updating}get location(){let e=this._propertiesPool.get("location");return e.spatialReference=this.state.spatialReference,this.renderCoordsHelper.fromRenderCoords(this.renderLocation,e),e}get worldUnitsPerContentPixel(){let{camera:e,contentPixelRatio:t}=this.state;return e.computeRenderPixelSizeAt(this.renderLocation)*(e.pixelRatio/t)}get running(){return this._dirty}runTask(){let e=this._get("renderLocation"),t=this.centerOnSurface.renderLocation,i=this.renderCoordsHelper,r=this.state.contentCamera;this._dirty=!1,i.worldUpAtPosition(t,Wq);let n=Math.max(0,(Math.acos(ae(Wq,r.viewForward))-.5*Math.PI)*(r.aboveGround?1:-1));if(Number.isNaN(n)){if(!e||!zc(e,t)){let l=this._propertiesPool.get("renderLocation");ee(l,t),this._set("renderLocation",l)}return Ui}let s=1-q(n/(.5*Math.PI),0,1),o=s*s*s;this._calculateScreenHorizontalEdgeOnSurface($q);let a=this._propertiesPool.get("renderLocation");return ni(a,t,$q,o),e&&zc(e,a)||this._set("renderLocation",a),Ui}_calculateScreenHorizontalEdgeOnSurface(e){let t=this.state.contentCamera,i=t.getRenderCenter(bd());if(i[1]=t.aboveGround?t.padding[rn.BOTTOM]:t.fullHeight-t.padding[rn.TOP],this.estimateSurfaceIntersectionAtRenderPoint(i,e))return e;let r=this.renderCoordsHelper.getAltitude(this.centerOnSurface.renderLocation);if(t.unprojectFromRenderScreen(i,ev)){ve(ev,ev,t.eye);let n=ne(ev,ev);if(this.renderCoordsHelper.intersectInfiniteManifold(ia(t.eye,n),r,e))return e}return this.renderCoordsHelper.setAltitude(e,r,t.eye)}updateRenderLocation(){this._dirty=!0}};u([d()],Ho.prototype,"_dirty",void 0),u([d({constructOnly:!0})],Ho.prototype,"scheduler",void 0),u([d({constructOnly:!0})],Ho.prototype,"centerOnSurface",void 0),u([d({constructOnly:!0})],Ho.prototype,"estimateSurfaceIntersectionAtRenderPoint",void 0),u([d()],Ho.prototype,"updating",null),u([d()],Ho.prototype,"location",null),u([d()],Ho.prototype,"renderLocation",void 0),u([d()],Ho.prototype,"worldUnitsPerContentPixel",null),Ho=u([C("esri.views.3d.support.pointsOfInterest.Focus")],Ho);var Wq=w(),ev=w(),$q=w();var Tl=class extends P{get surface(){return this.view.map?.ground}get surfaceView(){return this.view.basemapTerrain}get renderLocation(){if(!this.location)return null;let e=w();return this.view.renderCoordsHelper.toRenderCoords(this.location,e),e}constructor(e){super(e),this.location=null,this._updateController=null}initialize(){this.view.state.isLocal&&(this.addHandles([S(()=>[this.surfaceView?.spatialReference,this.surfaceView?.extent],()=>this._update()),tr(()=>this.surface?.layers,"change",()=>this._update())]),this._update())}_update(){if(this._updateController&&(this._updateController.abort(),this._updateController=null),this.surfaceView?.extent==null||this.surfaceView.spatialReference==null)return void this._set("location",null);let e=f0(this.surfaceView.extent),t=new pt({x:e[0],y:e[1],z:0,spatialReference:this.surfaceView.spatialReference});this.surface&&this.surface.layers.length>0?(this._set("location",null),this._updateController=new AbortController,this.surface.queryElevation(t,{noDataValue:0,signal:this._updateController.signal,cache:this.cache}).then(i=>{this._updateController=null,this._set("location",i.geometry)}).catch(i=>{})):this._set("location",t)}};u([d({constructOnly:!0})],Tl.prototype,"view",void 0),u([d({constructOnly:!0})],Tl.prototype,"cache",void 0),u([d()],Tl.prototype,"surface",null),u([d()],Tl.prototype,"surfaceView",null),u([d({readOnly:!0})],Tl.prototype,"location",void 0),u([d({readOnly:!0})],Tl.prototype,"renderLocation",null),Tl=u([C("esri.views.3d.support.pointsOfInterest.StableSurfaceCenter")],Tl);var El=class extends P{constructor(e){super(e),this._tileGeometryUpdateExtent=Yo(),this._tileGeometryUpdateSpatialReference=null,this.events=new oi,this.updating=!1}initialize(){this.addHandles([this.surface.on("elevation-change",e=>this._tileGeometryChanged(e)),this.scheduler.registerTask(Xt.SURFACE_GEOMETRY_UPDATES,this)])}get running(){return this.updating}runTask(){return this.updating?(this._tileGeometryUpdateSpatialReference&&this._centerIntersectsExtent(this._tileGeometryUpdateExtent,this._tileGeometryUpdateSpatialReference)&&this.events.emit("request-update",wte),Yo(this._tileGeometryUpdateExtent),this._set("updating",!1),Ui):Ui}_tileGeometryChanged(e){this._tileGeometryUpdateSpatialReference=e.spatialReference,ka(this._tileGeometryUpdateExtent,e.extent,this._tileGeometryUpdateExtent),this._set("updating",!0)}_furthestCenterOnSurface(){let e=this.centerOnSurfaces[0];for(let t=1;t<this.centerOnSurfaces.length;t++){let i=this.centerOnSurfaces[t];i.distance>e.distance&&(e=i)}return e}_centerIntersectsExtent(e,t){let i=this.state.contentCamera.eye,r=bte,n=this._furthestCenterOnSurface();return this.renderCoordsHelper.fromRenderCoords(i,Xh,t),this.renderCoordsHelper.fromRenderCoords(n.renderLocation,Jh,t),Xh[0]<Jh[0]?(r[0]=Xh[0],r[2]=Jh[0]):(r[0]=Jh[0],r[2]=Xh[0]),Xh[1]<Jh[1]?(r[1]=Xh[1],r[3]=Jh[1]):(r[1]=Jh[1],r[3]=Xh[1]),Bl(r,e)}};u([d({constructOnly:!0})],El.prototype,"state",void 0),u([d({constructOnly:!0})],El.prototype,"centerOnSurfaces",void 0),u([d({constructOnly:!0})],El.prototype,"renderCoordsHelper",void 0),u([d({constructOnly:!0})],El.prototype,"scheduler",void 0),u([d({constructOnly:!0})],El.prototype,"surface",void 0),u([d({readOnly:!0})],El.prototype,"updating",void 0),El=u([C("esri.views.3d.support.pointsOfInterest.SurfaceGeometryUpdates")],El);var wte={},Xh=w(),Jh=w(),bte=Yo();var Sn=class extends P{constructor(e){super(e),this.renderPointOfView=w(),this._pois=new Array,this._debugCenters=null,this._tmpRay=Os(),this._centerRayDirty=!0,this._surfaceAltitudeAtCenter=0,this._surfaceAltitudeAtCenterDirty=!0,this._contentAltitudeAtCenter=0,this._contentAltitudeAtCenterDirty=!0,this._propertiesPool=new Vn({renderPointOfView:Cte},this)}initialize(){let{state:e,basemapTerrain:t,renderCoordsHelper:i,map:r}=this.view;this._surfaceIntersector=nn(e.viewingMode),this._surfaceIntersector.options.invisibleTerrain=!1,this._surfaceIntersector.options.store=fo.MIN,this._contentIntersector=nn(e.viewingMode);let n=()=>this._estimateSurfaceAltitudeAtCenter(),s=this.view.resourceController.scheduler,o=this.view.basemapTerrain?.elevationQueryCache,a={state:e,scheduler:s,surface:t,renderCoordsHelper:i};this._set("centerOnSurfaceInfrequent",new Ys(be(ie({},a),{task:Xt.POINT_OF_INTEREST_INFREQUENT,estimateSurfaceAltitudeAtCenter:n}))),this._set("centerOnSurfaceFrequent",new Ys(be(ie({},a),{task:Xt.POINT_OF_INTEREST_FREQUENT,estimateSurfaceAltitudeAtCenter:n}))),this._set("centerOnContent",new Ys(be(ie({},a),{task:Xt.POINT_OF_INTEREST_FREQUENT,estimateSurfaceAltitudeAtCenter:()=>this._estimateContentAltitudeAtCenter()}))),this._set("cameraOnSurface",new Vo(be(ie({},a),{cache:o,task:Xt.POINT_OF_INTEREST_INFREQUENT,map:r}))),this._set("surfaceGeometryUpdates",new El(be(ie({},a),{centerOnSurfaces:[this.centerOnSurfaceFrequent,this.centerOnContent,this.centerOnSurfaceInfrequent]}))),this._set("contentGeometryUpdates",new _D({contentLayerViews:this.view.allLayerViews,renderCoordsHelper:i})),this._set("surfaceOrigin",new Tl({cache:o,view:this.view})),this._set("focus",new Ho({state:e,scheduler:s,surface:t,renderCoordsHelper:i,centerOnSurface:this.centerOnSurfaceFrequent,estimateSurfaceIntersectionAtRenderPoint:(l,c)=>this._estimateSurfaceIntersectionAtRenderPoint(l,this.view.state.contentCamera,c)})),this._pois.push(this.centerOnContent,this.centerOnSurfaceFrequent,this.centerOnSurfaceInfrequent,this.cameraOnSurface,this.focus),this.addHandles([S(()=>e.contentCamera,l=>this._cameraChanged(l),Fe),S(()=>t.extent,()=>this._updateCenterPointsOfInterest()),S(()=>this.view.map?.ground?.navigationConstraint?.type,l=>{this._surfaceIntersector.options.backfacesTerrain=l==="none"},Re),Wi(()=>!t.updating,()=>this._updateCenterPointsOfInterest(),Fe),tr(()=>this.surfaceGeometryUpdates.events,"request-update",()=>this._updateCenterPointsOfInterest()),tr(()=>this.contentGeometryUpdates.events,"request-update",()=>this._updateCenterOnContent()),S(()=>ur.SHOW_POI,l=>this._setDebug(l),Re)]),this._cameraChanged(this.view.state.contentCamera);for(let l of this._pois)l.runTask()}destroy(){this._setDebug(!1),this._propertiesPool.destroy();for(let e of this._pois)e.destroy();this.surfaceOrigin.destroy()}get updating(){return!(!this.surfaceGeometryUpdates?.updating&&!this._pois.some(e=>e.updating))}get _centerRay(){return this._centerRayDirty&&(this._centerRayCached=this.view.sceneIntersectionHelper.getCenterRayWithSubpixelOffset(this.view.state.contentCamera,this._tmpRay),this._centerRayDirty=!1),this._centerRayCached}_estimateContentAltitudeAtCenter(){if(!this._contentAltitudeAtCenterDirty)return this._contentAltitudeAtCenter;this._contentAltitudeAtCenterDirty=!1;let e=this._centerRay;return e==null||(this.view.sceneIntersectionHelper.intersectRay(e,this._contentIntersector,Wf,Ete)?this._contentAltitudeAtCenter=this.view.renderCoordsHelper.getAltitude(Wf):this._contentAltitudeAtCenter=this._estimateSurfaceAltitudeAtCenter()),this._contentAltitudeAtCenter}_estimateSurfaceAltitudeAtCenter(){if(!this.view.basemapTerrain)return 0;if(!this._surfaceAltitudeAtCenterDirty)return this._surfaceAltitudeAtCenter;this._surfaceAltitudeAtCenterDirty=!1;let e=this._centerRay;if(e==null)return this._surfaceAltitudeAtCenter;let t=e.origin,i=he(Wf,e.origin,e.direction);return this._surfaceIntersector.resetWithRay(e,this.view.state.contentCamera),this.view.basemapTerrain.intersect(this._surfaceIntersector,null,t,i),this._surfaceIntersector.results.min.getIntersectionPoint(Wf)&&(this._surfaceAltitudeAtCenter=this.view.renderCoordsHelper.getAltitude(Wf)),this._surfaceAltitudeAtCenter}_estimateSurfaceIntersectionAtRenderPoint(e,t,i){let r=Cw(t,e,Tte);if(r==null)return null;let n=r.origin,s=he(Wf,r.origin,r.direction);return this._surfaceIntersector.resetWithRay(r,t),this.view.basemapTerrain.intersect(this._surfaceIntersector,null,n,s),this._surfaceIntersector.results.min.getIntersectionPoint(i)?i:null}_cameraChanged(e){this._updateCenterPointsOfInterest();let t=e.eye;Rp(this.renderPointOfView,t)||this._set("renderPointOfView",ee(this._propertiesPool.get("renderPointOfView"),t))}_updateCenterPointsOfInterest(){this._centerRayDirty=!0,this._surfaceAltitudeAtCenterDirty=!0,this._contentAltitudeAtCenterDirty=!0;for(let e of this._pois)e.updateRenderLocation()}_updateCenterOnContent(){this._contentAltitudeAtCenterDirty=!0,this.centerOnContent.updateRenderLocation()}_setDebug(e){if(!e)return this._debugCenters?.forEach(t=>t.hide()),void this.removeHandles("debug");if(!this._debugCenters){this._debugCenters=new Map;let t=this.view.graphics;this._debugCenters.set(this.centerOnContent,new Cl(t,"red","CenterOnContent")),this._debugCenters.set(this.centerOnSurfaceFrequent,new Cl(t,"red","CenterOnSurface")),this._debugCenters.set(this.centerOnSurfaceInfrequent,new Cl(t,"red","CenterOnSurface")),this._debugCenters.set(this.cameraOnSurface,new Cl(t,"blue","CameraOnSurface")),this._debugCenters.set(this.focus,new Cl(t,"green","Focus"))}for(let t of this._pois)this.addHandles(S(()=>t.renderLocation,i=>this._debugCenters?.get(t)?.show(i,t.renderCoordsHelper.spatialReference),Re),"debug")}get test(){}};u([d()],Sn.prototype,"centerOnContent",void 0),u([d()],Sn.prototype,"centerOnSurfaceFrequent",void 0),u([d()],Sn.prototype,"centerOnSurfaceInfrequent",void 0),u([d()],Sn.prototype,"cameraOnSurface",void 0),u([d()],Sn.prototype,"focus",void 0),u([d()],Sn.prototype,"renderPointOfView",void 0),u([d()],Sn.prototype,"surfaceOrigin",void 0),u([d()],Sn.prototype,"contentGeometryUpdates",void 0),u([d()],Sn.prototype,"surfaceGeometryUpdates",void 0),u([d({constructOnly:!0})],Sn.prototype,"view",void 0),u([d()],Sn.prototype,"updating",null),Sn=u([C("esri.views.3d.support.pointsOfInterest.PointsOfInterest")],Sn);var Cte=Array,Wf=w(),Tte=Os(),Ete={exclude:new Set([Wl])};var Dte=()=>W.getLogger("esri/core/MemCachePool"),Bo=class{constructor(t,i){this._cache=t(i,(r,n,s)=>{switch(n){case Hx.ALL:return r.forEach(o=>o.dispose()),0;case Hx.SOME:{let o=r.shift();return o?(s-=Math.round(o.cachedMemory),o.dispose()):s>0&&(Dte().warn("Encountered empty MemCachePool with non-zero memory."),s=0),s}}})}hitrate(){return this._cache.hitRate}destroy(){this._cache.destroy()}clear(){this._cache.clear()}getSize(t){return this._cache.getSize(t)}pop(t){let i=this._cache.peek(t);if(!i)return;let r=i.pop();return i.length>0?r&&(i.cachedMemory=this._cache.getSize(t)-Math.round(r.cachedMemory),this._cache.updateSize(t,i)):this._cache.pop(t),r}put(t,i,r=J2){let n=this._cache.peek(t);if(n)n.push(i),n.cachedMemory=this._cache.getSize(t)+Math.round(i.cachedMemory),this._cache.updateSize(t,n);else{let s=new fO(i);this._cache.put(t,s,r)}}},fO=class extends Array{constructor(t){super(),this.item=t,this.cachedMemory=t.cachedMemory,this.push(t)}};var yD=class{constructor(t){this._store=t}destroy(){this._store.destroy()}get(t){return this._store.get(t)}put(t,i){this._store.put(t,i)}};var Dl=class{constructor(t=0,i=0){this.min=t,this.max=i,this.level=0,this.hasNoDataValues=!1}copyFrom(t){this.min=t.min,this.max=t.max,this.level=t.level,this.hasNoDataValues=t.hasNoDataValues}};var vD=class{constructor(t,i,r){this.type="elevation",this.level=t[0],this.i=t[1],this.j=t[2],this.extent=i,this.samplerData=new Dk(r,i)}computeMinMaxValue(t,i,r,n){n.min=1/0,n.max=-1/0,n.hasNoDataValues=!1;let s=t-this.level;if(s<=0)return n;let o=2**s;if(!(Math.floor(i/o)===this.i&&Math.floor(r/o)===this.j))return n;let a=1/0,l=-1/0,c=this.samplerData.data.width,h=this.samplerData.data.values,p=.5*t_,m=(c-1)/o,f=(r-this.j*o)*m,g=(i-this.i*o)*m;if(m<1){let _=Math.floor(f),v=Math.floor(g),b=_+v*c,x=h[b],E=h[b+1],D=h[b+c],M=h[b+c+1];if(x+E+D+M<p){let T=f-_,I=g-v,A=jg(x,E,D,M,T,I),O=jg(x,E,D,M,T+m,I),$=jg(x,E,D,M,T,I+m),H=jg(x,E,D,M,T+m,I+m);return n.min=Math.min(A,O,$,H),n.max=Math.max(A,O,$,H),n}f=_,g=v,m=1}else f=Math.floor(f),g=Math.floor(g),m=Math.ceil(m);for(let _=f;_<=f+m;_++)for(let v=g;v<=g+m;v++){let b=h[_+v*c];b<p?(a=Math.min(a,b),l=Math.max(l,b)):n.hasNoDataValues=!0}return n.min=a,n.max=l,n}},xte=.5*t_;function gi(e,t,i){if(i==null)return null;for(let r of i){if(!r)continue;let n=r.safeWidth,s=q(r.dy*(r.y1-t),0,n),o=q(r.dx*(e-r.x0),0,n),a=Math.floor(s),l=Math.floor(o),c=r.data.width,h=a*c+l,p=r.data.values,m=p[h],f=p[h+1],g=h+c,_=p[g],v=p[g+1];if(m+_+f+v<xte){s-=a,o-=l;let b=m+(f-m)*o;return b+(_+(v-_)*o-b)*s}}return null}var Uo=class extends P{constructor(e){super(e)}initialize(){this.addHandles([this.layerViews.on("change",()=>this.notifyChange("stencilEnabledExtents"))])}destroy(){}get layerViewsExtent(){return this._computeLayerViewsExtent()}get tiledLayersExtent(){return this._computeTiledLayersExtent()}get stencilEnabledExtents(){return this._computeStencilEnabledExtents()}_computeStencilEnabledExtents(){let e=[];return this.layerViews.forEach(t=>{let i=t.layer;if("operationalLayerType"in i&&S2(i.operationalLayerType)&&this.viewSpatialReference!=null){let r=Qq(i.fullExtent,this.viewSpatialReference);r!=null&&e.push(P2(r))}}),e}};function Zq(e,t){return e===Se.Global?new gO(t):new _O(t)}u([d({readOnly:!0})],Uo.prototype,"layerViewsExtent",null),u([d({readOnly:!0})],Uo.prototype,"tiledLayersExtent",null),u([d({readOnly:!0})],Uo.prototype,"stencilEnabledExtents",null),u([d()],Uo.prototype,"viewSpatialReference",void 0),u([d()],Uo.prototype,"tilingScheme",void 0),u([d()],Uo.prototype,"defaultTiledLayersExtent",void 0),u([d({constructOnly:!0})],Uo.prototype,"layers",void 0),u([d({constructOnly:!0})],Uo.prototype,"layerViews",void 0),Uo=u([C("esri.views.3d.terrain.ExtentHelper")],Uo);var gO=class extends Uo{_computeLayerViewsExtent(){return this._globalExtent}_computeTiledLayersExtent(){return this._globalExtent}get _globalExtent(){return this.viewSpatialReference.isWebMercator?i3:r3}};gO=u([C("esri.views.3d.terrain.ExtentHelper.ExtentHelperGlobal")],gO);var _O=class extends Uo{_computeLayerViewsExtent(){let e=Yo(),t=this.viewSpatialReference;this.layerViews.forEach(n=>{let s=n.layer;if(n.isResolved()&&(s.type!=="graphics"||!s.internal)){let o=Qq("fullExtentInLocalViewSpatialReference"in n&&n.fullExtentInLocalViewSpatialReference||n.layer.fullExtent,t);ka(e,o,e)}});let i=Ox(e)?e:null,r=this._get("layerViewsExtent");return Ko(i,r)?r:i}_computeTiledLayersExtent(){let e=this.tilingScheme;if(!e)return null;let t=this.viewSpatialReference,i=Yo();this.layers.forEach(s=>{if(s.loaded&&Bc(s)){let o=Ud(s,t,Se.Local);if(o==null)return;let{tileInfo:a,fullExtent:l}=o,c="tilemapCache"in s?s.tilemapCache?.effectiveMaxLOD:void 0;a!=null&&l!=null&&(Rw(s)||e.compatibleWith(a,c)&&l.spatialReference.equals(e.spatialReference))&&ka(i,l,i)}}),ka(i,this.defaultTiledLayersExtent,i);let r=Ox(i)?i:null,n=this._get("tiledLayersExtent");return Ko(r,n)?n:r}};function Qq(e,t){return e==null||e.spatialReference.equals(t)?e:bL(e,e.spatialReference,t)}_O=u([C("esri.views.3d.terrain.ExtentHelper.ExtentHelperLocal")],_O);function wD(){let e=globalThis.require?.modules;if(e){let t=Object.keys(e);for(let i of t)i.includes(".glsl")&&delete e[i]}}var tv=class{constructor(t,i){this.screen=t,this.olid=i}};var Yq=1.3,Mte=[[-.1,-2,3.9,2],[-.1,-3.9,3.9,.1],[-2,-3.9,2,.1],[-3.9,-3.9,.1,.1],[-3.9,-2,.1,2],[-3.9,-.1,.1,3.9],[-2,-.1,2,3.9],[-.1,-.1,3.9,3.9]],cd,In=class extends P{constructor(e){super(e),this._renderSR=null,this._overlaySREqualsRenderSR=!0,this._drapeSources=new Set,this._drapeTargets=new Set,this._placementDirty=!1,this._contentUpdated=!1,this._drawTexturesDirty=!1,this._drawTexturesAnimateDirty=!1,this._latestOriginId=0,this._maxResolution=Ct("esri-mobile")?2048:4096}initialize(){let e=this.view;this.renderer=new AV({parent:this}),e._stage.renderer.plugins.add(this.renderer);let t=()=>this.requestRender();this._groundIntersector=nn(this.view.state.viewingMode),this._groundIntersector.options.backfacesTerrain=!0,this._groundIntersector.options.invisibleTerrain=!0,this._groundIntersector.options.hud=!1,this.addHandles([S(()=>this.renderer.hasHighlights,t),this.renderer.events.on("has-water",()=>e._stage?.renderer.updateHasFlags()),this.renderer.events.on("content-changed",t),S(()=>e.state.camera.pixelRatio,t),S(()=>e.state.alignPixelEnabled,t),this.renderer.events.on("textures-disposed",()=>this.surface.requestRender()),S(()=>[e.pointsOfInterest?.renderPointOfView,e.pointsOfInterest?.centerOnSurfaceFrequent?.location],()=>this.setPlacementDirty()),S(()=>[e.state?.pixelRatio,e.state?.contentPixelRatio],()=>this.setPlacementDirty(),Fe),this.surface.on("elevation-change",()=>this.setPlacementDirty()),e.on("resize",()=>this.setPlacementDirty()),e.resourceController.scheduler.registerTask(Xt.OVERLAY,this),e._stage.renderView.events.on("force-camera-for-screenshot",i=>{this._updateOverlays(Jn,i.camera,Pe.BACKGROUND),this.renderer.hasOverlays&&this._drawOverlays(Pe.BACKGROUND,i)})]),e._stage.renderer.overlay=this}destroy(){this.view?._stage&&(this.view._stage.renderer.plugins.remove(this.renderer),this.view._stage.renderer.overlay=null),cd&&(cd.hide(),cd=null),this.renderer=G(this.renderer)}get spatialReference(){return this._spatialReference}set spatialReference(e){this._spatialReference=e,this.renderer.longitudeCyclical=null;let t=this.view.renderSpatialReference;e!=null&&t!=null?(this._renderSR=t,this._overlaySREqualsRenderSR=e.equals(this._renderSR),this._isSpherical&&(this.renderer.longitudeCyclical=e.isWebMercator?new sM(-20037508342787e-6,20037508342787e-6):new sM(-180,180))):this.renderer.disposeOverlays()}get running(){return this._placementDirty&&(this._drapeSources.size>0||this.view.graphics.length>0||ur.OVERLAY_DRAW_DEBUG_TEXTURE)&&!!this._spatialReference&&!this.suspended&&this.surface.ready}get _isSpherical(){return this.view.state.isGlobal}get worldToPCSRatio(){return this._spatialReference!=null&&this._spatialReference.isGeographic&&!this.view.state.isLocal?_t(this._spatialReference).metersPerDegree:1}get _overlayStretch(){return Yq/this.view.resolutionScale}get _longitudeCyclical(){return this.renderer.longitudeCyclical}get suspended(){return this.surface.suspended}get updating(){return this.running||this.renderer.updating||this._contentUpdated}get rendersOccludedDraped(){return this.renderer.rendersOccludedDraped}render(){if(this._contentUpdated=!1,this.renderer.processSyncDrapeSources(),this.renderer.hasOverlays)return this._precompileShaders()?this._drawOverlays(Pe.UPDATE):null}get hasOverlays(){return this.renderer.hasOverlays}registerDrapeSource(e,t,i){this._drapeSources.add(e),this.renderer.ensureOverlays(this._drapeTargets,this._drapeSources);let r=this.renderer.createDrapeSourceRenderer(e,t,i);return this._updateDrapeSourceExtent(e),this._setContentDirty(),this.notifyChange("running"),r}registerGeometryDrapeSource(e){return this.registerDrapeSource(e,O3)}_updateDrapeSourceExtent(e){this.renderer.overlays.length===2&&e.setDrapingExtent!=null&&this._spatialReference!=null&&e.setDrapingExtent(this.renderer.overlays,this._spatialReference)}unregisterDrapeSource(e){this._drapeSources.has(e)&&(this._drapeSources.delete(e),this.renderer.removeDrapeSourceRenderer(e),this.renderer.ensureDrapeSources(this._drapeSources),this._setContentDirty(),this.notifyChange("running"))}registerDrapeTarget(e){this._drapeTargets.add(e),this.renderer.ensureOverlays(this._drapeTargets,this._drapeSources)}unregisterDrapeTarget(e){this._drapeTargets.delete(e),this.renderer.ensureDrapeTargets(this._drapeTargets)}_setContentDirty(){this.setPlacementDirty(),this.requestRender()}setPlacementDirty(){this._placementDirty=!0}runTask(e){return this._updateOverlays(e,this.view.state.contentCamera,Pe.UPDATE)}_updateOverlays(e,t,i){if(!this._spatialReference)return Ui;let r=this._computeOverlayResolution(t);this._computeOverlayExtents(t,r,xl),this.renderer.ensureOverlays(this._drapeTargets,this._drapeSources,xl.stretch);let n=this._updateOverlay(aa.INNER,xl.inner,r,1*xl.pixelRatioAdjustment,xl.mapUnitsPerPixel),s=ao(xl.inner)/ao(xl.outer),o=this._updateOverlay(aa.OUTER,xl.outer,r,s*xl.pixelRatioAdjustment,xl.mapUnitsPerPixel);n!==Ml.EXTENT&&o!==Ml.EXTENT||(this._drapeSources.forEach(a=>this._updateDrapeSourceExtent(a)),this.updateOverlayParameters(i)),n===Ml.NONE&&o===Ml.NONE||this.requestRender(),this._placementDirty=!1,e.madeProgress()}_computeOverlayResolution(e){let t=this.view.state.contentPixelRatio*this.view.resolutionScale,i=e.fullWidth/e.pixelRatio*t,r=e.fullHeight/e.pixelRatio*t,n=Math.ceil(1.5*Math.max(i,r));return Math.min(tu(n),this._maxResolution)}_updateOverlay(e,t,i,r,n){if(this.renderer.overlays.length===0)return Ml.NONE;let s=this.renderer.overlays[e],o=s.mapUnitsPerPixel;if(s.mapUnitsPerPixel=n,s.pixelRatio=r,Ste(t,s.extent)&&i===s.resolution)return o===n?Ml.NONE:Ml.RERENDER_ONLY;Og(s.extent,t),s.resolution=i;let a=f0(s.extent);return s.renderLocalOrigin=gV(a[0],a[1],0,"OV_"+this._latestOriginId++),Ml.EXTENT}updateOverlayParameters(e){this.surface.allTiles.forAll(t=>this.updateTileOverlayParameters(t)),this.surface.requestRender(e)}updateTileOverlayParameters(e){if(!e.renderData)return;let t=e.renderData.overlay;if(this.renderer.overlays.length===0)this._clearTileOverlayData(aa.INNER,t),this._clearTileOverlayData(aa.OUTER,t);else{let[i,r]=this.renderer.overlays,n=e.extent;this._rectInsideRect(i.extent,n)||this._rectanglesOverlap(n,i.extent)||this._rectanglesOverlap(n,r.extent)?(this._setTileOverlayData(n,aa.INNER,t),this._setTileOverlayData(n,aa.OUTER,t)):(this._clearTileOverlayData(aa.INNER,t),this._clearTileOverlayData(aa.OUTER,t))}}overlayPixelSizeInMapUnits(e,t){if(this.renderer.overlays.length===0)return t();let i=this.renderer.overlays[aa.INNER],r=this.renderer.overlays[aa.OUTER],n=this._pointIsInExtent(e,i.extent)?i:r;return(n.extent[2]-n.extent[0])/n.resolution}_setTileOverlayData(e,t,i){if(this.renderer.overlays.length===0)return;let r=this.renderer.overlays[t].extent,n=ao(r),s=Hl(r),o=e[0];if(this._longitudeCyclical){o=this._longitudeCyclical.minimalMonotonic(r[0],o);let a=this._longitudeCyclical.minimalMonotonic(r[0],e[2]);o>a&&(o=a-(e[2]-e[0]))}i.setScale(t,ao(e)/n,Hl(e)/s),i.setOffset(t,(o-r[0])/n,(e[1]-r[1])/s)}_clearTileOverlayData(e,t){t.setScale(e,-1,-1),t.setOffset(e,-1,-1)}reloadShaders(){wD(),this.requestRender(),this.runTask(Jn)}requestRender(e=Pe.UPDATE){this.renderer.hasOverlays?(e===Pe.UPDATE?(this._contentUpdated=!0,this._drawTexturesDirty=!0):this._drawTexturesAnimateDirty=!0,this.view._stage.renderView.requestRender(e)):this.setPlacementDirty()}_intersectGroundFromView(e,t,i,r,n){let s=this.view.sceneIntersectionHelper.getCenterRayWithSubpixelOffset(e,Rte,t,i);if(s==null)return!1;let o=s.origin,a=he(bD,s.origin,s.direction);this._groundIntersector.reset(o,a,e),this._groundIntersector.intersect([]),this.view.basemapTerrain.intersect(this._groundIntersector,null,o,a);let l=this._groundIntersector.results.min;return l.getIntersectionPoint(n)&&l.withinDistance(r)}_findHorizonBasedPointOfInterest(e,t){let i=.5,r=.55,n=this.view.renderCoordsHelper.getAltitude(e.eye),s=this.view.pointsOfInterest.centerOnSurfaceFrequent,o=1e-5,a=q(s.estimatedSurfaceAltitude,e.aboveGround?-1/0:n+o,e.aboveGround?n-o:1/0),l=e.aboveGround;if(this.view.viewingMode==="global"){let c=bD;Qc(Bp(Up,_t(this.view.spatialReference).radius+a),ia(e.eye,e.viewForward),c),ve(c,c,e.eye);let h=oa.normalize(nF(e.viewForward,c,e.viewRight))/e.fovY+.5,p=h<=0||h>=1?.5:r;i=l?p*h:h+p*(1-h)}else{let c=.5*Math.PI-Math.acos(-e.viewForward[2]),h=Math.tan(c),p=fn(0,h,1,0),m=kg(p,p,e.projectionMatrix)[1],f=q(.5+.5*m,0,1);i=f===1||f===0?.5:l?f*r:1-(1-f)*r}return this._intersectGroundFromView(e,.5,i,s.distance,t)}_computeOverlayExtents(e,t,i){let r=this.view.pointsOfInterest.centerOnSurfaceFrequent.renderLocation,n=w();this._findHorizonBasedPointOfInterest(e,n)||ee(n,r),ur.OVERLAY_SHOW_CENTER?(cd==null&&(cd=new Cl(this.view.graphics,"red")),cd.show(n,this._renderSR)):cd?.hide();let s=Math.max(.1,ui(e.eye,n)),o=la(this.view.renderCoordsHelper,r,e.eye);this._overlaySREqualsRenderSR||Ua(n,this._renderSR,n,this._spatialReference);let a=this.surface.extent,l=!this._isSpherical&&this._spatialReference?.isGeographic,c=l&&this._spatialReference?1/_t(this._spatialReference).metersPerDegree:1,h=this.view.state.contentPixelRatio,p=e.perScreenPixelRatio/h*s*c;i.mapUnitsPerPixel=p/this.worldToPCSRatio,i.stretch=this._overlayStretch;let m=t*p/2*i.stretch,f=!1,g=l?90:1/0;this._isSpherical&&a&&this._spatialReference&&(this._spatialReference.isWebMercator?(m/=Math.cos(b2(n[1])),g=a[3]):(f=!0,m/=_t(this._spatialReference).metersPerDegree,g=90),m>=g&&(m=g,n[1]=0,this._spatialReference.isWebMercator&&(n[0]=0)));let _=1;f&&(_=1/Math.max(.2,Math.cos(Math.abs(kt(n[1])))),m*_>180&&(_=180/m),i.mapUnitsPerPixel*=_);let v=Math.log(2)/12;m=Math.exp(Math.round(Math.log(m)/v)*v);let b=m*_,x=32,E=.5*t/(x*b),D=.5*t/(x*m);n[0]=Math.round(n[0]*E)/E,n[1]=Math.round(n[1]*D)/D;let M=i.inner;M[0]=n[0]-b,M[1]=n[1]-m,M[2]=n[0]+b,M[3]=n[1]+m,this._isSpherical&&this._shiftExtentToFitBounds(M,1/0,g);let T=i.outer;if(6*b>ao(a))Og(T,a);else if(Math.PI/2-Math.abs(o-Math.PI/2)<=.25*Math.PI)T[0]=M[0]-b,T[1]=M[1]-m,T[2]=M[2]+b,T[3]=M[3]+m;else{Ua(e.eye,this._renderSR,bD,this._spatialReference),T0(ep,n,bD);let A=-Math.atan2(ep[1],ep[0])+.125*Math.PI;A<0&&(A+=2*Math.PI);let O=Math.floor(A/(.25*Math.PI));w0(ep,Mte[O],2*m),ep[0]*=_,ep[2]*=_,hL(T,M,ep)}if(this._isSpherical)T[0]=this._longitudeCyclical.clamp(T[0]),T[2]=this._longitudeCyclical.clamp(T[2]),T[1]=Math.max(T[1],-g),T[3]=Math.min(T[3],g);else{let A=Ng(M,a,Ite),O=Ng(T,a,Ate);Lx(A,O)&&(T[2]=T[0],T[3]=T[1])}let I=Math.abs(M[2]-M[0])/t;i.mapUnitsPerPixel=Math.max(i.mapUnitsPerPixel,I),i.pixelRatioAdjustment=i.mapUnitsPerPixel/I}_precompileShaders(){return!!this.renderer.hasOverlays&&(this.renderer.precompileShaders(this.view.state),!0)}_drawOverlays(e,t=this.view.state){if(!this._drawTexturesDirty&&!this._drawTexturesAnimateDirty)return this.renderer;let i=this._drawTexturesDirty;this._drawTexturesDirty=this._drawTexturesAnimateDirty=!1;let r=this.renderer.computeValidity();return this.renderer.releaseRenderTargets(),this.renderer.drawOverlays(t),r!==this.renderer.computeValidity()&&this.updateOverlayParameters(Pe.UPDATE),i?(this.surface.requestRender(e),e===Pe.UPDATE&&this.surface.requestUpdate()):this.surface.requestRender(Pe.BACKGROUND),this.renderer}_rectanglesOverlap(e,t){return e!=null&&(this._longitudeCyclical?(this._longitudeCyclical.contains(t[0],t[2],e[0])||this._longitudeCyclical.contains(t[0],t[2],e[2])||this._longitudeCyclical.contains(e[0],e[2],t[0]))&&!(e[1]>t[3]||e[3]<t[1]):Bl(e,t))}_rectInsideRect(e,t){return t!=null&&(this._longitudeCyclical?this._longitudeCyclical.contains(e[0],e[2],t[0])&&this._longitudeCyclical.contains(e[0],e[2],t[2])&&t[1]>e[1]&&t[3]<e[3]:Lx(e,t))}_pointIsInExtent(e,t){if(this._longitudeCyclical)return this._longitudeCyclical.contains(t[0],t[2],e.x)&&e.y>=t[1]&&e.y<=t[3];let i=e.x,r=e.y;return i>t[0]&&i<t[2]&&r>t[1]&&r<t[3]}_shiftExtentToFitBounds(e,t,i){let r=0,n=0;e[0]<-t?r=e[0]+t:e[2]>t&&(r=t-e[2]),e[1]<-i?n=e[1]+i:e[3]>i&&(n=i-e[3]),g0(e,r,n)}get test(){}};function Ste(e,t){let r=ur.TESTS_DISABLE_OPTIMIZATIONS?0:1e-5*Math.max(e[2]-e[0],e[3]-e[1],t[2]-t[0],t[3]-t[1]);return Math.abs(t[0]-e[0])<=r&&Math.abs(t[1]-e[1])<=r&&Math.abs(t[2]-e[2])<=r&&Math.abs(t[3]-e[3])<=r}u([d()],In.prototype,"_spatialReference",void 0),u([d({readOnly:!0})],In.prototype,"running",null),u([d()],In.prototype,"_placementDirty",void 0),u([d()],In.prototype,"_contentUpdated",void 0),u([d()],In.prototype,"_isSpherical",null),u([d()],In.prototype,"worldToPCSRatio",null),u([d()],In.prototype,"renderer",void 0),u([d({constructOnly:!0})],In.prototype,"view",void 0),u([d({constructOnly:!0})],In.prototype,"surface",void 0),u([d()],In.prototype,"suspended",null),u([d()],In.prototype,"updating",null),u([d({type:Boolean})],In.prototype,"rendersOccludedDraped",null),In=u([C("esri.views.3d.terrain.OverlayManager")],In);var yO=class{constructor(){this.inner=Yt(),this.outer=Yt(),this.mapUnitsPerPixel=0,this.pixelRatioAdjustment=1,this.stretch=Yq}},ep=Qi(),bD=w(),xl=new yO,Ite=Yt(),Ate=Yt(),Rte=Os(),Ml;(function(e){e[e.NONE=0]="NONE",e[e.EXTENT=1]="EXTENT",e[e.RERENDER_ONLY=2]="RERENDER_ONLY"})(Ml||(Ml={}));var CD=class{constructor(){this.indices=null,this.indexCount=0,this.edgeIndicesStartIndex=0,this.poleIndicesStartIndex=0,this.vertexAttributes=null,this.edgeVerticesStartIndex=0,this.poleVerticesStartIndex=0,this.maxEdgeVertexCount=0,this.boundingBox=Ul(),this.numVerticesPerSide=0,this.minu=0,this.minv=0,this.maxu=1,this.maxv=1,this.outerEdgesOffsetAndLength=[0,0,0,0,0,0,0,0]}release(){this.vertexAttributes=ki(this.vertexAttributes),this.indices=null}reset(){this.indices=null,this.vertexAttributes=null,Ul(this.boundingBox),this.numVerticesPerSide=0}getEdgeFirstVertexIndex(t){return this.outerEdgesOffsetAndLength[2*t]}getEdgeCount(t){return this.outerEdgesOffsetAndLength[2*t+1]}getEdgeVertexIndex(t,i){return this.getEdgeAttributeIndex(t,i)}getEdgeVertexPosition(t,i,r,n){this._getEdgeVertexRaw(this.getEdgeAttributeIndex(t,n),i),he(i,i,r)}getEdgeNormal(t,i,r){let{typedBuffer:n,typedBufferStride:s}=this.vertexAttributes.normalCompressed;RL(i,n,this.getEdgeAttributeIndex(t,r),s)}setEdgeNormalFromValues(t,i,r,n,s){this._setNormal(this.getEdgeAttributeIndex(t,i),r,n,s)}setEdgeVertexFromValuesRawPositionUV(t,i,r,n,s,o,a){let l=this.getEdgeAttributeIndex(t,i);this.vertexAttributes.position.setValues(l,r,n,s),this._setUV(l,o,a)}setEdgeVertexFromValuesRawPositionUVNormal(t,i,r,n,s,o,a,l,c,h){let p=this.getEdgeAttributeIndex(t,i);this.vertexAttributes.position.setValues(p,r,n,s),this._setUV(p,o,a),this._setNormal(p,l,c,h)}_getEdgeVertexRaw(t,i){this.vertexAttributes.position.getVec(t,i)}_setNormal(t,i,r,n){let{typedBuffer:s,typedBufferStride:o}=this.vertexAttributes.normalCompressed;Rd(s,t,i,r,n,o)}_setUV(t,i,r){jo(this.vertexAttributes.uv0,t,i,r)}getEdgeAttributeIndex(t,i){return te(0<=i&&i<this.getEdgeCount(t)),this.getEdgeFirstVertexIndex(t)+i}},Kq=16384;function jo(e,t,i,r){e.setValues(t,i*Kq,r*Kq)}var TD=class{constructor(){this.sinLonLUT=new Array(Bd+1),this.cosLonLUT=new Array(Bd+1),this.sinLatLUT=new Array(Bd+1),this.cosLatLUT=new Array(Bd+1)}update(t,i,r){let n=i[0],s=i[2];for(let o=0;o<=t;o++){let a=o/t,l=n*(1-a)+s*a;this.sinLonLUT[o]=Math.sin(l),this.cosLonLUT[o]=Math.cos(l);let c=r(a);this.sinLatLUT[o]=Math.sin(c),this.cosLatLUT[o]=Math.cos(c)}}};var ED=class{constructor(){this.numVerticesPerSide=0,this.samplerData=null,this.samplerDataVersion=0,this.clippingArea=null,this.wireframe=!1,this.cornerPeerNeighbors=[null,null,null,null],this.cornerNeighborCornerTiles=[null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null],this.cornerNeighborCornerTileSamplerVersions=[-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1],this.edgeResolutions=[-1,-1,-1,-1],this.edgePeerNeighbors=[null,null,null,null],this.edgePeerNeighborSamplerVersions=[-1,-1,-1,-1]}};var iv=class e{constructor(t){this._getFadeDuration=t,this._fadeStart=0,this._delayedTime=0}clear(){this._current=G(this._current),this._next=G(this._next),this._waiting=G(this._waiting),this._delayed=G(this._delayed)}get current(){if(this._current==null)return null;if(!this._isFadingEnabled){let i=this._delayed||this._waiting||this._next||this._current;i!==this._current&&(this._current=null,this.clear(),this._current=i)}let t=e.test.fadeMoment;if(this._delayed!=null&&(t=t||performance.now(),t>=this._delayedTime&&(this._push(this._delayed,Sl.Immediate),this._delayed=null)),this._next!=null){t=t||performance.now();let i=this._fadeDuration,r=this._current!=null&&this._next.texture===this._current.texture,n=this._next.type!==di.FADING,s=t-this._fadeStart>=i;(r||n||s)&&(G(this._current),this._current=this._next,this._next=this._waiting,this._waiting=null,this._fadeStart=this._alignFadeStart(t))}return this._current}get next(){return this._next}get fadeFactor(){if(this._next==null)return 1;let t=e.test.fadeMoment||performance.now(),i=Math.max(0,t-this._fadeStart),r=this._fadeDuration;return i>r?0:1-i/r}get isFading(){return this._next!=null||this._delayed!=null}push(t,i=Sl.Immediate){this._delayed=G(this._delayed),this._push(t,i)}_push(t,i){if(this._isFadingEnabled||this.clear(),this._current==null)return void(this._current=t);let r=e.test.fadeMoment||performance.now();return i!==Sl.Immediate?(this._delayed=t,void(this._delayedTime=r+i)):this._next==null?(this._next=t,void(this._fadeStart=this._alignFadeStart(r))):void(t!=null&&(G(this._waiting),this._waiting=t))}get _fadeDuration(){let t=this._getFadeDuration();return this._waiting?.5*t:t}_alignFadeStart(t){let i=this._getFadeDuration();return t+i-t%i}get _isFadingEnabled(){return this._getFadeDuration()>0}},Sl;iv.test={fadeMoment:0},function(e){e[e.Immediate=0]="Immediate",e[e.Delayed=5e3]="Delayed"}(Sl||(Sl={}));var ud=class{constructor(t,i,r,n,s,o){this.texture=t,this.type=i,this.offsetAndScale=r,t.retain(),this.opacities=yt(n,s,o)}destroy(){this.texture.release()}};var DD=class{constructor(){this._scales=fn(-1,-1,-1,-1),this._offsets=fn(-1,-1,-1,-1)}clear(){this._scales[0]=this._scales[1]=this._scales[2]=this._scales[3]=-1,this._offsets[0]=this._offsets[1]=this._offsets[2]=this._offsets[3]=-1}setScale(t,i,r){this._scales[2*t]=i,this._scales[2*t+1]=r}setOffset(t,i,r){this._offsets[2*t]=i,this._offsets[2*t+1]=r}get scales(){return this._scales}get offsets(){return this._offsets}};var xD=class extends ft{constructor(t,i){super(t,i,new mt(X3,()=>import("./chunk-5R6UDWLA.js")),vO),this.type="TerrainTechnique",this.useStencil=!1}initializePipeline(t){return this._stencilPipelineState=this._createPipeline(t,!0),this._createPipeline(t,!1)}_createPipeline(t,i){let{renderOccluded:r,output:n}=t,s=t.backfaceCullingEnabled&&!r;return Tt({blending:r?$p:null,culling:s?Z0:null,depthTest:r?null:{func:Ei.LESS},depthWrite:r?null:UF,colorWrite:St,stencilTest:i?jF(z0.IntegratedMeshMaskExcluded):null,drawBuffers:n===oe.Depth?{buffers:[SL.NONE]}:null})}getPipeline(){return this.useStencil?this._stencilPipelineState:super.getPipeline()}},vO=new Map([[yi.POSITION,0],[yi.UV0,1],[yi.NORMALCOMPRESSED,2]]);var MD=class{constructor(){this.geometry=new CD,this.intersectionData=null,this.geometryState=null,this._vao=null,this._texture=null,this._textureOpacity=1,this._textureRef=new iv(()=>this._tile.surface.fadeDuration),this.overlay=new DD,this._localOrigin=null,this._geometryStateChangedSinceLastUpdate=!0,this._hasGeometry=!1,this._modifiedFlags=0}get tile(){return this._tile}get localOrigin(){return this._localOrigin}init(t,i){this.clear(),this._tile=t,this.geometry.reset(),this.intersectionData=null,this.geometryState=new ED,this._localOrigin=i,this.overlay.clear()}clear(){this.releaseGeometry(),this.releaseTexture(),this._textureRef.clear(),this._tile=null,this.intersectionData=null,this.geometryState=null}updateGeometryIfNeeded(t){if((!this._vao||this._geometryStateChangedSinceLastUpdate||this.wireframeChanged||this.clippingAreaChanged||this.samplerDataChanged||this.numVerticesPerSideChanged||this.dirtyCorners||this.dirtyEdgeResolutions||this.dirtyEdges)&&(this._updateGeometry(t),this._geometryStateChangedSinceLastUpdate=!1),Ki&&this.tile.intersectsClippingArea)for(let i=0;i<4;++i)te(this.geometry.getEdgeCount(i)===this.geometryState.edgeResolutions[i]+1)}_calculateEdgeResolution(t,i){let r=this.tile,n=this.geometryState.numVerticesPerSide-1;if(!r.surface.isGlobal){let l=r.surface.extent;if(l!=null&&(t===0&&r.extent[3]>l[3]||t===1&&r.extent[2]>l[2]||t===2&&r.extent[1]<l[1]||t===3&&r.extent[0]<l[0]))return n}let s=r.level,o=Bn[t];if(!i)return te(r.surface?.rootTiles==null||r.surface.updatingRootTiles||!r.shouldHaveNeighbor(o)),n;if(i.loaded){let l=i,c=l.renderData.geometryState,h=s-l.level;if(te(h>=0),h===0){let f=c.numVerticesPerSide-1;return Math.max(f,n)}let p=2**h,m=c.edgeResolutions[(t+2)%4]/p;return Math.max(1,m)}te(!i.leaf);let a=n;return i.forAllSubtreeOnSide(cm(o),l=>l===r||(l.loaded?(a=Math.max(a,2**(l.level-s)),!0):(te(!l.leaf),!1))),a}updateNeighborData(){let t=this.tile;if(!t.intersectsClippingArea)return;let i=t.renderData.geometryState,r=o=>(o.loaded||o.level===t.level)&&o?.intersectsClippingArea,n=i.edgePeerNeighbors,s=i.edgePeerNeighborSamplerVersions;for(let o=0;o<4;++o){let a=t.findNeighborTile(Bn[o],r),l=dd(t,a),c=l?.renderData?.geometryState.samplerDataVersion??-1,h=n[o],p=l!==dd(t,h),m=s[o]!==c;Ki&&a&&(te(t.level>=a.level),te(t.level-a.level<=Gi)),n[o]=a,(p||m)&&(s[o]=c,this._markEdgeDirty(o));let f=i.edgeResolutions[o],g=this._calculateEdgeResolution(o,a);te(wd(g)),te(g>=1),i.edgeResolutions[o]=g,f!==g&&this._markEdgeResolutionDirty(o)}for(let o=0;o<4;++o){let a=t.findNeighborTile(jd[o],r);i.cornerPeerNeighbors[o]=a;let l=dd(t,n[o]),c=dd(t,n[(o+1)%4]),h=dd(t,a);Da[o]=h,Da[(o+1)%4]=c,Da[(o+2)%4]=t,Da[(o+3)%4]=l,te(Da.some(g=>g?.loaded||g===t));let p=Da.reduce((g,_)=>Math.min(g,_?.level??1/0),1/0);Da.forEach((g,_)=>{g&&g?.level>p&&(Da[_]=null)}),te(Da.some(g=>g?.loaded||g===t));let m=i.cornerNeighborCornerTiles,f=i.cornerNeighborCornerTileSamplerVersions;for(let g=0;g<4;++g){let _=Da[g],v=_?.renderData.geometryState.samplerDataVersion??-1,b=4*o+g,x=m[b]!==_,E=!x&&f[b]!==v;(x||E)&&(m[b]=_,f[b]=v,this._markCornerDirty(o))}Ki&&te(SD.some(g=>m[4*o+g]?.loaded||m[4*o+g]===t))}Ki&&te(this.geometryState.edgeResolutions.every(o=>o>0));for(let o=0;o<4;++o)Da[o]=null}_updateGeometry(t){if(!this.tile.intersectsClippingArea)return;Ki&&te(!this.tile.intersectsClippingArea||this.geometryState.edgeResolutions.every(f=>f>0)),this.intersectionData=null;let{tile:i,_vao:r,geometry:n,geometryState:s}=this,o=!r||this.wireframeChanged||this.samplerDataChanged||this.clippingAreaChanged||this.numVerticesPerSideChanged,a=this.dirtyEdgeResolutions!==0,l=s.edgeResolutions.reduce((f,g)=>f+g+1,0),c=o||a&&l>(n?.maxEdgeVertexCount??0),h=!c&&a,p=!h&&(this.dirtyEdges!==0||a),m=!p&&this.dirtyCorners!==0;c?(this.releaseGeometry(),this._createGeometry(t)):h?i.updateEdgeElevationsAndResolutions():p||m?i.updateEdgeElevations():m?i.updateCornerElevations():console.warn("Update for no reason?"),this._modifiedFlags=0}get hasGeometry(){return this._hasGeometry}releaseGeometry(){return this._hasGeometry=!1,this.intersectionData=null,!!this._vao&&(this._vao=We(this._vao),this.geometry.release(),!0)}ensureTexture(t,i,r,n){let s=i?mi.RGBA:mi.RGB;return this._texture!=null&&(r===di.FADING&&this._tile.surface.fadeDuration>0&&this._isTextureVisible(this._texture)||this._texture.descriptor.width!==t||this._texture.descriptor.pixelFormat!==s)&&this.releaseTexture(),this._texture==null&&(this._texture=n(),this.tile.setMemoryDirty()),this._texture}releaseTexture(){this._texture!=null&&(this._texture.release(),this._texture=null,this.tile.setMemoryDirty())}reuseTexture(t,i){return!(!t||!this._texture)&&(t.setTextureReference(new ud(this._texture,di.FADING,i,this._textureOpacity,0,1)),!0)}get numVerticesPerSideChanged(){return!!(this._modifiedFlags&Ote)}get samplerDataChanged(){return!!(this._modifiedFlags&Nte)}get clippingAreaChanged(){return!!(this._modifiedFlags&Lte)}get wireframeChanged(){return!!(this._modifiedFlags&Fte)}get dirtyEdges(){return this._modifiedFlags>>wO&15}get dirtyCorners(){return this._modifiedFlags>>bO&15}get dirtyEdgeResolutions(){return this._modifiedFlags>>CO&15}_markCornerDirty(t){let i=1<<t<<bO;this._modifiedFlags|=i}_markEdgeDirty(t){let i=1<<t<<wO;this._modifiedFlags|=i,this._markCornerDirty((t+0)%4),this._markCornerDirty((t+3)%4)}_markEdgeResolutionDirty(t){let i=1<<t<<CO;this._modifiedFlags|=i,this._markEdgeDirty(t)}_markAllEdgesAndCornersDirty(){this._modifiedFlags|=15<<bO|15<<wO|15<<CO}updateGeometryState(){let t=this._elevationInfo,i=this.tile,r=t.samplerData?i.getElevationVerticesPerSide(t.maxTileLevel):i.minimumVerticesPerSide,n=Math.max(r,5),s=i.clippingArea;i.intersectsClippingArea&&!i.withinClippingArea||(s=null);let o=this.geometryState,a=!1;o.numVerticesPerSide!==n&&(this._modifiedFlags|=1,o.numVerticesPerSide=n,o.samplerDataVersion++,a=!0),t.changed&&(this._modifiedFlags|=2,o.samplerData=t.samplerData,o.samplerDataVersion++,a=!0),Kv(o.clippingArea,s)||(this._modifiedFlags=4,o.clippingArea=s,a=!0);let l=i.surface.wireframe;return o.wireframe!==l&&(this._modifiedFlags=8,o.wireframe=l,a=!0),this._geometryStateChangedSinceLastUpdate||=a,a&&this._markAllEdgesAndCornersDirty(),this._hasGeometry=!0,this._geometryStateChangedSinceLastUpdate}_createGeometry(t){this.tile.createGeometry();let i=this.geometry.vertexAttributes,r=this.geometry.indices,n=t.gl;this._vao=new ns(t,vO,new Map([["geometry",is(i.layout)]]),new Map([["geometry",vr.createVertex(t,n.STATIC_DRAW,i.buffer)]]),vr.createIndex(t,n.STATIC_DRAW,r)),this._hasGeometry=!0}get vao(){return this._vao}setTextureReference(t,i=Sl.Immediate){t?.texture===this._texture?this._textureOpacity=t.opacities[0]:this.releaseTexture(),this._textureRef.push(t,i)}get textureReference(){return this._textureRef.current}get nextTextureReference(){return this._textureRef.next}get textureFadeFactor(){return this._textureRef.fadeFactor}get textureIsFading(){return this._textureRef.isFading}_isTextureVisible(t){return this._textureRef.current?.texture===t||this._textureRef.next?.texture===t&&this._textureRef.fadeFactor<1}get _elevationInfo(){let t=this.geometryState.samplerData,i=this.tile.layerInfo[Ue.ELEVATION],r=i.length,n=new Array(r),s=0,o=0,a=!1;for(let h=0;h<r;h++){let p=i[h],m=p.upsampleInfo?.tile;if(m){let f=m.layerInfo[Ue.ELEVATION][h].data,g=f&&f.samplerData;t&&t[s]===g||(a=!0),n[s++]=g,o=Math.max(o,m.lij[0])}else if(p.data){let f=this.tile.surface.layerViewByIndex(h,Ue.ELEVATION);if(ca(this.tile,f)){let g=p.data;t&&t[s]===g.samplerData||(a=!0),n[s++]=g.samplerData,o=this.tile.level}}}t!=null&&t.length!==s&&(a=!0);let l=s>0,c=l?n:null;return l&&(n.length=s),{changed:a,samplerData:c,maxTileLevel:o}}get estimatedGeometryMemoryUsage(){let t=this.intersectionData?.estimatedMemoryUsage??0;return(this.geometry.indices?.byteLength??0)+(this.geometry.vertexAttributes?.byteLength??0)+t}get texture(){return this._texture}get test(){}checkGeometryWaterproofness(){if(!Ki)return;let t=this.tile;if(!t.loaded||!t.intersectsClippingArea||t.level===0)return void te(t?.loaded);let i=t.surface.extent;if(i!=null&&!t.intersectsExtent(i))return;let r=Bn.map((a,l)=>i!=null&&(l<2?-1:1)*(t.extent[3-l]-i[3-l])<0),n=t.level;te(this.dirtyCorners===0),te(this.dirtyEdges===0),te(this.dirtyEdgeResolutions===0),te(!this.numVerticesPerSideChanged),te(!this.samplerDataChanged),te(!this.clippingAreaChanged),te(!this.wireframeChanged);let s=jd.map(a=>t.findNeighborCornerTileExact(a,l=>!l.intersectsClippingArea||l.loaded||l.level===t.level)??null).map(a=>a?.intersectsClippingArea?a:null),o=this.geometryState;for(let a=0;a<4;++a){let l=o.cornerPeerNeighbors[a],c=s[a];te(c===l,`Tile[${t.lij}].corner[${a}] out of date: cur=[${l?.lij}] exp=[${c?.lij}]`)}Bn.forEach((a,l)=>{if(r[l])return;let c=t.findNeighborTile(a,Ie=>(Ie.level===n||Ie?.loaded)&&Ie?.intersectsClippingArea);if(!c){let Ie=!t.surface.updatingRootTiles&&t.surface.rootTiles!=null&&t.surface.rootTiles.length>0&&t.shouldHaveNeighbor(a);return void te(!Ie)}te(c.loaded||c.level===t.level),te(c===this.geometryState.edgePeerNeighbors[l]);let h=n-c.level;if(!c.loaded)return te(!c.leaf),void te(h===0);let p=c.renderData;te(t.isEdgeNeighbor(c,a)),te(h>=0);let m=2**h;if(h<0)return void te(!1);let f=t.renderData,g=f.geometry,_=f.localOrigin,v=g.getEdgeCount(l),b=g.numVerticesPerSide-1,x=p.geometry;if(!x)return void te(!1);let E=p.localOrigin,D=this.geometryState.edgePeerNeighbors[l];if(D?.loaded){let Ie=D.renderData;te(f.geometryState.edgePeerNeighborSamplerVersions[l]===Ie.geometryState.samplerDataVersion),te(this.geometryState.edgePeerNeighborSamplerVersions[l]===Ie.geometryState.samplerDataVersion)}let M=(l+2)%4,T=x.getEdgeCount(M),I=v-1,A=T-1;te(I*m===A,`Tile[${t.lij}]:e${l},res=${I} edgeRes mismatch with Neighbor[${c.lij}]:e${M},res=${A} (expected:${I*m})`);let O=t.extent,$=a===ii.NORTH||a===ii.SOUTH,H=T-1,k=H>>h,K=v-1;if(k<1)return void te(K===1);te(k===K),te(wd(k));let F=x.numVerticesPerSide-1;te(h>0||k===Math.max(F,b));let R=t.getNeighborEdgeStartVertexIndex(l,c);te(0<=R&&R<m);let j=R*k;te(0<=j&&j<=H-k);let B=0,z=j;g.getEdgeVertexPosition(l,Il,_,0),g.getEdgeVertexPosition(l,Al,_,v-1);let ce=ui(Il,Al),ue=Math.max(Pte,1e-4*ce);for(let Ie=0;Ie<=k;++Ie){g.getEdgeVertexPosition(l,Il,_,B),x.getEdgeVertexPosition(M,Al,E,z);let le=Ie/k,ze=$?O[0]+le*(O[2]-O[0]):a===ii.WEST?O[0]:O[2],Le=$?a===ii.SOUTH?O[1]:O[3]:O[1]+le*(O[3]-O[1]),de=t.surface.extent;if(de==null||N2(de,ze,Le)){let fe=Ar(Il,Al),st=yr(Il)-pn.radius,De=yr(Al)-pn.radius,Ee=fe<ue;if(!Ee){console.warn(`Tile edge vertex position mismatch: between [${t.lij}].edge${l}[${B}/${v}] and [${c.lij}].edge${M}[${z}/${T}]`),de!=null&&console.warn("  surface extent= ",de," x,y=",ze,",",Le);let Ve=w();ve(Ve,f.localOrigin,p.localOrigin),yr(Ve)>0&&console.warn(`   localOrigins: ${f.localOrigin} vs ${p.localOrigin} d=${yr(Ve)} [${Ve}]`),(()=>{let N=mn(Il),V=mn(Al);t.updateEdgeElevations(),c.updateEdgeElevations(),g.getEdgeVertexPosition(l,Il,_,B),x.getEdgeVertexPosition(M,Al,E,z);let U=w();ai(U,Il,N),yr(U)>0&&console.warn(`  XXX Tile[${t.lij}] edge out of date: ${N} vs ${Il} d=${yr(U)} [${U}]`),ai(U,Al,V),yr(U)>0&&console.warn(`  XXX Neighbor[${c.lij}] edge out of date: ${V} vs ${Al} d=${yr(U)} [${U}]`)})();let _e=g.getEdgeCount(l),L=x.getEdgeCount(T);te(Ee,`Mismatch in tile [${t.lij}].edge[${l}][${B}/${_e}] vs neighbor [${c.lij}].edge[${M}][${z}/${L}] ${Ka(Il)} vs ${Ka(Al)}  dist=${fe} h(t|n|d)=${st}|${De}|${De-st}`)}g.getEdgeNormal(l,$f,B),x.getEdgeNormal(M,Zf,z),ne(Xq,$f),ne(Jq,Zf);let Ae=ae(Xq,Jq),He=1-Ae<.01||!1||t===c;if(!He){let Ve=w();ai(Ve,$f,Zf);let _e=()=>`Mismatch in tile edge normal ${TM(t.lij)} (${B}/${v-1}) edge ${l} vs neighbor ${TM(c.lij)}  (${z}/${T-1}) nedge ${M} :${Ka($f)} vs ${Ka(Zf)}  dot = ${Ae} : ${Ka(Ve)}`;console.warn("Mismatch in tile edge normal: ",_e());{t.updateEdgeElevations(),c.updateEdgeElevations();let L=w(),N=w();g.getEdgeNormal(l,L,B),x.getEdgeNormal(M,N,z),zc($f,L)||console.warn("Missing update in tile normal: ",Ka($f)," => ",Ka(L)),zc(Zf,N)||console.warn("Missing update in neighbor normal: ",Ka(Zf)," => ",Ka(N))}te(He,_e())}}B+=1,z+=1}})}},Il=w(),Al=w(),$f=w(),Zf=w(),Xq=w(),Jq=w(),Pte=1,Da=[null,null,null,null];function dd(e,t){return t?.loaded||t===e?t:null}var Ote=1,Nte=2,Lte=4,Fte=8,wO=4,bO=8,CO=12,SD=[0,1,2,3];var tp=class{get updating(){return!!this._tileRequested}init(t,i,r,n){this.tile=t,this._layerIdx=i,this._layerClass=r,this._suspended=n,this._tileLayerInfo=t.getLayerInfo(i,r),this._tileRequested=null;let s=this._findAncestorWithData();this._setUpsampleTile(s)}startLoading(){return this._requestNext()}dispose(){this._tileRequested&&(this._tileRequested.unrequestLayerData(this._layerIdx,this._layerClass,this),this._tileRequested=null),this.tile=null,this._tileLayerInfo=null}setSuspension(t){t!==this._suspended&&(this._suspended=t,t?this._tileRequested&&(this._tileRequested.unrequestLayerData(this._layerIdx,this._layerClass,this),this._tileRequested=null):this._tileLayerInfo.data||this.update())}update(){let t=this._findAncestorWithData();return this._setUpsampleTile(t),this._requestNext()}dataArrived(t,i){this._setUpsampleTile(t,i),this._tileRequested=null,t===this.tile?this.tile.updateRenderData(this._layerClass,di.FADING,i):this._requestNext()}dataMissing(){this._tileRequested=null,this._tileLayerInfo.data=null,this._requestNext()}_agentDone(){this.tile.agentDone(this._layerIdx,this._layerClass),this.dispose()}_requestNext(){if(this._suspended)return!0;let t=this._findNextDownload();if(this._tileRequested){if(t===this._tileRequested)return!0;this._tileRequested.unrequestLayerData(this._layerIdx,this._layerClass,this),this._tileRequested=null}return t!=null?t.requestLayerData(this._layerIdx,this._layerClass,this)&&(this._tileRequested=t):this._agentDone(),!!this._tileRequested}_findNextDownload(){let t=this._layerIdx,i=this._layerClass,r=this.tile.surface.layerViewByIndex(t,i),{minLevel:n,maxLevel:s}=r.dataLevelRange,o=this._desiredMinLevelDelta,a=this._progressiveLevelModulo+o,l=this._scaleRangeEnabled?ca:()=>!0,c=this.tile,h=c.level,p,m=this._tileLayerInfo.upsampleInfo,f=m?.tile?.level??-1,g=m!=null&&f-h>=o,_=M3(r),v=r.type==="vector-tile-3d"?r.schemaHelper:null;for(;c&&l(c,r)&&c.level>=n;){let b=c.level,x=h-b,E=c.layerInfo[i][t];if(E.data&&x>=o){(!g||b>f)&&this._setUpsampleTile(c),E.dataInvalidated&&(p=c);break}let D=v?.getLevelRowColumn(c.lij)??c.lij;if(_?.getAvailability(D[0],D[1],D[2])!=="unavailable"&&b<=s&&!E.data&&!E.dataMissing&&((!p||c.level===n||b%Aw==0||h-p.level<o)&&(p=c),x>=a))break;c=c.parent}if(p!=null&&h-p.level<o)if(m)p=null;else{let b=this._findAncestorWithData();b!=null&&(this._setUpsampleTile(b),p=b.layerInfo[i][t].dataInvalidated?b:null)}return p}_findAncestorWithData(){let t=this.tile.elevationLevel,i=this._desiredMinLevelDelta,r;for(let n=this.tile;n;n=n.parent)if(n.hasLayerData(this._layerIdx,this._layerClass)){if(t-n.level>=i)return n;r=n}return r}_setUpsampleTile(t,i){this._tileLayerInfo.setUpsampleInfo(this.tile,t),this.tile.updateRenderData(this._layerClass,di.FADING,i)}get test(){}},TO=class extends tp{constructor(){super(...arguments),this.type="none"}get _desiredMinLevelDelta(){throw e8}get _progressiveLevelModulo(){throw e8}dispose(){}},e8=new Error("Abstract method called on TileAgent"),Wn=new TO;var ID=class extends tp{constructor(){super(...arguments),this.type="elevation",this._scaleRangeEnabled=!1}get _desiredMinLevelDelta(){return this.tile.elevationLevelDelta-(this.tile.elevationLevel-this.tile.level)}get _progressiveLevelModulo(){return 0}};function t8(e){return e.type==="elevation"}var AD=class extends tp{constructor(){super(),this.type="map",this._scaleRangeEnabled=!0}get _desiredMinLevelDelta(){return 0}get _progressiveLevelModulo(){return Aw}};function i8(e){return e.type==="map"}var Tr;(function(e){e[e.INSIDE=0]="INSIDE",e[e.INTERSECTS=1]="INTERSECTS",e[e.OUTSIDE=2]="OUTSIDE"})(Tr||(Tr={}));var ip=class{constructor(){this.waitingAgents=new Nt,this.pendingUpdates=0}static acquire(t){let i=EO.acquire();return i._init(t),i}release(){this.dispose(),RD.delete(this),EO.release(this)}dispose(){this.loadingAgent=We(this.loadingAgent),this.abortRequest(),this._unsetUpsampleInfo(),this.pendingUpdates=0,this._data=cu(this._data)}static prune(){EO.prune(0)}_init(t){this.waitingAgents.clear(),this._data=cu(this._data),this.dataMissing=!1,this.dataInvalidated=!1,this._unsetUpsampleInfo(),this.abortRequest(),this.loadingAgent=null,this.pendingUpdates=0,this._pool=t,this.elevationBounds=null}invalidateSourceData(){this.dataInvalidated=!0,this.dataMissing=!1,this._unsetUpsampleInfo()}abortRequest(){this.requestAbort=xr(this.requestAbort),this.requestPromise=null}_unsetUpsampleInfo(){this.upsampleInfo&&(this.upsampleInfo.tile?.unrefMapData(),this._pool.release(this.upsampleInfo),this.upsampleInfo=null)}setUpsampleInfo(t,i){if(t!==i&&i!=null){if(this.upsampleInfo==null)this.upsampleInfo=this._pool.acquire();else{if(this.upsampleInfo.tile===i)return;this.upsampleInfo.tile?.unrefMapData()}i.refMapData(),R3(t,i,this.upsampleInfo)}else this._unsetUpsampleInfo()}get data(){return this._data}set data(t){cu(this._data),this._data=t}},EO=new no(ip,null,()=>{}),RD=new Map;function r8(){RD.size>0&&(console.log(`${RD.size} live TilePerLayerInfo allocations:`),RD.forEach(e=>console.log(e,`
`)))}var we;(function(e){e[e.NONE=0]="NONE",e[e.SPLIT=1]="SPLIT",e[e.ELEVATION=2]="ELEVATION",e[e.MERGE=4]="MERGE",e[e.GEOMETRY=8]="GEOMETRY",e[e.TEXTURE_NOFADING=16]="TEXTURE_NOFADING",e[e.TEXTURE_FADING=32]="TEXTURE_FADING"})(we||(we={}));var kte=.1,hd=class{constructor(){this._lij=[0,0,0],this._children=[null,null,null,null],this._pendingUpdates=0,this.renderData=null,this._dirty=!0,this._previouslyRendered=!1,this.extent=Yt(),this._elevationBoundsMin=NaN,this._elevationBoundsMax=0,this.layerInfo=[[],[]],this.extentInRadians=Yt(),this.centerAtSeaLevel=w(),this._center=[w(),cr(),w()],this.up=U2(),this._withinClippingArea=!0,this._intersectsClippingArea=!0,this._maxTesselation=0,this._usedMemory=0,this._rasterTileMemory=0,this._vectorTileMemory=0,this._mapDataRefCount=0,this.screenDepth=0,this.renderOrder=0,this._edgeLen=0,this._edgeLen2=0,this._curvatureHeight=0,this.extentMidX=0,this.extentMidY=0,this.distanceToPOI=-1,this._lastPOI=w(),this.maxLevelDeltaNeighborCount=0,this.unmergableChildCount=0}get lij(){return this._lij}get elevationLevelDelta(){return this._surface.getElevationLevelDelta(this.level)}static prune(){MO.prune(0),SO.prune(0),ip.prune()}get _cached(){return!this.leaf&&this._mapDataRefCount<=0}get withinClippingArea(){return this._withinClippingArea}get intersectsClippingArea(){return this._intersectsClippingArea}get clippingArea(){return this._clippingArea}get parent(){return this._parent}get children(){return this._children}get surface(){return this._surface}get elevationBoundsMin(){return this._elevationBoundsMin}get elevationBoundsMax(){return this._elevationBoundsMax}get level(){return this._lij[0]}get key(){return`${this._lij[0]}/${this._lij[1]}/${this._lij[2]}`}get edgeLen(){return this._edgeLen}get radius(){return this._center[Fi.MIDDLE][3]}get visible(){return this._dirty&&this.computeVisibility(),this._visible}get frustumVisibility(){return this._dirty&&this.computeVisibility(),this._frustumVisibility}computeVisibility(){this._dirty=!1;let t=this.parent,i=t?.frustumVisibility??Tr.INTERSECTS;this._frustumVisibility=i===Tr.INSIDE?Tr.INSIDE:i===Tr.OUTSIDE?Tr.OUTSIDE:this._calculateFrustumVisibility(this.surface.frustum);let r=this._frustumVisibility!==Tr.OUTSIDE&&this._intersectsClippingArea;r!==this._visible&&(this._visible=r,this._surface.emit("tiles-visibility-changed"),this._surface.renderer.setDirty(),this.updateAgentSuspension())}get _loadable(){return this.visible||this._surface.view.state.fixedContentCamera}get rendered(){let t=!!this.renderData;return t!==this._previouslyRendered&&(this._surface.emit("tiles-visibility-changed"),this._previouslyRendered=t,this._surface.renderer.setDirty()),t}init(t,i,r,n,s){this._lij[0]=t,this._lij[1]=i,this._lij[2]=r,this.ellipsoid=_t(s.tilingScheme.spatialReference),s.tilingScheme.getExtent(t,i,r,this.extent),s.tilingScheme.convertExtentToRadians(this.extent,this.extentInRadians),this.extentMidX=.5*(this.extent[0]+this.extent[2]),this.extentMidY=.5*(this.extent[1]+this.extent[3]),this._withinClippingArea=!0,this._intersectsClippingArea=!0,this._clippingArea=null,this._mapDataRefCount=0,s.upsampleMapCache.pop(this.key),this._edgeLen=0,this._edgeLen2=0,this._center[Fi.MIDDLE][3]=0,this.elevationLevel=t,n&&!Number.isNaN(n.elevationBoundsMin)?(this._elevationBoundsMin=n.elevationBoundsMin,this._elevationBoundsMax=n.elevationBoundsMax):(this._elevationBoundsMin=0,this._elevationBoundsMax=0),this._pendingUpdates=0,this.renderData=null,this.screenDepth=0,this._visible=!1,this._previouslyRendered=!1,this._parent=n,this.clearChildren(),this._surface=s,this.updateVisibility(),this.maxLevelDeltaNeighborCount=0,this.unmergableChildCount=0;for(let o of ad){let a=s.numLayers(o),l=this.layerInfo[o];for(let c of l)c.release();l.length=a;for(let c=0;c<a;c++)l[c]=ip.acquire(this._surface.upsampleInfoPool),o===Ue.ELEVATION&&this.findElevationBoundsForLayer(c,-1)}this.computeElevationBounds(),this._maxTesselation=Math.min(s.tilingScheme.pixelSize,Bd)}dispose(){this._surface!=null&&(ir(!this.renderData,"tile.renderData was not unloaded"),this._surface.upsampleMapCache.pop(this.key),this.layerInfo.forEach(t=>{t.forEach(i=>i.release()),t.length=0}),this._surface=this._parent=null,this.clearChildren(),this.setMemoryDirty())}refMapData(){++this._mapDataRefCount,this._cached||this._surface.upsampleMapCache.pop(this.key)}unrefMapData(){--this._mapDataRefCount,this._cached&&this.cachedMemory>0&&this._surface.upsampleMapCache.put(this.key,this)}setMemoryDirty(){this._usedMemory=0}get usedMemory(){return this._ensureUsedMemory()+(this._cached?0:this._mapTileMemory)}get cachedMemory(){return this._ensureUsedMemory(),this._surface==null?this.usedMemory:this._cached?this._mapTileMemory:0}get _mapTileMemory(){return this._rasterTileMemory+this._vectorTileMemory}get _cpuImageMemorySize(){let i=this._surface.tilingScheme.pixelSize;return i*i*4}_ensureUsedMemory(){if(this._usedMemory>0)return this._vectorTileMemory=this.layerInfo[Ue.MAP].reduce((t,{data:i})=>t+(nm(i)?i.usedMemoryPerReference:0),0),this._usedMemory;this._usedMemory=this._baseUsedMemory,this._rasterTileMemory=0,this._vectorTileMemory=0;for(let{data:t}of this.layerInfo[Ue.MAP])nm(t)?this._vectorTileMemory+=t.usedMemoryPerReference:this._rasterTileMemory+=this.getTerrainDataMemory(t);for(let t of this.layerInfo[Ue.ELEVATION])this._usedMemory+=t.data?this._cpuImageMemorySize:0;return this.renderData&&(this._usedMemory+=this.renderData.estimatedGeometryMemoryUsage,this._rasterTileMemory+=this.renderData.texture?.cachedMemory??0),this._cached&&this._surface.upsampleMapCache.updateSize(this.key,this),this._usedMemory}getUsedMemoryForLayer(t,i){let r=this.layerInfo[t][i];return r?.data?t===Ue.MAP?this._cached?0:this.getTerrainDataMemory(r.data):t===Ue.ELEVATION?this._cpuImageMemorySize:0:0}getTerrainDataMemory(t){return l3(t)?t.texture.usedMemory:a3(t)?t.memoryUsage:nm(t)?t.usedMemoryPerReference:sm(t)||t instanceof HTMLImageElement?this._cpuImageMemorySize:0}updateScreenDepth(t){let i=this._center[Fi.MIDDLE],r=t,n=i[0],s=i[1],o=i[2],a=r[2]*n+r[6]*s+r[10]*o+r[14];this.screenDepth=a<0?0:a/(r[3]*n+r[7]*s+r[11]*o+r[15])}shouldSplit(t,i,r){if(!this.visible)return we.NONE;if(t.frustum&&(!this._intersectsClippingArea||this._calculateFrustumVisibility(t.frustum)===Tr.OUTSIDE))return we.NONE;let n=this.level;ve(OD,this._center[Fi.MIDDLE],i);let s=Ir(OD),o=OD,a=this._center[Fi.MIDDLE];ve(DO,this._center[Fi.TOP],i);let l=Ir(DO);l<s&&(s=l,o=DO,a=this._center[Fi.TOP]),ve(xO,this._center[Fi.BOTTOM],i);let c=Ir(xO);if(c<s&&(s=c,o=xO,a=this._center[Fi.BOTTOM]),this._edgeLen2>s&&n<t.maxLod)return we.SPLIT;let h=Math.sqrt(s),p=t.fovX*h*2,m=this._edgeLen/p,f=()=>{if(n<t.maxLod)return this.elevationLevel=n,we.NONE;let I=n+Math.ceil(-Math.log2(t.relativeWidthLimit/m));return I!==this.elevationLevel?(this.elevationLevel=I,we.ELEVATION):we.NONE},g=r!=null?r-n:1/0;if(g<=.5)return f();let _=ae(this.up,OD),v=this._elevationBoundsMax-this._elevationBoundsMin,b=v/this.edgeLen;if(t.aboveGround&&_>0&&b<.001&&_/h-Math.sin(this._curvatureHeight/(this.edgeLen*Math.SQRT1_2)*Math.PI)-b>0)return we.NONE;let x=r!=null?3-Math.min(g,2):1;if(m*x<t.relativeWidthLimit||n>=t.maxLod)return f();if(n<7)return we.SPLIT;X(kr,this.up,_),ve(kr,kr,o);let E=Ir(kr);if(E<=this.radius*this.radius)return we.SPLIT;X(kr,kr,this.radius/Math.sqrt(E)),he(kr,kr,a),ve(kr,i,kr);let D=Math.min(1,(Math.abs(ae(kr,this.up))+.5*v+this._curvatureHeight)/xe(kr)),M=kte/t.angledSplitBias,T=t.fovY*h*2;return D*(this._edgeLen/T*x)<M*t.relativeHeightLimit?we.NONE:we.SPLIT}createChildren(){let t=this._children,i=this.lij[0]+1,r=2*this.lij[1],n=2*this.lij[2];return t[0]=this.surface.createTile(i,r,n,this),t[1]=this.surface.createTile(i,r,n+1,this),t[2]=this.surface.createTile(i,r+1,n,this),t[3]=this.surface.createTile(i,r+1,n+1,this),t}clearChildren(){this._children[0]=this._children[1]=this._children[2]=this._children[3]=null}get loaded(){return this.renderData?.hasGeometry??!1}load(){this.refMapData();for(let t of ad)this._createOrUpdateAgents(0,t);this.surface.renderer.loadTile(this)}unload(){this.renderData&&this.unrefMapData(),this.surface.renderer.unloadTile(this);for(let t of ad){let i=this.layerInfo[t];for(let r of i)r.loadingAgent&&r.loadingAgent!==Wn&&(PD(r.loadingAgent),r.loadingAgent=null),r.pendingUpdates=0}this.resetPendingUpdate(we.GEOMETRY),this.resetPendingUpdate(we.TEXTURE_NOFADING),this.resetPendingUpdate(we.TEXTURE_FADING)}unloadMapData(){let t=this.layerInfo[Ue.MAP];for(let i of t)i.loadingAgent&&i.loadingAgent!==Wn&&(PD(i.loadingAgent),i.loadingAgent=null),i.pendingUpdates=0,i.invalidateSourceData();this.renderData&&this.renderData.releaseTexture(),this.setMemoryDirty()}updateClippingStatus(t){if(Ko(t,this._clippingArea))return!1;let i=this._intersectsClippingArea,r=this._withinClippingArea;t!=null?(this._intersectsClippingArea=this.intersectsExtent(t),this._withinClippingArea=this._isWithinExtent(t)):(this._intersectsClippingArea=!0,this._withinClippingArea=!0),this._clippingArea=t,this.updateVisibility();let n=r&&this._withinClippingArea,s=!(r||i||this._withinClippingArea||this._intersectsClippingArea);return!this.renderData||n||s||this.setPendingUpdate(we.GEOMETRY),!0}updateVisibility(){this._dirty=!0,this._surface.setTileTreeDirty()}getLayerInfo(t,i){return this.layerInfo[i][t]}hasLayerData(t,i){let r=this.layerInfo[i][t];return!(!r?.data||r.dataInvalidated)}get updating(){if(this.hasPendingUpdates)return!0;for(let t of ad){let i=this.layerInfo[t];for(let r of i)if(r.loadingAgent&&r.loadingAgent!==Wn&&r.loadingAgent.updating)return!0}return!1}_isSuspended(t){return!!this.hasPendingUpdate(we.SPLIT)||t!==Ue.ELEVATION&&!this._loadable}get hasPendingUpdates(){return this._pendingUpdates!==0}hasPendingUpdate(t){return(this._pendingUpdates&t)===t}setPendingUpdate(t){let i=this._pendingUpdates;return this._pendingUpdates|=t,t===we.SPLIT||t===we.MERGE?this._surface.setTileTreeDirty():this._surface.requestUpdate(),i!==this._pendingUpdates}resetPendingUpdate(t){return!!this.hasPendingUpdate(t)&&(this._pendingUpdates&=~t,!0)}requestLayerData(t,i,r){let n=this.layerInfo[i][t];if(n.waitingAgents.has(r))return console.warn("agent already requested this piece of map data (tile %s, agent tile %s, layer: %d/%d)",this._lij.toString(),r.tile.lij.toString(),i,t),!0;if(n.waitingAgents.push(r),n.data&&!n.dataInvalidated){console.warn("agent requested existing data (tile %s, agent tile %s, layer: %d/%d)",this._lij.toString(),r.tile.lij.toString(),i,t);let a=nm(n.data);return r.dataArrived(this,a),!0}if(n.requestPromise)return!0;xr(n.requestAbort),n.requestAbort=new AbortController;let s=this._surface.requestTileData(this,t,i,n.requestAbort);if(!s)return n.requestAbort=null,!1;let o=()=>{n.requestPromise===s&&(n.requestPromise=null,n.requestAbort=null)};return n.requestPromise=s,s.then(o,o),!0}get leaf(){return this._children[0]==null}hasLij(t){return this._lij[0]===t[0]&&this._lij[1]===t[1]&&this._lij[2]===t[2]}findByLij(t){if(this.hasLij(t))return this;let i=this._children;return i[0]?i[0].findByLij(t)||i[1].findByLij(t)||i[2].findByLij(t)||i[3].findByLij(t):null}distanceToSquared(t){return Ir(ve(kr,this._center[Fi.MIDDLE],t))}containsPoint(t){let i=this.extent;return t[0]>=i[0]&&t[1]>=i[1]&&t[0]<=i[2]&&t[1]<=i[3]}containsPointXY(t,i){let r=this.extent;return t>=r[0]&&i>=r[1]&&t<=r[2]&&i<=r[3]}unrequestLayerData(t,i,r){let n=this.layerInfo[i][t],s=n.waitingAgents,o=s.removeUnordered(r)!=null;ir(o,"agent has not requested this piece of map data"),s.length<1&&(n.abortRequest(),this.setMemoryDirty())}dataArrived(t,i,r){let n=nm(r),s=this.layerInfo[i][t];s.data=r,s.dataInvalidated=!1,s.waitingAgents.forAll(o=>o.dataArrived(this,n)),s.waitingAgents.clear(),this.setMemoryDirty()}dataMissing(t,i){let r=this.layerInfo[i][t];r.dataMissing=!0,r.waitingAgents.forAll(n=>n.dataMissing()),r.waitingAgents.clear(),this.setMemoryDirty()}updateRenderData(t,i,r){switch(r&&this.forEachLoadedNeighbor(n=>n.updateRenderData(t,i)),t){case Ue.MAP:return this._updateTexture(i);case Ue.ELEVATION:return this._updateGeometry()}}_updateTexture(t){this.renderData&&(this.resetPendingUpdate(t===di.FADING?we.TEXTURE_NOFADING:we.TEXTURE_FADING),this.setPendingUpdate(t===di.FADING?we.TEXTURE_FADING:we.TEXTURE_NOFADING))}_updateGeometry(){this.setPendingUpdate(we.GEOMETRY);for(let t of this.layerInfo[Ue.ELEVATION])t.pendingUpdates|=we.GEOMETRY}invalidateLayerData(t,i){this.layerInfo[i][t].invalidateSourceData(),this.restartAgents(i)}computeElevationBounds(){let t=this._elevationBoundsMin,i=this._elevationBoundsMax,r=1/0,n=-1/0,s=this.layerInfo[Ue.ELEVATION],o=!0;for(let a of s)a.elevationBounds!=null&&(r=Math.min(r,a.elevationBounds.min),n=Math.max(n,a.elevationBounds.max),a.elevationBounds.hasNoDataValues||(o=!1));o&&(r=Math.min(r,0),n=Math.max(n,0)),t===r&&i===n||(this._elevationBoundsMin=r,this._elevationBoundsMax=n,this.updateRadiusAndCenter(),this._surface.setTileTreeDirty())}_updateCenter(){let t=this._elevationBoundsMin,i=this._elevationBoundsMax,r=.5*(t+i),n=this._center;X(kr,this.up,r),he(n[Fi.MIDDLE],this.centerAtSeaLevel,kr),X(kr,this.up,t),he(n[Fi.TOP],this.centerAtSeaLevel,kr),X(kr,this.up,i),he(n[Fi.BOTTOM],this.centerAtSeaLevel,kr)}findElevationBoundsForLayer(t,i){let r=this.layerInfo[Ue.ELEVATION][t],n=this.elevationLevelDelta,s=Math.max(this.elevationLevel-n,0),o=r.elevationBounds;if(o!=null&&o.level>=i&&o.level<=s)return;let a=this._surface.layerViewByIndex(t,Ue.ELEVATION);if(!ca(this,a))return;let l=Hte,c=!1,h=r.data;if(h&&h.level<=s){let p=r.data;l.min=p.samplerData.data.minValue,l.max=p.samplerData.data.maxValue,l.hasNoDataValues=p.samplerData.data.hasNoDataValues,l.level=this.level,c=!0}else{let p,m,f=0;for(let g=this._parent;g&&(!m||f<n)&&(f=this.elevationLevel-g.level,p=m||p,m=g.layerInfo[Ue.ELEVATION][t].data,!(!m&&p&&g.level<=s));g=g.parent);m=m||p,m&&(m.computeMinMaxValue(this._lij[0],this._lij[1],this._lij[2],l),l.min!==1/0&&(l.level=m.level,c=!0))}c&&(r.elevationBounds==null&&(r.elevationBounds=new Dl),r.elevationBounds.copyFrom(l))}modifyLayers(t,i,r){let n=this.layerInfo[r];for(let a of n)a.loadingAgent&&a.loadingAgent!==Wn&&(PD(a.loadingAgent),a.loadingAgent=null),a.waitingAgents.clear();for(let a=0;a<n.length;++a)t[a]===void 0&&n[a].release();let s=new Array(...n),o=i.length;n.length=o;for(let a=0;a<o;a++){let l=i[a];n[a]=l>-1?s[l]:ip.acquire(this._surface.upsampleInfoPool)}this.setMemoryDirty()}restartAgents(t){this.renderData&&(this._createOrUpdateAgents(0,t),this.updateRenderData(t,di.FADING))}updateAgents(t){if(this.renderData){let i=this.layerInfo[t];for(let r of i)r.loadingAgent===Wn&&(r.loadingAgent=null);this._createOrUpdateAgents(0,t)}}updateAgentSuspension(){for(let t of ad){let i=this._isSuspended(t);for(let r of this.layerInfo[t])r.loadingAgent&&r.loadingAgent!==Wn&&(r.loadingAgent.setSuspension(i),r.loadingAgent===Wn&&this.updateRenderData(t,di.FADING))}}removeLayerAgent(t,i){let r=this.layerInfo[i][t];r.loadingAgent&&r.loadingAgent!==Wn&&r.loadingAgent.dispose(),r.loadingAgent=null}agentDone(t,i){let r=this.layerInfo[i][t];r.loadingAgent=Wn,r.data||r.upsampleInfo!=null||this._createOrUpdateAgents(t+1,i)}_hasBlendableAncestor(t){return t.blendMode!=="normal"||Uc(t.parent)&&this._hasBlendableAncestor(t.parent)}_hasBlendModes(t,i,r){for(let n=t;n<i;++n){let s=this._surface.layerViewByIndex(n,r);if(lu(s)&&s?.layer?.blendMode!=="normal"||Uc(s?.layer?.parent)&&this._hasBlendableAncestor(s?.layer?.parent))return!0}return!1}_createOrUpdateAgents(t,i){let r=this.layerInfo[i];if(r.length===0)return;let n=this._isSuspended(i);for(let s=t;s<r.length;++s){let o=r[s],a=this._surface.layerViewByIndex(s,i),l=!1;if(o.loadingAgent?ca(this,a)?(o.loadingAgent!==Wn&&o.loadingAgent.setSuspension(n),o.loadingAgent!==Wn&&(l=o.loadingAgent.update())):o.dispose():ca(this,a)&&(o.loadingAgent=Vte(this,s,i,n),l=o.loadingAgent.startLoading(),l?o.loadingAgent===Wn&&this.setPendingUpdate(we.GEOMETRY):(PD(o.loadingAgent),o.loadingAgent=Wn)),o.loadingAgent===Wn&&this.updateRenderData(i,di.FADING),!this._hasBlendModes(t,r.length,i)&&l&&a.isOpaque)return}}_isWithinExtent(t){let i=this.extent;return i[0]>=t[0]&&t[2]>=i[2]&&i[1]>=t[1]&&t[3]>=i[3]}intersectsExtent(t){let i=this.extent;return i[2]>=t[0]&&t[2]>=i[0]&&i[3]>=t[1]&&t[3]>=i[1]}getElevationVerticesPerSide(t){let i=this.elevationLevel-this.level,r=Math.max(this.level-t,this.elevationLevelDelta-i),n=q(1+(this._maxTesselation>>r),2,this._maxTesselation+1),s=this.minimumVerticesPerSide;return Math.max(n,s)}_findLIJ(t,i){if(!t)return null;let r=this.surface.rootTiles;if(r!=null){for(let n of r)if(Bte(n,t)){let s=n,o=t[0]-s.level-1;for(;o>=0&&!s.leaf&&!i(s);){let a=t[1]>>o&1,l=t[2]>>o&1;s=s.children[2*a+l],o--}return i(s)?s:null}}return null}findNeighborTile(t,i){let r=this._lij,n=this._getNeighborLIJ(r,t);return n?rv(r,n)?i(this)?this:null:this._findLIJ(n,i):null}findCorner(t,i){let r=t===ii.NORTH_EAST?1:t===ii.NORTH_WEST?0:t===ii.SOUTH_WEST?2:3,n=this;for(;n.children[0]&&(!i||!i(n));)n=n.children[r];return n}findNeighborCornerTileExact(t,i){return this.findNeighborTile(t,r=>i(r)||r.level===this.level)?.findCorner(lm(t),i)||null}forAllSubtreeOnSide(t,i){let r=t===ii.NORTH?[0,1]:t===ii.NORTH_EAST?[1]:t===ii.EAST?[1,3]:t===ii.SOUTH_EAST?[3]:t===ii.SOUTH?[2,3]:t===ii.SOUTH_WEST?[2]:t===ii.WEST?[0,2]:[0],n=s=>{let o=s.children;!i(s)&&o[0]&&r.forEach(a=>n(o[a]))};n(this)}getNeighborEdgeStartVertexIndex(t,i){if(!i)return 0;let r=this.level-i.level;if(te(!Ki||r>=0),r===0)return 0;let n=2**r,s=!(1&~t),o=s?0:1,a=i.lij[o+1]*n,l=this._lij[o+1],c=l-a,h=s?n-1-c:c;return Ki&&(te(a<=l&&l<a+n),te(0<=h&&h<n)),h}forEachLoadedNeighbor(t){let i=this.level,r=n=>n.level===i||n.loaded;Bn.forEach(n=>{let s=this.findNeighborTile(n,r);s!=null&&s!==this&&s.forAllSubtreeOnSide(cm(n),o=>!!o.loaded&&(t(o,n),!0))}),jd.forEach(n=>{let s=this.findNeighborTile(n,r)?.findCorner(lm(n),o=>o.loaded);te(!s||ND(this,s,n)),s?.loaded&&t(s,n)})}_getNeighborLIJ(t,i){let r=MM(i)?-1:xM(i)?1:0,n=EM(i)?-1:DM(i)?1:0,s=[t[0],t[1]+r,t[2]+n];return s[1]<0?null:this.surface.isGlobal?this._wrapLIJ(s):s[2]<0?null:s}_wrapLIJ(t){return!t||t[1]<0||t[1]>=2**t[0]?null:this.surface.wrapEastWest(t)}isEdgeNeighbor(t,i){if(t==null)return!1;if(this.level===0&&t.level===0&&(this._eastEnd&&t._westEnd&&i===ii.EAST||this._westEnd&&t._eastEnd&&i===ii.WEST))return!0;let r=Math.max(1e-6*(this.extent[2]-this.extent[0]),1);switch(i){case ii.NORTH:return Hn(this.extent[3],t.extent[1],r);case ii.SOUTH:return Hn(this.extent[1],t.extent[3],r);case ii.EAST:return Hn(this.extent[2],t.extent[0],r)||Hn(this.extent[2],-t.extent[0],r);case ii.WEST:return Hn(this.extent[0],t.extent[2],r)||Hn(this.extent[0],-t.extent[2],r)}}get _eastEnd(){return this._lij[2]===this.surface.lijEastEnd(this.level)-1}get _westEnd(){return this._lij[2]===0}checkGeometryWaterproofness(){i_&&(te(this.loaded),this.renderData?.checkGeometryWaterproofness())}shouldHaveNeighbor(t){let i=this.extent,r=this.surface.rootTilesExtent,n=.25*(i[2]-i[0]);if(MM(t)&&i[3]+n>=r[3]||xM(t)&&i[1]-n<=r[1])return!1;let s=this.surface.isGlobal;return!(!s&&EM(t)&&i[0]-n<=r[0])&&!(!s&&DM(t)&&i[2]+n>=r[2])}updateDistanceToPOI(t){let i=this._lastPOI;if(this.distanceToPOI>=0&&i[0]===t[0]&&i[1]===t[1]&&i[2]===t[2])return;ee(this._lastPOI,t);let r=this._center[Fi.MIDDLE],n=t[0]-r[0],s=t[1]-r[1],o=t[2]-r[2];this.distanceToPOI=n*n+s*s+o*o}};function Vte(e,t,i,r){let n=i===Ue.ELEVATION?SO.acquire():MO.acquire();return n.init(e,t,i,r),n}function PD(e){e.dispose(),t8(e)?SO.release(e):i8(e)&&MO.release(e)}var MO=new no(AD),SO=new no(ID),Hte=new Dl,Fi;function Bte(e,t){let i=e.lij,r=t[0]-i[0];return!(r<0)&&t[1]>>r===i[1]&&t[2]>>r===i[2]}function rv(e,t){return e[0]===t[0]&&e[1]===t[1]&&e[2]===t[2]}function ND(e,t,i){return e!=null&&t!=null&&t!==e&&(e.level>=t.level?n8(e,t,i):n8(t,e,lm(i)))}function n8(e,t,i){te(e.level>=t.level);let r=v3(i),n=w3(i),s=e.extent,o=t.extent,a=[r?s[0]:s[2],n?s[3]:s[1]],l=[r?o[2]:o[0],n?o[1]:o[3]],c=1e-5*(s[2]-s[0]),h=Hn(a[0],l[0],c)||e.surface.isGlobal&&Hn(a[0],-l[0],c),p=Hn(a[1],l[1],c);if(h&&p)return!0;if(e.level===t.level)return te(!1),!1;if(!h&&!p)return te(!1),!1;let m=h?s8(o[1],o[3],s[1],s[3],c):s8(o[0],o[2],s[0],s[2],c);return te(m),m}function s8(e,t,i,r,n){return e-n<=i&&i<=r&&r<=t+n}(function(e){e[e.TOP=0]="TOP",e[e.MIDDLE=1]="MIDDLE",e[e.BOTTOM=2]="BOTTOM"})(Fi||(Fi={}));var OD=w(),DO=w(),xO=w(),kr=w();var Ute=65536;function o8(e,t){let{tile:i,geometry:r,geometryState:n}=e,{extentInRadians:s,surface:o}=i,{isWebMercator:a,renderer:l}=o,{numVerticesPerSide:c,wireframe:h}=n,p=c-1,m=(c-2)**2,f=a&&(t===yo.HAS_SOUTH_POLE||t===yo.HAS_BOTH_POLES),g=a&&(t===yo.HAS_NORTH_POLE||t===yo.HAS_BOTH_POLES),_=((f?1:0)+(g?1:0))*LD*c,v=S8(n),b=m+_+4*v,x=l.tileGeometryCache.acquire(b);r.numVerticesPerSide=c,r.vertexAttributes=x,r.maxEdgeVertexCount=v;let{boundingBox:E}=r;Ul(E);let D=PO(e);Vr.update(p,s,D),zte(e),r.poleVerticesStartIndex=m;let M=jte(e,f,g);r.edgeVerticesStartIndex=m+_,NO(e),RO(e),w8(r,M,h),e.intersectionData=null}function jte(e,t,i){let{tile:r,localOrigin:n,geometry:s}=e,{extent:o,ellipsoid:a}=r,{boundingBox:l,numVerticesPerSide:c,vertexAttributes:h,poleVerticesStartIndex:p}=s,m=c-1,f=n[0],g=n[1],_=n[2],v=a.radius,b=o[1],x=o[3],E=[],D=p,M=(T,I)=>{let A=I*c;zo(-f,-g,T*v-_,l),E.push(new AO(T===1,A,T===1?0:2,D,LD));let O=h8(T===-1?b:x,v),$=T*Math.PI/2-O,H=.99*(T===1?1:-1),k=v+0,{position:K,uv0:F}=h,{typedBuffer:R,typedBufferStride:j}=h.normalCompressed;for(let B=1;B<=LD;++B){let z=O+$*(B/LD),ce=Math.cos(z),ue=Math.sin(z);for(let Ie=0;Ie<=m;Ie++){let le=Ie/m,ze=Vr.sinLonLUT[Ie],Le=Vr.cosLonLUT[Ie]*ce,de=ze*ce,fe=ue,st=Le*k-f,De=de*k-g,Ee=fe*k-_;zo(st,De,Ee,l),K.setValues(D,st,De,Ee),jo(F,D,le,H),Rd(R,D,Le,de,fe,j),++D}}};return t&&M(-1,0),i&&M(1,m),E}function zte(e){let{tile:t}=e;if(!t.intersectsClippingArea)return;let{geometry:i,geometryState:r,localOrigin:n}=e,{numVerticesPerSide:s,samplerData:o}=r,a=s-2,l=s-1,{vertexAttributes:c,boundingBox:h}=i,p=c.position,m=c.uv0,{typedBuffer:f,typedBufferStride:g}=c.normalCompressed,{extent:_}=t,v=_[0],b=_[2],x=_[1],E=_[3],D=t.ellipsoid.radius,M=n[0],T=n[1],I=n[2],A=p.typedBuffer,O=p.typedBufferStride,$=1/l,H=0;if(1<=a){let k=$,K=x*(1-k)+E*k,F=Vr.sinLatLUT[1],R=Vr.cosLatLUT[1];for(let j=1;j<=a;j++){let B=j*$,z=v*(1-B)+b*B,ce=Vr.sinLonLUT[j],ue=Vr.cosLonLUT[j],Ie=D+gi(z,K,o),le=Ie*ue*R-M,ze=Ie*ce*R-T,Le=Ie*F-I;zo(le,ze,Le,h);let de=(j-1)*O;A[de]=le,A[de+1]=ze,A[de+2]=Le,jo(m,j-1,B,k)}}for(let k=1;k<=a;k++){let K=k*$,F=x*(1-K)+E*K,R=Vr.sinLatLUT[k],j=Vr.cosLatLUT[k],B=k+1,z=B*$,ce=x*(1-z)+E*z,ue=Vr.sinLatLUT[B],Ie=Vr.cosLatLUT[B],le=Vr.sinLonLUT[0],ze=Vr.cosLonLUT[0],Le=D+gi(v,F,o),de=ze*j*Le-M,fe=le*j*Le-T,st=R*Le-I,De=H*O,Ee=A[De],Ae=A[De+1],He=A[De+2];for(let Ve=1;Ve<=a;Ve++){let _e=Ve*$,L=v*(1-_e)+b*_e,N=Vr.sinLonLUT[Ve],V=Vr.cosLonLUT[Ve],U=0,Y=0,re=0;if(Ve<a){let gt=(H+1)*O;U=A[gt],Y=A[gt+1],re=A[gt+2]}else{let gt=Vr.sinLonLUT[l],wt=Vr.cosLonLUT[l],xt=D+gi(b,F,o);U=wt*j*xt-M,Y=gt*j*xt-T,re=R*xt-I}let ye=de,J=fe,Z=st;de=Ee,fe=Ae,st=He,Ee=U,Ae=Y,He=re;let Q=U-ye,pe=Y-J,Me=re-Z,et=0,Je=0,$e=0;if(k>1){let gt=(H-a)*O;et=A[gt],Je=A[gt+1],$e=A[gt+2]}else{let gt=Vr.sinLatLUT[0],wt=Vr.cosLatLUT[0],xt=D+gi(L,x,o);et=V*wt*xt-M,Je=N*wt*xt-T,$e=gt*xt-I}let Ke=D+gi(L,ce,o),at=V*Ie*Ke-M,Ze=N*Ie*Ke-T,Ge=ue*Ke-I;if(k<a){let gt=H+a,wt=gt*O;A[wt]=at,A[wt+1]=Ze,A[wt+2]=Ge,zo(at,Ze,Ge,h),jo(m,gt,_e,z)}let y=et-at,qe=Je-Ze,je=$e-Ge,tt=V*j,dt=N*j,it=R;it*it<.999&&(tt=Me*qe-pe*je,dt=Q*je-Me*y,it=pe*y-Q*qe);let Ye=1/Math.sqrt(tt*tt+dt*dt+it*it);Rd(f,H,tt*Ye,dt*Ye,it*Ye,g),++H}}}function a8(e){e.tile.intersectsClippingArea&&(RO(e),Kf(e),e.intersectionData=null)}function l8(e){e.tile.intersectsClippingArea&&(T8(e),RO(e),Kf(e),x8(e),e.intersectionData=null)}function c8(e){e.tile.intersectsClippingArea&&(d8(e),u8(e,!0),Kf(e),e.intersectionData=null)}function RO(e){e.tile.intersectsClippingArea&&(d8(e),u8(e))}function u8(e,t=!1){let{geometry:i,geometryState:r,tile:n,localOrigin:s}=e,{level:o,extent:a,extentInRadians:l,ellipsoid:c}=n,h=c.radius,p=l[0],m=l[2],f=l[1],g=l[3],{samplerData:_}=r,v=a[0],b=a[2],x=a[1],E=a[3],D=PO(e),{boundingBox:M,vertexAttributes:T}=i,I=s[0],A=s[1],O=s[2],$=T.position,H=$.typedBuffer,k=$.typedBufferStride,K=T.uv0;for(let F=0;F<4;++F){let R=F===1||F===3,j=r.edgeResolutions[F];te(wd(j));let B=j+1,z=dd(n,r.edgePeerNeighbors[F]);if(M8(n,z,F)){E8(e,F,z);continue}let ce=z!=null;te(!ce||z.level===n.level),te(!ce||wo(n,z)<=0);let ue=z?.renderData,Ie=ue?.geometryState;if(Ki){let Q=n.surface;if(!z&&Q&&!Q.updatingRootTiles){let pe=Bn[F],Me=n.findNeighborTile(pe,et=>et.loaded||et.leaf||et.level===n.level);Me?Me.intersectsClippingArea&&(te(!Me.loaded),te(!Me.leaf),te(Me.level===o)):te(Q?.rootTiles==null||!n.shouldHaveNeighbor(pe))}}let le=F===1?a[2]:a[0],ze=z?.extent,Le=ze&&R?F===1?ze[0]:ze[2]:le,de=F===0?a[3]:a[1],fe=F===1?1:0,st=F===0?1:0,De=F===1?m:p,Ee=F===0?g:f,Ae=Math.sin(De),He=Math.cos(De),Ve=Math.sin(Ee),_e=Math.cos(Ee),L=Ie?.samplerData,N=ce?(Q,pe,Me)=>.5*(gi(Q,pe,_)+gi(Me,pe,L)):(Q,pe,Me)=>gi(Q,pe,_),V=i.outerEdgesOffsetAndLength[2*F+0],U=t&&B>3?B-3:1,Y=_!=null&&_.some(Q=>Q!=null),re=L!=null&&L.some(Q=>Q!=null),ye=Y||re,J=1/j,Z=V;te(!ze||Hn(ze[2]-ze[0],a[2]-a[0])),(()=>{let Q=F===1?-1:F===3?1:0,pe=F===0?-1:F===2?1:0,Me=(a[2]-a[0])*J,et=Q*Me,Je=pe*Me,$e=R?Q*((m-p)*J):0,Ke=R?0:pe*J,at=st,Ze=R?De+$e:De,Ge=R?Math.sin(Ze):Ae,y=R?Math.cos(Ze):He,qe=R?De-$e:De,je=R?Math.sin(qe):Ae,tt=R?Math.cos(qe):He,dt=R?Ee:D(at+Ke),it=R?Ve:Math.sin(dt),Ye=R?_e:Math.cos(dt),gt=R?Ee:D(at-Ke),wt=R?Ve:Math.sin(gt),xt=R?_e:Math.cos(gt),bi=0,Ci=0,li=0;{let Qe=0*J,zt=R?le:v*(1-Qe)+b*Qe,Ot=R?Le:zt,se=R?x*(1-Qe)+E*Qe:de,ri=R?De:p*(1-Qe)+m*Qe,jr=R?Ae:Math.sin(ri),Qn=R?He:Math.cos(ri),Mt=R?D(Qe):Ee,Ds=R?Math.sin(Mt):Ve,Pn=R?Math.cos(Mt):_e,Er=h+N(zt,se,Ot);bi=Qn*Pn*Er,Ci=jr*Pn*Er,li=Ds*Er}let ci=0,jt=0,bt=0;{let Qe=1*J,zt=R?le:v*(1-Qe)+b*Qe,Ot=R?Le:zt,se=R?x*(1-Qe)+E*Qe:de,ri=R?De:p*(1-Qe)+m*Qe,jr=R?Ae:Math.sin(ri),Qn=R?He:Math.cos(ri),Mt=R?D(Qe):Ee,Ds=R?Math.sin(Mt):Ve,Pn=R?Math.cos(Mt):_e,Er=h+N(zt,se,Ot);ci=Qn*Pn*Er,jt=jr*Pn*Er,bt=Ds*Er}for(let Qe=1;Qe<B-1;Qe+=U){let zt=0,Ot=0,se=0;{let Gr=(Qe+1)*J,Kn=R?le:v*(1-Gr)+b*Gr,to=R?Le:Kn,er=R?x*(1-Gr)+E*Gr:de,Xn=R?De:p*(1-Gr)+m*Gr,Sa=R?Ae:Math.sin(Xn),kc=R?He:Math.cos(Xn),Ss=R?D(Gr):Ee,io=R?Math.sin(Ss):Ve,Ll=R?Math.cos(Ss):_e,Ia=h+N(Kn,er,to);zt=kc*Ll*Ia,Ot=Sa*Ll*Ia,se=io*Ia}let ri=zt,jr=Ot,Qn=se,Mt=ci,Ds=jt,Pn=bt;ci=ri,jt=jr,bt=Qn;{let Gr=Z+Qe,Kn=Gr*k,to=Mt-I,er=Ds-A,Xn=Pn-O;H[Kn]=to,H[Kn+1]=er,H[Kn+2]=Xn,zo(to,er,Xn,M);let Sa=Qe*J;jo(K,Gr,R?fe:Sa,R?Sa:st)}let Er=bi,xs=Ci,or=li;bi=Mt,Ci=Ds,li=Pn;let zr=Mt,eo=Ds,Ms=Pn,ar=1/Math.sqrt(zr*zr+eo*eo+Ms*Ms),Dr=Ms*ar,_i=0,Yn=0,Ma=0;if(ye&&Dr*Dr<.999){let Gr=0,Kn=0,to=0;{let er=F===0?-1:1;Gr=er*(ri-Er),Kn=er*(jr-xs),to=er*(Qn-or)}{let er=Qe*J,Xn=R?le:v*(1-er)+b*er,Sa=R?Le:Xn,kc=R?x*(1-er)+E*er:de,Ss=R?De:p*(1-er)+m*er,io=R?Ae:Math.sin(Ss),Ll=R?He:Math.cos(Ss),Ia=R?D(er):Ee,pp=R?Math.sin(Ia):Ve,mp=R?Math.cos(Ia):_e,Aa=zr,_d=eo,yd=Ms;if(ce){let Is=h+gi(Sa-et,kc-Je,L),Ra=R?mp:xt;Aa=(R?tt:Ll)*Ra*Is,_d=(R?je:io)*Ra*Is,yd=(R?pp:wt)*Is}{let Is=h+gi(Xn+et,kc+Je,_),Ra=R?mp:Ye,Vc=(R?y:Ll)*Ra*Is,fp=(R?Ge:io)*Ra*Is,gp=(R?pp:it)*Is;ce||(Aa=2*zr-Vc,_d=2*eo-fp,yd=2*Ms-gp);let Eg=F===3?-1:1,Zv=Eg*(Aa-Vc),Qv=Eg*(_d-fp),Yv=Eg*(yd-gp);_i=to*Qv-Kn*Yv,Yn=Gr*Yv-to*Zv,Ma=Kn*Zv-Gr*Qv;let Dg=1/Math.sqrt(_i*_i+Yn*Yn+Ma*Ma);_i*=Dg,Yn*=Dg,Ma*=Dg}}}else _i=zr*ar,Yn=eo*ar,Ma=Ms*ar;i.setEdgeNormalFromValues(F,Qe,_i,Yn,Ma)}})()}}function d8(e){D8(e)}function h8(e,t){return Math.PI/2-2*Math.atan(Math.exp(-e/t))}function Gte(e,t,i,r){return h8(e*(1-r)+t*r,i)}function qte(e,t,i){return e*(1-i)+t*i}function PO(e){let{tile:t}=e;if(t.surface.isWebMercator){let r=t.extent,n=t.ellipsoid.radius;return s=>Gte(r[1],r[3],n,s)}let i=t.extentInRadians;return r=>qte(i[1],i[3],r)}function p8(e,t){let{tile:i,geometryState:r,geometry:n}=e,{extent:s,surface:o}=i,{wireframe:a}=r,l=s[0],c=s[1],h=s[2]-l,p=s[3]-c,{numVerticesPerSide:m,clippingArea:f}=r,g=f!=null?Math.max(0,(f[0]-l)/h):0,_=f!=null?Math.max(0,(f[1]-c)/p):0,v=f!=null?Math.min(1,(f[2]-l)/h):1,b=f!=null?Math.min(1,(f[3]-c)/p):1,x=(m-2)**2,E=S8(r),D=x+4*E,M=o.renderer.tileGeometryCache.acquire(D),{boundingBox:T}=n;Ul(T),n.numVerticesPerSide=m,n.vertexAttributes=M,n.maxEdgeVertexCount=E,n.minu=g,n.minv=_,n.maxu=v,n.maxv=b,Wte(e),n.edgeVerticesStartIndex=x,NO(e),OO(e),w8(n,[],a),e.intersectionData=null}function Wte(e){let t=e.tile;if(!t.intersectsClippingArea)return;let{geometry:i,geometryState:r,localOrigin:n}=e,{samplerData:s,clippingArea:o,numVerticesPerSide:a}=r,{surface:l,extent:c,ellipsoid:h}=t,{isWebMercatorOnPlateCarree:p}=l,m=o??LO,f=c[0],g=c[1],_=c[2],v=c[3],b=Math.max(f,m[0]),x=Math.min(_,m[2]),E=Math.max(g,m[1]),D=Math.min(v,m[3]),M=h.radius,T=t.horizontalScale,I=a-1,A=a-2,{minu:O,minv:$,maxu:H,maxv:k,boundingBox:K,vertexAttributes:F}=i,R=F.position,j=F.uv0,{typedBuffer:B,typedBufferStride:z}=F.normalCompressed,ce=n[0],ue=n[1],Ie=n[2],le=R.typedBuffer,ze=R.typedBufferStride,Le=0,de=q(g,E,D),fe=p?(Math.PI/2-2*Math.atan(Math.exp(-de/M)))*M:de*T,st=1/I,De=q(g*(1-st)+v*st,E,D),Ee=fe,Ae=p?(Math.PI/2-2*Math.atan(Math.exp(-De/M)))*M:De*T;for(let He=1;He<=A;He++){let Ve=He/I,_e=q(g*(1-Ve)+v*Ve,E,D),L=q(Ve,$,k),N=Ae,V=(He-1)/I,U=q(g*(1-V)+v*V,E,D),Y=Ee,re=(He+1)/I,ye=q(g*(1-re)+v*re,E,D),J=p?(Math.PI/2-2*Math.atan(Math.exp(-ye/M)))*M:ye*T,Z=q(re,$,k);Ee=Ae,Ae=J;let Q=q(f,b,x),pe=Q*T,Me=gi(Q,_e,s),et=1/I,Je=q(et,O,H),$e=q(f*(1-Je)+_*Je,b,x),Ke=Je,at=$e,Ze=$e*T,Ge=gi($e,_e,s);if(He===1){let y=Ze-ce,qe=Ee-ue,je=Ge-Ie,tt=0*ze;le[tt]=y,le[tt+1]=qe,le[tt+2]=je,zo(y,qe,je,K);let dt=q(et,O,H);jo(j,Le,dt,L)}for(let y=1;y<=A;y++){let qe=Ze,je=Ge,tt=(y+1)/I,dt=q(tt,O,H),it=q(f*(1-tt)+_*tt,b,x),Ye=at;at=it;{let jt=Le+1,bt=jt*ze;if(He===1||y===A){let Qe=it*T,zt=gi(it,_e,s);if(He===1&&y<A){let Ot=Qe-ce,se=N-ue,ri=zt-Ie;le[bt]=Ot,le[bt+1]=se,le[bt+2]=ri,zo(Ot,se,ri,K),jo(j,jt,dt,L)}Ze=Qe,Ge=zt}else Ze=le[bt]+ce,Ge=le[bt+2]+Ie}let gt=Ze,wt=Ge,xt=pe,bi=Me;pe=qe,Me=je;let Ci=(Le-A)*ze,li=He===1?gi(Ye,U,s):le[Ci+2]+Ie,ci=gi(Ye,ye,s);if(He<A){let jt=Le+A,bt=jt*ze,Qe=qe-ce,zt=J-ue,Ot=ci-Ie;le[bt]=Qe,le[bt+1]=zt,le[bt+2]=Ot,zo(Qe,zt,Ot,K);let se=Ke;Ke=dt,jo(j,jt,se,Z)}{let jt=gt-xt,bt=Y-J,Qe=bt*(wt-bi),zt=jt*(li-ci),Ot=-bt*jt,se=Qe*Qe+zt*zt+Ot*Ot;if(se===0)Rd(B,Le,0,0,1,z);else{let ri=1/Math.sqrt(se);Rd(B,Le,Qe*ri,zt*ri,Ot*ri,z)}}++Le}}}function m8(e,t){e.tile.intersectsClippingArea&&(y8(e),_8(e,!0),Kf(e),e.intersectionData=null)}function f8(e,t){e.tile.intersectsClippingArea&&(T8(e),OO(e),Kf(e),x8(e),e.intersectionData=null)}function g8(e,t){e.tile.intersectsClippingArea&&(OO(e),Kf(e),e.intersectionData=null)}function OO(e,t){e.tile.intersectsClippingArea&&(y8(e),_8(e,!1))}function _8(e,t){let{geometry:i,geometryState:r,localOrigin:n}=e,s=e.tile,{surface:o,extent:a}=s,{clippingArea:l,samplerData:c}=r,h=l??LO,p=a[0],m=a[2],f=a[1],g=a[3],_=[g>h[3],m>h[2],f<h[1],p<h[0]],v=s.horizontalScale,b=v8(o.isWebMercatorOnPlateCarree,s.ellipsoid.radius,v),{minu:x,minv:E,maxu:D,maxv:M,boundingBox:T}=i,I=Math.max(p,h[0]),A=Math.min(m,h[2]),O=Math.max(f,h[1]),$=Math.min(g,h[3]),H=n[0],k=n[1],K=n[2];for(let F=0;F<4;++F){let R=F===1||F===3,j=r.edgeResolutions[F];te(wd(j));let B=j+1,z=_[F],ce=dd(s,r.edgePeerNeighbors[F]);if(!z&&M8(s,ce,F)){E8(e,F,ce);continue}let ue=ce!=null&&!z,Ie=ce?.renderData,le=Ie?.geometryState;if(Ki&&(te(!ue||ce.level===s.level),te(!ue||wo(s,ce)<=0),s&&!ce&&!o.updatingRootTiles)){let J=Bn[F],Z=s.findNeighborTile(J,Q=>Q.loaded||Q.leaf||Q.level===s.level);o.updatingRootTiles||(Z?Z.intersectsClippingArea&&(te(!Z.loaded),te(!Z.leaf),te(Z.level===s.level)):te(o?.rootTiles==null||!s.shouldHaveNeighbor(J)))}let ze=q(F===1?m:p,I,A),Le=q(F===0?g:f,O,$),de=le?.samplerData,fe=t&&B>3?B-3:1,st=q(F===1?1:0,x,D),De=q(F===0?1:0,E,M),Ee=ue?(J,Z)=>.5*(gi(J,Z,de)+gi(J,Z,c)):(J,Z)=>gi(J,Z,c),Ae=(m-p)/j,He=R?F===1?Ae:-Ae:0,Ve=R?0:F===0?Ae:-Ae,_e=-He,L=-Ve,N=0,V=0,U=0;{let J=0/j,Z=R?ze:q(p*(1-J)+m*J,I,A),Q=R?q(f*(1-J)+g*J,O,$):Le,pe=Ee(Z,Q);N=Z*v,V=b(Q),U=pe}let Y=0,re=0,ye=0;{let J=1/j,Z=R?ze:q(p*(1-J)+m*J,I,A),Q=R?q(f*(1-J)+g*J,O,$):Le,pe=Ee(Z,Q);Y=Z*v,re=b(Q),ye=pe}for(let J=1;J<B-1;J+=fe){let Z=J/j,Q=Y,pe=re,Me=ye;{let je=R?st:q(Z,x,D),tt=R?q(Z,E,M):De,dt=Q-H,it=pe-k,Ye=Me-K;zo(Q,it,Ye,T),i.setEdgeVertexFromValuesRawPositionUV(F,J,dt,it,Ye,je,tt)}{let je=(J+1)/j,tt=R?ze:q(p*(1-je)+m*je,I,A),dt=R?q(f*(1-je)+g*je,O,$):Le,it=Ee(tt,dt);Y=tt*v,re=b(dt),ye=it}let et=Y,Je=ye,$e=N,Ke=V,at=U;N=Q,V=pe,U=Me;let Ze=0,Ge=0,y=0;if(R){let je=re-pe,tt=Je-Me,dt=Ke-pe,it=at-Me,Ye=q(f*(1-Z)+g*Z,O,$),gt=ze+_e,wt=gt*v-Q,xt=gi(gt,Ye,c)-Me,bi=F===3?-1:1;if(Ze=bi*(-dt+je)*xt,Ge=bi*wt*(-it+tt),y=-bi*wt*(-dt+je),ue){let Ci=ze+He,li=Ci*v-Q;Ze=(-dt+je)*(xt-(gi(Ci,Ye,de)-Me)),Ge=(wt-li)*(-it+tt),y=-(wt-li)*(-dt+je)}}else{let je=et-Q,tt=Je-Me,dt=$e-Q,it=at-Me,Ye=q(p*(1-Z)+m*Z,I,A),gt=Le+L,wt=gi(Ye,gt,c)-Me,xt=b(gt)-pe,bi=F===2?-1:1;if(Ze=bi*xt*(-it+tt),Ge=bi*(-dt+je)*wt,y=-bi*xt*(-dt+je),ue){let Ci=Ye,li=Le+Ve,ci=b(li)-pe;Ze=(-xt+ci)*(-it+tt),Ge=(-dt+je)*(-wt+(gi(Ci,li,de)-Me)),y=-(-xt+ci)*(-dt+je)}}let qe=1/Math.sqrt(Ze*Ze+Ge*Ge+y*y);i.setEdgeNormalFromValues(F,J,Ze*qe,Ge*qe,y*qe)}}}function y8(e,t){D8(e)}function $te(e,t){return(Math.PI/2-2*Math.atan(Math.exp(-e/t)))*t}function Zte(e,t){return e*t}function v8(e,t,i){return e?r=>$te(r,t):r=>Zte(r,i)}function w8(e,t,i){let{numVerticesPerSide:r,vertexAttributes:n,maxEdgeVertexCount:s}=e,o=r-1,a=n.count,l=2*(r-3)*(r-3),c=4*(o+s-3),h=SD.reduce((_,v)=>_+(o+e.getEdgeCount(v)-3),0),p=t.reduce((_,v)=>_+o*(2*(v.latitudeResolution-1)+1),0),m=3*(i?2:1),f=(l+c+p)*m,g=a>=Ute?new Uint32Array(f):new Uint16Array(f);for(let _=0;_<f;++_)g[_]=0;e.indices=g,e.indexCount=(l+h+p)*m,e.poleIndicesStartIndex=l*m,e.edgeIndicesStartIndex=(l+p)*m,i?(Kte(e),Xte(e,t),C8(e)):(Qte(e),Yte(e,t),b8(e))}function Qte(e){let{numVerticesPerSide:t,indices:i,vertexAttributes:r}=e,{position:n}=r,{typedBuffer:s,typedBufferStride:o}=n,a=t-2,l=t-3,c=0,h=t-3,p=0;for(let m=0;m<l;++m){let f=m*a;for(let g=c;g<h;++g){let _=f+g,v=_+1,b=v+a,x=b-1;I8(_,v,b,x,o,s)?(i[p]=_,i[p+1]=v,i[p+2]=b,i[p+3]=b,i[p+4]=x,i[p+5]=_):(i[p]=_,i[p+1]=v,i[p+2]=x,i[p+3]=x,i[p+4]=v,i[p+5]=b),p+=6}}}function Yte(e,t){let{numVerticesPerSide:i,indices:r,poleIndicesStartIndex:n}=e,s=i-1,o=n;for(let a of t){let l=a.isNorth?1:2,c=a.isNorth?2:1,h=a.isNorth?3:4,p=a.isNorth?4:3,m=e.getEdgeVertexIndex(a.connectedOuterEdgeOffset,0),f=1;for(let g=0;g<a.latitudeResolution;++g){let _=g===0?a.rowOffset:m+i;for(let v=0;v<s;v++){let b=_+v;r[o]=m,r[o+l]=m+1,r[o+c]=b,g<a.latitudeResolution-1?(r[o+h]=m+1,r[o+p]=b+1,r[o+5]=b,o+=6):o+=3,m+=f}m=_,f=1}}}function b8(e){let{indices:t,numVerticesPerSide:i,edgeIndicesStartIndex:r}=e,n=i-1,s=n-2,o=r;for(let a=0;a<4;++a){let l=FO[a],c=0,h=0,p=e.getEdgeCount(a),m=l.count;te(m===n-1);let f=a===1||a===2,g=f?1:2,_=f?2:1,v=e.getEdgeFirstVertexIndex(a),b=1,x=l.vertex0Index,E=l.stride;for(;c<p-1||h<m-1;){let D=x+h*E,M=v+c*b,T=c<p-1,I=h<m-1,A=T&&(!I||(T?0+n*(c+.5)/(p-1):0)<=(I?1+s*(h+.5)/(m-1):0));A?++c:++h;let O=A?M+b:D+E;t[o]=D,t[o+g]=M,t[o+_]=O,o+=3}}e.indexCount=o}function Kte(e){let{indices:t,numVerticesPerSide:i,vertexAttributes:r}=e,{position:n}=r,{typedBuffer:s,typedBufferStride:o}=n,a=i-2,l=0;for(let c=0;c<i-3;++c){let h=c*a;for(let p=0;p<i-3;++p){let m=c*a+p,f=m+1,g=f+a,_=g-1,v=h+p,b=v+1,x=b+a;I8(v,b,x,x-1,o,s)?(Yf(t,l,m,f,g),l+=6,Yf(t,l,g,_,m)):(Yf(t,l,m,f,_),l+=6,Yf(t,l,_,g,f)),l+=6}}}function Xte(e,t){let{indices:i,numVerticesPerSide:r,poleIndicesStartIndex:n}=e,s=r-1,o=n;for(let a of t){let l=a.connectedOuterEdgeOffset,c=e.getEdgeVertexIndex(l,0),h=1;for(let p=0;p<a.latitudeResolution;++p){let m=p===0?a.rowOffset:c+r;for(let f=0;f<s;f++)Yf(i,o,c,c+1,m+f),o+=6,p<a.latitudeResolution-1&&(Yf(i,o,c+1,m+f+1,m+f),o+=6),c+=h;c=m,h=1}}}function C8(e){let{indices:t,numVerticesPerSide:i,edgeIndicesStartIndex:r}=e,n=i-1,s=n-2,o=r;for(let a=0;a<4;++a){let l=FO[a],c=0,h=0,p=e.getEdgeCount(a),m=l.count;te(m===n-1);let f=a===1||a===2,g=f?1:3,_=f?3:1,v=e.getEdgeFirstVertexIndex(a),b=1,x=l.vertex0Index,E=l.stride;for(;c<p-1||h<m-1;){let D=x+h*E,M=v+c*b,T=c<p-1,I=h<m-1,A=T&&(!I||(T?0+n*(c+.5)/(p-1):0)<=(I?1+s*(h+.5)/(m-1):0));A?++c:++h;let O=A?M+b:D+E;t[o]=D,t[o+g]=M,t[o+g+1]=M,t[o+_]=O,t[o+_+1]=O,t[o+5]=D,o+=6}}e.indexCount=o}function NO(e){let{geometry:t,geometryState:i}=e,{edgeResolutions:r}=i,{numVerticesPerSide:n,edgeVerticesStartIndex:s}=t,o=n-2,a=s;for(let l=0;l<4;++l){{let c=l===0||l===2,h=(l===0?o-1:0)*o+(l===1?o-1:0),p=(c?0:1)*o+(c?1:0),m=FO[l];m.vertex0Index=h,m.stride=p,m.count=o}{let c=r[l]+1;t.outerEdgesOffsetAndLength[2*l+0]=a,t.outerEdgesOffsetAndLength[2*l+1]=c,a+=c}}}function T8(e){NO(e),e.geometryState.wireframe?C8(e.geometry):b8(e.geometry)}function E8(e,t,i){let{geometryState:r,geometry:n,tile:s,localOrigin:o}=e,a=t===1||t===3,l=r.edgeResolutions[t];te(wd(l));let c=l+1,{boundingBox:h,minu:p,minv:m,maxu:f,maxv:g,vertexAttributes:_}=n,v=q(t===1?1:0,p,f),b=q(t===0?1:0,m,g),x=i.renderData,E=x.geometryState,D=x.geometry,M=(t+2)%4,T=D.getEdgeCount(M),I=s.getNeighborEdgeStartVertexIndex(t,i)*l,A=l*2**(s.level-i.level);te(E.edgeResolutions[M]===A),te(T-1===A);let O=x.localOrigin[0]-o[0],$=x.localOrigin[1]-o[1],H=x.localOrigin[2]-o[2],k=n.getEdgeFirstVertexIndex(t),K=_.position,F=K.typedBuffer,R=K.typedBufferStride,j=_.normalCompressed,B=j.typedBuffer,z=j.typedBufferStride,ce=_.uv0,ue=D.vertexAttributes,Ie=D.getEdgeFirstVertexIndex(M),le=ue.position.typedBuffer,ze=ue.position.typedBufferStride,Le=ue.normalCompressed.typedBuffer,de=ue.normalCompressed.typedBufferStride;for(let fe=1;fe<c-1;++fe){let st=k+fe,De=Ie+(I+fe),Ee=st*R,Ae=De*ze,He=le[Ae]+O,Ve=le[Ae+1]+$,_e=le[Ae+2]+H;F[Ee]=He,F[Ee+1]=Ve,F[Ee+2]=_e,zo(He,Ve,_e,h);let L=st*z,N=De*de;B[L]=Le[N],B[L+1]=Le[N+1];let V=fe/l,U=a?v:q(V,p,f),Y=a?q(V,m,g):b;jo(ce,st,U,Y)}}function D8(e){let{geometry:t,geometryState:i,localOrigin:r}=e,{clippingArea:n,samplerData:s}=i,{minu:o,minv:a,maxu:l,maxv:c,boundingBox:h,vertexAttributes:p}=t,m=e.tile,{surface:f,ellipsoid:g,extent:_,extentInRadians:v,horizontalScale:b}=m,x=f.view?.viewingMode==="local",E=g.radius,D=0,M=0,T=0,I=(L,N,V)=>{let U=v[N===0?1:3],Y=v[L===0?0:2],re=Math.cos(U),ye=Math.sin(U),J=Math.sin(Y),Z=Math.cos(Y),Q=E+V;D=Z*re*Q,M=J*re*Q,T=ye*Q},A=x?(()=>{let L=n,N=L!=null&&(_[3]>L[3]||_[2]>L[2]||_[1]<L[1]||_[0]<L[0]),V=v8(f.isWebMercatorOnPlateCarree,E,b);return(U,Y,re)=>{let ye=U===0?_[0]:_[2],J=Y===0?_[1]:_[3],Z=N?q(ye,L[0],L[2]):ye,Q=N?q(J,L[1],L[3]):J,pe=re;D=Z*b,M=V(Q),T=pe}})():I,O=0,$=0,H=0,k=0,K=0,F=0,R=0,j=0,B=0,z=x&&f.isWebMercatorOnPlateCarree,ce=(L,N,V,U,Y)=>{let re=0,ye=0,J=0;if(x){let Z=N*b,Q=z?(Math.PI/2-2*Math.atan(Math.exp(-V/E)))*E:V*b;re=Z-D,ye=Q-M,J=U-T}else{let Z=PO(L),Q=L.tile,pe=Q.extent,Me=Q.extentInRadians,et=(N-pe[0])/(pe[2]-pe[0]),Je=(V-pe[1])/(pe[3]-pe[1]),$e=Me[0]*(1-et)+Me[2]*et,Ke=Z(Je),at=Math.cos(Ke),Ze=Math.sin(Ke),Ge=Math.sin($e),y=Math.cos($e),qe=E+U;re=y*at*qe-D,ye=Ge*at*qe-M,J=Ze*qe-T}switch(Y){case 0:R+=re,j+=ye,B+=J;break;case 1:k-=re,K-=ye,F-=J;break;case 2:R-=re,j-=ye,B-=J;break;case 3:k+=re,K+=ye,F+=J}},ue=n??LO,Ie=_[0],le=_[2],ze=_[1],Le=_[3],de=[Le>ue[3],le>ue[2],ze<ue[1],Ie<ue[0]],fe=Math.max(Ie,ue[0]),st=Math.min(le,ue[2]),De=Math.max(ze,ue[1]),Ee=Math.min(Le,ue[3]),Ae=L=>Math.max(ue[0],Math.min(ue[2],L)),He=L=>Math.max(ue[1],Math.min(ue[3],L)),Ve=L=>{let N=i.cornerNeighborCornerTiles;O=0,$=0,H=1,k=0,K=0,F=0,R=0,j=0,B=0;let V=1/0;for(let Z=0;Z<4;++Z){let Q=N[4*L+Z];V=Math.min(V,Q?.level??1/0)}for(let Z=0;Z<4;++Z){let Q=N[4*L+Z];nv[Z]=Q?.level===V?Q:null}let U=1,Y=0;for(let Z=0;Z<4;++Z){let Q=nv[Z];Q&&(U=Math.max(U,Q?.renderData.geometryState.numVerticesPerSide),Y=Q.extent[2]-Q.extent[0])}let re=Y,ye=U;te(ye>1);let J=re/ye;for(let Z=0;Z<4;++Z){let Q=nv[(Z+3)%4],pe=nv[Z%4];if(!Q&&!pe)continue;let Me=Z===0?1:Z===1?2:Z===2?3:0,et=Z===0?2:Z===1?3:Z===2?0:1;if(Q&&pe){let Je=IO[Z][0]*J,$e=IO[Z][1]*J,Ke=Q.extent,at=Ae(Ke[Me===0||Me===1?2:0]+Je),Ze=He(Ke[Me===0||Me===3?3:1]+$e),Ge=pe.extent,y=Ae(Ge[et===0||et===1?2:0]+Je),qe=He(Ge[et===0||et===3?3:1]+$e),je=Q.renderData,tt=pe.renderData,dt=gi(at,Ze,je.geometryState.samplerData),it=gi(y,qe,tt.geometryState.samplerData);ce(je,at,Ze,.5*(dt+it),Z)}else{let Je=Q??pe,$e=Q?Me:et,Ke=Je.extent,at=IO[Z],Ze=Ae(Ke[$e===0||$e===1?2:0]+at[0]*J),Ge=He(Ke[$e===0||$e===3?3:1]+at[1]*J),y=Je.renderData,qe=gi(Ze,Ge,y.geometryState.samplerData);ce(y,Ze,Ge,qe,Z)}}if(!x){let Z=Math.sqrt(D*D+M*M+T*T);O=D/Z,$=M/Z,H=T/Z}if(x||H*H<.999){let Z=Math.sqrt(k*k+K*K+F*F);k/=Z,K/=Z,F/=Z;let Q=Math.sqrt(R*R+j*j+B*B);R/=Q,j/=Q,B/=Q,O=F*j-K*B,$=k*B-F*R,H=K*R-k*j;let pe=1/Math.sqrt(O*O+$*$+H*H);O*=pe,$*=pe,H*=pe}},_e=i.cornerNeighborCornerTiles;for(let L=0;L<4;++L){let N=L,V=(L+1)%4,U=L===0||L===1?1:0,Y=L===0||L===3?1:0,re=q(U,o,l),ye=q(Y,a,c),J=t.getEdgeFirstVertexIndex(N),Z=t.getEdgeCount(N),Q=L===0||L===3?Z-1:0,pe=t.getEdgeFirstVertexIndex(V),Me=t.getEdgeCount(V),et=L===0||L===1?Me-1:0,Je=-1;for(let at=0;at<4;++at){let Ze=_e[4*L+at],Ge=_e[4*L+Je];Ze&&(Je===-1||wo(Ge,Ze)>0)&&(Je=at)}let $e=Je,Ke=_e[4*L+$e];if(Ke!==m){let at=m.level-Ke.level,Ze=2**at,Ge=[Ke.lij[0]+at,Ke.lij[1]*Ze,Ke.lij[2]*Ze],y=[Ge[1]+Ze===m.lij[1],L===0&&($e===1||$e===0&&Ke!==_e[4*L+3])||L===1&&($e===0||$e===1&&Ke!==_e[4*L+2]),Ge[1]===m.lij[1]+1,L===2&&($e===3||$e===2&&Ke!==_e[4*L+1])||L===3&&($e===2||$e===3&&Ke!==_e[4*L+0])],qe=y.reduce((Ye,gt)=>Ye+(gt?1:0),0);te(qe===1||qe===2);let je=-1,tt=-1,dt=Ke.renderData;if(qe===1){let Ye=y.findIndex(wt=>wt);te(0<=Ye&&Ye<=3),je=(Ye+2)%4;let gt=i.edgeResolutions[Ye];tt=m.getNeighborEdgeStartVertexIndex(Ye,Ke)*gt+gt*(Ye===0&&L===0||Ye===1&&L===0||Ye===2&&L===1||Ye===3&&L===3?1:0)}else{te(y[1]||y[3]),je=y[1]?3:1;let Ye=dt.geometryState.edgeResolutions[je];tt=L===0||L===3?0:Ye}let it=dt.geometry;{let Ye=J+Q,gt=pe+et,wt=it.getEdgeFirstVertexIndex(je)+tt,xt=it.vertexAttributes,bi=dt.localOrigin;{let li=xt.position,ci=li.typedBuffer,jt=wt*li.typedBufferStride,bt=ci[jt]+bi[0]-r[0],Qe=ci[jt+1]+bi[1]-r[1],zt=ci[jt+2]+bi[2]-r[2];zo(bt,Qe,zt,h);let Ot=p.position,se=Ot.typedBuffer;{let ri=Ye*Ot.typedBufferStride;se[ri]=bt,se[ri+1]=Qe,se[ri+2]=zt}{let ri=gt*Ot.typedBufferStride;se[ri]=bt,se[ri+1]=Qe,se[ri+2]=zt}}let Ci=p.uv0;jo(Ci,Ye,re,ye),jo(Ci,gt,re,ye);{let li=xt.normalCompressed.typedBuffer,ci=wt*xt.normalCompressed.typedBufferStride,jt=p.normalCompressed,bt=jt.typedBuffer;{let Qe=Ye*jt.typedBufferStride;bt[Qe]=li[ci],bt[Qe+1]=li[ci+1]}{let Qe=gt*jt.typedBufferStride;bt[Qe]=li[ci],bt[Qe+1]=li[ci+1]}}}}else{let at=de[N],Ze=de[V],Ge;if(at||Ze){let tt=q(Ie*(1-U)+le*U,fe,st),dt=q(ze*(1-Y)+Le*Y,De,Ee);Ge=gi(tt,dt,s)}else Ge=Jte(_e,L);A(U,Y,Ge),Ve(L);let y=D-r[0],qe=M-r[1],je=T-r[2];zo(y,qe,je,h),t.setEdgeVertexFromValuesRawPositionUVNormal(N,Q,y,qe,je,re,ye,O,$,H),t.setEdgeVertexFromValuesRawPositionUVNormal(V,et,y,qe,je,re,ye,O,$,H)}}for(let L=0;L<4;++L)nv[L]=null}function Jte(e,t){let i=4*t,r=SD.reduce((a,l)=>Math.min(a,e[i+l]?.level??1/0),1/0);Ki&&(te(!e[i+0]||!e[i+2]||ND(e[i+0],e[i+2],ii.SOUTH_WEST)),te(!e[i+1]||!e[i+3]||ND(e[i+1],e[i+3],ii.NORTH_WEST)));let n=0,s=0;for(let a=0;a<4;++a){let l=e[i+a];if(l&&l.level===r){let c=a===0||a===1,h=a===0||a===3,p=l.extent,m=p[c?0:2],f=p[h?1:3],g=l.renderData?.geometryState?.samplerData;s+=gi(m,f,g),n++}}let o=n?s/n:0;return te(o!=null),o}function Kf(e){let{vao:t,geometry:i}=e,{vertexAttributes:r,edgeVerticesStartIndex:n}=i,s=r.position.typedBuffer;t.vertexBuffers.get("geometry").setSubData(s,n,n,s.length)}function x8(e){let{vao:t,geometry:i}=e,{indices:r,indexCount:n,edgeIndicesStartIndex:s}=i;t.indexBuffer.setSubData(r,s,s,n)}var AO=class{constructor(t,i,r,n,s){this.isNorth=t,this.connectedRowOffset=i,this.connectedOuterEdgeOffset=r,this.rowOffset=n,this.latitudeResolution=s}},IO=[[0,1],[1,0],[0,-1],[-1,0]],Vr=new TD,LO=R2(-1/0,-1/0,1/0,1/0),nv=[null,null,null,null];function M8(e,t,i){if(!t)return!1;let r=wo(e,t);return r>0||r===0&&i>=2}var Qf=class{constructor(){this.vertex0Index=0,this.stride=1,this.count=0}getVertexIndex(t){return te(0<=t&&t<this.count),this.vertex0Index+this.stride*t}},FO=[new Qf,new Qf,new Qf,new Qf];function zo(e,t,i,r){e<r[0]?r[0]=e:e>r[3]&&(r[3]=e),t<r[1]?r[1]=t:t>r[4]&&(r[4]=t),i<r[2]?r[2]=i:i>r[5]&&(r[5]=i)}function S8(e){let{edgeResolutions:t,numVerticesPerSide:i}=e,r=1+Math.max(...t);return Math.max(i,r)}function I8(e,t,i,r,n,s){let o=e*n,a=s[o],l=s[o+1],c=s[o+2],h=t*n,p=s[h],m=s[h+1],f=s[h+2],g=i*n,_=s[g],v=s[g+1],b=s[g+2],x=r*n,E=s[x],D=s[x+1],M=s[x+2];return(p-E)*(p-E)+(m-D)*(m-D)+(f-M)*(f-M)>(a-_)*(a-_)+(l-v)*(l-v)+(c-b)*(c-b)}function Yf(e,t,i,r,n){e[t]=i,e[t+1]=r,e[t+2]=r,e[t+3]=n,e[t+4]=n,e[t+5]=i}var LD=6;var kD=class extends hd{constructor(t,i,r,n,s){super(),this._horizontalScaleFactor=1,this._extentInRenderSR=Yt(),this._baseUsedMemory=900,this._subtreeGeometryElevationBoundMin=0,this._subtreeGeometryElevationBoundMax=0,this.init(t,i,r,n,s)}init(t,i,r,n,s){super.init(t,i,r,n,s);let o=s.view.renderSpatialReference,a=s.spatialReference,l=o!=null&&c0(o)&&a!=null&&a.isGeographic?this.ellipsoid.radius*Math.PI/180:1;this._horizontalScaleFactor=l;let{isWebMercatorOnPlateCarree:c}=s,h=this._extentInRenderSR,p=this.extent;if(c){let m=yt(p[0],p[1],0);Ua(m,Qt.WebMercator,m,Qt.PlateCarree);let f=yt(p[2],p[3],0);Ua(f,Qt.WebMercator,f,Qt.PlateCarree),h[0]=m[0],h[1]=m[1],h[2]=f[0],h[3]=f[1]}else for(let m=0;m<4;++m)h[m]=p[m]*l;this.centerAtSeaLevel[0]=.5*(h[0]+h[2]),this.centerAtSeaLevel[1]=.5*(h[1]+h[3]),this.centerAtSeaLevel[2]=0,this._edgeLen=Math.max(h[2]-h[0],h[3]-h[1]),this._edgeLen2=this._edgeLen*this._edgeLen,this.updateRadiusAndCenter()}updateRadiusAndCenter(){this._updateCenter();let t=this._extentInRenderSR,i=.5*(t[2]-t[0]),r=.5*(t[3]-t[1]),n=Math.sqrt(i*i+r*r),s=.5*(this.elevationBoundsMax-this.elevationBoundsMin),o=Math.max(n,s);this._center[Fi.MIDDLE][3]=o}_calculateFrustumVisibility(t){let i=this._aabb(),r=i[0],n=i[1],s=i[2],o=i[3],a=i[4],l=i[5],c=!0;for(let h=0;h<6;h++){let p=t[h],m=p[0],f=p[1],g=p[2],_=p[3];if(m*(m>0?r:o)+f*(f>0?n:a)+g*(g>0?s:l)+_>=0)return Tr.OUTSIDE;c=c&&m*(m<0?r:o)+f*(f<0?n:a)+g*(g<0?s:l)+_<=0}return c?Tr.INSIDE:Tr.INTERSECTS}_aabb(){let t=this._extentInRenderSR;return dL(t[0],t[1],Math.min(this.elevationBoundsMin,this._subtreeGeometryElevationBoundMin),t[2],t[3],Math.max(this.elevationBoundsMax,this._subtreeGeometryElevationBoundMax))}intersectsRay(t,i,r,n){return FD[0]=1/i[0],FD[1]=1/i[1],FD[2]=1/i[2],X0(this._aabb(),t,FD,r,n)}createGeometry(){p8(this.renderData,this._horizontalScaleFactor),this._updateSubtreeGeometryElevationsBounds(),this.setMemoryDirty()}_updateSubtreeGeometryElevationsBounds(){let t=this._subtreeGeometryElevationBoundMin,i=this._subtreeGeometryElevationBoundMax,r=this.renderData,n=t,s=i;if(r){let o=r.geometry.boundingBox;n=o[2],s=o[5]}else if(!this.leaf){n=1/0,s=-1/0;for(let o of this.children){let a=o;n=Math.min(n,a._subtreeGeometryElevationBoundMin),s=Math.max(s,a._subtreeGeometryElevationBoundMax)}}(n!==this._subtreeGeometryElevationBoundMin||s!==this._subtreeGeometryElevationBoundMax)&&(this._subtreeGeometryElevationBoundMin=n,this._subtreeGeometryElevationBoundMax=s,this.parent?._updateSubtreeGeometryElevationsBounds())}get minimumVerticesPerSide(){return this.level<9?3:2}updateCornerElevations(){m8(this.renderData,this._horizontalScaleFactor),this._updateSubtreeGeometryElevationsBounds()}updateEdgeElevations(){g8(this.renderData,this._horizontalScaleFactor),this._updateSubtreeGeometryElevationsBounds()}updateEdgeElevationsAndResolutions(){f8(this.renderData,this._horizontalScaleFactor),this._updateSubtreeGeometryElevationsBounds()}get horizontalScale(){return this._horizontalScaleFactor}},FD=w();var kO=class{constructor(){this.extent=Qi(),this.minLevel=0,this.maxLevel=0,this.callback=null}},sv=class extends P{constructor(){super(...arguments),this._queries=new Nt({initialSize:10}),this._queriesInvPtr=0,this._queryQueue=new Nt({initialSize:30}),this._queryPool=new no(kO)}queryVisibleLevelRange(e,t,i,r){let n=this._queryPool.acquire();Ap(n.extent,e),n.minLevel=t??-Number.MAX_VALUE,n.maxLevel=i??Number.MAX_VALUE,n.callback=r,this._queryQueue.push(n),this.notifyChange("updating")}get updating(){return this._queryQueue.length!==0}prepare(){for(;this._queries.length<this._queries.data.length&&this._queryQueue.length>0;){let e=this._queryQueue.pop();this._queries.push(e)}this._queriesInvPtr=this._queries.length}process(){for(let e=0;e<this._queries.length;e++){let t=this._queries.data[e];this._queryPool.release(t),t.callback(e>=this._queriesInvPtr),t.callback=null}this._queries.clear(),this.notifyChange("updating")}queriesForTile(e){let t=e.level,i=0;for(;i<this._queriesInvPtr;){let r=this._queries.data[i],n=r.extent;t>=r.minLevel&&t<=r.maxLevel&&n[0]<=e.extent[2]&&n[2]>=e.extent[0]&&n[1]<=e.extent[3]&&n[3]>=e.extent[1]?(this._queries.swapElements(i,this._queriesInvPtr-1),this._queriesInvPtr--):i++}}};u([d()],sv.prototype,"updating",null),sv=u([C("esri.views.3d.terrain.ScaleRangeQueries")],sv);function A8(e,t,i,r){let n=Math.cos(i);e[0]=Math.cos(t)*n*r,e[1]=Math.sin(t)*n*r,e[2]=Math.sin(i)*r}var VD=class extends hd{constructor(t,i,r,n,s){super(),this._convexHull=new Array(24),this._boundingSphere=cr(),this._baseUsedMemory=1816,this.init(t,i,r,n,s)}init(t,i,r,n,s){super.init(t,i,r,n,s);let o=this.ellipsoid.radius,a=this.extentInRadians[0],l=this.extentInRadians[1],c=this.extentInRadians[2],h=this.extentInRadians[3],p=Xe(l,h,.5),m=Xe(a,c,.5),f=t===0?0:Math.min(Math.abs(l),Math.abs(h));this._edgeLen=(c-a)*Math.cos(f)*o,this._edgeLen2=this._edgeLen*this._edgeLen,this._curvatureHeight=o-Math.sqrt(o*o-this._edgeLen2/4),A8(this.centerAtSeaLevel,m,p,this.ellipsoid.radius),ne(this.up,this.centerAtSeaLevel),this.updateRadiusAndCenter()}updateRadiusAndCenter(){this._updateBoundingVolumes();let t=this._center;if(this.lij[0]===0)Te(t[Fi.MIDDLE],0,0,0),Te(t[Fi.TOP],0,0,0),Te(t[Fi.BOTTOM],0,0,0),t[Fi.MIDDLE][3]=this.ellipsoid.radius+this.elevationBoundsMax;else{this._updateCenter();let i=t[Fi.MIDDLE],r=this.convexHull,n=0;for(let s=0;s<8;++s)n=Math.max(n,eie(i,r,3*s));t[Fi.MIDDLE][3]=Math.sqrt(n)}}_calculateFrustumVisibility(t){if(!Gg(t,this._boundingSphere))return Tr.OUTSIDE;if(this.lij[0]<10)return Tr.INTERSECTS;let i=this.convexHull,r=this.surface.view.state.camera.near,n=!0;for(let s=0;s<vF;s++){let o=s===Yc.NEAR,a=t[s],l=a[0],c=a[1],h=a[2],p=a[3]-(o?r:0),m=!1;for(let f=0;f<8;++f){let g=3*f;if(l*i[g]+c*i[g+1]+h*i[g+2]+p<0){if(m=!0,!n)break}else n=!1}if(!m)return Tr.OUTSIDE}return n?Tr.INSIDE:Tr.INTERSECTS}computeElevationBounds(){super.computeElevationBounds(),this._updateBoundingVolumes()}createGeometry(){o8(this.renderData,this._getPatchType()),this._updateBoundingVolumes(),this.setMemoryDirty()}_updateBoundingVolumes(){this._updateConvexHull(),this._updateBoundingSphere(),Ki&&this._checkBVs()}_updateBoundingSphere(){let t=this._boundingSphere,i=t,r=this.elevationBoundsMin,n=this.elevationBoundsMax,s=this.ellipsoid.radius,o=n;if(this.level===0)Te(i,0,0,0),t[3]=s+o;else{let a=this.extentInRadians,l=.5*(a[0]+a[2]),c=a[1],h=a[3];rp(O8,l,c,s),rp(N8,l,h,s),he(i,O8,N8),X(i,i,(s+.5*(r+n))/yr(i));let p=this.convexHull,m=0,f=(_,v)=>{let b=_[0]-p[3*v],x=_[1]-p[3*v+1],E=_[2]-p[3*v+2];return Math.sqrt(b*b+x*x+E*E)};for(let _=0;_<8;++_){let v=f(i,_);m=Math.max(m,v)}let g=m;t[3]=g+2}}_updateConvexHull(){let t=this.extentInRadians,i=this.ellipsoid.radius;if(this.level===0)return;let r=this.elevationBoundsMin,n=this.elevationBoundsMax,s=this._getPatchType(),o=this.surface.isWebMercator,a=o&&s===yo.HAS_NORTH_POLE,l=o&&s===yo.HAS_SOUTH_POLE,c=l||a,h=Math.PI/2,p=t[0],m=t[2],f=l?-h:t[1],g=a?h:t[3],_=.5*(p+m),v=r,b=i+(c?Math.min(0,v-1):v),x=(B,z,ce)=>rp(B,z,ce,b),E=w(),D=w(),M=w(),T=w();x(E,p,f),x(D,p,g),x(M,m,g),x(T,m,f);let I=(B,z)=>{for(let ce=0;ce<3;++ce)this._convexHull[3*z+ce]=B[ce]};I(E,0),I(D,1),I(M,2),I(T,3);let A=n,O=i+(c?Math.max(0,A+1):A),$=w(),H=w(),k=w();rp(H,_,g,b),rp(k,_,f,b),he($,H,k),ne($,$);let K=w(),F=w(),R=(B,z)=>{ai(F,B,z),ne(F,F);let ce=-ae(B,K)/ae(F,K);te(ce>=0),X(F,F,ce),he(B,B,F)};if(2**this.lij[0]>2*this.lij[1]){let B=k,z=w();At(z,P8,B),ne(z,z),At(K,B,z),ne(K,K),te(Hn(ae(K,B)/yr(B),0)),R(E,D),R(T,M),I(E,0),I(T,3)}else if(2**this.lij[0]!==2*this.lij[1]){let B=H,z=w();At(z,P8,B),ne(z,z),At(K,z,B),ne(K,K),R(D,E),R(M,T),I(D,1),I(M,2)}let j=(B,z)=>{let ce=O/ae(z,$);for(let ue=0;ue<3;++ue)this._convexHull[3*B+ue]=z[ue]*ce};j(4,E),j(5,D),j(6,M),j(7,T)}_getPatchType(){let t=this.lij[1],i=t===0,r=t===(1<<this.level)-1;return i?r?yo.HAS_BOTH_POLES:yo.HAS_NORTH_POLE:r?yo.HAS_SOUTH_POLE:yo.REGULAR}intersectsRay(t,i,r,n){let s=this._boundingSphere,o=s[3]+r,a=i[0]*i[0]+i[1]*i[1]+i[2]*i[2],l=s[0]-t[0],c=s[1]-t[1],h=s[2]-t[2],p=(l*i[0]+c*i[1]+h*i[2])/a,m=i[0]*p-l,f=i[1]*p-c,g=i[2]*p-h;return m*m+f*f+g*g<o*o}get minimumVerticesPerSide(){return this.level<R8.length?R8[this.level]+1:2}updateCornerElevations(){c8(this.renderData),this._updateBoundingVolumes()}updateEdgeElevations(){a8(this.renderData),this._updateBoundingVolumes()}updateEdgeElevationsAndResolutions(){l8(this.renderData),this._updateBoundingVolumes()}_checkBVs(){if(!Ki||this.level<=2)return;let t=this._boundingSphere,i=t[3],r=t,n=w(),s=this.ellipsoid.radius,o=this.elevationBoundsMin,a=this.elevationBoundsMax,l=s+o,c=1,h=0,p=this._center[Fi.MIDDLE][3],m=this.convexHull,f=(N,V)=>{for(let U=0;U<3;++U)N[U]=m[3*V+U]};{let N=w(),V=w(),U=w(),Y=w(),re=w(),ye=(J,Z,Q,pe)=>{f(V,J),f(U,Z),f(Y,Q),ai(V,V,U),ai(Y,Y,U),At(N,V,Y),ne(N,N);let Me=ae(N,U);f(re,pe);let et=ae(N,re),Je=Math.abs(et-Me);te(Hn(Je,0),`Non coplanar ${J},${Z},${Q},${pe} diff = ${Je}`)};ye(0,1,2,3),ye(4,5,6,7),ye(0,1,4,5),ye(1,2,5,6),ye(2,3,6,7),ye(3,0,7,4)}let g=iL(24),_=(N,V,U)=>{let Y=4*N;for(let re=0;re<3;++re)g[Y+re]=V[re];g[Y+3]=U},v=w(),b=w(),x=w(),E=w(),D=(N,V,U,Y)=>{f(v,V),f(b,U),f(x,Y),ai(v,v,b),ne(v,v),ai(x,x,b),ne(x,x),At(E,v,x),ne(E,E);let re=ae(E,b);_(N,E,re)};D(0,0,1,2),D(1,1,0,4),D(2,1,5,2),D(3,3,2,6),D(4,4,0,3),D(5,4,6,5);let M=(N,V,U,Y)=>{let re=4*N;return g[re]*V+g[re+1]*U+g[re+2]*Y-g[re+3]},T=(N,V,U,Y)=>M(N,V,U,Y)>=-1,I=(N,V)=>T(N,V[0],V[1],V[2]),A=2**this.lij[0]>2*this.lij[1],O=(N,V,U)=>Math.sqrt(L8(N,V,U,r[0],r[1],r[2]))<i,$=N=>O(N[0],N[1],N[2]),H=(N,V)=>O(N[V],N[V+1],N[V+2]),k=this.extentInRadians,K=.5*(k[0]+k[2]),F=k[1],R=k[3],j=w(),B=w();rp(j,K,R,l),rp(B,K,F,l);let z=A?"Upper":"Lower",ce=!0;for(let N=0;N<6;++N){for(let V=0;V<8;++V){let U=3*V,Y=T(N,m[U],m[U+1],m[U+2]);ce&&=Y,te(Y,`Tile[${this.lij}] Convex hull point ${V} outside of plane ${N}`)}te(I(N,B),`Tile[${this.lij}] (${z}) bottom mid outside of plane ${N}`),te(I(N,j),`Tile[${this.lij}] (${z}) top mid outside of plane ${N}`)}te(ce,"Not all convex hull points are inside  convex hull polyhedron"),te($(B),`Tile[${this.lij}] (${z}) bottom mid outside of bounding sphere`),te($(j),`Tile[${this.lij}] (${z}) top mid outside of bounding sphere`);for(let N=0;N<8;++N){let V=H(m,3*N);te(V,`Tile[${this.lij}] Convex hull point ${N} outside of bounding sphere`)}for(let N=0;N<6;++N)for(let V=0;V<8;++V){let U=3*V;T(N,m[U],m[U+1],m[U+2])||console.error(`Tile[${this.lij}] Convex hull point ${V} outside of plane ${N}`)}let{extentInRadians:ue}=this,Ie=Math.max(ue[2]-ue[0],ue[3]-ue[1]),le=Math.round(Ie*s),{renderData:ze}=this;if(!ze)return;let{geometry:Le,geometryState:de,localOrigin:fe}=ze,st=Le.vertexAttributes?.position;if(!st)return;let De=w(),Ee=Le.numVerticesPerSide-2,{indices:Ae,indexCount:He,edgeVerticesStartIndex:Ve,poleVerticesStartIndex:_e}=Le;if(!Ae)return;let L=new Set;for(let N=0;N<He;++N){let V=Ae[N];if(L.has(V))continue;L.add(V);let U=V<_e,Y=V>=Ve,re=!1,ye=-1;if(Y){let y=Ve;for(let qe=0;qe<4;++qe){let je=de.edgeResolutions[qe];if(V===y||V===y+je-1){re=!0;break}if(y+=je,V<y){ye=qe;break}}}let J=Y?de.edgePeerNeighbors[ye]:null,Z=Y&&J&&wo(this,J)>0;st.getVec(V,n),he(De,n,fe);let Q=yr(De)-s,pe=0,Me=!1,et=o-Q,Je=Q-a,$e=et>c,Ke=Je>c,at=$e||Ke,Ze=()=>{let y=U?"internal":Y&&!re?"edge":re?"corner":"pole";return`Tile[${this.lij}].vertex[${V}]:${y}`+($e?"(below)":Ke?"(above)":"")+(Z?"(Neighbor)":"")},Ge=Ar(De,r);if(Ge>=i+h){let y=Ge-i;at||(console.error(`${Ze()} is out of the bounding sphere by ${y.toFixed(0)} / ${i.toFixed(0)}[tol=${h}] h=${Q.toFixed(0)} / [${o.toFixed(0)}..${a.toFixed(0)}] (${(y/i).toFixed(0)})`),Me=!0)}for(let y=0;y<6;++y)if(!T(y,De[0],De[1],De[2])){let qe=M(y,De[0],De[1],De[2]),je=V%Ee,tt=(V-je)/Ee;y===0&&et||y===5&&Je||(console.error(`${Ze()} (${je},${tt})|${Ee}] is out of the bounding trapezoid plane ${y} h=${Math.round(Q)} / [${Math.round(o)}..${Math.round(a)}] dist=${Math.round(qe)} radii = ${Math.round(i)}/${Math.round(p)}} : maxL = ${le}`),++pe)}if(Me||pe>0)break}}get convexHull(){return this._convexHull}},R8=[128,64,64,32,16,8,8,4];function eie(e,t,i){return L8(e[0],e[1],e[2],t[i],t[i+1],t[i+2])}function L8(e,t,i,r,n,s){let o=r-e,a=n-t,l=s-i;return o*o+a*a+l*l}var rp=(e,t,i,r)=>{let n=Math.cos(t),s=Math.sin(t),o=Math.cos(i),a=Math.sin(i);e[0]=r*o*n,e[1]=r*o*s,e[2]=r*a},P8=[0,0,1],O8=w(),N8=w();var Go=class extends P{constructor(){super(...arguments),this.fovX=0,this.fovY=0,this.relativeWidthLimit=0,this.relativeHeightLimit=0,this.maxLod=0,this.angledSplitBias=0,this.aboveGround=!0}};u([d()],Go.prototype,"fovX",void 0),u([d()],Go.prototype,"fovY",void 0),u([d()],Go.prototype,"relativeWidthLimit",void 0),u([d()],Go.prototype,"relativeHeightLimit",void 0),u([d()],Go.prototype,"maxLod",void 0),u([d()],Go.prototype,"angledSplitBias",void 0),u([d()],Go.prototype,"aboveGround",void 0),u([d()],Go.prototype,"frustum",void 0),Go=u([C("esri.views.3d.terrain.SplitLimits")],Go);var F8=Ps().vec3f(yi.POSITION).vec2i16(yi.UV0).vec2i16(yi.NORMALCOMPRESSED,{glNormalized:!0});var HD=class{constructor(t){this._storage=new Bo((i,r)=>t.newCache(i,r),"TileGeometry")}acquire(t){let r=Math.ceil(t/4)*4,n=this._storage,s=tie(r),o=n.pop(s);if(o)return o;let a=F8.createBuffer(r);return a.release=()=>n.put(s,a),a}clear(){this._storage.clear()}destroy(){this._storage.destroy()}};function tie(e){return e.toString()}var BD=class extends U3{constructor(){super(...arguments),this.opacity=1,this.baseOpacity=1,this.texture=null,this.fboTexture=null,this.backgroundColor=Jo}},ov=class extends ft{constructor(t,i){super(t,i,new mt(J3,()=>import("./chunk-XBVGTIB3.js")))}};function k8(e,t){let i=e.transforms.tileUnitsToPixels,r=Mp(t),n=Math.cos(r),s=Math.sin(r),o=Math.ceil(512*(Math.abs(s)+Math.abs(n)));Np(Rl),zl(Rl,Rl,[o/2,o/2]),Lp(Rl,Rl,r),zl(Rl,Rl,[-256,-256]),P0(Rl,Rl,[1/8,1/8,1]),e.transforms.tileUnitsToPixels=Rl;let a=[],l=new jV(4096,a,()=>new VV),c=new UV(a,l,(h,p,m)=>new BV(h,p,m,e.styleRepository,e.key.level,t),(h,p)=>{HV(h,p,!1)},()=>0,h=>{let p=e.styleRepository.getStyleLayerByUID(h).getLayoutProperty("visibility");return!p||p.getValue()!==xF.NONE});a.push(e),l.add(e),c.setScreenSize(o,o),c.continue(1/0),l.removeTile(e),e.transforms.tileUnitsToPixels=i}var Rl=Xp();var iie=.125,UD=class{constructor(){this._renderParams={reshuffleManager:new Jk,context:null,drawPhase:1,state:new VO,stationary:!0,pixelRatio:1,displayLevel:-1,requiredLevel:-1,globalOpacity:1,renderPass:"background",styleLayer:null,styleLayerUID:-1,painter:null,glyphMosaic:null,spriteMosaic:null,profiler:null,renderingOptions:null,requestRender:null,allowDelayedRender:!1,deltaTime:-1,timeline:null,time:0,hasClipping:!1,blendMode:null,dataUploadCounter:0,effects:null,inFadeTransition:!1,requireFBO:!1,highlightGradient:null,stencilSymbols:!0,is3D:!0,backgroundColor:null},this._backgroundTile=new zV(new N0(0,0,0,0),0,0,0,512,512,4096,4096),this._heading=0,this._declutteredForHeading=new WeakMap}dispose(){this._renderParams=null}renderBackground(t,i,r,n,s,o,a,l,c,h){let p=this._backgroundTile;this._updateRenderParameters(t,i,p,r,s,o,a,l,c,h),this._renderParams.stencilSymbols=!1,r.drawBackground(this._renderParams,p,n)}renderContent(t,i,r,n,s,o,a,l,c,h,p,m){this._declutter(r),n.forAll(({sourceLayerInfo:{data:_}})=>this._declutter(_));let f=n.length>0;f&&this._stencilSymbols(t,i,r,n,s,o,a,l,c,h,p,m);let g=1;r.stencilRef=f?g:0,t.setStencilFunction(Ei.EQUAL,r.stencilRef,255),this._render(t,i,r,s,o,a,l,c,h,p,m),n.forAll(({sourceLod:_,offset:v,sourceLayerInfo:{data:b}})=>{b.stencilRef=++g,this._renderSymbols(t,_,b,s,o,a,l,v,h,p,m)})}_stencilSymbols(t,i,r,n,s,o,a,l,c,h,p,m){let f=1;r.stencilRef=f,t.setDepthTestEnabled(!1),t.setDepthWriteEnabled(!1),t.setStencilTestEnabled(!0),t.setBlendingEnabled(!1),t.setColorMask(!1,!1,!1,!1),t.setStencilOp(D0.KEEP,D0.KEEP,D0.REPLACE),t.setStencilWriteMask(255),t.setStencilFunction(Ei.ALWAYS,r.stencilRef,255),this._stencilTileSymbols(t,i,r,s,o,a,l,c,h,p,m),n.forAll(({sourceLod:g,offset:_,sourceLayerInfo:{data:v}})=>{v.stencilRef=++f,t.setStencilFunction(Ei.ALWAYS,v.stencilRef,255),this._stencilTileSymbols(t,g,v,s,o,a,l,_,h,p,m)}),t.setStencilWriteMask(0),t.setBlendingEnabled(!0),t.setDepthTestEnabled(!0),t.setColorMask(!0,!0,!0,!0)}_renderSymbols(t,i,r,n,s,o,a,l,c,h,p){t.setStencilFunction(Ei.EQUAL,r.stencilRef,255),this._render(t,i,r,n,s,o,a,l,c,h,p,DF.SYMBOL)}_render(t,i,r,n,s,o,a,l,c,h,p,m){this._updateRenderParameters(t,i,r,n,o,a,l,c,h,p),this._renderParams.stencilSymbols=!1,n.drawTile(this._renderParams,r,s,m)}_stencilTileSymbols(t,i,r,n,s,o,a,l,c,h,p){this._updateRenderParameters(t,i,r,n,o,a,l,c,h,p),this._renderParams.stencilSymbols=!0,r.triangleCount=0,n.drawSymbols(this._renderParams,r,s)}_updateRenderParameters(t,i,r,n,s,o,a,l,c,h){"type"in r&&r.type==="vector-tile"&&!r.stage&&r.attachWithContext(t);let p=i[0]-s.getLevelShift(i[0]),m=this._renderParams;m.context=t,m.painter=n,m.glyphMosaic=n.glyphMosaic,m.spriteMosaic=n.spriteMosaic,m.pixelRatio=c*h,m.displayLevel=p,m.requiredLevel=p;let f=s.getScale(i[0]),[g,_]=s.getOffset(i,o*f),v=iie*o*f/l,b=r.transforms.displayViewScreenMat3;b[0]=v,b[4]=-v,b[6]=-1-g-a[0]*o*2,b[7]=1+_+(1-a[1])*o*2-2;let x=m.state,E=l/h;x.size[0]=E,x.size[1]=E,x.pixelRatio=h,x.rotation=(360-this._heading)%360;let D=2/E;I0(x.displayViewMat3,D,0,0,0,-D,0,-1,1,1);let M=Np(x.displayMat3),T=Mp(this._heading);zl(M,M,[E/2,E/2]),Lp(M,M,T),zl(M,M,[-E/2,-E/2]),R0(M,x.displayViewMat3,M)}updateHeading(t){this._heading=t}_declutter(t){this._declutteredForHeading.get(t)!==this._heading&&(k8(t,(360-this._heading)%360),this._declutteredForHeading.set(t,this._heading))}},VO=class{constructor(){this.size=[0,0],this.pixelRatio=1,this.rotation=0,this.displayMat3=Ln(),this.displayViewMat3=Ln(),this.transform=null,this.inverseTransform=null,this.viewMat2d=null,this.viewMat3=null,this.id=0,this.extent=null,this.center=null,this.scale=1,this.resolution=0,this.worldScreenWidth=0,this.spatialReference=null,this.viewpoint=null,this.getScreenTransform=null,this.toMap=null,this.toScreen=null,this.clone=null,this.copy=null,this.toJSON=null}};var av=class extends iu{constructor(){super(...arguments),this.blendMode=du.Normal}};u([$t({count:du.COUNT})],av.prototype,"blendMode",void 0);var Rc=class extends av{constructor(){super(...arguments),this.output=Rr.Composite,this.baseOpacityMode=vn.NotRequired,this.premultipliedSource=ua.Off}};u([$t({count:Rr.COUNT})],Rc.prototype,"output",void 0),u([$t({count:vn.COUNT})],Rc.prototype,"baseOpacityMode",void 0),u([$t({count:ua.COUNT})],Rc.prototype,"premultipliedSource",void 0);var lv=class extends Rc{constructor(){super(...arguments),this.background=mm.BelowLayer}};u([$t({count:mm.COUNT})],lv.prototype,"background",void 0);var cv=class extends ft{constructor(t,i){super(t,i,new mt(z3,()=>import("./chunk-56G5ZZSE.js")))}};var pd=class extends Rc{constructor(){super(...arguments),this.colorizerType=PM.Stretch,this.stretchType=dm.Noop,this.applyColormap=!0,this.requireBilinearWithNN=!1}};u([$t({count:PM.COUNT})],pd.prototype,"colorizerType",void 0),u([$t({count:dm.COUNT})],pd.prototype,"stretchType",void 0),u([$t()],pd.prototype,"applyColormap",void 0),u([$t()],pd.prototype,"requireBilinearWithNN",void 0);var uv=class{constructor(t){this._rctx=t,this._fbos=new Map}get(t){return this._getPool(t)}dispose(){this._fbos.forEach(t=>t.dispose()),this._fbos.clear()}_getPool(t){let i=this._fbos.get(t);if(i)return i;let r=new $a(this._rctx,new vi(t),new lw(x0.DEPTH24_STENCIL8,t));return this._fbos.set(t,r),r}};var rie=()=>W.getLogger("esri.views.3d.terrain"),jD=class{constructor(t,i){this._rctx=t,this._techniques=i,this._fbos=[],this._vectorTileHelper=new UD,this._bindParameters=new vw(null),this._blendLayersTechniqueConfig=new lv,this._current=0,this._lastUsedIds=new Array,this._lastCreatedBufferId=0,this._onHoldIds=new Array,this._vaoQuad=yn(this._rctx,uu.Pos2Tex)}dispose(){this._fbos.forEach(We),this._fbos=null,this._vtFBO=We(this._vtFBO),this._vaoQuad=We(this._vaoQuad),this._vectorTileHelper=We(this._vectorTileHelper)}updateHeading(t){this._vectorTileHelper?.updateHeading(t)}_acquireBlendLayersTechnique(t,i,r,n=ua.Off,s=mm.BelowLayer){return this._blendLayersTechniqueConfig.output=i,this._blendLayersTechniqueConfig.blendMode=t,this._blendLayersTechniqueConfig.baseOpacityMode=r,this._blendLayersTechniqueConfig.premultipliedSource=n,this._blendLayersTechniqueConfig.background=s,this._techniques.precompile(ov,this._blendLayersTechniqueConfig),this._techniques.get(ov,this._blendLayersTechniqueConfig)}drawBackground(t,i){let r=this._acquireBlendLayersTechnique(du.Normal,i?Rr.ColorComposite:Rr.GridComposite,vn.NotRequired,ua.Off,mm.Only),n=this._rctx.bindTechnique(r,this._bindParameters,t);this._render(n)}_render(t){this._rctx.bindVAO(this._vaoQuad),t.assertCompatibleVertexAttributeLocations(this._vaoQuad),this._rctx.drawArrays(Jt.TRIANGLE_STRIP,0,sa(this._vaoQuad,"geometry"))}drawGroup(t,i,r,n,s=ua.On){i===Rr.Composite&&(t.fboTexture=this._fbos[this.getLastOnHoldId()].get(r).colorTexture),t.texture=this.currentFBO(r).colorTexture,this.closeGroup(r);let o=t.baseOpacity<1?vn.Required:vn.NotRequired,a=this._acquireBlendLayersTechnique(n,i,o,s),l=this._rctx.bindTechnique(a,this._bindParameters,t);this._render(l)}drawImageData(t,i,r,n,s=ua.Off){if(t.texture==null)return;let o=t.baseOpacity<1?vn.Required:vn.NotRequired;t.fboTexture=i===Rr.GroupBackgroundComposite||n===du.Normal&&o===vn.NotRequired&&s===ua.Off?null:this.switch(r).colorTexture;let a=this._acquireBlendLayersTechnique(n,i,o,s),l=this._rctx.bindTechnique(a,this._bindParameters,t);this._render(l)}drawRasterData(t,i,r,n,s){let o=s.sourceLayerInfo.data;if(!o.source||(s.tile.surface.layerViewByIndex(s.layerIndex,Ue.MAP).ensureSymbolizerParameters(o),!o.bind(this._rctx)))return;let a=t.baseOpacity<1?vn.Required:vn.NotRequired;t.fboTexture=n===du.Normal&&a===vn.NotRequired?null:this.switch(r).colorTexture;let l=this._acquireRasterColorizerTechnique(o,i,n,a);o.opacity=t.opacity;let c=o.getUniforms();c.scale=s.scale,c.offset=s.offset,c.backgroundColor=t.backgroundColor,c.fboTexture=t.fboTexture,c.baseOpacity=t.baseOpacity;let h=this._rctx.bindTechnique(l,this._bindParameters,c);this._render(h)}_acquireRasterColorizerTechnique(t,i,r,n){let s=t.symbolizerParameters,o=["stretch","lut","hillshade"].indexOf(s.type);return this._rasterColorizerConfig==null&&(this._rasterColorizerConfig=new pd,this._rctx.gl.getExtension("WEBGL_color_buffer_float"),this._rctx.gl.getExtension("OES_texture_float")),this._rasterColorizerConfig.output=i,this._rasterColorizerConfig.blendMode=r,this._rasterColorizerConfig.baseOpacityMode=n,this._rasterColorizerConfig.colorizerType=o,this._rasterColorizerConfig.applyColormap=!!s.colormap,this._rasterColorizerConfig.requireBilinearWithNN=t.isBilinearWithStretchColorRamp,this._rasterColorizerConfig.stretchType=t.hasStretchTypeNone()?dm.Noop:dm.PerBand,this._techniques.precompile(cv,this._rasterColorizerConfig),this._techniques.get(cv,this._rasterColorizerConfig)}drawVectorData(t,i,r,n,s,o,a,l){let c=this._rctx,h=s.sourceLayerInfo.data,p=s.tile.surface.layerViewByIndex(s.layerIndex,Ue.MAP),m=t.baseOpacity<1?vn.Required:vn.NotRequired,f=m===vn.Required||t.opacity<1||n!==du.Normal||i!==Rr.Composite,g=f?ua.On:ua.Off,_=this._acquireBlendLayersTechnique(n,i,m,g);c.setPipelineState(_.getPipeline());let v=null,b=null;f?(b=this.currentFBO(r),this._vtFBO==null&&(this._vtFBO=new uv(this._rctx)),v=this._vtFBO.get(r),c.bindFramebuffer(v),this._clearCurrentFBO()):l&&c.clear(Ti.DEPTH);try{this._vectorTileHelper.renderBackground(c,s.sourceLod,p.painter,p.layer.styleRepository,p.schemaHelper,Math.round(1/s.scale),s.offset,a,o,p.contentZoom),h&&this._vectorTileHelper.renderContent(c,s.sourceLod,h,s.vtlNeighborInfos,p.painter,p.layer.styleRepository,p.schemaHelper,Math.round(1/s.scale),s.offset,a,o,p.contentZoom)}catch(x){rie().warnOnce("A render call containing vector tiles did not resolve correctly.",x)}return!v||(c.bindFramebuffer(b),t.texture=v.colorTexture,t.offset=Sd,t.scale=1,this.drawImageData(t,i,r,n,g),l)}copyFBOToTexture(t){let i=this._rctx,r=i.bindTexture(t.texture,Di.TEXTURE_UNIT_FOR_UPDATES),n=t.descriptor;i.gl.copyTexImage2D(Bg.TEXTURE_2D,0,n.pixelFormat,0,0,n.width,n.height,0),t.generateMipmap(),i.bindTexture(r,Di.TEXTURE_UNIT_FOR_UPDATES)}_clearCurrentFBO(){this._rctx.setStencilWriteMask(255),this._rctx.setClearColor(0,0,0,0),this._rctx.setClearDepth(1),this._rctx.setClearStencil(0),this._rctx.clear(Ti.COLOR|Ti.DEPTH|Ti.STENCIL)}_initFBO(t,i,r){this._rctx.bindFramebuffer(t),r&&(this._rctx.setViewport(0,0,i,i),this._clearCurrentFBO())}ensureBuffer(t){this._lastUsedIds.length=0,this._lastUsedIds.push(1),this._lastCreatedBufferId=1,this._onHoldIds.length=0,this.bind(t)}bind(t,i=0,r=!0){if(this._current=i,i>=this._fbos.length)for(let n=this._fbos.length;n<=i;n++)this._fbos.push(new uv(this._rctx));this._initFBO(this._fbos[i].get(t),t,r)}_bindNextFreeBuffer(t){this._lastUsedIds.length>0?this.bind(t,this._lastUsedIds.pop()):(this._lastCreatedBufferId++,this.bind(t,this._lastCreatedBufferId))}openGroup(t){this._onHoldIds.push(this._current),this._bindNextFreeBuffer(t)}switch(t){let i=this.currentFBO(t),r=this._current;return this._bindNextFreeBuffer(t),this._lastUsedIds.push(r),i}getLastOnHoldId(){return this._onHoldIds[this._onHoldIds.length-1]}closeGroup(t){let i=this._current;this._bindNextFreeBuffer(t),this._lastUsedIds.push(i),this._lastUsedIds.push(this._onHoldIds.pop())}unbind(){this._rctx.bindFramebuffer(null)}currentFBO(t){return this._fbos[this._current].get(t)}};var zD=class{constructor(){this.sourceLod=[0,0,0],this.offset=[0,0],this.scale=1,this.layerIndex=0,this.isVTLBackground=!1,this.vtlNeighborInfos=new Nt({allocator:t=>t||new HO})}},HO=class{constructor(){this.sourceLayerInfo=null,this.sourceLod=[0,0,0],this.offset=[-1,0]}};var dv=class{constructor(t,i){this._texture=t,this._cache=i,this.type="tile-texture",this._refCount=1}retain(){++this._refCount}release(){--this._refCount,this._refCount===0&&(this._cache?(this._texture.isCompressing&&this._texture.abortCompression(),this._cache.put(this._generateCacheKey(),this)):this.dispose())}dispose(){this._texture.dispose()}get texture(){return this._texture}generateMipmap(){this._texture.generateMipmap()}_generateCacheKey(){return`${this._texture.descriptor.width} ${this._texture.descriptor.pixelFormat}`+(qF(this._texture)?"compressed":"")}get descriptor(){return this._texture.descriptor}get cachedMemory(){return this._texture.usedMemory}};function BO(e){return e instanceof HTMLImageElement||e instanceof HTMLCanvasElement}var GD=class extends wF{constructor(t){super("TextureCompressionWorker","compress",{compress:i=>[i.data]},t)}isCompressible(t){return BO(t)}};var jO=class{constructor(t,i,r,n,s,o){this.start=t,this.end=i,this.blendMode=r,this.opacity=n,this.output=s,this.baseOpacity=o}},Oc=class extends P{constructor(e){super(e),this._passParameters=new BD,this._backgroundTexture=null,this._backgroundColor=null,this._backgroundDirty=!1}initialize(){this._maxAnisotropy=this.rctx.parameters.maxMaxAnisotropy,this._compositor=new jD(this.rctx,this.techniques),this._ensureBackgroundTexture(this.tileSize),this.texturesBeingCompressed=0}dispose(){this._compositor=We(this._compositor),this._backgroundTexture=ki(this._backgroundTexture)}get backgroundIsGrid(){return this._backgroundColor==null}get backgroundColor(){return this._backgroundColor}updateHeading(e){this._compositor?.updateHeading(e)}updateTileTexture(e,t){if(!e.renderData)return;let i=e.surface,r=i.baseOpacity,n=0,s=0,o=this.tileSize,a=!1,l=!1,c=i.view.state.contentPixelRatio,h=!1;qD.clear(),Xf.length=0;let p=e.layerInfo[Ue.MAP],m=0,f=null;for(;m<p.length;m++){let v=i.layerViewByIndex(m,Ue.MAP),b=v.layer,x=!ca(e,v),E=b.opacity,D=v.fullOpacity;if(l=l||Dp(b),lu(v)){let I=v.layer.blendMode!=="normal";if(Uc(b.parent)){let A=b.parent.uid;A!=null&&A!==""&&(I=V8(b.parent)||I)}I&&(h=I,a=!1)}if((x||E===0)&&!h){p[m].pendingUpdates&=~(we.TEXTURE_NOFADING&we.TEXTURE_FADING);continue}++s;let M=om(v),T=UO(e,m,M);if(T){if(p[m].pendingUpdates&=~(we.TEXTURE_NOFADING&we.TEXTURE_FADING),Uc(b.parent)){let I=b.parent.uid;I!=null&&I!==""&&H8(b.parent,m)}M?o=Math.max(o,this.tileSize*c):r===1&&D===1&&(v.isOpaque||this._dataToTexture(T)&&T.sourceLayerInfo.data.descriptor.isOpaque)&&(a=!0),++n,f===null&&(f=m)}}let g=o/this.tileSize,_=this._ensureBackgroundTexture(this.tileSize);n!==0&&f!==null?n===1&&!h&&this._useLayerTexture(e,f)||this._composeLayers(e,t,m-1,l,o,g,!a||h,qD,h):sie(e,s,_,t!==di.FADING)}_ensureBackgroundTexture(e){return this._backgroundTexture==null&&(this._backgroundTexture=this._buildTexture(e,!1),this._backgroundDirty=!0),this._backgroundDirty&&(this._compositor.bind(e),this._passParameters.offset=Sd,this._passParameters.scale=1,this._passParameters.opacity=1,this.backgroundColor&&(this._passParameters.backgroundColor=this.backgroundColor),this._compositor.drawBackground(this._passParameters,this.backgroundColor!=null),this._compositor.copyFBOToTexture(this._backgroundTexture),this._compositor.unbind(),this._backgroundDirty=!1),this._backgroundTexture}_useLayerTexture(e,t){let i=e.surface.layerViewByIndex(t,Ue.MAP),r=Dp(i.layer),n=r?e.surface.baseOpacity:1,s=r?1:e.surface.baseOpacity,o=i.fullOpacity,a=UO(e,t,!1);return!!this._dataToTexture(a)&&(e.renderData.setTextureReference(new ud(a.sourceLayerInfo.data,di.FADING,fn(a.offset[0],a.offset[1],a.scale,a.scale),n,s,o)),!0)}_composeLayers(e,t,i,r,n,s,o,a,l){this._compositor.ensureBuffer(n);let c=e.surface.baseOpacity,h=!1,p=Nn.LINEAR_MIPMAP_LINEAR,m=!1,f=0;for(let b=i;b>=0;b--){let x=e.surface.layerViewByIndex(b,Ue.MAP),E=x.layer,D=om(x),M=UO(e,b,D),T=E.opacity,I=!ca(e,x);if(!M||(T===0||I)&&!l)continue;let A=!Dp(E)&&!h;A&&(h=!0);let O=!1;a.forEach(K=>{K.start===b&&(K.output=r?Rr.Composite:o&&A?this.backgroundIsGrid?Rr.GridComposite:Rr.ColorComposite:Rr.Composite,K.baseOpacity=A?c:1,Xf.push(K),this._compositor.openGroup(n),O=!0)});let $=f===0,H=O?Rr.GroupBackgroundComposite:o&&$?this.backgroundIsGrid?Rr.GridComposite:Rr.ColorComposite:Rr.Composite,k=o_[lu(x)?x.layer.blendMode:"normal"];for(this._passParameters.baseOpacity=A&&!O&&c<1?c:1,this._passParameters.opacity=T,m3(M)?m=this._compositor.drawVectorData(this._passParameters,H,n,k,M,s,this.tileSize,m):p3(M)?(this._compositor.drawRasterData(this._passParameters,H,n,k,M),nie(M)&&(p=Nn.NEAREST)):this._dataToTexture(M)&&(this._passParameters.texture=M.sourceLayerInfo.data.texture,this._passParameters.offset=M.offset,this._passParameters.scale=M.scale,this._compositor.drawImageData(this._passParameters,H,n,k));Xf.length>0&&Xf[Xf.length-1].end===b;){let K=Xf.pop();this._passParameters.baseOpacity=K.baseOpacity,this._passParameters.opacity=K.opacity,this._passParameters.offset=Sd,this._passParameters.scale=1,this._compositor.drawGroup(this._passParameters,K.output,n,o_[K.blendMode])}f++}let g=e.renderData,_=l||h&&c<1,v=g.ensureTexture(n,_,t,()=>this._buildTexture(n,_,p));this._compositor.copyFBOToTexture(v),this._compositor.unbind(),g.setTextureReference(new ud(v,t,B8,h?1:c,0,1))}_dataToTexture(e){if(g3(e)){let t=e.sourceLayerInfo,i=e.scale===1;t.data=this._buildTexture(t.data,!0,i),e.tile.setMemoryDirty()}return f3(e)}setBackground(e){this._backgroundColor!==e&&(this._backgroundColor=e,this._backgroundDirty=!0)}_buildTexture(e,t,i=Nn.LINEAR_MIPMAP_LINEAR){if(e==null)return null;let r=new vi;r.wrapMode=ji.CLAMP_TO_EDGE,r.samplingMode=typeof i=="boolean"?Nn.LINEAR_MIPMAP_LINEAR:i,r.maxAnisotropy=this._maxAnisotropy,r.preMultiplyAlpha=!0,r.flipped=!0,r.hasMipmap=!0,t||(r.pixelFormat=mi.RGB);let n=this.rctx,s=typeof i=="boolean"&&i,o;if(typeof e=="number")r.width=r.height=e,o=this._buildTileTexture(r,e);else if(sm(e))r.isOpaque=e.isOpaque,r.isOpaque&&(r.pixelFormat=mi.RGB),o=this._buildTileTexture(r,e.element.width,s,e.element);else try{r.width=e.width,r.height=e.height,o=this._buildTileTexture(r,e.width,s,e)}catch{o=new dv(Nw(n)),console.warn("TileRenderer: failed to execute 'texImage2D', cross-origin image may not be loaded.")}let a=n.bindTexture(o.texture,Di.TEXTURE_UNIT_FOR_UPDATES);return o.generateMipmap(),n.bindTexture(a,Di.TEXTURE_UNIT_FOR_UPDATES),o}_buildTileTexture(e,t,i=!1,r){let n=`${t} ${e.pixelFormat}`,s=this.cache.pop(n)??this.cache.pop(n+"compressed");if(i&&=BO(r),s)return s.retain(),i&&s.texture.enableCompression(!0),s.texture.setData(r),s;e.shouldCompress=i;let o=new Di(this.rctx,e,r);return o.isCompressing&&(this.texturesBeingCompressed++,this.addHandles([S(()=>o.isCompressing,a=>{a?this.texturesBeingCompressed++:this.texturesBeingCompressed--},Fe)])),new dv(o,this.cache)}get test(){}};function UO(e,t,i){un.layerIndex=t,un.vtlNeighborInfos.clear();let r=e.layerInfo[Ue.MAP][t];if(es(un.offset,0,0),un.tile=e,un.scale=1,un.sourceLod=e.lij,un.sourceLayerInfo=r,un.isVTLBackground=i,r.data)return i&&e.forEachLoadedNeighbor((o,a)=>{if(o.level!==e.level)return;let l=o.layerInfo[Ue.MAP][t];if(!_3(l)||r.data===l.data)return;let c=un.vtlNeighborInfos.pushNew();c.offset=Pc[a],c.sourceLod=o.lij,c.sourceLayerInfo=l}),un;let n=r.upsampleInfo,s=n?.tile?.layerInfo[Ue.MAP][t];return s&&n.tile?(un.tile=n.tile,Yi(un.offset,n.offset),un.scale=n.scale,un.sourceLod=n.tile.lij,un.sourceLayerInfo=s,un):i?un:null}function nie(e){let t=e.sourceLayerInfo.data;return!!t.source&&t.interpolation==="nearest"}function V8(e){let t=e.blendMode!=="normal";return Uc(e.parent)&&(t=V8(e.parent)||t),t}function H8(e,t){Uc(e.parent)&&H8(e.parent,t);let i=e.uid;if(i!=null&&i!==""){let r=qD.get(i);r?r.start=t:qD.set(i,new jO(t,t,e.blendMode,e.opacity,Rr.Composite,1))}}function sie(e,t,i,r){let n=e.renderData,s=!r&&n.textureReference!=null&&(e.surface.view.layerViewManager.updating||t>0)?Sl.Delayed:Sl.Immediate;n.setTextureReference(new ud(i,di.FADING,B8,e.surface.baseOpacity,0,1),s)}u([d({constructOnly:!0})],Oc.prototype,"rctx",void 0),u([d({constructOnly:!0})],Oc.prototype,"techniques",void 0),u([d({constructOnly:!0})],Oc.prototype,"cache",void 0),u([d()],Oc.prototype,"tileSize",void 0),u([d()],Oc.prototype,"texturesBeingCompressed",void 0),Oc=u([C("esri.views.3d.terrain.TileRenderer")],Oc);var qD=new Map,Xf=new Array,un=new zD,B8=fn(0,0,1,1),Pc=new Array;Pc[ii.NORTH]=[0,-1],Pc[ii.NORTH_EAST]=[-1,-1],Pc[ii.EAST]=[-1,0],Pc[ii.SOUTH_EAST]=[-1,1],Pc[ii.SOUTH]=[0,1],Pc[ii.SOUTH_WEST]=[1,1],Pc[ii.WEST]=[1,0],Pc[ii.NORTH_WEST]=[1,-1];var z8=200,zO=40,oie=.8,aie=10,GO=1e-6;function lie(e,t,i){let r=t,n=i,s=0,o=1/0;for(let a=0;a<3;++a){{let l=e[a];if(r[a]<l){if(n[a]<=GO)return!1;let c=(l-r[a])/n[a];s=Math.max(s,c)}else if(n[a]<=-1e-6){let c=(l-r[a])/n[a];o=Math.min(o,c)}if(s>o)return!1}{let l=e[a+3];if(r[a]>l){if(n[a]>=-1e-6)return!1;let c=(l-r[a])/n[a];s=Math.max(s,c)}else if(n[a]>=GO){let c=(l-r[a])/n[a];o=Math.min(o,c)}if(s>o)return!1}}return!0}var WD=class{constructor(t,i,r,n,s){this.aabb=t,this.axis=i,this.d=r,this.midStartIndex=n,this.rightStartIndex=s}},G8=(()=>{class e{constructor(i,r,n,s){this.globalTriangleVertexIndices=i,this.firstTriangleIndex=r,this.positions=s,this._rayDirection=w(),this._callback=j8,this._intersectionOptions=U8,this.bspNodeTree=new Array;let o=n-r,a=new(o<pie?Uint8Array:o<mie?Uint16Array:Uint32Array)(o);this.triangleIndexMap=a;for(let l=0;l<o;++l)a[l]=l;{let l=hie(i,r,n,s.data,s.stride),c=q(Math.log2(o/zO),2,aie),h=(p,m,f)=>{let g=uie(a,l,p,m),_=m-p;if(_<=zO){let M=new WD(g,void 0,0,p,m);return this.bspNodeTree.push(M),M}let{axis:v,midValue:b}=die(g),x=cie(a,l,p,m,v,b),E=(M,T)=>{if(f>c)return;let I=T-M;return I<zO||I>=oie*_?void 0:h(M,T,f+1)},D=new WD(g,v,b,x.next,x.mid);return this.bspNodeTree.push(D),D.leftNode=E(p,x.next),D.rightNode=E(x.mid,m),D};h(0,o,0)}}intersectRayTriangleRange(i,r){if(i>=r)return;let n=this.positions;K0(this._rayFrom,this._rayDirection,i,r,this.globalTriangleVertexIndices,n.data,n.stride,this._intersectionOptions.normalRequired,this._callback,this.triangleIndexMap,this.firstTriangleIndex),e.numFacesTested+=r-i}intersectRay(i,r,n,s){e.numFacesTested=0;let o=i,a=r,l=a[0]-o[0],c=a[1]-o[1],h=a[2]-o[2];if(l*l+c*c+h*h<GO)return;this._rayFrom=o;let p=this._rayDirection;p[0]=l,p[1]=c,p[2]=h;let m=this.triangleIndexMap.length;this._callback=s,this._intersectionOptions=n,this.intersectRayBSP(this.bspNodeTree[0],0,m),this._callback=j8,this._intersectionOptions=U8}intersectRayBSP(i,r,n){let s=this._rayFrom,o=this._rayDirection;if(!lie(i.aabb,s,o))return;let a=i.axis,l=i.d;if(s[a]<l||o[a]<0){let c=r,h=i.midStartIndex;if(c<h){let p=i.leftNode;p!==void 0?this.intersectRayBSP(p,c,h):this.intersectRayTriangleRange(c,h)}}if(this.intersectRayTriangleRange(i.midStartIndex,i.rightStartIndex),s[a]>l||o[a]>0){let c=i.rightStartIndex,h=n;if(c<h){let p=i.rightNode;p!==void 0?this.intersectRayBSP(p,c,h):this.intersectRayTriangleRange(c,h)}}}get estimatedMemoryUsage(){return this.triangleIndexMap.byteLength}}return e.numFacesTested=0,e})(),Jf=[1/0,1/0,1/0],eg=[-1/0,-1/0,-1/0];function cie(e,t,i,r,n,s){let o=i,a=r;for(;o<a;){let c=e[o];t[6*c+n+3]<=s?++o:(--a,e[o]=e[a],e[a]=c)}let l=o;for(a=r;l<a;){let c=e[a-1];t[6*c+n]>=s?--a:(e[a-1]=e[l],e[l]=c,++l)}return{next:o,mid:l}}function uie(e,t,i,r){if(r<=i)return Bx(NaN,NaN,NaN,NaN,NaN,NaN);{let n=6*e[i];for(let s=0;s<3;++s)Jf[s]=t[n+0+s],eg[s]=t[n+3+s]}for(let n=i+1;n<r;++n){let s=6*e[n];for(let o=0;o<3;++o)Jf[o]=Math.min(Jf[o],t[s+0+o]),eg[o]=Math.max(eg[o],t[s+3+o])}return Bx(Jf[0],Jf[1],Jf[2],eg[0],eg[1],eg[2])}function die(e){let t=e[3]-e[0],i=e[4]-e[1],r=e[5]-e[2],n=t>i?t>r?0:i>r?1:2:i>r?1:r>t?2:0;return{axis:n,midValue:(e[n]+e[n+3])/2}}function hie(e,t,i,r,n){let s=i-t,o=new Float32Array(6*s);for(let a=0;a<s;++a){let l=3*(a+t),c=e[l]*n,h=e[l+1]*n,p=e[l+2]*n;for(let m=0;m<3;++m){let f=r[c+m],g=r[h+m],_=r[p+m];o[6*a+m]=Math.min(f,g,_),o[6*a+3+m]=Math.max(f,g,_)}}return o}var pie=255,mie=65535,U8=new Yp,j8=()=>{};var Hr=class extends uk{constructor(t){super(),this.spherical=t,this.overlayMode=dM.Disabled,this.tileBlendInput=hu.LayerOnly,this.transparencyMode=wn.Opaque,this.pbrMode=Zp.Simplified,this.doublePrecisionRequiresObfuscation=!1,this.receiveShadows=!1,this.backfaceCullingEnabled=!1,this.textureFadingEnabled=!1,this.renderOccluded=!1,this.screenSpaceReflections=!1,this.cloudReflections=!1,this.tileBorders=!1,this.visualizeNormals=!1,this.screenSizePerspective=!1,this.receiveAmbientOcclusion=!1,this.normalType=TF.Compressed,this.textureCoordinateType=zF.Compressed,this.highStepCount=!1,this.useCustomDTRExponentForWater=!1,this.useFillLights=!1,this.hasColorTexture=!0,this.canHaveOverlay=!0}};u([$t({count:dM.COUNT})],Hr.prototype,"overlayMode",void 0),u([$t({count:hu.COUNT})],Hr.prototype,"tileBlendInput",void 0),u([$t({count:wn.COUNT})],Hr.prototype,"transparencyMode",void 0),u([$t({count:Zp.COUNT})],Hr.prototype,"pbrMode",void 0),u([$t()],Hr.prototype,"doublePrecisionRequiresObfuscation",void 0),u([$t()],Hr.prototype,"receiveShadows",void 0),u([$t()],Hr.prototype,"backfaceCullingEnabled",void 0),u([$t()],Hr.prototype,"textureFadingEnabled",void 0),u([$t()],Hr.prototype,"renderOccluded",void 0),u([$t()],Hr.prototype,"screenSpaceReflections",void 0),u([$t()],Hr.prototype,"cloudReflections",void 0),u([$t()],Hr.prototype,"tileBorders",void 0),u([$t()],Hr.prototype,"visualizeNormals",void 0),u([$t()],Hr.prototype,"screenSizePerspective",void 0),u([$t()],Hr.prototype,"receiveAmbientOcclusion",void 0);var qO=7,fie=10,WO=jc(),Es=class extends zp{get _isGlobal(){return this._stage.viewingMode===Se.Global}get _techniques(){return this._context.techniques}get _rctx(){return this._context.renderContext.rctx}constructor(e,t,i,r,n){super({}),this._overlayRenderer=e,this._stage=t,this._allTiles=i,this._ellipsoidRadius=r,this.type=na.TERRAIN,this.isGround=!0,this._passParameters=new K3,this._drawParameters=new AF,this._renderDataPool=new no(MD),this._visiblePatchesByOrigin=new Map,this._allPatchesByOrigin=new Map,this._patchesByOriginDirty=!0,this._patchSortingDirty=!0,this._tileIterator=new Ow,this._castShadows=!1,this._inViewshed=!1,this._emptyTex=null,this._tileRenderer=null,this._stencilEnabledLayerExtents=new Array,this._numTilesRendered=0,this._numTilesCulled=0,this._numOriginsRendered=0,this.renderOccludedFlags=dr.Occlude,this.produces=new Map([[me.OPAQUE_TERRAIN,()=>this._produces()&&this.transparency===wn.Opaque],[me.TRANSPARENT_TERRAIN,()=>this._produces()&&(this.transparency===wn.Transparent||this.transparency===wn.InvisibleWithDraped)],[me.OCCLUDED_TERRAIN,()=>this._produces()]]),this._tileSize=256,this._configuration=new Hr(t.viewingMode===Se.Global),this._tileTextureCache=new Bo((s,o)=>n.newCache(s,o),"TileTexture"),this.tileGeometryCache=new HD(n)}normalizeCtorArgs(){return{}}initialize(){this._stage.addRenderPlugin(this),this.addHandles(S(()=>this._overlayRenderer.rendersOccludedDraped,e=>{this.renderOccludedFlags=e?mM:dr.Occlude,this.setNeedsRender()},Fe))}destroy(){this._stage.removeRenderPlugin(this),this._tileTextureCache.destroy(),this.tileGeometryCache.destroy()}_produces(){return this.visible&&!!this._rootTiles&&!this.renderingDisabled}consumes(){return this._overlayRenderer.hasWater?SF:MF}set renderingDisabled(e){this._set("renderingDisabled",!!e),this.setDirty()}set visible(e){this._set("visible",!!e),this.setDirty()}updateHeading(e){this._tileRenderer?.updateHeading(e)}set transparency(e){this._configuration.transparencyMode!==e&&(this._configuration.transparencyMode=e,this.setNeedsRender())}get transparency(){return this._configuration.transparencyMode}get tileRenderer(){return this._tileRenderer}get texturesBeingCompressed(){return this._tileRenderer?this._tileRenderer?.texturesBeingCompressed:null}get renderPatchBorders(){return this._configuration.tileBorders}set renderPatchBorders(e){this._configuration.tileBorders!==e&&(this._configuration.tileBorders=e,this.setNeedsRender(),this.notifyChange("renderPatchBorders"))}get visualizeNormals(){return this._configuration.visualizeNormals}set visualizeNormals(e){this._configuration.visualizeNormals!==e&&(this._configuration.visualizeNormals=e,this.setNeedsRender(),this.notifyChange("visualizeNormals"))}get cullBackFaces(){return this._configuration.backfaceCullingEnabled}set cullBackFaces(e){this._configuration.backfaceCullingEnabled!==e&&(this._configuration.backfaceCullingEnabled=e,this.notifyChange("cullBackFaces"),this.setNeedsRender())}set renderOrder(e){this._set("renderOrder",e),this._setSortingDirty()}get layerUid(){return Wl}get slicePlaneEnabled(){return this._configuration.hasSlicePlane}set slicePlaneEnabled(e){this._configuration.hasSlicePlane!==e&&(this._configuration.hasSlicePlane=e,this.setNeedsRender())}set textureFadingEnabled(e){this._configuration.textureFadingEnabled!==e&&(this._configuration.textureFadingEnabled=e,this.setNeedsRender())}set pbrMode(e){this._configuration.pbrMode!==e&&(this._configuration.pbrMode=e,this.setNeedsRender())}setDebugScreenSizePerspective(e){this._configuration.screenSizePerspective!==e&&(this._configuration.screenSizePerspective=e,this.setNeedsRender())}setRootTiles(e){this._rootTiles=e,this.setDirty()}setStencilEnabledLayerExtents(e){this._stencilEnabledLayerExtents=e,this._setSortingDirty()}set tileSize(e){this._tileSize=e,this._tileRenderer!=null&&(this._tileRenderer.tileSize=e),this.setDirty()}get tileSize(){return this._tileSize}_ensureRenderData(e){e.renderData||(e.renderData=this._renderDataPool.acquire(),e.renderData.init(e,this._getLocalOriginOfTile(e)))}loadTile(e){this._ensureRenderData(e),this.updateTileGeometryState(e),this.reuseTextureFromParent(e)||this.updateTileTexture(e,we.TEXTURE_FADING)}reuseTextureFromParent(e){let t=e.parent;if(!t)return!1;let i=fn(1&e.lij[2]?.5:0,1&e.lij[1]?0:.5,.5,.5);return t.renderData?.reuseTexture(e.renderData,i)??!1}updateTileTexture(e,t){this._tileRenderer!=null&&(this._tileRenderer.updateTileTexture(e,t===we.TEXTURE_FADING?di.FADING:di.UNFADED),this.setNeedsRender(),e.resetPendingUpdate(t))}updateTileGeometryState(e){for(let i of e.layerInfo[Ue.ELEVATION])i.pendingUpdates&=~we.GEOMETRY;e.resetPendingUpdate(we.GEOMETRY);let t=e.renderData.updateGeometryState();return t&&this.setDirty(),t}updateGeometryIfNeeded(e){e.loaded&&e.renderData.updateGeometryIfNeeded(this._rctx)}unloadTile(e){let t=e.renderData;t&&(t.releaseGeometry(),this._renderDataPool.release(t),t.clear(),e.renderData=null,e.setMemoryDirty(),this.setDirty())}_getLocalOriginOfTile(e){let t=fie-qO,i=Math.max(0,Math.floor((e.level-t)/qO)*qO);if(this._isGlobal&&i===0)return Jo;for(;e.parent&&e.level>i;)e=e.parent;return e.centerAtSeaLevel}getStats(){return{numTilesRendered:this._numTilesRendered,numTilesCulled:this._numTilesCulled,numOriginsRendered:this._numOriginsRendered}}set wireframe(e){this._get("wireframe")!==e&&(this._set("wireframe",e),this.setNeedsRender())}setDirty(e=Pe.UPDATE){this._patchesByOriginDirty=!0,this._context.requestRender(e)}_setSortingDirty(e=Pe.UPDATE){this._patchSortingDirty=!0,this._context.requestRender(e)}setNeedsRender(e=Pe.UPDATE){this._context.requestRender(e)}initializeRenderContext(e){this._context=e,this._tileRenderer=new Oc({rctx:this._rctx,tileSize:this._tileSize,techniques:this._techniques,cache:this._tileTextureCache}),this.updateTileBackground(),this._emptyTex=Nw(this._rctx)}uninitializeRenderContext(){this._emptyTex=We(this._emptyTex),this._tileRenderer=We(this._tileRenderer)}intersect(e,t,i,r){if(!this._rootTiles||e.options.selectOpaqueTerrainOnly&&e.options.selectionMode&&this.transparency!==wn.Opaque)return;let n=gie,s=_ie;ve(n,r,i),Te(s,1/n[0],1/n[1],1/n[2]);let o=e.results.min,a=e.results.max,l=e.results.ground,c=e.options.store===fo.MIN,h=!!e.results.ground.target,p=rk(e.verticalOffset),m=e.tolerance,f,g=c&&o.dist!=null?o.dist:1/0,_=e.options,v=_.normalRequired||!_.backfacesTerrain,b=new Yp(!1,v),x=D=>{let M=D.renderData;if(!M?.vao)return;let T=M.geometry;lL(WO,T.boundingBox);let I=M.localOrigin;p!=null&&(p.localOrigin=I,p.applyToAabb(WO));let A=WO;if(tg[0]=i[0]-I[0],tg[1]=i[1]-I[1],tg[2]=i[2]-I[2],!X0(A,tg,s,m,g))return;let O=(z,ce,ue)=>{z.set(this.type,D,ce,ue,Wc),g=c&&o.dist!=null?o.dist:1/0},$=(z,ce,ue)=>{if((!v||ue!=null)&&z>=0&&(_.backfacesTerrain||ae(ue,n)<0)&&(_.invisibleTerrain||!_.selectionMode||t==null||t(i,r,z))){if((l.dist==null||z<l.dist)&&O(l,z,ue),_.isFiltered)return;_.store===fo.ALL&&(f==null?(f=nk(e.ray),O(f,z,ue),e.results.all.push(f)):z<f.dist&&O(f,z,ue)),(o.dist==null||z<o.dist)&&O(o,z,ue),_.store!==fo.MIN&&(a.dist==null||z>a.dist)&&O(a,z,ue)}},H=yie;ve(H,r,I);let{indices:k,indexCount:K}=T,F=T.vertexAttributes,R=F.getField(yi.POSITION,EL),j=new hF(R.typedBuffer,3,F.stride/4),B=K/3;if(!p&&B>z8){let z=D.renderData;z.intersectionData==null&&(z.intersectionData=new G8(k,0,B,j)),z.intersectionData.intersectRay(tg,H,b,$)}else ok(tg,H,0,B,k,j,p,b,$)},E=this._rootTiles;E!=null&&(()=>{let D=this._tileIterator;D.reset(E);let M=e.options.invisibleTerrain;for(let T=D.next();T;T=D.next())!(T.visible||M&&T.intersectsClippingArea)||p==null&&!T.intersectsRay(i,n,m,g)||h&&this._useStencilForTile(T)?D.skipSubtree():x(T)})()}processScaleRangeQueries(e,t){if(!t.done)for(this._updatePatchGroups();e.updating&&!t.done;){e.prepare();for(let i of this._visiblePatchesByOrigin.values())for(let r of i)r.renderData?.textureReference!=null&&e.queriesForTile(r);e.process(),t.madeProgress()}}acquireTechniques(e){let t=!!Ct("enable-feature:terrain-shadows")&&e.bind.shadowMap.enabled;t!==this._castShadows&&(this._castShadows=t,this._patchesByOriginDirty=!0);let i=e.bind.viewshedEnabled;if(this._inViewshed!==i&&(this._inViewshed=i,this._patchesByOriginDirty=!0),e.bind.slot===me.OCCLUDED_TERRAIN){if(!(e.renderOccludedMask&mM))return null}else{let r=this.transparency===wn.Opaque?me.OPAQUE_TERRAIN:me.TRANSPARENT_TERRAIN;if(e.bind.slot!==r)return null}if(this.transparency===wn.Invisible)return null;switch(this._configuration.screenSpaceReflections=this._configuration.cloudReflections=this._configuration.receiveShadows=this._configuration.receiveAmbientOcclusion=!1,this._configuration.overlayMode=this._overlayRenderer.mode,e.output){case oe.Color:case oe.ColorEmission:return this._configuration.screenSpaceReflections=e.bind.ssr.lastFrameColor!=null,this._configuration.cloudReflections=e.bind.clouds.data!=null,this._configuration.receiveShadows=e.bind.shadowMap.ready,this._configuration.receiveAmbientOcclusion=e.bind.ssao!=null,this._acquireTechnique(e.output,e.bind.slot===me.OCCLUDED_TERRAIN);case oe.Shadow:case oe.ShadowExcludeHighlight:return this._castShadows?this._acquireTechnique(oe.Shadow,!1):null;case oe.ViewshedShadow:return this._inViewshed?this._acquireTechnique(oe.ViewshedShadow,!1):null;case oe.Depth:case oe.Normal:return this._acquireTechnique(e.output,!1);case oe.ObjectAndLayerIdColor:return this._acquireTechnique(oe.ObjectAndLayerIdColor,!1);case oe.Highlight:return this._overlayRenderer.hasHighlights?this._acquireTechnique(oe.Highlight,!1):null}return null}render(e,t){switch(this._updatePatchGroups(),t.useStencil=!1,e.output){case oe.Color:case oe.ColorEmission:{let i=e.bind.slot===me.OCCLUDED_TERRAIN?ru.Occluded:ru.Color;this._renderMaterialPass(e,t,i);break}case oe.Depth:case oe.Normal:this._renderAuxiliaryPass(e,t,ru.Color,this._visiblePatchesByOrigin);break;case oe.Highlight:{let i=e.bind.highlight?.name;i&&this._overlayRenderer.hasHighlights&&this._overlayRenderer.renders(ru.Highlight)&&this._overlayRenderer.hasHighlightOptions(i)&&this._renderAuxiliaryPass(e,t,ru.Highlight,this._visiblePatchesByOrigin);break}case oe.Shadow:case oe.ShadowExcludeHighlight:case oe.ViewshedShadow:this._renderAuxiliaryPass(e,t,null,this._allPatchesByOrigin);break;case oe.ObjectAndLayerIdColor:this._renderAuxiliaryPass(e,t,ru.ObjectAndLayerIdColor,this._visiblePatchesByOrigin)}}updateTileBackground(e){if(this._tileRenderer==null)return;let t=this._tileRenderer,i;if(e!=null){let r=_n.toUnitRGBA(e);i=yt(r[0]||0,r[1]||0,r[2]||0)}t.setBackground(i),this._allTiles.forAll(r=>t.updateTileTexture(r,di.FADING)),this._configuration.tileBlendInput=t.backgroundIsGrid?hu.GridComposite:t.backgroundColor!=null?hu.ColorComposite:hu.LayerOnly,this.setNeedsRender()}_updatePatchGroups(){if(this._patchesByOriginDirty&&(this._rebuildPatchGroups(),this._patchesByOriginDirty=!1,this._patchSortingDirty=!0),this._patchSortingDirty&&this.renderOrder!==s_.NONE){let e=Array.from(this._visiblePatchesByOrigin.values()),t=this._stencilEnabledLayerExtents;for(let i of e)S3(this.renderOrder,i,t);e.sort((i,r)=>I3(i[0],r[0],this.renderOrder)),this._visiblePatchesByOrigin=new Map(e.map(i=>[i[0].renderData.localOrigin,i])),this._patchSortingDirty=!1}}_rebuildPatchGroups(){let e=this._rootTiles;if(e!=null){e[0]?.surface.checkAllTilesWaterproofness(),this._visiblePatchesByOrigin.clear(),this._allPatchesByOrigin.clear();for(let t of e)this._rebuildPatchGroupsForRootTile(t)}}_rebuildPatchGroupsForRootTile(e){let t=this._tileIterator;for(t.resetOne(e);!t.done;){let i=t.next(),r=i.renderData;if(!r){this._numTilesCulled++;continue}let n=r.localOrigin;if(this._castShadows||this._inViewshed){let o=this._allPatchesByOrigin.get(n);o||(o=[],this._allPatchesByOrigin.set(n,o)),o.push(i)}if(!i.visible){this._numTilesCulled++,t.skipSubtree();continue}let s=this._visiblePatchesByOrigin.get(n);s||(s=[],this._visiblePatchesByOrigin.set(n,s)),s.push(i),t.skipSubtree()}}_useStencilForTile(e){for(let t of this._stencilEnabledLayerExtents)if(e.intersectsExtent(t))return!0;return!1}_renderAuxiliaryPass(e,t,i,r){let n=e.rctx;this._passParameters.overlayContent=i,n.bindTechnique(t,e.bind,this._passParameters);let s=this._stencilEnabledLayerExtents.length>0;r.forEach(o=>{this._drawParameters.origin=o[0].renderData.localOrigin,t.program.bindDraw(e.bind,this._passParameters,this._drawParameters);for(let a=0;a<o.length;a++)this._renderPatch(e,t,o[a],Jt.TRIANGLES,s,i)}),e.rctx.bindVAO(null)}_renderMaterialPass(e,t,i){let{rctx:r}=e;this._passParameters.overlayContent=i,r.bindTechnique(t,e.bind,this._passParameters),this._numTilesRendered=0,this._numTilesCulled=0,this._numOriginsRendered=0;let n=e.bind.camera,s=t.program;if(this._configuration.screenSizePerspective&&this.pointsOfInterest){let p=$0(this._stage.viewingMode,this._ellipsoidRadius),m=this.pointsOfInterest.centerOnSurfaceFrequent.distance;p.update({distance:m,fovY:n.fovY})}let o=this._stencilEnabledLayerExtents.length>0,a=i===ru.Occluded;a&&(s.bindTexture("tex",this._emptyTex),s.setUniform3fv("textureOpacities",Jo),s.setUniform4fv("texOffsetAndScale",gn));let l=this._tileRenderer?.backgroundColor!=null?this._tileRenderer.backgroundColor:Jo;this._configuration.tileBlendInput===hu.ColorComposite&&s.setUniform3fv("backgroundColor",l);let c=this.wireframe?Jt.LINES:Jt.TRIANGLES;this._configuration.textureFadingEnabled&&s.bindTexture("texNext",this._emptyTex);let h=this._visiblePatchesByOrigin;for(let p of h.values()){let m=p[0].renderData.localOrigin;this._drawParameters.origin=m,t.program.bindDraw(e.bind,this._passParameters,this._drawParameters),this._numOriginsRendered++;for(let f of p){let g=f.renderData,_=g.textureReference;if(_!=null){if(!a){s.setUniform4fv("texOffsetAndScale",_.offsetAndScale),s.bindTexture("tex",_.texture.texture);let v=g.textureFadeFactor,b=v<1?g.nextTextureReference:null;this._configuration.textureFadingEnabled&&b!=null&&v<1?(s.setUniform1f("fadeFactor",v),s.setUniform4fv("nextTexOffsetAndScale",b.offsetAndScale),s.setUniform3fv("nextTexOpacities",b.opacities),s.bindTexture("texNext",b.texture.texture)):s.setUniform1f("fadeFactor",1),g.textureIsFading&&this.setNeedsRender(),s.setUniform3fv("textureOpacities",_.opacities)}this._renderPatch(e,t,f,c,o,i),f.renderOrder=this._numTilesRendered,this._numTilesRendered++}}}e.rctx.bindVAO(null)}_renderPatch(e,t,i,r,n,s){let o=i.renderData,a=o.vao,l=a?.indexBuffer;if(!a||l==null)return void(Ki&&console.error("Rendered tile with no indices: ",i.lij," : ",o));let c=t.program;s==null||this._overlayRenderer.isEmpty||this._bindOverlayPatchData(c,o.overlay),n&&(t.useStencil=this._useStencilForTile(i),e.rctx.setPipelineState(t.getPipeline()));let h=o.geometry.indexCount;e.rctx.bindVAO(a),c.assertCompatibleVertexAttributeLocations(a),e.rctx.drawElements(r,h,l.indexType,0)}_bindOverlayPatchData(e,t){e.setUniform4fv("overlayTexOffset",t.offsets),e.setUniform4fv("overlayTexScale",t.scales)}_acquireTechnique(e,t){return this._configuration.output=e,this._configuration.renderOccluded=t,this._techniques.get(xD,this._configuration)}get test(){}hasHighlightOptions(e){return this._overlayRenderer.hasHighlightOptions(e)}};u([d({readOnly:!0})],Es.prototype,"_isGlobal",null),u([d()],Es.prototype,"renderOccludedFlags",void 0),u([d({value:!1})],Es.prototype,"renderingDisabled",null),u([d({value:!0})],Es.prototype,"visible",null),u([d()],Es.prototype,"texturesBeingCompressed",null),u([d()],Es.prototype,"renderPatchBorders",null),u([d()],Es.prototype,"visualizeNormals",null),u([d()],Es.prototype,"cullBackFaces",null),u([d({value:s_.FRONT_TO_BACK})],Es.prototype,"renderOrder",null),u([d()],Es.prototype,"wireframe",null),Es=u([C("esri.views.3d.terrain.TerrainRenderer")],Es);var gie=w(),_ie=w(),tg=w(),yie=w();var $D=class{constructor(){this.numNodes=0,this.numLeaves=0,this.numVisible=0,this.numRendered=0,this.numSplit=0,this.numMerged=0,this.numRenderedPerLevel=new Array,this.numLoadedPerLevel=new Array}};var xa=class extends P{constructor(e){super(e)}initialize(){this.addHandles([this.layers.on("change",()=>this._update()),S(()=>this.extentHelper.layerViewsExtent,()=>this._setAdHocTilingScheme())]),this._update(),this.tilingSchemeLocked||this._setAdHocTilingScheme()}destroy(){this._waitTask=null,this.layers.destroy()}_update(){if(this._waitTask=null,this.tilingSchemeLocked)return;let e;if(this.layers.some(t=>!(!Bc(t)||t.isRejected())&&!(t.isFulfilled()&&!vie(t,this.viewSpatialReference,this.viewingMode))&&(e=t,!(t?.type==="vector-tile"||Rw(t)))),e)if(e.isResolved()){let t=Ud(e,this.viewSpatialReference,this.viewingMode);if(t!=null){let i=new Hd(t.tileInfo);this._lockTilingScheme(i)}}else this._updateWhen(e)}_updateWhen(e){let t=e.when().catch(()=>{}).then(()=>{t!==this._waitTask||this.destroyed||this._update()});this._waitTask=t}_lockTilingScheme(e){if(this.viewingMode===Se.Global){let t=e.levels.length-1,i=e.spatialReference;i.isWebMercator?e=Hd.makeWebMercatorAuxiliarySphere(t):u3(i)&&(e=Hd.makeGCSWithTileSize(e.spatialReference,e.pixelSize,t))}this.tilingSchemeLocked=!0,this.tilingScheme=e,this.extentHelper.tilingScheme=this.tilingScheme,this._updateTiledLayerExtent(),this.removeAllHandles(),this.addHandles(S(()=>this.extentHelper.tiledLayersExtent,()=>this._updateTiledLayerExtent()))}_updateTiledLayerExtent(){this._set("extent",this.extentHelper.tiledLayersExtent)}_setAdHocTilingScheme(){if(this.viewingMode===Se.Global){let e=this.extentHelper.viewSpatialReference;e.isWebMercator?this.tilingScheme=Hd.WebMercatorAuxiliarySphere:c3(e)&&(this.tilingScheme=Hd.makeGCSWithTileSize(e,256)),this._set("extent",this.extentHelper.layerViewsExtent)}else{let e=this.extentHelper.layerViewsExtent;e==null||Ko(e,this.extent)||(this.tilingScheme=Hd.fromExtent(e,this.extentHelper.viewSpatialReference),this._set("extent",e))}}get test(){}};function vie(e,t,i){return Ud(e,t,i)!=null}u([d()],xa.prototype,"tilingScheme",void 0),u([d({readOnly:!0})],xa.prototype,"extent",void 0),u([d({value:!1})],xa.prototype,"tilingSchemeLocked",void 0),u([d({constructOnly:!0})],xa.prototype,"viewSpatialReference",void 0),u([d({constructOnly:!0})],xa.prototype,"layers",void 0),u([d({constructOnly:!0})],xa.prototype,"extentHelper",void 0),u([d({constructOnly:!0})],xa.prototype,"viewingMode",void 0),xa=u([C("esri.views.3d.terrain.TilingSchemeLogic")],xa);var ZD=class{constructor(){this._offset=Hi(),this.scale=0}get offset(){return this._offset}init(t,i,r,n){this.tile=t,this._offset[0]=i,this._offset[1]=r,this.scale=n}dispose(){this.tile=null,this._offset[0]=0,this._offset[1]=0,this.scale=0}};var YD,nt=YD=class extends oi.EventedMixin(P){get allTiles(){return this._allTiles}constructor(e){super(e),this._scaleRangeQueries=new sv,this._iteratorPool=new no(Ow,t=>t.remove=()=>this._iteratorPool.release(t)),this._postorderIterator=new x3,this._hasPendingUpdates=!1,this._pendingUpdates=0,this._asyncWorkItems=0,this._allTilesDirty=!0,this._allTilesSorted=!0,this._usedMemory=null,this._performanceInfo=new $D,this._viewChanged=!1,this.heading=0,this._inFrameTask=!1,this._viewChangeUpdateDirty=!1,this._eyePosRenderSR=w(),this._eyePosSurfaceSR=w(),this._splitLimits=new Go,this._frustum=Kx(),this._layerViews=[new Array,new Array],this._layerIndexByUid=[new Map,new Map],this._basemapLayerViewHandles=new Map,this._watchUpdatingTracking=new mo,this._frameTask=Ed,this._allTiles=new Nt,this._upsampleInfoPool=new no(ZD),this._shouldEmitChangeEvent=!1,this._destroying=!1,this._rootTilesExtent=Yt(),this.updatingProgress=.5,this._maxNumUpdating=1,this.maxTextureScale=1.2,this._spatialReference=Qt.WebMercator,this._elevationProjectorCache=new Map,this.visibleElevationBounds=new Dl(1/0,-1/0),this.rootTileElevationBounds=new Dl(1/0,-1/0),this._projectorCache=new Map,this._radiusModifier=Math.cos(Math.PI/16/16),this._tilingSchemeSpatialReference=null,this._updatingRootTiles=!1,this._pendingTilesForElevationUpdateEvent=new Set,this._pendingTilesToUpdate=new Set,this.totalGeometryUpdates=0,this.totalTileUpdates=0,this._oneBatchPerFrameTask=!0,this._layerViewsDirty=!1,this.unloadedMemory=0,this.ignoresMemoryFactor=!1,this._isWebMercator=!1,this._isWebMercatorOnPlateCarree=!1,this.overlayManager=new In(be(ie({},e),{surface:this})),this._isGlobal=!e.view?.state?.isLocal,this._isGeographic=this._spatialReference?.isGeographic??!1,this._tileConstructor=this._isGlobal?VD:kD,this._ellipsoid=_t(e.view.spatialReference)}initialize(){let e=this.view,t=e.resourceController,i=t.memoryController;this._tileCache=new Bo((l,c)=>i.newCache(l,c),"terrain-tile"),this._upsampleMapCache=i.newCache("terrain-upsample",l=>l.unloadMapData()),this._elevationQueryCache=new yD(i.newCache("elevation-query"));let r=this.overlayManager;this._renderer=new Es(r.renderer,e._stage,this._allTiles,this._ellipsoid.radius,i),this.addHandles([S(()=>r.renderer.isEmpty,()=>this._evaluateTransparency()),S(()=>this.renderer.visible,l=>this.suspended=!l),S(()=>this.heading,l=>{this._renderer.updateHeading(l),this._updateTileTextures(di.FADING)}),S(()=>({heading:e.camera?.heading,state:e.state?.mode}),({heading:l,state:c})=>{if(l==null)return;if(this.isGlobal&&this.isGeographic||this.isWebMercatorOnPlateCarree)return void(this.heading=90*Math.round(l/90)%360);let h=Math.round(l)%360,p=Math.abs(h-this.heading);(c===pi.IDLE||Math.min(p,360-p)>=30)&&(this.heading=h)})],"overlayManager"),this.addHandles([S(()=>this.baseOpacity,()=>{this._handleLayerViewChanges(),this._updateTileTextures(this._evaluateTransparency()?di.UNFADED:di.IMMEDIATE)},Ce),S(()=>this.hasCompositeBlendMode,()=>this._updateTileTextures(this._evaluateTransparency()?di.UNFADED:di.IMMEDIATE),Ce),S(()=>this.backgroundColor,(l,c)=>{l?.equals(c)||(this._handleLayerViewChanges(),this._renderer.updateTileBackground(l))},Fe),S(()=>this.snapLevel,()=>this._viewChanged=!0,Fe),S(()=>this.view.pointsOfInterest,l=>{this._renderer.pointsOfInterest=l,this._watchUpdatingTracking.removeAll(),l&&this._watchUpdatingTracking.add(()=>l.focus.renderLocation,()=>this._allTilesSorted=!1)}),S(()=>ur.TERRAIN_TILE_TREE_SHOW_TILES,l=>{l&&!this._treeDebugger?import("./chunk-WFNX6FSW.js").then(({TerrainTileTree3DDebugger:c})=>{!this._treeDebugger&&ur.TERRAIN_TILE_TREE_SHOW_TILES&&(this._treeDebugger=new c({view:e}))}):l||(this._treeDebugger=G(this._treeDebugger))},Re)]),this.addHandles([S(()=>this._renderer.tileRenderer?.texturesBeingCompressed,(l,c)=>{c&&l<c&&(this.setMemoryDirty(),this._allTiles.forAll(h=>h.setMemoryDirty()))})]),this.addHandles([S(()=>this._renderer.texturesBeingCompressed,(l,c)=>{l===0&&l!==c&&this.requestRender()})]);let{spatialReference:n}=e;this._extentHelper=Zq(this.viewingMode,{layers:e.map.allLayers,layerViews:e.allLayerViews,viewSpatialReference:n});let s=new $l({getCollections:()=>e.defaultsFromMap?.mapCollections?.map(({layers:l})=>l),getChildrenFunction:l=>l&&"layers"in l?l.layers:null}),o=new xa({layers:s,extentHelper:this._extentHelper,viewingMode:this.viewingMode,viewSpatialReference:n});this._set("tilingSchemeLogic",o),this._updateTilingScheme(),this._elevationDataRequester=t.createStreamDataRequester(n_.ELEVATION),this._mapDataRequester=t.createStreamDataRequester(n_.BASEMAP);let a=t.scheduler;this._frameTask=a.registerTask(Xt.TERRAIN_SURFACE,this),this.addHandles([S(()=>this._extentHelper.stencilEnabledExtents,l=>this._renderer.setStencilEnabledLayerExtents(l),Re),S(()=>this.tilingSchemeLogic.tilingScheme,()=>this._updateTilingScheme(),Fe),S(()=>this.extent,()=>this._updateRootTiles(),Re),e.on("resize",()=>this._viewChangeUpdate()),S(()=>{let l=e.state;return[this._lodBias,this.lodSnappingEnabled,e.quality,l.camera,l.contentCamera,l.fixedContentCamera]},()=>this._viewChangeUpdate(),Ce),S(()=>e.qualitySettings?.fadeDuration,l=>this._renderer.textureFadingEnabled=l>0,Re),S(()=>e.qualitySettings?.physicallyBasedRenderingEnabled,l=>this._renderer.pbrMode=l?Zp.Simplified:Zp.Disabled,Re),S(()=>e.qualitySettings?.tiledSurface.elevationLevelDelta,()=>this._updateAllTileGeometries()),S(()=>this._userClippingExtent,()=>this._updateClippingExtent(),Fe)]),this.addHandles(e.allLayerViews.on("after-changes",()=>this._layerViewsDirty=!0)),this._layerViewsDirty=!0,this._handleLayerViewChanges(),this._renderer.updateTileBackground(this.backgroundColor)}destroy(){this._destroying=!0,this._frameTask.remove(),this._watchUpdatingTracking.destroy(),this._removeAllTiles(),this._set("tilingSchemeLogic",G(this.tilingSchemeLogic)),this._basemapLayerViewHandles.forEach((e,t)=>this._unregisterTiledLayerView(t)),this._elevationDataRequester=null,this._mapDataRequester=null,this._set("overlayManager",G(this.overlayManager)),this._tileCache=G(this._tileCache),hd.prune(),this._treeDebugger=G(this._treeDebugger),this._renderer=G(this._renderer),this._iteratorPool=G(this._iteratorPool),this._upsampleMapCache=G(this._upsampleMapCache),this._elevationQueryCache=G(this._elevationQueryCache),this._set("view",null),this._extentHelper=G(this._extentHelper),this._upsampleInfoPool=G(this._upsampleInfoPool),r8()}get renderer(){return this._renderer}get frustum(){return this._frustum}get snapLevel(){if(this.lodSnappingEnabled){let{view:e,tilingScheme:t}=this,i=e.scale;if(t&&i){let r=t.levelAtScale(i)+e.qualitySettings.tiledSurface.lodBias,n=t.getMaxLod();return r<=0?null:Math.min(r,n||1/0)}}return null}get lodSnappingEnabled(){return this.view.qualitySettings.tiledSurface.reduceTileLevelDifferences}get upsampleInfoPool(){return this._upsampleInfoPool}get upsampleMapCache(){return this._upsampleMapCache}get elevationQueryCache(){return this._elevationQueryCache}get hasStencilEnabledExtents(){return this._extentHelper.stencilEnabledExtents.length>0}get _userClippingExtent(){let{spatialReference:e}=this,{clippingArea:t}=this.view;if(t==null||e==null)return null;let i=Yt(),r=Ew(t,i,e)?i:null,n=this._get("extent");return Ko(r,n)?n:r}get rootTilesExtent(){return this._rootTilesExtent}get extent(){let e=Ng(this.groundExtent,this._userClippingExtent,Yt()),t=this._get("extent");return Ko(e,t)?t:e}get groundExtent(){return this._tilingSchemeExtent!=null?this._tilingSchemeExtent:this._rootTilesExtent}get _tilingSchemeExtent(){return this.tilingSchemeLogic?.extent}get updating(){return this._hasPendingUpdates||(this._maxNumUpdating=1),!!((this.running||this._watchUpdatingTracking?.updating||this._asyncWorkItems>0)&&this.ready&&!this.suspended||this.overlayManager?.updating||this.renderer.texturesBeingCompressed)}get running(){return(this._hasPendingUpdates||this._viewChanged||this._allTilesDirty||!this._allTilesSorted||this._layerViewsDirty||this._scaleRangeQueries.updating||this._frameTask.updating)&&this.ready&&!this.suspended}get updatingProgressValue(){return this._maxNumUpdating=Math.max(this._pendingUpdates,this._maxNumUpdating),1-this._pendingUpdates/this._maxNumUpdating}get baseOpacity(){return this.view?.map?.ground?.opacity??1}set baseOpacity(e){this.view.map.ground.opacity=e}get viewingMode(){return this.view.state.viewingMode}get ready(){return this._rootTiles!=null}set renderOrder(e){this._renderer.renderOrder=e,this._set("renderOrder",e)}get rootTiles(){return this._rootTiles}get spatialReference(){return this.tilingScheme?.spatialReference??null}get backgroundColor(){return this.view?.map?.ground?.surfaceColor}set backgroundColor(e){this.view.map.ground.surfaceColor=e}set slicePlaneEnabled(e){this._renderer.slicePlaneEnabled=e,this._set("slicePlaneEnabled",e),this._evaluateTransparency()}get tilingSchemeLocked(){return this.tilingSchemeLogic?.tilingSchemeLocked??!1}get wireframe(){return this._renderer?.wireframe}set wireframe(e){e!==this._renderer.wireframe&&(this._renderer.wireframe=e,this._updateAllTileGeometries())}get opaque(){return this._renderer.transparency===wn.Opaque}set suspended(e){this._set("suspended",e),this._viewChangeUpdate()}get fadeDuration(){return this.view.qualitySettings.fadeDuration??0}intersect(e,t,i,r){this._renderer.intersect(e,t,i,r)}getElevationLevelDelta(e){return e<4?3:this.view.qualitySettings.tiledSurface.elevationLevelDelta}getElevation(e,t,i,r){let n=this._rootTiles;if(!n?.length||n[0].layerInfo[Ue.ELEVATION].length===0)return null;let s=this._elevationProjectorCache.get(r);if(s===void 0&&(s=Vg(r,this._spatialReference)??null,this._elevationProjectorCache.set(r,s)),s==null)return W.getLogger(this).error("TerrainSurface.getElevation(): could not project given point to tiling scheme coordinate system"),null;let o=Te(hv,e,t,i);return s(o,0,o,0),q8(n,o[0],o[1])}getElevations(e,t,i){let r=this._rootTiles,n=r?r[0].layerInfo[Ue.ELEVATION].length:0;if(r?.length&&n!==0)for(let s=0;s<t;++s){let o=3*s;i(s,q8(r,e[o],e[o+1]))}else for(let s=0;s<t;++s)i(s,null)}getScale(e){if(!this.tilingScheme)return null;if(!$c(e,hv,this.spatialReference))return W.getLogger(this).error("TerrainSurface.getScale(): could not project given point to tiling scheme coordinate system"),null;let t=this._rootTiles;if(t!=null){for(let i of t)if(i?.containsPoint(hv)){let r=i;for(;r.children[0]&&!r.rendered;){let n=r.children[0].extent,s=0;hv[0]>n[2]&&(s+=1),hv[1]<n[1]&&(s+=2),r=r.children[s]}return this._getLodBiasCorrectedScale(r.level)}}return 1/0}_ensureProjector(e){let t=this._projectorCache.get(e);if(t)return t;let i=Vg(e,this._tilingSchemeSpatialReference)??null;return this._projectorCache.set(e,i),i}getSphereElevationBounds(e,t){let i=this._ensureProjector(t);if(i==null)return W.getLogger(this).error("TerrainSurface.getSphereElevationBounds(): could not project given point to tiling scheme coordinate system"),null;fF(e,ig);let r=ig;i(r,0,r,0);let n=new jp,s=this._rootTiles;if(s!=null){let o=[];for(let l of s)o.push(l);let a=0;for(;a<o.length;){let l=o[a];if(++a,!Nx(l.extent,ig))continue;let c=l.children;if(c[0]==null||l.rendered)n.expandElevationRangeValues(l.elevationBoundsMin,l.elevationBoundsMax);else for(let h of c)o.push(h)}}return n}getRootElevationBounds(){return new jp(this.rootTileElevationBounds.min,this.rootTileElevationBounds.max)}getLowerBoundRadius(){let e=(this._ellipsoid.radius+this.visibleElevationBounds.min)*this._radiusModifier;return Math.min(e,this._ellipsoid.radius)}getSphereScale(e,t){if(!this.tilingScheme)return null;if(!$c(e,ig,this.spatialReference))return W.getLogger(this).error("TerrainSurface.getSphereScale(): could not project given point to tiling scheme coordinate system"),null;ig[3]=t;let i=null,r=s=>{if(s&&Nx(s.extent,ig)){let o=s.children;if(o[0]&&!s.rendered)for(let a of o)r(a);else{let a=this._getLodBiasCorrectedScale(s.level);i=i==null?a:Math.min(i,a)}}},n=this._rootTiles;if(n!=null)for(let s of n)r(s);return i}queryVisibleScaleRange(e,t,i,r){let n=t?this.tilingScheme.levelAtScale(t):0,s=i?this.tilingScheme.levelAtScale(i):1/0,o=this._lodBias;this._scaleRangeQueries.queryVisibleLevelRange(e,n+o,s+o,r)}_evaluateTransparency(){let e=this.baseOpacity,t=this.overlayManager.renderer.isEmpty,i=this._renderer.transparency,r=this._allSurfaceLayersTransparent()?t?wn.Invisible:wn.InvisibleWithDraped:e>=1&&!this.hasCompositeBlendMode&&!this._renderer.slicePlaneEnabled?wn.Opaque:wn.Transparent;return this._renderer.transparency=r,i!==r}_updateTilingScheme(){let e=this.tilingSchemeLogic.tilingScheme;if(e===this.tilingScheme)return;ir(!!e,"tiling scheme cannot be reset to undefined"),this._isGlobal=!this.view?.state?.isLocal,this.tilingScheme&&this._removeAllTiles();let t=e?.spatialReference??Qt.WebMercator;this._spatialReference=t,this._isWebMercator=!!t?.isWebMercator,this._isWebMercatorOnPlateCarree=this._isWebMercator&&c0(this.view?.renderSpatialReference),this._isGeographic=t?.isGeographic??!1,this._set("tilingScheme",e),this._tilingSchemeSpatialReference=this.tilingScheme?.spatialReference,this._projectorCache.clear(),this._updateClippingExtent(),e&&(this._updateTiledLayers(),this._renderer.tileSize=e.pixelSize,this.overlayManager.spatialReference=e.spatialReference,this._updateRootTiles())}_acquireTile(e,t,i,r){let n=this._tileCache.pop(YD._tileMemcacheKey);return n?(n.init(e,t,i,r,this),n):new this._tileConstructor(e,t,i,r,this)}get updatingRootTiles(){return this._updatingRootTiles}_updateRootTiles(){let{extent:e,tilingScheme:t}=this;if(!t)return;let i=wie,r=t.rootTilesInExtent(e,i,5*e_);if(this._rootTiles!=null){if(r.length>e_)return void W.getLogger(this).warn(n3);let n=this._rootTiles.map(o=>o.lij),s=xg(n,r,rv);if(this._updatingRootTiles=!0,s.removed.length>0||s.added.length>0){let o=this._rootTiles.filter(a=>!(s.removed.findIndex(l=>rv(l,a.lij))>-1)||(this._purgeTile(a),!1));s.added.forEach(a=>o.push(this._newRootTile(a))),this._setRootTiles(o)}}else this._updatingRootTiles=!0,r.length>e_&&(W.getLogger(this).warn(s3),r=t.rootTilesInExtent(e,i,e_)),this._setRootTiles(r.map(n=>this._newRootTile(n)));Ko(i,this._rootTilesExtent)||(this._rootTilesExtent=Yt(i)),this.renderer.visible=!0,this._viewChangeUpdate(),this.overlayManager.setPlacementDirty(),this.notifyChange("ready"),this._updateAllTileGeometries(),this._updatingRootTiles=!1,this.checkAllTilesWaterproofness()}_updateAllTileGeometries(){let e=this._allTiles.filter(t=>t.loaded&&t.intersectsClippingArea);e.sort(wo),e.forEach(t=>this._renderer.updateTileGeometryState(t)),e.forEach(t=>t.renderData.updateNeighborData()),this._updateTilesGeometries(e),this._pendingTilesToUpdate.clear()}_updateTilesGeometries(e){if(e.length===0)return;e.sort(wo);let t=this.renderer;e.forEach(i=>t.updateGeometryIfNeeded(i)),e.forEach(i=>this._pendingTilesForElevationUpdateEvent.add(i))}_shouldSplit(e){return e.shouldSplit(this._splitLimits,this._eyePosRenderSR,this.snapLevel)===we.SPLIT}_newRootTile(e){let t=this._acquireTile(0,e[1],e[2],null);return this._shouldSplit(t)&&t.setPendingUpdate(we.SPLIT),this._loadTile(t),this._markTileToUpdate(t),this._updateRootTileElevationBounds(),t}_setRootTiles(e){if(this._rootTiles=e,this._allTiles.clear(),e!=null){let t=this._iteratorPool.acquire();for(t.reset(e);!t.done;)this._allTiles.push(t.next());t.remove()}this._renderer.setRootTiles(this._rootTiles),this._updateTilesVisibility(e)}_runViewChangeUpdateIfDirty(){this._viewChangeUpdateDirty&&(this._viewChangeUpdateDirty=!1,this._viewChangeUpdate())}_viewChangeUpdate(){this.view&&!this.suspended&&this.tilingScheme&&this.renderer.visible&&(this._inFrameTask?this._viewChangeUpdateDirty=!0:(this._viewChangeUpdateDirty=!1,this._updateViewDependentParameters(),this._updateTilesVisibility(this._rootTiles)))}_updateClippingStatus(e){e.updateClippingStatus(this.extent)&&e.resetPendingUpdate(we.GEOMETRY)&&this._updateTileGeometryState(e)}_updateTilesVisibility(e){if(e==null)return;let t=P3(e),i=this.visibleElevationBounds,r=t?i.min:1/0,n=t?i.max:-1/0,s=this.extent,o=this.view.state.contentCamera.viewProjectionMatrix;this.setTileTreeDirty();let a=this._iteratorPool.acquire();for(a.reset(e);!a.done;){let l=a.next();l.updateClippingStatus(s)&&l.resetPendingUpdate(we.GEOMETRY)&&this._updateTileGeometryState(l),l.computeVisibility(),l.updateScreenDepth(o),l.renderData&&(r=Math.min(l.elevationBoundsMin,r),n=Math.max(l.elevationBoundsMax,n))}a.remove(),this._viewChanged=!0,this._allTilesDirty=!0,this._updatePendingTileGeometries(),isFinite(r)&&isFinite(n)&&(i.min!==r||i.max!==n)&&(this.visibleElevationBounds=new Dl(r,n))}_updateRootTileElevationBounds(){let e=1/0,t=-1/0,i=this._rootTiles;i?.forEach(({elevationBoundsMin:n,elevationBoundsMax:s})=>{e=Math.min(e,n),t=Math.max(t,s)});let r=this.rootTileElevationBounds;r.min===e&&r.max===t||(this.rootTileElevationBounds=new Dl(e,t))}_updateViewDependentParameters(){let{camera:e,contentCamera:t}=this.view.state,i=Math.tan(.5*t.fovX),r=Math.tan(.5*t.fovY),n=this.tilingScheme.pixelSize,s=2**-this._lodBias*e.pixelRatio;this._splitLimits.aboveGround=e.aboveGround,this._splitLimits.fovX=i,this._splitLimits.fovY=r,this._splitLimits.relativeWidthLimit=n/e.width*this.maxTextureScale*s,this._splitLimits.relativeHeightLimit=n/e.height*this.maxTextureScale*s,this._splitLimits.maxLod=this.tilingScheme.getMaxLod(),this._splitLimits.angledSplitBias=this.view.qualitySettings.tiledSurface.angledSplitBias,this.view.state.fixedContentCamera?this._splitLimits.frustum=Xx(this._splitLimits.frustum??Kx(),t.frustum):this._splitLimits.frustum=null,Xx(this._frustum,e.frustum),ee(this._eyePosRenderSR,t.eye),Ua(e.eye,this.view.renderSpatialReference,this._eyePosSurfaceSR,this.spatialReference)}_updateTileGeometryState(e){e.updateVisibility(),this._renderer.updateTileGeometryState(e)&&this._markTileToUpdate(e),this.setMemoryDirty()}_markAllTileNeighborsForUpdate(e){e.forEachLoadedNeighbor(t=>{this._layerViews[Ue.MAP].some(om)&&t.setPendingUpdate(we.TEXTURE_FADING),this._pendingTilesToUpdate.add(t)})}_updateTileTexture(e,t){let i=e.resetPendingUpdate(we.TEXTURE_FADING)?we.TEXTURE_FADING:!!e.resetPendingUpdate(we.TEXTURE_NOFADING)&&we.TEXTURE_NOFADING;i&&(this._renderer.updateTileTexture(e,i),this._usedMemory=null,t.madeProgress())}_emitElevationUpdateEventForTiles(){if(!this._shouldEmitChangeEvent)return;let e=$O.extent;Yo(e),this._pendingTilesForElevationUpdateEvent.forEach(t=>ka(e,t.extent,e)),this._pendingTilesForElevationUpdateEvent.clear(),$O.spatialReference=this.spatialReference,this.emit("elevation-change",$O),this._shouldEmitChangeEvent=!1}runTask(e){this._handleLayerViewChanges(e),this._frameTask.processQueue(e),this.renderer.processScaleRangeQueries(this._scaleRangeQueries,e),this._inFrameTask=!0,this._pendingUpdates=0,this._hasPendingUpdates=!1,this._updateAllTilesStatus(e),this._sortTiles(e);let t=!this.view.state.fixedContentCamera;if(this._mergeAndSplit(e,t),this._updateElevation(e),this._updateTextures(e),t||this._mergeAndSplit(e,!0),this._inFrameTask=!1,this._runViewChangeUpdateIfDirty(),this._updatePendingTileGeometries(),this._emitElevationUpdateEventForTiles(),e.done&&e.hasProgressed&&this.requestUpdate(),this.notifyChange("updatingProgressValue"),Ki&&this._checkTileInvariant(),!e.hasProgressed)return Ui}_checkTileInvariant(){let e=new Map;this._allTiles.forAll(t=>e.set(t,new Set)),this._allTiles.forAll(t=>{if(ir(t.rendered===t.leaf,` rendered ${t.rendered} != ${t.leaf} leaf`),!t.leaf){let i=n=>n.unmergableChildCount===0&&n.maxLevelDeltaNeighborCount===0,r=t.children.reduce((n,s)=>n+(i(s)?0:1),0);if(ir(t.unmergableChildCount===r,` Tile[${t.lij.toString()}] unmergeable child count mismatch: actual ${t.unmergableChildCount} vs ${r}`),t.hasPendingUpdate(we.MERGE)){ir(!t.hasPendingUpdate(we.SPLIT),"Tile can be both split and merge at the same time");for(let n of t.children)ir(n.leaf||n.hasPendingUpdate(we.MERGE),"Child of tile to merge must also merge")}}for(let i=0;i<4;++i){if(t.rendered){let o=t.renderData?.geometryState.edgePeerNeighbors[i];if(o!=null){{let a=t.level-o.level<=Gi;a||(console.log(`tile level delta [${t.lij.toString()}] vs [${o.lij.toString()}] > ${Gi}  (edge[${i}])`),ir(a,`tile level delta [${t.level}] vs [${o.level}] > ${Gi}`))}ir(t.level-o.level<=Gi,`Max tile lod delta exceeded: [${t.lij.toString()}] vs [${o.lij.toString()}]`)}}let r=t.level-Gi,n=o=>o.leaf||o.level===t.level,s=t.findNeighborTile(Bn[i],n);if(s!=null){if(t.leaf&&t.level>=Gi){let o=s;for(;t.level-o.level<Gi;)o=o.parent;let a=[r,t.lij[1]>>Gi,t.lij[2]>>Gi];if(!rv(a,o.lij)){let l=e.get(o);ir(!l.has(t),"Cannot already have neighbor"),l.add(t)}}ir(s.rendered||s.level===t.level,"Non-same-level-neighbor of rendered must be rendered"),ir(t.level-s.level<=Gi,`Tile level delta [${t.level}] vs [${s.level}] > ${Gi}`)}}}),this._allTiles.forAll(t=>{let i=t.maxLevelDeltaNeighborCount,r=e.get(t);ir(i===r.size,`Tile[${t.lij.toString()}] merge-blocker mismatch: actual ${i} vs ${r.size}`)})}_updateAllTilesStatus(e){if(!this._viewChanged||!this._rootTiles||e.done)return;this._viewChanged=!1;let t=new QO(this._allTiles.length);t.pushAll(this._rootTiles);let i=this.snapLevel,r=this._splitLimits,n=this._eyePosRenderSR;this._allTiles.forAll(o=>{o.maxLevelDeltaNeighborCount=0,o.unmergableChildCount=0});let s=this.view.state.contentCamera.viewProjectionMatrix;for(;!t.empty;){let o=t.pop(),a=o.parent,l=a!=null&&a.hasPendingUpdate(we.MERGE),c=l?we.MERGE:o.shouldSplit(r,n,i),h=c===we.SPLIT;o.leaf?ZO(o,h):t.pushAll(o.children),l?(o.resetPendingUpdate(we.SPLIT),o.leaf||o.setPendingUpdate(we.MERGE),this._updateClippingStatus(o),o.updateVisibility(),o.updateScreenDepth(s)):h?(o.resetPendingUpdate(we.MERGE),o.leaf&&o.setPendingUpdate(we.SPLIT)):(o.resetPendingUpdate(we.SPLIT)&&o.updateAgentSuspension(),c===we.ELEVATION&&o.updateAgents(Ue.ELEVATION),o.leaf||(o.setPendingUpdate(we.MERGE),o.resetPendingUpdate(we.SPLIT)))}this.requestUpdate(),(this._shortBatches||!this._oneBatchPerFrameTask)&&this._updatePendingTileGeometries(),e.madeProgress()}_sortTiles(e){e.done||this._allTilesSorted||(A3(this._allTiles,this.view.pointsOfInterest.focus.renderLocation),this._allTilesSorted=!0,this._treeDebugger&&this._treeDebugger.update(),e.madeProgress())}_markTileToUpdate(e){te(e.loaded),e.intersectsClippingArea&&(this._pendingTilesToUpdate.add(e),this._markAllTileNeighborsForUpdate(e))}_updatePendingTileGeometries(){let e=this._pendingTilesToUpdate,t=Array.from(e.keys()).filter(n=>n.loaded&&n.intersectsClippingArea);if(t.length===0)return void e.clear();let i=(n,s)=>{!s?.loaded||!s.intersectsClippingArea||s.level<n.level||e.has(s)||(e.add(s),t.push(s),s.renderData.updateNeighborData())};t.sort(wo);let r=t.length;for(let n=0;n<r;++n){let s=t[n];te(s.loaded),te(s.intersectsClippingArea);let o=s.renderData;o.updateNeighborData();let a=o.dirtyEdgeResolutions,l=o.geometryState,c=h=>{let p=jd[h];i(s,l.cornerPeerNeighbors[h]?.findCorner(lm(p),m=>m.loaded))};for(let h=0;h<4;++h)if(a&1<<h){let p=o.geometryState.edgePeerNeighbors[h];p&&p?.level>=s.level&&p.forAllSubtreeOnSide(cm(Bn[h]),m=>!(!m.loaded||!m.intersectsClippingArea)&&(te(e.has(m)||wo(s,m)<0),i(s,m),!0)),c((h+1)%4),c(h)}}e.clear(),this._updateTilesGeometries(t),this._shouldEmitChangeEvent=!0,Ki&&i_&&this.checkAllTilesWaterproofness()}_mergeAndSplit(e,t){if(this.suspended||e.done||!this._allTilesDirty)return;this._allTilesDirty=!1,this.requestUpdate();let i=!1,r=this.view.state.fixedContentCamera,n=!1;for(;!e.done;){n=!0;let s=!1,o=!this._allTiles.some(a=>{if(!i&&!r&&!a.visible)return e.done;let l=a;if(a.hasPendingUpdate(we.MERGE)){if(!t||a.unmergableChildCount>0)return e.done;for(a.resetPendingUpdate(we.MERGE);l.parent!=null&&l.parent.unmergableChildCount===0&&l.parent.resetPendingUpdate(we.MERGE);)l=l.parent;this._mergeTile(l),s=!0,e.madeProgress()}else if(a.resetPendingUpdate(we.SPLIT)){let c=!0,h=a.level;if(h>=Gi){let p=m=>m.leaf||h-m.level<Gi;for(let m=0;m<4;++m){let f=a.findNeighborTile(Bn[m],p);f!=null&&h-f.level===Gi&&(c=!1,Ki&&(te(f.leaf),te(f.hasPendingUpdate(we.SPLIT))))}}c?(this._splitTile(a),e.madeProgress(),s=!0):a.setPendingUpdate(we.SPLIT)}return e.done});if(s&&(this._allTilesSorted=!1,this._allTilesDirty=!0,!this._oneBatchPerFrameTask&&this._updatePendingTileGeometries()),o){if(!i){i=!0;continue}if(!s)break}else this._allTilesDirty=!0}n?e.madeProgress():this._allTilesDirty=!0,!this._oneBatchPerFrameTask&&this._updatePendingTileGeometries(),this._sortTiles(e)}_updateElevation(e){e.done||(this._allTiles.some(t=>(t.resetPendingUpdate(we.GEOMETRY)&&(this._updateTileGeometryState(t),this._shortBatches&&this._updatePendingTileGeometries(),e.madeProgress()),e.done)),!this._oneBatchPerFrameTask&&this._updatePendingTileGeometries())}_updateTextures(e){e.done||this._allTiles.some(t=>(this._updateTileTexture(t,e),e.done))}_updateClippingExtent(){this.spatialReference&&(this.overlayManager?.updateOverlayParameters(Pe.UPDATE),this.overlayManager.setPlacementDirty(),this._updateRootTiles())}get _lodBias(){let e=this.view.quality;return this.view.qualitySettings.tiledSurface.lodBias-(1-e)*t3}_getLodBiasCorrectedScale(e){let t=this.tilingScheme.levels,i=q(e-this._lodBias,0,t.length-1),r=i-Math.floor(i);return t[Math.floor(i)].scale*(1-r)+t[Math.ceil(i)].scale*r}_removeAllTiles(){this._rootTiles!=null&&(this._rootTiles.forEach(e=>this._purgeTile(e)),this._setRootTiles(null),this.notifyChange("ready")),this._allTiles.clear(),this.renderer.visible=!1}_purgeSubtree(e){let t=e.children;t[0]&&(this._purgeTile(t[0]),this._purgeTile(t[1]),this._purgeTile(t[2]),this._purgeTile(t[3]),e.clearChildren())}_purgeTile(e){e.leaf?W8(e):this._purgeSubtree(e),this._allTiles.removeUnordered(e),this._unloadTile(e),e.dispose(),this._tileCache.put(YD._tileMemcacheKey,e)}_unloadTile(e){this._pendingTilesToUpdate.delete(e),this._pendingTilesForElevationUpdateEvent.delete(e),e.unload()}_splitTile(e){ir(e.leaf,"Tile that is already split should not be split again!"),ir(e.rendered,"Tile marked to split is not rendered"),W8(e);let t=e.createChildren();this._allTiles.pushArray(t),e.updateAgentSuspension(),ir(e.rendered,"parent should be rendered"),t.forEach(i=>this._loadTile(i)),t.forEach(i=>this._pendingTilesToUpdate.add(i)),this._unloadTile(e),this._markAllTileNeighborsForUpdate(e),this._emitTileScaleChange(e,e.level+1),this._allTilesDirty=!0,this._shortBatches&&this._updatePendingTileGeometries(),t.forEach(i=>ZO(i,i.hasPendingUpdate(we.SPLIT))),++this._performanceInfo.numSplit}_emitTileScaleChange(e,t=e.level){QD.spatialReference=this.spatialReference,QD.extent=e.extent,QD.scale=this._getLodBiasCorrectedScale(t),this.emit("scale-change",QD)}createTile(e,t,i,r){ir(!!r,"createTile sanity check");let n=this._acquireTile(e,t,i,r);return n.updateClippingStatus(this.extent),n.updateScreenDepth(this.view.state.contentCamera.viewProjectionMatrix),this._shouldSplit(n)&&n.setPendingUpdate(we.SPLIT),n}get _shortBatches(){return this.view.state.mode!==pi.IDLE}_mergeTile(e){ir(!e.hasPendingUpdate(we.SPLIT),"_mergeTile sanity check"),ir(!e.leaf,"Cannot merge a leaf"),e.leaf||(this._purgeSubtree(e),ir(!e.renderData,"Merging tile with existing render data?"),this._loadTile(e),this._markTileToUpdate(e),this._emitTileScaleChange(e),this._shortBatches&&this._updatePendingTileGeometries(),ZO(e,!1),this._allTilesDirty=!0,++this._performanceInfo.numMerged)}_loadTile(e){e.load(),this.requestUpdate(),this._allTilesDirty=!0,this.overlayManager?.hasOverlays&&this.overlayManager.updateTileOverlayParameters(e)}_handleLayerViewChanges(e=Jn){if(!this._layerViewsDirty)return;this._layerViewsDirty=!1;let t=!1,i=new Set,r=-1;for(let n=this.view.allLayerViews.length-1;n>=0;n--){let s=this.view.allLayerViews.items[n];if(i.add(s.uid),r_(s)||am(s))if(this._basemapLayerViewHandles.has(s.uid)&&!am(s)){let o=this._layerClassFromLayerView(s),a=this._getLayerIdxByUID(o,s.uid);a!=null&&((a<r||r==null)&&(t=!0),r=a)}else this._registerTiledLayerView(s),s.layer.loaded&&(t=!0)}this._basemapLayerViewHandles.forEach((n,s)=>{i.has(s)||(this._unregisterTiledLayerView(s),t=!0)}),t&&this._updateTiledLayers(),this.hasCompositeBlendMode=this._hasCompositeBlendMode(),this._evaluateTransparency(),e.madeProgress()}_allSurfaceLayersTransparent(){let e=this.view.map?.ground?.opacity===0;for(let t of this.view.allLayerViews.items)if(CM(t)&&!Dp(t.layer)&&t.fullOpacity!==0)return e=!1,e;return e}_hasCompositeBlendMode(){for(let e of this.view.allLayerViews.items)if((lu(e)||am(e))&&j3(o_[e.layer.blendMode]))return!0;return!1}_layerClassFromLayerView(e){return bM(e)?Ue.ELEVATION:Ue.MAP}_registerTiledLayerView(e){let t=[];if((lu(e)||am(e))&&t.push(S(()=>e.layer.blendMode,()=>{this.hasCompositeBlendMode=this._hasCompositeBlendMode(),this._updateTileTextures(di.UNFADED)})),!am(e)){let i=this._layerClassFromLayerView(e);t.push(S(()=>e.suspended,()=>this._updateTiledLayers())),t.push(S(()=>e.fullOpacity,()=>this._updateTileTextures(di.UNFADED))),t.push(S(()=>"effectiveScaleRange"in e.layer?e.layer.effectiveScaleRange:null,()=>this._restartAllAgents(i))),t.push(e.on("data-changed",()=>{let r=this._getLayerIdxByUID(i,e.uid);r!=null&&this._invalidateLayerData(r,i)}))}this._unregisterTiledLayerView(e.uid),this._basemapLayerViewHandles.set(e.uid,t)}_unregisterTiledLayerView(e){let t=this._basemapLayerViewHandles.get(e);if(t){for(let i of t)i.remove();this._basemapLayerViewHandles.delete(e)}}_updateTiledLayers(){if(!this.tilingScheme||this.view.suspended)return;let e=this.view.allLayerViews,t=[[],[]],i=null;e.forEach(r=>{if(!r.layer||r.suspended||!r_(r)||!r.fullExtent)return;let n=this._layerClassFromLayerView(r);if(n===Ue.MAP){let s=r.displayLevelRange.maxLevel;s!==1/0&&(i===null||s>i)&&(i=s)}t[n].push(r)});for(let r of ad){let n=this._layerViews[r],s=t[r];s.reverse();let o=s.length,a=n.length!==o,l=new Array(o),c=new Array(n.length);this._layerIndexByUid[r].clear();for(let h=0;h<o;h++){let p=s[h].uid;this._layerIndexByUid[r].set(p,h);let m=n.indexOf(s[h]);l[h]=m,h!==m&&(a=!0),m>-1&&(c[m]=h)}if(a){let h=this._postorderIterator;for(h.reset(this._rootTiles);!h.done;)h.next().modifyLayers(c,l,r);this._layerViews[r]=s,this._restartAllAgents(r),this._updateTilesVisibility(this._rootTiles)}}this.tilingScheme.ensureMaxLod(i)&&(this._viewChangeUpdate(),this.notifyChange("tilingScheme"))}_restartAllAgents(e){let t=this._postorderIterator;for(t.reset(this._rootTiles);!t.done;){let i=t.next();i.restartAgents(e),e===Ue.ELEVATION&&i.computeElevationBounds()}this._updateRootTileElevationBounds()}layerViewByIndex(e,t){return this._layerViews[t][e]}numLayers(e){return this._layerViews[e].length}_updateTileTextures(e){this._allTiles.forAll(t=>{t.updateAgents(Ue.MAP),e===di.IMMEDIATE?this.renderer.updateTileTexture(t,we.TEXTURE_NOFADING):t.updateRenderData(Ue.MAP,e)}),this._evaluateTransparency()}_invalidateLayerData(e,t){this._allTiles.forAll(i=>i.removeLayerAgent(e,t)),this._allTiles.forAll(i=>i.invalidateLayerData(e,t))}setTileTreeDirty(){this._allTilesDirty=!0}requestRender(e=Pe.UPDATE){this.renderer.setNeedsRender(e)}requestUpdate(){++this._pendingUpdates==1&&(this._hasPendingUpdates=!0)}requestTileData(e,t,i,r){let n=this.layerViewByIndex(t,i),s=n.layer;return!s.tilemapCache||om(n)?this._requestTileData(e,i,n,r):(++this._asyncWorkItems,s.tilemapCache.fetchAvailability(e.level,e.lij[1],e.lij[2],be(ie({},r),{timeout:6e3})).then(()=>--this._asyncWorkItems).catch(o=>{throw--this._asyncWorkItems,Ht(r),qr(o)||this._dataMissing(e,i,n),o}).then(()=>this._frameTask.schedule(()=>this._requestTileData(e,i,n,r),r.signal)))}_requestTileData(e,t,i,r){if(this._destroying)return Promise.resolve();let n=t===Ue.ELEVATION;return r.requester??=n?this._elevationDataRequester:this._mapDataRequester,n?bM(i)?this._requestElevationTileData(e,i,r):Promise.reject():CM(i)?this._requestMapTileData(e,i,r):Promise.reject()}_requestElevationTileData(e,t,i){++this._asyncWorkItems;let r=s=>{!Fl(i)&&s&&(this.setMemoryDirty(),this.requestUpdate(),this._elevationDataArrived(e,t,s))},n=s=>{qr(s)||(W.getLogger(this).error(`Tile ${e.lij.toString()} layer ${Ue.ELEVATION}/${t.uid} error ${s}`),this._dataMissing(e,Ue.ELEVATION,t),this.requestUpdate())};return t.fetchTile(e.lij,i).then(s=>this._frameTask.schedule(()=>r(s)),n).finally(()=>--this._asyncWorkItems)}_elevationDataArrived(e,t,i){let r=this._layerIndexByUid[Ue.ELEVATION].get(t.uid);if(r==null)return void W.getLogger(this).warn("TerrainSurface: received data from unknown layer %d %s",Ue.ELEVATION,e.lij.toString());let n=new vD(e.lij,e.extent,i);e.dataArrived(r,Ue.ELEVATION,n);let s=[e],o=e.level,a=this._iteratorPool.acquire();for(a.reset(s);!a.done;){let l=a.next();l.findElevationBoundsForLayer(r,o),l.computeElevationBounds()}o===0&&this._updateRootTileElevationBounds(),a.remove(),this._updateTilesVisibility(s)}_requestMapTileData(e,t,i){++this._asyncWorkItems;let r=(a,l)=>{cu(l),Fl(i)||(console.error(`Tile ${e.lij.toString()} layer ${Ue.MAP}/${t.uid} error ${a}`),this._dataMissing(e,Ue.MAP,t),this.requestUpdate())},n=a=>l=>r(l,a),s=a=>this._frameTask.schedule(()=>{this.requestUpdate(),Fl(i)?cu(a):this._mapTileDataArrived(e,t,a)},i.signal,n(a)).catch(n(a)),o=(a,l=null)=>this._frameTask.schedule(()=>r(a,l));return t.fetchTile(e.lij,i).then(s,o).finally(()=>--this._asyncWorkItems)}_mapTileDataArrived(e,t,i){let r=this._getLayerIdxByUID(Ue.MAP,t.uid);if(r==null)return cu(i),void W.getLogger(this).warn("TerrainSurface: received data from unknown layer");e.dataArrived(r,Ue.MAP,i)}_getLayerIdxByUID(e,t){return this._layerIndexByUid[e].get(t)}_dataMissing(e,t,i){let r=this._getLayerIdxByUID(t,i.uid);r!=null?e.dataMissing(r,t):W.getLogger(this).warn("TerrainSurface: received data from unknown layer")}get performanceInfo(){let e=this._performanceInfo;return e.numNodes=this._allTiles.length,e.numLeaves=e.numVisible=e.numRendered=e.numLoadedPerLevel.length=e.numRenderedPerLevel.length=0,this._allTiles.forAll(t=>{t.leaf&&e.numLeaves++;let i=t.level;t.renderData&&(e.numLoadedPerLevel[i]=(e.numLoadedPerLevel[i]||0)+1),t.visible&&(e.numVisible++,t.rendered&&(e.numRenderedPerLevel[i]=(e.numRenderedPerLevel[i]||0)+1,e.numRendered++))}),e}setMemoryDirty(){this._usedMemory=null}get usedMemory(){return this.tilingScheme?(this._usedMemory==null&&(this._usedMemory=this._recalculateUsedMemory()),this._usedMemory??0):0}_recalculateUsedMemory(){return this.tilingScheme?Math.round(this._allTiles.reduce((e,t)=>e+t.usedMemory,0)):null}getUsedMemoryForLayerView(e){let t=0,i=this._layerClassFromLayerView(e),r=this._getLayerIdxByUID(i,e.uid);return r!=null&&this._allTiles.forAll(n=>t+=n.getUsedMemoryForLayer(i,r)),t}get renderPatchBorders(){return this._renderer.renderPatchBorders}set renderPatchBorders(e){this._renderer.renderPatchBorders=e}get visualizeNormals(){return this._renderer.visualizeNormals}set visualizeNormals(e){this._renderer.visualizeNormals=e}get renderingDisabled(){return this._renderer.renderingDisabled}set renderingDisabled(e){this._renderer.renderingDisabled=e}get test(){}checkAllTilesWaterproofness(){if(!i_)return;let e=this._rootTiles;if(e==null)return;let t=s=>s?.renderData?.geometry?.indices?.length>0,i=(s,o)=>{t(s)&&console.error("Tile[",s.lij,"] has geometry although parent[",o.lij,"] has geom")},r=s=>{if(s.intersectsClippingArea)if(s.renderData&&!s.renderData.geometryState&&console.error("Tile[",s.lij,"] has renderData but not geometryState"),s.renderData&&!s.renderData.geometry&&console.error("Tile[",s.lij,"] has renderData but not geometryInfo"),!s.renderData?.geometry||(s.renderData.geometry.indices?.length??0)>0||console.error("Tile[",s.lij,"] has renderData but no indices - geometryInfo: ",s.renderData.geometry),t(s)){s.checkGeometryWaterproofness();for(let o of s.children)i(o,s)}else if(s.leaf)console.error("Tile[",s.lij,"] has no geometry and no children, from root to leaf");else for(let o of s.children)r(o)},n=s=>{let o=s.parent?.visible??!0,a=s.visible;s.computeVisibility();let l=s.visible;if(a!==l&&o&&console.error(" Tile[",s.lij,"] has out of date visibility: ",a," instead of ",l),!s.leaf)for(let c of s.children)n(c)};for(let s of e)r(s),n(s)}get isGlobal(){return this._isGlobal}get isGeographic(){return this._isGeographic}get isWebMercator(){return this._isWebMercator}get isWebMercatorOnPlateCarree(){return this._isWebMercatorOnPlateCarree}isEastEndWrap(e){return this._isGlobal&&e[2]===this.lijEastEnd(e[0])-1}isWestEndWrap(e){return this._isGlobal&&e[2]===0}lijEastEnd(e){return 1<<e+(this._isGeographic?1:0)}wrapEastWest(e){let t=this.lijEastEnd(e[0]),i=e[2];if(0<=i&&i<t)return e;if(!this._isGlobal)return null;let r=(i+(i<0?t:0))%t;return[e[0],e[1],r]}enableInternalChecks(e){h3(e)}enableWaterproofnessChecks(e){d3(e)}};nt._tileMemcacheKey="TerrainTileMemcache",u([d()],nt.prototype,"_renderer",void 0),u([d({constructOnly:!0})],nt.prototype,"_scaleRangeQueries",void 0),u([d({constructOnly:!0})],nt.prototype,"view",void 0),u([d({constructOnly:!0})],nt.prototype,"overlayManager",void 0),u([d()],nt.prototype,"_hasPendingUpdates",void 0),u([d()],nt.prototype,"_asyncWorkItems",void 0),u([d()],nt.prototype,"_allTilesDirty",void 0),u([d()],nt.prototype,"_allTilesSorted",void 0),u([d()],nt.prototype,"_viewChanged",void 0),u([d({type:Number})],nt.prototype,"heading",void 0),u([d()],nt.prototype,"_splitLimits",void 0),u([d({readOnly:!0})],nt.prototype,"_watchUpdatingTracking",void 0),u([d()],nt.prototype,"_frameTask",void 0),u([d({readOnly:!0})],nt.prototype,"snapLevel",null),u([d({readOnly:!0})],nt.prototype,"lodSnappingEnabled",null),u([d()],nt.prototype,"_userClippingExtent",null),u([d()],nt.prototype,"_rootTilesExtent",void 0),u([d({readOnly:!0})],nt.prototype,"extent",null),u([d({readOnly:!0})],nt.prototype,"groundExtent",null),u([d({readOnly:!0})],nt.prototype,"_tilingSchemeExtent",null),u([d({readOnly:!0})],nt.prototype,"updating",null),u([d({readOnly:!0})],nt.prototype,"running",null),u([d(o3)],nt.prototype,"updatingProgress",void 0),u([d({readOnly:!0})],nt.prototype,"updatingProgressValue",null),u([d()],nt.prototype,"_maxNumUpdating",void 0),u([d()],nt.prototype,"baseOpacity",null),u([d()],nt.prototype,"hasCompositeBlendMode",void 0),u([d({readOnly:!0})],nt.prototype,"viewingMode",null),u([d()],nt.prototype,"maxTextureScale",void 0),u([d({readOnly:!0})],nt.prototype,"ready",null),u([d({value:s_.FRONT_TO_BACK})],nt.prototype,"renderOrder",null),u([d({readOnly:!0})],nt.prototype,"rootTiles",null),u([d()],nt.prototype,"_rootTiles",void 0),u([d({readOnly:!0})],nt.prototype,"spatialReference",null),u([d({type:_n})],nt.prototype,"backgroundColor",null),u([d({value:!1})],nt.prototype,"slicePlaneEnabled",null),u([d({readOnly:!0})],nt.prototype,"tilingScheme",void 0),u([d({readOnly:!0})],nt.prototype,"tilingSchemeLocked",null),u([d({readOnly:!0})],nt.prototype,"tilingSchemeLogic",void 0),u([d()],nt.prototype,"wireframe",null),u([d({value:!1})],nt.prototype,"suspended",null),u([d()],nt.prototype,"fadeDuration",null),u([d()],nt.prototype,"visibleElevationBounds",void 0),u([d()],nt.prototype,"rootTileElevationBounds",void 0),u([d()],nt.prototype,"_layerViewsDirty",void 0),u([d()],nt.prototype,"renderPatchBorders",null),u([d()],nt.prototype,"visualizeNormals",null),u([d()],nt.prototype,"renderingDisabled",null),nt=YD=u([C("esri.views.3d.terrain.TerrainSurface")],nt);var $8=nt,hv=w(),ig=cr(),wie=Yt();new Nt;var $O=new LV("ground"),QD={spatialReference:null,extent:null,scale:0};function q8(e,t,i){for(let r of e){if(!r.containsPointXY(t,i))continue;let n=r;for(;n&&!n.renderData;){let o=(t>n.extentMidX?1:0)+(i<n.extentMidY?2:0);n=n.children[o]}let s=n?.renderData?.geometryState.samplerData??null;return gi(t,i,s)}return null}var QO=class{constructor(t){this.capacity=t,this._head=0,this._tail=0,this._data=new Array(t)}push(t){let i=this._tail;if(!(i<this.capacity))throw new Error("Queue full");this._data[i]=t,this._tail=i+1}pushAll(t){let i=t.length;if(i===0)return;let r=this._tail;if(!(r+i<=this.capacity))throw new Error("Queue full");for(let n=0;n<i;++n)this._data[r+n]=t[n];this._tail=r+i}pop(){let t=this._head;if(t<this._tail){let i=this._data[t];return this._head=t+1,i}}get empty(){return this._head>=this._tail}get full(){return this._tail>=this._data.length}};function ZO(e,t){!e.leaf||e.level<Gi||KO(e,i=>{t&&Z8(i);let r=YO(i);if(i.maxLevelDeltaNeighborCount++,r){let n=i.parent;for(;n;){let s=YO(n);if(n.unmergableChildCount++,!s)break;n=n.parent}}})}function Z8(e){if(e.hasPendingUpdate(we.SPLIT))return;let t=e.parent;for(;t?.resetPendingUpdate(we.MERGE);)t=t.parent;e.resetPendingUpdate(we.MERGE),e.leaf&&e.setPendingUpdate(we.SPLIT),e.level<Gi||KO(e,i=>{Z8(i)})}function W8(e){e.level<Gi||KO(e,t=>{if(t.maxLevelDeltaNeighborCount--,t.maxLevelDeltaNeighborCount===0&&t.unmergableChildCount===0){let i=t.parent;for(;i&&(i.unmergableChildCount--,YO(i));)i=i.parent}})}function YO(e){return e.maxLevelDeltaNeighborCount===0&&e.unmergableChildCount===0}function KO(e,t){if(e.level<Gi)return;let i=e.level-Gi,r=e.lij[1]>>Gi,n=e.lij[2]>>Gi,s=o=>o.leaf||o.level===i;for(let o=0;o<4;++o){let a=e.findNeighborTile(Bn[o],s);if(!a||a.level!==i)continue;let l=a.lij;l[1]===r&&l[2]===n||t(a)}}var XO=class{constructor(t,i,r,n){this.operation=t,this.geometry=i,this.states=r,this.sync=n}},pv=class extends P{constructor(e){super(e),this._residentGeomRecords=new Map,this._dirtyGeomRecords=new Map,this._dirtyRecordCount=0}get dirty(){return this._dirtyRecordCount>0}commitLayer(e,t){let i=this._dirtyGeomRecords.get(e);if(!i)return;let r=0;i.forEach((n,s)=>{let o=this._ensureGeomRecord(e,s);r+=n.size,n.forEach(({geometry:a,operation:l,states:c},h)=>{let p=!1;if(l===zi.UPDATE){let m=o.get(h);if(m){if(c&Za.TRANSFORMATION){let f=this.model.getObject(s);this.model.updateRenderGeometryTransformation(f,a,m)&&(p=!0)}p||t.updates.push({renderGeometry:m,updateType:c})}else en(!1,"ModelDirtySet.commitLayer: invalid update")}if(l===zi.REMOVE||p){let m=o.get(h);m?(t.removes.push(m),o.delete(h)):l===zi.REMOVE&&en(!1,"ModelDirtySet.commitLayer: invalid remove")}if(l===zi.ADD||p){let m=this.model.getObject(s);if(m!=null){let f=this.model.getRenderGeometry(m,a);t.adds.push(f),o.set(h,f)}}}),o.size===0&&this._residentGeomRecords.get(e).delete(s)}),this._residentGeomRecords.get(e).size===0&&this._residentGeomRecords.delete(e),this._dirtyGeomRecords.delete(e),this._dirtyRecordCount-=r}commitSyncUpdates(e,t){let i=this._dirtyGeomRecords.get(e);i&&i.forEach((r,n)=>{let s=this._ensureGeomRecord(e,n);r.forEach(({geometry:o,operation:a,states:l,sync:c},h)=>{let p=!1;if(a===zi.UPDATE&&c){let m=s.get(h);if(m){if(l&Za.TRANSFORMATION){let f=this.model.getObject(n);this.model.updateRenderGeometryTransformation(f,o,m)&&(p=!0)}p||t.updates.push({renderGeometry:m,updateType:l})}else en(!1,"ModelDirtySet.commitSyncUpdates: invalid update")}})})}getResidentRenderGeometries(e,t){let i=this._residentGeomRecords.get(e);i&&i.forEach(r=>r.forEach(n=>t.push(n)))}_objectStateChanged(e,t){for(let i of t.geometries)this._updateOrCreateDirtyRecord(t,i,null,zi.UPDATE,e)}visibilityChanged(e){this._objectStateChanged(Za.VISIBILITY,e)}highlightChanged(e){this._objectStateChanged(Za.HIGHLIGHT,e)}occlusionChanged(e){this._objectStateChanged(Za.OCCLUDEE,e)}attributesChanged({object:e,geometry:t,sync:i}){this._updateOrCreateDirtyRecord(e,t,null,zi.UPDATE,Za.GEOMETRY,i)}layerAdded(e){e.objects.forAll(t=>this._layerObjectAdded(e,t))}layerRemoved(e){e.objects.forAll(t=>this._layerObjectRemoved(e,t))}layerObjectAdded(e){this._layerObjectAdded(e.layer,e.object)}_layerObjectAdded(e,t){let i=e.id;for(let r of t.geometries)this._geometryAdded(t,r,i)}layerObjectRemoved(e){this._layerObjectRemoved(e.layer,e.object)}layerObjectsAdded(e){for(let t of e.objects)this._layerObjectAdded(e.layer,t)}layerObjectsRemoved(e){for(let t of e.objects)this._layerObjectRemoved(e.layer,t)}_layerObjectRemoved(e,t){let i=e.id;for(let r of t.geometries)this._geometryRemoved(t,r,i)}transformationChanged(e){let t=this._getParentLayerId(e),i=e.id;this._ensureGeomRecord(t,i).forEach(r=>{this._updateOrCreateDirtyRecord(e,r.geometry,t,zi.UPDATE,Za.TRANSFORMATION)})}shaderTransformationChanged(e){let t=this._getParentLayerId(e),i=e.id;this._ensureGeomRecord(t,i).forEach(r=>{r.objectShaderTransformationChanged(e.shaderTransformation)})}geometryAdded(e){this._geometryAdded(e.object,e.geometry)}_geometryAdded(e,t,i=null){this._updateOrCreateDirtyRecord(e,t,i,zi.ADD)}geometryRemoved(e){this._geometryRemoved(e.object,e.geometry)}_geometryRemoved(e,t,i=null){this._updateOrCreateDirtyRecord(e,t,i,zi.REMOVE)}_updateOrCreateDirtyRecord(e,t,i,r,n=Za.NONE,s=!1){i=i??this._getParentLayerId(e);let o=e.id,a=t.id,l=this._ensureDirtyRecord(i,o),c=l.get(a);if(c){let h=c.operation;h===zi.REMOVE&&r===zi.ADD&&c.states!==Za.NONE?c.operation=zi.UPDATE:h===zi.REMOVE&&r===zi.ADD||h===zi.ADD&&r===zi.REMOVE?(l.delete(a),this._dirtyRecordCount--):h!==zi.UPDATE||r!==zi.REMOVE&&r!==zi.UPDATE?(en((h===zi.REMOVE||h===zi.ADD)&&r===zi.UPDATE,"ModelDirtySet.objectGeometryAdded: inconsistent state"),c.states|=n):(c.operation=r,c.states|=n),c.sync=c.sync||s}else l.set(a,new XO(r,t,n,s)),this._dirtyRecordCount++}_ensureGeomRecord(e,t){let i=this._residentGeomRecords.get(e);i||(i=new Map,this._residentGeomRecords.set(e,i));let r=i.get(t);return r||(r=new Map,i.set(t,r)),r}_ensureDirtyRecord(e,t){let i=this._dirtyGeomRecords.get(e);i||(i=new Map,this._dirtyGeomRecords.set(e,i));let r=i.get(t);return r||(r=new Map,i.set(t,r)),r}_getParentLayerId(e){return e.parentLayer?e.parentLayer.id:i2}formatDebugInfo(){let e=["ADD","UPD",void 0,"REM"],t="";return this._dirtyGeomRecords.forEach((i,r)=>{i.forEach((n,s)=>{t.length>0&&(t+=`
`),t+=r+"."+s;let o=[];n.forEach(a=>{let l=a.operation;o[l]||(o[l]=[]),o[l].push(a.geometry.id)});for(let a=0;a<o.length;a++)if(o[a]){t+=" "+e[a-1]+": ";for(let l=0;l<o[a].length;l++)t+=o[a][l]+", "}})}),t}get test(){}};u([d()],pv.prototype,"_dirtyRecordCount",void 0),u([d({constructOnly:!0})],pv.prototype,"model",void 0),pv=u([C("esri.views.3d.webgl-engine.lib.ModelDirtySet")],pv);var Q8=pv;var mv=class extends P{constructor(){super(...arguments),this.dirtySet=new Q8({model:this}),this._content=new Map,this._originFactory=new MV(null)}getObject(e){return this._content.get(e)}add(e){let t=e.id;en(!this._content.has(t),"Model/Stage already contains object to be added"),this._content.set(t,e),em(e)&&this.dirtySet.layerAdded(e)}remove(e){return!!this._content.has(e.id)&&(this._content.delete(e.id),em(e)&&this.dirtySet.layerRemoved(e),!0)}addMany(e){for(let t of e)t&&(en(!this._content.has(t.id),"Model/Stage already contains object to be added"),this._content.set(t.id,t))}removeMany(e){for(let t of e)t&&(en(this._content.has(t.id),"Model/Stage doesn't contain object to be removed"),this._content.delete(t.id))}has(e){return this._content.has(e.id)}forEachOfType(e,t){this._content.forEach(i=>{i.type===e&&t(i)})}getRenderGeometry(e,t){let i=new RV(t,{castShadow:e.castShadow,objectShaderTransformation:e.shaderTransformation});i.transformation=e.getCombinedStaticTransformation(t,Y8);let{localOrigin:r}=t;return i.localOrigin=r??this._originFactory.getOrigin(i.boundingSphere),i}updateRenderGeometryTransformation(e,t,i){if(e==null)return!1;i.transformation=e.getCombinedStaticTransformation(t,Y8);let r=this._originFactory.getOrigin(i.boundingSphere);return i.localOrigin!==r}getStats(){let e={},t=Array.from(this._content.values());for(let i=0;i<Q0.COUNT;++i)e[i]=t.filter(r=>r.type===i).length;return{contentTypes:e,dirtySet:this.dirtySet.formatDebugInfo()}}get test(){}};u([d({constructOnly:!0})],mv.prototype,"dirtySet",void 0),mv=u([C("esri.views.3d.webgl-engine.parts.Model")],mv);var Y8=Wt();var KD=class extends Vw{constructor(){super(...arguments),this.innerFadeDistance=0,this.altitudeFade=0,this.backgroundColor=w()}},rg=class extends ft{constructor(t,i){super(t,i,new mt(eH,()=>import("./chunk-CGCSPPRE.js")))}initializePipeline(t){return Tt({blending:t.reduced?Wp:qp(ei.SRC_ALPHA,ei.ONE_MINUS_SRC_ALPHA),depthTest:{func:t.reduced?Ei.ALWAYS:Ei.LEQUAL},colorWrite:St})}};var fv=class extends iu{constructor(){super(...arguments),this.reduced=!1}};u([$t()],fv.prototype,"reduced",void 0);var An=class extends ss{constructor(){super(...arguments),this.produces="disabled",this.consumes={required:[Oe.OPAQUE_ENVIRONMENT]}}_enable(){this.produces=Oe.OPAQUE_ENVIRONMENT,this.requestRender(Pe.UPDATE)}_disable(){this.produces="disabled",this.requestRender(Pe.UPDATE)}};u([d()],An.prototype,"produces",void 0),u([d()],An.prototype,"consumes",void 0),An=u([C("esri.views.3d.webgl-engine.effects.OpaqueEnvironment")],An);var gv=class extends ft{constructor(t,i){super(t,i,new mt(iH,()=>import("./chunk-WS2JARHK.js")))}initializePipeline(){return Tt({blending:qp(ei.SRC_ALPHA,ei.ONE_MINUS_SRC_ALPHA),depthTest:{func:Ei.ALWAYS},colorWrite:St})}};var XD=class extends An{constructor(){super(...arguments),this.requireGeometryDepth=!0,this._compositingPassParameters=new tH,this._vao=null,this._passParameters=new KD,this._configuration=new fv}initialize(){this.techniques.precompile(rg,this._configuration),this.techniques.precompile(gv),this._configuration.reduced=!0,this.techniques.precompile(rg,this._configuration),this._configuration.reduced=!1,this.addHandles([S(()=>this.view.environment.background,e=>{let t=e instanceof VT?kp(e.color):gn;Te(this._passParameters.backgroundColor,t[0]*t[3],t[1]*t[3],t[2]*t[3])},Ce),S(()=>this.view._stage?.renderer?.fullResolutionAtmosphere,e=>this._configuration.reduced=!e,Ce),S(()=>this.view.environment.atmosphereEnabled,e=>e?this._enable():this._disable(),Ce)])}destroy(){this._vao=We(this._vao)}render(e){let t=e.find(({name:g})=>g===Oe.OPAQUE_ENVIRONMENT);if(!this.bindParameters.mainDepth)return t;let i=this.renderingContext;this._vao??=yn(i,uu.Pos2Tex);let r=t.getAttachment(i.gl.DEPTH_STENCIL_ATTACHMENT);this._update();let n=this.techniques.get(rg,this._configuration);if(!n.compiled)return this.requestRender(Pe.UPDATE),t;if(!this._configuration.reduced)return t.detachDepth(),i.bindFramebuffer(t.fbo),i.bindTechnique(n,this.bindParameters,this._passParameters),i.bindVAO(this._vao),i.drawArrays(Jt.TRIANGLE_STRIP,0,4),t.attachDepth(r),t;let s=this.techniques.get(gv);if(!s.compiled)return this.requestRender(Pe.UPDATE),t;let o=i.getViewport(),a=this.bindParameters.camera,l=xe(a.eye)-pn.radius,c,h=pn.atmosphereHeight;if(l<h){let g=Math.min(1,Math.max(0,l/h));c=Xe(.2,.3,g)}else{let g=Math.min(1,Math.max(0,(l-h)/(15*h)));c=Xe(.3,.6,g)}let p=tu(Math.round(c*a.fullViewport[2])),m=tu(Math.round(c*a.fullViewport[3]));i.setViewport(0,0,p,m);let f=this.fboCache.acquire(p,m,"chapman",Pi.RGBA);return i.bindFramebuffer(f.fbo),i.clearFramebuffer([0,0,0,1],!0,!0),i.bindTechnique(n,this.bindParameters,this._passParameters),i.bindVAO(this._vao),i.drawArrays(Jt.TRIANGLE_STRIP,0,4),i.setViewport(o.x,o.y,o.width,o.height),this._compositingPassParameters.color=f.getTexture(),t.detachDepth(),i.bindFramebuffer(t.fbo),i.bindTechnique(s,this.bindParameters,this._compositingPassParameters),i.screen.draw(),t.attachDepth(r),f.release(),t}_update(){let e=this.bindParameters.camera,t=Ir(e.eye),i=Math.sqrt(t),r=t-this._passParameters.radii[1]**2,n=q((i-this._passParameters.radii[0])/pn.atmosphereHeight,0,1);ho(this._passParameters.heightParameters,i,t,r,n);let s=this.view.basemapTerrain?.getLowerBoundRadius()??0;es(this._passParameters.radii,s,s+pn.atmosphereHeight),this._passParameters.innerFadeDistance=2*Math.sqrt((2*s-NM)*NM),this._passParameters.altitudeFade=pm(i-s)}};XD=u([C("esri.views.3d.environment.ChapmanAtmosphere")],XD);var _v=class extends ft{constructor(t,i){super(t,i,new mt(rH,()=>import("./chunk-JEMG7YVG.js")))}initializePipeline(){return Tt({blending:za(ei.ONE,ei.ZERO,ei.SRC_ALPHA,ei.ONE),depthTest:{func:Ei.LEQUAL},colorWrite:St})}};var JD=class extends An{constructor(e){super(e),this._planetRadius=_t(e.view.spatialReference).radius}initialize(){this.techniques.precompile(_v),this.addHandles([S(()=>this.view.environment.weather!=null&&this.view.environment.atmosphereEnabled,e=>e?this._enable():this._disable(),Re)])}destroy(){this._vao=We(this._vao)}render(e){let t=e.find(({name:o})=>o===Oe.OPAQUE_ENVIRONMENT),i=this.bindParameters.clouds;if(!i.data)return t;let r=this.techniques.get(_v);if(!r.compiled)return this.requestRender(Pe.UPDATE),t;let n=this.renderingContext;this._vao??=yn(n);let s=n.bindTechnique(r,this.bindParameters);return n.bindVAO(this._vao),s.assertCompatibleVertexAttributeLocations(this._vao),n.drawArrays(Jt.TRIANGLE_STRIP,0,4),i.isFading&&this.requestRender(Pe.UPDATE),t}};JD=u([C("esri.views.3d.environment.CloudsComposition")],JD);var yv=class extends ft{constructor(t,i){super(t,i,new mt(sH,()=>import("./chunk-EYIEWMFL.js")))}initializePipeline(){return Tt({blending:za(ei.SRC_ALPHA,ei.ZERO,ei.ONE_MINUS_SRC_ALPHA,ei.ONE),colorWrite:St})}};var np=class extends An{constructor(){super(...arguments),this.consumes={required:[Oe.TRANSPARENT_ENVIRONMENT]}}_enable(){this.produces=Oe.TRANSPARENT_ENVIRONMENT,this.requestRender(Pe.UPDATE)}};u([d()],np.prototype,"consumes",void 0),np=u([C("esri.views.3d.webgl-engine.effects.TransparentEnvironment")],np);var bie=.95,Cie=1,e1=class extends np{constructor(e){super(e),this.requireGeometryDepth=!0,this._newParameters=new vv,this._oldParameters=new vv,this._fadedParameters=new vv,this._parameters=this._newParameters,this._passParameters=new nH;let t=_t(e.view.spatialReference);this._planetRadius=t.radius,this._atmosphereRadius=t.radius+t.atmosphereHeight,e.view._stage.renderView.techniques.precompile(yv)}toogle(){this.view.environment.atmosphereEnabled&&this.view.environment.weather?this._enable():this._disable()}initialize(){this.addHandles([S(()=>this.view.environment.atmosphereEnabled,()=>this.toogle(),Ce),S(()=>this.view.environment.weather,()=>this.toogle(),Ce),S(()=>this._updateFogParameters(),()=>{},Ce)]),this.addHandles(S(()=>this._fadeFactor,e=>this._fade(e),Ce))}get _fadeFactor(){return this.view._stage?.renderer.renderContext.bind.clouds.fadeFactor??1}_fade(e){let{_newParameters:t,_oldParameters:i}=this;e>=1?(this._parameters=t,this._oldParameters.copyFrom(this._newParameters)):e<=0?this._parameters=i:(this._fadedParameters.lerp(i,t,e),this._parameters=this._fadedParameters)}_updateFogParameters(){let e=this.view.environment.weather,t=e.type==="foggy"||e.type==="snowy"||e.type==="rainy";this._newParameters.strength=e.type==="foggy"?Xe(3e-5,.005,e.fogStrength**3):e.type==="snowy"||e.type==="rainy"?Xe(4e-6,2e-4,(e.precipitation??0)**3):0,this._newParameters.amount=t?1:0,e.type!=="foggy"&&e.type!=="snowy"||ee(this._newParameters.color,Eie),e.type==="rainy"&&ee(this._newParameters.color,Tie),this._fadeFactor>=1&&this._oldParameters.copyFrom(this._newParameters),this.requestRender(Pe.UPDATE)}render(e){let t=e.find(({name:s})=>s===Oe.TRANSPARENT_ENVIRONMENT);if(this._parameters.amount===0||(this._update(),this._passParameters.amount<=0))return t;let i=this.techniques.get(yv);if(!i.compiled)return this.requestRender(Pe.UPDATE),t;let r=this.renderingContext,n=t.getAttachment(r.gl.DEPTH_STENCIL_ATTACHMENT);return t.attachDepth(null),r.bindFramebuffer(t.fbo),r.bindTechnique(i,this.bindParameters,this._passParameters),r.screen.draw(),t.attachDepth(n),t}_update(){let e=this.bindParameters.camera;ne(K8,e.eye);let t=Math.max(0,ae(K8,this.bindParameters.lighting.mainLight.direction)),i=this._parameters.color;X(X8,i,.1),ni(this._passParameters.color,X8,i,t);let r=xe(e.eye);this._passParameters.atmosphereC=r**2-this._atmosphereRadius**2,this._passParameters.amount=(1-Vl(bie*Xg,Cie*Xg,Math.abs(r-this._planetRadius)))*this._parameters.amount,this._passParameters.strength=this._parameters.strength}};e1=u([C("esri.views.3d.environment.Fog")],e1);var vv=class{constructor(){this.color=w(),this.strength=0,this.amount=0}copyFrom(t){this.amount=t.amount,this.strength=t.strength,ee(this.color,t.color)}lerp(t,i,r){this.amount=Xe(t.amount,i.amount,r),this.strength=Xe(t.strength,i.strength,r),ni(this.color,t.color,i.color,r)}},K8=w(),X8=w(),Tie=yt(.5,.5,.5),Eie=yt(1.5,1.5,1.5);var Pl=class extends ft{constructor(t,i){super(t,i,new mt(oH,()=>import("./chunk-BOLHIQHB.js")))}initializePipeline(t){let i=t.geometry===pu.Cylinder;return Tt({blending:Ga,culling:i?Z0:void 0,depthTest:{func:Ei.LEQUAL},colorWrite:St})}};var J8=new Uint8ClampedArray([0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,2,0,0,0,2,0,0,0,2,0,0,0,2,0,0,0,2,0,0,0,2,0,0,0,3,0,0,0,3,0,0,0,3,0,0,0,3,0,0,0,3,0,0,0,4,0,0,0,4,0,0,0,4,0,0,0,4,0,0,0,4,0,0,0,4,0,0,0,5,0,0,0,5,0,0,0,5,0,0,0,5,0,0,0,5,0,0,0,6,0,0,0,6,0,0,0,6,0,0,0,6,0,0,0,6,0,0,0,7,0,0,0,7,0,0,0,7,0,0,0,7,0,0,0,7,0,0,0,8,0,0,0,8,0,0,0,8,0,0,0,8,0,0,0,8,0,0,0,9,0,0,0,9,0,0,0,9,0,0,0,9,0,0,0,9,0,0,0,10,0,0,0,10,0,0,0,10,0,0,0,10,0,0,0,11,0,0,0,11,0,0,0,11,0,0,0,11,0,0,0,11,0,0,0,12,0,0,0,12,0,0,0,12,0,0,0,12,0,0,0,13,0,0,0,13,0,0,0,13,0,0,0,13,0,0,0,14,0,0,0,14,0,0,0,14,0,0,0,14,0,0,0,15,0,0,0,15,0,0,0,15,0,0,0,15,0,0,0,15,16,0,0,16,16,0,0,16,16,0,0,16,16,0,0,16,15,0,0,17,15,0,0,17,15,0,0,17,15,0,0,17,14,0,0,18,14,0,0,18,14,0,0,18,13,0,0,19,13,0,0,19,13,0,0,19,13,0,0,19,13,0,0,20,13,0,0,20,13,0,0,20,13,0,0,20,12,0,0,21,12,0,0,21,12,0,0,21,12,0,0,21,12,0,0,22,12,0,0,22,12,0,0,22,12,0,0,22,11,0,0,23,11,0,0,23,11,0,0,23,11,0,0,24,11,0,0,24,11,0,0,24,11,0,0,24,10,0,0,25,10,0,0,25,10,0,0,25,10,0,0,26,10,0,0,26,10,0,0,26,10,0,0,26,9,0,0,27,9,0,0,27,9,0,0,27,18,0,0,28,18,0,0,28,18,0,0,28,18,0,0,28,18,0,0,29,18,0,0,29,18,0,0,29,17,0,0,30,17,0,0,30,17,0,0,30,17,0,0,30,16,0,0,31,16,0,0,31,16,0,0,31,16,0,0,32,16,0,0,32,16,0,0,32,15,0,0,33,15,0,0,33,15,0,0,33,15,0,0,34,15,8,0,34,15,8,0,34,15,8,0,34,15,7,0,35,15,7,0,35,15,7,0,35,21,7,0,36,21,7,0,36,21,7,0,36,21,7,0,37,21,7,0,37,21,7,0,37,20,7,0,38,20,7,0,38,20,7,0,38,20,7,0,39,20,7,0,39,20,7,0,39,20,7,0,39,19,6,0,40,19,6,0,40,19,6,0,40,19,6,0,41,19,6,0,41,19,6,0,41,18,6,0,42,18,6,0,42,18,6,0,42,24,6,0,43,24,6,0,43,24,6,0,43,23,6,0,44,23,6,0,44,23,6,0,44,23,6,0,45,23,6,0,45,23,6,0,45,22,6,0,46,22,6,0,46,22,6,0,46,22,5,0,47,22,5,0,47,22,5,0,47,21,5,0,48,21,5,0,48,21,5,0,48,21,5,0,49,21,5,0,49,26,5,0,49,25,5,0,50,25,5,0,50,25,5,0,50,25,5,0,51,25,5,0,51,25,5,0,51,25,5,0,52,25,5,0,52,25,5,0,52,24,5,0,53,24,5,0,53,24,5,0,53,24,9,0,54,28,9,0,54,28,9,0,54,28,9,0,55,28,9,0,55,27,9,0,56,27,9,0,56,27,9,0,56,27,9,4,57,27,9,4,57,27,9,4,57,26,9,4,58,26,9,4,58,26,9,4,58,26,9,4,59,26,9,4,59,26,9,4,59,26,8,4,60,30,8,4,60,30,8,4,60,29,8,4,61,29,8,4,61,29,8,4,62,29,8,4,62,29,8,4,62,28,8,4,63,28,8,4,63,28,8,4,63,28,12,4,64,28,12,4,64,28,12,4,64,27,12,4,65,27,12,8,65,27,12,8,65,31,12,8,66,31,12,8,66,30,11,8,67,30,11,8,67,30,11,8,67,30,11,8,68,30,11,8,68,30,11,8,68,30,15,7,69,30,15,7,69,30,15,7,69,33,15,11,70,33,15,11,70,32,14,11,71,32,14,11,71,32,14,11,71,32,18,14,72,32,18,14,72,32,18,14,72,31,17,14,73,35,17,14,73,34,17,17,74,34,21,17,74,34,21,17,74,34,20,17,75,34,20,20,75,34,20,20,75,34,23,20,76,34,23,20,76,36,23,23,77,36,23,23,77,36,23,23,77,36,23,23,78,36,26,26,78,36,26,26,78,36,26,26,79,36,26,29,79,38,26,29,80,38,29,29,80,38,29,29,80,38,28,31,81,38,28,31,81,38,31,31,81,37,31,34,82,37,31,34,82,37,31,37,83,40,34,37,83,40,34,37,83,39,33,39,84,39,33,39,84,39,36,42,84,39,36,42,85,39,36,42,85,39,36,42,85,39,39,44,86,39,39,44,86,41,38,47,87,41,41,47,87,41,41,50,87,41,41,49,88,41,41,52,88,40,43,52,89,43,43,52,89,43,43,54,89,42,45,54,90,42,45,57,90,42,45,57,90,42,45,59,91,42,48,59,91,44,47,61,92,44,47,61,92,44,50,61,92,44,49,63,93,44,49,63,93,44,52,66,93,43,52,65,94,46,54,68,94,46,54,70,95,46,54,70,95,46,54,70,95,45,56,72,96,45,56,72,96,45,58,74,97,47,58,76,97,47,58,76,97,47,60,78,98,47,60,78,98,47,60,81,98,49,62,80,99,49,62,82,99,48,61,84,100,48,64,84,100,48,64,84,100,50,63,86,101,50,66,86,101,50,66,88,101,50,65,90,102,52,67,89,103,51,69,91,104,51,68,92,105,52,69,93,107,52,71,94,108,54,70,96,109,53,71,96,111,52,73,98,112,54,72,98,114,53,73,100,115,54,72,100,117,54,73,102,118,55,74,104,120,55,76,105,121,56,77,106,123,56,76,107,124,57,79,107,126,58,78,110,128,57,79,111,129,56,80,113,131,58,79,112,132,57,82,114,134,58,81,116,136,60,82,117,137,59,83,117,139,60,83,119,141,59,84,120,142,60,85,122,144,59,86,122,146,60,86,126,148,62,87,127,149,61,88,127,151,62,88,128,153,63,89,130,155,62,90,131,156,63,90,132,158,64,91,134,160,65,91,135,162,64,92,136,163,63,93,138,165,66,95,139,167,65,95,140,169,66,95,142,171,67,96,142,172,66,97,144,174,67,99,145,176,67,97,148,178,67,99,147,180,68,100,149,181,68,100,150,183,69,101,152,185,70,102,153,187,71,103,155,188,70,103,156,190,70,104,157,192,71,105,158,194,71,106,160,195,72,106,161,197,72,108,161,199,73,108,163,200,73,109,164,202,74,109,165,204,74,110,167,206,75,111,168,207,74,112,170,209,75,112,170,210,76,113,171,212,76,114,173,214,77,115,174,215,78,115,175,217,78,116,175,218,78,117,177,220,78,118,178,221,79,118,180,223,80,120,180,224,81,120,181,226,81,120,182,227,82,121,184,229,82,122,185,230,84,123,186,232,83,123,187,233,84,124,189,234,84,125,188,235,85,126,189,237,86,126,190,238,86,127,191,239,87,127,192,240,87,129,193,242,88,129,194,243,89,130,195,244,90,131,196,245,90,132,197,246,91,132,197,247,92,133,198,248,92,134,199,249,93,135,200,250,94,136,201,251,95,137,202,252,96,138,203,253,97,140,204,254,98,141,205,254,99,142,206,255,101,143,207,255,102,144,208,255,103,146,209,255,104,147,209,255,106,148,210,255,107,149,211,255,108,151,212,255,110,152,213,255,111,153,213,255,112,154,214,255,114,156,215,255,115,157,215,255,117,158,216,255,118,160,217,255,120,161,217,255,121,162,218,255,123,164,218,255,124,165,219,255,125,166,219,255,127,167,220,255,129,169,220,255,130,170,221,255,132,171,221,255,133,173,222,255,134,174,222,255,136,175,223,255,139,178,224,255,142,180,224,255,144,182,225,255,147,185,226,255,150,187,226,255,153,189,227,255,155,191,228,255,158,194,228,255,160,196,229,255,163,198,229,255,165,200,230,255,168,202,231,255,170,203,231,255,172,205,232,255,174,207,232,255,176,209,233,255,178,210,234,255,180,212,234,255,182,214,235,255,184,215,236,255,186,217,237,255,188,219,238,255,190,220,238,255,192,221,239,255,193,222,240,255,194,224,240,255,196,225,241,255,197,226,241,255,198,226,242,255,199,227,242,255,200,228,242,255,201,228,243,255,202,229,243,255,203,230,243,255,204,230,244,255,205,231,244,255,207,232,244,255,208,233,245,255,209,233,245,255,211,234,246,255,213,235,246,255,217,238,247,255,222,240,248,255,226,242,249,255,231,245,250,255,236,247,251,255,241,249,252,255,245,251,253,255,249,252,254,255,255,255,255,255]);var t1=class extends An{constructor(){super(...arguments),this._configuration=new Hw,this._passParameters=new Bw,this._vao=null,this._vaoCount=0}initialize(){this._configuration.geometry=pu.Cylinder,this.addHandles([S(()=>this.view.environment.atmosphereEnabled,e=>e?this._enable():this._disable(),Re)])}destroy(){this._passParameters.texture=We(this._passParameters.texture),this._vao=We(this._vao)}precompile(){this.techniques.precompile(Pl,this._configuration)}render(e){let t=e.find(({name:s})=>s===Oe.OPAQUE_ENVIRONMENT),i=this.techniques.get(Pl,this._configuration);if(!i.compiled)return this.requestRender(Pe.UPDATE),t;let r=this.renderingContext;if(this._vao||(this._vao=Die(r),this._vaoCount=sa(this._vao,"geometry")),!this._passParameters.texture){let s=new vi;s.wrapMode=ji.CLAMP_TO_EDGE,s.flipped=!0,s.width=1,s.height=512,this._passParameters.texture=new Di(r,s,J8)}let n=r.bindTechnique(i,this.bindParameters,this._passParameters);return xie(e6,this.bindParameters.camera.viewMatrix),n.setUniformMatrix4fv("view",e6),r.bindVAO(this._vao),n.assertCompatibleVertexAttributeLocations(this._vao),r.drawArrays(Jt.TRIANGLES,0,this._vaoCount),t}};function Die(e){let t=pk(1,2,!1),{data:i,indices:r}=t[0][1],n=t6.createBuffer(r.length),s=n.position;for(let o=0;o<r.length;++o){let a=3*r[o%3==0?o+2:o%3==2?o-2:o];s.set(o,0,i[a]),s.set(o,1,i[a+1]),s.set(o,2,i[a+2])}return new ns(e,ja,new Map([["geometry",is(t6)]]),new Map([["geometry",vr.createVertex(e,tn.STATIC_DRAW,n.buffer)]]))}function xie(e,t){Sp(e,t),e[12]=0,e[13]=0,e[14]=0,e[15]=1}t1=u([C("esri.views.3d.environment.LocalAtmosphere")],t1);var e6=Wt(),t6=Ps().vec3f(yi.POSITION);var i6=new Uint8ClampedArray([0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,2,0,0,0,2,0,0,0,2,0,0,0,2,0,0,0,3,0,0,0,3,0,0,0,3,0,0,0,4,0,0,0,4,0,0,0,4,0,0,0,5,0,0,0,5,0,0,0,5,0,0,0,5,0,0,0,5,0,0,0,5,0,0,0,5,0,0,0,6,0,0,0,6,0,0,0,7,0,0,0,7,0,0,0,7,0,0,0,8,0,0,0,8,0,0,0,8,0,0,0,9,0,0,0,9,0,0,0,9,0,0,0,10,0,0,0,10,0,0,0,11,0,0,0,11,0,0,0,11,0,0,0,12,0,0,0,12,0,0,0,12,0,0,0,13,0,0,0,13,0,0,0,14,0,0,0,14,0,0,0,14,0,0,0,14,0,0,0,14,0,0,0,15,0,0,0,15,0,0,0,16,0,0,0,16,0,0,0,16,0,0,0,17,0,0,0,17,0,0,0,18,0,0,0,18,0,0,0,19,0,0,0,19,0,0,0,19,0,0,0,20,0,0,0,20,0,0,0,21,0,0,0,21,0,0,0,22,0,0,0,22,11,0,0,23,11,0,0,23,11,0,0,23,11,0,0,23,11,0,0,24,11,0,0,24,11,0,0,24,10,0,0,25,10,0,0,25,10,0,0,26,10,0,0,26,9,0,0,27,9,0,0,27,9,0,0,28,9,0,0,28,9,0,0,29,9,0,0,29,8,0,0,30,8,0,0,30,8,0,0,31,8,0,0,31,8,0,0,32,8,0,0,32,8,0,0,32,8,0,0,32,8,0,0,33,8,0,0,33,8,0,0,34,7,0,0,35,7,0,0,35,7,0,0,36,7,0,0,36,7,7,0,37,7,7,0,37,7,7,0,38,7,7,0,38,13,7,0,39,13,7,0,39,13,6,0,40,13,6,0,40,12,6,0,41,12,6,0,41,12,6,0,41,12,6,0,42,12,6,0,42,12,6,0,43,12,6,0,43,12,6,0,44,12,6,0,44,11,6,0,45,11,6,6,45,11,6,6,46,11,5,5,47,11,5,5,47,11,5,5,48,11,5,5,48,10,5,5,49,10,5,5,49,10,5,5,50,15,5,5,51,15,5,5,51,15,5,5,51,15,5,5,51,15,5,5,52,15,5,5,52,14,5,5,53,14,5,5,54,14,5,5,54,14,5,5,55,14,5,5,55,14,5,5,56,13,4,4,57,13,4,4,57,13,4,4,58,13,4,4,58,13,4,4,59,13,4,4,59,17,4,4,60,17,4,4,60,17,4,4,60,17,4,4,61,17,4,4,61,16,4,4,62,16,4,4,63,16,4,4,63,16,8,4,64,16,8,4,64,16,8,4,65,15,8,4,66,15,8,4,66,15,8,4,67,19,8,4,68,19,8,4,68,18,7,4,69,18,7,4,69,18,7,4,69,18,7,4,70,18,7,4,70,18,7,4,71,18,7,4,71,18,7,4,72,17,7,3,73,17,7,3,73,21,7,3,74,21,7,3,74,20,7,3,75,20,7,3,76,20,7,3,76,20,7,3,77,20,7,3,77,20,7,3,78,20,7,3,78,20,7,7,78,19,6,6,79,19,10,6,80,19,10,6,80,22,9,6,81,22,9,6,81,22,9,6,82,22,9,6,83,22,9,6,83,21,9,6,84,21,9,6,84,21,9,6,85,21,9,6,86,21,9,6,86,23,9,6,87,23,9,6,87,23,9,6,87,23,9,6,88,23,9,6,88,23,9,6,89,23,8,6,90,23,8,6,90,22,8,6,91,22,8,6,91,25,8,6,92,25,8,5,93,25,8,5,93,24,8,5,94,24,8,5,94,24,11,5,95,24,11,5,96,24,11,5,96,26,11,5,97,26,11,5,97,26,11,5,97,26,10,5,98,26,10,5,98,26,10,5,99,25,10,5,100,25,10,5,100,25,10,5,101,25,10,5,101,25,10,5,102,27,10,5,103,27,10,5,103,27,10,5,104,27,10,5,104,27,12,5,105,26,12,5,106,26,12,5,106,29,12,5,106,29,12,5,106,29,12,7,107,28,12,7,108,28,12,7,108,28,12,7,109,28,12,7,109,30,12,7,110,30,11,7,111,30,11,7,111,30,11,7,112,30,11,7,112,29,11,7,113,29,11,7,114,29,11,7,114,31,11,7,115,31,11,7,115,31,11,7,115,31,11,7,116,31,11,7,116,33,13,7,117,33,13,9,117,32,13,9,118,32,13,9,118,32,13,9,119,34,15,8,120,34,15,8,120,34,15,8,121,36,15,8,121,36,15,8,122,36,15,8,122,35,15,8,123,37,14,8,124,37,14,8,124,37,14,8,124,37,14,8,124,39,14,8,125,39,16,8,125,38,16,8,126,38,16,8,127,38,16,8,127,40,16,10,128,40,16,10,128,40,16,10,129,42,18,10,129,41,18,10,130,41,18,10,130,43,18,10,131,43,18,10,131,42,17,10,132,42,17,12,132,42,17,12,133,44,17,12,133,44,17,12,133,46,17,11,134,46,17,11,134,45,19,11,135,45,19,11,135,47,19,11,136,47,19,11,136,47,19,11,137,47,19,11,137,48,20,11,138,48,20,11,138,50,20,13,139,50,20,13,139,49,20,13,140,49,22,13,140,51,22,13,141,51,22,13,141,50,22,13,142,52,22,13,142,52,21,12,143,53,21,12,143,53,21,12,143,53,21,12,143,53,21,14,144,53,23,14,144,55,23,14,145,55,23,14,145,56,23,14,146,56,23,14,146,57,24,14,147,57,24,14,147,59,24,16,148,59,24,16,148,58,24,15,149,58,26,15,149,58,26,15,149,60,26,15,150,60,26,15,150,61,25,15,151,61,25,15,151,62,25,17,152,62,25,17,152,64,25,17,152,64,27,17,152,63,27,17,153,63,27,17,153,65,27,17,153,66,28,17,154,66,28,17,154,67,28,16,155,67,28,16,155,67,30,16,155,69,29,18,156,69,29,18,156,68,29,18,157,70,29,18,157,70,29,18,157,71,31,18,158,71,31,18,158,72,30,19,159,72,30,19,159,74,30,19,159,73,30,19,160,73,32,19,160,74,32,19,161,74,32,21,161,76,32,21,161,78,33,21,161,78,33,21,161,79,35,20,162,78,34,20,163,79,34,22,164,81,36,22,164,82,36,22,165,81,35,22,166,82,37,21,167,84,37,21,167,85,36,21,168,86,38,23,169,88,38,23,169,88,38,23,170,88,39,23,170,89,39,24,171,91,40,24,171,92,40,24,172,93,40,24,173,94,41,25,173,95,41,25,174,96,42,25,175,98,42,25,175,99,43,26,176,99,43,26,177,101,45,26,177,102,44,26,178,103,46,27,179,104,46,27,179,105,46,27,179,106,45,28,180,108,47,28,180,108,46,28,181,109,48,28,182,111,48,29,182,111,49,29,183,114,49,29,184,114,50,30,184,114,50,30,185,116,51,30,185,117,51,30,186,119,52,31,187,119,53,31,187,121,53,31,188,122,54,33,188,123,54,32,189,124,55,32,189,125,55,32,189,126,56,34,190,128,56,34,190,128,57,33,191,130,57,33,191,131,58,35,192,131,58,35,192,133,59,34,193,134,60,35,194,135,60,35,194,136,61,37,195,139,61,37,195,139,62,36,196,141,62,36,196,141,63,38,197,142,63,38,197,143,64,39,198,144,64,39,198,146,66,39,198,146,67,39,198,147,67,38,199,147,68,40,199,149,68,40,200,150,69,40,200,152,70,41,201,154,71,41,201,154,71,42,202,155,72,42,202,156,73,41,203,157,73,43,203,158,74,42,204,160,75,44,204,161,76,44,204,162,77,44,205,164,77,45,205,165,78,45,206,166,79,45,206,168,80,46,207,169,81,46,207,170,83,47,207,171,83,47,207,172,83,47,207,174,85,48,208,175,85,48,208,177,85,48,209,178,87,49,209,180,87,49,210,181,87,49,210,182,89,50,210,182,89,50,211,185,91,50,211,186,91,51,212,186,93,51,212,189,94,52,212,190,95,51,213,192,96,51,213,193,96,53,213,194,97,52,214,195,98,54,214,197,98,55,215,198,100,55,215,199,101,55,215,200,102,55,216,202,103,55,216,203,104,55,216,204,105,57,216,205,106,57,216,207,107,58,216,208,108,58,217,209,109,59,217,210,110,60,217,211,111,60,218,212,112,61,218,213,113,61,218,214,114,62,219,217,115,63,219,217,116,64,219,218,118,64,220,219,119,65,220,220,121,66,220,222,121,67,221,222,122,67,221,222,123,68,221,223,124,69,222,224,125,70,222,225,127,71,222,226,128,72,223,228,129,73,223,228,130,74,223,229,132,75,223,230,135,79,224,231,138,81,224,233,141,84,224,233,144,87,225,235,147,91,225,236,150,94,225,237,154,97,225,238,158,102,225,239,161,107,225,239,165,110,225,240,168,114,226,241,172,118,226,241,176,122,226,241,181,126,226,242,183,130,227,243,186,135,227,243,190,139,227,244,194,143,227,244,197,147,228,244,200,150,228,245,204,154,228,245,207,157,228,245,210,161,229,246,212,164,229,246,215,167,229,246,217,169,229,246,220,172,230,247,221,174,230]);var i1=128,r6=-1e4,n6=0,JO=50,Mie=()=>1-511/512,Sie=Hp([[50,.1015625],[500,.21875],[5e3,1-250/512],[5e4,.4140625]]),tN=class extends An{constructor(e){super(e),this._passParameters=new Bw,this._configuration=new Hw,this._vao=null,this._vaoCount=0,this._fadeVao=null,this._fadeVaoCount=0,this._texV1=1;let t=e.view,i=_t(t.spatialReference),{outerAtmosphereRimWidth:r,radius:n}=i;this._planetRadius=n,this._innerRimFactor=1+r6/n,this._middleRimFactor=1+n6/n,this._outerRimFactor=1+r/n,this._texV0=n6/r,this._texVScale=this._texV1-this._texV0;let s=t._stage.renderView.techniques;s.precompile(Pl,this._configuration),this._configuration.geometry=pu.Underground,s.precompile(Pl,this._configuration)}initialize(){this.addHandles(S(()=>this.view.environment.atmosphereEnabled,e=>e?this._enable():this._disable(),Re))}destroy(){this._passParameters.texture=We(this._passParameters.texture),this._fadeVao=We(this._fadeVao),this._vao=We(this._vao)}render(e){let t=e.find(({name:r})=>r===Oe.OPAQUE_ENVIRONMENT);this._update();let i=this.renderingContext;if(!this._passParameters.texture){let r=new vi;r.wrapMode=ji.CLAMP_TO_EDGE,r.flipped=!0,r.width=1,r.height=512,this._passParameters.texture=new Di(i,r,i6)}if(this._passParameters.undergroundFadeAlpha<1){this._vao||(this._vao=this._createRibbon(i),this._vaoCount=sa(this._vao,"geometry")),this._configuration.geometry=pu.Cone;let r=this.techniques.get(Pl,this._configuration);if(!r.compiled)return this.requestRender(Pe.UPDATE),t;i.bindTechnique(r,this.bindParameters,this._passParameters),i.bindVAO(this._vao),i.drawArrays(Jt.TRIANGLES,0,this._vaoCount)}if(this._passParameters.undergroundFadeAlpha>0){this._fadeVao||(this._fadeVao=yn(i),this._fadeVaoCount=sa(this._fadeVao,"geometry")),this._configuration.geometry=pu.Underground;let r=this.techniques.get(Pl,this._configuration);if(!r.compiled)return this.requestRender(Pe.UPDATE),t;i.bindTechnique(r,this.bindParameters,this._passParameters),i.bindVAO(this._fadeVao),i.drawArrays(Jt.TRIANGLE_STRIP,0,this._fadeVaoCount)}return t}_update(){let e=this.bindParameters.camera,t=w(),i=this._planetRadius,r=xe(e.eye),n=r-i;if(n<0){let m=Math.min(-n/5e3,1);this._passParameters.undergroundFadeAlpha=m}else this._passParameters.undergroundFadeAlpha=0;let s=Math.max(JO,n),o=i+r6;this._passParameters.innerScale=Iie(i+s,i,o)-1,this._passParameters.altitudeFade=pm(n),X(t,e.eye,(i+JO)/r),s6(t,e.center,e.up,i,this._passParameters.silhouette);let a=this._computeScreenRimWidth(e,t,e.up,this._passParameters.silhouette),l=Mie(),c=Sie(n),h=this._texV0+l*this._texVScale,p=this._texV0+a*c*this._texVScale;if(n>JO){s6(e.eye,e.center,e.up,i,this._passParameters.silhouette);let m=this._computeScreenRimWidth(e,e.eye,e.up,this._passParameters.silhouette),f=q((m-1.5)/(a-1.5),0,1);h=this._texV0+f*l*this._texVScale,p=this._texV0+Xe(this._texV1,a*c,f)*this._texVScale}es(this._passParameters.texV,h,p)}_createRibbon(e){let t=S0(3+3*i1*3),i=new Uint32Array(3*i1*5);t[0]=0,t[1]=0,t[2]=-1;for(let s=0;s<i1;s++){let o=9*s+3;t[o]=s,t[o+1]=this._innerRimFactor,t[o+2]=-1,t[o+3]=s,t[o+4]=this._middleRimFactor,t[o+5]=0,t[o+6]=s,t[o+7]=this._outerRimFactor,t[o+8]=1;let a=3*s+1,l=s===i1-1?1:a+3,c=15*s;i[c]=a,i[c+1]=a+1,i[c+2]=l+1,i[c+3]=l+1,i[c+4]=l,i[c+5]=a,i[c+6]=a+1,i[c+7]=a+2,i[c+8]=l+2,i[c+9]=l+2,i[c+10]=l+1,i[c+11]=a+1,i[c+12]=a,i[c+13]=l,i[c+14]=0}let r=o6.createBuffer(i.length),n=r.position;for(let s=0;s<i.length;++s){let o=3*i[s];n.set(s,0,t[o]),n.set(s,1,t[o+1]),n.set(s,2,t[o+2])}return new ns(e,ja,new Map([["geometry",is(o6)]]),new Map([["geometry",vr.createVertex(e,tn.STATIC_DRAW,r.buffer)]]))}_computeScreenRimWidth(e,t,i,r){return he(ng,r.center,r.v2),X(r1,ng,this._outerRimFactor),$2(eN,t,ng,i),Gx(ng,eN,e.projectionMatrix,e.viewport,ng),Gx(r1,eN,e.projectionMatrix,e.viewport,r1),ui(ng,r1)/e.height}};function s6(e,t,i,r,n){let s=xe(e),o=r*Math.sqrt(s*s-r*r)/s,a=Math.sqrt(r*r-o*o),l=n.v1,c=n.v2;return X(n.center,e,a/s),At(l,e,t),Ir(l)<1&&At(l,e,i),X(l,l,o/xe(l)),At(c,l,e),X(c,c,o/xe(c)),o}tN=u([C("esri.views.3d.environment.MarsAtmosphere")],tN);var eN=Wt(),ng=w(),r1=w();function Iie(e,t,i){return e*e/(Math.sqrt(e*e-t*t)*Math.sqrt(e*e-i*i)+t*i)}var o6=Ps().vec3f(yi.POSITION),a6=tN;var n1=class{constructor(t){this._totalCount=t,this._componentCountCache=-1,this._indexRanges=[0,t]}allVisible(){return this.componentCount===this._totalCount}allInvisible(){return this._indexRanges.length===0}isVisible(t){if(t<0||t>=this._totalCount)return!1;if(this.allVisible())return!0;{let i=this._indexRanges,r=0,n=i.length/2;if(t<i[2*r]||t>i[2*n]+i[2*n+1])return!1;for(;n-r>0;){let s=Math.floor(.5*(r+n)),o=i[2*s];if(t<o){if(n-r==1)return!1;n=s;continue}if(t<o+i[2*s+1])return!0;if(n-r==1)return!1;r=s+1}return!1}}get componentCount(){if(this._componentCountCache===-1){let t=this._indexRanges,i=0;for(let r=0;r<t.length;r+=2)i+=t[r+1];this._componentCountCache=i}return this._componentCountCache}reset(t){t==="all"||t.length===this._totalCount?this._indexRanges=[0,this._totalCount]:this._indexRanges=Aie(t),this._componentCountCache=-1}forEachComponent(t){let i=this._indexRanges;for(let r=0;r<i.length;r+=2){let n=i[r],s=n+i[r+1];for(let o=n;o<s;o++)if(!t(o))return!1}return!0}forEachComponentRange(t){let i=this._indexRanges;for(let r=0;r<i.length;r+=2){let n=i[r];if(!t(n,n+i[r+1]))return!1}return!0}computeOffsetRanges(t){let i=new Array(this._indexRanges.length),r=this._indexRanges;for(let n=0;n<r.length;n+=2){let s=r[n],o=s+r[n+1],a=t[s],l=t[o];i[n]=a,i[n+1]=l-a}return i}};function Aie(e){let t=new Array;if(e.length===0)return t;let i=e[0],r=1;for(let n=1;n<e.length;n++){let s=e[n];i+r===s?r+=1:(t.push(i),t.push(r),i=s,r=1)}return t.push(i),t.push(r),t}var s1=class{constructor(t,i){this.offsets=i,this._highlightsInOrder=[],this.pickability=null,this.componentHighlights=new Map,this.verticalOffsets=null,this.cachedGeometryRanges=null,this.cachedHighlightRangesMap=null,this.cachedShadowmapRanges=null;let r=this.count;this.visibility=new n1(r),this.materialDataBuffer=t.getBuffer(r),this.materialDataIndices=new Uint16Array(r);for(let n=0;n<r;n++)this.materialDataIndices[n]=this.materialDataBuffer.acquireIndex()}destroy(){for(let t=0;t<this.count;t++)this.materialDataBuffer.releaseIndex(this.materialDataIndices[t])}get count(){return this.offsets.length-1}get geometryRanges(){return this.cachedGeometryRanges==null&&(this.cachedGeometryRanges=this.visibility.computeOffsetRanges(this.offsets)),this.cachedGeometryRanges}get highlightRangesMap(){return this.componentHighlights.size===0?null:(this._updateCachedHighlightRanges(),this.cachedHighlightRangesMap)}get shadowmapRanges(){return this.componentHighlights.size===0?this.geometryRanges:(this._updateCachedHighlightRanges(),this.cachedShadowmapRanges)}markHighlightsDirty(){this.cachedHighlightRangesMap=null,this.cachedShadowmapRanges=null}markVisibilityDirty(){this.cachedGeometryRanges=null,this.markHighlightsDirty()}updateHighlights(t){this._updateHighlightOrder(t)&&(this.markHighlightsDirty(),this._updateCachedHighlightRanges())}_updateHighlightOrder(t){let{_highlightsInOrder:i}=this,r=i.length!==t.length;i.length=Math.min(t.length,8);for(let n=0;n<t.length;++n){let s=t.at(n).name;i.length<n?(r=!0,i.push(s)):i[n]!==s&&(i[n]=s,r=!0)}return r}_updateCachedHighlightRanges(){if(this.cachedHighlightRangesMap==null||this.cachedShadowmapRanges==null){let{highlightRangesMap:t,shadowmapRangesMap:i}=Rie(this.componentHighlights,this.visibility,this.offsets,this._highlightsInOrder);this.cachedHighlightRangesMap=t,this.cachedShadowmapRanges=i}}};function Rie(e,t,i,r){let n=new Map,s=[];if(e.size>0){let o=i.length;t.forEachComponent(a=>{let l=!1;for(let c=r.length-1;c>=0;--c){let h=r[c];if((e.get(h)?.[a]??0)>0){let m=_p(n,h,()=>[]),f=i[a],g=i[a+1];m.push(f),m.push(g-f),l||=h===Ld;break}}return l||(o!==a-1&&(s.length>0&&s.push(i[o+1]-s[s.length-1]),s.push(i[a])),o=a),!0}),s.length>0&&s.push(i[o+1]-s[s.length-1])}return{highlightRangesMap:n,shadowmapRangesMap:s}}var o1=class{constructor(t,i,r,n,s,o){this.transform=t,this.toMapSpace=i,this.obb=r,this.componentData=n,this.renderable=s,this.intersectionGeometry=o,this.visible=!1,this.offsetObb=null}destroy(){this.intersectionGeometry=G(this.intersectionGeometry),this.renderable=G(this.renderable),this.componentData=G(this.componentData)}};function l6(e,t,i,r,n,s,o){let a=s-o,l=t-e,c=new Float64Array(4*l);for(let h=0;h<l;++h){let p=3*(h+e),m=n*i[p+0],f=r[m+0],g=r[m+1],_=a/(r[m+2]-o),v=f*_,b=g*_,x=n*i[p+1],E=r[x+0],D=r[x+1],M=a/(r[x+2]-o),T=E*M,I=D*M,A=n*i[p+2],O=r[A+0],$=r[A+1],H=a/(r[A+2]-o),k=O*H,K=$*H,F=4*h;c[F+0]=Math.min(v,T,k),c[F+1]=Math.min(b,I,K),c[F+2]=Math.max(v,T,k),c[F+3]=Math.max(b,I,K)}return c}function c6(e,t,i,r,n){let s=t-e,o=new Float64Array(4*s);for(let a=0;a<s;++a){let l=3*(a+e),c=n*i[l+0],h=r[c+0],p=r[c+1],m=n*i[l+1],f=r[m+0],g=r[m+1],_=n*i[l+2],v=r[_+0],b=r[_+1],x=4*a;o[x+0]=Math.min(h,f,v),o[x+1]=Math.min(p,g,b),o[x+2]=Math.max(h,f,v),o[x+3]=Math.max(p,g,b)}return o}function u6(e,t){return new(Pie(e))(t)}function Pie(e){return e<128?Uint8Array:e<32768?Uint16Array:e<1<<31?Uint32Array:Array}var sg=class{constructor(t,i){this.elementCount=t,this.model=i,this._elementIndexMap=null,this._bspNodes=[],this._generatedBVH=!1,this.localMode=i.localMode,this.planetCenterZ=i.planetCenterZ,this.geometryMinZ=i.geometryMinZ,this.planetCenter=yt(0,0,this.planetCenterZ),this.maxBspNodeDepth=i.maxBspNodeDepth??8,this.minElementCountForBVH=i.minElementCountForBVH??15,this.minBspNodeElementCount=i.minBspNodeElementCount??5}get elementIndexMap(){return this._ensureBVH(),this._elementIndexMap}get _skipBVH(){return this.elementCount<this.minElementCountForBVH||this.geometryMinZ<.5*this.planetCenterZ}_ensureBVH(){this._generatedBVH||this._skipBVH||this._bspNodes.length===0&&this._generateBsp()}intersectRay(t,i,r){this.elementCount<1||(this._skipBVH?this._intersectRayWithoutBVH(r):this._intersectRayWithBVH(t,i,r))}_intersectRayWithoutBVH(t){this._intersectRange(0,this.elementCount)}_intersectRange(t,i){this.model.intersectRange(t,i)}_intersectRayWithBVH(t,i,r){this._ensureBVH(),r?this._intersectGeometryWithBVHVerticalRay(t):this._intersectGeometryWithBVHGeneralRay(t,i)}_intersectGeometryWithBVHVerticalRay(t){let i=t[0],r=t[1];if(!this.localMode){let{geometryMinZ:o,planetCenterZ:a}=this,l=(o-a)/(t[2]-a);i=t[0]*l,r=t[1]*l}let{_bspNodes:n}=this,s=0;for(;s>=0;){let o=n[s],{d:a,dim:l,minIndexIndex:c,minMidIndexIndex:h,maxMidIndexIndex:p,maxIndexIndex:m,aabb2D:f}=o;if(i<f[0]||i>f[2]||r<f[1]||r>f[3])break;if(l===-1||o.child0===-1&&o.child1===-1){this._intersectRange(c,m);break}{this._intersectRange(h,p);let g=(l===0?i:r)-a;if(g<0){if(o.child0===-1){this._intersectRange(c,h);break}s=o.child0}else{if(!(g>0))break;if(o.child1===-1){this._intersectRange(p,m);break}s=o.child1}}}}_intersectGeometryWithBVHGeneralRay(t,i){let r=t[0],n=t[1],s=i[0],o=i[1],{geometryMinZ:a}=this;if(!this.localMode){let g=0,_=1,v=Math.min(.5*this.planetCenterZ,a),b=t[2],x=i[2];if(b<v&&x<v||(b<v&&(g=(v-b)/(x-b)),x<v&&(_=(v-b)/(x-b)),g>_))return;let E=(1-g)*t[0]+g*i[0],D=(1-g)*t[1]+g*i[1],M=(1-g)*t[2]+g*i[2],T=(1-_)*t[0]+_*i[0],I=(1-_)*t[1]+_*i[1],A=(1-_)*t[2]+_*i[2],{planetCenterZ:O}=this,$=a-O,H=$/(M-O);r=E*H,n=D*H;let k=$/(A-O);s=T*k,o=I*k}let l=s-r,c=o-n,h=this._bspNodes,p=1;{let{aabb2D:g}=h[0],_=(x,E,D,M)=>{if(Math.abs(E)<1e-5*Math.max(M-D,1))return!1;let T=E>0,I=T?M:D,A=x+p*E;return(T?A<I:A>I)&&(p=Math.max((I-x)/E,p),!0)},v=()=>_(r,l,g[0],g[2]),b=()=>_(n,c,g[1],g[3]);Math.abs(l)>=Math.abs(c)?v()||b():b()||v()}let m=[0,0,p],f=0;for(;f<m.length;){let g=m[f],_=m[f+1],v=m[f+2];if(f+=3,_>v)continue;let b=h[g],{minIndexIndex:x,maxIndexIndex:E}=b,{child0:D,child1:M,minMidIndexIndex:T,maxMidIndexIndex:I,aabb2D:A,d:O,dim:$}=b;{let H=r+_*l,k=r+v*l,K=Math.min(H,k),F=Math.max(H,k),R=A[0],j=A[2];if(F<R||j<K)continue;if(K<R){let B=(R-r)/l;l>0?_=Math.max(_,B):v=Math.min(v,B)}if(j<F){let B=(j-r)/l;l>0?v=Math.min(v,B):_=Math.max(_,B)}}{let H=n+_*c,k=n+v*c,K=Math.min(H,k),F=Math.max(H,k),R=A[1],j=A[3];if(F<R||j<K)continue;if(K<R){let B=(R-n)/c;c>0?_=Math.max(_,B):v=Math.min(v,B)}if(j<F){let B=(j-n)/c;c>0?v=Math.min(v,B):_=Math.max(_,B)}}if(D===-1&&M===-1)this._intersectRange(x,E);else{let H=$===0?r:n,k=$===0?l:c,K=H+_*k,F=H+v*k,R=Math.min(K,F),j=Math.max(K,F),B=q((O-H)/k,0,p);x<T&&R<=O&&(D!==-1?(m.push(D),m.push(k>=0?_:Math.max(_,B)),m.push(k>=0?Math.min(v,B):v)):this._intersectRange(x,T)),this._intersectRange(T,I),I<E&&O<=j&&(M!==-1?(m.push(M),m.push(k>=0?Math.max(_,B):_),m.push(k>=0?v:Math.min(v,B))):this._intersectRange(I,E))}}}_generateBsp(){let{elementCount:t}=this;if(t<1)return;let i=u6(t,t);this._elementIndexMap=i;for(let f=0;f<t;++f)i[f]=f;let r=this.model.getAabbs2D(),n=0,s=this._bspNodes;s.length=0;let{localMode:o}=this,a=!1;if(!o){let{planetCenterZ:f,geometryMinZ:g}=this;a=f>=0||g<.5*f}let l=[],c=(f,g,_,v,b)=>{l.push(f),l.push(g),l.push(_),l.push(v<0?-1:(b?0:1)+2*v)},{maxBspNodeDepth:h,minBspNodeElementCount:p}=this,m=(f,g,_,v,b)=>{let x=s.length;if(x>0&&(a||_>=h||g-f<p))return;let E=[0,0,0,0];Fie(E,f,g,i,r);let{d:D,dim:M}=o?Oie(E):Nie(E),{rangeMidStart:T,rangeMidEnd:I}=Lie(f,g,M,D,i,r),A=_===h-1,O=!A&&T>=f+p,$=!A&&g>=I+p;if(O||$||x===0){let H=new iN(f,T,I,g,M,D,E);if(O&&c(f,T,_+1,x,!0),$&&c(I,g,_+1,x,!1),s.push(H),v!==-1){let k=s[v];b?k.child0=x:k.child1=x}}};for(c(0,t,0,-1,!1);n<l.length;){let f=l[n],g=l[n+1],_=l[n+2],v=l[n+3];n+=4;let b=v>>1;m(f,g,_,b,v-(b<<1)==0)}this._generatedBVH=!0}};function Oie(e){let t=e[0],i=e[1],r=e[2],n=e[3],s,o;return r-t>=n-i?(o=.5*(t+r),s=0):(o=.5*(i+n),s=1),{d:o,dim:s}}function Nie(e){let t=e[0],i=e[1],r=e[2],n=e[3],s,o;return r-t>=n-i?(s=0,o=.5*(t+r)):(s=1,o=.5*(i+n)),{dim:s,d:o}}function Lie(e,t,i,r,n,s){let o=e;{let h=t;for(;o<h;){let p=n[o];d6(p,i,r,s)<0?++o:(--h,n[o]=n[h],n[h]=p)}}let a=o,l=o,c=t;for(;l<c;){let h=n[c-1];d6(h,i,r,s)>0?--c:(n[c-1]=n[l],n[l]=h,++l)}return{rangeMidStart:a,rangeMidEnd:c}}function d6(e,t,i,r){let n=4*e,s=r[n+0+t];return r[n+2+t]<i?-1:s>i?1:0}function Fie(e,t,i,r,n){let s=1/0,o=1/0,a=-1/0,l=-1/0;for(let c=t;c<i;++c){let h=4*r[c];s=Math.min(s,n[h+0]),o=Math.min(o,n[h+1]),a=Math.max(a,n[h+2]),l=Math.max(l,n[h+3])}e[0]=s,e[1]=o,e[2]=a,e[3]=l}var iN=class{constructor(t,i,r,n,s,o,a){this.minIndexIndex=t,this.minMidIndexIndex=i,this.maxMidIndexIndex=r,this.maxIndexIndex=n,this.dim=s,this.d=o,this.aabb2D=a,this.child0=-1,this.child1=-1}};var a1=class{constructor(t,i,r,n,s,o,a,l,c){this.componentIndex=t,this.vertexData=i,this.vertexStride=r,this.indexData=n,this.startTriangleNumber=s,this.endTriangleNumber=o,this.geometryMinZ=a,this.planetCenterZ=l,this.localMode=c,this.maxBspNodeDepth=8,this.minElementCountForBVH=20,this.minBspNodeElementCount=10,this.rayDirection=w(),this.ray0=w(),this.isVerticalRay=!1,this._triangleHitCallback=h6,this.totalElevationOffset=0,this.normalRequired=!1,this._bvh=new sg(o-s,this)}getAabbs2D(){return this.localMode?c6(this.startTriangleNumber,this.endTriangleNumber,this.indexData,this.vertexData,this.vertexStride):l6(this.startTriangleNumber,this.endTriangleNumber,this.indexData,this.vertexData,this.vertexStride,this.geometryMinZ,this.planetCenterZ)}get numTriangles(){return this.endTriangleNumber-this.startTriangleNumber}intersectRay(t,i,r,n,s,o){ee(this.ray0,t),ai(this.rayDirection,i,t),this.isVerticalRay=r,this.totalElevationOffset=n,this.normalRequired=o,this._triangleHitCallback=s,this._bvh.intersectRay(t,i,r),this._triangleHitCallback=h6}intersectRange(t,i){let r=this._bvh.elementIndexMap;rN(this.ray0,this.rayDirection,t,i,this.indexData,this.vertexData,this.vertexStride,this.totalElevationOffset,this.planetCenterZ,this.normalRequired,this._triangleHitCallback,r,this.startTriangleNumber)}getTriangleElevationOffset(t){return this.totalElevationOffset}};function rN(e,t,i,r,n,s,o,a,l,c,h,p=null,m=0){a!==0?ak(e,t,i,r,n,s,o,a,l,c,h,p,m):K0(e,t,i,r,n,s,o,c,h,p,m)}function h6(){}function p6(e,t,i,r){if(i>=t)return e;e==null&&(e=kie());let n=e.isVisibleBit,s=e.data,o=m6(s),a=i/o|0,l=i-o*a,c=(t-1)/o|0,h=s,p=r===n;if(!(i<h.length*o)&&p){let m=a+1,f=Math.ceil(h.length*jN),g=c+1,_=Math.max(m,f);_=Math.min(_,g),s=new Uint32Array(_),s.set(h)}return a<s.length&&(s[a]=Hie(s[a],l,p)),e.data=s,e}function wv(e,t){if(e==null)return!0;let{isVisibleBit:i,data:r}=e,n=m6(r);return t<r.length*n?Vie(i,r,t,n):!e.isVisibleBit}function kie(e=!0){return{isVisibleBit:!e,data:new Uint32Array(0)}}function Vie(e,t,i,r){let n=i/r|0,s=i-n*r;return Bie(t[n],s)===e}function m6(e){return e.BYTES_PER_ELEMENT*8}function Hie(e,t,i){return e&~(1<<t)|(i?1:0)<<t}function Bie(e,t){return!!(e&1<<t)}var l1=class{constructor(t,i,r,n,s,o,a,l){this.vertexData=t,this.vertexStride=i,this.indexData=r,this._components=n,this._componentAabbs3D=s,this.geometryMinZ=o,this.planetCenterZ=a,this.localMode=l,this.maxBspNodeDepth=6,this.minElementCountForBVH=10,this.minBspNodeElementCount=3,this._ray0=Gie,this._ray1=qie,this._invDir=w(),this._componentVerticalOffsets=null,this._verticalOffset=null,this._tolerance=0,this._intersectionOptions=Wie,this._callback=f6,this.rayDirectionC=w(),this._componentIndexMap=null,this._bvh=new sg(n.count,this),this.componentIntersectionData=new Array(n.count)}get numComponents(){return this._components.count}get minZGlobal(){return this.geometryMinZ-this.planetCenterZ}getAabbs2D(){return this.localMode?this.getAabbs2DLocal():this.getAabbs2DGlobal()}getAabbs2DGlobal(){let{numComponents:t,planetCenterZ:i,minZGlobal:r}=this,n=new Float64Array(4*t),s=this._componentAabbs3D;for(let o=0;o<t;++o){let a=6*o,l=s[a+0],c=s[a+1],h=s[a+2],p=s[a+3],m=s[a+4],f=r/(h-i),g=r/(s[a+5]-i),_=Math.min(l*f,l*g),v=Math.min(c*f,c*g),b=Math.max(p*f,p*g),x=Math.max(m*f,m*g),E=4*o;n[E+0]=_,n[E+1]=v,n[E+2]=b,n[E+3]=x}return n}getAabbs2DLocal(){let{numComponents:t}=this,i=new Float64Array(4*t),r=this._componentAabbs3D;for(let n=0;n<t;++n){let s=6*n,o=r[s+0],a=r[s+1],l=r[s+3],c=r[s+4],h=4*n;i[h+0]=o,i[h+1]=a,i[h+2]=l,i[h+3]=c}return i}intersectRay(t,i,r,n,s,o,a){let{isVerticalRay:l}=a;this._ray0=t,this._ray1=i,this._componentVerticalOffsets=r,this._verticalOffset=n,this._tolerance=o,this._intersectionOptions=a,this._componentIndexMap=this._bvh.elementIndexMap,lk(t,i,this._invDir),this._callback=s,this._bvh.intersectRay(t,i,l),this._callback=f6}intersectRange(t,i){let r=this._componentIndexMap,n=this._components,s=n.pickability,o=n.visibility;for(let a=t;a<i;++a){let l=r?r[a]:a;wv(s,l)&&o.isVisible(l)&&this._intersectComponent(l)}}getComponentTriangleCount(t){let i=this._components.offsets,r=i[t]/3;return i[t+1]/3-r}getComponentAabb3D(t,i){let r=this._componentAabbs3D,n=6*t;return i[0]=r[n],i[1]=r[n+1],i[2]=r[n+2],i[3]=r[n+3],i[4]=r[n+4],i[5]=r[n+5],i}_intersectComponent(t){if(!wv(this._components.pickability,t))return;let i=this.getComponentAabb3D(t,Uie),r=!1,{localMode:n,_componentVerticalOffsets:s,_verticalOffset:o,_ray0:a,_ray1:l,_invDir:c,planetCenterZ:h,_tolerance:p,rayDirectionC:m,componentIntersectionData:f}=this,{isVerticalRay:g}=this._intersectionOptions,_=this._components.offsets,v=ee(jie,a),b=ee(zie,l),x=s?.[t]??0,E=x+(o?.offset??0);if(E!==0&&(n?(v[2]=a[2]-E,b[2]=l[2]-E,r=!0):o!=null&&(o.componentOffset=x)),o==null||r||E===0||o.applyToAabb(i),!ck(i,v,c,p))return;ai(m,b,v);let D=_[t]/3,M=_[t+1]/3,T=M-D,I=(K,F,R)=>{this._callback(K,F,t,R)},{vertexData:A,vertexStride:O,indexData:$,_intersectionOptions:H}=this,{normalRequired:k}=H;if(T>$ie){let K=f[t];K==null&&(K=new a1(t,A,O,$,D,M,this.geometryMinZ,h,n),f[t]=K),K.intersectRay(v,b,g,r?0:E,I,k)}else rN(v,m,D,M,$,A,O,r?0:E,h,k,I)}},Uie=jc(),jie=w(),zie=w(),Gie=w(),qie=w(),f6=()=>{},Wie=new Yp,$ie=40;var c1=class{constructor(t,i,r){this.viewingMode=t,this.positionData=i,this._components=r,this.verticalOffset=null,this.componentVerticalOffsets=null,this._planetCenter=w(),this._componentBvh=null,this._aabb=[0,0,0,0,0,0],this._indices=i.indices?M0(i.indices):IL(i.positions.length/3),this._positions=i.positions}destroy(){this._positions=null,this._indices=null,this._perComponentAabbs=null,this._componentBvh=null}getComponentAabb(t,i){let r=this._ensureComponentAabbs(),n=6*t;return i[0]=r[n],i[1]=r[n+1],i[2]=r[n+2],i[3]=r[n+3],i[4]=r[n+4],i[5]=r[n+5],i}getComponentAabbs(){return this._ensureComponentAabbs()}_ensureComponentAabbs(){return this._perComponentAabbs||(this._perComponentAabbs=this._computePerComponentAabbs()),this._perComponentAabbs}getComponentPositions(t,i){i.indices=this._indices,i.data=this._positions,i.stride=3,i.startIndex=this._components.offsets[t],i.endIndex=this._components.offsets[t+1]}intersect(t,i,r,n,s,o,a,l){this.verticalOffset=n,this.componentVerticalOffsets=s;let{position:c}=o,h=ai(Zie,t,c),p=ai(Qie,i,c),m=A0(Yie,o.rotationScale);ts(h,h,m),ts(p,p,m);let f=qc(Xie,m);if(this.viewingMode===Se.Global){let _=this._planetCenter;Rs(_,c),ts(_,_,m)}let g=(_,v,b,x)=>{l(b,_,x?ts(Kie,x,f):null,v)};this._intersectComponents(h,p,s,n,g,r,a)}_computePerComponentAabbs(){let t=this._aabb,i=.5*(t[0]+t[3]),r=.5*(t[1]+t[4]),n=.5*(t[2]+t[5]),s=this._components.count,o=S0(6*s),a=this._indices,l=this._positions,c=this._components.offsets,h=0,p=1/0,m=1/0,f=1/0,g=-1/0,_=-1/0,v=-1/0;for(let b=0;b<s;b++){let x=c[b],E=c[b+1],D=1/0,M=1/0,T=1/0,I=-1/0,A=-1/0,O=-1/0;if(x<E)for(let $=x;$<E;$++){let H=3*a[$],k=l[H],K=l[H+1],F=l[H+2];D=Math.min(D,k),M=Math.min(M,K),T=Math.min(T,F),I=Math.max(I,k),A=Math.max(A,K),O=Math.max(O,F)}else D=i,M=r,T=n,I=i,A=r,O=n;o[h++]=D,o[h++]=M,o[h++]=T,o[h++]=I,o[h++]=A,o[h++]=O,p=Math.min(p,D),m=Math.min(m,M),f=Math.min(f,T),g=Math.max(g,I),_=Math.max(_,A),v=Math.max(v,O)}return this._aabb[0]=p,this._aabb[1]=m,this._aabb[2]=f,this._aabb[3]=g,this._aabb[4]=_,this._aabb[5]=v,o}_intersectComponents(t,i,r,n,s,o,a){let l=this._componentBvh;l==null&&(l=new l1(this._positions,3,this._indices,this._components,this._ensureComponentAabbs(),this.geometryMinZ,this.planetCenterZ,this.localMode),this._componentBvh=l),l.intersectRay(t,i,r,n,s,o,a)}get geometryMinZ(){return this._aabb[2]}get planetCenterZ(){return this._planetCenter[2]}get numTriangles(){return this._indices.length/3}get localMode(){return this.viewingMode===Se.Local}get positions(){return this._positions}get indices(){return this._indices}get aabb(){return this._ensureComponentAabbs(),this._aabb}},Zie=w(),Qie=w(),Yie=Ln(),Kie=w(),Xie=Ln();var u1=class{constructor(t,i,r){this.material=t,this.geometry=i,this.meta=r}destroy(){this.material.dispose(),this.geometry.dispose()}};var d1=class{constructor(t,i,r,n){this.vao=t,this.primitiveType=i,this.parameters=r,this.indexed=n}dispose(){this.vao.dispose()}};function b6(e,t){let i=new Wr,{eye:r,frustum:n,viewForward:s}=e;t.forAll(o=>{let a=o.offsetObb!=null?o.offsetObb:o.obb,l=ae(ai(Ks,a.center,r),s),c=a.projectedRadius(s);if(i.within(l-c)&&i.within(l+c))return;let h=rre(a,n);if(h===-1)return;if(h===0)return Nc.far=l+c,Nc.near=l-c,void i.union(Nc);let p=h1.pushNew();p.near=l-c,p.far=l+c,p.mask=h,p.object=o});for(let o=0;o<h1.length;o++){let a=h1.data[o];if(i.within(a.near)&&i.within(a.far))continue;Nc.far=a.far,Nc.near=1/0,ire(a.object.offsetObb!=null?a.object.offsetObb:a.object.obb,r,Jie,c=>{let h=ere;for(let p=0;p<C6&&c.length>0;p++){if(!(a.mask&1<<p))continue;tre(n[p],c,h);let m=c;c=h,h=m}for(let p=0;p<c.length;p+=3){Te($n,c.data[p],c.data[p+1],c.data[p+2]);let m=ae(ai($n,$n,r),s);Nc.near=Math.min(Nc.near,m)}})===0&&(Nc.near=0),i.union(Nc)}return h1.length=0,i}var h1=new Nt({allocator:e=>e||{near:1/0,far:-1/0,mask:0,object:null},deallocator:e=>(e.object=null,e)}),Nc=new Wr,$n=w(),sp=w(),Jie=new Nt({deallocator:null}),ere=new Nt({deallocator:null});function tre(e,t,i){i.length=0;let r=t.length-3;nN($n,t,r);let n=ql(e,$n);n<=0&&(i.push($n[0]),i.push($n[1]),i.push($n[2]));let s=0,o=n;for(;s<r;s+=3){nN(sp,t,s);let a=ql(e,sp);o*a<0&&(ni($n,sp,$n,a/(a-o)),Zn(i,$n)),a<=0&&Zn(i,sp),o=a,ee($n,sp)}o*n<0&&(nN(sp,t,r),ni($n,sp,$n,n/(n-o)),Zn(i,$n))}function nN(e,t,i){return Te(e,t.data[i],t.data[i+1],t.data[i+2])}function Zn(e,t){e.push(t[0]),e.push(t[1]),e.push(t[2])}function ire(e,t,i,r){rF(_6,e.quaternion),ai(Ks,t,e.center),TL(Ks,Ks,_6);let n=e.halfSize,s=8*((Ks[0]<-n[0]?-1:Ks[0]>n[0]?1:0)+3*(Ks[1]<-n[1]?-1:Ks[1]>n[1]?1:0)+9*(Ks[2]<-n[2]?-1:Ks[2]>n[2]?1:0)+13),o=g6[s];if(o===0)return o;PL(p1,e.quaternion),P0(p1,p1,e.halfSize);let a=(l,c)=>{let h=g6[s+c+1];return Te(l,((1&h)<<1)-1,(2&h)-1,((4&h)>>1)-1),ts(l,l,p1),he(l,e.center,l)};return i.length=0,Zn(i,a(sN,0)),Zn(i,a(y6,1)),Zn(i,a(Ks,2)),Zn(i,a(v6,3)),r(i),o===1||(i.length=0,Zn(i,sN),Zn(i,v6),Zn(i,a(Ks,4)),Zn(i,a(w6,5)),r(i),o===2||(i.length=0,Zn(i,sN),Zn(i,w6),Zn(i,a(Ks,6)),Zn(i,y6),r(i))),o}var g6=(()=>{let e=new Array(216),t=0,i=r=>{for(let n=0;n<r.length;n++)e[t+n]=r[n];t+=8};return i([3,0,6,2,3,1,5,4]),i([2,0,2,3,1,5,4,0]),i([3,1,0,2,3,7,5,4]),i([2,0,1,3,2,6,4,0]),i([1,0,1,3,2,0,0,0]),i([2,1,5,7,3,2,0,0]),i([3,2,0,1,3,7,6,4]),i([2,2,0,1,3,7,6,0]),i([3,3,0,1,5,7,6,2]),i([2,0,1,5,4,6,2,0]),i([1,0,1,5,4,0,0,0]),i([2,1,3,7,5,4,0,0]),i([1,0,2,6,4,0,0,0]),i([0,0,0,0,0,0,0,0]),i([1,1,3,7,5,0,0,0]),i([2,2,3,7,6,4,0,0]),i([1,2,3,7,6,0,0,0]),i([2,3,1,5,7,6,2,0]),i([3,4,0,1,5,7,6,2]),i([2,5,7,6,4,0,1,0]),i([3,5,0,1,3,7,6,4]),i([2,4,5,7,6,2,0,0]),i([1,4,5,7,6,0,0,0]),i([2,5,1,3,7,6,4,0]),i([3,6,0,2,3,7,5,4]),i([2,6,2,3,7,5,4,0]),i([3,7,6,2,3,1,5,4]),e})(),C6=4;function rre(e,t){let i=0;for(let r=0;r<C6;r++){let n=e.intersectPlane(t[r]);if(n>0)return-1;n===0&&(i|=1<<r)}return i}var p1=Ln(),_6=Ug(),Ks=w(),sN=w(),y6=w(),v6=w(),w6=w();var m1=class{constructor(t){this._objects=t}submit(t,i){this._objects.preSubmit(i),this._objects.visibleObjects.forAll(r=>r.renderable.material.submit(t,i,r))}queryDepthRange(t){return this._objects.visibleObjects.length?b6(t,this._objects.visibleObjects):null}get hasEmissions(){return this._objects.visibleObjects.some(t=>t.renderable.material.hasEmissions)}hasHighlightOptions(t){return this._objects.hasHighlightOptions(t)}};var f1=class{constructor(){this.externalColor=Qi(),this.externalColorMixMode=q0.Multiply,this.castShadows=!0,this.pickable=!0,this.elevationOffset=0}};var g1=()=>W.getLogger("esri.views.3d.webgl-engine.collections.Component.ComponentObjectCollection"),_1=class{constructor(t,i){this._renderManager=t,this._viewingMode=i,this._elevationRangeCacheVerticalOffset=NaN,this._elevationRangeCacheMin=NaN,this._elevationRangeCacheMax=NaN,this._activeHighlightOptions=new Map,this._visible=new Nt,this._hidden=new Nt,this._renderSubmit=new m1(this),this._renderManager.register(this._renderSubmit),this._componentBufferManager=new aH(t.rctx,2+(Xc()?1:0))}destroy(){en(this._hidden.length===0&&this._visible.length===0,"ObjectCollection should be empty upon disposal"),this._componentBufferManager.destroy(),this._visible.forAll(t=>t.destroy()),this._hidden.forAll(t=>t.destroy()),this._visible.clear(),this._hidden.clear()}createObject(t){let i=t.geometry,r=new s1(this._componentBufferManager,M0(i.componentOffsets)),n=this._createRenderable(t,r),s=new c1(this._viewingMode,i.positionData,r),o=new o1(t.transform,t.toMapSpace,t.obb.clone(),r,n,s);return(o.visible?this._visible:this._hidden).push(o),o}destroyObject(t){let i=t;(i.visible?this._visible:this._hidden).removeUnordered(i),i.destroy(),this._notifyDirty()}setObjectVisibility(t,i){let r=t;i!==r.visible&&(i?(this._hidden.removeUnordered(r),this._visible.push(r)):(this._visible.removeUnordered(r),this._hidden.push(r)),r.visible=i,this._notifyDirty())}preSubmit(t){let i=t.camera.eye;this.visibleObjects.forAll(r=>r.renderable.meta.cameraDepthSquared=po(i,r.obb.center))}getMaterial(t){return t.renderable.material}updateMaterial(t,i){let r=t.renderable.material;i(r),r.dirty&&this._notifyDirty()}setAllComponentVisibilities(t,i){let r=t;r.componentData.visibility.reset(i),r.componentData.markVisibilityDirty(),this._notifyDirty()}forEachVisibleComponent(t,i){return t.componentData.visibility.forEachComponent(i)}getComponentCount(t){let i=t,r=i.componentData.visibility.componentCount;return{visible:r,invisible:i.componentData.count-r}}setComponentData(t,i){let r=t,{renderable:n,componentData:s}=r,o=n.material,a=s.materialDataBuffer,l=s.materialDataIndices,c=new f1,h=a.textureBuffer,p=new Uint8Array(4),m=new Uint32Array(p.buffer),f=0,g=0,_=0,v=s.verticalOffsets,b=1/0,x=-1/0,E=!1,D=!1,M=0;for(let T=0;T<s.count;T++){i(T,c),f+=+(c.externalColor[3]<1),g+=+(c.externalColorMixMode===q0.Replace&&c.externalColor[3]===1),_+=+c.castShadows,bF(c.externalColor,c.externalColorMixMode,p),p[2]=254&p[2]|+c.castShadows,h.setData(l[T],0,p[0],p[1],p[2],p[3]),E||=T>0&&M!==m[0],M=m[0],D||=c.elevationOffset!==0,D&&v==null&&(v=new Array(T).fill(0)),v!=null&&(v[T]=c.elevationOffset),b=Math.min(b,c.elevationOffset),x=Math.max(x,c.elevationOffset),CF(c.elevationOffset,p),h.setData(l[T],1,p[0],p[1],p[2],p[3]);let I=c.objectAndLayerIdColor;I!=null&&h.setData(l[T],2,I[0],I[1],I[2],I[3]),c.pickable!==wv(s.pickability,T)&&(s.pickability=p6(s.pickability,s.count,T,c.pickable))}s.verticalOffsets=D?v:null,r.offsetObb=D?pF(r.obb,b,x,this._viewingMode,r.offsetObb??r.obb.clone()):null,E||D||Xc()?(o.componentParameters=new V3,o.componentParameters.castShadows=oN(_,s.count),o.componentParameters.transparent=oN(f,s.count),o.componentParameters.opaqueOverride=oN(g,s.count),o.componentParameters.texture=h,h.updateTexture()):(o.componentParameters=new k3,o.componentParameters.castShadows=c.castShadows?um.All:um.None,o.componentParameters.externalColor=c.externalColor,o.componentParameters.externalColorMixMode=c.externalColorMixMode),this._elevationRangeCacheVerticalOffset=NaN,this._notifyDirty()}getComponentAabb(t,i,r,n=!1){t.intersectionGeometry.getComponentAabb(i,r);let s=t,o=s.componentData.verticalOffsets;if(n||o==null)return r;let a=o[i];if(this._viewingMode===Se.Local||a===0)return r[2]+=a,r[5]+=a,r;let l=iM(a);return l.localOrigin=s.transform.position,l.applyToAabb(r)}getComponentObb(t){return t.obb}getObjectTransform(t){return t.transform}getComponentPositions(t,i,r){return t.intersectionGeometry.getComponentPositions(i,r)}expandRangeWithComponentObjectElevationRange(t,i,r,n){Number.isNaN(this._elevationRangeCacheVerticalOffset)||this._elevationRangeCacheVerticalOffset!==i||n.expandElevationRangeValues(this._elevationRangeCacheMin,this._elevationRangeCacheMax);let s=t,o=s.componentData,a=o.count,l=o.verticalOffsets,c=s.intersectionGeometry,h=this._viewingMode===Se.Local,p=c.getComponentAabbs(),m=sre,f=1/0,g=-1/0;for(let _=0;_<a;_++){let v=6*_,b=l?.[_]??0,x=1/0,E=-1/0;if(h)x=p[v+2]+b+i,E=p[v+5]+b+i;else{if(m[0]=p[v],m[1]=p[v+1],m[2]=p[v+2],m[3]=p[v+3],m[4]=p[v+4],m[5]=p[v+5],b!==0){let I=iM(b);I.localOrigin=s.transform.position,I.applyToAabb(m)}let D=Math.max(Math.abs(m[3]),Math.abs(m[0])),M=Math.max(Math.abs(m[4]),Math.abs(m[1])),T=i+m[5]+r;n.expandElevationRangeValues(i+m[2],Math.sqrt(D*D+M*M+T*T)-r)}n.expandElevationRangeValues(x,E),f=Math.min(f,x),g=Math.max(g,E)}this._elevationRangeCacheVerticalOffset=i,this._elevationRangeCacheMin=f,this._elevationRangeCacheMax=g}intersect(t,i,r,n,s,o,a){let l=t,{transform:c}=l,{position:h}=c;return s!=null&&(s.localOrigin=h),l.intersectionGeometry.intersect(i,r,n,s,l.componentData.verticalOffsets,c,o,a)}addEdges(t,i,r,n,s){let o=t,{indices:a,positions:l}=o.intersectionGeometry,c=o.componentData.offsets;return i.addComponentObject(o,l,a,c,r,n,s)}async extractEdgeInformation(t,i,r){let n=t,s=n.componentData.visibility;if(s.allInvisible()){let{extractComponentsEdgeLocationsLayout:f}=await import("./chunk-FKI35EZK.js");return{buffer:f.createBuffer(0),origin:[0,0,0]}}let{indices:o,positions:a}=n.intersectionGeometry,l=n.componentData.offsets,{EdgeInputBufferLayout:c}=await import("./chunk-5XMH3XCD.js"),h=c.createBuffer(a.length/3);cF(h.position.typedBuffer,a,h.position.typedBufferStride,3),kL(h.position,h.position,n.transform.rotationScale),this._setComponentIndices(h.componentIndex,o,l);let p=h.count,m=this._computeVisibilityIndices(o,s,l,p);return{origin:mn(n.transform.position),buffer:await i.extractComponentsEdgeLocations({indices:m,indicesLength:m.length,skipDeduplicate:!0,data:h,writerSettings:{reducedPrecision:!1,variants:0}},r)}}_setComponentIndices(t,i,r){let n=0;for(let s=0;s<r.length-1;s++){let o=r[s],a=r[s+1];for(let l=o;l<a;l++){let c=i?i[l]:l;t.set(c,n)}n++}}_computeVisibilityIndices(t,i,r,n){if(t&&i.allVisible())return t;let s=0;i.forEachComponentRange((l,c)=>(s+=r[c]-r[l],!0));let o=GN(t)?t?.BYTES_PER_ELEMENT===2||n<=65536?new Uint16Array(s):new Uint32Array(s):new Array(s),a=0;return i.forEachComponentRange((l,c)=>{let h=r[l],p=r[c];for(let m=h;m<p;m++)o[a++]=t?t[m]:m;return!0}),o}addComponentHighlight(t,i,r){let n=t.componentData,s=_p(n.componentHighlights,r,()=>new Uint32Array(n.count+1));{let o=this._activeHighlightOptions.get(r)??0;this._activeHighlightOptions.set(r,o+1)}s[i]++===0&&(n.markHighlightsDirty(),this._notifyDirty()),s[n.count]++}removeComponentHighlight(t,i,r){let{componentData:n}=t,s=n.componentHighlights.get(r);if(s===void 0)return void g1().warn("Removing non-existing highlight.");let o=s[i];if(o===0)return void g1().warn("Removing non-existing highlight.");this._removeActiveHighlight(r);let a=s[n.count];if(o>1)return s[i]=o-1,void(s[n.count]=a-1);s[i]=0,a===1?n.componentHighlights.delete(r):s[n.count]=a-1,n.markHighlightsDirty(),this._notifyDirty()}_removeActiveHighlight(t,i=1){let r=this._activeHighlightOptions.get(t);if(r===void 0)g1().warn("Removing non-existing highlight.");else{let n=r-i;n<0&&g1().warn("Removing non-existing highlight."),n<=0?this._activeHighlightOptions.delete(t):this._activeHighlightOptions.set(t,n)}}clearHighlights(t){let{componentData:i}=t,{componentHighlights:r}=i;if(r.size>0){for(let n of r)this._removeActiveHighlight(n[0],n[1][i.count]);r.clear(),i.markHighlightsDirty(),this._notifyDirty()}}hasHighlightOptions(t){return this._activeHighlightOptions.has(t)}getObjectGPUMemoryUsage(t){return t.renderable.meta.gpuMemoryEstimate}get visibleObjects(){return this._visible}_createRenderable(t,i){let r=this._renderManager.rctx,n=t.geometry,s=n.vertices.layoutParameters,o=vr.createVertex(r,tn.STATIC_DRAW,n.vertices.data),a=n.indices?vr.createIndex(r,tn.STATIC_DRAW,n.indices):null,l=is(D3(s)),c=new Uint16Array(n.vertices.count);for(let _=0;_<i.count;_++){let v=i.offsets[_],b=i.offsets[_+1],x=i.materialDataIndices[_];if(n.indices!=null)for(let E=v;E<b;E++)c[n.indices[E]]=x;else for(let E=v;E<b;E++)c[E]=x}let h=vr.createVertex(r,tn.STATIC_DRAW,c.buffer),p=new F3(t.transform,t.toMapSpace),m=new NF(r,N3,new Map([["data",l],["componentIndices",nre]]),new Map([["data",o],["componentIndices",h]]),a),f=new d1(m,Jt.TRIANGLES,s,a!=null),g={cameraDepthSquared:.5,gpuMemoryEstimate:o.usedMemory+h.usedMemory+(a!=null?a.usedMemory:0)};return new u1(p,f,g)}_notifyDirty(){this._renderManager.notifyDirty()}},nre=is(Ps().u16(yi.COMPONENTINDEX));function oN(e,t){return e===t?um.All:e===0?um.None:um.Some}var sre=jc();var y1=class{constructor(t,i,r,n,s){this.rctx=t,this.viewingMode=i,this.stippleTextures=r,this.waterTextures=n,this.markerTextures=s}get spherical(){return this.viewingMode===Se.Global}get doublePrecisionRequiresObfuscation(){return this.rctx.driverTest.doublePrecisionRequiresObfuscation.result}};var og=class extends ss{constructor(e){super(e),this.consumes={required:["olid"]},this.produces="olid"}destroy(){}render(e){let t=e.find(({name:r})=>r==="olid"),i=this.renderingContext;return i.bindFramebuffer(t.fbo),i.clearFramebuffer(gn,!0,!0),this.view._stage.renderer.renderAllGeometry(oe.ObjectAndLayerIdColor),i.clear(Ti.DEPTH|Ti.STENCIL),this.view._stage.renderer.renderHUD(Fn.NotOccluded),t}};u([d()],og.prototype,"consumes",void 0),u([d()],og.prototype,"produces",void 0),og=u([C("esri.views.3d.webgl-engine.effects.geometry.ObjectAndLayerIDRenderNode")],og);var ag=class extends ss{constructor(e){super(e),this.consumes={required:[Oe.OCCLUDED]},this.produces=Oe.OCCLUDED,this._blit=new _w(e.view._stage.renderView.techniques,Zl.PremultipliedAlpha)}precompile(){let e=this.view._stage.renderer;e.plugins.plugins.forAll(t=>{e.precompileSlots(t,me.OCCLUDED_TERRAIN,me.TRANSPARENT_OCCLUDER_MATERIAL),t.material&&e.precompileOccludedSlots(t,T6)})}render(e){let t=e.find(({name:n})=>n===this.produces),i=this.view._stage.renderer,r=0;if(Lc.clear(),i.plugins.plugins.forAll(n=>{n.material&&n.queryRenderOccludedState(dr.OccludeAndTransparentStencil)&&(r|=dr.OccludeAndTransparentStencil,Lc.push(n))}),Lc.length>0&&(i.renderSlots(Lc,me.OCCLUDER_MATERIAL),r&dr.OccludeAndTransparentStencil&&this._renderAndComposite(t,.5,()=>i.renderSlots(Lc,me.TRANSPARENT_OCCLUDER_MATERIAL),!1,!1)),Lc.clear(),i.plugins.plugins.forAll(n=>{if(!n.material)return;let s=n.queryRenderOccludedState(dr.OccludeAndTransparent),o=n.queryRenderOccludedState(dr.Transparent),a=n.queryRenderOccludedState(dr.Opaque);(s||o||a)&&(r|=s?dr.OccludeAndTransparent:o?dr.Transparent:dr.Opaque,Lc.push(n))}),r|=i.plugins.renderOccludedFlags,!r)return t;for(let n of T6)r&n&&this._renderAndComposite(t,n===dr.Opaque?1:.5,()=>i.renderOccludedSlots(Lc,n),!0,z0.OutlineVisualElementMask);return Lc.clear(),t}_renderAndComposite(e,t,i,r,n){let s=this.renderingContext,{width:o,height:a}=e.fbo,l=this.fboCache.acquire(o,a,"tmp color"),c=r?this.fboCache.acquireDepth(wr.DEPTH_STENCIL_TEXTURE,o,a,"tmp depth"):e.getAttachment(Ad);l.attachDepth(c),s.bindFramebuffer(l.fbo),s.clearFramebuffer(gn,r,n),i(),l.detachDepth(),this._blit.blend(s,l,e,this.bindParameters,t),r&&c.release(),l.release()}};u([d()],ag.prototype,"consumes",void 0),u([d()],ag.prototype,"produces",void 0),ag=u([C("esri.views.3d.webgl-engine.effects.geometry.RenderOccludedRenderNode")],ag);var Lc=new Nt,T6=[dr.OccludeAndTransparent,dr.Transparent,dr.Opaque];var bv=class extends ft{constructor(t,i){super(t,i,new mt(cH,()=>import("./chunk-XNVWROXJ.js")))}initializePipeline(){return Tt({blending:za(ei.ONE,ei.ZERO,ei.ONE_MINUS_SRC_COLOR,ei.ONE),depthTest:{func:Ei.ALWAYS},colorWrite:St})}};var v1=class extends Vw{constructor(){super(...arguments),this.hazeStrength=1}},lg=class extends ft{constructor(t,i){super(t,i,new mt(uH,()=>import("./chunk-RM33HC4G.js")))}initializePipeline(t){return t.reduced?Tt({blending:Wp,depthTest:{func:Ei.ALWAYS},colorWrite:St}):Tt({blending:za(ei.ONE,ei.ZERO,ei.ONE_MINUS_SRC_COLOR,ei.ONE),colorWrite:St})}};var op=class extends iu{constructor(){super(...arguments),this.reduced=!1}};u([$t()],op.prototype,"reduced",void 0);var w1=class extends np{constructor(e){super(e),this._compositingPassParameters=new lH,this._passParameters=new v1,this._hazeConfiguration=new op,this._vao=null,this.requireGeometryDepth=!0,this._oldAmount=1,this._newAmount=1,this._amount=this._newAmount;let t=e.view._stage.renderView.techniques;t.precompile(lg,new op);let i=new op;i.reduced=!0,t.precompile(lg,i),t.precompile(bv)}initialize(){this.addHandles([S(()=>this.view.environment.atmosphereEnabled,e=>e?this._enable():this._disable(),Ce),S(()=>this.view._stage?.renderer.renderContext.bind.clouds.fadeFactor??1,e=>this._fade(e),Ce),S(()=>this.view.environment.weather.type,e=>this._newAmount=e==="rainy"?0:1,Ce),S(()=>this.view._stage.renderer?.fullResolutionAtmosphere,e=>this._hazeConfiguration.reduced=!e,Ce)])}_fade(e){e>=1?(this._amount=this._newAmount,this._oldAmount=this._newAmount):this._amount=e<=0?this._oldAmount:Xe(this._oldAmount,this._newAmount,e)}destroy(){this._vao=We(this._vao)}render(e){let t=e.find(({name:g})=>g===Oe.TRANSPARENT_ENVIRONMENT);if(!this.bindParameters.mainDepth)return t;let i=this.renderingContext;this._vao??=yn(i,uu.Pos2Tex);let r=this.techniques.get(lg,this._hazeConfiguration);if(!r.compiled)return t;let n=t.getAttachment(i.gl.DEPTH_STENCIL_ATTACHMENT);if(this._update(),!this._hazeConfiguration.reduced)return t.detachDepth(),i.bindFramebuffer(t.fbo),i.bindTechnique(r,this.bindParameters,this._passParameters),this._renderCommon(i),t.attachDepth(n),t;let s=this.techniques.get(bv);if(!s.compiled)return t;let o=i.getViewport(),a=this.camera,l=xe(a.eye)-pn.radius,c,h=pn.atmosphereHeight;if(l<h){let g=Math.min(1,Math.max(0,l/h));c=Xe(.4,.5,g)}else{let g=Math.min(1,Math.max(0,(l-h)/(15*h)));c=Xe(.5,1,g)}let p=tu(Math.round(c*a.fullViewport[2])),m=tu(Math.round(c*a.fullViewport[3]));i.setViewport(0,0,p,m);let f=this.fboCache.acquire(p,m,"haze",Pi.RGBA);return i.bindFramebuffer(f.fbo),i.clearFramebuffer([0,0,0,1],!0,!0),i.bindTechnique(r,this.bindParameters,this._passParameters),this._renderCommon(i),i.setViewport(o.x,o.y,o.width,o.height),this._compositingPassParameters.color=f.getTexture(),t.detachDepth(),i.bindFramebuffer(t.fbo),i.bindTechnique(s,this.bindParameters,this._compositingPassParameters),i.screen.draw(),t.attachDepth(n),f.release(),t}_renderCommon(e){this._vao!=null&&(e.bindVAO(this._vao),e.drawArrays(Jt.TRIANGLE_STRIP,0,4))}_update(){let e=this.bindParameters.camera,t=Ir(e.eye),i=Math.sqrt(t),r=t-this._passParameters.radii[1]*this._passParameters.radii[1],n=q((i-this._passParameters.radii[0])/pn.atmosphereHeight,0,1);ho(this._passParameters.heightParameters,i,t,r,n);let s=this.view.basemapTerrain?.getLowerBoundRadius()??0;es(this._passParameters.radii,s,s+pn.atmosphereHeight),this._passParameters.hazeStrength=Xe(Xe(.6,1,Vl(9500,10500,i-pn.radius)),1,this._amount)}};w1=u([C("esri.views.3d.webgl-engine.effects.haze.Haze")],w1);var b1=class extends Y0{constructor(){super(...arguments),this.shadowColor=fn(1,0,1,1),this.shadowOpacity=.2,this.occludedShadowOpacity=.1,this.opacityElevation=1,this.dayNightTerminator=1}},Cv=class extends ft{constructor(t,i){super(t,i,new mt(dH,()=>import("./chunk-SU3BDOLS.js"))),this.primitiveType=Jt.TRIANGLE_STRIP}initializePipeline(){return Tt({blending:Ga,colorWrite:St,depthTest:null,depthWrite:null})}};var ore=1/512,are=4e4,lre=5e4,ap=class extends ss{constructor(e){super(e),this.produces=ti.COMPOSITE,this.consumes={required:[ti.COMPOSITE,"highlights"]},this._passParameters=new b1,this._maxOpacity=1,this._shadowDifference=.2}initialize(){this.addHandles([S(()=>this.view.highlightOptions.shadowOpacity,e=>{this._passParameters.shadowOpacity=e??KF,this._updateOccludedShadowOpacity(),this._ensureMaxOpacity()},Ce),S(()=>this.view.highlightOptions.shadowDifference,e=>{this._shadowDifference=e??XF,this._updateOccludedShadowOpacity(),this._ensureMaxOpacity()},Ce),S(()=>this.view.highlightOptions.shadowColor,e=>{this._passParameters.shadowColor=kp(e??YF),this._ensureMaxOpacity()},Ce)])}_updateOccludedShadowOpacity(){this._passParameters.occludedShadowOpacity=this._passParameters.shadowOpacity*(1-this._shadowDifference)}_ensureMaxOpacity(){let e=Math.max(this._passParameters.shadowOpacity,this._passParameters.occludedShadowOpacity);this._maxOpacity=e*this._passParameters.shadowColor[3],this.requestRender(Pe.UPDATE)}precompile(){this.techniques.precompile(Cv)}render(e){let t=e.find(({name:n})=>n===ti.COMPOSITE),i=this.bindParameters;if(!i.shadowHighlightsVisible||!i.depth||!this._ensureIfVisible(i.camera,i.lighting.mainLight.direction))return t;let r=this.techniques.get(Cv);if(r.compiled){this._passParameters.highlight=e.find(({name:s})=>s==="highlights")?.getTexture(),this._passParameters.origin=i.camera.center;let n=this.renderingContext;n.bindFramebuffer(t.fbo),n.bindTechnique(r,i,this._passParameters),n.screen.draw()}else this.requestRender(Pe.UPDATE);return t}_ensureIfVisible(e,t){this._passParameters.opacityElevation=1-Vl(are,lre,e.relativeElevation);let i=this.viewingMode===Se.Global?ne(E6,e.center):Te(E6,0,0,1),r=ae(i,t);return this._passParameters.dayNightTerminator=Vl(0,1,q(30*r,0,1)),this._maxOpacity*this._passParameters.opacityElevation*this._passParameters.dayNightTerminator>=ore}};u([d()],ap.prototype,"produces",void 0),u([d()],ap.prototype,"consumes",void 0),u([d({constructOnly:!0})],ap.prototype,"viewingMode",void 0),ap=u([C("esri.views.3d.webgl-engine.effects.highlight.ShadowHighlight")],ap);var E6=w();var Tv=class extends ft{constructor(t,i){super(t,i,new mt(pH,()=>import("./chunk-IMNPXFMM.js")))}initializePipeline(){return Tt({blending:$p,depthTest:null,depthWrite:null,colorWrite:St})}};var md=class extends ss{constructor(){super(...arguments),this.produces=Oe.MAGNIFIER,this.consumes={required:[Oe.MAGNIFIER]},this._imageSources=null,this._imageLoadTask=null,this._passParameters=new hH,this._vao=null,this._magnifier=null,this._tmpScreenPoint=Kt(),this._tmpRenderPoint=V2()}initialize(){this.addHandles([S(()=>this.view.magnifier,e=>this._update(e),Ce)])}_update(e){if(e===this._magnifier)return;this.removeAllHandles(),this._magnifier=e;let t=()=>{let i=this._validMagnifier;i?(this._loadResources(i),this.produces=Oe.MAGNIFIER):this.produces="disabled",this.requestRender()};this._magnifier&&this.addHandles(S(()=>this._magnifier?.version,t)),t()}get _validMagnifier(){return this._magnifier?.visible&&this._magnifier?.position&&this._magnifier?.size>0?this._magnifier:null}get _factor(){return this._magnifier?.factor||1}destroy(){this._magnifier=null,this._imageLoadTask!=null&&(this._imageLoadTask.task.abort(),this._imageLoadTask=null),this._disposeTextures(),this._vao=We(this._vao)}_disposeTextures(){this._passParameters.mask=We(this._passParameters.mask),this._passParameters.overlay=We(this._passParameters.overlay),this._passParameters.input=We(this._passParameters.input)}precompile(){this._imageSources&&this.techniques.precompile(Tv)}render(e){let t=this._validMagnifier,i=e.find(({name:v})=>v===Oe.MAGNIFIER);if(t==null)return i;if(this._imageSources==null)return this.requestRender(Pe.UPDATE),i;let r=this.renderingContext,n=this.camera.pixelRatio,s=Math.ceil(n*t.size);this._vao??=yn(r,uu.Pos2,ja,0,1);let o=this.techniques.get(Tv);if(this._ensureTextureResources(r,s),!o.compiled||!this._passParameters.input)return this.requestRender(Pe.UPDATE),i;let a=Math.ceil(1/this._factor*s),l=this._passParameters.input;l.resize(a,a),Xo(t.position,this._tmpScreenPoint);let c=this.camera.screenToRender(this._tmpScreenPoint,this._tmpRenderPoint),h=this.camera.fullWidth,p=this.camera.fullHeight,m=.5*a,f=.5*a;c[0]=q(c[0],m,h-m-1),c[1]=q(c[1],f,p-f-1);let g=Math.floor(c[0]-m),_=Math.floor(c[1]-f);return r.bindFramebuffer(i.fbo),o.program.bindTexture("textureInput",l),r.gl.copyTexImage2D(l.descriptor.target,0,l.descriptor.pixelFormat,g,_,a,a,0),this._passParameters.magnifier=t,r.bindTechnique(o,this.bindParameters,this._passParameters),r.bindVAO(this._vao),r.drawArrays(Jt.TRIANGLE_STRIP,0,4),i}_loadResources(e){let{maskUrl:t,overlayUrl:i}=e;this._imageLoadTask?.maskUrl===t&&this._imageLoadTask?.overlayUrl===i||(this._imageLoadTask?.task.abort(),this._imageLoadTask=this._imageSources=null),this._imageSources||this._imageLoadTask||(this._imageLoadTask={maskUrl:t,overlayUrl:i,task:hn(async r=>{let n=t==null||i==null?uV(r):null,s=t!=null?eu(t,{signal:r}):n.then(a=>a.mask),o=i!=null?eu(i,{signal:r}):n.then(a=>a.overlay);this._imageSources={mask:await s,overlay:await o}})})}_ensureTextureResources(e,t){if(this._imageSources==null||this._passParameters.size===t&&this._passParameters.input&&this._passParameters.mask&&this._passParameters.overlay)return;this._disposeTextures(),this._imageSources.overlay.width=this._imageSources.mask.width=t,this._imageSources.overlay.height=this._imageSources.mask.height=t;let i=new vi;i.internalFormat=mi.RGBA,i.wrapMode=ji.CLAMP_TO_EDGE,i.flipped=!0,i.preMultiplyAlpha=!a0(this._imageSources.overlay.src)||!e.driverTest.svgPremultipliesAlpha.result,this._passParameters.overlay=new Di(e,i,this._imageSources.overlay),i.pixelFormat=i.internalFormat=mi.ALPHA,i.preMultiplyAlpha=!1,this._passParameters.mask=new Di(e,i,this._imageSources.mask),i.pixelFormat=i.internalFormat=mi.RGBA,i.flipped=!1,this._passParameters.input=new Di(e,i)}};u([d()],md.prototype,"produces",void 0),u([d()],md.prototype,"consumes",void 0),u([d()],md.prototype,"_imageSources",void 0),u([d()],md.prototype,"_imageLoadTask",void 0),md=u([C("esri.views.3d.webgl-engine.effects.magnifier.Magnifier")],md);var Ev=class extends ft{constructor(t,i){super(t,i,new mt(mH,()=>import("./chunk-D77IKVLK.js")))}initializePipeline(){return Tt({colorWrite:St})}};var Dv=class extends ft{constructor(t,i){super(t,i,new mt(fH,()=>import("./chunk-ZFM2JEX4.js")))}initializePipeline(){return Tt({colorWrite:St})}};var xv=class extends ft{constructor(t,i){super(t,i,new mt(gH,()=>import("./chunk-CQD2GOCN.js")))}initializePipeline(){return Tt({colorWrite:St})}};var C1=class extends Jc{};var fd=class extends ss{constructor(e){super(e),this.produces="disabled",this.consumes={required:[Oe.ANTIALIASING],optional:[ti.COMPOSITE]},this._areaTexture=null,this._searchTexture=null,this._smaaParameters=new C1}initialize(){this.addHandles([S(()=>this.isEnabled(),e=>e?this.enable():this.disable(),Ce)])}async enable(){if(this.produces=Oe.ANTIALIASING,this._abortController||this._areaTexture&&this._searchTexture)return;this._abortController=new AbortController;let e=this._abortController.signal;try{let t=await import("./chunk-TI47PP3Q.js");await this._loadTextures(t,e),this.requestRender(Pe.UPDATE)}catch{}this._abortController=null}async _loadTextures(e,t){Ht(t);let[i,r]=await Promise.allSettled([eu(e.areaTexture,{signal:t}),eu(e.searchTexure,{signal:t})]);if(Ht(t),i.status!=="fulfilled"||r.status!=="fulfilled")return;let n=this.renderingContext;this._areaTexture=D6(n,Nn.LINEAR,mi.RGB,i.value),this._searchTexture=D6(n,Nn.NEAREST,mi.LUMINANCE,r.value)}disable(){this.produces="disabled"}destroy(){this._searchTexture=We(this._searchTexture),this._areaTexture=We(this._areaTexture)}precompile(){this.techniques.precompile(xv),this.techniques.precompile(Ev),this.techniques.precompile(Dv)}render(e){let t=e.find(({name:m})=>m===Oe.ANTIALIASING);if(!this._areaTexture||!this._searchTexture)return this.requestRender(Pe.UPDATE),t;let i=this.techniques.get(xv),r=this.techniques.get(Ev),n=this.techniques.get(Dv);if(!i.compiled||!r.compiled||!n.compiled)return this.requestRender(Pe.UPDATE),t;let s=e.find(({name:m})=>m===ti.COMPOSITE);if(!s)return t;let o=s.fbo.width,a=s.fbo.height,l=this.renderingContext;l.setViewport(0,0,o,a);let c=this.fboCache.acquire(o,a,"smaa edges",Pi.RG);l.bindFramebuffer(c.fbo),l.setClearColor(0,0,0,1),l.clear(Ti.COLOR),this._smaaParameters.color=s.getTexture();let h=this.bindParameters;l.bindTechnique(i,h,this._smaaParameters),l.screen.draw();let p=this.fboCache.acquire(o,a,"smaa blend");return l.bindFramebuffer(p.fbo),l.setClearColor(0,0,1,1),l.clear(Ti.COLOR),this._smaaParameters.inputTexture=c.getTexture(),this._smaaParameters.areaTexture=this._areaTexture,this._smaaParameters.searchTexture=this._searchTexture,l.bindTechnique(r,h,this._smaaParameters),l.screen.draw(),c.release(),l.bindFramebuffer(t.fbo),l.setClearColor(0,1,0,1),l.clear(Ti.COLOR),this._smaaParameters.inputTexture=p.getTexture(),l.bindTechnique(n,h,this._smaaParameters),l.screen.draw(),p.release(),t}};function D6(e,t,i,r){let n=new vi;return n.pixelFormat=i,n.wrapMode=ji.CLAMP_TO_EDGE,n.width=r.width,n.height=r.height,n.samplingMode=t,new Di(e,n,r)}u([d()],fd.prototype,"produces",void 0),u([d()],fd.prototype,"consumes",void 0),u([d({constructOnly:!0})],fd.prototype,"isEnabled",void 0),u([d()],fd.prototype,"_abortController",void 0),fd=u([C("esri.views.3d.webgl-engine.effects.smaa.SMAA")],fd);var T1=class extends Jc{constructor(){super(...arguments),this.modelMatrix=Wt()}},Mv=class extends ft{constructor(t,i){super(t,i,new mt(_H,()=>import("./chunk-LVDOV23D.js")))}initializePipeline(){return Tt({blending:Ga,depthTest:{func:Ei.LEQUAL},colorWrite:St})}};var E1=class extends An{constructor(){super(...arguments),this._starData=null,this._loadDataTask=null,this._numPoints=0,this._passParameters=new T1}initialize(){this.addHandles([S(()=>this.view.environment.starsEnabled,e=>e?this._enable():this._disable(),Re),S(()=>this.view.environment.lighting.type==="virtual"?null:this.view.environment.lighting.date,e=>this._update(e),Ce)])}_enable(){super._enable(),this._loadDataTask=this._createLoadDataTask()}get loading(){return!!this._loadDataTask&&!this._loadDataTask.finished}destroy(){this._loadDataTask=xr(this._loadDataTask),this._numPoints=0,this._vao=We(this._vao),this._starData=null}precompile(){this.techniques.precompile(Mv)}render(e){let t=e.find(({name:n})=>n===Oe.OPAQUE_ENVIRONMENT),i=this.renderingContext;if(this.loading)return this.requestRender(Pe.UPDATE),t;if(!this._starData)return t;this._vao??=this._ensureResources(this._starData,i);let r=this.techniques.get(Mv);return r.compiled?(i.bindTechnique(r,this.bindParameters,this._passParameters),i.bindVAO(this._vao),i.drawArrays(Jt.POINTS,0,this._numPoints),t):(this.requestRender(Pe.UPDATE),t)}_ensureResources(e,t){return this._numPoints=e.byteLength/M6,cre(t,new Float32Array(e,0,2*this._numPoints),new Uint8Array(e,2*this._numPoints*4,this._numPoints),this._numPoints)}_update(e){if(!e)return;let t=(e.getHours()/12+e.getMinutes()/60*(2/24)+e.getSeconds()/60*(2/1440)-.9972222)%2,i=2*ure(e),r=Sp(this._passParameters.modelMatrix,gre);Fg(r,r,-i*Math.PI),lo(r,fre,r),Fg(r,r,-t*Math.PI),this.requestRender(Pe.UPDATE)}_createLoadDataTask(){if(this._starData)return null;let e=hn(async t=>{let{data:i}=await u2("esri/views/3d/environment/resources/stars.wsv",{responseType:"array-buffer",signal:t});dre(i),this._starData=i});return e.promise.catch(t=>{qr(t)||W.getLogger(this).error(t)}).then(()=>{this.destroyed||this.requestRender(Pe.UPDATE)}),e}};function cre(e,t,i,r){let n=x6.createBuffer(r),s=n.position,o=n.color,a=n.size;for(let l=0;l<r;l++){let c=t[2*l],h=t[2*l+1];s.set(l,0,-Math.cos(c)*Math.sin(h)),s.set(l,1,-Math.sin(c)*Math.sin(h)),s.set(l,2,-Math.cos(h));let p=pre(i[l]),m=hre(mre[p[1]]);o.set(l,0,255*m[0]),o.set(l,1,255*m[1]),o.set(l,2,255*m[2]),o.set(l,3,255),a.set(l,p[0])}return new ns(e,ja,new Map([["geometry",is(x6)]]),new Map([["geometry",vr.createVertex(e,tn.STATIC_DRAW,n.buffer)]]))}function ure(e){let t=e,i=new Date(e.getFullYear(),0,1,11,58,56);return(+t-+i)/(+new Date(e.getFullYear()+1,0,1,11,58,55)-+i)}function dre(e){if(!e)throw new Be("stars:no-data-received","Failed to create stars because star catalogue is missing");let t=e.byteLength/M6;if(t%1!=0||t>5e4||t<5e3)throw new Be("stars:invalid-data","Failed to create stars because star catalogue data is invalid")}function hre(e){return[parseInt(e.slice(0,2),16),parseInt(e.slice(2,4),16),parseInt(e.slice(4,6),16)]}function pre(e){return e>=192?[2.9,e-192]:e>=160?[2.5,e-160]:e>=128?[2,e-128]:e>=96?[1.5,e-96]:e>=64?[1,e-64]:e>=32?[.7,e-32]:[.4,e]}E1=u([C("esri.views.3d.webgl-engine.effects.stars.Stars")],E1);var mre=["9bb2ff","9eb5ff","aabfff","bbccff","ccd8ff ","dae2ff","e4e9ff","eeefff","f8f6ff","fff9fb","fff5ef","fff1e5","ffeddb","ffe9d2","ffe6ca","ffe3c3","ffe0bb","ffddb4","ffdaad","ffd6a5","ffd29c","ffcc8f","ffc178","ffa94b","ff7b00"],fre=qx(1,0,0,0,0,.9174771405229186,.39778850739794974,0,0,-.39778850739794974,.9174771405229186,0,0,0,0,1),gre=qx(1,0,0,0,0,.9174771405229186,-.39778850739794974,0,0,.39778850739794974,.9174771405229186,0,0,0,0,1),M6=9,x6=Ps().vec3f(yi.POSITION).vec4u8(yi.COLOR).f32(yi.SIZE);var Sv=class extends ft{constructor(t,i){super(t,i,new mt(vH,()=>import("./chunk-SYPJJZWA.js")))}initializePipeline(){return Tt({colorWrite:{r:!1,g:!0,b:!1,a:!1}})}};var D1=class{constructor(t,i){this._rctx=t,this._techniques=i,this._configuration=new mV,this._passParameters=new fV,this._hudParameters=new yH,this._configuration.blitMode=Zl.PremultipliedAlpha,this._techniques.precompile(tm,this._configuration),this._configuration.hasOpacityFactor=!0,this._techniques.precompile(tm,this._configuration),this._configuration.hasOpacityFactor=!1,this._configuration.blitMode=Zl.Alpha,this._techniques.precompile(tm,this._configuration),this._configuration.blitMode=Zl.Depth,this._techniques.precompile(tm,this._configuration),this._techniques.precompile(Sv)}compositeHUD(t,i){this._hudParameters.texture=i;let r=this._techniques.get(Sv);this._rctx.bindTechnique(r,t,this._hudParameters),this._rctx.screen.draw()}compositePreMultipliedAlpha(t,i,r=1){this._composite(t,i,Zl.PremultipliedAlpha,r)}composite(t,i){this._composite(t,i,Zl.Alpha,1)}blitDepthToLinearDepth(t,i){this._composite(t,i,Zl.Depth,1)}_composite(t,i,r,n){this._configuration.blitMode=r,this._configuration.hasOpacityFactor=n!==1,this._passParameters.texture=i,this._passParameters.opacity=n;let s=this._techniques.get(tm,this._configuration);this._rctx.bindTechnique(s,t,this._passParameters),this._rctx.screen.draw()}};var x1=class{constructor(){this.declaredClass="esri.views.3d.webgl-engine.lib.ObjectAndLayerIdRenderHelper",this.colorZero=new zx(new ArrayBuffer(4)),this._layerToOidToColor=new $g,this._colorToUID=new Map,this._layerUidToGraphicsUidToObjectId=new $g,this._layerUidToId=new Map,this._layerUidToPopupEnabled=new Map}setUidToObjectAndLayerId(t,i,r,n,s,o=null,a=null,l=null){t&&i&&r&&n&&(this._layerUidToId.set(n,r),this._layerUidToPopupEnabled.set(n,s),s&&this._layerUidToGraphicsUidToObjectId.set(n,i,{objectId:t,attributeNodeId:o,attributeIndex:a,subLayerId:l}))}getObjectAndLayerIdColor(t){let i=this.getObjectAndLayerIdColorArray(t);return fn(i.get(0,1),i.get(0,2),i.get(0,3),255)}getObjectAndLayerIdColorArray(t){if(!t.layerUid||!t.graphicUid)return this.colorZero;let i=this._layerUidToPopupEnabled.get(t.layerUid);if(i===void 0)return this.colorZero;if(i===!1)return this.colorZero;let r=this._layerUidToGraphicsUidToObjectId.get(t.layerUid,t.graphicUid)?.objectId;if(!r)return this.colorZero;let n=this._layerToOidToColor.get(t.layerUid,r);if(!n){if(Ct("enable-feature:objectAndLayerId-screenshot-testing"))n=r;else for(;!n;){let o=Math.floor(16777214*Math.random())+1;this._colorToUID.has(o)||(n=o)}if(n>16777215)throw new Error("Object ID Overflow");this._layerToOidToColor.set(t.layerUid,r,n),this._colorToUID.set(n,t)}let s=new ArrayBuffer(4);return new DataView(s).setUint32(0,n,!1),new zx(s)}getColorToObjectAndLayerIdMapping(){let t=new Map;for(let[i,r]of this._colorToUID.entries()){let n=this._layerUidToGraphicsUidToObjectId.get(r.layerUid,r.graphicUid),s=this._layerUidToId.get(r.layerUid);n&&s&&t.set(i,n.attributeNodeId?{type:"object-and-layer-and-i3s-id",olid:n.objectId,lid:s,attrId:n.attributeNodeId,attrIdx:n.attributeIndex,subLayerId:n.subLayerId}:{type:"object-and-layer-id",olid:n.objectId,lid:s})}return t}};var cg=class{constructor(t,i){this.key=t,this.free=i,this.incarnation=0,this._refCount=1}retain(t=1){this._refCount+=t}release(){return this._refCount===0?(console.log(`Releasing already released FBO attachment "${this.name}" in ${new Error().stack}`),!0):(--this._refCount,this._refCount===0&&(this.free(),!0))}},Ol;(function(e){e[e.FBO=0]="FBO",e[e.DEPTH=1]="DEPTH",e[e.COLOR=2]="COLOR"})(Ol||(Ol={}));var ug=class extends cg{constructor(t,i,r){super(t,r),this.attachment=i,this.name=""}dispose(){this.attachment.dispose()}get cachedMemory(){return this.attachment.usedMemory}};var M1=class extends ug{constructor(t,i,r){super(t,i,r),this.attachment=i,this.type=Ol.COLOR}};var Iv=class extends ug{constructor(){super(...arguments),this.type=Ol.DEPTH}};function S6(e){return e?.attachment.type===GF.Texture}var Av=class extends cg{constructor(t,i,r,n,s,o){super(t,o),this.type=Ol.FBO,this._colors=new Map,this._name=ti.COMPOSITE,this.acquireDepth=null,this.acquireColor=null,this._name=i,this.fbo=r,this.acquireDepth=n,this.acquireColor=s}dispose(){this.fbo?.dispose()}get cachedMemory(){return this.fbo?.usedMemory||0}get numberOfColorAttachments(){return this._colors.size}get name(){return this._name}setName(t){this._name=t}getTexture(t=lr.COLOR_ATTACHMENT0){return t===Ad?this.fbo?.depthStencilTexture:this.fbo?.getColorTexture(t)}getAttachment(t=lr.COLOR_ATTACHMENT0){return t===Ad?this._depth:this._colors.get(t)}hasAttachment(t){return s0(this._colors,i=>i.name===t)}attachDepth(t){return t?.retain(),this.detachDepth(),t&&this.fbo?.attachDepthStencil(t.attachment),this._depth=t,this}detachDepth(){this.fbo?.detachDepthStencilTexture(),this.fbo?.detachDepthStencilBuffer(),this._depth=ki(this._depth)}obtainDepthTexture(){let t=this._depth;return S6(t)?(this.fbo?.detachDepthStencilTexture(),this._depth=null,t):null}attachColor(t,i){return t.retain(),this.detachColor(i),this.fbo?.attachColorTexture(t.attachment,i),this._colors.set(i,t),this}detachColor(t){this.fbo?.detachColorTexture(t);let i=this._colors.get(t);this._colors.delete(t),i?.release()}detachAll(){this._colors.forEach((t,i)=>this.detachColor(i)),this.detachDepth()}};var dg=class{constructor(t,i){this._last=new Nt,this._incarnation=0,this._cache=new Bo(t,i)}destroy(){this._last?.forAll(t=>t.dispose()),this._last=null,this._cache.destroy()}set interactive(t){t&&!this._last?this._last=new Nt:t||(this._last?.forAll(i=>i.dispose()),this._last=null)}clean(){this._last?.filterInPlace(t=>!(t.incarnation<this._incarnation)||(this._cache.put(t.key,t),!1))}frame(){++this._incarnation}pop(t){if(this._last){let i=this._last.find(r=>r.key===t);if(i)return this._last.removeUnordered(i),i}return this._cache.pop(t)}put(t){t.incarnation=this._incarnation,this._last?this._last.push(t):this._cache.put(t.key,t)}get usedMemory(){return this._last?.reduce((t,i)=>t+i.cachedMemory,0)??0}};var P1=class{constructor(t){this.rctx=t,this._acquired=new Set,this._cache=new dg(t.newCache,"FBOCache"),this._depthCache=new dg(t.newCache,"DepthAttachmentCache"),this._colorCache=new dg(t.newCache,"ColorAttachmentCache")}destroy(){this._cache.destroy(),this._depthCache.destroy(),this._colorCache.destroy()}clean(){this._cache.clean(),this._colorCache.clean(),this._depthCache.clean()}frameStart(){this._cache.frame(),this._colorCache.frame(),this._depthCache.frame(),this.debugCallback?.()}frameEnd(){let t=this.debugCallback;t&&this._acquired.forEach(i=>i.type===Ol.FBO&&t(i.name,i.fbo,i.numberOfColorAttachments))}get usedMemory(){return Array.from(this._acquired.values()).reduce((t,i)=>t+("getTexture"in i?i.getTexture()?.usedMemory??0:i.cachedMemory),this._cache.usedMemory+this._colorCache.usedMemory+this._depthCache.usedMemory)}set interactive(t){this._cache.interactive=this._colorCache.interactive=this._depthCache.interactive=t}acquire(t,i,r,n=Pi.RGBA){let s=aN(n,t,i),o=this._cache.pop(s);if(o){o.retain(),o.setName(r);let a=this.rctx.getBoundFramebufferObject();if(this.rctx.bindFramebuffer(o.fbo),this.rctx.setDrawBuffers([lr.COLOR_ATTACHMENT0]),!o.fbo)throw new Be("attempt to use a not existing framebuffer");this.rctx.unbindTexture(o.fbo.colorTexture),this.rctx.bindFramebuffer(a)}else o=new Av(s,r,new $a(this.rctx,be(ie({},I6[n]),{width:t,height:i})),a=>{a??=wr.DEPTH_STENCIL_TEXTURE;let l=this._acquireDepth(a,o.fbo.width,o.fbo.height,`${o.name} depth`);return o.attachDepth(l),l.release(),o},(a,l,c)=>{l??=Pi.RGBA;let h=this._acquireColor(l,t,i,c??`${o.name} color ${a}`);return this.rctx.unbindTexture(h.attachment),o.attachColor(h,a),h.release(),o},()=>{this.debugCallback?.(o.name,o.fbo,o.numberOfColorAttachments),this._acquired.delete(o),o.detachAll(),this._cache.put(o)});return this._trackHandle(o)}acquireDepth(t,i,r,n){return this._acquireDepth(t,i,r,n)}_acquireDepth(t,i,r,n){let s=aN(t,i,r),o=this._depthCache.pop(s);if(o)return o.retain(),o.name=n,this._trackHandle(o);let a=t===wr.DEPTH_STENCIL_TEXTURE?new Iv(s,new Di(this.rctx,be(ie({},A6[t]),{width:i,height:r})),()=>{this._acquired.delete(a),this._depthCache.put(a)}):new Iv(s,new Kk(this.rctx,be(ie({},A6[t]),{width:i,height:r})),()=>{this._acquired.delete(a),this._depthCache.put(a)});return a.name=n,this._trackHandle(a)}_acquireColor(t,i,r,n){let s=aN(t,i,r),o=this._colorCache.pop(s);if(o)return o.retain(),o.name=n,this._trackHandle(o);let a=new M1(s,new Di(this.rctx,be(ie({},I6[t]),{width:i,height:r})),()=>{this._acquired.delete(a),this._colorCache.put(a)});return a.name=n,this._trackHandle(a)}_trackHandle(t){return this._acquired.add(t),t}},Nl=new Av("default","default",null,()=>Nl,()=>Nl,()=>{});function aN(e,t,i){return`${e}x${t}x${i}`}Nl.release=()=>!1;var S1=new vi;S1.pixelFormat=mi.RED,S1.internalFormat=Gc.R8,S1.wrapMode=ji.CLAMP_TO_EDGE;var I1=new vi;I1.pixelFormat=mi.RG,I1.internalFormat=Gc.RG8,I1.wrapMode=ji.CLAMP_TO_EDGE;var A1=new vi;A1.internalFormat=Gc.RGBA4,A1.dataType=Ba.UNSIGNED_SHORT_4_4_4_4,A1.wrapMode=ji.CLAMP_TO_EDGE;var R6=new vi;R6.wrapMode=ji.CLAMP_TO_EDGE;var Rv=new vi;Rv.wrapMode=ji.CLAMP_TO_EDGE,Rv.samplingMode=Nn.LINEAR_MIPMAP_LINEAR,Rv.hasMipmap=!0,Rv.maxAnisotropy=8;var Pv=new vi;Pv.pixelFormat=mi.RED,Pv.dataType=Ba.HALF_FLOAT,Pv.internalFormat=Gc.R16F,Pv.samplingMode=Nn.NEAREST;var R1=new vi;R1.dataType=Ba.HALF_FLOAT,R1.internalFormat=Gc.RGBA16F,R1.samplingMode=Nn.NEAREST;var I6={[Pi.RED]:S1,[Pi.RG]:I1,[Pi.RGBA4]:A1,[Pi.RGBA]:R6,[Pi.RGBA_MIPMAP]:Rv,[Pi.R16F]:Pv,[Pi.RGBA16F]:R1},hg=new vi;hg.pixelFormat=mi.DEPTH_STENCIL,hg.dataType=Ba.UNSIGNED_INT_24_8,hg.samplingMode=Nn.NEAREST,hg.wrapMode=ji.CLAMP_TO_EDGE,hg.internalFormat=mi.DEPTH24_STENCIL8;var A6={[wr.DEPTH_STENCIL_TEXTURE]:hg,[wr.DEPTH16_BUFFER]:new lw(x0.DEPTH_COMPONENT16,4)};var pg;(function(e){e[e.FrontToBack=0]="FrontToBack",e[e.BackToFront=1]="BackToFront"})(pg||(pg={}));var qo=class{constructor(t,i,r=pg.FrontToBack){this._rctx=t,this._techniques=i,this._sorting=r,this._draws=new Nt({allocator:n=>n??{material:null,geometry:null,geometryRanges:null,bindDrawParams:null,depthSquaredHint:0,indexType:0}}),this._previouslyBoundDraw=new Map}submitDraw(t,i,r,n,s){let o=this._draws.pushNew();o.geometry=i,o.geometryRanges=r,o.material=t,o.depthSquaredHint=n,o.indexType=(i.indexed?i.vao.indexBuffer.indexType:null)??0,o.highlightName=s}acquire(t,i){return this._draws.map(r=>r.material.acquireTechnique(this._techniques,t,i,r.geometry.parameters))}dispatch(t,i,r){let n=this._rctx;this._previouslyBoundDraw.clear();let s=null,o=this._draws.length,a=i.highlight?.name;for(let l=0;l<o;l++){let c=this._draws.data[l];if(t.identifier===Ql.Highlight){let b=c.highlightName;if(b){if(b!==a)continue}else if(!a||!i.overlay?.hasHighlightOptions(a))continue}let h=r[l];h===s&&i.oitPass===Ns.NONE||(n.bindTechnique(h,i,t),s=h);let{geometryRanges:p,indexType:m,geometry:f,material:g}=c;n.bindVAO(f.vao),this._previouslyBoundDraw.get(h)!==g&&(h.program.bindDraw(i,t,g),this._previouslyBoundDraw.set(h,g));let _=p.length,{primitiveType:v}=f;for(let b=0;b<_;b+=2){let x=p[b],E=p[b+1];if(m!==0){let D=O1.get(m);n.drawElements(v,E,m,x*D)}else n.drawArrays(v,x,E)}}}prepareSubmit(){this._draws.clear()}finishSubmit(){let t=this._sorting===pg.FrontToBack?1:-1;this._draws.sort((i,r)=>{let n=t*(i.depthSquaredHint-r.depthSquaredHint);return n!==0?n:i.geometry.vao.byteSize-r.geometry.vao.byteSize})}get count(){return this._draws.length}},O1=new Map;O1.set(Id.UNSIGNED_BYTE,1),O1.set(Id.UNSIGNED_SHORT,2),O1.set(Id.UNSIGNED_INT,4);var N1=class{constructor(t){let i=t.renderContext.rctx,r=t.techniques;this.opaque=new qo(i,r),this.transparent=new qo(i,r,pg.BackToFront),this.integratedMesh=new qo(i,r),this.shadowMap=new qo(i,r),this.highlight=new qo(i,r),this.highlightIntegratedMesh=new qo(i,r),this.highlightShadowMap=new qo(i,r),this.viewshedShadowMap=new qo(i,r),this.nonHighlightShadowMap=new qo(i,r)}},mg=class extends IF{constructor(){super(...arguments),this.slicePlaneLocalOrigin=w(),this.origin=this.slicePlaneLocalOrigin,this.modelTransformation=null}};var L1=class extends mg{constructor(){super(...arguments),this.identifier=Ql.Material,this.output=oe.Color,this.transparent=!1}},F1=class extends mg{constructor(){super(...arguments),this.identifier=Ql.ShadowMap}},k1=class extends mg{constructor(){super(...arguments),this.identifier=Ql.Highlight}},V1=class extends mg{constructor(){super(...arguments),this.identifier=Ql.ViewshedShadowMap}};var H1=class extends zp{constructor(){super({}),this.produces=new Map([[me.OPAQUE_MATERIAL,e=>this._produces(e,me.OPAQUE_MATERIAL)],[me.TRANSPARENT_MATERIAL,e=>this._produces(e,me.TRANSPARENT_MATERIAL)],[me.INTEGRATED_MESH,e=>this._produces(e,me.INTEGRATED_MESH)]]),this._materialPassParameters=new L1,this._shadowPassParameters=new F1,this._highlightPassParameters=new k1,this._viewshedPassParameters=new V1,this._systems=new Set}initializeRenderContext(e){this._context=e,this._passes=new N1(e)}get rctx(){return this._context.renderContext.rctx}uninitializeRenderContext(){}dispose(){this._context=null,this._systems.clear()}register(e){this._systems.add(e)}_produces(e,t){return!!this._invoke(e,t,i=>i.count>0)}prepareRender(e){if(this._systems.size!==0&&this._passes!=null){for(let t of Object.values(this._passes))t.prepareSubmit();this._systems.forEach(t=>t.submit(this._passes,e.bind));for(let t of Object.values(this._passes))t.finishSubmit()}}acquireTechniques(e){if(this._systems.size===0)return null;let t=e.output===oe.Shadow||e.output===oe.ShadowHighlight||e.output===oe.ShadowExcludeHighlight?this._shadowPassParameters:e.output===oe.ViewshedShadow?this._viewshedPassParameters:e.output===oe.Highlight?this._highlightPassParameters:this._materialPassParameters,i=e.bind;return this._updateParameters(i.camera,t,i.slot===me.TRANSPARENT_MATERIAL),this._materialPassParameters.output=e.output,this._invoke(e.output,e.bind.slot,(r,n)=>r.acquire(n,e.bind))}render(e,t){this._invoke(e.output,e.bind.slot,(i,r)=>i.dispatch(r,e.bind,t))}_invoke(e,t,i){if(this._passes==null)return null;switch(t){case me.OPAQUE_MATERIAL:switch(e){case oe.Color:case oe.ColorEmission:case oe.Depth:case oe.Normal:case oe.ObjectAndLayerIdColor:return i(this._passes.opaque,this._materialPassParameters);case oe.Highlight:return i(this._passes.highlight,this._highlightPassParameters);case oe.Shadow:return i(this._passes.shadowMap,this._shadowPassParameters);case oe.ShadowHighlight:return i(this._passes.highlightShadowMap,this._shadowPassParameters);case oe.ShadowExcludeHighlight:return i(this._passes.nonHighlightShadowMap,this._shadowPassParameters);case oe.ViewshedShadow:return i(this._passes.viewshedShadowMap,this._viewshedPassParameters)}break;case me.TRANSPARENT_MATERIAL:switch(e){case oe.Color:case oe.ColorEmission:case oe.Depth:case oe.Normal:case oe.ObjectAndLayerIdColor:return i(this._passes.transparent,this._materialPassParameters)}break;case me.INTEGRATED_MESH:switch(e){case oe.Color:case oe.ColorEmission:case oe.Depth:case oe.Normal:case oe.ObjectAndLayerIdColor:return i(this._passes.integratedMesh,this._materialPassParameters);case oe.Highlight:return i(this._passes.highlightIntegratedMesh,this._highlightPassParameters)}}return null}notifyDirty(){this._context.requestRender()}queryDepthRange(e){let t=new Wr;return this._systems.forEach(i=>t.union(i.queryDepthRange(e))),t}get hasEmissions(){let e=!1;return this._systems.forEach(t=>e=t.hasEmissions||e),e}_updateParameters(e,t,i){let r=e.viewInverseTransposeMatrix;Te(lN,r[3],r[7],r[11]),cN.set(lN),ee(t.transformWorldFromViewTH,cN.high),ee(t.transformWorldFromViewTL,cN.low),ee(t.slicePlaneLocalOrigin,lN),Op(t.transformViewFromCameraRelativeRS,e.viewMatrix),Sp(t.transformProjFromView,e.projectionMatrix),t.identifier===Ql.Material&&(this._materialPassParameters.transparent=i,qc(P6,t.transformViewFromCameraRelativeRS),A0(t.transformNormalViewFromGlobal,P6))}hasHighlightOptions(e){for(let t of this._systems)if(t.hasHighlightOptions(e))return!0;return!1}};H1=u([C("esri.views.3d.webgl-engine.core.renderPasses.RenderPassManager")],H1);var lN=w(),P6=Ln(),cN=new L3;function O6(e){return e.name}var B1=class{constructor(t){this._context=t,this._nodes=new Nt}destroy(){this._nodes.forEach(t=>t.destroy()),this._nodes.clear()}add(t){this._nodes.push(t),eM&&console.log(`Registered render nodes: ${this._nodes.map(({declaredClass:i})=>i).join(", ")}`)}remove(t){this._nodes.remove(t),eM&&console.log(`Registered render nodes: ${this._nodes.map(({declaredClass:i})=>i).join(", ")}`)}produces(t){return this._nodes.some(({produces:i})=>i===t)}require(t,...i){let r=this._nodes,n=s=>r.reduce((o,{consumes:a,produces:l})=>o+(!a.required.includes(t)||s!=null&&l!==s?0:1),0);return i.length===0?n():i.reduce((s,o)=>s+n(o),0)}optional(t,...i){let r=this._nodes,n=s=>r.reduce((o,{consumes:a,produces:l})=>o+(!a.optional?.includes(t)||s!=null&&l!==s?0:1),0);return i.length===0?n():i.reduce((s,o)=>s+n(o),0)}updateAnimation(t){return this._nodes.reduce((i,r)=>r.updateAnimation(t)||i,!1)}precompile(...t){++this._context.techniques.precompiling;for(let i of t)this._nodes.forEach(r=>{r.produces===i&&r.precompile()});--this._context.techniques.precompiling}render(t,i,r=()=>{}){let n=t.name,s=this._nodes.filter(({produces:o})=>o===n);return s.length===0?O6(t)?t:Nl:(s.forEach(o=>{let a=[t];for(let l of o.consumes.required){if(l===n)continue;let c=i.get(l);if(c)a.push(c);else if(l!=="emissive"||!i.get(n)?.hasAttachment(l))return void(r&&r(a))}if(o.consumes.optional)for(let l of o.consumes.optional){if(l===n)continue;let c=i.get(l);c&&a.push(c)}try{let l=o.doRender(a);l&&l!==t&&(n!==l.name&&(W.getLogger(o).errorOnce(`RenderNode produced ${l.name}, expected ${n}`),l.setName(n)),t.release(),t=l,i.set(n,t))}catch(l){W.getLogger(o).errorOnce(l)}r&&r(a)}),this._context.rctx.enforceState(),t)}requireGeometryDepth(){return this._nodes.some(t=>t.produces!=="disabled"&&t.requireGeometryDepth)}get test(){return{nodes:this._nodes}}};var U1=class{constructor(t){this.context=t,this._renderPlugins=new Nt,this._slots=new Array,this._version=On(0);for(let i=0;i<me.MAX_SLOTS;++i)this._slots[i]=[]}destroy(){this._renderPlugins.forEach(t=>t.destroy()),this._renderPlugins.clear()}get plugins(){return this._renderPlugins}add(t,i){let r=()=>{if(i?.aborted)throw t.uninitializeRenderContext(),Mr();this._renderPlugins.push(t),t.produces.forEach((s,o)=>this._slots[o].push(t)),this.context.requestRender(),this._version.value++},n=t.initializeRenderContext(this.context,i);if(Na(n))return n.then(r);r()}remove(t){this._renderPlugins.removeUnordered(t),t.uninitializeRenderContext();for(let i=0;i<this._slots.length;++i)this._slots[i]=this._slots[i].filter(r=>r!==t);this.context.requestRender(),this._version.value++}prepareRender(){this._renderPlugins.forAll(t=>{t.prepareRender&&t.prepareRender(this.context.renderContext)})}updateAnimation(t){let i=!1;return this._renderPlugins.forAll(r=>i=r.updateAnimation?.(t)||i),i}precompile(...t){++this.context.techniques.precompiling;let i=this.context.renderContext.bind.slot;for(let r of t)this.context.renderContext.bind.slot=r,this._forEachRender(()=>{});this.context.renderContext.bind.slot=i,--this.context.techniques.precompiling}render(t,...i){for(let r of i)this.context.renderContext.bind.slot=r,this._forEachRender((n,s)=>n.render(this.context.renderContext,s,t))}_forEachRender(t){let i=this.context.renderContext.bind.slot,r=this.context.renderContext.output;this._slots[i].forEach(n=>{if(!n.produces.get(i)?.(r)||n.isDecoration&&!this.context.renderContext.bind.decorations)return;let o=n.acquireTechniques(this.context.renderContext);o&&t(n,o)})}queryDepthRange(t){let i=new Wr;return this._renderPlugins.forAll(r=>{let n=r.queryDepthRange?.(t);i.union(n)}),i}get updating(){return this._version.value>=0&&this._renderPlugins.some(t=>t.running)}produces(t,...i){return i.some(r=>this._slots[r].some(n=>{let s=n.produces.get(r);return!!s&&s(t)}))}consumes(t){return this._renderPlugins.some(i=>i.consumes().required.includes(t))}hasHighlightOptions(t){return _re.some(i=>this._slots[i].some(r=>r.hasHighlightOptions(t)))}get hasDecorations(){return this._renderPlugins.some(t=>t.isDecoration)}get hasOccludees(){return this._renderPlugins.some(t=>t.hasOccludees)}get hasEmissions(){return this._renderPlugins.some(t=>t.hasEmissions)}get renderOccludedFlags(){return this._renderPlugins.reduce((t,i)=>t|i.renderOccludedFlags,dr.None)}get usedMemory(){return this._renderPlugins.reduce((t,i)=>i.material?t:t+(i.usedMemory??0),0)}get test(){}},_re=[me.OPAQUE_MATERIAL,me.TRANSPARENT_MATERIAL,me.DRAPED_MATERIAL,me.HUD_MATERIAL,me.LABEL_MATERIAL];var fg=class extends ft{constructor(t,i){super(t,i,new mt(bH,()=>import("./chunk-6ZARIC6L.js")))}initializePipeline(t){return Tt({blending:Ga,colorWrite:St,drawBuffers:t.hasEmission?{buffers:[lr.COLOR_ATTACHMENT0,lr.COLOR_ATTACHMENT1]}:{buffers:[lr.COLOR_ATTACHMENT0]}})}};var Ov=class extends iu{constructor(){super(...arguments),this.hasEmission=!1}};u([$t()],Ov.prototype,"hasEmission",void 0);var j1=class{constructor(t){this._techniques=t,this._parameters=new wH,this._configuration=new Ov,t.precompile(fg,this._configuration),this._configuration.hasEmission=!0,t.precompile(fg,this._configuration)}blend(t,i,r,n,s){this._parameters.colorTexture=i.getTexture(),s&&(this._parameters.emissionTexture=i.getTexture(lr.COLOR_ATTACHMENT1),this._parameters.emissionFrontFaceTexture=r.getTexture(lr.COLOR_ATTACHMENT1)),this._parameters.alphaTexture=i.getTexture(s?lr.COLOR_ATTACHMENT2:lr.COLOR_ATTACHMENT1),this._parameters.frontFaceTexture=r.getTexture(),this._configuration.hasEmission=s;let o=this._techniques.get(fg,this._configuration);t.bindTechnique(o,n,this._parameters),t.screen.draw()}};var z1=class{constructor(t,i){this._camera=t,this._dt=0,this._time=0,this._lastUpdate=0,this._lastUpdate=i,this._time=i}advance(t,i,r){let n=i-this._lastUpdate;this._dt=n/r,this._time=this._time+n,this._lastUpdate=i,this._camera=t}forceTime(t){this._lastUpdate=this._time=t,this._dt=0}get camera(){return this._camera}get dt(){return this._dt}get time(){return this._time}};var G1=class{constructor(){this._step=F6,this._dilation=1,this._firstIdleTime=0}frame(t,i){if(i?this._firstIdleTime===0&&(this._firstIdleTime=performance.now()):this._firstIdleTime=0,Ct("disable-feature:high-quality-idle"))this._dilation=1;else{let n=i?performance.now()-this._firstIdleTime:0;if(n>=N6+vre)return this._step=1/0,void(this._dilation=1);this._dilation=n>=N6?wre:1}let r=q(t/yre,F6,Cre);this._step===1/0?this._step=r:this._step=this._step*L6+r*(1-L6)}get value(){return this._step}get timeDilation(){return this._dilation}clear(){this._step=this._firstIdleTime=0}},yre=.5,N6=12e4,vre=1e4,wre=10,L6=.9,bre=30,F6=1e3/1,Cre=1e3/bre;var q1;(function(e){e[e.SHADOW_CASTERS=0]="SHADOW_CASTERS",e[e.FULL_SCENE=1]="FULL_SCENE"})(q1||(q1={}));var Tre=1e4,hN=100,Ere=500,Dre=500,xre=.1;function H6(e,t,i,r=q1.SHADOW_CASTERS){let n=0;if(!t.some(o=>!!o.material&&(n+=o.numGeometries,n>=Tre)))return Pre.compute(e,t,r);let s=new Wr;return i.forAll(o=>s.union(Mre(e,o))),s}function Mre(e,t){if(!t.visible)return;let i=new Wr,r=t.getSpatialQueryAccelerator();return r?Sre(i,e,r):Ire(i,e,t.objects),i}function Sre(e,t,i){let{eye:r,viewForward:n,frustum:s}=t,o=l=>l.visible,a=i.objectCount;if(a<Ere)Wo.set(t.near,Math.min(e.near,t.far)),i.forEachInDepthRange(r,n,Kc.DepthOrder.FRONT_TO_BACK,Wo,(l,c)=>{pN(e,t,l),Wo.far=e.near,c.setRange(Wo)},s,o),Wo.set(Math.max(e.far,t.near),t.far),i.forEachInDepthRange(r,n,Kc.DepthOrder.BACK_TO_FRONT,Wo,(l,c)=>{pN(e,t,l),Wo.near=e.far,c.setRange(Wo)},s,o);else{let l=Math.max(Math.min(a,Dre),Math.ceil(a*xre)),c=i.findClosest(n,Kc.DepthOrder.FRONT_TO_BACK,s,o,l),h=i.findClosest(n,Kc.DepthOrder.BACK_TO_FRONT,s,o,l);c&&h&&(k6(e,t,c.boundingVolumeWorldSpace.bounds),k6(e,t,h.boundingVolumeWorldSpace.bounds))}}function Ire(e,t,i){gg.clear(),i.forAll(r=>{r.visible&&r.geometries.length!==0&&gg.add(r)}),gg.empty||(gg.sort(t),Wo.set(t.near,Math.min(e.near,t.far)),gg.forEachInDepthRange(Wo,Kc.DepthOrder.FRONT_TO_BACK,(r,n)=>{n<e.near&&pN(e,t,r)}),Wo.set(Math.max(e.far,t.near),t.far),gg.forEachInDepthRange(Wo,Kc.DepthOrder.BACK_TO_FRONT,(r,n,s)=>{e.far=Math.max(e.far,s)}))}function pN(e,t,i){if(!i.visible||!Gg(t.frustum,i.boundingVolumeWorldSpace.bounds))return;let r=i.transformation,n=Rre;i.geometries.forEach(s=>{lo(n,r,s.transformation);let o=H0(n);B6(e,t,s.boundingInfo,n,o)})}function B6(e,t,i,r,n){if(i==null)return;si(Br,i.center,r);let{eye:s,viewForward:o}=t,a=o[0]*(Br[0]-s[0])+o[1]*(Br[1]-s[1])+o[2]*(Br[2]-s[2]);if(Br[3]=i.radius*n,!(a-Br[3]>e.near&&a+Br[3]<e.far)&&Gg(t.frustum,Br))if(i.radius>hN&&i.getChildren())for(let l of i.getChildren())B6(e,t,l,r,n);else _N.unionDepthRangeWithAABB(e,t.viewProjectionMatrix,r,i.bbMin,i.bbMax)}function k6(e,t,i){let r=t.eye,n=t.viewForward,s=(i[0]-r[0])*n[0]+(i[1]-r[1])*n[1]+(i[2]-r[2])*n[2];e.near=Math.min(e.near,s-i[3]),e.far=Math.max(e.far,s+i[3])}var mN=class{constructor(){this._items=new Nt({allocator:t=>t||{object:null,distance:0,near:0,far:0},deallocator:t=>(t.object=null,t.distance=0,t.near=0,t.far=0,t)})}get length(){return this._items.length}get empty(){return this._items.length===0}clear(){this._items.clear()}add(t){this._items.pushNew().object=t}sort(t){let i=t.eye,r=t.viewForward;this._items.forAll(n=>{let s=n.object.boundingVolumeWorldSpace.bounds,o=(s[0]-i[0])*r[0]+(s[1]-i[1])*r[1]+(s[2]-i[2])*r[2];n.distance=o,n.near=o-s[3],n.far=o+s[3]}),this._items.sort((n,s)=>n.distance-s.distance)}forEachInDepthRange(t,i,r){if(i===Kc.DepthOrder.FRONT_TO_BACK)for(let n=0;n<this._items.length;++n){let s=this._items.data[n];s.far<t.near||s.near>t.far||r(s.object,s.near,s.far)}else for(let n=this._items.length-1;n>=0;--n){let s=this._items.data[n];s.far<t.near||s.near>t.far||r(s.object,s.near,s.far)}}},fN=class{constructor(){this._geometries=new Array,this._near=[],this._far=[],this._nearCandidates=[],this._farCandidates=[],this._looseRange=new Wr(0,0)}compute(t,i,r){this._reset();let{viewMatrix:n}=t;i.forAll(c=>{c.forEachGeometry(h=>{if(!h.visible||r===q1.SHADOW_CASTERS&&!h.castShadow)return;let p=h.boundingSphere,m=n[2]*p[0]+n[6]*p[1]+n[10]*p[2]+n[14],f=m-p[3],g=m+p[3];this._geometries.push(h),this._near.push(-g),this._far.push(-f)})});let s=new Wr;if(this._geometries.length===0)return s;for(let c=0;c<this._geometries.length;++c)this._near[c]>s.far&&(s.far=this._near[c]),this._near[c]>2&&this._far[c]<s.near&&(s.near=this._far[c]);let o=this._looseRange;o.near=Math.max(.5*s.near,2),o.far=2*s.far;let a=0,l=0;for(let c=0;c<this._geometries.length;++c)this._near[c]<s.near&&(this._near[c]>=o.near?s.near=this._near[c]:this._nearCandidates[a++]=c),this._far[c]>s.far&&(this._far[c]<=o.far?s.far=this._far[c]:this._farCandidates[l++]=c);if(this._nearCandidates.length===0&&this._farCandidates.length===0)return s;this._nearCandidates.sort((c,h)=>this._near[c]<this._near[h]?-1:this._near[c]>this._near[h]?1:0),this._farCandidates.sort((c,h)=>this._far[c]<this._far[h]?1:this._far[c]>this._far[h]?-1:0);for(let c=0;c<this._nearCandidates.length;++c){let h=this._nearCandidates[c];if(this._near[h]<s.near){let p=this._geometries[h],{boundingInfo:m,shaderTransformation:f}=p;this._includeNearBoundingInfoRec(t,m,f,s)}}for(let c=0;c<this._farCandidates.length;++c){let h=this._farCandidates[c];if(this._far[h]>s.far){let p=this._geometries[h],{boundingInfo:m,shaderTransformation:f}=p;this._includeFarBoundingInfoRec(t,m,f,s)}}return this._reset(),s}_reset(){this._geometries.length=0,this._near.length=0,this._far.length=0,this._nearCandidates.length=0,this._farCandidates.length=0}_isOutsideSidePlanes(t,i){let r=t,n=_F(t);return i[0][0]*r[0]+i[0][1]*r[1]+i[0][2]*r[2]+i[0][3]>n||i[1][0]*r[0]+i[1][1]*r[1]+i[1][2]*r[2]+i[1][3]>n||i[2][0]*r[0]+i[2][1]*r[1]+i[2][2]*r[2]+i[2][3]>n||i[3][0]*r[0]+i[3][1]*r[1]+i[3][2]*r[2]+i[3][3]>n}_includeNearBoundingInfoRec(t,i,r,n){if(i==null)return;let s=i.center;si(Br,s,r),Br[3]=i.radius*H0(r);let{frustum:o}=t;if(this._isOutsideSidePlanes(Br,o))return;let a=Br[0],l=Br[1],c=Br[2],h=Br[3],{viewMatrix:p}=t,m=p[2]*a+p[6]*l+p[10]*c+p[14],f=m+h;if(!(-(m-h)<2||-f>=n.near))if(-f>this._looseRange.near)n.near=-f;else{if(h>hN){let g=i.getChildren();if(g!==void 0){for(let _ of g)this._includeNearBoundingInfoRec(t,_,r,n);return}}_N.unionDepthRangeWithAABB(n,t.viewProjectionMatrix,r,i.bbMin,i.bbMax)}}_includeFarBoundingInfoRec(t,i,r,n){if(i==null)return;let s=i.center;si(Br,s,r),Br[3]=i.radius*H0(r);let{frustum:o}=t;if(this._isOutsideSidePlanes(Br,o))return;let[a,l,c,h]=Br,{viewMatrix:p}=t,m=p[2]*a+p[6]*l+p[10]*c+p[14]-h;if(!(-m<=n.far))if(-m<this._looseRange.far)n.far=-m;else{if(h>hN){let f=i.getChildren();if(f!==void 0){for(let g of f)this._includeFarBoundingInfoRec(t,g,r,n);return}}_N.unionDepthRangeWithAABB(n,t.viewProjectionMatrix,r,i.bbMin,i.bbMax)}}},gN=class{constructor(){this._modelViewProj=Wt(),this._clipPosition=[Qi(),Qi(),Qi(),Qi(),Qi(),Qi(),Qi(),Qi()]}unionDepthRangeWithAABB(t,i,r,n,s){let o=this._modelViewProj;lo(o,i,r);let a=!1;for(let l=0;l<8;++l){let c=this._clipPosition[l],h=l===0||l===3||l===4||l===7?n[0]:s[0],p=l===0||l===1||l===4||l===5?n[1]:s[1],m=l<4?n[2]:s[2];c[0]=o[0]*h+o[4]*p+o[8]*m+o[12],c[1]=o[1]*h+o[5]*p+o[9]*m+o[13],c[2]=o[2]*h+o[6]*p+o[10]*m+o[14],c[3]=o[3]*h+o[7]*p+o[11]*m+o[15]}for(let l=0;l<12;++l){let c=Are(this._clipPosition[dN[l][0]],this._clipPosition[dN[l][1]],this._clipPosition[dN[l][2]]),h=!0;for(let p=0;p<c.length;++p)if(c[p][3]>=2){h=!1;break}if(!h){a=!0;for(let p=0;p<c.length;++p){let m=c[p][3];Number.isFinite(m)&&(t.near=Math.min(m,t.near),t.far=Math.max(m,t.far))}}}return a}};function Are(e,t,i){let r=[e,t,i];for(let n=0;n<4;++n){let s=r;r=[];for(let o=0;o<s.length;++o){let a=s[o],l=s[(o+1)%s.length];uN(l,n)?(uN(a,n)||r.push(V6(a,l,n)),r.push(l)):uN(a,n)&&r.push(V6(a,l,n))}}return r}function uN(e,t){return t===0?e[0]>=-e[3]:t===1?e[1]>=-e[3]:t===2?e[0]<=e[3]:t===3?e[1]<=e[3]:void en(!1)}function V6(e,t,i){let r=0;return i===0?r=(-e[3]-e[0])/(t[0]-e[0]+t[3]-e[3]):i===1?r=(-e[3]-e[1])/(t[1]-e[1]+t[3]-e[3]):i===2?r=(e[3]-e[0])/(t[0]-e[0]-t[3]+e[3]):i===3&&(r=(e[3]-e[1])/(t[1]-e[1]-t[3]+e[3])),pL(Qi(),e,t,r)}var dN=[[0,1,3],[2,3,1],[1,5,2],[6,2,5],[5,4,6],[7,6,4],[4,0,7],[3,7,0],[3,2,7],[6,7,2],[4,5,0],[1,0,5]],Br=cr(),Rre=Wt(),Wo=new Wr,gg=new mN,Pre=new fN,_N=new gN;var U6={idleOpacity:.8,navigatingOpacity:.4,maxDelta:.1,tiltFadeStart:20,tiltFadeEnd:30,altitudeStart:1e4,altitudeEnd:2e4};var W1=class{constructor(t){this._fbos=t,this._requiresEmission=!1,this._size=new SV(0,0),this._clearColor=Qi()}dispose(){this._color=ki(this._color),this.releaseDepth()}initialize(t,i,r,n){this._size.width=t,this._size.height=i,Jp(this._size,this._fbos.rctx.parameters.maxTextureSize);let s=this._color;return this._color=null,this.releaseDepth(),this._requiresEmission=n,Ap(this._clearColor,r),s}releaseDepth(){this._color?.detachDepth(),this._depth=ki(this._depth)}update(t){let i=this._ensureColor();i.attachDepth(this.depth),this._color=t(i)}bind(){let t=this._color==null;if(this.color.attachDepth(this.depth),this._fbos.rctx.bindFramebuffer(this.color.fbo),t){let i=this._fbos.rctx;i.setClearStencil(0),i.setClearColor(this._clearColor[0],this._clearColor[1],this._clearColor[2],this._clearColor[3]),i.clear(Ti.COLOR|Ti.DEPTH|Ti.STENCIL),this._requiresEmission&&i.gl.clearBufferfv(i.gl.COLOR,1,cw)}}_acquireColor(){return this._requiresEmission?this._fbos.acquire(this._size.width,this._size.height,"acquired-color").acquireColor(lr.COLOR_ATTACHMENT1,Pi.RGBA,"emissive"):this._fbos.acquire(this._size.width,this._size.height,"acquired-color")}_acquireDepth(){return this._fbos.acquireDepth(wr.DEPTH_STENCIL_TEXTURE,this._size.width,this._size.height,"depth")}get size(){return this._size}get color(){return this._ensureColor()}get depth(){return this._depth??=this._acquireDepth(),this._depth}_ensureColor(){return this._color??=this._acquireColor(),this._color}};var $1=class{constructor(){this._inputs=new Map}set(t,i){this._inputs.set(t,i)}get(t){return this._inputs.get(t)}has(t){return this._inputs.has(t)}release(t){this._inputs.get(t)?.release()&&this._inputs.delete(t)}};var Nv=class extends ft{constructor(t,i){super(t,i,new mt(xH,()=>import("./chunk-DLO2QMVX.js"))),this.primitiveType=Jt.TRIANGLE_STRIP}initializePipeline(){return Tt({blending:Ga,colorWrite:St,depthTest:null,depthWrite:null})}};var j6=4e4,z6=5e4,yN=1/512,Lv=class extends P{constructor(e,t,i,r){super({}),this._techniques=e,this._rctx=t,this._data=i,this._requestRender=r,this._passParameters=new DH(this._data),this._configuration=new EH,this._enabled=!1,this._vao=yn(t)}dispose(){this._stop(),this._vao=We(this._vao)}precompile(){this._showVisualization&&this._techniques.precompile(Nv,this._configuration)}render(e){if(!this._showVisualization)return;this._passParameters.sampleScale=1/this._data.computedSamples;let t=this._techniques.get(Nv,this._configuration);this._rctx.bindVAO(this._vao),this._rctx.bindTechnique(t,e,this._passParameters),this._rctx.drawArrays(t.primitiveType,0,sa(this._vao,"geometry"))}setOptions(e){e.enabled!==void 0&&this._setEnabled(e.enabled),e.color!==void 0&&this._setColor(e.color),e.threshold!==void 0&&(this._threshold=e.threshold),e.visualization!==void 0&&(this._visualization=e.visualization),e.bandSize!==void 0&&(this._bandSize=e.bandSize),e.bandsEnabled!==void 0&&(this._bandsEnabled=e.bandsEnabled)}get opacityFromElevation(){return this._passParameters.opacityFromElevation}set opacityFromElevation(e){this._passParameters.opacityFromElevation!==e&&(this._passParameters.opacityFromElevation=e,this.notifyChange("opacityFromElevation"))}get _showVisualization(){return this._enabled&&this._data.computedSamples>0&&this.opacityFromElevation>yN}get _threshold(){return this._passParameters.threshold}set _threshold(e){this._threshold!==e&&(this._passParameters.threshold=e,this._requestRenderIfEnabled())}get _visualization(){return this._configuration.visualization}set _visualization(e){e!==this._visualization&&(this._configuration.visualization=e,this._requestRenderIfEnabled())}get _bandSize(){return this._passParameters.bandSize}set _bandSize(e){e!==this._bandSize&&(this._passParameters.bandSize=e,this._requestRenderIfEnabled())}get _bandsEnabled(){return this._configuration.bandsEnabled}set _bandsEnabled(e){e!==this._bandsEnabled&&(this._configuration.bandsEnabled=e,this._requestRenderIfEnabled())}_setColor(e){let t=this._passParameters.color;mL(e,t)||(Ap(this._passParameters.color,e),this._requestRenderIfEnabled())}_setEnabled(e){e!==this._enabled&&(e?this._start():this._stop())}_requestRenderIfEnabled(){this._enabled&&this._requestRender()}_start(){this._enabled=!0,this._requestRender()}_stop(){this._enabled=!1,this._requestRender()}};u([d()],Lv.prototype,"opacityFromElevation",null),Lv=u([C("esri.views.3d.webgl-engine.lib.ShadowCastRenderer")],Lv);var Fv=class extends ft{constructor(t,i){super(t,i,new mt(TH,()=>import("./chunk-SLTB22ZT.js"))),this.primitiveType=Jt.TRIANGLE_STRIP}initializePipeline(){return Tt({blending:BF,colorWrite:St,depthTest:null,depthWrite:null})}};var Rn=class extends P{constructor(e,t,i,r,n,s){super({}),this.fbos=e,this._techniques=t,this._stage=i,this._prepareForShadowMapPass=r,this._renderToShadowMap=n,this._requestRender=s,this._progress=0,this._sampleCount=0,this._passParameters=new Y0,this._cachedLightDirections=[],this._depthRange=Wr.zero,this._previewing=!1,this._cameraForcedForScreenshot=!1,this._shadowAccumulatorKey="shadowAccumulator",this._rctx=e.rctx,this._bindParameters=new vw(new ww(e,i.viewingMode)),this._bindParameters.shadowMap.enabled=!0,this._vao=yn(this._rctx),this._accumulationRenderer=new Lv(t,this._rctx,this,s);let o=this._stage.view.resourceController.scheduler;this.addHandles([o.registerTask(Xt.SHADOW_ACCUMULATOR,this),S(()=>i.renderView,a=>{this.removeHandles(G6),a!=null&&this.addHandles(a.events.on("force-camera-for-screenshot",()=>this._cameraForcedForScreenshot=!0),G6)},Ce),S(()=>this._previewing,()=>this._requestRenderIfEnabled(),Fe)],this._shadowAccumulatorKey),t.precompile(Fv)}normalizeCtorArgs(){return{}}dispose(){this._disable(),this.removeHandles(this._shadowAccumulatorKey),this._accumulationRenderer=We(this._accumulationRenderer),this._bindParameters.shadowMap.dispose(),this._fbo=We(this._fbo),this._vao=We(this._vao),this._cachedLightDirections.length=0,this._sampleCount=0}get computedSamples(){return this._progress}get shadowCastTexture(){return this._fbo?.colorTexture}get accumulating(){return this._active&&this._previewing||this._refining}get _refining(){return this._active&&!this._doneAccumulating&&!this._previewing}get _active(){return this._fbo!=null&&this._sampleCount>0}get canAccumulate(){return this._bindParameters.depth!=null&&this._depthRange!==Wr.zero&&this._opacityFromElevation>yN}get _doneAccumulating(){return this._progress>=this._sampleCount}get _lightDirections(){return this._cachedLightDirections}set _lightDirections(e){let t=this._cachedLightDirections;if(Kv(t,e,zc))return;let i=Math.min(CH,e.length);t.length=i,this._sampleCount=i;for(let r=0;r<i;++r)t[r]=ee(t[r]??w(),e[r]);this._invalidate()}get _opacityFromElevation(){return this._accumulationRenderer.opacityFromElevation}set _opacityFromElevation(e){this._accumulationRenderer.opacityFromElevation=e}get running(){return this._refining&&this.canAccumulate&&this._progress>0}runTask(e){for(this._prepareForShadowMapPass(this._bindParameters);!e.done&&!this._doneAccumulating;)this._accumulateShadow(),e.madeProgress();this._requestRender()}renderAccumulation(e,t,i,r){if(this._depthRange=t,this._updateCamera(i),this._bindParameters.contentCamera=r,this._bindParameters.depth=e,this._passParameters.origin=this._bindParameters.camera.center,this.notifyChange("canAccumulate"),!this.accumulating||!this.canAccumulate)return!1;(this._previewing||this._progress===0||this._cameraForcedForScreenshot)&&this._clear();let n=this._cameraForcedForScreenshot?this._sampleCount:Math.min(Ore,this._sampleCount);n-=this._progress;for(let s=0;s<n;++s)this._accumulateShadow(),this._requestRender();return this._cameraForcedForScreenshot=!1,n>0}precompile(){this._accumulationRenderer.precompile()}render(e){this._accumulationRenderer.render(e)}setOptions(e){if(e.enabled!==void 0){let t=this._fbo!=null;e.enabled!==t&&(e.enabled?this._enable():this._disable())}e.previewing!==void 0&&(this._previewing=e.previewing),e.lightDirections!==void 0&&(this._lightDirections=e.lightDirections),this._accumulationRenderer.setOptions(e)}readAccumulatedShadow(e,t){return!this._active||!this._fbo||this._progress<1||e<0||e>=this._fbo.width||t<0||t>=this._fbo.height?0:(this._fbo.readPixels(e,t,1,1,mi.RGBA,Ba.UNSIGNED_BYTE,q6),q6[0]/this._progress)}_enable(){this._progress=0;let e=new vi;e.pixelFormat=mi.RED,e.internalFormat=Gc.R8,e.wrapMode=ji.CLAMP_TO_EDGE,this._fbo=new $a(this._rctx,e),this._requestRender()}_disable(){this._fbo=We(this._fbo),this._requestRender()}_invalidate(){this._progress=0,this._requestRenderIfEnabled()}_clear(){this._rctx.bindFramebuffer(this._fbo),this._rctx.setClearColor(0,0,0,0),this._rctx.clear(Ti.COLOR),this._progress=0}_accumulateShadow(){this._renderToShadowMap(this._bindParameters,this._lightDirections[this._progress++],this._depthRange);let e=this._techniques.get(Fv);this._rctx.bindFramebuffer(this._fbo),this._rctx.bindTechnique(e,this._bindParameters,this._passParameters),this._rctx.bindVAO(this._vao),this._rctx.drawArrays(e.primitiveType,0,sa(this._vao,"geometry"))}_updateCamera(e){let t=this._fbo;if(t==null)return;let i=this._bindParameters.camera;e.equals(i)||i.copyFrom(e),t.resize(e.fullWidth,e.fullHeight),this._opacityFromElevation=1-Vl(j6,z6,e.relativeElevation)}_requestRenderIfEnabled(){this._fbo&&this._requestRender()}get test(){}};u([d()],Rn.prototype,"_progress",void 0),u([d()],Rn.prototype,"_sampleCount",void 0),u([d()],Rn.prototype,"_fbo",void 0),u([d()],Rn.prototype,"_depthRange",void 0),u([d()],Rn.prototype,"_previewing",void 0),u([d()],Rn.prototype,"_accumulationRenderer",void 0),u([d()],Rn.prototype,"_refining",null),u([d()],Rn.prototype,"_active",null),u([d()],Rn.prototype,"canAccumulate",null),u([d()],Rn.prototype,"_doneAccumulating",null),u([d()],Rn.prototype,"_opacityFromElevation",null),u([d()],Rn.prototype,"running",null),Rn=u([C("esri.views.3d.webgl-engine.lib.ShadowAccumulator")],Rn);var Ore=6,G6="renderView",q6=new Uint8Array(4);var Nre=Wg(),Z1=class{constructor(){this._plane=Wg()}get plane(){return this._plane}set plane(t){Gp(t||Nre,this._plane)}};function W6(e,t){let i=e.capabilities.disjointTimerQuery;return i==null?null:new vN(i,t)}var vN=class{constructor(t,i){this._timer=t,this._queryPool=new Array,this._queryResults=new Map,this._currentQuery=null,i.forEach(r=>{let n=this._timer.createQuery(),s=this._timer.createQuery();this._queryPool.push(n,s),this._queryResults.set(r,null)})}start(){Xk||(this._currentQuery=this._queryPool.pop(),this._currentQuery!=null&&(this._timer.disjoint(),this._timer.beginTimeElapsed(this._currentQuery)))}stop(t){if(this._timer.disjoint()||this._currentQuery==null||!this._queryResults.has(t))return this.abort(),null;this._timer.endTimeElapsed();let i=this._queryResults.get(t);if(i==null)return this._queryResults.set(t,this._currentQuery),this._currentQuery=null,null;if(!this._timer.resultAvailable(i))return this._queryPool.unshift(this._currentQuery),this._currentQuery=null,null;let r=this._timer.getResult(i)/1e6;return this._queryPool.unshift(i),this._queryResults.set(t,this._currentQuery),this._currentQuery=null,r}abort(){this._currentQuery!=null&&(this._timer.deleteQuery(this._currentQuery),this._queryPool.unshift(this._timer.createQuery()),this._currentQuery=null)}dispose(){this._currentQuery!=null&&this._timer.deleteQuery(this._currentQuery),this._queryPool.forEach(t=>{this._timer.deleteQuery(t)}),this._queryResults.forEach(t=>{t!=null&&this._timer.deleteQuery(t)})}};var Ri;(function(e){e.OVERLAY="overlay",e.PREPARE="prepare",e.SHADOW_MAP="shadow map",e.DEPTH="depth",e.ACCUMULATED_SHADOWS="accumulated shadows",e.APPLY_ACCUMULATED_SHADOWS="apply accumulated shadows",e.OBJECT_AND_LAYER_ID_COLOR="object/layer id color",e.NORMALS="normals",e.SSAO="SSAO",e.HIGHLIGHTS="highlights",e.OPAQUE_EDGES="opaque edges",e.VOXEL="voxel",e.TRANSPARENT="transparent",e.TRANSPARENT_EDGES="transparent edges",e.HUD_VISIBILITY="HUD visibility",e.TRANSPARENT_TERRAIN="transparent terrain",e.TRANSPARENT_MATERIAL_WITHOUT_DEPTH="transparent material without depth",e.OPAQUE_ENVIRONMENT="opaque environment",e.TRANSPARENT_ENVIRONMENT="transparent environment",e.OCCLUDED="occluded",e.HUD="HUD",e.HUD_OCCLUDED="HUD occluded",e.FINISH="finish",e.FOCUS_AREA_MASK="focus area mask"})(Ri||(Ri={}));var wN=Object.values(ti).concat(Object.values(Oe)).concat(Object.values(Ri)),$6="Total",Q1=class{constructor(t){this._rctx=t,this._startTimeStampCPU=0,this._lastTimeStampCPU=0,this._totalCPUTime=new Sg($6),this._cpuTimeSamplers=new Map(wN.map(i=>[i,new Sg(i)])),this._enableGPUTimer=0,this._totalGPUTime=new Sg("GPU"),this._gpuTimeSamplers=new Map(wN.map(i=>[i,new Sg(i)])),this._totalTime=0,this._totalFrameCount=0}get totalCPUTimeSampler(){return this._totalCPUTime}get cpuTimeSamplers(){return Array.from(this._cpuTimeSamplers.values())}get totalGPUTimeSampler(){return this._totalGPUTime}get gpuTimeSamplers(){return Array.from(this._gpuTimeSamplers.values())}get gpuSamplingEnabled(){return this._gpuTimerPool!=null}get totalTime(){return this._totalTime}get totalFrameCount(){return this._totalFrameCount}get elapsedTime(){return performance.now()-this._startTimeStampCPU}enableGPUPerformanceInfo(){if(this._gpuTimerPool==null){let i=[...wN,$6];this._gpuTimerPool=W6(this._rctx,i)}if(this._gpuTimerPool==null)return{hasGPUTimerSupport:!1,remove:()=>{}};++this._enableGPUTimer;let t=!1;return{hasGPUTimerSupport:!0,remove:()=>{t||(t=!0,--this._enableGPUTimer,this._enableGPUTimer===0&&(this._gpuTimerPool=We(this._gpuTimerPool)))}}}startFrame(){this._startTimeStampCPU=this._lastTimeStampCPU=performance.now(),this._gpuTimerPool&&(this._gpuTimeSamplers.forEach(t=>t.push(0)),this._gpuTimerPool.start())}advance(t){let i=performance.now();if(this._cpuTimeSamplers.get(t).push(i-this._lastTimeStampCPU),this._lastTimeStampCPU=i,this._gpuTimerPool){let r=this._gpuTimerPool.stop(t);this._gpuTimeSamplers.get(t).set(r),this._gpuTimerPool.start()}}finishFrame(){if(this._gpuTimerPool){let i=this._gpuTimerPool.stop(Ri.FINISH);this._gpuTimeSamplers.get(Ri.FINISH).set(i),this._rctx.gl.flush()}let t=performance.now()-this._startTimeStampCPU;this._totalTime=this._totalTime+t,this._totalCPUTime.push(t),this._gpuTimerPool&&this._totalGPUTime.push(this.gpuTimeSamplers.reduce((i,r)=>i+(r.last||0),0)),++this._totalFrameCount}};var lp=class{constructor(t,i,r,n,s,o){this._stage=t,this._techniques=r,this._rctx=n,this._compositingHelper=s,this._requestRender=o,this._pluginsHas={hudElements:!1,water:!1},this._renderers=new Map,this.renderPassManager=new H1,this._isRendering=!1,this._inGlobeView=!1,this._backgroundColor=fn(0,0,0,1),this._sliceHelper=new Z1,this._blit=null,this._oitblend=null,this._state=On(pi.IDLE),this._highQualityTransparencyEnabled=!0,this._ssrEnabled=!1,this._hasAnimations=!1,this._animationTimestep=new G1,this._loadEdgeViewTask=null,this._edgeViewCallbacks=[],this._reprojectionMatrixVersion=On(0),this._lastFrameTime=0,this._renderHiddenTransparentEdges=()=>{},this._pluginInput=new $1,this._releaseNormals=a=>{a.some(({name:l})=>l==="normals")&&this._pluginInput.release("normals")},this._debugNeedsDepth=!1,this.fboCache=new P1(n),this._renderStateFeatures=On(RM(!Ct("disable-feature:high-quality-idle"),t.view.qualityProfile)),this._framebuffer=new W1(this.fboCache),this.performanceInfo=new Q1(this._rctx),this._shadowMap=new ww(this.fboCache,t.viewingMode),this._shadowAccumulator=new Rn(this.fboCache,r,t,a=>{let l=this.shadowsEnabled;this._shadowMap.enabled=!0,this._ensureBindParametersCamera(a.camera,a.contentCamera),this._plugins.prepareRender(),this._shadowMap.enabled=l},(a,l,c)=>{let h=this._stage.view.qualitySettings.maximumPixelRatio;a.shadowMap.start(a.camera,l,c,!0,h),this._renderShadowCascades(oe.Shadow,a.shadowMap),a.shadowMap.finish(),a.camera.setGLViewport(this._rctx),this._ensureBindParametersCamera(a.camera,a.contentCamera)},o),this._renderContext=new IV(this._rctx,this._shadowMap,r),this._nodes=new B1(this._renderContext),this._plugins=new U1({renderContext:this._renderContext,techniques:r,materials:i,requestRender:o,controller:t,fbos:this.fboCache,isFeatureEnabled:a=>this.isFeatureEnabled(a)}),this._plugins.add(this.renderPassManager),this._handles=[S(()=>this._stage.view.state.camera,()=>o(),Ce),S(()=>ur.EDGES_SHOW_HIDDEN_TRANSPARENT_EDGES,a=>{this._renderHiddenTransparentEdges=a?()=>this._renderEdges(Nd.TRANSPARENT):()=>{},o()},Re),S(()=>this._stage.view.environment.background?.color,a=>{let l=a?kp(a):gn;ho(this._backgroundColor,l[0]*l[3],l[1]*l[3],l[2]*l[3],l[3]),o()},Ce),S(()=>this._stage.view.state.camera.relativeElevation,a=>this._inGlobeView=(a??1/0)>=5e5,Ce),S(()=>this._bindParameters.clouds.fadeFactor,()=>this._bindParameters.fadeLighting(),Fe),S(()=>this._bindParameters.clouds.data?.state,()=>o(),Fe),S(()=>this._stage.view.state.highlights,a=>{this._bindParameters.highlights=a,this._updateHighlights(),o()},Re)]}destroy(){this._handles.forEach(t=>t.remove()),this._gpuTimerHandle=Ft(this._gpuTimerHandle),this._nodes.destroy(),this._framebuffer.dispose(),this._shadowMap.dispose(),this._shadowAccumulator.dispose(),this._loadEdgeViewTask=xr(this._loadEdgeViewTask),this._edgeView=G(this._edgeView),this.renderPassManager.dispose(),this._releaseFBOs(),this._disposeOffscreenBuffers(),this.fboCache.destroy(),this._plugins.destroy(),this._renderers.clear(),this._blit=null,this._oitblend=null,hk.prune(),IM.prune(),AL()}get renderContext(){return this._renderContext}get _bindParameters(){return this._renderContext.bind}get _framebufferSize(){return this._framebuffer.size}updateRenderFeatures(t=null,i=!Ct("disable-feature:high-quality-idle")){this._renderStateFeatures.value=RM(i,t),this._requestRender()}isFeatureEnabled(t,i=this._state.value){return this._renderStateFeatures.value.get(i,t)??!1}setFeatureEnabled(t,i,r){this._renderStateFeatures.mutate(n=>n.set(i,t,r)),this._requestRender()}get _highQualityTransparency(){return this._highQualityTransparencyEnabled||this.isFeatureEnabled(bo.HighQualityTransparency)}get hasReflections(){return this._pluginsHas.water&&(this._ssrEnabled||this.isFeatureEnabled(bo.WaterReflection))}get _hasHighlights(){return this._plugins.produces(oe.Highlight,me.OPAQUE_MATERIAL,me.TRANSPARENT_MATERIAL,me.DRAPED_MATERIAL,me.HUD_MATERIAL,me.LABEL_MATERIAL)}hasHighlightOptions(t){return this._plugins.hasHighlightOptions(t)}get _hasHUDHighlights(){return this._plugins.produces(oe.Highlight,me.HUD_MATERIAL,me.LABEL_MATERIAL)}get hasSSAO(){return(this._stage.view.qualitySettings.ambientOcclusion||this.isFeatureEnabled(bo.SSAO))&&!this._inGlobeView}get hasSMAA(){return this._stage.view.qualitySettings.antialiasingEnabled||this.isFeatureEnabled(bo.Antialiasing)}get fullResolutionAtmosphere(){return this._stage.view.qualitySettings.highResolutionAtmosphere||this.isFeatureEnabled(bo.HighResolutionAtmosphere)}_releaseFBOs(){this._bindParameters.ssr.lastFrameColor=ki(this._bindParameters.ssr.lastFrameColor),this._bindParameters.terrainDepth=ki(this._bindParameters.terrainDepth),this._bindParameters.geometryDepth=ki(this._bindParameters.geometryDepth)}_disposeOffscreenBuffers(){this._framebuffer.dispose(),this._disposeBindBuffers()}_disposeBindBuffers(){this._shadowMap.disposeOffscreenBuffers(),this._bindParameters.depth=ki(this._bindParameters.depth),this._bindParameters.hudVisibility=ki(this._bindParameters.hudVisibility)}get updating(){return this._edgeView!=null&&this._edgeView.updating||this._shadowAccumulator.running||this._plugins.updating||!this.isCameraFinal}loadEdgeView(){return this._loadEdgeViewTask||(this._loadEdgeViewTask=hn(async t=>{let{EdgeView:i}=await import("./chunk-TEPFLNMP.js");Ht(t);let r=this._edgeView=new i({rctx:this._rctx,renderSR:this._stage.view.renderSpatialReference,viewingMode:this._stage.viewingMode,techniques:this._techniques,setNeedsRender:()=>this._requestRender(),schedule:Hre(this._stage.view.resourceController)});return this._handles.push(S(()=>r.updating,()=>this._requestRender(),Fe)),this._requestRender(),this._edgeViewCallbacks.forEach(n=>n(r)),this._edgeViewCallbacks.length=0,r})),this._loadEdgeViewTask.promise}withEdgeView(t){this.loadEdgeView(),this._edgeView==null?this._edgeViewCallbacks.push(t):t(this._edgeView)}get edgeView(){return this._edgeView}get isCameraFinal(){return this._reprojectionMatrixVersion.value>=0&&Y2(this._bindParameters.ssr.reprojectionMatrix,Wc)}set _reprojectionMatrix(t){zN(this._bindParameters.ssr.reprojectionMatrix,t)&&this._reprojectionMatrixVersion.value++}get shadowsEnabled(){return!!this._shadowMap?.enabled}setParameters(t){let{_shadowMap:i,_bindParameters:r}=this;if(t.qualitySettings?.reflections!==void 0&&this._ssrEnabled!==t.qualitySettings.reflections&&(this._ssrEnabled=t.qualitySettings.reflections,this._requestRender()),t.shadowMap!==void 0&&this._shadowMap.enabled!==t.shadowMap&&(this._shadowMap.enabled=t.shadowMap,this._requestRender()),t.shadowMapMaxCascades!==void 0&&i.maxCascades!==t.shadowMapMaxCascades&&(i.maxCascades=t.shadowMapMaxCascades,this._requestRender()),t.environment!=null){t.environment.weather!=null&&(this._bindParameters.weather=t.environment.weather,this._bindParameters.weatherVisible=!!t.weatherVisible);let n=t.environment.lighting.type!=="virtual";r.enableFillLights!==n&&(r.enableFillLights=n,this._requestRender())}t.highQualityTransparency!==void 0&&this._highQualityTransparencyEnabled!==t.highQualityTransparency&&(this._highQualityTransparencyEnabled=t.highQualityTransparency,this._requestRender()),t.shadowCast!==void 0&&this._shadowAccumulator.setOptions(t.shadowCast)}set slicePlane(t){this._sliceHelper.plane!==t&&(this._sliceHelper.plane=t,this._requestRender())}get plugins(){return this._plugins}getMaterialRenderer(t){return this._renderers.get(t)}get _hasOITSupport(){return this._rctx.driverTest.floatBufferBlend.result}get _oitEnabled(){return this._highQualityTransparency&&this._hasOITSupport}modify(t,i){this._isRendering&&console.warn("Renderer.modify called while rendering");let{adds:r,removes:n,updates:s}=t;r.length===0&&n.length===0&&s.length===0||(RF(t).forEach((o,a)=>{if(i.done)return;let l=this._renderers.get(a);l==null&&o.adds.length>0&&(l=new IM({material:a,highlightOrderMap:this._stage.view.state.highlightOrderMap}),l.initializeRenderContext(this._plugins.context),this._plugins.add(l),this._renderers.set(a,l)),l&&(l.modify(o),l.updateHighlights(this._stage.view.state.highlightOrderMap),l.numGeometries===0&&(this._renderers.delete(l.material),this._plugins.remove(l),l.destroy())),o.removes.forEach(c=>t.removes.removeUnordered(c)),o.adds.forEach(c=>t.adds.removeUnordered(c)),o.updates.forEach(c=>t.updates.removeUnordered(c)),i.madeProgress()}),this.updateHasFlags())}updateHasFlags(){let t=this._pluginsHas;t.hudElements=this._plugins.produces(oe.Color,...Vv),t.water=this._plugins.produces(oe.Normal,me.DRAPED_WATER),this._bindParameters.hasOccludees=this._plugins.hasOccludees,this._requestRender()}updateAnimation(t,i){this._animationTimer??=new z1(t.camera,i),this._animationTimer.advance(t.camera,i,this._animationTimeDilation),t.forcedAnimationTime!=null&&this._animationTimer.forceTime(t.forcedAnimationTime);let r=this._hasAnimations;return this._hasAnimations=this._plugins.updateAnimation(this._animationTimer),this._hasAnimations=this._nodes.updateAnimation(this._animationTimer)||this._hasAnimations,this._hasAnimations!==r&&(this._gpuTimerHandle=r?Ft(this._gpuTimerHandle):this.performanceInfo.enableGPUPerformanceInfo()),this._hasAnimations}get animationTimestep(){return this._animationTimestep.value}get _animationTimeDilation(){return this._animationTimestep.timeDilation}resetAnimation(){this._animationTimestep.clear()}tick(){this.fboCache.clean()}render(t,i,r=ra.Default,n=!1){try{return this._isRendering=!0,this._render(t,i,r,n)}catch(s){console.error(`Exception during rendering: ${s}`)}finally{this._isRendering=!1}return new tv(this._pluginInput.get(ti.FINAL),null)}_updateHUDOccludedFragmentOpacity(t,i){let{idleOpacity:r,navigatingOpacity:n,maxDelta:s,tiltFadeStart:o,tiltFadeEnd:a,altitudeStart:l,altitudeEnd:c}=U6,h=this._stage.view,p=h.stateManager.camera,m=h.qualitySettings.fadeDuration,f=t===pi.IDLE?r:n,g=q((p.tilt-o)/(a-o),0,1),_=q((p.position.z??0-l)/(c-l),0,1),v=Xe(Xe(1,f,g),1,_),b=this._bindParameters.hudOccludedFragmentOpacity;if(m<=0||b===v||this._lastFrameTime===0||this._lastFrameTime>i)return this._bindParameters.hudOccludedFragmentOpacity=v,void(this._lastFrameTime=i);let x=i-this._lastFrameTime;this._lastFrameTime=i;let E=Math.min(Math.abs(r-n)*x/m,s);E>=Math.abs(v-b)?this._bindParameters.hudOccludedFragmentOpacity=v:(this._bindParameters.hudOccludedFragmentOpacity=b+Math.sign(v-b)*E,this._requestRender())}_render(t,i,r=ra.Default,n){this.performanceInfo.startFrame(),this.fboCache.frameStart(),this.fboCache.interactive=r===ra.Default,this._disposeBindBuffers();let{camera:s,contentCamera:o,mode:a,alignPixelEnabled:l}=t;this._state.value=a;let c=this._nodes.produces("magnifier-color"),h=this._nodes.produces(ti.FINAL),p=this._nodes.require("emissive",ti.FINAL,ti.COMPOSITE)>0&&this._plugins.hasEmissions,m=p?oe.ColorEmission:oe.Color;this._renderContext.time=i,this._renderContext.output=m,this._bindParameters.oitPass=Ns.NONE,this._bindParameters.alignPixelEnabled=l,this._bindParameters.decorations=!n,this._bindParameters.mainDepth=null,this._bindParameters.slicePlane=this._sliceHelper.plane,this._bindParameters.viewshedEnabled=this._nodes.produces(Oe.VIEWSHED),this._renderOverlay(i),s.setGLViewport(this._rctx);let f=this._framebuffer,g=f.initialize(s.fullWidth,s.fullHeight,this._backgroundColor,p);this.hasReflections?(g?.setName("last frame color"),this._bindParameters.ssr.lastFrameColor=g):g?.release(),this._ensureBindParametersCamera(s,o),this._updateHUDOccludedFragmentOpacity(a,i),this._plugins.prepareRender(),this._bindParameters.shadowHighlightsVisible=this._needsShadowHighlight&&!n;let _=this._highQualityTransparency&&this._hasTransparentTerrain,v=this._plugins.produces(oe.Color,...kv);this._precompilePrepasses(),this.performanceInfo.advance(Ri.PREPARE);let b=this._computeDepthRange(s);this._renderShadowMap(s,this._bindParameters.lighting.mainLight.direction,b),this._ensureBindParametersCamera(s,o),this._pluginInput.set("normals",this._renderNormals()),this._renderRemainingGeometryDepth(),this._renderShadowAccumulation(b,s,o),this._ensureBindParametersSSR(i),this._precompileShaders(_,v,m),this._renderContext.output=m,f.bind(),this._bindParameters.mainDepth=f.depth.attachment;let x=this.plugins.produces(oe.Color,...bN);x&&this._renderOpaqueGeometry(),f.update(H=>this._renderNodes(ti.OPAQUE,H,x)),this.fboCache.debugCallback?.(ti.OPAQUE,f.color.fbo),f.update(H=>this._renderNodes(Oe.OPAQUE_ENVIRONMENT,H)),this.fboCache.debugCallback?.(Oe.OPAQUE_ENVIRONMENT,f.color.fbo),this._renderTerrainDepth(_),this._renderEdges(Nd.OPAQUE),f.bind(),this._renderPlugins(me.VOXEL,Ri.VOXEL),this._renderHiddenTransparentEdges(),v&&(this._oitEnabled?this._renderOIT(yg.Geometry,m):this._renderTransparentGeometry()),f.update(H=>this._renderNodes(ti.TRANSPARENT,H,v)),this.fboCache.debugCallback?.(ti.TRANSPARENT,f.color.fbo),this._renderGeometryDepth(_),this._renderHUDVisibility(),_||this._plugins.render(this._pluginInput,me.LINE_CALLOUTS),this._renderEdges(Nd.TRANSPARENT);let E=this._hasTransparentTerrain?this._renderTransparentTerrain():null;E&&(this.performanceInfo.advance(Ri.TRANSPARENT_TERRAIN),this._bindParameters.hudVisibility&&(_?this._renderLineCallouts(Fn.Occluded):(this._rctx.bindFramebuffer(this._bindParameters.hudVisibility?.fbo),this._compositingHelper.compositeHUD(this._bindParameters,E.getTexture())),this._renderHUD(Fn.Occluded,f.color,m))),this._bindParameters.cullAboveTerrain=!1,E&&(f.bind(),this._compositingHelper.compositePreMultipliedAlpha(this._bindParameters,E.getTexture()),E.release(),_&&(this._renderEdges(Nd.OPAQUE),v&&(this._oitEnabled?this._renderOIT(yg.Geometry,m):this._renderTransparentGeometry(),this.performanceInfo.advance(Ri.TRANSPARENT)),this._renderEdges(Nd.TRANSPARENT))),this._bindParameters.ssao=ki(this._bindParameters.ssao),_&&this._renderLineCallouts(Fn.NotOccluded),this._bindParameters.terrainDepthTest=!1,this._renderTransparentEnvironment(),this._pluginInput.set(Oe.FOCUSAREA,this._renderFocusAreaGeometry()),f.update(H=>this._renderNodes(Oe.TRANSPARENT_ENVIRONMENT,H)),f.update(H=>this._renderNodes(Oe.VIEWSHED,H)),f.update(H=>this._renderNodes(Oe.LASERLINES,H)),f.update(H=>this._renderNodes(Oe.OCCLUDED,H)),this._pluginInput.set("highlights",this._renderHighlightPrepass());let D=r===ra.ObjectAndLayerID?this._renderObjectAndLayerIdColor():null;f.update(H=>this._renderNodes(ti.COMPOSITE,H)),this._pluginInput.release(Oe.FOCUSAREA);let M=!(r!==ra.Default||h||c&&!n),T=this._pluginInput.get(ti.COMPOSITE),I=M?Nl:this.fboCache.acquire(T.fbo.width,T.fbo.height,Oe.ANTIALIASING),A=this._nodes.produces(Oe.ANTIALIASING)?this._renderNodes(Oe.ANTIALIASING,I):this._blitFBO(T,I,!1),O;this._pluginInput.set(Oe.ANTIALIASING,A),this._hasHUDHighlights?(this._renderHUD(Fn.NotOccluded,A,m),O=this._renderNodes(Oe.HIGHLIGHTS,A)):(O=this._renderNodes(Oe.HIGHLIGHTS,A),this._renderHUD(Fn.NotOccluded,O,m));let $=this._renderNodes(Oe.MAGNIFIER,O);return c&&!n&&r===ra.Default&&!h&&this._blitFBO($),h?($.attachDepth(f.depth),this._blitFBO(this._renderNodes(ti.FINAL,$)),$.detachDepth()):this._pluginInput.set(ti.FINAL,$),this._pluginInput.release("highlights"),this.onPostRender&&this.onPostRender(),this._releaseFBOs(),f.releaseDepth(),this._renderContext.lastFrameCamera.copyFrom(this._bindParameters.camera),this.fboCache.frameEnd(),this.performanceInfo.finishFrame(),r!==ra.Default&&(this._releaseFBOs(),this._disposeOffscreenBuffers()),new tv(this._pluginInput.get(ti.FINAL),D)}_precompileShaders(t,i,r){if(++this._plugins.context.techniques.precompiling,this._renderContext.output=r,this._precompileOpaqueGeometry(),this._nodes.precompile(Oe.OPAQUE_ENVIRONMENT),this._bindParameters.terrainDepthTest=t,this._bindParameters.cullAboveTerrain=t,this._renderContext.output=oe.Depth,this._plugins.precompile(me.TRANSPARENT_TERRAIN),t&&(this._precompileOpaqueGeometry(),this._precompileTransparentGeometry()),this._renderContext.output=r,this._plugins.precompile(me.TRANSPARENT_TERRAIN),i&&(this._precompileTransparentGeometry(),this._hasTransparentTerrain&&(this._bindParameters.cullAboveTerrain=!1,this._precompileTransparentGeometry(),this._bindParameters.cullAboveTerrain=t)),this._nodes.precompile(Oe.FOCUSAREA),this._needsHUDVisibility&&this._plugins.precompile(me.OCCLUSION_PIXELS),this._plugins.precompile(me.LINE_CALLOUTS),this._precompileHUD(Fn.Occluded),this._bindParameters.terrainDepthTest=!1,this._bindParameters.cullAboveTerrain=!1,this._nodes.precompile(Oe.VIEWSHED,Oe.LASERLINES,Oe.OCCLUDED,Oe.ANTIALIASING,Oe.HIGHLIGHTS),this._precompileHUD(Fn.NotOccluded),this._hasHighlights){let n=this._bindParameters;n.highlights.forEach((s,o)=>{n.highlightLevel=o,this._precompileAllGeometry(oe.Highlight)}),n.highlightLevel=null}this._nodes.precompile(ti.COMPOSITE,Oe.MAGNIFIER),this._shadowAccumulator.precompile(),this._plugins.precompile(me.TRANSPARENT_MATERIAL_WITHOUT_DEPTH),--this._plugins.context.techniques.precompiling}_updateHighlights(){let t=this._stage.view.state;this._renderers.forEach(i=>i.updateHighlights(t.highlightOrderMap))}_renderFocusAreaGeometry(){if(!this._nodes.produces(Oe.FOCUSAREA))return null;let{width:t,height:i}=this._framebufferSize,r=this.fboCache.acquire(t,i,Oe.FOCUSAREA);return r=this._nodes.render(r,this._pluginInput),this.performanceInfo.advance(Ri.FOCUS_AREA_MASK),r}_renderObjectAndLayerIdColor(){if(!this._nodes.produces("olid"))return null;let t=this._renderContext.output;++this._techniques.precompiling;let i=this._framebufferSize,r=this.fboCache.acquire(i.width,i.height,"olid");return r.acquireDepth(wr.DEPTH_STENCIL_TEXTURE),r=this._nodes.render(r,this._pluginInput),--this._techniques.precompiling,this.performanceInfo.advance(Ri.OBJECT_AND_LAYER_ID_COLOR),this._renderContext.output=t,r}finish(t){this._hasAnimations||this._animationTimestep.clear();let i=this.performanceInfo.gpuSamplingEnabled,r=t===Pe.BACKGROUND;if(r||i){let n=r?this.performanceInfo.elapsedTime:0,s=0;i?s=this.performanceInfo.totalGPUTimeSampler.last:this._rctx.gl.finish();let o=Math.max(n,s);this._animationTimestep.frame(o,r)}}readMainDepth(t,i){let{mainDepth:r,camera:n}=this._bindParameters;if(!r)return;let s=this.fboCache.acquire(this._framebufferSize.width,this._framebufferSize.height,"linear-depth");this._rctx.bindFramebuffer(s.fbo),n.setGLViewport(this._rctx),this._rctx.setScissorRect(t[0],t[1],t[2],t[3]),this._rctx.setScissorTestEnabled(!0),this._rctx.clearFramebuffer(gn),this._compositingHelper.blitDepthToLinearDepth(this._bindParameters,r),this._rctx.setScissorTestEnabled(!1),this._rctx.setScissorRect(0,0,this._rctx.gl.canvas.width,this._rctx.gl.canvas.width),s.fbo?.readPixels(t[0],t[1],t[2],t[3],mi.RGBA,Ba.UNSIGNED_BYTE,i),s.release()}readHUDVisibility(t,i,r,n,s){this._bindParameters.hudVisibility?.fbo?.readPixels(t,i,r,n,mi.RGBA,Ba.UNSIGNED_BYTE,s)}readAccumulatedShadow(t){return this._shadowAccumulator.readAccumulatedShadow(t[0],t[1])}_renderEdges(t){let i=this._edgeView;if(!i?.shouldRender())return;let r=this._framebufferSize,n=this.fboCache.acquire(r.width,r.height,"edges"),s=()=>i.render(this._bindParameters,t),o=this._bindParameters.geometryDepth;this.renderToTargets(s,n,o??this._framebuffer.depth,gn),this._framebuffer.bind(),this._compositingHelper.composite(this._bindParameters,n.getTexture()),n.release(),this.performanceInfo.advance(t===Nd.OPAQUE?Ri.OPAQUE_EDGES:Ri.TRANSPARENT_EDGES)}_renderOverlay(t){this._bindParameters.overlay=this.overlay?.render(t),this._bindParameters.overlay&&this.performanceInfo.advance(Ri.OVERLAY)}_renderShadowMap(t,i,r){if(!this.shadowsEnabled)return;let n=this._shadowMap;n.start(t,i,r,this.isFeatureEnabled(bo.HighResolutionShadows),this._stage.view.qualitySettings.maximumPixelRatio),this._needsShadowHighlight?(this._renderShadowCascades(oe.ShadowHighlight,this._shadowMap),n.moveSnapshot(pM.Highlight),this._renderShadowCascades(oe.ShadowExcludeHighlight,this._shadowMap),n.copySnapshot(pM.ExcludeHighlight),this._renderShadowCascades(oe.ShadowHighlight,this._shadowMap)):this._renderShadowCascades(oe.Shadow),n.finish(),t.setGLViewport(this._rctx),this.performanceInfo.advance(Ri.SHADOW_MAP)}_precompileShadowCascades(t){for(let i of this._shadowMap.cascades)i.camera.setGLViewport(this._rctx),this._ensureBindParametersCamera(i.camera,i.camera),this._precompileAllGeometry(t)}_renderShadowCascades(t,i=this._shadowMap){for(let r of i.cascades)r.camera.setGLViewport(this._rctx),this._ensureBindParametersCamera(r.camera,r.camera),this.renderAllGeometry(t)}get _needsDepth(){return this._plugins.consumes(oe.Depth)||this._nodes.requireGeometryDepth()||this.hasReflections||this._needsShadowHighlight||this._needsShadowAccumulation||this._debugNeedsDepth}_renderRemainingGeometryDepth(){let t=this._pluginInput.get("normals");if(t){let i=this._needsDepth?t.getAttachment(Ad):null;i?.retain(),this._pluginInput.set(Oe.SSAO,this._renderSSAO()),this._renderGeometryWithoutNormalsDepth(i)}else this._renderAllGeometryDepth()}_renderGeometryWithoutNormalsDepth(t){if(!this._needsDepth||!t)return void(this._bindParameters.depth=ki(this._bindParameters.depth));let i=this._framebufferSize,r=this.fboCache.acquire(i.width,i.height,"depth");r.attachDepth(t),t.release(),this._rctx.bindFramebuffer(r.fbo),this._rctx.clear(Ti.STENCIL),this._renderGeometryWithoutNormals(oe.Depth),ki(this._bindParameters.depth),this._bindParameters.depth=r.obtainDepthTexture(),r.release(),this.performanceInfo.advance(Ri.DEPTH)}_renderAllGeometryDepth(){if(!this._needsDepth)return void(this._bindParameters.depth=ki(this._bindParameters.depth));let t=this._framebufferSize,i=this.fboCache.acquire(t.width,t.height,"depth").acquireDepth(wr.DEPTH_STENCIL_TEXTURE);this._rctx.bindFramebuffer(i.fbo),this._rctx.clear(Ti.DEPTH|Ti.STENCIL),this.renderAllGeometry(oe.Depth),ki(this._bindParameters.depth),this._bindParameters.depth=i.obtainDepthTexture(),i.release(),this.performanceInfo.advance(Ri.DEPTH)}_renderTerrainDepth(t){if(this._bindParameters.terrainDepthTest=t,this._bindParameters.cullAboveTerrain=t,!t)return void(this._bindParameters.terrainDepth=ki(this._bindParameters.terrainDepth));let i=this._renderContext.output;this._renderContext.output=oe.Depth;let r=this._framebufferSize,n=this.fboCache.acquire(r.width,r.height,"terrain depth").acquireDepth(wr.DEPTH_STENCIL_TEXTURE);this._rctx.bindFramebuffer(n.fbo),this._rctx.clear(Ti.DEPTH|Ti.STENCIL),this._renderTransparentTerrain(),ki(this._bindParameters.terrainDepth),this._bindParameters.terrainDepth=n.obtainDepthTexture(),this._renderContext.output=i,n.release()}_renderGeometryDepth(t){if(!t)return void(this._bindParameters.geometryDepth=ki(this._bindParameters.geometryDepth));let i=this._renderContext.output,{width:r,height:n}=this._framebufferSize,s=this.fboCache.acquire(r,n,"geometry depth").acquireDepth(wr.DEPTH_STENCIL_TEXTURE);this._rctx.bindFramebuffer(s.fbo),this._rctx.clear(Ti.DEPTH|Ti.STENCIL),this._renderOpaqueAndTransparentGeometry(oe.Depth),this._renderContext.output=i,ki(this._bindParameters.geometryDepth),this._bindParameters.geometryDepth=s.obtainDepthTexture(),s.release()}get _needsDepthRange(){return this._shadowMap.enabled||this._needsShadowAccumulation}_computeDepthRange(t){if(!this._needsDepthRange)return Wr.zero;let i=H6(t,this._plugins.plugins,this._stage.layers);return i.union(this._plugins.queryDepthRange(t)),i.near=Math.max(t.near,i.near),i.far=Math.min(t.far,i.far),i}get _normalsRequired(){let t=this._nodes.require("normals",ti.FINAL,ti.COMPOSITE,ti.OPAQUE,ti.TRANSPARENT,Oe.VIEWSHED,Oe.LASERLINES);return(this.hasSSAO?1:0)+t}_precompilePrepasses(){this._normalsRequired&&this._precompileAllGeometry(oe.Normal),this._needsDepth&&this._precompileAllGeometry(oe.Depth),this.shadowsEnabled&&(this._needsShadowHighlight?(this._precompileShadowCascades(oe.ShadowHighlight),this._precompileShadowCascades(oe.ShadowExcludeHighlight),this._precompileShadowCascades(oe.ShadowHighlight)):this._precompileShadowCascades(oe.Shadow)),this._needsShadowAccumulation&&this._precompileAllGeometry(oe.Shadow)}_renderNormals(){let t=this._normalsRequired;if(t===0)return;let i=this._framebufferSize,r=this.fboCache.acquire(i.width,i.height,"normals",Pi.RGBA);r.acquireDepth(wr.DEPTH_STENCIL_TEXTURE),this._rctx.bindFramebuffer(r.fbo),this._rctx.clearFramebuffer(gn,!0,!0),this._renderGeometryWithNormals(oe.Normal);let n=this._nodes.optional("normals",ti.FINAL,ti.COMPOSITE,ti.OPAQUE,ti.TRANSPARENT,Oe.VIEWSHED);return r.retain(t+n-1),this.performanceInfo.advance(Ri.NORMALS),r}_renderSSAO(){let t=this._pluginInput.get("normals");if(!this.hasSSAO||!t)return void t?.detachDepth();Nl.setName(Oe.SSAO);let i=this._nodes.render(Nl,this._pluginInput);return this._bindParameters.ssao=i,t.detachDepth(),this._pluginInput.release("normals"),this.performanceInfo.advance(Ri.SSAO),i}_precompileAllGeometry(t){let i=this._renderContext.output;this._renderContext.output=t,this._precompileOpaqueGeometry(),this._precompileTransparentGeometry(),this._plugins.precompile(me.TRANSPARENT_TERRAIN),this._renderContext.output=i}renderAllGeometry(t){this._renderContext.output=t,this._renderOpaqueAndTransparentGeometry(t),this._renderTransparentTerrain()}precompileSlots(t,...i){for(let r of i)this._bindParameters.slot=r,t.precompile(this._renderContext)}precompileOccludedSlots(t,i){for(let r of i)this._renderContext.renderOccludedMask=r,this.precompileSlots(t,...Z6);this._renderContext.renderOccludedMask=hM}renderSlots(t,...i){for(let r of i)this._bindParameters.slot=r,t.forAll(n=>{let s=n.acquireTechniques(this._renderContext);s&&n.render(this._renderContext,s,this._pluginInput)})}renderOccludedSlots(t,i){this._renderContext.renderOccludedMask=i,this.plugins.renderOccludedFlags>dr.Occlude&&this._plugins.render(this._pluginInput,me.OCCLUDED_TERRAIN),this.renderSlots(t,...Z6),this._renderContext.renderOccludedMask=hM}renderHUD(t){this._bindParameters.hudRenderStyle=t,this._plugins.render(this._pluginInput,me.HUD_MATERIAL)}precompileViewshedShadowMap(){this._precompileAllGeometry(oe.ViewshedShadow)}renderViewshedShadowMap(t){let{camera:i,contentCamera:r}=this._bindParameters,n=this._renderContext.output;t.setGLViewport(this._rctx),this._ensureBindParametersCamera(t,t),this.renderAllGeometry(oe.ViewshedShadow),this._ensureBindParametersCamera(i,r),this._bindParameters.camera.setGLViewport(this._rctx),this._renderContext.output=n}_renderOpaqueAndTransparentGeometry(t){this._renderContext.output=t,this._renderOpaqueGeometry(),this._renderTransparentGeometry()}_renderGeometryWithNormals(t){this._renderContext.output=t,this._plugins.render(this._pluginInput,...Fre),this._renderTransparentTerrain()}_renderGeometryWithoutNormals(t){this._renderContext.output=t,this._plugins.render(this._pluginInput,...kre)}_precompileOpaqueGeometry(){this._plugins.precompile(...bN)}_renderOpaqueGeometry(){this._plugins.render(this._pluginInput,...bN)}_renderTransparentGeometry(){this._plugins.render(this._pluginInput,...kv)}get _hasTransparentTerrain(){return this._plugins.produces(oe.Color,me.TRANSPARENT_TERRAIN)}_renderTransparentTerrain(){let t=()=>this._plugins.render(this._pluginInput,me.TRANSPARENT_TERRAIN);if(!W0(this._renderContext.output))return void t();let i=this._framebufferSize,r=this.fboCache.acquire(i.width,i.height,"transparent terrain");return this.renderToTargets(t,r,this._framebuffer.depth,gn),r}get _needsHUDVisibility(){return this._plugins.produces(this._renderContext.output,me.OCCLUSION_PIXELS)}_renderHUDVisibility(){if(!this._needsHUDVisibility)return void(this._bindParameters.hudVisibility=ki(this._bindParameters.hudVisibility));let{width:t,height:i}=this._framebufferSize,r=this._bindParameters.hudVisibility;r?.fbo?.width===t&&r?.fbo?.height===i||(r?.release(),r=this.fboCache.acquire(t,i,"hud visibility",Pi.RGBA4),this._bindParameters.hudVisibility=r);let n=this._bindParameters.geometryDepth;r.attachDepth(n||this._framebuffer.depth),this._rctx.bindFramebuffer(r.fbo),this._rctx.clearFramebuffer([0,1,0,1]),this._plugins.render(this._pluginInput,me.OCCLUSION_PIXELS),r.detachDepth(),this._framebuffer.bind(),this.performanceInfo.advance(Ri.HUD_VISIBILITY)}_renderLineCallouts(t){if(this._bindParameters.hudRenderStyle=t,t===Fn.Occluded){let i=()=>this._plugins.render(this._pluginInput,me.LINE_CALLOUTS),r=this._framebufferSize,n=this.fboCache.acquireDepth(wr.DEPTH16_BUFFER,r.width,r.height,"line callouts");this.renderToTargets(i,this._framebuffer.color,n,void 0,!0,!0),n.release()}else this._plugins.render(this._pluginInput,me.LINE_CALLOUTS)}_precompileHUD(t){if(this._precompileHUDOutput(t),this._hasHighlights){let i=this._renderContext.output;this._renderContext.output=oe.Highlight,this._precompileHUDOutput(t),this._renderContext.output=i}}_precompileHUDOutput(t){let i=this._bindParameters.hudRenderStyle;this._bindParameters.hudRenderStyle=t,this._oitEnabled&&W0(this._renderContext.output)?(this._bindParameters.oitPass=Ns.ColorAlpha,this._plugins.precompile(...Vv),this._bindParameters.oitPass=Ns.FrontFace,this._plugins.precompile(...Vv),this._bindParameters.oitPass=Ns.NONE):this._plugins.precompile(...Vv),this._bindParameters.hudRenderStyle=i}_renderHUD(t,i,r){if(this._pluginsHas.hudElements){if(this._oitEnabled){let n=this._renderOIT(yg.HUD,r,t);this._rctx.bindFramebuffer(i.fbo),this._compositingHelper.compositePreMultipliedAlpha(this._bindParameters,n.getTexture()),n.release()}else if(this._renderContext.output=r,t===Fn.Occluded){let n=()=>this._renderHUDElements(t),s=this._framebufferSize,o=this.fboCache.acquireDepth(wr.DEPTH16_BUFFER,s.width,s.height,"hud");this.renderToTargets(n,this._framebuffer.color,o,void 0,!0,!0),o.release()}else i.acquireDepth(wr.DEPTH16_BUFFER),this._rctx.bindFramebuffer(i.fbo),this._renderHUDElements(t),i.detachDepth();this.performanceInfo.advance(t===Fn.Occluded?Ri.HUD_OCCLUDED:Ri.HUD)}}_renderHUDElements(t){this._bindParameters.hudRenderStyle=t,this._plugins.render(this._pluginInput,...Vv)}get _needsShadowHighlight(){return this.shadowsEnabled&&this._plugins.produces(oe.ShadowHighlight,me.OPAQUE_MATERIAL)}_renderHighlightPrepass(){if(!this._hasHighlights)return;let{fboCache:t,_rctx:i,_bindParameters:r}=this,n=this._framebufferSize,s=t.acquire(n.width,n.height,"highlights",Pi.RG);return s.acquireDepth(wr.DEPTH_STENCIL_TEXTURE),i.bindFramebuffer(s.fbo),i.clearFramebuffer(gn,!0),this._renderContext.output=oe.Highlight,i.bindFramebuffer(s.fbo),CV(i,t,n,r,()=>this._renderHighlightGeometries()),this.performanceInfo.advance(Ri.HIGHLIGHTS),s}_renderHighlightGeometries(){this._plugins.render(this._pluginInput,...Vre),this._rctx.clear(Ti.DEPTH),this._renderHUDElements(Fn.Both)}get _needsShadowAccumulation(){return this._shadowAccumulator.accumulating}_renderShadowAccumulation(t,i,r){this._needsShadowAccumulation&&this._bindParameters.depth&&this._shadowAccumulator.renderAccumulation(this._bindParameters.depth,t,i,r)&&this.performanceInfo.advance(Ri.ACCUMULATED_SHADOWS)}_precompileTransparentGeometry(){this._oitEnabled&&W0(this._renderContext.output)?(this._bindParameters.oitPass=Ns.ColorAlpha,this._plugins.precompile(...kv),this._bindParameters.oitPass=Ns.FrontFace,this._plugins.precompile(...kv),this._bindParameters.oitPass=Ns.NONE):this._plugins.precompile(...kv)}_renderOIT(t,i,r=Fn.Both){let n=t===yg.HUD,s=this._framebufferSize,o=n?this.fboCache.acquire(s.width,s.height,"oit hud composite"):null,a=n?()=>this._renderHUDElements(r):()=>this._renderTransparentGeometry(),l=this._bindParameters,c=this._renderContext.output;this._renderContext.output=i,l.oitPass=Ns.ColorAlpha;let h=o?"oit hud color+alpha":"oit color+alpha",p=this.fboCache.acquire(s.width,s.height,h,Pi.RGBA16F),m=i===oe.ColorEmission;m&&p.acquireColor(lr.COLOR_ATTACHMENT1,Pi.RGBA16F,"emissive"),p.acquireColor(m?lr.COLOR_ATTACHMENT2:lr.COLOR_ATTACHMENT1,Pi.R16F),o||p.attachDepth(this._framebuffer.depth),this._rctx.bindFramebuffer(p.fbo),this._rctx.clearFramebuffer([0,0,0,1]),m&&this._rctx.gl.clearBufferfv(this._rctx.gl.COLOR,1,cw),a(),p.detachDepth(),l.oitPass=Ns.FrontFace;let f=this.fboCache.acquire(s.width,s.height,o?"oit hud front":"oit front");return m&&f.acquireColor(lr.COLOR_ATTACHMENT1,Pi.RGBA,"emissive"),o?f.acquireDepth(wr.DEPTH16_BUFFER):f.attachDepth(this._framebuffer.depth),this._rctx.bindFramebuffer(f.fbo),this._rctx.clearFramebuffer(gn,!!o),a(),f.detachDepth(),l.oitPass=Ns.NONE,o?(this._rctx.bindFramebuffer(o.fbo),this._rctx.setClearColor(0,0,0,1e-13),this._rctx.clear(Ti.COLOR)):this._framebuffer.bind(),this._oitblend??=new j1(this._techniques),this._oitblend.blend(this._rctx,p,f,l,m),o?.detachDepth(),f.release(),p.release(),this._renderContext.output=c,o}_renderTransparentEnvironment(){this._shadowAccumulator.render(this._bindParameters),this.performanceInfo.advance(Ri.APPLY_ACCUMULATED_SHADOWS),this._framebuffer.bind(),this._plugins.render(this._pluginInput,me.TRANSPARENT_MATERIAL_WITHOUT_DEPTH),this.performanceInfo.advance(Ri.TRANSPARENT_MATERIAL_WITHOUT_DEPTH)}_renderPlugins(t,i){this._plugins.produces(this._renderContext.output,t)&&(this._plugins.render(this._pluginInput,t),this.performanceInfo.advance(i))}_renderNodes(t,i,r=!1){if(i.setName(t),this._pluginInput.set(t,i),!this._nodes.produces(t))return r&&this.performanceInfo.advance(t),i;let n=this._nodes.render(i,this._pluginInput,this._releaseNormals);return this.performanceInfo.advance(t),n}_blitFBO(t,i=Nl,r=!0){return this._blit??=new _w(this._techniques),this._blit.blit(this._rctx,t,i,this._bindParameters),this._pluginInput.set(t.name,i),r&&t.release(),i}_ensureBindParametersCamera(t,i){this._bindParameters.camera=t,this._bindParameters.contentCamera=i}_ensureBindParametersSSR(t){if(this._bindParameters.ssr.lastFrameColor){this._ssrEnableTime==null&&(this._ssrEnableTime=t),this._renderContext.lastFrameCamera.equals(this._bindParameters.camera)?this._reprojectionMatrix=Wc:(Fx(Y6,this._bindParameters.camera.viewMatrix),Fx(Q6,this._bindParameters.camera.projectionMatrix),lo(_g,Y6,Q6),lo(_g,this._renderContext.lastFrameCamera.viewMatrix,_g),lo(_g,this._renderContext.lastFrameCamera.projectionMatrix,_g),this._reprojectionMatrix=_g);let i=this._stage.view.qualitySettings.fadeDuration;this._bindParameters.ssr.fadeFactor=i>0?Math.min(i,t-this._ssrEnableTime)/i:1,this._bindParameters.ssr.fadeFactor<1&&this._requestRender()}else this._reprojectionMatrix=Wc,this._ssrEnableTime=null}addRenderNode(t){this._nodes.add(t),this._requestRender()}removeRenderNode(t){this._nodes.remove(t),this._requestRender()}updateLighting(t,i,r,n){this._bindParameters.updateLighting(t,i,r,n),this._requestRender(Pe.UPDATE)}get usedMemory(){return{fbos:this.fboCache.usedMemory,plugins:this._plugins.usedMemory,edges:this.edgeView?.usedMemory??0}}renderToTargets(t,i,r,n,s=!1,o=!1){i.attachDepth(r),this._rctx.bindFramebuffer(i.fbo),this._rctx.clearFramebuffer(n,s,o),t(),i.detachDepth()}get test(){}},yg;u([d({readOnly:!0})],lp.prototype,"fullResolutionAtmosphere",null),u([d()],lp.prototype,"_edgeView",void 0),u([d()],lp.prototype,"updating",null),function(e){e[e.Geometry=0]="Geometry",e[e.HUD=1]="HUD"}(yg||(yg={}));var Fre=[me.INTEGRATED_MESH,me.OPAQUE_TERRAIN,me.OPAQUE_MATERIAL,me.TRANSPARENT_MATERIAL],kre=[me.OPAQUE_MATERIAL_WITHOUT_NORMALS,me.TRANSPARENT_MATERIAL_WITHOUT_NORMALS],bN=[me.INTEGRATED_MESH,me.OPAQUE_TERRAIN,me.OPAQUE_MATERIAL,me.OPAQUE_MATERIAL_WITHOUT_NORMALS],kv=[me.TRANSPARENT_MATERIAL,me.TRANSPARENT_MATERIAL_WITHOUT_NORMALS],Z6=[me.OPAQUE_MATERIAL,me.TRANSPARENT_MATERIAL,me.TRANSPARENT_MATERIAL_WITHOUT_DEPTH],Vv=[me.LINE_CALLOUTS_HUD_DEPTH,me.HUD_MATERIAL,me.LABEL_MATERIAL],Vre=[me.TRANSPARENT_MATERIAL,me.TRANSPARENT_MATERIAL_WITHOUT_NORMALS,me.OPAQUE_MATERIAL,me.OPAQUE_MATERIAL_WITHOUT_NORMALS,me.TRANSPARENT_TERRAIN,me.INTEGRATED_MESH,me.OPAQUE_TERRAIN],Q6=Wt(),Y6=Wt(),_g=Wt();function Hre(e){return t=>e.immediate.schedule(t)}var Y1=class{constructor(t){this._rctx=t,this._vao=Bre(t)}destroy(){this._vao=We(this._vao)}draw(){this._vao!=null&&(this._rctx.bindVAO(this._vao),this._rctx.drawArrays(Jt.TRIANGLES,0,3))}get test(){}};function Bre(e,t=wV,i=ja){let r=new Float32Array([-1,-1,3,-1,-1,3]);return new ns(e,i,new Map([["geometry",t]]),new Map([["geometry",vr.createVertex(e,tn.STATIC_DRAW,r)]]))}var K1=class{constructor(t,i,r){this._rctx=t,this._locations=i,this._layout=r,this._cache=new Bo(t.newCache,"VAOCache")}dispose(){this._cache.destroy()}newVao(t){let i=t.toString(),r=this._cache.pop(i);return r||(r=new ns(this._rctx,this._locations,new Map([["geometry",this._layout]]),new Map([["geometry",vr.createVertex(this._rctx,tn.STATIC_DRAW)]])),r.vertexBuffers.get("geometry")?.setSize(t),r)}deleteVao(t){if(t==null)return;let i=t.byteSize.toString();this._cache.put(i,t)}};var Hv=class extends tV{constructor(t,i){super(t,i),this._vaoCaches=new $g,this._appleAmdDriverHelper=null,this._refCount=1,this._newCache=i.newCache,this.screen=new Y1(this)}configure(t){super.configure(t),this._newCache=t.newCache}destroy(){this._vaoCaches?.forAll(t=>t.dispose()),this._vaoCaches?.clear(),--this._refCount>0||this.dispose()}ref(){++this._refCount}dispose(){super.dispose(),this._appleAmdDriverHelper?.dispose(),this.screen.destroy(),this._vaoCaches.forAll(t=>t.dispose()),this._vaoCaches.clear()}get newCache(){return this._newCache}getVaoCache(t,i){let r=Array.from(t).join("."),n=JSON.stringify(i),s=this._vaoCaches.get(r,n);if(s)return s;let o=new K1(this,t,i);return this._vaoCaches.set(r,n,o),o}bindTechnique(t,i,r,n){return this.useProgram(t.program),this.setPipelineState(t.getPipeline()),t.program.bind(i),r&&(t.program.bindPass(r,i),n&&t.program.bindDraw(i,r,n)),t.program}runAppleAmdDriverHelper(){this.driverTest.drawArraysRequiresIndicesTypeReset.result&&(this._appleAmdDriverHelper??=new eV(this),this._appleAmdDriverHelper.run())}get test(){}};function CN(e){return!!e.frameUpdate}var cp=class extends P{constructor(e){super({}),this._stage=e,this._textures=new Map,this._loadingCount=0,this._frameUpdates=new Map,this.events=new oi,this._frameTask=e.view.resourceController.scheduler.registerTask(Xt.TEXTURE_UNLOAD)}normalizeCtorArgs(){return{}}destroy(){this._frameTask.remove(),this._stage.forEachOfType(Q0.Texture,e=>e.unload())}get updating(){return this._loadingCount>0||this._frameTask.updating}acquire(e){let t=this._textures.get(e);return t?(t.ref(),t.loadingPromise??t):this._createNewRef(e)}update(){let e=!1;this._frameUpdates.forEach(t=>{let i=t.texture.frameUpdate(t.previousToken);i>=0&&i!==t.previousToken&&(t.previousToken=i,e=!0)}),e&&this.events.emit("changed",Pe.BACKGROUND)}_createNewRef(e){let t=this._stage.getObject(e);if(t==null)return null;let i=t.events.on("unloaded",()=>{i.remove(),this._onTextureUnloaded(e)}),r=new TN(e,()=>{this._frameTask.schedule(()=>{r.isUnreferenced&&t.unload()})});return this._textures.set(e,r),r.ref(),t.glTexture?(this._updateGLTexture(r,t.glTexture),CN(t)&&this._frameUpdates.set(e,{texture:t,previousToken:-1}),r):(this._loadingCount++,r.loadingPromise=this._stage.schedule(()=>{let n=t.load(this._stage.renderView.renderingContext),s=a=>(this._loadingCount--,r.loadingPromise=null,this._updateGLTexture(r,a),CN(t)&&this._frameUpdates.set(e,{texture:t,previousToken:-1}),r),o=a=>(this._loadingCount--,r.loadingPromise=null,qr(a)||W.getLogger(this).error(a),null);return Na(n)?n.then(s,o):s(n)}),r.loadingPromise)}_updateGLTexture(e,t){e.glTexture=t,this.events.emit("changed",Pe.UPDATE)}_onTextureUnloaded(e){this._textures.delete(e),this._frameUpdates.delete(e)}};u([d()],cp.prototype,"_loadingCount",void 0),u([d()],cp.prototype,"_frameTask",void 0),u([d()],cp.prototype,"updating",null),cp=u([C("esri.views.3d.webgl-engine.lib.TextureRepository")],cp);var TN=class{constructor(t,i){this.id=t,this._release=i,this._refCount=0}get isUnreferenced(){return this._refCount===0}ref(){++this._refCount}release(){--this._refCount,this._refCount>0||(this._refCount!==0?(W.getLogger("esri.views.3d.webgl-engine.lib.TextureRepository.RefCountedTextureImpl").error("Cannot dereference texture that has no references!"),this._refCount=0):this._release())}};function K6(e,t){return new EV(i=>xV(i,e),i=>i,t)}var vg=class extends P{constructor(){super(...arguments),this._passParameters=new EN,this._resourcesTask=null}get passParameters(){return this._passParameters}destroy(){this._resourcesTask=xr(this._resourcesTask),this._passParameters.waveNormal=We(this._passParameters.waveNormal),this._passParameters.wavePerturbation=We(this._passParameters.wavePerturbation)}get updating(){return!!this._resourcesTask&&!this._resourcesTask.finished}ensureResources(e){return this._resourcesTask||(this._resourcesTask=hn(async t=>{await Promise.allSettled([this._loadImageResource(e,Dx("esri/images/materials/water/normals.jpg"),i=>this._passParameters.waveNormal=i,t),this._loadImageResource(e,Dx("esri/images/materials/water/perturbation.jpg"),i=>this._passParameters.wavePerturbation=i,t)])})),this._resourcesTask.finished?Qx.LOADED:Qx.LOADING}async _loadImageResource(e,t,i,r){try{let n=await eu(t,{signal:r});Ht(r);let s=new vi(n.width,n.height);s.pixelFormat=mi.RGB,s.samplingMode=Nn.LINEAR_MIPMAP_LINEAR,s.hasMipmap=!0,s.maxAnisotropy=8,i(new Di(e,s,n))}catch(n){W.getLogger(this).error("Failed to load water material normal texture.",n)}}};u([d()],vg.prototype,"_resourcesTask",void 0),u([d({type:Boolean,readOnly:!0})],vg.prototype,"updating",null),vg=u([C("esri.views.3d.webgl-engine.materials.internal.WaterTextureRepository")],vg);var EN=class extends Jc{};var Ure=new Map;function X1(){return Ure}var J1=class{constructor(t,i){this.parameters=t,this.fbos=i}},ex=class{constructor(t,i,r){this._rctx=t,this._renderFunctions=i,this._forceCameraHook=r,this.supersample=!0,this._screenshotQueue=new Array}destroy(){this._rctx=null}async takeScreenshot(t){await this._renderFunctions.prepareOverlay(),this._renderFunctions.requestRenderScene(Pe.BACKGROUND);let i=As();return this._screenshotQueue.push({settings:t,resolver:i}),i.promise}update(t,i){for(let r of this._screenshotQueue){if(this._rctx==null){r.resolver.reject();continue}let n=be(ie({},r.settings),{pixelRatio:r.settings.pixelRatio*t.parameters.camera.pixelRatio}),s=this._renderScreenshot(t,n,i);r.resolver(s)}this._screenshotQueue.length=0}_renderScreenshotOverlay(t,i,r){t.width=i.width,t.height=i.height;let n=t.getContext("2d"),s=r.pixelRatio;return n.save(),n.translate(0,i.height),n.scale(1,-1),r.region&&n.translate(-r.region.x,-r.region.y),n.scale(s,s),i=this._renderFunctions.renderOverlay(t,r.disableDecorations,i),n.restore(),i}_readbackScreenshot(t,i){return t.resample?this._readbackScreenshotResampled(be(ie({},t),{resample:t.resample}),i):this._readbackScreenshotImmediate(t,i)}_readbackScreenshotResampled(t,i){let{framebufferWidth:r,framebufferHeight:n,region:s,resample:o}=t,a=this._ensureScreenshotEncodeCanvas(),l=k0(r,n,a);this._rctx.gl.readPixels(0,0,r,n,mi.RGBA,Id.UNSIGNED_BYTE,new Uint8Array(l.data.buffer)),i(),l=this._renderScreenshotOverlay(a,l,be(ie({},t),{region:void 0}));let c=k0(s.width,s.height,a);return oV(l,c,!0,o.region.x,n-(o.region.y+o.region.height),o.region.width,o.region.height)}_readbackScreenshotImmediate(t,i){let{framebufferHeight:r,region:n}=t,s=this._ensureScreenshotEncodeCanvas(),o=k0(n.width,n.height,s);return this._rctx.gl.readPixels(n.x,r-(n.y+n.height),n.width,n.height,mi.RGBA,Id.UNSIGNED_BYTE,new Uint8Array(o.data.buffer)),i(),this._renderScreenshotOverlay(s,o,t)}_renderScreenshot(t,i,r){let n=t.parameters.camera,s={width:i.framebufferWidth,height:i.framebufferHeight};Jp(s,Math.min(this._rctx.parameters.maxTextureSize,this._rctx.parameters.maxRenderbufferSize));let o=!1,a=s.width!==n.fullWidth||s.height!==n.fullHeight,l=i.ignorePadding&&n.pixelRatio!==i.pixelRatio,c=a||i.disableDecorations||l||i.objectAndLayerIdColor,h=null,p=null;if(c){let _=n.clone();if(i.ignorePadding){let D=fL(_.padding);for(let M=0;M<4;M++)D[M]=Math.round(D[M]/_.pixelRatio*i.pixelRatio);_.padding=D}_.fullWidth=s.width,_.fullHeight=s.height,_.pixelRatio=i.pixelRatio;let v=n.fovX-_.fovX,b=n.fovY-_.fovY;v<0&&v<b?_.fovX=n.fovX:b<0&&b<v&&(_.fovY=n.fovY);let x={camera:_,contentCamera:_,mode:pi.IDLE,alignPixelEnabled:!0,contentPixelRatio:_.pixelRatio,forcedAnimationTime:t.parameters.forcedAnimationTime};this._forceCameraHook(x),o=!0;let E=this._renderFunctions.renderScene(x,r,i.objectAndLayerIdColor?ra.ObjectAndLayerID:ra.Screenshot,i.disableDecorations);p=E.screen,h=E.olid}let m=()=>{this._rctx.bindFramebuffer(null),p?.release()};this._rctx.bindFramebuffer(p?.fbo);let f=this._readbackScreenshot(i,m),g=null;if(i.objectAndLayerIdColor){let _=()=>{this._rctx.bindFramebuffer(null),h?.release()};this._rctx.bindFramebuffer(h?.fbo),g=this._readbackScreenshot(i,_),this._rctx.bindFramebuffer(null)}if(c&&!this._rctx.contextAttributes.alpha)for(let _=3;_<f.data.length;_+=4)f.data[_]=255;if(g&&!this._rctx.contextAttributes.alpha)for(let _=3;_<g.data.length;_+=4)g.data[_]=255;return o&&this._forceCameraHook(t.parameters),[f,g]}_ensureScreenshotEncodeCanvas(){return this._screenshotEncodeCanvas??=document.createElement("canvas"),this._screenshotEncodeCanvas}};var X6={enabled:!1,disposeContextCache:()=>{let e=X1();e.forEach(t=>t.dispose()),e.clear()}};var Ur=class extends P{constructor(e){super(e),this.events=new oi,this.waterTextures=new vg,this.olidRenderHelper=Xc()?new x1:null,this._needsUpdate=!0,this._needsRender=!0,this._idleSuspend=!0,this._needsWaterReflectionUpdate=!1,this._lastAnimationUpdate=0,this._savedFadeDuration=0;let t=e.stage;try{this._initializeContext(t)}catch(n){return void console.error("Failed to initialize context",n)}let{memoryController:i}=t.view.resourceController;this.stippleTextures=DV(this._rctx,i),this.markerTextures=K6(this._rctx,i),this._techniques=new PV(new y1(this._rctx,t.viewingMode,this.stippleTextures,this.waterTextures,this.markerTextures)),this._textures=new cp(t),this.addHandles(this._textures.events.on("changed",n=>this.requestRender(n))),this._materials=new TV(this._textures,this._techniques,()=>this.requestRender(),()=>this.requestRender()),this._compositingHelper=new D1(this._rctx,this._techniques),this.renderer=new lp(t,this._materials,this._techniques,this._rctx,this._compositingHelper,n=>this.requestRender(n)),this.addHandles([S(()=>t.view.ready,n=>{n&&this._createRenderNodes()},Re),S(()=>this.waterTextures?.updating,()=>this.requestRender(),Re),S(()=>t.view.qualityProfile,n=>this.renderer?.updateRenderFeatures(n),Ce)]);let r={renderScene:(n,s,o,a)=>this.renderer.render(n,s,o,a),requestRenderScene:n=>this.requestRender(n),prepareOverlay:()=>t.options.screenshot.prepareOverlay(),renderOverlay:(n,s,o)=>t.options.screenshot.renderOverlay(n,s,o)};this._screenshotManager=new ex(this._rctx,r,n=>this.events.emit("force-camera-for-screenshot",n)),this._registerFrameTask(t)}destroy(){let e=this.stage?.container;e?.contains(this._canvas)&&e.removeChild(this._canvas),this._frameTask=Ft(this._frameTask),this._techniques=G(this._techniques),this._componentObjects=G(this._componentObjects),this._screenshotManager=G(this._screenshotManager),G(this.renderer),this._textures=G(this._textures),G(this.waterTextures),G(this.markerTextures),G(this.stippleTextures),this._canvas=null,this._rctx=G(this._rctx)}_createRenderNodes(){let{view:e,viewingMode:t}=this.stage;new E1({view:e}),d0(e.spatialReference)||(t===Se.Local?new t1({view:e}):u0(e.spatialReference)?new a6({view:e}):(new XD({view:e}),new JD({view:e}),new w1({view:e}),new e1({view:e}))),new WF({view:e,isEnabled:()=>this.renderer.hasSSAO}),new fd({view:e,isEnabled:()=>this.renderer.hasSMAA}),new md({view:e}),new bV({view:e}),new ap({view:e,viewingMode:t}),new ag({view:e}),Xc()&&new og({view:e})}requestRender(e=Pe.UPDATE){this._needsRender=!0,e===Pe.UPDATE&&(this._needsUpdate=!0)}get updating(){return this._needsUpdate||this._needsWaterReflectionUpdate||this.renderer.updating||this._textures.updating||this.waterTextures.updating}get textures(){return this._textures}get techniques(){return this._techniques}get compositingHelper(){return this._compositingHelper}setIdleSuspend(e){this._idleSuspend!==e&&(this._idleSuspend=e,this.requestRender())}get renderingContext(){return this._rctx}get capabilities(){return this._rctx.capabilities}get canvas(){return this._canvas}takeScreenshot(e){return this._screenshotManager.takeScreenshot(e).then(t=>t[0])}takeScreenshotWithOID(e){return e.objectAndLayerIdColor=!0,this._screenshotManager.takeScreenshot(e)}getAlpha(){return!!this._rctx.contextAttributes.alpha}getMinimalDepthForArea(e,t,i,r,n,s=n){let o=r.constrainWindowSize(t,i,n*r.pixelRatio,s*r.pixelRatio),a=this._ensureLinearDepthArrayBuffer(o);this.renderer.readMainDepth(o,a);let l=(h,p,m)=>jL(p,h)*(m[1]-m[0])+m[0],c=Number.MAX_VALUE;for(let h=0;h<o[2]*o[3];h++){let p=l(4*h,a,r.nearFar);c>p&&p!==r.nearFar[0]&&p!==r.nearFar[1]&&(c=p)}if(e){let h=e.pickDepth(t*r.pixelRatio,i*r.pixelRatio,r);h!=null&&c>h&&h!==r.nearFar[0]&&h!==r.nearFar[1]&&(c=h)}return c===Number.MAX_VALUE?void 0:c}_ensureLinearDepthArrayBuffer(e){let t=4*e[2]*e[3];return(this._tmpDepthBuffer==null||this._tmpDepthBuffer.byteLength<t)&&(this._tmpDepthBuffer=new Uint8Array(t)),this._tmpDepthBuffer}async reloadShaders(){wD(),await this._techniques.reloadAll(),this.renderer.overlay?.reloadShaders(),this.requestRender()}_registerFrameTask(e){let t=e.view.state,i=!1,r=Pe.BACKGROUND,n=!1,s={preRender:({time:o})=>{i=this.updating,r=this._needsUpdate?Pe.UPDATE:Pe.BACKGROUND,e.commitSyncLayers(),o=this._testTime??o,(o-this._lastAnimationUpdate>this.renderer.animationTimestep||t.forcedAnimationTime!=null||i||this._needsRender)&&(this.renderer.updateAnimation(t,o)&&this.requestRender(Pe.BACKGROUND),this._lastAnimationUpdate=o)},render:({time:o})=>{if((this._needsRender||!this._idleSuspend||!this.renderer.isCameraFinal||this._needsWaterReflectionUpdate)&&t.camera.fullWidth>0&&t.camera.fullHeight>0){let a=this._needsUpdate&&this._idleSuspend&&this.renderer.isCameraFinal;this._needsRender=!1,this._needsUpdate=!1,this._needsWaterReflectionUpdate=!1,o=this._testTime??o,this.renderer.render(t,o),n=!0,a&&this.renderer.hasReflections&&(this.requestRender(Pe.BACKGROUND),this._needsWaterReflectionUpdate=!0)}},update:({time:o})=>{this._textures.update();let a=new J1(t,this.renderer.fboCache);o=this._testTime??o,this._screenshotManager.update(a,o)},finish:()=>{n&&(this.renderer.finish(t.mode===pi.IDLE?r:Pe.UPDATE),n=!1)}};this._frameTask=Jr(s)}_initializeContext(e){let{options:t}=e,i=t.canvas??document.createElement("canvas");i.setAttribute("style","width: 100%; height:100%; display:block;"),this._canvas=i;let r={alpha:t.alpha||!1,premultipliedAlpha:!0,antialias:!1,depth:!0,stencil:t.stencil??!0,powerPreference:"high-performance",preserveDrawingBuffer:t.preserveDrawingBuffer??!1},n=i.getContext("webgl2",r);if(n==null)return void W.getLogger(this).error("A WebGL2 context could not be created.");this._rctx=jre(n,e),this._loadShaderOnlyExtensions(),!t.alpha&&this._rctx.contextAttributes.alpha&&W.getLogger(this).error("WebGL context has alpha channel even though no alpha channel was requested");let{container:s}=e;!this._rctx.contextAttributes.alpha&&Ct("safari")>=11&&(s.style.backgroundColor="black"),s.contains(i)||s.appendChild(i)}_loadShaderOnlyExtensions(){this._rctx.capabilities.enable("textureFloatLinear")}get _viewingMode(){return this.stage.viewingMode}getObjectAndLayerIdColor(e){return this.olidRenderHelper?.getObjectAndLayerIdColor(e)}get componentObjectCollection(){return this._componentObjects==null&&(this._componentObjects=new _1(this.renderer.renderPassManager,this._viewingMode)),this._componentObjects}set componentObjectCollection(e){this._componentObjects=e}updateQualitySettings(e){this._testTime!=null&&(this._savedFadeDuration=e.fadeDuration,e.fadeDuration=0)}set testTime(e){this._testTime=e,e==null?this.stage.view.qualitySettings.fadeDuration=this._savedFadeDuration:this.updateQualitySettings(this.stage.view.qualitySettings)}get testTime(){return this._testTime}};function jre(e,t){let i=(n,s)=>t.view.resourceController.memoryController.newCache(n,s),r={disabledExtensions:t.options.deactivatedWebGLExtensions||{},debugWebGLExtensions:t.options.debugWebGLExtensions||{},maxAnisotropy:8,newCache:i};if(X6.enabled){let n=J6.get(e);return n?(n.configure(r),n.ref(),n):(n=new Hv(e,r),J6.set(e,n),n.ref(),n)}return new Hv(e,r)}u([d({type:Boolean,readOnly:!0})],Ur.prototype,"updating",null),u([d({constructOnly:!0})],Ur.prototype,"stage",void 0),u([d()],Ur.prototype,"_rctx",void 0),u([d()],Ur.prototype,"_canvas",void 0),u([d()],Ur.prototype,"stippleTextures",void 0),u([d()],Ur.prototype,"markerTextures",void 0),u([d()],Ur.prototype,"waterTextures",void 0),u([d({readOnly:!0})],Ur.prototype,"olidRenderHelper",void 0),u([d()],Ur.prototype,"_textures",void 0),u([d({readOnly:!0})],Ur.prototype,"renderer",void 0),u([d()],Ur.prototype,"_screenshotManager",void 0),u([d()],Ur.prototype,"componentObjectCollection",null),u([d()],Ur.prototype,"_componentObjects",void 0),u([d()],Ur.prototype,"_needsUpdate",void 0),u([d()],Ur.prototype,"_needsWaterReflectionUpdate",void 0),Ur=u([C("esri.views.3d.webgl-engine.parts.RenderView")],Ur);var J6=X1();var Xs=class extends P{constructor(e){super(e),this._model=new mv,this._layers=new Nt,this._asyncChangeSet=new Jx,this._syncChangeSet=new Jx,this._layerSyncSet=new Set}initialize(){this._set("renderView",new Ur({stage:this})),this._frameTask=this.view.resourceController.scheduler.registerTask(Xt.STAGE,this),this.addHandles(this._frameTask)}destroy(){this.renderView.destroy()}get viewingMode(){return this.view.state.viewingMode}get updating(){return this.running||this.renderView.updating||this._frameTask.updating}get renderer(){return this.renderView?.renderer}add(e){this._model.add(e),em(e)&&this._addLayer(e),this.renderView.requestRender()}remove(e){e!=null&&!this.destroyed&&this._model.remove(e)&&(em(e)&&this._removeLayer(e),this.renderView.requestRender())}addMany(e){e!=null&&(this._model.addMany(e),this.renderView.requestRender())}removeMany(e){e!=null&&(this._model?.removeMany(e),this.renderView?.requestRender())}forEachOfType(e,t){this._model.forEachOfType(e,t)}handleEvent(e,t){this.destroyed||(this._model.dirtySet[e](t),this.renderView.requestRender())}get running(){return this._model.dirtySet.dirty||!this._asyncChangeSet.empty}runTask(e){if(this._frameTask.processQueue(e),this._commit(e),!e.hasProgressed)return Ui}_commit(e){let t=this._model.dirtySet;this._asyncChangeSet.empty||e.done||(this.renderer.modify(this._asyncChangeSet,e),this.renderView.requestRender(),e.madeProgress()),this._layers.forAll(i=>{if(e.done)return;let r=this._layerSyncSet.has(i.id)||i.updatePolicy===gw.SYNC,n=r?this._syncChangeSet:this._asyncChangeSet;t.commitLayer(i.id,n),this._layerSyncSet.delete(i.id),n.empty||(this.renderer.modify(n,r?Jn:e),this.renderView.requestRender(),e.madeProgress())}),this._syncChangeSet.empty||(this.renderer.modify(this._syncChangeSet,Jn),this.renderView.requestRender(),e.madeProgress()),this._layers.forAll(i=>{e.done||this._layerSyncSet.has(i.id)||i.updatePolicy!==gw.ASYNC||(t.commitLayer(i.id,this._asyncChangeSet),this._asyncChangeSet.empty||(this.renderer.modify(this._asyncChangeSet,e),this.renderView.requestRender(),e.madeProgress()))}),this._layerSyncSet.clear(),this.notifyChange("running")}commitSyncLayers(){let e=this._model.dirtySet;this._layers.forAll(t=>{this._layerSyncSet.has(t.id)||t.updatePolicy===gw.SYNC?(e.commitLayer(t.id,this._syncChangeSet),this._layerSyncSet.delete(t.id)):e.commitSyncUpdates(t.id,this._syncChangeSet)});for(let t of this._layerSyncSet)e.commitLayer(t,this._syncChangeSet);this._layerSyncSet.clear(),this._syncChangeSet.empty||(this.renderer.modify(this._syncChangeSet,Jn),this.renderView.requestRender())}_commitLayer(e){this._model.dirtySet.commitLayer(e.id,this._syncChangeSet),this._layerSyncSet.delete(e.id),this._syncChangeSet.empty||(this.renderer.modify(this._syncChangeSet,Jn),this.renderView.requestRender())}schedule(e,t){return this._frameTask.schedule(e,t)}reschedule(e,t){return this._frameTask.reschedule(e,t)}syncLayer(e){this._layerSyncSet.add(e),this.renderView.requestRender()}getObject(e){return this._model.getObject(e)}get layers(){return this._layers}_addLayer(e){this._layers.includes(e)||this._layers.push(e)}_removeLayer(e){this._commitLayer(e),this._layers.removeUnordered(e)!=null&&(this._model.dirtySet.getResidentRenderGeometries(e.id,this._syncChangeSet.removes),this.renderer.modify(this._syncChangeSet,Jn))}addRenderPlugin(e,t){let i=this.renderer.plugins.add(e,t),r=()=>{lO(e)&&this.view.sceneIntersectionHelper.addIntersectionHandler(e)};if(Na(i))return i.then(r);r()}removeRenderPlugin(e){this.destroyed||(lO(e)&&this.view.sceneIntersectionHelper.removeIntersectionHandler(e),this.renderer.plugins.remove(e))}get performanceInfo(){return this._model.getStats()}get test(){}};u([d({constructOnly:!0})],Xs.prototype,"view",void 0),u([d({constructOnly:!0})],Xs.prototype,"options",void 0),u([d({readOnly:!0})],Xs.prototype,"viewingMode",null),u([d({constructOnly:!0})],Xs.prototype,"container",void 0),u([d({readOnly:!0})],Xs.prototype,"updating",null),u([d({constructOnly:!0})],Xs.prototype,"_model",void 0),u([d()],Xs.prototype,"renderView",void 0),u([d({readOnly:!0})],Xs.prototype,"renderer",null),u([d({readOnly:!0})],Xs.prototype,"running",null),Xs=u([C("esri.views.3d.webgl-engine.Stage")],Xs);var tx=new Set,eW=()=>W.getLogger("esri/views/support/TextureCompressionHelper");function tW(e,t){return Di.compressionWorkerHandle??=new GD(GV(t)),tx.has(e)?eW().warn("Repeated texture compression worker initialization by the same view."):tx.add(e),Di.compressionWorkerHandle}function iW(e){Di.compressionWorkerHandle&&(tx.delete(e)||eW().warn("Unknown view attempted to destroy the texture compression worker."),tx.size||(G(Di.compressionWorkerHandle),Di.compressionWorkerHandle=null))}var ix=class extends Vu{constructor(e){super(e),this.components=["attribution","zoom","navigation-toggle","compass"]}};u([d()],ix.prototype,"components",void 0),ix=u([C("esri.views.ui.3d.DefaultUI3D")],ix);var DN=ix;var ge=class extends VC(BC(HC(GC))){constructor(e){super(e),this._userClippingArea=null,this._clippingArea=null,this._initialDefaultSpatialReference=null,this._overrideDefaultEnvironmentOnly=!0,this._createGraphicsViewController=null,this._resolveWhenReady=[],this._propertiesPool=new Vn({slicePlane:LF},this),this._resourceController=Gq(this),this._defaultToMapOptions={include:new Set},this._defaultHitTestOptions={exclude:new Set},this.deconflictor=new KE({view:this}),this.labeler=new E3({view:this,deconflictor:this.deconflictor.labels}),this.sharedSymbolResources=null,this.analyses=new Iu,this.basemapTerrain=null,this.elevationProvider=null,this.canvas=null,this.constraints=new Uu,this.environment=new Hh,this.environmentManager=new Gs,this.floors=new lt,this.fullOpacity=1,this.graphicsView=null,this.analysisViewManager=new k4({view:this}),this.groundView=null,this.map=null,this.screenSizePerspectiveEnabled=!0,this.state=new Bq({view:this}),this.spatialReference=null,this.alphaCompositingEnabled=!1,this.preserveDrawingBufferEnabled=!1,this.supersampleScreenshotsEnabled=!0,this.type="3d",this.ui=new DN,this._numUpdating=0,this._lastUpdateTime=0,this.updatingProgress=.5,this.focusAreas=new NV({view:this}),tw();let t=(i=null)=>{i!=null&&i.type===Mx.MOVE||(this._updatingChanged(),this.map&&this.map.allLayers.forEach(async r=>{try{await r.when()}catch{}this._updatingChanged()}))};this.addHandles([tr(()=>this.map?.allLayers,"after-changes",i=>t(i),{onListenerAdd:()=>t(),onListenerRemove:()=>t(),sync:!0}),this.allLayerViews.on("after-changes",i=>this._updateUpdatingMonitors(i)),S(()=>this.map,i=>{i&&"load"in i&&i.load&&i.load().catch(()=>{})})]),this.inputManager=new mq({view:this}),this.stateManager=new Li({view:this})}initialize(){if(Ct("enable-feature:esri-compress-textures")){let t=tW(this,this.resourceController);this.addResolvingPromise(t.promise)}this.groundView=new P4({view:this}),this._updateUpdatingMonitors();let e=()=>this._updateDefaultToMapOptions();this.addHandles(tr(()=>this.map?.allLayers,"after-changes",e,{onListenerAdd:e,onListenerRemove:e})),this.updatingHandles.add(()=>this.qualitySettings.memoryLimit,t=>{this.resourceController&&(this.resourceController.memoryController.maxMemory=t)},Re),this.updatingHandles.add(()=>this.qualitySettings.additionalCacheMemory,t=>{this.resourceController&&(this.resourceController.memoryController.additionalCacheMemory=t)},Re),this.updatingHandles.add(()=>this.qualitySettings.frameRate??0,t=>e2(t>0?1e3/Math.ceil(t):0),Re),this.updatingHandles.add(()=>this.map?.ground,e,Ce),this.updatingHandles.add(()=>this.map?.ground?.opacity,()=>this._updateDefaultHitTestOptions(),Ce),this.addHandles(S(()=>this.spatialReference,()=>this.notifyChange("clippingArea"),Fe))}destroy(){this.destroyed||(iW(this),this.updatingHandles.removeAll(),this.invalidate(),this.activeTool=null,this.layerViewManager.clear(),this._set("analysisViewManager",G(this.analysisViewManager)),this._exitSurface(),this._disposeGraphicsView(),this.sharedSymbolResources=G(this.sharedSymbolResources),this._set("labeler",G(this.labeler)),this._set("deconflictor",G(this.deconflictor)),this._resourceController=G(this._resourceController),this._set("stateManager",G(this.stateManager)),this._set("inputManager",G(this.inputManager)),this.state.destroy(),this.highlights.destroy(),this._propertiesPool.destroy(),this.removeHandles("updatingMonitors"),this._set("environmentManager",G(this.environmentManager)),this._set("environment",G(this.environment)),this.groundView=G(this.groundView),this._exitBasemapTerrain(),this._stage?.destroy())}get renderSpatialReference(){return this.renderCoordsHelper?.spatialReference}get basemapSpatialReference(){return this.basemapTerrain?.spatialReference}get animation(){return this.state?.animation}get camera(){return this.stateManager?.camera}set camera(e){this.stateManager&&(this.stateManager.camera=e)}get contentCamera(){return this.stateManager?.contentCamera}set contentCamera(e){this.stateManager&&(this.stateManager.contentCamera=e)}installContentCameraReset(e={sticky:!1}){return this.stateManager.installContentCameraReset(e)}get center(){return this.stateManager?.center}set center(e){this.stateManager&&(this.stateManager.center=e)}get clippingArea(){if(this.viewingMode==="global")return null;let e=this.map,t=this._userClippingArea||vx(e,"clippingArea");return!this._userClippingArea&&!vx(e,"clippingEnabled")||t==null?(this._clippingArea=null,null):t instanceof Vi?this.spatialReference&&(t=rx(t,this.spatialReference),t==null)?(W.getLogger(this).error("#clippingArea","setting clippingArea with incompatible SpatialReference"),this._clippingArea):(t=t.clone(),t.intersection(this._groundAndLayersExtent)==null&&(t.xmin=t.xmax,t.ymin=t.ymax),t.zmin=void 0,t.zmax=void 0,t.equals(this._clippingArea)||(this._clippingArea=t),this._clippingArea):(W.getLogger(this).error("#clippingArea","only clippingArea geometries of type Extent are supported"),this._clippingArea)}set clippingArea(e){this.ready&&this.viewingMode==="global"&&e!=null?W.getLogger(this).error("#clippingArea=","Clipping area is only supported in local viewingMode"):this._userClippingArea=e}get renderDataExtent(){if(this.state.viewingMode===Se.Global)return null;let e=this.renderSpatialReference,t=this.dataExtent;return t==null||e==null||t.spatialReference.equals(e)?t:rx(t,e)}get tileInfo(){return this.basemapTerrain?.tilingScheme?.toTileInfo()}get dataExtent(){let e=this._groundAndLayersExtent,t=this.spatialReference||Qt.WGS84,i=rx(this.clippingArea,t);i!=null&&(e=e!=null?e.intersection(i):i);let r=this._get("dataExtent");return e!=null&&e.equals(r)?r:e}get _groundAndLayersExtent(){let e=this.spatialReference||Qt.WGS84,t,i=s=>{let o=rx(s,e);o!=null&&(t!=null?t.union(o):t=o.clone())},r=this.basemapTerrain;if(r?.spatialReference){let s=r.groundExtent;i(new Vi({xmin:s[0],ymin:s[1],zmin:0,xmax:s[2],ymax:s[3],zmax:0,spatialReference:r.spatialReference}))}if(this.map){let s=o=>{o.fullExtent==null||o.type==="graphics"&&o.internal||i(o.fullExtent)};this.map.allLayers.forEach(o=>s(o))}if(t==null)return null;t.hasZ?(t.zmin=Math.min(0,t.zmin??0),t.zmax=Math.max(0,t.zmax??0)):(t.zmin=0,t.zmax=0);let n=this._get("_groundAndLayersExtent");return t.equals(n)?n:t}castEnvironment(e){return e?e instanceof Hh?e:e instanceof HT?this.environment?.cloneWithWebsceneEnvironment(e)??Hh.fromWebsceneEnvironment(e):yp(Hh,e):new Hh}get extent(){return this.stateManager?.extent}set extent(e){this.stateManager&&(this.stateManager.extent=e)}get screenCenter(){return this.stateManager?.screenCenter}get frustum(){return this.stateManager?.frustum}get initialExtentRequired(){return this.stateManager&&!this.stateManager.hasInitialView}get defaultsFromMapSettings(){return{required:{tileInfo:!1,heightModelInfo:!0,extent:!1}}}get interacting(){return this.navigating||(this.toolViewManager?.interacting??!1)}get stationary(){return!this.animation&&!this.resizing&&(this.state?.stationary??!0)}get navigating(){return this.state?.navigating??!1}get padding(){return this.stateManager?.padding}set padding(e){this.stateManager&&(this.stateManager.padding=e)}set qualityProfile(e){Gf.isValidProfile(e)&&(Gf.apply(e,this.qualitySettings),this._stage?.renderView.updateQualitySettings(this.qualitySettings),this._set("qualityProfile",e))}get qualityProfile(){return this._get("qualityProfile")||Gf.getDefaultProfile()}set slicePlane(e){if(this._stage!=null&&(this._stage.renderer.slicePlane=e),e==null)return void this._set("slicePlane",null);let t=this._propertiesPool.get("slicePlane");Gp(e,t),this._set("slicePlane",t)}get typeSpecificPreconditionsReady(){return!!this.viewingMode&&!!this.stateManager?.preinit(this.spatialReference)}get resolution(){return this.spatialReference!=null?tF(this.scale,this.spatialReference):0}get scale(){return this.stateManager?.scale}set scale(e){this.stateManager&&(this.stateManager.scale=e)}get heightModelInfo(){let e=this.getDefaultHeightModelInfo();return e!=null?p0.deriveUnitFromSR(e,this.spatialReference):null}get updating(){if(this.destroyed)return!1;let e=0,t=this.layerViewManager.updating,i=t?this.layerViewManager.updatingRemaining:0;this.allLayerViews.forEach(n=>{if(n.isFulfilled()){if(n.updating){if(t=!0,n.suspended||r_(n))return;++i,e+=n.updatingProgress}}else++i});for(let n of this._updatingObjects)n!=null&&n.updating&&(i+=.1,e+=.5*.1);for(let n of this._updatingObjectsWithProgress)n!=null&&n.updating&&(++i,e+=n.updatingProgress);let r=!this.stateManager.test.updatingIgnoreRenderState&&this.state.updating;if(t=!!(t||i>0||this.updatingHandles.updating||!this.ready||!this.stationary||r||this._createGraphicsViewController||this.inputManager?.updating||this.map?.allLayers?.some(n=>!n.isFulfilled())||this.textures?.updating),t?(this._numUpdating=Math.max(i,this._numUpdating),e+=this._numUpdating-i):this._numUpdating=0,this._numUpdating>0?e/=this._numUpdating:e=t?0:1,this._get("updatingProgress")!==e){let n=performance.now();if(e<1){let s=Math.min((n-this._lastUpdateTime)/2e3,1);e=this.updatingProgress*(1-s)+e*s}this._set("updatingProgress",e),this._lastUpdateTime=t&&e<1?n:0}return t}get _updatingObjects(){return[this.graphicsView,this.basemapView,this._resourceController,this._stage,this.featureTiles,this.pointsOfInterest,this.environmentManager,this.overlay,this._featureTreeDebugger,this.toolViewManager,this.analysisViewManager]}get _updatingObjectsWithProgress(){return[this.deconflictor,this.labeler,this.basemapTerrain]}get viewingMode(){let e=this._predeterminedViewingMode;if(e!=null)return G0(e);let t=this.spatialReference;return t?this.defaultsFromMap?.viewingMode!=null&&t.equals(this.defaultsFromMap.spatialReference)?G0(this.defaultsFromMap.viewingMode):gM(t,Se.Global)?"global":"local":"global"}set viewingMode(e){this.ready?W.getLogger(this).error("#viewingMode","viewingMode cannot be set once view is ready"):this._overrideIfSome("viewingMode",e)}get viewpoint(){return this.stateManager?.viewpoint}set viewpoint(e){this.stateManager&&(this.stateManager.viewpoint=e)}get visibleArea(){return this.stateManager?.visibleArea}get zoom(){return this.stateManager.zoom}set zoom(e){this.stateManager&&(this.stateManager.zoom=e)}get highlightOptions(){return this.highlights.find(({name:e})=>e===Ld)??new _o}set highlightOptions(e){for(let t=0;t<this.highlights.length;++t)if(this.highlights.at(t).name===Ld)return void this.highlights.items[t].assignFrom(e)}get resourceController(){return this._resourceController}get quality(){return this._resourceController?.memoryController?.memoryFactor??1}get resolutionScale(){return Math.sqrt(Math.min(1,this.quality/.75))}get performanceInfo(){return new hD(this)}on(e,t,i,r){return this.viewEvents.on(e,t,i,r)||super.on(e,t)}hasEventListener(e){return super.hasEventListener(e)||this.viewEvents.hasHandler(e)}toMap(e,t){if(!this.ready)return W.getLogger(this).error("#toMap()","Scene view cannot be used before it is ready"),null;let i=kd(e)?Fd(this,e):e;return B3(this,i,t,this._defaultToMapOptions)}toScreen(e){if(!this.ready)return W.getLogger(this).error("#toScreen()","Scene view cannot be used before it is ready"),null;let t=(e.z==null?Jg(this.elevationProvider,e):null)??0;return $c(e,nx,this.renderSpatialReference,t),this.state.camera.projectToScreen(nx,xN),Zi(xN[0],xN[1])}pixelSizeAt(e,t){if(!this.ready)return W.getLogger(this).error("#pixelSizeAt()","Scene view cannot be used before it is ready"),null;if(!e)return 0;let i=this.renderSpatialReference;$c(e,nx,i);let r=this.state.camera.computeScreenPixelSizeAt(nx);return t&&i!==t?r*Rg(i)/Rg(t):r}overlayPixelSizeInMapUnits(e){let t=this.basemapTerrain.overlayManager;return t?t.overlayPixelSizeInMapUnits(e,()=>this.pixelSizeAt(e)):1}hitTest(e,t){if(!this.ready)return W.getLogger(this).error("#hitTest()","Scene view cannot be used before it is ready"),null;let i=kd(e)?Fd(this,e):e;return H3(this,i,t,this._defaultHitTestOptions)}async popupHitTest(e){return zq(this,e)}goTo(e,t){return this.updatingHandles.addPromise(this.stateManager.goTo(e,t))}async whenAnalysisView(e){if(e.parent==null)throw new Be("view:no-analysisview-for-analysis","The analysis has not been added to view.analyses",{analysis:e});switch(e.parent.type){case"line-of-sight":case"dimension":case"viewshed":return(await this.whenLayerView(e.parent)).whenAnalysisView();default:return this.analysisViewManager.whenAnalysisView(e)}}whenLayerView(e){return super.whenLayerView(e)}async takeScreenshot(e){let t=await this._completeSettings(e);await this.whenReady();let i=await this._stage.renderView.takeScreenshot(t);return(await import("./chunk-YPQG6RNE.js")).encode(i,t,this._pixelFormat())}async _takeScreenshot(e){let t=await this._completeSettings(e);await this.whenReady();let i=await this._stage.renderView.takeScreenshot(t);return(await import("./chunk-YPQG6RNE.js")).encodeData(i,this._pixelFormat())}async _takeScreenshotWithObjectAndLayerId(e){let t=await this._completeSettings(e);await this.whenReady();let i=await this._stage.renderView.takeScreenshotWithOID(t),{encodeData:r}=await import("./chunk-YPQG6RNE.js");return[r(i[0],this._pixelFormat()),r(i[1],this._pixelFormat())]}async _completeSettings(e){let{toRenderSettings:t,screenshotSuperSampleSettings:i}=await import("./chunk-YPQG6RNE.js"),r=t(e,this);return r.pixelRatio/=this.state.pixelRatio,i(r,this.supersampleScreenshotsEnabled,this.padding)}_pixelFormat(){return{flipY:!0,premultipliedAlpha:this._stage.renderView.getAlpha()}}get test(){}async takeScreenshotWithObjectAndLayerId(e){if(!Xc())throw new Be("360vr:objectAndLayerId-rendering-disabled","has enable-feature:objectAndLayerId-rendering must be true");let{encode:t}=await import("./chunk-YPQG6RNE.js"),i=await this._completeSettings(e);await this.whenReady();let r=await this._stage.renderView.takeScreenshotWithOID(i),n=t(r[0],i,this._pixelFormat()),s=await this._completeSettings(e);return s.format="png",[n,t(r[1],s,this._pixelFormat())]}getColorToObjectAndLayerIdMapping(){let e=this._stage.renderView.olidRenderHelper;if(e)return e.getColorToObjectAndLayerIdMapping();throw new Be("360vr:objectAndLayerId-rendering-disabled","has enable-feature:objectAndLayerId-rendering must be true")}addUpdatingPromise(e){return this.updatingHandles.addPromise(e)}importLayerView(e){return jR.importLayerView(e)}hasLayerViewModule(e){return jR.hasLayerViewModule(e)}forceDOMReadyCycle(){this.forceReadyCycle()}getDefaultSpatialReference(){return this.map&&"initialViewProperties"in this.map&&this.map.initialViewProperties?.spatialReference||this.defaultsFromMap?.spatialReference||this.defaultsFromMap?.ready&&this._initialDefaultSpatialReference||null}async validate(){let e=yT(this.type),t=Ct("safari");if(t&&t<9&&(e=new Be("sceneview:browser-not-supported","This browser is not supported by SceneView (Safari < 9)",{type:"safari",requiredVersion:9,detectedVersion:t})),e!=null)throw W.getLogger(this).warn("#validate()",e.message),e}get _predeterminedViewingMode(){let e=this._isOverridden("viewingMode")?this._get("viewingMode"):(this.map&&"initialViewProperties"in this.map?this.map.initialViewProperties?.viewingMode:null)??null;return e!=null?zg(e):null}getSpatialReferenceSupport(e,t){let i=this._predeterminedViewingMode;if(i!=null)return this._validateSpatialReferenceForViewingMode(e,t,i)?{constraints:this._makeSpatialReferenceConstraints(e,t,i)}:null;let r=this._validateSpatialReferenceForViewingMode(e,t,Se.Local),n=this._validateSpatialReferenceForViewingMode(e,t,Se.Global);return r||n?r&&n?{constraints:this._makeSpatialReferenceConstraints(e,t,null)}:r?{constraints:this._makeSpatialReferenceConstraints(e,t,Se.Local)}:{constraints:this._makeSpatialReferenceConstraints(e,t,Se.Global)}:null}_validateSpatialReferenceForViewingMode(e,t,i){return!!gM(e,i)&&(t==null||!!Px(t)||(!Bc(t)||Ud(t,e,i)!=null)&&(!Rx(t)||i!==Se.Global))}_makeSpatialReferenceConstraints(e,t,i){if(t==null)return[{spatialReference:e,viewingMode:i}];let{isWebMercator:r,isWGS84:n}=e;return Px(t)&&(r||n)?!n||i===Se.Local||y3(t.tileInfo,t.fullExtent,e,Se.Global)===null?[{spatialReference:e,viewingMode:i},{spatialReference:Qt.WebMercator,viewingMode:i}]:[{spatialReference:r?Qt.WGS84:Qt.WebMercator,viewingMode:i}]:Bc(t)||Rx(t)||!r&&!n?Bc(t)&&r&&i!==Se.Global?[{spatialReference:e,viewingMode:i},{spatialReference:Qt.WGS84,viewingMode:Se.Local}]:[{spatialReference:e,viewingMode:i}]:[{spatialReference:e,viewingMode:i},{spatialReference:r?Qt.WGS84:Qt.WebMercator,viewingMode:i}]}_validateSpatialReference(e){let t=this.getSpatialReferenceSupport(e)!=null,i=this._predeterminedViewingMode;return t||(i!=null?W.getLogger(this).warnOnce(`Spatial reference defined on view not supported in ${G0(i)} viewing mode.`):e.isGeographic&&W.getLogger(this).warnOnce("Spatial reference is geographic but not supported.")),t}whenReady(){return new Promise(e=>{this.ready?e(this):this._resolveWhenReady.push(e)})}trackGraphicState(e){if(!e.graphic)return W.getLogger(this).error("trackGraphicState","GraphicState.graphic must not be null or undefined to start tracking"),null;let t=this.getViewForGraphic(e.graphic),i=null,r=!1,n=s=>{!r&&s!=null&&"processor"in s&&s.processor?.type==="graphics-3d"&&s.processor.graphicsCore&&(i=s.processor.graphicsCore.trackGraphicState(e))};return t!=null?n(t):this.whenViewForGraphic(e.graphic,{waitForLayer:!0}).then(s=>n(s),()=>{}).catch(()=>{}),_r(()=>{r=!0,i!=null&&(i.remove(),i=null)})}maskOccludee(e){if(!e)return W.getLogger(this).error("maskOccludee","GraphicState.graphic must not be null or undefined to mask an occludee"),null;let t=this.getViewForGraphic(e),i=null,r=!1,n=s=>{!r&&s!=null&&EF(s)&&(i=s.maskOccludee(e))};return t!=null?n(t):this.whenViewForGraphic(e,{waitForLayer:!0}).then(s=>n(s),()=>{}).catch(()=>{}),_r(()=>{r=!0,i!=null&&(i.remove(),i=null)})}getViewForGraphic(e){return e.layer===this.graphics?this.graphicsView:e.layer?this.allLayerViews.filter(t=>t.type!=="media-3d").find(t=>t.layer===e.layer):null}graphicChanged(e){this.graphicsView!=null&&this.graphicsView.graphicChanged(e)}async whenViewForGraphic(e,t){if(e.layer===this)return await Zo(()=>this.graphicsView),this.graphicsView;if(!e.layer||!this.map)throw new Be("no-view-for-graphic");return t&&t.waitForLayer&&!this.map.allLayers.includes(e.layer)?new Promise((i,r)=>{let n=this.map.allLayers.on("change",s=>{s.added.includes(e.layer)&&(n.remove(),this.whenLayerView(e.layer).then(i,r))})}):this.whenLayerView(e.layer)}_initBasemapTerrain(){this._set("basemapTerrain",new $8({view:this})),this._set("elevationProvider",new zf({view:this})),this.elevationProvider.register("ground",this.basemapTerrain)}_exitBasemapTerrain(){this.basemapTerrain&&(this.elevationProvider.unregister(this.basemapTerrain),this.elevationProvider.destroy(),this._set("elevationProvider",null),this.basemapTerrain.destroy(),this._set("basemapTerrain",null))}_initGlobe(){this._initCoordinateSystem(),this.state.createInitialCamera(),this._initBasemapTerrain(),this._set("pointsOfInterest",new Sn({view:this})),this._set("featureTiles",new Cr({renderCoordsHelper:this.renderCoordsHelper,cameraOnSurface:this.pointsOfInterest.cameraOnSurface,focus:this.pointsOfInterest.focus,tilingSchemeOwner:this.basemapTerrain,viewState:this.state,scheduler:this._resourceController.scheduler,terrain:this.basemapTerrain}));let e=()=>{let t=this.basemapTerrain?.extent;if(this.clippingArea||t)if(t&&this.basemapTerrain.spatialReference){let i=this.basemapTerrain.extent!=null&&this.basemapTerrain.spatialReference!=null?jl(m0(this.basemapTerrain.extent,this.basemapTerrain.spatialReference),this.spatialReference):null;this.clippingArea?this.featureTiles.filterExtent=this.clippingArea.intersection(i):this.featureTiles.filterExtent=i}else this.featureTiles.filterExtent=this.clippingArea;else this.featureTiles.filterExtent=null};this.addHandles([this.updatingHandles.add(()=>ur.FEATURE_TILE_TREE_SHOW_TILES,t=>{t&&this.featureTiles&&!this._featureTreeDebugger?this.updatingHandles.addPromise(import("./chunk-3OO5TCSF.js")).then(({FeatureTileTree3DDebugger:i})=>{!this._featureTreeDebugger&&ur.FEATURE_TILE_TREE_SHOW_TILES&&(this._featureTreeDebugger=new i({view:this}))}):t||!this._featureTreeDebugger||ur.FEATURE_TILE_TREE_SHOW_TILES||(this._featureTreeDebugger.destroy(),this._featureTreeDebugger=null)},Ce),this.updatingHandles.add(()=>this.clippingArea,e,Ce),this.updatingHandles.add(()=>this.basemapTerrain.extent,e,Ce)],"feature-tiles"),this.stateManager.init()}_exitGlobe(){this.featureTiles&&(this.stateManager.exit(),this.removeHandles("render-coords-helper"),this.removeHandles("feature-tiles"),this._set("featureTiles",G(this.featureTiles)),this._set("pointsOfInterest",G(this.pointsOfInterest)),this._exitBasemapTerrain(),this.state.reset(),this._exitCoordinateSystem())}_initCoordinateSystem(){if(this.spatialReference){let e=this.spatialReference,t=this.state.isGlobal,i=mk(t,e);i!==this.renderSpatialReference&&(this._set("renderCoordsHelper",fk.create(this.state.viewingMode,i)),t||this.addHandles(S(()=>this.basemapTerrain?.extent,r=>{let n=this.renderCoordsHelper.spatialReference;r==null||r[0]===0&&r[1]===0&&r[2]===0&&r[3]===0||!Tw(r,this.basemapTerrain.spatialReference,rW,n)||(this.renderCoordsHelper.extent=rW)},Fe),"render-coords-helper"),this.sceneIntersectionHelper&&this.sceneIntersectionHelper.setTolerance(Qp/this.renderCoordsHelper.unitInMeters))}else this._set("renderCoordsHelper",null)}_exitCoordinateSystem(){this.removeHandles("render-coords-helper"),this._set("renderCoordsHelper",null)}_updatingChanged(){this.notifyChange("updating")}_updateUpdatingMonitors(e=null){e!=null&&e.type===Mx.MOVE||(this.removeHandles("updatingMonitors"),this.allLayerViews.forEach(t=>{t.destroyed||(this.addHandles(S(()=>[t.updating,t.updatingProgress],()=>this._updatingChanged(),Fe),"updatingMonitors"),t.when(()=>this._updatingChanged(),()=>this._updatingChanged()))}),this._updatingChanged())}async _prepareScreenshotOverlay(){this.overlay&&await this.overlay.prepare()}_renderScreenshotOverlay(e,t,i){if(!this.overlay||!this.overlay.hasVisibleItems)return i;let r=e.getContext("2d");return r.putImageData(i,0,0),this.overlay.renderCanvas(e,{disableDecorations:t}),r.getImageData(0,0,i.width,i.height)}_initStage(){let e={deactivatedWebGLExtensions:this.deactivatedWebGLExtensions,debugWebGLExtensions:this.debugWebGLExtensions,alpha:this.alphaCompositingEnabled,preserveDrawingBuffer:this.preserveDrawingBufferEnabled,canvas:this.renderCanvas,screenshot:{prepareOverlay:()=>this._prepareScreenshotOverlay(),renderOverlay:(r,n,s)=>this._renderScreenshotOverlay(r,n,s)}},t=new nD(this.state.viewingMode,r=>this._stage.layers.forAll(r),this);this._set("sceneIntersectionHelper",t);let i=vp(this.surface);this._stage=new Xs({view:this,options:e,container:i}),this._stage.renderer.slicePlane=this.slicePlane,this.addHandles([this.updatingHandles.add(()=>this.qualitySettings.highQualityTransparency,r=>this._stage.renderer.setParameters({highQualityTransparency:r}),Re),this.on("pointer-move",()=>this._stage?.renderer.resetAnimation()),e0(this._stage.renderView.canvas,"webglcontextlost",r=>{this.fatalError=new Be("webgl-context-lost",r.statusMessage)})],"stage"),this.renderCoordsHelper&&this.sceneIntersectionHelper.setTolerance(Qp/this.renderCoordsHelper.unitInMeters),this._set("canvas",this._stage.renderView.canvas)}_exitStage(){this._set("sceneIntersectionHelper",null),this._stage=G(this._stage),this.removeHandles("stage"),this._set("canvas",null)}_initSurface(e){this._exitSurface(),this._initStage(),this._initGlobe(),this.sharedSymbolResources=new gD({view:this,viewingMode:e,resourceController:this._resourceController,pointsOfInterest:this.pointsOfInterest,viewState:this.state})}_exitSurface(){this.sharedSymbolResources&&(this.sharedSymbolResources.objectResourceCache.destroy(),this.sharedSymbolResources.destroy(),this.sharedSymbolResources=null,this._exitGlobe(),this._exitStage())}_createGraphicsViewIfNeeded(){if(this.graphicsView||this._createGraphicsViewController||this.graphics.length===0)return;this.removeHandles("graphics-view"),this._createGraphicsViewController=new AbortController;let e=()=>{this._createGraphicsViewController=null,this._updatingChanged()};this._createGraphicsViewAsync(this._createGraphicsViewController.signal).then(e,e),this._updatingChanged()}async _createGraphicsViewAsync(e){let t=(await import("./chunk-T3T7F6ML.js")).default;Ht(e),await Zo(()=>this.basemapTerrain?.ready,e),this._set("graphicsView",new t({view:this}))}_disposeGraphicsView(){this._createGraphicsViewController&&(this._createGraphicsViewController.abort(),this._createGraphicsViewController=null),this.removeHandles("graphics-view"),this.graphicsView!=null&&(this.removeHandles(this.graphicsView.processor.layer.id),this.graphicsView.destroy(),this._set("graphicsView",null))}_startup(){let e=zg(this.viewingMode);e===Se.Global&&(this._clippingArea=null),this._initSurface(e),this._set("ready",!0),this.addHandles(tr(()=>this.graphics,"after-changes",()=>this._createGraphicsViewIfNeeded()),"graphics-view"),this._createGraphicsViewIfNeeded();let t=this.map&&"initialViewProperties"in this.map?this.map.initialViewProperties:null,i=t?.environment;i&&(this._overrideDefaultEnvironmentOnly?UR(this.environment,i):this.environment=this.environment.cloneWithWebsceneEnvironment(i)),this.timeExtent=t?.timeExtent,this.labeler.setup(),this.environmentManager.connectView(this),this.inputManager.connect(),this._set("textures",new ld(this._stage,this.resourceController.scheduler));let r=this._resolveWhenReady;this._resolveWhenReady=[],r.forEach(n=>n(this))}_teardown(){this._initialDefaultSpatialReference=null,this.inputManager.disconnect(),this.environmentManager.disconnectView(),this._overrideDefaultEnvironmentOnly=!1,this.labeler.dispose(),this._disposeGraphicsView(),this.removeHandles("graphics-view"),this._set("textures",G(this.textures)),this._exitSurface(),this._set("ready",!1)}_updateDefaultToMapOptions(){if(this._defaultToMapOptions.include.clear(),this.map){this.map.ground&&this._defaultToMapOptions.include.add(Wl);for(let e of this.map.allLayers.items)Pg(e.type)&&this._defaultToMapOptions.include.add(e.uid)}}_updateDefaultHitTestOptions(){if(this._defaultHitTestOptions.exclude.clear(),this.map){this.map.ground&&this.map.ground.opacity<1&&this._defaultHitTestOptions.exclude.add(Wl);for(let e of this.map.allLayers.items)Pg(e.type)&&e.opacity<1&&this._defaultHitTestOptions.exclude.add(e.uid)}}};function rx(e,t){return e!=null&&b0(e.spatialReference,t)?jl(e,t):null}ge.type="3d",u([d()],ge.prototype,"_userClippingArea",void 0),u([d()],ge.prototype,"_resourceController",void 0),u([d()],ge.prototype,"_stage",void 0),u([d({readOnly:!0})],ge.prototype,"deconflictor",void 0),u([d({readOnly:!0})],ge.prototype,"labeler",void 0),u([d(Zg(Iu,"analyses"))],ge.prototype,"analyses",void 0),u([d({type:Cn,readOnly:!0})],ge.prototype,"animation",null),u([d({readOnly:!0})],ge.prototype,"basemapTerrain",void 0),u([d({readOnly:!0})],ge.prototype,"elevationProvider",void 0),u([d()],ge.prototype,"camera",null),u([d({type:kn})],ge.prototype,"contentCamera",null),u([d({readOnly:!0})],ge.prototype,"canvas",void 0),u([d({type:pt})],ge.prototype,"center",null),u([d({type:Vi})],ge.prototype,"clippingArea",null),u([d({type:Uu})],ge.prototype,"constraints",void 0),u([d({type:Vi,readOnly:!0})],ge.prototype,"renderDataExtent",null),u([d({readOnly:!0})],ge.prototype,"tileInfo",null),u([d({type:Vi,readOnly:!0})],ge.prototype,"dataExtent",null),u([d({type:Vi,readOnly:!0})],ge.prototype,"_groundAndLayersExtent",null),u([d({type:Hh})],ge.prototype,"environment",void 0),u([Sr("environment")],ge.prototype,"castEnvironment",null),u([d({readOnly:!0})],ge.prototype,"environmentManager",void 0),u([d({type:Vi})],ge.prototype,"extent",null),u([d({type:lt})],ge.prototype,"floors",void 0),u([d()],ge.prototype,"screenCenter",null),u([d()],ge.prototype,"frustum",null),u([d({type:Number,readOnly:!0})],ge.prototype,"fullOpacity",void 0),u([d({readOnly:!0})],ge.prototype,"graphicsView",void 0),u([d({readOnly:!0})],ge.prototype,"analysisViewManager",void 0),u([d()],ge.prototype,"groundView",void 0),u([d({type:Boolean})],ge.prototype,"initialExtentRequired",null),u([d()],ge.prototype,"defaultsFromMapSettings",null),u([d()],ge.prototype,"interacting",null),u([d()],ge.prototype,"stationary",null),u([d()],ge.prototype,"navigating",null),u([d()],ge.prototype,"map",void 0),u([d()],ge.prototype,"padding",null),u([d({type:Sn,readOnly:!0})],ge.prototype,"pointsOfInterest",void 0),u([d({type:Cr,readOnly:!0})],ge.prototype,"featureTiles",void 0),u([d()],ge.prototype,"_featureTreeDebugger",void 0),u([d({type:Boolean})],ge.prototype,"screenSizePerspectiveEnabled",void 0),u([d({constructOnly:!0})],ge.prototype,"deactivatedWebGLExtensions",void 0),u([d({constructOnly:!0})],ge.prototype,"debugWebGLExtensions",void 0),u([d({constructOnly:!0})],ge.prototype,"renderCanvas",void 0),u([d({constructOnly:!0})],ge.prototype,"state",void 0),u([d({readOnly:!0})],ge.prototype,"inputManager",void 0),u([d({readOnly:!0})],ge.prototype,"stateManager",void 0),u([d({type:["low","medium","high"]})],ge.prototype,"qualityProfile",null),u([d({type:cO,get(){let e=this._get("qualitySettings");return e||(e=new cO,Gf.apply(this.qualityProfile,e)),e}})],ge.prototype,"qualitySettings",void 0),u([d()],ge.prototype,"slicePlane",null),u([d({readOnly:!0})],ge.prototype,"typeSpecificPreconditionsReady",null),u([d({readOnly:!0})],ge.prototype,"renderCoordsHelper",void 0),u([d({readOnly:!0})],ge.prototype,"sceneIntersectionHelper",void 0),u([d({type:Number,dependsOn:["scale","spatialReference"],readOnly:!0})],ge.prototype,"resolution",null),u([d({type:Number})],ge.prototype,"scale",null),u([d()],ge.prototype,"heightModelInfo",null),u([d()],ge.prototype,"spatialReference",void 0),u([d({type:Boolean,constructOnly:!0})],ge.prototype,"alphaCompositingEnabled",void 0),u([d({constructOnly:!0})],ge.prototype,"preserveDrawingBufferEnabled",void 0),u([d({type:Boolean})],ge.prototype,"supersampleScreenshotsEnabled",void 0),u([d({readOnly:!0})],ge.prototype,"type",void 0),u([d(),Sr(e=>e instanceof Vu?e:o0(DN,e))],ge.prototype,"ui",void 0),u([d({type:Boolean,readOnly:!0,dependsOn:["graphicsView.updating","basemapView.updating","basemapTerrain.updating","layerViewManager.updating","layerViewManager.updatingRemaining","_resourceController.updating","_stage.updating","featureTiles.updating","pointsOfInterest.updating","environmentManager.updating","overlay.updating","updatingHandles.updating","featureTreeDebugger.updating","labeler.updating","deconflictor.updating","ready","stationary","inputManager.updating","toolViewManager.updating","analysisViewManager.updating","state.updating","textures.updating"]})],ge.prototype,"updating",null),u([d()],ge.prototype,"_updatingObjects",null),u([d()],ge.prototype,"_updatingObjectsWithProgress",null),u([d({type:Number,readOnly:!0,dependsOn:["updating"]})],ge.prototype,"updatingProgress",void 0),u([d({type:["global","local"]})],ge.prototype,"viewingMode",null),u([d({type:Si})],ge.prototype,"viewpoint",null),u([d({readOnly:!0})],ge.prototype,"visibleArea",null),u([d({type:Number})],ge.prototype,"zoom",null),u([d({type:_o})],ge.prototype,"highlightOptions",null),u([d({readOnly:!0})],ge.prototype,"quality",null),u([d({readOnly:!0})],ge.prototype,"resolutionScale",null),u([d()],ge.prototype,"textures",void 0),ge=u([C("esri.views.SceneView")],ge);var nx=w(),xN=Kt(),rW=Yt(),nW=ge;var $o=Math.PI,qi=$o*2,Bv=$o/180,CSt=180/$o,zre=1440,Gre=398600.8,Js=6378.135,Fc=60/Math.sqrt(Js*Js*Js/Gre),MN=Js*Fc/60,qre=1/Fc,dp=.001082616,Wre=-253881e-11,$re=-165597e-11,hp=Wre/dp,Uv=2/3,Zre=1440/(2*$o);function Qre(e,t){for(var i=[31,e%4===0?29:28,31,30,31,30,31,31,30,31,30,31],r=Math.floor(t),n=1,s=0;r>s+i[n-1]&&n<12;)s+=i[n-1],n+=1;var o=n,a=r-s,l=(t-r)*24,c=Math.floor(l);l=(l-c)*60;var h=Math.floor(l),p=(l-h)*60;return{mon:o,day:a,hr:c,minute:h,sec:p}}function sW(e,t,i,r,n,s){var o=arguments.length>6&&arguments[6]!==void 0?arguments[6]:0;return 367*e-Math.floor(7*(e+Math.floor((t+9)/12))*.25)+Math.floor(275*t/9)+i+17210135e-1+((o/6e4+s/60+n)/60+r)/24}function sx(e,t,i,r,n,s){var o=arguments.length>6&&arguments[6]!==void 0?arguments[6]:0;if(e instanceof Date){var a=e;return sW(a.getUTCFullYear(),a.getUTCMonth()+1,a.getUTCDate(),a.getUTCHours(),a.getUTCMinutes(),a.getUTCSeconds(),a.getUTCMilliseconds())}return sW(e,t,i,r,n,s,o)}function oW(e,t){var i=e.e3,r=e.ee2,n=e.peo,s=e.pgho,o=e.pho,a=e.pinco,l=e.plo,c=e.se2,h=e.se3,p=e.sgh2,m=e.sgh3,f=e.sgh4,g=e.sh2,_=e.sh3,v=e.si2,b=e.si3,x=e.sl2,E=e.sl3,D=e.sl4,M=e.t,T=e.xgh2,I=e.xgh3,A=e.xgh4,O=e.xh2,$=e.xh3,H=e.xi2,k=e.xi3,K=e.xl2,F=e.xl3,R=e.xl4,j=e.zmol,B=e.zmos,z=t.init,ce=t.opsmode,ue=t.ep,Ie=t.inclp,le=t.nodep,ze=t.argpp,Le=t.mp,de,fe,st,De,Ee,Ae,He,Ve,_e,L,N,V,U,Y,re,ye,J,Z,Q,pe,Me,et=119459e-10,Je=.01675,$e=.00015835218,Ke=.0549;Me=B+et*M,z==="y"&&(Me=B),pe=Me+2*Je*Math.sin(Me),J=Math.sin(pe),L=.5*J*J-.25,N=-.5*J*Math.cos(pe);var at=c*L+h*N,Ze=v*L+b*N,Ge=x*L+E*N+D*J,y=p*L+m*N+f*J,qe=g*L+_*N;Me=j+$e*M,z==="y"&&(Me=j),pe=Me+2*Ke*Math.sin(Me),J=Math.sin(pe),L=.5*J*J-.25,N=-.5*J*Math.cos(pe);var je=r*L+i*N,tt=H*L+k*N,dt=K*L+F*N+R*J,it=T*L+I*N+A*J,Ye=O*L+$*N;return V=at+je,re=Ze+tt,ye=Ge+dt,U=y+it,Y=qe+Ye,z==="n"&&(V-=n,re-=a,ye-=l,U-=s,Y-=o,Ie+=re,ue+=V,De=Math.sin(Ie),st=Math.cos(Ie),Ie>=.2?(Y/=De,U-=st*Y,ze+=U,le+=Y,Le+=ye):(Ae=Math.sin(le),Ee=Math.cos(le),de=De*Ae,fe=De*Ee,He=Y*Ee+re*st*Ae,Ve=-Y*Ae+re*st*Ee,de+=He,fe+=Ve,le%=qi,le<0&&ce==="a"&&(le+=qi),Z=Le+ze+st*le,_e=ye+U-re*le*De,Z+=_e,Q=le,le=Math.atan2(de,fe),le<0&&ce==="a"&&(le+=qi),Math.abs(Q-le)>$o&&(le<Q?le+=qi:le-=qi),Le+=ye,ze=Z-Le-st*le)),{ep:ue,inclp:Ie,nodep:le,argpp:ze,mp:Le}}function Yre(e){var t=e.epoch,i=e.ep,r=e.argpp,n=e.tc,s=e.inclp,o=e.nodep,a=e.np,l,c,h,p,m,f,g,_,v,b,x,E,D,M,T,I,A,O,$,H,k,K,F,R,j,B,z,ce,ue,Ie,le,ze,Le,de,fe,st,De,Ee,Ae,He,Ve,_e,L,N,V,U,Y,re,ye,J,Z,Q,pe,Me,et,Je,$e,Ke,at,Ze,Ge,y,qe,je=.01675,tt=.0549,dt=29864797e-13,it=47968065e-14,Ye=.39785416,gt=.91744867,wt=.1945905,xt=-.98088458,bi=a,Ci=i,li=Math.sin(o),ci=Math.cos(o),jt=Math.sin(r),bt=Math.cos(r),Qe=Math.sin(s),zt=Math.cos(s),Ot=Ci*Ci,se=1-Ot,ri=Math.sqrt(se),jr=0,Qn=0,Mt=0,Ds=0,Pn=0,Er=t+18261.5+n/1440,xs=(4.523602-.00092422029*Er)%qi,or=Math.sin(xs),zr=Math.cos(xs),eo=.91375164-.03568096*zr,Ms=Math.sqrt(1-eo*eo),ar=.089683511*or/Ms,Dr=Math.sqrt(1-ar*ar),_i=5.8351514+.001944368*Er,Yn=.39785416*or/Ms,Ma=Dr*zr+.91744867*ar*or;Yn=Math.atan2(Yn,Ma),Yn+=_i-xs;var Gr=Math.cos(Yn),Kn=Math.sin(Yn);H=wt,k=xt,R=gt,j=Ye,K=ci,F=li,x=dt;for(var to=1/bi,er=0;er<2;)er+=1,l=H*K+k*R*F,h=-k*K+H*R*F,g=-H*F+k*R*K,_=k*j,v=k*F+H*R*K,b=H*j,c=zt*g+Qe*_,p=zt*v+Qe*b,m=-Qe*g+zt*_,f=-Qe*v+zt*b,E=l*bt+c*jt,D=h*bt+p*jt,M=-l*jt+c*bt,T=-h*jt+p*bt,I=m*jt,A=f*jt,O=m*bt,$=f*bt,Ge=12*E*E-3*M*M,y=24*E*D-6*M*T,qe=12*D*D-3*T*T,Q=3*(l*l+c*c)+Ge*Ot,pe=6*(l*h+c*p)+y*Ot,Me=3*(h*h+p*p)+qe*Ot,et=-6*l*m+Ot*(-24*E*O-6*M*I),Je=-6*(l*f+h*m)+Ot*(-24*(D*O+E*$)+-6*(M*A+T*I)),$e=-6*h*f+Ot*(-24*D*$-6*T*A),Ke=6*c*m+Ot*(24*E*I-6*M*O),at=6*(p*m+c*f)+Ot*(24*(D*I+E*A)-6*(T*O+M*$)),Ze=6*p*f+Ot*(24*D*A-6*T*$),Q=Q+Q+se*Ge,pe=pe+pe+se*y,Me=Me+Me+se*qe,Y=x*to,U=-.5*Y/ri,re=Y*ri,V=-15*Ci*re,ye=E*M+D*T,J=D*M+E*T,Z=D*T-E*M,er===1&&(B=V,z=U,ce=Y,ue=re,Ie=ye,le=J,ze=Z,Le=Q,de=pe,fe=Me,st=et,De=Je,Ee=$e,Ae=Ke,He=at,Ve=Ze,_e=Ge,L=y,N=qe,H=Gr,k=Kn,R=eo,j=Ms,K=Dr*ci+ar*li,F=li*Dr-ci*ar,x=it);var Xn=(4.7199672+(.2299715*Er-_i))%qi,Sa=(6.2565837+.017201977*Er)%qi,kc=2*B*le,Ss=2*B*ze,io=2*z*De,Ll=2*z*(Ee-st),Ia=-2*ce*de,pp=-2*ce*(fe-Le),mp=-2*ce*(-21-9*Ot)*je,Aa=2*ue*L,_d=2*ue*(N-_e),yd=-18*ue*je,Is=-2*z*He,Ra=-2*z*(Ve-Ae),Vc=2*V*J,fp=2*V*Z,gp=2*U*Je,Eg=2*U*($e-et),Zv=-2*Y*pe,Qv=-2*Y*(Me-Q),Yv=-2*Y*(-21-9*Ot)*tt,Dg=2*re*y,kW=2*re*(qe-Ge),VW=-18*re*tt,HW=-2*U*at,BW=-2*U*(Ze-Ke);return{snodm:li,cnodm:ci,sinim:Qe,cosim:zt,sinomm:jt,cosomm:bt,day:Er,e3:fp,ee2:Vc,em:Ci,emsq:Ot,gam:_i,peo:jr,pgho:Ds,pho:Pn,pinco:Qn,plo:Mt,rtemsq:ri,se2:kc,se3:Ss,sgh2:Aa,sgh3:_d,sgh4:yd,sh2:Is,sh3:Ra,si2:io,si3:Ll,sl2:Ia,sl3:pp,sl4:mp,s1:V,s2:U,s3:Y,s4:re,s5:ye,s6:J,s7:Z,ss1:B,ss2:z,ss3:ce,ss4:ue,ss5:Ie,ss6:le,ss7:ze,sz1:Le,sz2:de,sz3:fe,sz11:st,sz12:De,sz13:Ee,sz21:Ae,sz22:He,sz23:Ve,sz31:_e,sz32:L,sz33:N,xgh2:Dg,xgh3:kW,xgh4:VW,xh2:HW,xh3:BW,xi2:gp,xi3:Eg,xl2:Zv,xl3:Qv,xl4:Yv,nm:bi,z1:Q,z2:pe,z3:Me,z11:et,z12:Je,z13:$e,z21:Ke,z22:at,z23:Ze,z31:Ge,z32:y,z33:qe,zmol:Xn,zmos:Sa}}function Kre(e){var t=e.cosim,i=e.argpo,r=e.s1,n=e.s2,s=e.s3,o=e.s4,a=e.s5,l=e.sinim,c=e.ss1,h=e.ss2,p=e.ss3,m=e.ss4,f=e.ss5,g=e.sz1,_=e.sz3,v=e.sz11,b=e.sz13,x=e.sz21,E=e.sz23,D=e.sz31,M=e.sz33,T=e.t,I=e.tc,A=e.gsto,O=e.mo,$=e.mdot,H=e.no,k=e.nodeo,K=e.nodedot,F=e.xpidot,R=e.z1,j=e.z3,B=e.z11,z=e.z13,ce=e.z21,ue=e.z23,Ie=e.z31,le=e.z33,ze=e.ecco,Le=e.eccsq,de=e.emsq,fe=e.em,st=e.argpm,De=e.inclm,Ee=e.mm,Ae=e.nm,He=e.nodem,Ve=e.irez,_e=e.atime,L=e.d2201,N=e.d2211,V=e.d3210,U=e.d3222,Y=e.d4410,re=e.d4422,ye=e.d5220,J=e.d5232,Z=e.d5421,Q=e.d5433,pe=e.dedt,Me=e.didt,et=e.dmdt,Je=e.dnodt,$e=e.domdt,Ke=e.del1,at=e.del2,Ze=e.del3,Ge=e.xfact,y=e.xlamo,qe=e.xli,je=e.xni,tt,dt,it,Ye,gt,wt,xt,bi,Ci,li,ci,jt,bt,Qe,zt,Ot,se,ri,jr,Qn,Mt,Ds,Pn,Er,xs,or,zr,eo,Ms,ar,Dr,_i,Yn=17891679e-13,Ma=21460748e-13,Gr=22123015e-14,Kn=17891679e-13,to=73636953e-16,er=21765803e-16,Xn=.0043752690880113,Sa=37393792e-14,kc=11428639e-14,Ss=.00015835218,io=119459e-10;Ve=0,Ae<.0052359877&&Ae>.0034906585&&(Ve=1),Ae>=.00826&&Ae<=.00924&&fe>=.5&&(Ve=2);var Ll=c*io*f,Ia=h*io*(v+b),pp=-io*p*(g+_-14-6*de),mp=m*io*(D+M-6),Aa=-io*h*(x+E);(De<.052359877||De>$o-.052359877)&&(Aa=0),l!==0&&(Aa/=l);var _d=mp-t*Aa;pe=Ll+r*Ss*a,Me=Ia+n*Ss*(B+z),et=pp-Ss*s*(R+j-14-6*de);var yd=o*Ss*(Ie+le-6),Is=-Ss*n*(ce+ue);(De<.052359877||De>$o-.052359877)&&(Is=0),$e=_d+yd,Je=Aa,l!==0&&($e-=t/l*Is,Je+=Is/l);var Ra=0,Vc=(A+I*Xn)%qi;if(fe+=pe*T,De+=Me*T,st+=$e*T,He+=Je*T,Ee+=et*T,Ve!==0){if(ar=Math.pow(Ae/Fc,Uv),Ve===2){Dr=t*t;var fp=fe;fe=ze;var gp=de;de=Le,_i=fe*de,Qe=-.306-(fe-.64)*.44,fe<=.65?(zt=3.616-13.247*fe+16.29*de,se=-19.302+117.39*fe-228.419*de+156.591*_i,ri=-18.9068+109.7927*fe-214.6334*de+146.5816*_i,jr=-41.122+242.694*fe-471.094*de+313.953*_i,Qn=-146.407+841.88*fe-1629.014*de+1083.435*_i,Mt=-532.114+3017.977*fe-5740.032*de+3708.276*_i):(zt=-72.099+331.819*fe-508.738*de+266.724*_i,se=-346.844+1582.851*fe-2415.925*de+1246.113*_i,ri=-342.585+1554.908*fe-2366.899*de+1215.972*_i,jr=-1052.797+4758.686*fe-7193.992*de+3651.957*_i,Qn=-3581.69+16178.11*fe-24462.77*de+12422.52*_i,fe>.715?Mt=-5149.66+29936.92*fe-54087.36*de+31324.56*_i:Mt=1464.74-4664.75*fe+3763.64*de),fe<.7?(Er=-919.2277+4988.61*fe-9064.77*de+5542.21*_i,Ds=-822.71072+4568.6173*fe-8491.4146*de+5337.524*_i,Pn=-853.666+4690.25*fe-8624.77*de+5341.4*_i):(Er=-37995.78+161616.52*fe-229838.2*de+109377.94*_i,Ds=-51752.104+218913.95*fe-309468.16*de+146349.42*_i,Pn=-40023.88+170470.89*fe-242699.48*de+115605.82*_i),xs=l*l,tt=.75*(1+2*t+Dr),dt=1.5*xs,Ye=1.875*l*(1-2*t-3*Dr),gt=-1.875*l*(1+2*t-3*Dr),xt=35*xs*tt,bi=39.375*xs*xs,Ci=9.84375*l*(xs*(1-2*t-5*Dr)+.33333333*(-2+4*t+6*Dr)),li=l*(4.92187512*xs*(-2-4*t+10*Dr)+6.56250012*(1+2*t-3*Dr)),ci=29.53125*l*(2-8*t+Dr*(-12+8*t+10*Dr)),jt=29.53125*l*(-2-8*t+Dr*(12+8*t-10*Dr)),eo=Ae*Ae,Ms=ar*ar,zr=3*eo*Ms,or=zr*Kn,L=or*tt*Qe,N=or*dt*zt,zr*=ar,or=zr*Sa,V=or*Ye*se,U=or*gt*ri,zr*=ar,or=2*zr*to,Y=or*xt*jr,re=or*bi*Qn,zr*=ar,or=zr*kc,ye=or*Ci*Mt,J=or*li*Pn,or=2*zr*er,Z=or*ci*Ds,Q=or*jt*Er,y=(O+k+k-(Vc+Vc))%qi,Ge=$+et+2*(K+Je-Xn)-H,fe=fp,de=gp}Ve===1&&(bt=1+de*(-2.5+.8125*de),se=1+2*de,Ot=1+de*(-6+6.60937*de),tt=.75*(1+t)*(1+t),it=.9375*l*l*(1+3*t)-.75*(1+t),wt=1+t,wt*=1.875*wt*wt,Ke=3*Ae*Ae*ar*ar,at=2*Ke*tt*bt*Yn,Ze=3*Ke*wt*Ot*Gr*ar,Ke=Ke*it*se*Ma*ar,y=(O+k+i-Vc)%qi,Ge=$+F+et+$e+Je-(H+Xn)),qe=y,je=H,_e=0,Ae=H+Ra}return{em:fe,argpm:st,inclm:De,mm:Ee,nm:Ae,nodem:He,irez:Ve,atime:_e,d2201:L,d2211:N,d3210:V,d3222:U,d4410:Y,d4422:re,d5220:ye,d5232:J,d5421:Z,d5433:Q,dedt:pe,didt:Me,dmdt:et,dndt:Ra,dnodt:Je,domdt:$e,del1:Ke,del2:at,del3:Ze,xfact:Ge,xlamo:y,xli:qe,xni:je}}function SN(e){var t=(e-2451545)/36525,i=-62e-7*t*t*t+.093104*t*t+(876600*3600+8640184812866e-6)*t+67310.54841;return i=i*Bv/240%qi,i<0&&(i+=qi),i}function IN(e,t,i,r,n,s,o){return e instanceof Date?SN(sx(e)):SN(t!==void 0?sx(e,t,i,r,n,s,o):e)}function Xre(e){var t=e.ecco,i=e.epoch,r=e.inclo,n=e.opsmode,s=e.no,o=t*t,a=1-o,l=Math.sqrt(a),c=Math.cos(r),h=c*c,p=Math.pow(Fc/s,Uv),m=.75*dp*(3*h-1)/(l*a),f=m/(p*p),g=p*(1-f*f-f*(1/3+134*f*f/81));f=m/(g*g),s/=1+f;var _=Math.pow(Fc/s,Uv),v=Math.sin(r),b=_*a,x=1-5*h,E=-x-h-h,D=1/_,M=b*b,T=_*(1-t),I="n",A;if(n==="a"){var O=i-7305,$=Math.floor(O+1e-8),H=O-$,k=.017202791694070362,K=1.7321343856509375,F=5075514194322695e-30,R=k+qi;A=(K+k*$+R*H+O*O*F)%qi,A<0&&(A+=qi)}else A=IN(i+24332815e-1);return{no:s,method:I,ainv:D,ao:_,con41:E,con42:x,cosio:c,cosio2:h,eccsq:o,omeosq:a,posq:M,rp:T,rteosq:l,sinio:v,gsto:A}}function Jre(e){var t=e.irez,i=e.d2201,r=e.d2211,n=e.d3210,s=e.d3222,o=e.d4410,a=e.d4422,l=e.d5220,c=e.d5232,h=e.d5421,p=e.d5433,m=e.dedt,f=e.del1,g=e.del2,_=e.del3,v=e.didt,b=e.dmdt,x=e.dnodt,E=e.domdt,D=e.argpo,M=e.argpdot,T=e.t,I=e.tc,A=e.gsto,O=e.xfact,$=e.xlamo,H=e.no,k=e.atime,K=e.em,F=e.argpm,R=e.inclm,j=e.xli,B=e.mm,z=e.xni,ce=e.nodem,ue=e.nm,Ie=.13130908,le=2.8843198,ze=.37448087,Le=5.7686396,de=.95240898,fe=1.8014998,st=1.050833,De=4.4108898,Ee=.0043752690880113,Ae=720,He=-720,Ve=259200,_e,L,N,V,U,Y,re,ye,J=0,Z=0,Q=(A+I*Ee)%qi;if(K+=m*T,R+=v*T,F+=E*T,ce+=x*T,B+=b*T,t!==0){(k===0||T*k<=0||Math.abs(T)<Math.abs(k))&&(k=0,z=H,j=$),T>0?_e=Ae:_e=He;for(var pe=381;pe===381;)t!==2?(re=f*Math.sin(j-Ie)+g*Math.sin(2*(j-le))+_*Math.sin(3*(j-ze)),U=z+O,Y=f*Math.cos(j-Ie)+2*g*Math.cos(2*(j-le))+3*_*Math.cos(3*(j-ze)),Y*=U):(ye=D+M*k,N=ye+ye,L=j+j,re=i*Math.sin(N+j-Le)+r*Math.sin(j-Le)+n*Math.sin(ye+j-de)+s*Math.sin(-ye+j-de)+o*Math.sin(N+L-fe)+a*Math.sin(L-fe)+l*Math.sin(ye+j-st)+c*Math.sin(-ye+j-st)+h*Math.sin(ye+L-De)+p*Math.sin(-ye+L-De),U=z+O,Y=i*Math.cos(N+j-Le)+r*Math.cos(j-Le)+n*Math.cos(ye+j-de)+s*Math.cos(-ye+j-de)+l*Math.cos(ye+j-st)+c*Math.cos(-ye+j-st)+2*(o*Math.cos(N+L-fe)+a*Math.cos(L-fe)+h*Math.cos(ye+L-De)+p*Math.cos(-ye+L-De)),Y*=U),Math.abs(T-k)>=Ae?pe=381:(Z=T-k,pe=0),pe===381&&(j+=U*_e+re*Ve,z+=re*_e+Y*Ve,k+=_e);ue=z+re*Z+Y*Z*Z*.5,V=j+U*Z+re*Z*Z*.5,t!==1?(B=V-2*ce+2*Q,J=ue-H):(B=V-ce-F+Q,J=ue-H),ue=H+J}return{atime:k,em:K,argpm:F,inclm:R,xli:j,mm:B,xni:z,nodem:ce,dndt:J,nm:ue}}var up=function(e){return e[e.None=0]="None",e[e.MeanEccentricityOutOfRange=1]="MeanEccentricityOutOfRange",e[e.MeanMotionBelowZero=2]="MeanMotionBelowZero",e[e.PerturbedEccentricityOutOfRange=3]="PerturbedEccentricityOutOfRange",e[e.SemiLatusRectumBelowZero=4]="SemiLatusRectumBelowZero",e[e.Decayed=6]="Decayed",e}(up||{});function aW(e,t){var i,r,n,s,o,a,l,c,h,p,m,f,g,_,v,b,x,E,D,M,T,I,A,O,$,H,k,K=15e-13;e.t=t,e.error=up.None;var F=e.mo+e.mdot*e.t,R=e.argpo+e.argpdot*e.t,j=e.nodeo+e.nodedot*e.t;h=R,T=F;var B=e.t*e.t;if(A=j+e.nodecf*B,x=1-e.cc1*e.t,E=e.bstar*e.cc4*e.t,D=e.t2cof*B,e.isimp!==1){l=e.omgcof*e.t;var z=1+e.eta*Math.cos(F);a=e.xmcof*(z*z*z-e.delmo),b=l+a,T=F+b,h=R-b,f=B*e.t,g=f*e.t,x=x-e.d2*B-e.d3*f-e.d4*g,E+=e.bstar*e.cc5*(Math.sin(T)-e.sinmao),D=D+e.t3cof*f+g*(e.t4cof+e.t*e.t5cof)}I=e.no;var ce=e.ecco;if(M=e.inclo,e.method==="d"){_=e.t;var ue={irez:e.irez,d2201:e.d2201,d2211:e.d2211,d3210:e.d3210,d3222:e.d3222,d4410:e.d4410,d4422:e.d4422,d5220:e.d5220,d5232:e.d5232,d5421:e.d5421,d5433:e.d5433,dedt:e.dedt,del1:e.del1,del2:e.del2,del3:e.del3,didt:e.didt,dmdt:e.dmdt,dnodt:e.dnodt,domdt:e.domdt,argpo:e.argpo,argpdot:e.argpdot,t:e.t,tc:_,gsto:e.gsto,xfact:e.xfact,xlamo:e.xlamo,no:e.no,atime:e.atime,em:ce,argpm:h,inclm:M,xli:e.xli,mm:T,xni:e.xni,nodem:A,nm:I},Ie=Jre(ue);ce=Ie.em,h=Ie.argpm,M=Ie.inclm,T=Ie.mm,A=Ie.nodem,I=Ie.nm}if(I<=0)return e.error=up.MeanMotionBelowZero,null;var le=Math.pow(Fc/I,Uv)*x*x;if(I=Fc/Math.pow(le,1.5),ce-=E,ce>=1||ce<-.001)return e.error=up.MeanEccentricityOutOfRange,null;ce<1e-6&&(ce=1e-6),T+=e.no*D,$=T+h+A,A%=qi,h%=qi,$%=qi,T=($-h-A)%qi;var ze={am:le,em:ce,im:M,Om:A,om:h,mm:T,nm:I},Le=Math.sin(M),de=Math.cos(M),fe=ce;if(O=M,p=h,k=A,H=T,s=Le,n=de,e.method==="d"){var st={inclo:e.inclo,init:"n",ep:fe,inclp:O,nodep:k,argpp:p,mp:H,opsmode:e.operationmode},De=oW(e,st);if(fe=De.ep,k=De.nodep,p=De.argpp,H=De.mp,O=De.inclp,O<0&&(O=-O,k+=$o,p-=$o),fe<0||fe>1)return e.error=up.PerturbedEccentricityOutOfRange,null}e.method==="d"&&(s=Math.sin(O),n=Math.cos(O),e.aycof=-.5*hp*s,Math.abs(n+1)>15e-13?e.xlcof=-.25*hp*s*(3+5*n)/(1+n):e.xlcof=-.25*hp*s*(3+5*n)/K);var Ee=fe*Math.cos(p);b=1/(le*(1-fe*fe));var Ae=fe*Math.sin(p)+b*e.aycof,He=H+p+k+b*e.xlcof*Ee,Ve=(He-k)%qi;c=Ve,v=9999.9;for(var _e=1;Math.abs(v)>=1e-12&&_e<=10;)r=Math.sin(c),i=Math.cos(c),v=1-i*Ee-r*Ae,v=(Ve-Ae*i+Ee*r-c)/v,Math.abs(v)>=.95&&(v>0?v=.95:v=-.95),c+=v,_e+=1;var L=Ee*i+Ae*r,N=Ee*r-Ae*i,V=Ee*Ee+Ae*Ae,U=le*(1-V);if(U<0)return e.error=up.SemiLatusRectumBelowZero,null;var Y=le*(1-L),re=Math.sqrt(le)*N/Y,ye=Math.sqrt(U)/Y,J=Math.sqrt(1-V);b=N/(1+J);var Z=le/Y*(r-Ae-Ee*b),Q=le/Y*(i-Ee+Ae*b);m=Math.atan2(Z,Q);var pe=(Q+Q)*Z,Me=1-2*Z*Z;b=1/U;var et=.5*dp*b,Je=et*b;e.method==="d"&&(o=n*n,e.con41=3*o-1,e.x1mth2=1-o,e.x7thm1=7*o-1);var $e=Y*(1-1.5*Je*J*e.con41)+.5*et*e.x1mth2*Me;if($e<1)return e.error=up.Decayed,null;m-=.25*Je*e.x7thm1*pe;var Ke=k+1.5*Je*n*pe,at=O+1.5*Je*n*s*Me,Ze=re-I*et*e.x1mth2*pe/Fc,Ge=ye+I*et*(e.x1mth2*Me+1.5*e.con41)/Fc,y=Math.sin(m),qe=Math.cos(m),je=Math.sin(Ke),tt=Math.cos(Ke),dt=Math.sin(at),it=Math.cos(at),Ye=-je*it,gt=tt*it,wt=Ye*y+tt*qe,xt=gt*y+je*qe,bi=dt*y,Ci=Ye*qe-tt*y,li=gt*qe-je*y,ci=dt*qe,jt={x:$e*wt*Js,y:$e*xt*Js,z:$e*bi*Js},bt={x:(Ze*wt+Ge*Ci)*MN,y:(Ze*xt+Ge*li)*MN,z:(Ze*bi+Ge*ci)*MN};return{position:jt,velocity:bt,meanElements:ze}}function ene(e,t){var i=t.opsmode,r=t.satn,n=t.epoch,s=t.xbstar,o=t.xecco,a=t.xargpo,l=t.xinclo,c=t.xmo,h=t.xno,p=t.xnodeo,m,f,g,_,v,b,x,E,D,M,T,I,A,O,$,H,k,K,F,R,j,B,z,ce,ue,Ie,le,ze,Le,de,fe,st,De,Ee,Ae,He,Ve,_e,L,N,V,U,Y,re,ye,J,Z,Q,pe,Me,et,Je,$e,Ke,at,Ze,Ge=15e-13,y=e;y.isimp=0,y.method="n",y.aycof=0,y.con41=0,y.cc1=0,y.cc4=0,y.cc5=0,y.d2=0,y.d3=0,y.d4=0,y.delmo=0,y.eta=0,y.argpdot=0,y.omgcof=0,y.sinmao=0,y.t=0,y.t2cof=0,y.t3cof=0,y.t4cof=0,y.t5cof=0,y.x1mth2=0,y.x7thm1=0,y.mdot=0,y.nodedot=0,y.xlcof=0,y.xmcof=0,y.nodecf=0,y.irez=0,y.d2201=0,y.d2211=0,y.d3210=0,y.d3222=0,y.d4410=0,y.d4422=0,y.d5220=0,y.d5232=0,y.d5421=0,y.d5433=0,y.dedt=0,y.del1=0,y.del2=0,y.del3=0,y.didt=0,y.dmdt=0,y.dnodt=0,y.domdt=0,y.e3=0,y.ee2=0,y.peo=0,y.pgho=0,y.pho=0,y.pinco=0,y.plo=0,y.se2=0,y.se3=0,y.sgh2=0,y.sgh3=0,y.sgh4=0,y.sh2=0,y.sh3=0,y.si2=0,y.si3=0,y.sl2=0,y.sl3=0,y.sl4=0,y.gsto=0,y.xfact=0,y.xgh2=0,y.xgh3=0,y.xgh4=0,y.xh2=0,y.xh3=0,y.xi2=0,y.xi3=0,y.xl2=0,y.xl3=0,y.xl4=0,y.xlamo=0,y.zmol=0,y.zmos=0,y.atime=0,y.xli=0,y.xni=0,y.bstar=s,y.ecco=o,y.argpo=a,y.inclo=l,y.mo=c,y.no=h,y.nodeo=p,y.operationmode=i;var qe=78/Js+1,je=42/Js,tt=je*je*je*je;y.init="y",y.t=0;var dt={satn:r,ecco:y.ecco,epoch:n,inclo:y.inclo,no:y.no,method:y.method,opsmode:y.operationmode},it=Xre(dt),Ye=it.ao,gt=it.con42,wt=it.cosio,xt=it.cosio2,bi=it.eccsq,Ci=it.omeosq,li=it.posq,ci=it.rp,jt=it.rteosq,bt=it.sinio;if(y.no=it.no,y.con41=it.con41,y.gsto=it.gsto,y.a=Math.pow(y.no*qre,-2/3),y.alta=y.a*(1+y.ecco)-1,y.altp=y.a*(1-y.ecco)-1,y.error=0,Ci>=0||y.no>=0){if(y.isimp=0,ci<220/Js+1&&(y.isimp=1),le=qe,j=tt,K=(ci-1)*Js,K<156){le=K-78,K<98&&(le=20);var Qe=(120-le)/Js;j=Qe*Qe*Qe*Qe,le=le/Js+1}F=1/li,J=1/(Ye-le),y.eta=Ye*y.ecco*J,I=y.eta*y.eta,T=y.ecco*y.eta,R=Math.abs(1-I),b=j*Math.pow(J,4),x=b/Math.pow(R,3.5),_=x*y.no*(Ye*(1+1.5*I+T*(4+I))+.375*dp*J/R*y.con41*(8+3*I*(8+I))),y.cc1=y.bstar*_,v=0,y.ecco>1e-4&&(v=-2*b*J*hp*y.no*bt/y.ecco),y.x1mth2=1-xt,y.cc4=2*y.no*x*Ye*Ci*(y.eta*(2+.5*I)+y.ecco*(.5+2*I)-dp*J/(Ye*R)*(-3*y.con41*(1-2*T+I*(1.5-.5*T))+.75*y.x1mth2*(2*I-T*(1+I))*Math.cos(2*y.argpo))),y.cc5=2*x*Ye*Ci*(1+2.75*(I+T)+T*I),E=xt*xt,Y=1.5*dp*F*y.no,re=.5*Y*dp*F,ye=-.46875*$re*F*F*y.no,y.mdot=y.no+.5*Y*jt*y.con41+.0625*re*jt*(13-78*xt+137*E),y.argpdot=-.5*Y*gt+.0625*re*(7-114*xt+395*E)+ye*(3-36*xt+49*E),Q=-Y*wt,y.nodedot=Q+(.5*re*(4-19*xt)+2*ye*(3-7*xt))*wt,Z=y.argpdot+y.nodedot,y.omgcof=y.bstar*v*Math.cos(y.argpo),y.xmcof=0,y.ecco>1e-4&&(y.xmcof=-Uv*b*y.bstar/T),y.nodecf=3.5*Ci*Q*y.cc1,y.t2cof=1.5*y.cc1,Math.abs(wt+1)>15e-13?y.xlcof=-.25*hp*bt*(3+5*wt)/(1+wt):y.xlcof=-.25*hp*bt*(3+5*wt)/Ge,y.aycof=-.5*hp*bt;var zt=1+y.eta*Math.cos(y.mo);if(y.delmo=zt*zt*zt,y.sinmao=Math.sin(y.mo),y.x7thm1=7*xt-1,2*$o/y.no>=225){y.method="d",y.isimp=1,V=0,$=y.inclo;var Ot={epoch:n,ep:y.ecco,argpp:y.argpo,tc:V,inclp:y.inclo,nodep:y.nodeo,np:y.no,e3:y.e3,ee2:y.ee2,peo:y.peo,pgho:y.pgho,pho:y.pho,pinco:y.pinco,plo:y.plo,se2:y.se2,se3:y.se3,sgh2:y.sgh2,sgh3:y.sgh3,sgh4:y.sgh4,sh2:y.sh2,sh3:y.sh3,si2:y.si2,si3:y.si3,sl2:y.sl2,sl3:y.sl3,sl4:y.sl4,xgh2:y.xgh2,xgh3:y.xgh3,xgh4:y.xgh4,xh2:y.xh2,xh3:y.xh3,xi2:y.xi2,xi3:y.xi3,xl2:y.xl2,xl3:y.xl3,xl4:y.xl4,zmol:y.zmol,zmos:y.zmos},se=Yre(Ot);y.e3=se.e3,y.ee2=se.ee2,y.peo=se.peo,y.pgho=se.pgho,y.pho=se.pho,y.pinco=se.pinco,y.plo=se.plo,y.se2=se.se2,y.se3=se.se3,y.sgh2=se.sgh2,y.sgh3=se.sgh3,y.sgh4=se.sgh4,y.sh2=se.sh2,y.sh3=se.sh3,y.si2=se.si2,y.si3=se.si3,y.sl2=se.sl2,y.sl3=se.sl3,y.sl4=se.sl4,f=se.sinim,m=se.cosim,D=se.em,M=se.emsq,B=se.s1,z=se.s2,ce=se.s3,ue=se.s4,Ie=se.s5,ze=se.ss1,Le=se.ss2,de=se.ss3,fe=se.ss4,st=se.ss5,De=se.sz1,Ee=se.sz3,Ae=se.sz11,He=se.sz13,Ve=se.sz21,_e=se.sz23,L=se.sz31,N=se.sz33,y.xgh2=se.xgh2,y.xgh3=se.xgh3,y.xgh4=se.xgh4,y.xh2=se.xh2,y.xh3=se.xh3,y.xi2=se.xi2,y.xi3=se.xi3,y.xl2=se.xl2,y.xl3=se.xl3,y.xl4=se.xl4,y.zmol=se.zmol,y.zmos=se.zmos,k=se.nm,pe=se.z1,Me=se.z3,et=se.z11,Je=se.z13,$e=se.z21,Ke=se.z23,at=se.z31,Ze=se.z33;var ri={inclo:$,init:y.init,ep:y.ecco,inclp:y.inclo,nodep:y.nodeo,argpp:y.argpo,mp:y.mo,opsmode:y.operationmode},jr=oW(y,ri);y.ecco=jr.ep,y.inclo=jr.inclp,y.nodeo=jr.nodep,y.argpo=jr.argpp,y.mo=jr.mp,A=0,O=0,H=0;var Qn={cosim:m,emsq:M,argpo:y.argpo,s1:B,s2:z,s3:ce,s4:ue,s5:Ie,sinim:f,ss1:ze,ss2:Le,ss3:de,ss4:fe,ss5:st,sz1:De,sz3:Ee,sz11:Ae,sz13:He,sz21:Ve,sz23:_e,sz31:L,sz33:N,t:y.t,tc:V,gsto:y.gsto,mo:y.mo,mdot:y.mdot,no:y.no,nodeo:y.nodeo,nodedot:y.nodedot,xpidot:Z,z1:pe,z3:Me,z11:et,z13:Je,z21:$e,z23:Ke,z31:at,z33:Ze,ecco:y.ecco,eccsq:bi,em:D,argpm:A,inclm:$,mm:H,nm:k,nodem:O,irez:y.irez,atime:y.atime,d2201:y.d2201,d2211:y.d2211,d3210:y.d3210,d3222:y.d3222,d4410:y.d4410,d4422:y.d4422,d5220:y.d5220,d5232:y.d5232,d5421:y.d5421,d5433:y.d5433,dedt:y.dedt,didt:y.didt,dmdt:y.dmdt,dnodt:y.dnodt,domdt:y.domdt,del1:y.del1,del2:y.del2,del3:y.del3,xfact:y.xfact,xlamo:y.xlamo,xli:y.xli,xni:y.xni},Mt=Kre(Qn);y.irez=Mt.irez,y.atime=Mt.atime,y.d2201=Mt.d2201,y.d2211=Mt.d2211,y.d3210=Mt.d3210,y.d3222=Mt.d3222,y.d4410=Mt.d4410,y.d4422=Mt.d4422,y.d5220=Mt.d5220,y.d5232=Mt.d5232,y.d5421=Mt.d5421,y.d5433=Mt.d5433,y.dedt=Mt.dedt,y.didt=Mt.didt,y.dmdt=Mt.dmdt,y.dnodt=Mt.dnodt,y.domdt=Mt.domdt,y.del1=Mt.del1,y.del2=Mt.del2,y.del3=Mt.del3,y.xfact=Mt.xfact,y.xlamo=Mt.xlamo,y.xli=Mt.xli,y.xni=Mt.xni}y.isimp!==1&&(g=y.cc1*y.cc1,y.d2=4*Ye*J*g,U=y.d2*J*y.cc1/3,y.d3=(17*Ye+le)*U,y.d4=.5*U*Ye*J*(221*Ye+31*le)*y.cc1,y.t3cof=y.d2+2*g,y.t4cof=.25*(3*y.d3+y.cc1*(12*y.d2+10*g)),y.t5cof=.2*(3*y.d4+12*y.cc1*y.d3+6*y.d2*y.d2+15*g*(2*y.d2+g)))}aW(y,0),y.init="n"}function lW(e,t){var i="i",r=0,n=e.substring(2,7),s=parseInt(e.substring(18,20),10),o=parseFloat(e.substring(20,32)),a=parseFloat(e.substring(33,43)),l=parseFloat("".concat(e.substring(44,45),".").concat(e.substring(45,50),"E").concat(e.substring(50,52))),c=parseFloat("".concat(e.substring(53,54),".").concat(e.substring(54,59),"E").concat(e.substring(59,61))),h=parseFloat(t.substring(8,16))*Bv,p=parseFloat(t.substring(17,25))*Bv,m=parseFloat(".".concat(t.substring(26,33))),f=parseFloat(t.substring(34,42))*Bv,g=parseFloat(t.substring(43,51))*Bv,_=parseFloat(t.substring(52,63))/Zre,v=s<57?s+2e3:s+1900,b=Qre(v,o),x=b.mon,E=b.day,D=b.hr,M=b.minute,T=b.sec,I=sx(v,x,E,D,M,T),A={error:r,satnum:n,epochyr:s,epochdays:o,ndot:a,nddot:l,bstar:c,inclo:h,nodeo:p,ecco:m,argpo:f,mo:g,no:_,jdsatepoch:I};return ene(A,{opsmode:i,satn:A.satnum,epoch:A.jdsatepoch-24332815e-1,xbstar:A.bstar,xecco:A.ecco,xargpo:A.argpo,xinclo:A.inclo,xmo:A.mo,xno:A.no,xnodeo:A.nodeo}),A}function cW(e){for(var t=arguments.length,i=new Array(t>1?t-1:0),r=1;r<t;r++)i[r-1]=arguments[r];var n=sx.apply(void 0,i),s=(n-e.jdsatepoch)*zre;return aW(e,s)}function uW(e,t){for(var i=6378.137,r=6356.7523142,n=Math.sqrt(e.x*e.x+e.y*e.y),s=(i-r)/i,o=2*s-s*s,a=Math.atan2(e.y,e.x)-t;a<-$o;)a+=qi;for(;a>$o;)a-=qi;for(var l=20,c=0,h=Math.atan2(e.z,Math.sqrt(e.x*e.x+e.y*e.y)),p;c++<l;)p=1/Math.sqrt(1-o*(Math.sin(h)*Math.sin(h))),h=Math.atan2(e.z+i*p*o*Math.sin(h),n);var m=n/Math.cos(h)-i*p;return{longitude:a,latitude:h,height:m}}var wg=class e{satellitesSubject=new pa([]);satellites$=this.satellitesSubject.asObservable();satellites=[];async loadBaseSatellites(t){let r=(await bp(t,{responseType:"text"})).data.split(`
`),n=Math.floor(r.length/3),s=Date.now();for(let o=0;o<n;o++){let a=r[o*3].trim(),l=r[o*3+1].trim(),c=r[o*3+2].trim();!a||!l||!c||a.includes("COSMOS")&&this.satellites.push({name:a,line1:l,line2:c,time:s,origin:"base"})}this.satellitesSubject.next([...this.satellites])}addUserSatellite(t,i,r){let n={name:t,line1:i,line2:r,time:Date.now(),origin:"user"};this.satellites.push(n),this.satellitesSubject.next([...this.satellites])}getAllSatellites(){return this.satellites}static \u0275fac=function(i){return new(i||e)};static \u0275prov=Zt({token:e,factory:e.\u0275fac,providedIn:"root"})};var ine=["viewDiv"],ox=class e{constructor(t){this.satelliteService=t}subscription;viewDiv;async ngAfterViewInit(){let t=new Qg,i=new Qg,r=new xu({basemap:"satellite",layers:[t,i]}),n=new nW({container:this.viewDiv.nativeElement,map:r,constraints:{altitude:{max:12e9}},popup:new Wk({dockEnabled:!0,dockOptions:{breakpoint:!1}}),environment:{lighting:{type:"virtual"}}});S(()=>n.popup?.selectedFeature,()=>i.removeAll()),n.popup?.on("trigger-action",o=>{if(o.action.id==="track"){i.removeAll();let a=n.popup?.selectedFeature,l=[];for(let h=0;h<60*24;h++){let p=this.getSatelliteLocation(new Date(a?.attributes.time+h*60*1e3),a?.attributes.line1,a?.attributes.line2);p&&l.push([p.x,p.y,p.z])}let c=new rs({geometry:{type:"polyline",paths:[l]},symbol:{type:"line-3d",symbolLayers:[{type:"line",material:{color:[192,192,192,.5]},size:3}]}});i.add(c)}});let s="https://developers.arcgis.com/javascript/latest/sample-code/satellites-3d/live/brightest.txt";console.log("Loaded base satellites!"),this.subscription=this.satelliteService.satellites$.subscribe(o=>{console.log("Received satellites:",o),t.removeAll(),i.removeAll();for(let a of o){let l=Date.now(),c=a.line1.substring(9,16),h=Number(c.substring(0,2))>=57?`19${c.substring(0,2)}`:`20${c.substring(0,2)}`,p=Number(c.substring(2,5)).toString(),m=Number(a.line1.substring(2,7)),f=this.getSatelliteLocation(new Date(l),a.line1,a.line2);if(!f)continue;let g={title:"{name}",content:"Launch number {number} of {year}"};t.add(new rs({geometry:f,symbol:{type:"picture-marker",url:"https://developers.arcgis.com/javascript/latest/sample-code/satellites-3d/live/satellite.png",width:48,height:48},attributes:{name:a.name,line1:a.line1,line2:a.line2,time:l,year:h,number:p,id:m},popupTemplate:g}));let _=[],v=15;for(let x=0;x<v*24;x++){let E=new Date(l+x*v*1e3),D=this.getSatelliteLocation(E,a.line1,a.line2);D&&_.push([D.x,D.y,D.z])}let b=new rs({geometry:{type:"polyline",paths:[_]},symbol:{type:"line-3d",symbolLayers:[{type:"line",material:{color:[192,192,192,.5]},size:2}]}});i.add(b)}}),await this.satelliteService.loadBaseSatellites(s)}getSatelliteLocation(t,i,r){try{let n=lW(i,r),s=cW(n,t.getUTCFullYear(),t.getUTCMonth()+1,t.getUTCDate(),t.getUTCHours(),t.getUTCMinutes(),t.getUTCSeconds());if(!s||!s.position)return null;let o=s.position,a=IN(t),l=uW(o,a),c=180/Math.PI;return{type:"point",x:c*l.longitude,y:c*l.latitude,z:l.height*1e3}}catch{return null}}ngOnDestroy(){this.subscription?.unsubscribe()}static \u0275fac=function(i){return new(i||e)(It(wg))};static \u0275cmp=Bs({type:e,selectors:[["app-map-3-d"]],viewQuery:function(i,r){if(i&1&&hA(ine,7),i&2){let n;pA(n=mA())&&(r.viewDiv=n.first)}},decls:2,vars:0,consts:[["viewDiv",""],[2,"width","100%","height","85vh"]],template:function(i,r){i&1&&Lr(0,"div",1,0)},styles:["[_nghost-%COMP%]{display:block;height:100%}#viewDiv[_ngcontent-%COMP%]{width:100%;height:100%}"]})};var wW=(()=>{class e{_renderer;_elementRef;onChange=i=>{};onTouched=()=>{};constructor(i,r){this._renderer=i,this._elementRef=r}setProperty(i,r){this._renderer.setProperty(this._elementRef.nativeElement,i,r)}registerOnTouched(i){this.onTouched=i}registerOnChange(i){this.onChange=i}setDisabledState(i){this.setProperty("disabled",i)}static \u0275fac=function(r){return new(r||e)(It(k_),It(oc))};static \u0275dir=gs({type:e})}return e})(),rne=(()=>{class e extends wW{static \u0275fac=(()=>{let i;return function(n){return(i||(i=uC(e)))(n||e)}})();static \u0275dir=gs({type:e,features:[sl]})}return e})(),bW=new ht("");var nne={provide:bW,useExisting:ec(()=>mx),multi:!0};function sne(){let e=Eu()?Eu().getUserAgent():"";return/android (\d+)/.test(e.toLowerCase())}var one=new ht(""),mx=(()=>{class e extends wW{_compositionMode;_composing=!1;constructor(i,r,n){super(i,r),this._compositionMode=n,this._compositionMode==null&&(this._compositionMode=!sne())}writeValue(i){let r=i??"";this.setProperty("value",r)}_handleInput(i){(!this._compositionMode||this._compositionMode&&!this._composing)&&this.onChange(i)}_compositionStart(){this._composing=!0}_compositionEnd(i){this._composing=!1,this._compositionMode&&this.onChange(i)}static \u0275fac=function(r){return new(r||e)(It(k_),It(oc),It(one,8))};static \u0275dir=gs({type:e,selectors:[["input","formControlName","",3,"type","checkbox"],["textarea","formControlName",""],["input","formControl","",3,"type","checkbox"],["textarea","formControl",""],["input","ngModel","",3,"type","checkbox"],["textarea","ngModel",""],["","ngDefaultControl",""]],hostBindings:function(r,n){r&1&&_s("input",function(o){return n._handleInput(o.target.value)})("blur",function(){return n.onTouched()})("compositionstart",function(){return n._compositionStart()})("compositionend",function(o){return n._compositionEnd(o.target.value)})},standalone:!1,features:[Gm([nne]),sl]})}return e})();function ane(e){return e==null||lne(e)===0}function lne(e){return e==null?null:Array.isArray(e)||typeof e=="string"?e.length:e instanceof Set?e.size:null}var ON=new ht(""),CW=new ht("");function cne(e){return ane(e.value)?{required:!0}:null}function hW(e){return null}function TW(e){return e!=null}function EW(e){return H_(e)?$d(e):e}function DW(e){let t={};return e.forEach(i=>{t=i!=null?ie(ie({},t),i):t}),Object.keys(t).length===0?null:t}function xW(e,t){return t.map(i=>i(e))}function une(e){return!e.validate}function MW(e){return e.map(t=>une(t)?t:i=>t.validate(i))}function dne(e){if(!e)return null;let t=e.filter(TW);return t.length==0?null:function(i){return DW(xW(i,t))}}function NN(e){return e!=null?dne(MW(e)):null}function hne(e){if(!e)return null;let t=e.filter(TW);return t.length==0?null:function(i){let r=xW(i,t).map(EW);return YM(r).pipe(hs(DW))}}function LN(e){return e!=null?hne(MW(e)):null}function pW(e,t){return e===null?[t]:Array.isArray(e)?[...e,t]:[e,t]}function pne(e){return e._rawValidators}function mne(e){return e._rawAsyncValidators}function AN(e){return e?Array.isArray(e)?e:[e]:[]}function lx(e,t){return Array.isArray(e)?e.includes(t):e===t}function mW(e,t){let i=AN(t);return AN(e).forEach(n=>{lx(i,n)||i.push(n)}),i}function fW(e,t){return AN(t).filter(i=>!lx(e,i))}var cx=class{get value(){return this.control?this.control.value:null}get valid(){return this.control?this.control.valid:null}get invalid(){return this.control?this.control.invalid:null}get pending(){return this.control?this.control.pending:null}get disabled(){return this.control?this.control.disabled:null}get enabled(){return this.control?this.control.enabled:null}get errors(){return this.control?this.control.errors:null}get pristine(){return this.control?this.control.pristine:null}get dirty(){return this.control?this.control.dirty:null}get touched(){return this.control?this.control.touched:null}get status(){return this.control?this.control.status:null}get untouched(){return this.control?this.control.untouched:null}get statusChanges(){return this.control?this.control.statusChanges:null}get valueChanges(){return this.control?this.control.valueChanges:null}get path(){return null}_composedValidatorFn;_composedAsyncValidatorFn;_rawValidators=[];_rawAsyncValidators=[];_setValidators(t){this._rawValidators=t||[],this._composedValidatorFn=NN(this._rawValidators)}_setAsyncValidators(t){this._rawAsyncValidators=t||[],this._composedAsyncValidatorFn=LN(this._rawAsyncValidators)}get validator(){return this._composedValidatorFn||null}get asyncValidator(){return this._composedAsyncValidatorFn||null}_onDestroyCallbacks=[];_registerOnDestroy(t){this._onDestroyCallbacks.push(t)}_invokeOnDestroyCallbacks(){this._onDestroyCallbacks.forEach(t=>t()),this._onDestroyCallbacks=[]}reset(t=void 0){this.control&&this.control.reset(t)}hasError(t,i){return this.control?this.control.hasError(t,i):!1}getError(t,i){return this.control?this.control.getError(t,i):null}},Tg=class extends cx{name;get formDirective(){return null}get path(){return null}},$v=class extends cx{_parent=null;name=null;valueAccessor=null},ux=class{_cd;constructor(t){this._cd=t}get isTouched(){return this._cd?.control?._touched?.(),!!this._cd?.control?.touched}get isUntouched(){return!!this._cd?.control?.untouched}get isPristine(){return this._cd?.control?._pristine?.(),!!this._cd?.control?.pristine}get isDirty(){return!!this._cd?.control?.dirty}get isValid(){return this._cd?.control?._status?.(),!!this._cd?.control?.valid}get isInvalid(){return!!this._cd?.control?.invalid}get isPending(){return!!this._cd?.control?.pending}get isSubmitted(){return this._cd?._submitted?.(),!!this._cd?.submitted}},fne={"[class.ng-untouched]":"isUntouched","[class.ng-touched]":"isTouched","[class.ng-pristine]":"isPristine","[class.ng-dirty]":"isDirty","[class.ng-valid]":"isValid","[class.ng-invalid]":"isInvalid","[class.ng-pending]":"isPending"},ZSt=be(ie({},fne),{"[class.ng-submitted]":"isSubmitted"}),SW=(()=>{class e extends ux{constructor(i){super(i)}static \u0275fac=function(r){return new(r||e)(It($v,2))};static \u0275dir=gs({type:e,selectors:[["","formControlName",""],["","ngModel",""],["","formControl",""]],hostVars:14,hostBindings:function(r,n){r&2&&ya("ng-untouched",n.isUntouched)("ng-touched",n.isTouched)("ng-pristine",n.isPristine)("ng-dirty",n.isDirty)("ng-valid",n.isValid)("ng-invalid",n.isInvalid)("ng-pending",n.isPending)},standalone:!1,features:[sl]})}return e})(),IW=(()=>{class e extends ux{constructor(i){super(i)}static \u0275fac=function(r){return new(r||e)(It(Tg,10))};static \u0275dir=gs({type:e,selectors:[["","formGroupName",""],["","formArrayName",""],["","ngModelGroup",""],["","formGroup",""],["form",3,"ngNoForm",""],["","ngForm",""]],hostVars:16,hostBindings:function(r,n){r&2&&ya("ng-untouched",n.isUntouched)("ng-touched",n.isTouched)("ng-pristine",n.isPristine)("ng-dirty",n.isDirty)("ng-valid",n.isValid)("ng-invalid",n.isInvalid)("ng-pending",n.isPending)("ng-submitted",n.isSubmitted)},standalone:!1,features:[sl]})}return e})();var jv="VALID",ax="INVALID",bg="PENDING",zv="DISABLED",gd=class{},dx=class extends gd{value;source;constructor(t,i){super(),this.value=t,this.source=i}},qv=class extends gd{pristine;source;constructor(t,i){super(),this.pristine=t,this.source=i}},Wv=class extends gd{touched;source;constructor(t,i){super(),this.touched=t,this.source=i}},Cg=class extends gd{status;source;constructor(t,i){super(),this.status=t,this.source=i}},RN=class extends gd{source;constructor(t){super(),this.source=t}},PN=class extends gd{source;constructor(t){super(),this.source=t}};function AW(e){return(fx(e)?e.validators:e)||null}function gne(e){return Array.isArray(e)?NN(e):e||null}function RW(e,t){return(fx(t)?t.asyncValidators:e)||null}function _ne(e){return Array.isArray(e)?LN(e):e||null}function fx(e){return e!=null&&!Array.isArray(e)&&typeof e=="object"}function yne(e,t,i){let r=e.controls;if(!(t?Object.keys(r):r).length)throw new ct(1e3,"");if(!r[i])throw new ct(1001,"")}function vne(e,t,i){e._forEachChild((r,n)=>{if(i[n]===void 0)throw new ct(1002,"")})}var hx=class{_pendingDirty=!1;_hasOwnPendingAsyncValidator=null;_pendingTouched=!1;_onCollectionChange=()=>{};_updateOn;_parent=null;_asyncValidationSubscription;_composedValidatorFn;_composedAsyncValidatorFn;_rawValidators;_rawAsyncValidators;value;constructor(t,i){this._assignValidators(t),this._assignAsyncValidators(i)}get validator(){return this._composedValidatorFn}set validator(t){this._rawValidators=this._composedValidatorFn=t}get asyncValidator(){return this._composedAsyncValidatorFn}set asyncValidator(t){this._rawAsyncValidators=this._composedAsyncValidatorFn=t}get parent(){return this._parent}get status(){return lc(this.statusReactive)}set status(t){lc(()=>this.statusReactive.set(t))}_status=qm(()=>this.statusReactive());statusReactive=ch(void 0);get valid(){return this.status===jv}get invalid(){return this.status===ax}get pending(){return this.status==bg}get disabled(){return this.status===zv}get enabled(){return this.status!==zv}errors;get pristine(){return lc(this.pristineReactive)}set pristine(t){lc(()=>this.pristineReactive.set(t))}_pristine=qm(()=>this.pristineReactive());pristineReactive=ch(!0);get dirty(){return!this.pristine}get touched(){return lc(this.touchedReactive)}set touched(t){lc(()=>this.touchedReactive.set(t))}_touched=qm(()=>this.touchedReactive());touchedReactive=ch(!1);get untouched(){return!this.touched}_events=new Xa;events=this._events.asObservable();valueChanges;statusChanges;get updateOn(){return this._updateOn?this._updateOn:this.parent?this.parent.updateOn:"change"}setValidators(t){this._assignValidators(t)}setAsyncValidators(t){this._assignAsyncValidators(t)}addValidators(t){this.setValidators(mW(t,this._rawValidators))}addAsyncValidators(t){this.setAsyncValidators(mW(t,this._rawAsyncValidators))}removeValidators(t){this.setValidators(fW(t,this._rawValidators))}removeAsyncValidators(t){this.setAsyncValidators(fW(t,this._rawAsyncValidators))}hasValidator(t){return lx(this._rawValidators,t)}hasAsyncValidator(t){return lx(this._rawAsyncValidators,t)}clearValidators(){this.validator=null}clearAsyncValidators(){this.asyncValidator=null}markAsTouched(t={}){let i=this.touched===!1;this.touched=!0;let r=t.sourceControl??this;this._parent&&!t.onlySelf&&this._parent.markAsTouched(be(ie({},t),{sourceControl:r})),i&&t.emitEvent!==!1&&this._events.next(new Wv(!0,r))}markAllAsDirty(t={}){this.markAsDirty({onlySelf:!0,emitEvent:t.emitEvent,sourceControl:this}),this._forEachChild(i=>i.markAllAsDirty(t))}markAllAsTouched(t={}){this.markAsTouched({onlySelf:!0,emitEvent:t.emitEvent,sourceControl:this}),this._forEachChild(i=>i.markAllAsTouched(t))}markAsUntouched(t={}){let i=this.touched===!0;this.touched=!1,this._pendingTouched=!1;let r=t.sourceControl??this;this._forEachChild(n=>{n.markAsUntouched({onlySelf:!0,emitEvent:t.emitEvent,sourceControl:r})}),this._parent&&!t.onlySelf&&this._parent._updateTouched(t,r),i&&t.emitEvent!==!1&&this._events.next(new Wv(!1,r))}markAsDirty(t={}){let i=this.pristine===!0;this.pristine=!1;let r=t.sourceControl??this;this._parent&&!t.onlySelf&&this._parent.markAsDirty(be(ie({},t),{sourceControl:r})),i&&t.emitEvent!==!1&&this._events.next(new qv(!1,r))}markAsPristine(t={}){let i=this.pristine===!1;this.pristine=!0,this._pendingDirty=!1;let r=t.sourceControl??this;this._forEachChild(n=>{n.markAsPristine({onlySelf:!0,emitEvent:t.emitEvent})}),this._parent&&!t.onlySelf&&this._parent._updatePristine(t,r),i&&t.emitEvent!==!1&&this._events.next(new qv(!0,r))}markAsPending(t={}){this.status=bg;let i=t.sourceControl??this;t.emitEvent!==!1&&(this._events.next(new Cg(this.status,i)),this.statusChanges.emit(this.status)),this._parent&&!t.onlySelf&&this._parent.markAsPending(be(ie({},t),{sourceControl:i}))}disable(t={}){let i=this._parentMarkedDirty(t.onlySelf);this.status=zv,this.errors=null,this._forEachChild(n=>{n.disable(be(ie({},t),{onlySelf:!0}))}),this._updateValue();let r=t.sourceControl??this;t.emitEvent!==!1&&(this._events.next(new dx(this.value,r)),this._events.next(new Cg(this.status,r)),this.valueChanges.emit(this.value),this.statusChanges.emit(this.status)),this._updateAncestors(be(ie({},t),{skipPristineCheck:i}),this),this._onDisabledChange.forEach(n=>n(!0))}enable(t={}){let i=this._parentMarkedDirty(t.onlySelf);this.status=jv,this._forEachChild(r=>{r.enable(be(ie({},t),{onlySelf:!0}))}),this.updateValueAndValidity({onlySelf:!0,emitEvent:t.emitEvent}),this._updateAncestors(be(ie({},t),{skipPristineCheck:i}),this),this._onDisabledChange.forEach(r=>r(!1))}_updateAncestors(t,i){this._parent&&!t.onlySelf&&(this._parent.updateValueAndValidity(t),t.skipPristineCheck||this._parent._updatePristine({},i),this._parent._updateTouched({},i))}setParent(t){this._parent=t}getRawValue(){return this.value}updateValueAndValidity(t={}){if(this._setInitialStatus(),this._updateValue(),this.enabled){let r=this._cancelExistingSubscription();this.errors=this._runValidator(),this.status=this._calculateStatus(),(this.status===jv||this.status===bg)&&this._runAsyncValidator(r,t.emitEvent)}let i=t.sourceControl??this;t.emitEvent!==!1&&(this._events.next(new dx(this.value,i)),this._events.next(new Cg(this.status,i)),this.valueChanges.emit(this.value),this.statusChanges.emit(this.status)),this._parent&&!t.onlySelf&&this._parent.updateValueAndValidity(be(ie({},t),{sourceControl:i}))}_updateTreeValidity(t={emitEvent:!0}){this._forEachChild(i=>i._updateTreeValidity(t)),this.updateValueAndValidity({onlySelf:!0,emitEvent:t.emitEvent})}_setInitialStatus(){this.status=this._allControlsDisabled()?zv:jv}_runValidator(){return this.validator?this.validator(this):null}_runAsyncValidator(t,i){if(this.asyncValidator){this.status=bg,this._hasOwnPendingAsyncValidator={emitEvent:i!==!1,shouldHaveEmitted:t!==!1};let r=EW(this.asyncValidator(this));this._asyncValidationSubscription=r.subscribe(n=>{this._hasOwnPendingAsyncValidator=null,this.setErrors(n,{emitEvent:i,shouldHaveEmitted:t})})}}_cancelExistingSubscription(){if(this._asyncValidationSubscription){this._asyncValidationSubscription.unsubscribe();let t=(this._hasOwnPendingAsyncValidator?.emitEvent||this._hasOwnPendingAsyncValidator?.shouldHaveEmitted)??!1;return this._hasOwnPendingAsyncValidator=null,t}return!1}setErrors(t,i={}){this.errors=t,this._updateControlsErrors(i.emitEvent!==!1,this,i.shouldHaveEmitted)}get(t){let i=t;return i==null||(Array.isArray(i)||(i=i.split(".")),i.length===0)?null:i.reduce((r,n)=>r&&r._find(n),this)}getError(t,i){let r=i?this.get(i):this;return r&&r.errors?r.errors[t]:null}hasError(t,i){return!!this.getError(t,i)}get root(){let t=this;for(;t._parent;)t=t._parent;return t}_updateControlsErrors(t,i,r){this.status=this._calculateStatus(),t&&this.statusChanges.emit(this.status),(t||r)&&this._events.next(new Cg(this.status,i)),this._parent&&this._parent._updateControlsErrors(t,i,r)}_initObservables(){this.valueChanges=new Qr,this.statusChanges=new Qr}_calculateStatus(){return this._allControlsDisabled()?zv:this.errors?ax:this._hasOwnPendingAsyncValidator||this._anyControlsHaveStatus(bg)?bg:this._anyControlsHaveStatus(ax)?ax:jv}_anyControlsHaveStatus(t){return this._anyControls(i=>i.status===t)}_anyControlsDirty(){return this._anyControls(t=>t.dirty)}_anyControlsTouched(){return this._anyControls(t=>t.touched)}_updatePristine(t,i){let r=!this._anyControlsDirty(),n=this.pristine!==r;this.pristine=r,this._parent&&!t.onlySelf&&this._parent._updatePristine(t,i),n&&this._events.next(new qv(this.pristine,i))}_updateTouched(t={},i){this.touched=this._anyControlsTouched(),this._events.next(new Wv(this.touched,i)),this._parent&&!t.onlySelf&&this._parent._updateTouched(t,i)}_onDisabledChange=[];_registerOnCollectionChange(t){this._onCollectionChange=t}_setUpdateStrategy(t){fx(t)&&t.updateOn!=null&&(this._updateOn=t.updateOn)}_parentMarkedDirty(t){let i=this._parent&&this._parent.dirty;return!t&&!!i&&!this._parent._anyControlsDirty()}_find(t){return null}_assignValidators(t){this._rawValidators=Array.isArray(t)?t.slice():t,this._composedValidatorFn=gne(this._rawValidators)}_assignAsyncValidators(t){this._rawAsyncValidators=Array.isArray(t)?t.slice():t,this._composedAsyncValidatorFn=_ne(this._rawAsyncValidators)}},px=class extends hx{constructor(t,i,r){super(AW(i),RW(r,i)),this.controls=t,this._initObservables(),this._setUpdateStrategy(i),this._setUpControls(),this.updateValueAndValidity({onlySelf:!0,emitEvent:!!this.asyncValidator})}controls;registerControl(t,i){return this.controls[t]?this.controls[t]:(this.controls[t]=i,i.setParent(this),i._registerOnCollectionChange(this._onCollectionChange),i)}addControl(t,i,r={}){this.registerControl(t,i),this.updateValueAndValidity({emitEvent:r.emitEvent}),this._onCollectionChange()}removeControl(t,i={}){this.controls[t]&&this.controls[t]._registerOnCollectionChange(()=>{}),delete this.controls[t],this.updateValueAndValidity({emitEvent:i.emitEvent}),this._onCollectionChange()}setControl(t,i,r={}){this.controls[t]&&this.controls[t]._registerOnCollectionChange(()=>{}),delete this.controls[t],i&&this.registerControl(t,i),this.updateValueAndValidity({emitEvent:r.emitEvent}),this._onCollectionChange()}contains(t){return this.controls.hasOwnProperty(t)&&this.controls[t].enabled}setValue(t,i={}){vne(this,!0,t),Object.keys(t).forEach(r=>{yne(this,!0,r),this.controls[r].setValue(t[r],{onlySelf:!0,emitEvent:i.emitEvent})}),this.updateValueAndValidity(i)}patchValue(t,i={}){t!=null&&(Object.keys(t).forEach(r=>{let n=this.controls[r];n&&n.patchValue(t[r],{onlySelf:!0,emitEvent:i.emitEvent})}),this.updateValueAndValidity(i))}reset(t={},i={}){this._forEachChild((r,n)=>{r.reset(t?t[n]:null,{onlySelf:!0,emitEvent:i.emitEvent})}),this._updatePristine(i,this),this._updateTouched(i,this),this.updateValueAndValidity(i)}getRawValue(){return this._reduceChildren({},(t,i,r)=>(t[r]=i.getRawValue(),t))}_syncPendingControls(){let t=this._reduceChildren(!1,(i,r)=>r._syncPendingControls()?!0:i);return t&&this.updateValueAndValidity({onlySelf:!0}),t}_forEachChild(t){Object.keys(this.controls).forEach(i=>{let r=this.controls[i];r&&t(r,i)})}_setUpControls(){this._forEachChild(t=>{t.setParent(this),t._registerOnCollectionChange(this._onCollectionChange)})}_updateValue(){this.value=this._reduceValue()}_anyControls(t){for(let[i,r]of Object.entries(this.controls))if(this.contains(i)&&t(r))return!0;return!1}_reduceValue(){let t={};return this._reduceChildren(t,(i,r,n)=>((r.enabled||this.disabled)&&(i[n]=r.value),i))}_reduceChildren(t,i){let r=t;return this._forEachChild((n,s)=>{r=i(r,n,s)}),r}_allControlsDisabled(){for(let t of Object.keys(this.controls))if(this.controls[t].enabled)return!1;return Object.keys(this.controls).length>0||this.disabled}_find(t){return this.controls.hasOwnProperty(t)?this.controls[t]:null}};var FN=new ht("",{providedIn:"root",factory:()=>kN}),kN="always";function wne(e,t){return[...t.path,e]}function PW(e,t,i=kN){OW(e,t),t.valueAccessor.writeValue(e.value),(e.disabled||i==="always")&&t.valueAccessor.setDisabledState?.(e.disabled),Cne(e,t),Ene(e,t),Tne(e,t),bne(e,t)}function gW(e,t){e.forEach(i=>{i.registerOnValidatorChange&&i.registerOnValidatorChange(t)})}function bne(e,t){if(t.valueAccessor.setDisabledState){let i=r=>{t.valueAccessor.setDisabledState(r)};e.registerOnDisabledChange(i),t._registerOnDestroy(()=>{e._unregisterOnDisabledChange(i)})}}function OW(e,t){let i=pne(e);t.validator!==null?e.setValidators(pW(i,t.validator)):typeof i=="function"&&e.setValidators([i]);let r=mne(e);t.asyncValidator!==null?e.setAsyncValidators(pW(r,t.asyncValidator)):typeof r=="function"&&e.setAsyncValidators([r]);let n=()=>e.updateValueAndValidity();gW(t._rawValidators,n),gW(t._rawAsyncValidators,n)}function Cne(e,t){t.valueAccessor.registerOnChange(i=>{e._pendingValue=i,e._pendingChange=!0,e._pendingDirty=!0,e.updateOn==="change"&&NW(e,t)})}function Tne(e,t){t.valueAccessor.registerOnTouched(()=>{e._pendingTouched=!0,e.updateOn==="blur"&&e._pendingChange&&NW(e,t),e.updateOn!=="submit"&&e.markAsTouched()})}function NW(e,t){e._pendingDirty&&e.markAsDirty(),e.setValue(e._pendingValue,{emitModelToViewChange:!1}),t.viewToModelUpdate(e._pendingValue),e._pendingChange=!1}function Ene(e,t){let i=(r,n)=>{t.valueAccessor.writeValue(r),n&&t.viewToModelUpdate(r)};e.registerOnChange(i),t._registerOnDestroy(()=>{e._unregisterOnChange(i)})}function Dne(e,t){e==null,OW(e,t)}function xne(e,t){if(!e.hasOwnProperty("model"))return!1;let i=e.model;return i.isFirstChange()?!0:!Object.is(t,i.currentValue)}function Mne(e){return Object.getPrototypeOf(e.constructor)===rne}function Sne(e,t){e._syncPendingControls(),t.forEach(i=>{let r=i.control;r.updateOn==="submit"&&r._pendingChange&&(i.viewToModelUpdate(r._pendingValue),r._pendingChange=!1)})}function Ine(e,t){if(!t)return null;Array.isArray(t);let i,r,n;return t.forEach(s=>{s.constructor===mx?i=s:Mne(s)?r=s:n=s}),n||r||i||null}var Ane={provide:Tg,useExisting:ec(()=>VN)},Gv=Promise.resolve(),VN=(()=>{class e extends Tg{callSetDisabledState;get submitted(){return lc(this.submittedReactive)}_submitted=qm(()=>this.submittedReactive());submittedReactive=ch(!1);_directives=new Set;form;ngSubmit=new Qr;options;constructor(i,r,n){super(),this.callSetDisabledState=n,this.form=new px({},NN(i),LN(r))}ngAfterViewInit(){this._setUpdateStrategy()}get formDirective(){return this}get control(){return this.form}get path(){return[]}get controls(){return this.form.controls}addControl(i){Gv.then(()=>{let r=this._findContainer(i.path);i.control=r.registerControl(i.name,i.control),PW(i.control,i,this.callSetDisabledState),i.control.updateValueAndValidity({emitEvent:!1}),this._directives.add(i)})}getControl(i){return this.form.get(i.path)}removeControl(i){Gv.then(()=>{let r=this._findContainer(i.path);r&&r.removeControl(i.name),this._directives.delete(i)})}addFormGroup(i){Gv.then(()=>{let r=this._findContainer(i.path),n=new px({});Dne(n,i),r.registerControl(i.name,n),n.updateValueAndValidity({emitEvent:!1})})}removeFormGroup(i){Gv.then(()=>{let r=this._findContainer(i.path);r&&r.removeControl(i.name)})}getFormGroup(i){return this.form.get(i.path)}updateModel(i,r){Gv.then(()=>{this.form.get(i.path).setValue(r)})}setValue(i){this.control.setValue(i)}onSubmit(i){return this.submittedReactive.set(!0),Sne(this.form,this._directives),this.ngSubmit.emit(i),this.form._events.next(new RN(this.control)),i?.target?.method==="dialog"}onReset(){this.resetForm()}resetForm(i=void 0){this.form.reset(i),this.submittedReactive.set(!1),this.form._events.next(new PN(this.form))}_setUpdateStrategy(){this.options&&this.options.updateOn!=null&&(this.form._updateOn=this.options.updateOn)}_findContainer(i){return i.pop(),i.length?this.form.get(i):this.form}static \u0275fac=function(r){return new(r||e)(It(ON,10),It(CW,10),It(FN,8))};static \u0275dir=gs({type:e,selectors:[["form",3,"ngNoForm","",3,"formGroup",""],["ng-form"],["","ngForm",""]],hostBindings:function(r,n){r&1&&_s("submit",function(o){return n.onSubmit(o)})("reset",function(){return n.onReset()})},inputs:{options:[0,"ngFormOptions","options"]},outputs:{ngSubmit:"ngSubmit"},exportAs:["ngForm"],standalone:!1,features:[Gm([Ane]),sl]})}return e})();function _W(e,t){let i=e.indexOf(t);i>-1&&e.splice(i,1)}function yW(e){return typeof e=="object"&&e!==null&&Object.keys(e).length===2&&"value"in e&&"disabled"in e}var Rne=class extends hx{defaultValue=null;_onChange=[];_pendingValue;_pendingChange=!1;constructor(t=null,i,r){super(AW(i),RW(r,i)),this._applyFormState(t),this._setUpdateStrategy(i),this._initObservables(),this.updateValueAndValidity({onlySelf:!0,emitEvent:!!this.asyncValidator}),fx(i)&&(i.nonNullable||i.initialValueIsDefault)&&(yW(t)?this.defaultValue=t.value:this.defaultValue=t)}setValue(t,i={}){this.value=this._pendingValue=t,this._onChange.length&&i.emitModelToViewChange!==!1&&this._onChange.forEach(r=>r(this.value,i.emitViewToModelChange!==!1)),this.updateValueAndValidity(i)}patchValue(t,i={}){this.setValue(t,i)}reset(t=this.defaultValue,i={}){this._applyFormState(t),this.markAsPristine(i),this.markAsUntouched(i),this.setValue(this.value,i),this._pendingChange=!1}_updateValue(){}_anyControls(t){return!1}_allControlsDisabled(){return this.disabled}registerOnChange(t){this._onChange.push(t)}_unregisterOnChange(t){_W(this._onChange,t)}registerOnDisabledChange(t){this._onDisabledChange.push(t)}_unregisterOnDisabledChange(t){_W(this._onDisabledChange,t)}_forEachChild(t){}_syncPendingControls(){return this.updateOn==="submit"&&(this._pendingDirty&&this.markAsDirty(),this._pendingTouched&&this.markAsTouched(),this._pendingChange)?(this.setValue(this._pendingValue,{onlySelf:!0,emitModelToViewChange:!1}),!0):!1}_applyFormState(t){yW(t)?(this.value=this._pendingValue=t.value,t.disabled?this.disable({onlySelf:!0,emitEvent:!1}):this.enable({onlySelf:!0,emitEvent:!1})):this.value=this._pendingValue=t}};var Pne={provide:$v,useExisting:ec(()=>HN)},vW=Promise.resolve(),HN=(()=>{class e extends $v{_changeDetectorRef;callSetDisabledState;control=new Rne;static ngAcceptInputType_isDisabled;_registered=!1;viewModel;name="";isDisabled;model;options;update=new Qr;constructor(i,r,n,s,o,a){super(),this._changeDetectorRef=o,this.callSetDisabledState=a,this._parent=i,this._setValidators(r),this._setAsyncValidators(n),this.valueAccessor=Ine(this,s)}ngOnChanges(i){if(this._checkForErrors(),!this._registered||"name"in i){if(this._registered&&(this._checkName(),this.formDirective)){let r=i.name.previousValue;this.formDirective.removeControl({name:r,path:this._getPath(r)})}this._setUpControl()}"isDisabled"in i&&this._updateDisabled(i),xne(i,this.viewModel)&&(this._updateValue(this.model),this.viewModel=this.model)}ngOnDestroy(){this.formDirective&&this.formDirective.removeControl(this)}get path(){return this._getPath(this.name)}get formDirective(){return this._parent?this._parent.formDirective:null}viewToModelUpdate(i){this.viewModel=i,this.update.emit(i)}_setUpControl(){this._setUpdateStrategy(),this._isStandalone()?this._setUpStandalone():this.formDirective.addControl(this),this._registered=!0}_setUpdateStrategy(){this.options&&this.options.updateOn!=null&&(this.control._updateOn=this.options.updateOn)}_isStandalone(){return!this._parent||!!(this.options&&this.options.standalone)}_setUpStandalone(){PW(this.control,this,this.callSetDisabledState),this.control.updateValueAndValidity({emitEvent:!1})}_checkForErrors(){this._checkName()}_checkName(){this.options&&this.options.name&&(this.name=this.options.name),!this._isStandalone()&&this.name}_updateValue(i){vW.then(()=>{this.control.setValue(i,{emitViewToModelChange:!1}),this._changeDetectorRef?.markForCheck()})}_updateDisabled(i){let r=i.isDisabled.currentValue,n=r!==0&&DA(r);vW.then(()=>{n&&!this.control.disabled?this.control.disable():!n&&this.control.disabled&&this.control.enable(),this._changeDetectorRef?.markForCheck()})}_getPath(i){return this._parent?wne(i,this._parent):[i]}static \u0275fac=function(r){return new(r||e)(It(Tg,9),It(ON,10),It(CW,10),It(bW,10),It(cc,8),It(FN,8))};static \u0275dir=gs({type:e,selectors:[["","ngModel","",3,"formControlName","",3,"formControl",""]],inputs:{name:"name",isDisabled:[0,"disabled","isDisabled"],model:[0,"ngModel","model"],options:[0,"ngModelOptions","options"]},outputs:{update:"ngModelChange"},exportAs:["ngModel"],standalone:!1,features:[Gm([Pne]),sl,sc]})}return e})();var LW=(()=>{class e{static \u0275fac=function(r){return new(r||e)};static \u0275dir=gs({type:e,selectors:[["form",3,"ngNoForm","",3,"ngNativeValidate",""]],hostAttrs:["novalidate",""],standalone:!1})}return e})();var One=(()=>{class e{_validator=hW;_onChange;_enabled;ngOnChanges(i){if(this.inputName in i){let r=this.normalizeInput(i[this.inputName].currentValue);this._enabled=this.enabled(r),this._validator=this._enabled?this.createValidator(r):hW,this._onChange&&this._onChange()}}validate(i){return this._validator(i)}registerOnValidatorChange(i){this._onChange=i}enabled(i){return i!=null}static \u0275fac=function(r){return new(r||e)};static \u0275dir=gs({type:e,features:[sc]})}return e})();var Nne={provide:ON,useExisting:ec(()=>BN),multi:!0};var BN=(()=>{class e extends One{required;inputName="required";normalizeInput=DA;createValidator=i=>cne;enabled(i){return i}static \u0275fac=(()=>{let i;return function(n){return(i||(i=uC(e)))(n||e)}})();static \u0275dir=gs({type:e,selectors:[["","required","","formControlName","",3,"type","checkbox"],["","required","","formControl","",3,"type","checkbox"],["","required","","ngModel","",3,"type","checkbox"]],hostVars:1,hostBindings:function(r,n){r&2&&vC("required",n._enabled?"":null)},inputs:{required:"required"},standalone:!1,features:[Gm([Nne]),sl]})}return e})();var Lne=(()=>{class e{static \u0275fac=function(r){return new(r||e)};static \u0275mod=Tu({type:e});static \u0275inj=tc({})}return e})();var FW=(()=>{class e{static withConfig(i){return{ngModule:e,providers:[{provide:FN,useValue:i.callSetDisabledState??kN}]}}static \u0275fac=function(r){return new(r||e)};static \u0275mod=Tu({type:e});static \u0275inj=tc({imports:[Lne]})}return e})();var gx=class e{constructor(t){this.satelliteService=t}newSatelliteAdded=new Qr;satellite={name:"",line1:"",line2:""};onSubmit(){this.satelliteService.addUserSatellite(this.satellite.name,this.satellite.line1,this.satellite.line2),this.newSatelliteAdded.emit(),this.satellite={name:"",line1:"",line2:""}}static \u0275fac=function(i){return new(i||e)(It(wg))};static \u0275cmp=Bs({type:e,selectors:[["app-add-sat-form"]],outputs:{newSatelliteAdded:"newSatelliteAdded"},decls:15,vars:3,consts:[[3,"ngSubmit"],["type","text","name","name","required","",3,"ngModelChange","ngModel"],["type","text","name","line1","required","",3,"ngModelChange","ngModel"],["type","text","name","line2","required","",3,"ngModelChange","ngModel"],["type","submit",2,"margin","0 auto"]],template:function(i,r){i&1&&(Ai(0,"form",0),_s("ngSubmit",function(){return r.onSubmit()}),Ai(1,"label"),jn(2," Name: "),Ai(3,"input",1),zm("ngModelChange",function(s){return z_(r.satellite.name,s)||(r.satellite.name=s),s}),pr()(),Lr(4,"br"),Ai(5,"label"),jn(6," Line 1: "),Ai(7,"input",2),zm("ngModelChange",function(s){return z_(r.satellite.line1,s)||(r.satellite.line1=s),s}),pr()(),Lr(8,"br"),Ai(9,"label"),jn(10," Line 2: "),Ai(11,"input",3),zm("ngModelChange",function(s){return z_(r.satellite.line2,s)||(r.satellite.line2=s),s}),pr()(),Lr(12,"br"),Ai(13,"button",4),jn(14,"Add Satellite"),pr()()),i&2&&(Nr(3),jm("ngModel",r.satellite.name),Nr(4),jm("ngModel",r.satellite.line1),Nr(4),jm("ngModel",r.satellite.line2))},dependencies:[$m,FW,LW,mx,SW,IW,BN,HN,VN],encapsulation:2})};function kne(e,t){if(e&1){let i=U_();Ai(0,"app-history",8),_s("highlight",function(n){Mm(i);let s=vh();return Sm(s.highlight(n))}),pr()}}function Vne(e,t){e&1&&Lr(0,"app-add-sat-form")}function Hne(e,t){if(e&1&&Lr(0,"app-map",6),e&2){let i=vh();yh("highlighted",i.highlightedPosition)}}function Bne(e,t){if(e&1&&Lr(0,"app-map-feature",6),e&2){let i=vh();yh("highlighted",i.highlightedPosition)}}function Une(e,t){e&1&&Lr(0,"app-map-3-d",7)}var _x=class e{constructor(t,i){this.http=t;this.positionService=i}title="iss-tracker";positions=new pa([]);highlightedPosition=null;activeMap="map1";ngOnInit(){this.loadISSPosition(),setInterval(()=>this.loadISSPosition(),1e4)}loadISSPosition(){this.http.get("http://api.open-notify.org/iss-now.json").subscribe(t=>{let i=new Date,r=parseFloat(t.iss_position.latitude),n=parseFloat(t.iss_position.longitude),s={latitude:r,longitude:n,time:i};this.positionService.updatePositions(s)})}switchMap(t){this.activeMap=t}highlight(t){this.highlightedPosition=t}static \u0275fac=function(i){return new(i||e)(It(OC),It(ol))};static \u0275cmp=Bs({type:e,selectors:[["app-root"]],decls:18,vars:11,consts:[[1,"container"],[1,"header"],[1,"nav-list"],[1,"nav-button",3,"click"],[1,"main-content"],[1,"right-panel"],[1,"map-component",3,"highlighted"],[1,"map-component"],[3,"highlight"]],template:function(i,r){i&1&&(Ai(0,"div",0)(1,"header",1)(2,"h1"),jn(3,"Satellite Tracker"),pr(),Ai(4,"nav",2)(5,"button",3),_s("click",function(){return r.switchMap("map1")}),jn(6,"Map"),pr(),Ai(7,"button",3),_s("click",function(){return r.switchMap("map2")}),jn(8,"Map-Feature"),pr(),Ai(9,"button",3),_s("click",function(){return r.switchMap("map3")}),jn(10,"Map-3D"),pr()()(),Ai(11,"main",4),gh(12,kne,1,0,"app-history"),gh(13,Vne,1,0,"app-add-sat-form"),Ai(14,"div",5),gh(15,Hne,1,1,"app-map",6),gh(16,Bne,1,1,"app-map-feature",6),gh(17,Une,1,0,"app-map-3-d",7),pr()()()),i&2&&(Nr(5),ya("active",r.activeMap==="map1"),Nr(2),ya("active",r.activeMap==="map2"),Nr(2),ya("active",r.activeMap==="map3"),Nr(3),_h(r.activeMap==="map1"||r.activeMap==="map2"?12:-1),Nr(),_h(r.activeMap==="map3"?13:-1),Nr(2),_h(r.activeMap==="map1"?15:-1),Nr(),_h(r.activeMap==="map2"?16:-1),Nr(),_h(r.activeMap==="map3"?17:-1))},dependencies:[LC,DT,xT,gx,ox],encapsulation:2})};NA(_x,Uj).catch(e=>console.error(e));
