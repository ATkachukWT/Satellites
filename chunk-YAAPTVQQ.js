import{d as q}from"./chunk-WFQUCDHF.js";import{b as T}from"./chunk-MKPAHACK.js";import{a as A}from"./chunk-G7RYJIRW.js";import{b as I}from"./chunk-6YRWGF73.js";import{a as H,f as P}from"./chunk-LXFQWIWE.js";import{n as N}from"./chunk-KGVXGH6H.js";import{H as d,J as B}from"./chunk-QHVIRF5H.js";import{I as E}from"./chunk-WZDN6K3C.js";import{a as m}from"./chunk-QGVBCWUY.js";import{G as W,O as z,v as y,y as b}from"./chunk-CKJ56T2Q.js";var j=Math.PI/180;function k(e){return e*j}function O(e,i){let a=k(i.rotation),t=Math.abs(Math.cos(a)),s=Math.abs(Math.sin(a)),[o,n]=i.size;return e[0]=Math.round(n*s+o*t),e[1]=Math.round(n*t+o*s),e}function C(e,i,a,t){let[s,o]=i,[n,r]=t,l=.5*a;return e[0]=s-l*n,e[1]=o-l*r,e[2]=s+l*n,e[3]=o+l*r,e}var u=H(),c=[0,0],_=new A(0,0,0,0),M={container:null,fetchSource:null,requestUpdate:null,imageMaxWidth:2048,imageMaxHeight:2048,imageRotationSupported:!1,imageNormalizationSupported:!1,hidpi:!1},p=class extends B{constructor(e){super(e),this._imagePromise=null,this.bitmaps=[],this.hidpi=M.hidpi,this.imageMaxWidth=M.imageMaxWidth,this.imageMaxHeight=M.imageMaxHeight,this.imageRotationSupported=M.imageRotationSupported,this.imageNormalizationSupported=M.imageNormalizationSupported,this.update=z(async(i,a)=>{if(y(a),!i.stationary||this.destroyed)return;let t=i.state,s=N(t.spatialReference),o=this.hidpi?i.pixelRatio:1,n=t.worldScreenWidth>0,r=n&&this.imageNormalizationSupported&&t.worldScreenWidth<t.size[0],l=Math.round((this.imageMaxWidth??0)/o),f=Math.round((this.imageMaxHeight??0)/o);r?(c[0]=t.worldScreenWidth,c[1]=t.size[1]):this.imageRotationSupported?(c[0]=t.size[0],c[1]=t.size[1]):O(c,t);let S=Math.floor(c[0])>l||Math.floor(c[1])>f,w=s&&(t.extent.xmin<s.valid[0]||t.extent.xmax>s.valid[1]),v=!this.imageNormalizationSupported&&w,x=!S&&!v,U=this.imageRotationSupported?t.rotation:0,V=this.container.children.slice();if(x){let h=r?t.paddedViewState.center:t.center;this._imagePromise=this._singleExport(t,c,h,t.resolution,U,o,a)}else{let h=Math.min(l,f);n&&(h=Math.min(t.worldScreenWidth,h),h=Math.round(t.worldScreenWidth/Math.ceil(t.worldScreenWidth/h))),this._imagePromise=this._tiledExport(t,h,o,a)}try{let h=await this._imagePromise??[];y(a);let R=[];if(this._imagePromise=null,this.destroyed)return;this.bitmaps=h;for(let g of V)h.includes(g)||R.push(g.fadeOut().then(()=>{g.remove(),g.destroy()}));for(let g of h)R.push(g.fadeIn());await Promise.all(R)}catch(h){this._imagePromise=null,b(h)}},5e3),this.updateExports=z(async i=>{let a=[];for(let t of this.container.children){if(!t.visible||!t.stage)return;a.push(i(t).then(()=>{t.invalidateTexture(),t.requestRender()}))}this._imagePromise=W(a).then(()=>this._imagePromise=null),await this._imagePromise})}destroy(){this.bitmaps.forEach(e=>e.destroy()),this.bitmaps=[]}get updating(){return!this.destroyed&&this._imagePromise!==null}async _export(e,i,a,t,s,o){let n=await this.fetchSource(e,Math.floor(i*s),Math.floor(a*s),{rotation:t,pixelRatio:s,signal:o});y(o);let r=new q(null,!0);return r.x=e.xmin,r.y=e.ymax,r.resolution=e.width/i,r.rotation=t,r.pixelRatio=s,r.opacity=0,this.container.addChild(r),await r.setSourceAsync(n,o),y(o),r}async _singleExport(e,i,a,t,s,o,n){C(u,a,t,i);let r=P(u,e.spatialReference);return[await this._export(r,i[0],i[1],s,o,n)]}_tiledExport(e,i,a,t){let s=I.create({size:i,spatialReference:e.spatialReference,scales:[e.scale]}),o=new T(s),n=o.getTileCoverage(e);if(!n)return null;let r=[];return n.forEach((l,f,S,w)=>{_.set(l,f,S,0),o.getTileBounds(u,_);let v=P(u,e.spatialReference);r.push(this._export(v,i,i,0,a,t).then(x=>(w!==0&&(_.set(l,f,S,w),o.getTileBounds(u,_),x.x=u[0],x.y=u[3]),x)))}),Promise.all(r)}};m([d()],p.prototype,"_imagePromise",void 0),m([d()],p.prototype,"bitmaps",void 0),m([d()],p.prototype,"container",void 0),m([d()],p.prototype,"fetchSource",void 0),m([d()],p.prototype,"hidpi",void 0),m([d()],p.prototype,"imageMaxWidth",void 0),m([d()],p.prototype,"imageMaxHeight",void 0),m([d()],p.prototype,"imageRotationSupported",void 0),m([d()],p.prototype,"imageNormalizationSupported",void 0),m([d()],p.prototype,"requestUpdate",void 0),m([d()],p.prototype,"updating",null),p=m([E("esri.views.2d.layers.support.ExportStrategy")],p);var at=p;export{at as a};
