import{a as fe,b as ve}from"./chunk-TUJMSP4X.js";import{a as ue,b as xe,c as C,d as f}from"./chunk-4YX5NE4F.js";import"./chunk-FJNBIBDX.js";import{a as ge}from"./chunk-5ZS2L6U3.js";import"./chunk-OC2XJJQU.js";import{f as G}from"./chunk-PCKPAUFQ.js";import{a as P}from"./chunk-N5YUEDXE.js";import{c as L,g as O}from"./chunk-ZJQOPRYL.js";import"./chunk-WSHRDZWE.js";import{a as le,f as de,n as x,p as me,s as _}from"./chunk-T4QAGZWF.js";import{c as y,e as E,g as m,l as pe}from"./chunk-7BXTHPPE.js";import{a as j,b as he,e as ce}from"./chunk-Q5KIWWVU.js";import"./chunk-KK722UJA.js";import"./chunk-C27Q2S3P.js";import"./chunk-O2PACODW.js";import"./chunk-5XQ3V6FG.js";import"./chunk-JAPGPEA6.js";import"./chunk-VU5W7W6Y.js";import"./chunk-ZFRNSCYG.js";import"./chunk-UWWX7VSW.js";import"./chunk-CFF33S4D.js";import{d as H,f as b}from"./chunk-JKP7KG6H.js";import{w as g}from"./chunk-2XYAAYOE.js";import{b as M,c as ae}from"./chunk-4X7VNDTG.js";import"./chunk-LXEWGICX.js";import"./chunk-NIYDRLW4.js";import"./chunk-CAXK5KYB.js";import"./chunk-3CCK7BDD.js";import"./chunk-LNYBTIG7.js";import"./chunk-AOQ57NDM.js";import"./chunk-VMECOA4F.js";import"./chunk-JPMGMA4B.js";import"./chunk-KAMRW6HF.js";import"./chunk-6DGDLLNL.js";import"./chunk-DJW5LMRG.js";import"./chunk-ALWV3RJ2.js";import"./chunk-DEH76MSI.js";import"./chunk-VTGWQ7AP.js";import"./chunk-TBA3OZMJ.js";import"./chunk-S4QV2MGO.js";import"./chunk-USMAJP2P.js";import"./chunk-PHNFWHVF.js";import"./chunk-4N5OXIEM.js";import"./chunk-W26XKMAT.js";import"./chunk-NQWYPF77.js";import"./chunk-JTDXB5TK.js";import"./chunk-CWUY5SXW.js";import"./chunk-TPFJWNIU.js";import"./chunk-P25RU3X5.js";import"./chunk-XRRQM4E2.js";import"./chunk-GWBRHLNH.js";import{a as w}from"./chunk-EM35R6FY.js";import{d as J,h as ee,i as D,j as K,l as te,o as re,q as ie}from"./chunk-QXXXCEV5.js";import{c as se,e as oe,o as ne}from"./chunk-6B5XFA6F.js";import"./chunk-NHEQ4TAR.js";import"./chunk-AFC2H4Q3.js";import"./chunk-OLOKUDVI.js";import"./chunk-ZTOZWLEE.js";import"./chunk-RJWOVI3M.js";import"./chunk-NRBJLISB.js";import"./chunk-PTZYZULI.js";import"./chunk-NMLYCCKN.js";import"./chunk-RSDQHAJX.js";import{a as T}from"./chunk-BOVYXYHK.js";import"./chunk-FENRIY2T.js";import"./chunk-JGEVVXD4.js";import"./chunk-B3FO6PT7.js";import"./chunk-C4UMJHQC.js";import"./chunk-BCREO4Q5.js";import"./chunk-LXFQWIWE.js";import"./chunk-QT6UNBJP.js";import"./chunk-MWSXMSWY.js";import"./chunk-JRCKELO6.js";import"./chunk-KJULKTB5.js";import"./chunk-LACL4BQ2.js";import{c as Z}from"./chunk-YR2HD3ZC.js";import"./chunk-GJASVPF6.js";import"./chunk-UBFCO3DV.js";import"./chunk-NI7FJV5X.js";import"./chunk-BUSG3ZOF.js";import"./chunk-XZIOXVVJ.js";import"./chunk-LFH24RLM.js";import"./chunk-Z5Q7KLA4.js";import"./chunk-X4LNX4BR.js";import"./chunk-4XZ6X7MQ.js";import"./chunk-WLHY3MMA.js";import{ha as $}from"./chunk-KGVXGH6H.js";import"./chunk-ARRCN5K3.js";import"./chunk-FTDD7QBB.js";import"./chunk-DB3UIQCU.js";import"./chunk-SBHKMV3P.js";import"./chunk-R4A63S45.js";import"./chunk-ETE32IYO.js";import"./chunk-ONUGDWDK.js";import"./chunk-SG7CQU4O.js";import{H as I,J as Y}from"./chunk-QHVIRF5H.js";import{I as X}from"./chunk-WZDN6K3C.js";import{a as R}from"./chunk-QGVBCWUY.js";import"./chunk-OJQ73TPF.js";import"./chunk-354SCPDU.js";import"./chunk-OVHPPCBL.js";import"./chunk-IYZFKXJ6.js";import"./chunk-CKJ56T2Q.js";import"./chunk-SNFOAZZQ.js";import"./chunk-F6JAWRPN.js";import"./chunk-UHRSAPGQ.js";import"./chunk-V76GWARL.js";import"./chunk-N2WTMF3X.js";var v=class{constructor(r,e){this.view=r,this.options=e,this.squaredShortLineThreshold=P.shortLineThreshold*P.shortLineThreshold}snap(r,e){return e.vertexHandle!=null?e.vertexHandle.type!=="vertex"?[]:this.snapExistingVertex(r,e):this.snapNewVertex(r,e)}edgeExceedsShortLineThreshold(r,e){return this.exceedsShortLineThreshold(m(r.leftVertex.pos,this.view,e),m(r.rightVertex.pos,this.view,e),e)}exceedsShortLineThreshold(r,e,{spatialReference:t}){return this.squaredShortLineThreshold===0||x(f(e,t,g,this.view),f(r,t,g,this.view))>this.squaredShortLineThreshold}isVertical(r,e,{spatialReference:t}){let i=$(t);return D(r,e)*i<P.verticalLineThresholdMeters}squaredProximityThreshold(r){return r==="touch"?this._squaredTouchProximityThreshold:this._squaredMouseProximityThreshold}get _squaredMouseProximityThreshold(){return this.options.distance*this.options.distance}get _squaredTouchProximityThreshold(){let{distance:r,touchSensitivityMultiplier:e}=this.options,t=r*e;return t*t}};var N=class extends v{snapNewVertex(r,e){let t=e.editGeometryOperations.data.components[0],i=t.edges.length,s=[];if(i<1)return s;let{spatialReference:o}=e,a=f(r,o,g,this.view),{view:n}=this,p=t.edges[i-1],h=p;do{if(this.edgeExceedsShortLineThreshold(h,e)){let d=_(h,n,e);this._processCandidateProposal(d.left,d.right,r,a,e,s)}h=h.leftVertex.leftEdge}while(h&&h!==p);return s}snapExistingVertex(r,e){let t=[],i=e.vertexHandle,s=i.component;if(s.edges.length<2)return t;let{view:o}=this,{spatialReference:a}=e,n=f(r,a,g,o),p=i.leftEdge,h=i.rightEdge;p&&h&&this.edgeExceedsShortLineThreshold(p,e)&&this.edgeExceedsShortLineThreshold(h,e)&&this._processCandidateProposal(m(p.leftVertex.pos,o,e),m(h.rightVertex.pos,o,e),r,n,e,t);let d=s.edges[0],l=d;do{if(l!==i.leftEdge&&l!==i.rightEdge&&this.edgeExceedsShortLineThreshold(l,e)){let u=_(l,o,e);this._processCandidateProposal(u.left,u.right,r,n,e,t)}l=l.rightVertex.rightEdge}while(l&&l!==d);return t}_processCandidateProposal(r,e,t,i,s,o){let{spatialReference:a,pointer:n}=s,p=T();Ve(p,r,e,t,s);let h=E(p);x(i,f(h,a,g,this.view))<this.squaredProximityThreshold(n)&&o.push(new ge({lineStart:r,lineEnd:e,targetPoint:h,isDraped:s.elevationInfo?.mode==="on-the-ground"}))}};function Ve(c,r,e,t,i){Te(c,r,e,t,i)||we(c,t,r,e)}function Te(c,r,e,t,{spatialReference:i}){let s=L(r,e,i,i);if(s==null)return!1;let o=L(e,t,i,i);if(o==null)return!1;let a=G(e,t,i);if(a==null)return!1;let n=Math.abs(ae.shortestSignedDiff(s,o))>Math.PI/2?M.normalize(s+Math.PI):s;return O(c,e,i,b(a,"meters"),H(n,"radians","geographic"),"geodesic"),c[2]=t[2],!0}function we(c,r,e,t){le(r,{start:e,end:t,type:ce.LINE},c),c[2]=r[2]}var z=class extends v{snapNewVertex(r,e){let t=e.editGeometryOperations.data.components[0],i=t.edges.length,s=t.vertices.length,o=[];if(i<2)return o;let{view:a}=this,n=f(r,e.spatialReference,g,a),p=m(t.vertices[s-1].pos,a,e),h=m(t.vertices[0].pos,a,e),d=t.edges[i-1],l=d;do{if(this.edgeExceedsShortLineThreshold(l,e)){let u=_(l,a,e);this._checkEdgeForParallelLines(u,p,r,n,e,o),this._checkEdgeForParallelLines(u,h,r,n,e,o)}l=l.leftVertex.leftEdge}while(l&&l!==d);return o}snapExistingVertex(r,e){let t=[],i=e.vertexHandle,s=i.component;if(s.edges.length<3)return t;let{view:o}=this,a=f(r,e.spatialReference,g,o),n=i.leftEdge,p=i.rightEdge,h=s.vertices[0],d=m(h.pos,o,e),l=s.vertices.length,u=s.vertices[l-1],A=m(u.pos,o,e),k=s.edges[0],S=k;do{if(S!==n&&S!==p&&this.edgeExceedsShortLineThreshold(S,e)){let q=_(S,o,e);n&&this._checkEdgeForParallelLines(q,m(n.leftVertex.pos,o,e),r,a,e,t),p&&this._checkEdgeForParallelLines(q,m(p.rightVertex.pos,o,e),r,a,e,t),i===h?this._checkEdgeForParallelLines(q,A,r,a,e,t):i===u&&this._checkEdgeForParallelLines(q,d,r,a,e,t)}S=S.rightVertex.rightEdge}while(S&&S!==k);return t}_checkEdgeForParallelLines(r,e,t,i,s,o){let a=r.left,n=r.right;if(j(V,e,a,n),K(V,e)<P.parallelLineThreshold)return;j(V,t,a,n,e);let{spatialReference:p,pointer:h}=s,d=E(y(V[0],V[1],t[2]));if(x(i,f(d,p,g,this.view))<this.squaredProximityThreshold(h)){if(this.isVertical(d,e,s)||this.isVertical(a,n,s)||ye(r,o))return;o.push(new fe({referenceLine:r,lineStart:e,targetPoint:d,isDraped:s.elevationInfo?.mode==="on-the-ground"}))}}};function ye(c,r){let e=c.left,t=c.right;for(let i of r)if(j(V,t,i.constraint.start,i.constraint.end,e),K(V,t)<P.parallelLineThreshold)return i.addReferenceLine(c),!0;return!1}var V=w();var U=class extends v{snapNewVertex(r,e){let t=e.editGeometryOperations.data.components[0],i=[];if(t.vertices.length<2)return i;let{view:s}=this,o=f(r,e.spatialReference,g,s),a=t.vertices.at(-1);this._checkForSnappingCandidate(C.LastVertex,i,a.leftEdge,a,a.leftEdge.leftVertex,r,o,e);let n=t.vertices[0];return this._checkForSnappingCandidate(C.FirstVertex,i,n.rightEdge,n,n.rightEdge.rightVertex,r,o,e),i}snapExistingVertex(r,e){let t=[],i=e.vertexHandle;if(i.component.vertices.length<3)return t;let{view:s}=this,o=f(r,e.spatialReference,g,s),a=i.leftEdge,n=i.rightEdge;if(a?.leftVertex.leftEdge){let p=a.leftVertex.leftEdge;this._checkForSnappingCandidate(C.ExistingEdge,t,p,p.rightVertex,p.leftVertex,r,o,e)}if(n?.rightVertex.rightEdge){let p=n.rightVertex.rightEdge;this._checkForSnappingCandidate(C.ExistingEdge,t,p,p.leftVertex,p.rightVertex,r,o,e)}return t}_checkForSnappingCandidate(r,e,t,i,s,o,a,n){if(!this.edgeExceedsShortLineThreshold(t,n))return;let p=this.view,h=m(i.pos,p,n),d=m(s.pos,p,n);Le(Se,d,h,o,n),this._checkForSnappingCandidateAlongProjectedRay(r,e,d,h,Se,o,a,n)}_checkForSnappingCandidateAlongProjectedRay(r,e,t,i,s,o,a,n){let{spatialReference:p,pointer:h}=n,d=J(W,o,i),l=re(s,d)/te(s),u=ee(W,i,s,l),A=E(y(u[0],u[1],o[2]));if(x(a,f(A,p,g,this.view))>this.squaredProximityThreshold(h)||this.isVertical(A,i,n)||this.isVertical(i,t,n))return;let k=ne(T(),i,s,Math.sign(l));e.push(new ue({targetPoint:A,constraint:new de(i,k),previousVertex:t,otherVertex:i,otherVertexType:xe.CENTER,selfSnappingType:r,isDraped:n.elevationInfo?.mode==="on-the-ground"}))}};function Le(c,r,e,t,i){_e(c,r,e,t,i)||Ae(c,r,e)}function _e(c,r,e,t,{spatialReference:i}){let s=L(r,e,i,i);if(s==null)return!1;let o=L(e,t,i,i);if(o==null)return!1;let a=Math.sign(M.shortestSignedDiff(s,o))*Math.PI*.5,n=H(s+a,"radians","geographic"),p=T(),h=G(e,t,i);return h!=null&&(O(p,e,i,b(h,"meters"),n,"geodesic"),oe(c,p,e),!0)}function Ae(c,r,e){let t=J(W,e,r);se(c,t[1],-t[0],0)}var W=w(),Se=T();var B=class extends v{snapNewVertex(r,e){let t=e.editGeometryOperations.data.components[0],i=[],s=t.vertices.length;if(e.editGeometryOperations.data.type!=="polygon"||s<2)return i;let{view:o}=this,a=t.vertices[0],n=t.vertices[s-1],p=m(a.pos,o,e),h=m(n.pos,o,e);return this._processCandidateProposal(p,h,r,e,i),i}snapExistingVertex(r,e){let t=[],i=e.vertexHandle,s=i.component;if(s.edges.length<2||e.editGeometryOperations.data.type==="polyline"&&(i.index===0||i.index===s.vertices.length-1))return t;let{view:o}=this,a=m(i.leftEdge.leftVertex.pos,o,e),n=m(i.rightEdge.rightVertex.pos,o,e);return this._processCandidateProposal(a,n,r,e,t),t}_processCandidateProposal(r,e,t,i,s){if(!this.exceedsShortLineThreshold(r,e,i))return;let o=ie(Ee,r,e,.5),a=.5*D(r,e),n=he(Ee,t,o,a),p=E(y(n[0],n[1],t[2])),{spatialReference:h,pointer:d}=i,l=f(t,h,g,this.view);if(x(l,f(p,h,g,this.view))<this.squaredProximityThreshold(d)){if(this.isVertical(r,p,i)||this.isVertical(p,e,i))return;s.push(new ve({targetPoint:p,point1:r,point2:e,isDraped:i.elevationInfo?.mode==="on-the-ground"}))}}},Ee=w();var F=class extends Y{constructor(c){super(c),this.updating=!1,this._snappers=new Z,this._domain=pe.SELF}initialize(){this._snappers.push(new z(this.view,this.options),new N(this.view,this.options),new U(this.view,this.options),new B(this.view,this.options))}set options(c){this._set("options",c);for(let r of this._snappers)r.options=c}async fetchCandidates(c,r,e){if(!(r&this._domain&&this.options.effectiveSelfEnabled))return[];let t=[];for(let i of this._snappers.items)for(let s of i.snap(c,e))t.push(s);return me(c,t),t}};R([I({readOnly:!0})],F.prototype,"updating",void 0),R([I({constructOnly:!0})],F.prototype,"view",void 0),R([I()],F.prototype,"options",null),F=R([X("esri.views.interactive.snapping.SelfSnappingEngine")],F);export{F as SelfSnappingEngine};
