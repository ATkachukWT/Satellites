import{b as re,c as ae,d as oe}from"./chunk-KAFWB3JH.js";import{c as se}from"./chunk-KO6SRXH5.js";import{a as ie}from"./chunk-CQUBHG54.js";import{a as K}from"./chunk-CDP4MSRO.js";import{m as ee,n as te,o as ne}from"./chunk-2NP7F5RO.js";import{a as Y}from"./chunk-7QY3BMVN.js";import{a as X}from"./chunk-CWUY5SXW.js";import{c as V}from"./chunk-LACL4BQ2.js";import{g as J}from"./chunk-Z5Q7KLA4.js";import{a as v}from"./chunk-4XZ6X7MQ.js";import{C as H}from"./chunk-KGVXGH6H.js";import{E as S}from"./chunk-ETE32IYO.js";import{S as U,h as Z,t as O}from"./chunk-ONUGDWDK.js";import{r as B,t as j}from"./chunk-UHRSAPGQ.js";import{a as F,b as x}from"./chunk-N2WTMF3X.js";var R=()=>B.getLogger("esri.layers.ogc.ogcFeatureUtils"),le="startindex",ye=new Set([le,"offset"]),ce="http://www.opengis.net/def/crs/",Le=`${ce}OGC/1.3/CRS84`,l;async function Me(e,n,t={},i=5){let{links:r}=e,s=m(r,"items",l.geojson)||m(r,"http://www.opengis.net/def/rel/ogc/1.0/items",l.geojson);if(s==null)throw new j("ogc-feature-layer:missing-items-page","Missing items url");let{apiKey:d,customParameters:p,signal:g}=t,u=O(s.href,e.landingPage.url),I=x(F({limit:i},p),{token:d}),P=U(u,I),W={accept:l.geojson},{data:N}=await S(P,{signal:g,headers:W}),q=Te(P,i,N.links)??le;re(N);let f=ae(N,{geometryType:n.geometryType}),h=n.fields||f.fields||[],A=n.hasZ!=null?n.hasZ:f.hasZ,y=f.geometryType,w=n.objectIdField||f.objectIdFieldName||"OBJECTID",o=n.timeInfo,C=h.find(({name:a})=>a===w);if(C)C.editable=!1,C.nullable=!1;else{if(!f.objectIdFieldType)throw new j("ogc-feature-layer:missing-feature-id","Collection geojson require a feature id as a unique identifier");h.unshift({name:w,alias:w,type:f.objectIdFieldType==="number"?"esriFieldTypeOID":"esriFieldTypeString",editable:!1,nullable:!1})}if(w!==f.objectIdFieldName){let a=h.find(({name:c})=>c===f.objectIdFieldName);a&&(a.type="esriFieldTypeInteger")}h===f.fields&&f.unknownFields.length>0&&R().warn({name:"ogc-feature-layer:unknown-field-types",message:"Some fields types couldn't be inferred from the features and were dropped",details:{unknownFields:f.unknownFields}});for(let a of h){if(a.name==null&&(a.name=a.alias),a.alias==null&&(a.alias=a.name),a.type!=="esriFieldTypeOID"&&a.type!=="esriFieldTypeGlobalID"&&(a.editable=a.editable==null||!!a.editable,a.nullable=a.nullable==null||!!a.nullable),!a.name)throw new j("ogc-feature-layer:invalid-field-name","field name is missing",{field:a});if(!X.jsonValues.includes(a.type))throw new j("ogc-feature-layer:invalid-field-type",`invalid type for field "${a.name}"`,{field:a})}if(o){let a=new K(h);if(o.startTimeField){let c=a.get(o.startTimeField);c?(o.startTimeField=c.name,c.type="esriFieldTypeDate"):o.startTimeField=null}if(o.endTimeField){let c=a.get(o.endTimeField);c?(o.endTimeField=c.name,c.type="esriFieldTypeDate"):o.endTimeField=null}if(o.trackIdField){let c=a.get(o.trackIdField);c?o.trackIdField=c.name:(o.trackIdField=null,R().warn({name:"ogc-feature-layer:invalid-timeInfo-trackIdField",message:"trackIdField is missing",details:{timeInfo:o}}))}o.timeReference||={timeZoneIANA:V},o.startTimeField||o.endTimeField||(R().warn({name:"ogc-feature-layer:invalid-timeInfo",message:"startTimeField and endTimeField are missing",details:{timeInfo:o}}),o=void 0)}return{drawingInfo:y?ie(y):null,extent:Ie(e),geometryType:y,fields:h,hasZ:!!A,objectIdField:w,paginationParameter:q,timeInfo:o}}async function Ze(e,n={}){let{links:t,url:i}=e,r=m(t,"data",l.json)||m(t,"http://www.opengis.net/def/rel/ogc/1.0/data",l.json);if(r==null)throw new j("ogc-feature-layer:missing-collections-page","Missing collections url");let{apiKey:s,customParameters:d,signal:p}=n,g=O(r.href,i),{data:u}=await S(g,{signal:p,headers:{accept:l.json},query:x(F({},d),{token:s})});for(let I of u.collections)I.landingPage=e;return u}async function Je(e,n={}){let{links:t,url:i}=e,r=m(t,"conformance",l.json)||m(t,"http://www.opengis.net/def/rel/ogc/1.0/conformance",l.json);if(r==null)throw new j("ogc-feature-layer:missing-conformance-page","Missing conformance url");let{apiKey:s,customParameters:d,signal:p}=n,g=O(r.href,i),{data:u}=await S(g,{signal:p,headers:{accept:l.json},query:x(F({},d),{token:s})});return u}async function Ke(e,n={}){let{apiKey:t,customParameters:i,signal:r}=n,{data:s}=await S(e,{signal:r,headers:{accept:l.json},query:x(F({},i),{token:t})});return s.url=e,s}async function ze(e,n={}){let{links:t,url:i}=e,r=m(t,"service-desc",l.openapi);if(r==null)return R().warn("ogc-feature-layer:missing-openapi-page","The OGC API-Features server does not have an OpenAPI page."),null;let{apiKey:s,customParameters:d,signal:p}=n,g=O(r.href,i),{data:u}=await S(g,{signal:p,headers:{accept:l.openapi},query:x(F({},d),{token:s})});return u}function Ee(e){let n=/^http:\/\/www\.opengis.net\/def\/crs\/(?<authority>.*)\/(?<version>.*)\/(?<code>.*)$/i.exec(e),t=n?.groups;if(!t)return null;let{authority:i,code:r}=t;switch(i.toLowerCase()){case"ogc":switch(r.toLowerCase()){case"crs27":return v.GCS_NAD_1927.wkid;case"crs83":return 4269;case"crs84":case"crs84h":return v.WGS84.wkid;default:return null}case"esri":case"epsg":{let s=Number.parseInt(r,10);return Number.isNaN(s)?null:s}default:return null}}async function Qe(e,n,t){let i=await we(e,n,t);return ne(i)}async function we(e,n,t){let{collection:{links:i,landingPage:{url:r}},layerDefinition:s,maxRecordCount:d,queryParameters:{apiKey:p,customParameters:g},spatialReference:u,supportedCrs:I}=e,P=m(i,"items",l.geojson)||m(i,"http://www.opengis.net/def/rel/ogc/1.0/items",l.geojson);if(P==null)throw new j("ogc-feature-layer:missing-items-page","Missing items url");let{geometry:W,num:N,start:q,timeExtent:f,where:h}=n;if(n.objectIds)throw new j("ogc-feature-layer:query-by-objectids-not-supported","Queries with object ids are not supported");let A=v.fromJSON(u),y=n.outSpatialReference??A,w=y.isWGS84?null:ue(y,I),o=je(W,I),C=he(f),a=Fe(h),c=N??(q==null?d:10),de=q===0?void 0:q,{fields:E,geometryType:$,hasZ:L,objectIdField:G,paginationParameter:fe}=s,me=O(P.href,r),{data:Q}=await S(me,x(F({},t),{query:x(F(F({},g),o),{crs:w,datetime:C,query:a,limit:c,[fe]:de,token:p}),headers:{accept:l.geojson}})),D=oe(Q,{geometryType:$,hasZ:L,objectIdField:G}),pe=D.length===c&&!!m(Q.links??[],"next",l.geojson),_=new K(E);for(let b of D){let k={};se(_,k,b.attributes,!0);for(let M of _.fields)M.nullable&&!(M.name in k)&&(k[M.name]=null);k[G]=b.attributes[G],b.attributes=k}if(!w&&y.isWebMercator){for(let b of D)if(b.geometry!=null&&$!=null){let k=te(b.geometry,$,L,!1);k.spatialReference=v.WGS84,b.geometry=ee(J(k,y))}}for(let b of D)b.objectId=b.attributes[G];let ge=w||!w&&y.isWebMercator?y.toJSON():H,T=new Y;return T.exceededTransferLimit=pe,T.features=D,T.fields=E,T.geometryType=$,T.hasZ=L,T.objectIdFieldName=G,T.spatialReference=ge,T}function be(e){return e!=null&&e.type==="extent"}function ue(e,n){let{isWebMercator:t,wkid:i}=e;if(!i)return null;let r=t?n[3857]??n[102100]??n[102113]??n[900913]:n[e.wkid];return r?`${ce}${r}`:null}function z(e){if(e==null)return"";let{xmin:n,ymin:t,xmax:i,ymax:r}=e;return`${n},${t},${i},${r}`}function he(e){if(e==null)return null;let{start:n,end:t}=e;return`${n!=null?n.toISOString():".."}/${t!=null?t.toISOString():".."}`}function Fe(e){return e!=null&&e&&e!=="1=1"?e:null}function je(e,n){if(!be(e))return null;let{spatialReference:t}=e;if(!t||t.isWGS84)return{bbox:z(e)};let i=ue(t,n);return i!=null?{bbox:z(e),"bbox-crs":i}:t.isWebMercator?{bbox:z(J(e,v.WGS84))}:null}function Ie(e){let n=e.extent?.spatial;if(!n)return null;let t=n.bbox[0],i=t.length===4,[r,s]=t,d=i?void 0:t[2];return{xmin:r,ymin:s,xmax:i?t[2]:t[3],ymax:i?t[3]:t[4],zmin:d,zmax:i?void 0:t[5],spatialReference:v.WGS84.toJSON()}}function m(e,n,t){return e.find(({rel:i,type:r})=>i===n&&r===t)??e.find(({rel:i,type:r})=>i===n&&!r)}function Te(e,n,t){if(!t)return;let i=m(t,"next",l.geojson),r=Z(i?.href)?.query;if(!r)return;let s=Z(e).query,d=Object.keys(s??{});return Object.entries(r).filter(([u])=>!d.includes(u)).find(([u,I])=>ye.has(u.toLowerCase())&&Number.parseInt(I,10)===n)?.[0]}(function(e){e.json="application/json",e.geojson="application/geo+json",e.openapi="application/vnd.oai.openapi+json;version=3.0"})(l||(l={}));export{ce as a,Le as b,Me as c,Ze as d,Je as e,Ke as f,ze as g,Ee as h,Qe as i,we as j};
