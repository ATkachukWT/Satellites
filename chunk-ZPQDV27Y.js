import{c as L}from"./chunk-SLAWDKDA.js";import{a as A}from"./chunk-GJASVPF6.js";import{E as H}from"./chunk-ETE32IYO.js";import{H as S}from"./chunk-QHVIRF5H.js";import{I as U}from"./chunk-WZDN6K3C.js";import{a as g}from"./chunk-QGVBCWUY.js";import{P as j}from"./chunk-CKJ56T2Q.js";import{b as u}from"./chunk-UHRSAPGQ.js";var T=L(),y=new Map,_=new Map;async function q(e,n,o){if(!e||!o)return!1;if(!n)return!0;let i=new URL(e).host,s=y.get(i);if(!s){let t=e.replace(/\/FeatureServer/i,"/VersionManagementServer").replace(/\/\d*$/,"");s=(await H(t,{responseType:"json",query:{f:"json"}})).data.defaultVersionName}return s===n}async function G(e,n,o=!1){if(!e||!n)return!0;let i=e.replace(/\/FeatureServer/i,"/VersionManagementServer").replace(/\/\d*$/,""),s=_.get(i)?.entries();if(s){for(let[t,a]of s)if(a.name===n){let d=!a.stack?.hasForwardEdits();if(!d&&o){let[{deleteForwardEdits:m},{default:h}]=await Promise.all([import("./chunk-OVNCBWCD.js"),import("./chunk-O7S3E44X.js")]),c=await m(i,t,new h({sessionId:T,moment:a.moment}));return c.success&&a.stack?.clearForwardEdits(),c.success}return d}}return!0}function k(e,n){if(!e)return!1;let o=e.replace(/\/FeatureServer/i,"/VersionManagementServer").replace(/\/\d*$/,""),i=_.get(o)?.entries();if(i){for(let[s,t]of i)if(t.name===n)return t.lockType==="edit"}return!1}var M=new A.EventEmitter;function C(e){return M.on("apply-edits",new WeakRef(e))}function N(e){return M.on("update-moment",new WeakRef(e))}function te(e,n,o=null,i=!1){let s=j();return i=n==null||i,M.emit("apply-edits",{serviceUrl:e,layerId:n,gdbVersion:o,mayReceiveServiceEdits:i,result:s.promise}),s}var R=Symbol();function se(e){return e!=null&&typeof e=="object"&&R in e}function p(e){return e!=null&&typeof e=="object"&&"gdbVersion"in e}function I(e,n,o){let i=new URL(e).host,s=y.get(i),t=a=>!a||a===s;return t(n)&&t(o)||n===o}var ie=e=>{var n;let o=class extends e{constructor(...i){super(...i),this[n]=!0,this._applyEditsHandler=s=>{let{serviceUrl:t,layerId:a,gdbVersion:d,mayReceiveServiceEdits:m,result:h}=s,c=t===this.url,f=a!=null&&this.layerId!=null&&a===this.layerId,x=p(this),B=p(this)&&I(t,d,this.gdbVersion);if(!c||x&&!B||!f&&!m)return;let D=h.then(r=>{if(this.lastEditsEventDate=new Date,f&&(r.addedFeatures.length||r.updatedFeatures.length||r.deletedFeatures.length||r.addedAttachments.length||r.updatedAttachments.length||r.deletedAttachments.length))return this.emit("edits",u(r)),r;let v=r.editedFeatures?.find(({layerId:b})=>b===this.layerId);if(v){let{adds:b,updates:E,deletes:V}=v.editedFeatures,w={edits:null,addedAttachments:[],deletedAttachments:[],updatedAttachments:[],addedFeatures:b?b.map(({attributes:l})=>({objectId:this.objectIdField&&l[this.objectIdField],globalId:this.globalIdField&&l[this.globalIdField]})):[],deletedFeatures:V?V.map(({attributes:l})=>({objectId:this.objectIdField&&l[this.objectIdField],globalId:this.globalIdField&&l[this.globalIdField]})):[],updatedFeatures:E?E.map(({current:{attributes:l}})=>({objectId:this.objectIdField&&l[this.objectIdField],globalId:this.globalIdField&&l[this.globalIdField]})):[],editedFeatures:u(r.editedFeatures),exceededTransferLimit:!1,historicMoment:u(r.historicMoment)};return this.emit("edits",w),w}let F={edits:null,addedAttachments:[],deletedAttachments:[],updatedAttachments:[],addedFeatures:[],deletedFeatures:[],updatedFeatures:[],editedFeatures:u(r.editedFeatures),exceededTransferLimit:!1,historicMoment:u(r.historicMoment)};return"historicMoment"in this&&this._shouldUpdateHistoricMoment(t,d,F.historicMoment)&&this.emit("edits",F),F}).then(r=>("historicMoment"in this&&this._shouldUpdateHistoricMoment(t,d,r.historicMoment)&&(this.historicMoment=r.historicMoment),r));this.emit("apply-edits",{result:D})},this._updateMomentHandler=s=>{let{serviceUrl:t,gdbVersion:a,moment:d}=s,m=t===this.url,h=p(this),c=p(this)&&I(t,a,this.gdbVersion),f=p(this)&&!I(t,this.gdbVersion,null);m&&h&&c&&f&&"historicMoment"in this&&this.historicMoment!==d&&(this.historicMoment=d)},this.when().then(()=>{this.addHandles(C(this._applyEditsHandler)),"historicMoment"in this&&this.addHandles(N(this._updateMomentHandler))},()=>{})}_shouldUpdateHistoricMoment(i,s,t){return"historicMoment"in this&&this.historicMoment!==t&&k(i,s)}};return n=R,g([S()],o.prototype,"lastEditsEventDate",void 0),o=g([U("esri.layers.mixins.EditBusLayer")],o),o};export{T as a,q as b,G as c,k as d,te as e,se as f,ie as g};
