import{b as K,c as X,d as ee}from"./chunk-KAFWB3JH.js";import{a as _,b as T,c as w,d as S,e as te,f as se}from"./chunk-KO6SRXH5.js";import"./chunk-WOGTXK7W.js";import{a as H,b as U,c as Y}from"./chunk-CQUBHG54.js";import{a as W}from"./chunk-NVYT4DEO.js";import{a as $}from"./chunk-L25QECEE.js";import"./chunk-E4ND5WCV.js";import"./chunk-JX3MPN3R.js";import{c as V}from"./chunk-IE6LCR36.js";import"./chunk-SCNTWYD2.js";import"./chunk-K3Z3MI77.js";import"./chunk-35XAFVAL.js";import{a as I,b}from"./chunk-C3PAYYXB.js";import"./chunk-3CWCNPAI.js";import"./chunk-UCYOLKZK.js";import"./chunk-WTZT4FKW.js";import"./chunk-6FDNNAVT.js";import"./chunk-FYZRIMPP.js";import"./chunk-VYI3HIPB.js";import"./chunk-WI3QVC6K.js";import"./chunk-6KRFVLII.js";import"./chunk-G27DRLGO.js";import"./chunk-KRAKR4MK.js";import"./chunk-MCO7DSFO.js";import"./chunk-D7WE3OBT.js";import{a as x}from"./chunk-CDP4MSRO.js";import"./chunk-BCSLWH5H.js";import"./chunk-TOH4K6HW.js";import"./chunk-UP6FLASM.js";import"./chunk-DGBDFGKO.js";import"./chunk-44S2QQS2.js";import"./chunk-DQOFEB5P.js";import"./chunk-JTDXB5TK.js";import{j as B,k as N,l as z,m as J,n as L}from"./chunk-2NP7F5RO.js";import"./chunk-7QY3BMVN.js";import"./chunk-XEZTJAR4.js";import"./chunk-BUP3AMMF.js";import"./chunk-XCIPBOI4.js";import{a as M}from"./chunk-CWUY5SXW.js";import"./chunk-KD27XIJC.js";import"./chunk-TPFJWNIU.js";import"./chunk-P25RU3X5.js";import"./chunk-XRRQM4E2.js";import"./chunk-GWBRHLNH.js";import"./chunk-M67YQAIX.js";import"./chunk-NHEQ4TAR.js";import"./chunk-BIRSPTTF.js";import"./chunk-IZLELRQR.js";import"./chunk-7EMOONQX.js";import"./chunk-RZF6KTKU.js";import{x as ie,y as re}from"./chunk-HP4LYRR4.js";import"./chunk-AFC2H4Q3.js";import"./chunk-OLOKUDVI.js";import"./chunk-4G7UTTZJ.js";import"./chunk-ZTOZWLEE.js";import"./chunk-RJWOVI3M.js";import"./chunk-SP2CO3KX.js";import"./chunk-NRBJLISB.js";import"./chunk-PTZYZULI.js";import"./chunk-NMLYCCKN.js";import"./chunk-RSDQHAJX.js";import"./chunk-BOVYXYHK.js";import{g as j}from"./chunk-FENRIY2T.js";import"./chunk-5HJY3X5Y.js";import"./chunk-6RZAM42M.js";import"./chunk-WDETDPZG.js";import"./chunk-HX2VGIR2.js";import"./chunk-64QN2VGD.js";import"./chunk-JGEVVXD4.js";import"./chunk-B3FO6PT7.js";import"./chunk-C4UMJHQC.js";import"./chunk-BCREO4Q5.js";import"./chunk-LXFQWIWE.js";import"./chunk-QT6UNBJP.js";import"./chunk-MWSXMSWY.js";import{f as G}from"./chunk-JRCKELO6.js";import"./chunk-ZVCMULXF.js";import"./chunk-KJULKTB5.js";import{c as v}from"./chunk-LACL4BQ2.js";import"./chunk-YR2HD3ZC.js";import"./chunk-GJASVPF6.js";import"./chunk-UBFCO3DV.js";import"./chunk-BUSG3ZOF.js";import"./chunk-XZIOXVVJ.js";import"./chunk-LFH24RLM.js";import"./chunk-Z5Q7KLA4.js";import"./chunk-X4LNX4BR.js";import"./chunk-4XZ6X7MQ.js";import"./chunk-WLHY3MMA.js";import{C as g,m as Z}from"./chunk-KGVXGH6H.js";import"./chunk-ARRCN5K3.js";import"./chunk-FTDD7QBB.js";import"./chunk-DB3UIQCU.js";import"./chunk-SBHKMV3P.js";import"./chunk-R4A63S45.js";import{E as P}from"./chunk-ETE32IYO.js";import"./chunk-ONUGDWDK.js";import"./chunk-SG7CQU4O.js";import"./chunk-QHVIRF5H.js";import"./chunk-WZDN6K3C.js";import"./chunk-QGVBCWUY.js";import"./chunk-OJQ73TPF.js";import"./chunk-354SCPDU.js";import"./chunk-OVHPPCBL.js";import"./chunk-IYZFKXJ6.js";import{D as Q}from"./chunk-CKJ56T2Q.js";import"./chunk-SNFOAZZQ.js";import"./chunk-F6JAWRPN.js";import{r as A,t as f}from"./chunk-UHRSAPGQ.js";import"./chunk-V76GWARL.js";import{a as q,b as C}from"./chunk-N2WTMF3X.js";var ue={hasAttachments:!1,capabilities:"query, editing, create, delete, update",useStandardizedQueries:!0,supportsCoordinatesQuantization:!0,supportsReturningQueryGeometry:!0,advancedQueryCapabilities:{supportsQueryAttachments:!1,supportsQueryAttachmentOrderByFields:!1,supportsQueryBins:!0,supportsQueryWithCacheHint:!0,supportsQueryWithDistance:!0,supportsQueryWithResultType:!0,supportsStatistics:!0,supportsPercentileStatistics:!0,supportsReturningGeometryCentroid:!0,supportsDistinct:!0,supportsReturningQueryExtent:!0,supportsReturningGeometryProperties:!1,supportsHavingClause:!0,supportsOrderBy:!0,supportsPagination:!0,supportsSqlExpression:!0,supportsDisjointSpatialRel:!0},queryBinsCapabilities:se},ne=class{constructor(){this._queryEngine=null,this._snapshotFeatures=async e=>{let t=await this._fetch(e);return this._createFeatures(t)}}destroy(){this._queryEngine?.destroy(),this._queryEngine=this._createDefaultAttributes=null}async load(e,t={}){this._loadOptions={url:e.url,customParameters:e.customParameters};let i=[],[s]=await Promise.all([e.url?this._fetch(t?.signal):null,this._checkProjection(e.spatialReference)]),r=X(s,{geometryType:e.geometryType}),u=e.fields||r.fields||[],d=e.hasZ!=null?e.hasZ:r.hasZ,p=r.geometryType,y=e.objectIdField||r.objectIdFieldName||"__OBJECTID",h=e.spatialReference||g,a=e.timeInfo;u===r.fields&&r.unknownFields.length>0&&i.push({name:"geojson-layer:unknown-field-types",message:"Some fields types couldn't be inferred from the features and were dropped",details:{unknownFields:r.unknownFields}});let o=new x(u),l=o.get(y);l?(l.type!=="esriFieldTypeString"&&(l.type="esriFieldTypeOID"),l.editable=!1,l.nullable=!1,y=l.name):(l={alias:y,name:y,type:r.objectIdFieldType==="string"?"esriFieldTypeString":"esriFieldTypeOID",editable:!1,nullable:!1},u.unshift(l));let m={};for(let n of u){if(n.name==null&&(n.name=n.alias),n.alias==null&&(n.alias=n.name),!n.name)throw new f("geojson-layer:invalid-field-name","field name is missing",{field:n});if(!M.jsonValues.includes(n.type))throw new f("geojson-layer:invalid-field-type",`invalid type for field "${n.name}"`,{field:n});if(n.name!==l.name){let E=ie(n);E!==void 0&&(m[n.name]=E)}n.length==null&&(n.length=re(n))}if(a){if(a.startTimeField){let n=o.get(a.startTimeField);n?(a.startTimeField=n.name,n.type="esriFieldTypeDate"):a.startTimeField=null}if(a.endTimeField){let n=o.get(a.endTimeField);n?(a.endTimeField=n.name,n.type="esriFieldTypeDate"):a.endTimeField=null}if(a.trackIdField){let n=o.get(a.trackIdField);n?a.trackIdField=n.name:(a.trackIdField=null,i.push({name:"geojson-layer:invalid-timeInfo-trackIdField",message:"trackIdField is missing",details:{timeInfo:a}}))}a.startTimeField||a.endTimeField||(i.push({name:"geojson-layer:invalid-timeInfo",message:"startTimeField and endTimeField are missing",details:{timeInfo:a}}),a=null)}let c=p?H(p):void 0,R=o.dateFields.length?{timeZoneIANA:v}:null,F={warnings:i,featureErrors:[],layerDefinition:C(q({},ue),{drawingInfo:c??void 0,templates:Y(m),extent:void 0,geometryType:p,objectIdField:y,fields:u,hasZ:!!d,timeInfo:a,dateFieldsTimeReference:R})};this._queryEngine=new V({fieldsIndex:x.fromLayerJSON({fields:u,timeInfo:a,dateFieldsTimeReference:R}),geometryType:p,hasM:!1,hasZ:d,objectIdField:y,spatialReference:h,timeInfo:a,featureStore:new $({geometryType:p,hasM:!1,hasZ:d})});let D=this._queryEngine.fieldsIndex.requiredFields.indexOf(l);D>-1&&this._queryEngine.fieldsIndex.requiredFields.splice(D,1),this._createDefaultAttributes=U(m,y);let O=await this._createFeatures(s);this._objectIdGenerator=this._createObjectIdGenerator(this._queryEngine,O);let ae=this._normalizeFeatures(O,F.featureErrors);this._queryEngine.featureStore.addMany(ae);let{fullExtent:oe,timeExtent:k}=await this._queryEngine.fetchRecomputedExtents();if(F.layerDefinition.extent=oe,k){let{start:n,end:E}=k;F.layerDefinition.timeInfo.timeExtent=[n,E]}return F}async applyEdits(e){let{spatialReference:t,geometryType:i}=this._queryEngine;return await Promise.all([te(t,i),I(e.adds,t),I(e.updates,t)]),await this._waitSnapshotComplete(),this._applyEdits(e)}async queryFeatures(e={},t={}){return await this._waitSnapshotComplete(),this._queryEngine.executeQuery(e,t.signal)}async queryFeatureCount(e={},t={}){return await this._waitSnapshotComplete(),this._queryEngine.executeQueryForCount(e,t.signal)}async queryObjectIds(e={},t={}){return await this._waitSnapshotComplete(),this._queryEngine.executeQueryForIds(e,t.signal)}async queryExtent(e={},t={}){return await this._waitSnapshotComplete(),this._queryEngine.executeQueryForExtent(e,t.signal)}async querySnapping(e,t={}){return await this._waitSnapshotComplete(),W(this._queryEngine,e,t.signal)}async queryAttributeBins(e,t={}){return await this._waitSnapshotComplete(),this._queryEngine.executeAttributeBinsQuery(e,t.signal)}async refresh(e){this._loadOptions.customParameters=e,this._snapshotTask?.abort(),this._snapshotTask=G(this._snapshotFeatures),this._snapshotTask.promise.then(s=>{this._queryEngine.featureStore.clear(),this._objectIdGenerator=this._createObjectIdGenerator(this._queryEngine,s);let r=this._normalizeFeatures(s);r&&this._queryEngine.featureStore.addMany(r)},s=>{this._queryEngine.featureStore.clear(),Q(s)||A.getLogger("esri.layers.GeoJSONLayer").error(new f("geojson-layer:refresh","An error occurred during refresh",{error:s}))}),await this._waitSnapshotComplete();let{fullExtent:t,timeExtent:i}=await this._queryEngine.fetchRecomputedExtents();return{extent:t,timeExtent:i}}async _createFeatures(e){if(e==null)return[];let{geometryType:t,hasZ:i,objectIdField:s}=this._queryEngine,r=ee(e,{geometryType:t,hasZ:i,objectIdField:s});if(!Z(this._queryEngine.spatialReference,g))for(let u of r)u.geometry!=null&&(u.geometry=J(b(L(u.geometry,this._queryEngine.geometryType,this._queryEngine.hasZ,!1),g,this._queryEngine.spatialReference)));return r}async _waitSnapshotComplete(){if(this._snapshotTask&&!this._snapshotTask.finished){try{await this._snapshotTask.promise}catch{}return this._waitSnapshotComplete()}}async _fetch(e){let{url:t,customParameters:i}=this._loadOptions,s=(await P(t??"",{responseType:"json",query:q({},i),signal:e})).data;return K(s),s}_normalizeFeatures(e,t){let{objectIdField:i,fieldsIndex:s}=this._queryEngine,r=[];for(let u of e){let d=this._createDefaultAttributes(),p=w(s,d,u.attributes,!0);p?t?.push(p):(this._assignObjectId(d,u.attributes,!0),u.attributes=d,u.objectId=d[i],r.push(u))}return r}async _applyEdits(e){let{adds:t,updates:i,deletes:s}=e,r={addResults:[],deleteResults:[],updateResults:[],uidToObjectId:{}};if(t?.length&&this._applyAddEdits(r,t),i?.length&&this._applyUpdateEdits(r,i),s?.length){for(let p of s)r.deleteResults.push(T(p));this._queryEngine.featureStore.removeManyById(s)}let{fullExtent:u,timeExtent:d}=await this._queryEngine.fetchRecomputedExtents();return{extent:u,timeExtent:d,featureEditResults:r}}_applyAddEdits(e,t){let{addResults:i}=e,{geometryType:s,hasM:r,hasZ:u,objectIdField:d,spatialReference:p,featureStore:y,fieldsIndex:h}=this._queryEngine,a=[];for(let o of t){if(o.geometry&&s!==j(o.geometry)){i.push(_("Incorrect geometry type."));continue}let l=this._createDefaultAttributes(),m=w(h,l,o.attributes);if(m)i.push(m);else{if(this._assignObjectId(l,o.attributes),o.attributes=l,o.uid!=null){let c=o.attributes[d];e.uidToObjectId[o.uid]=c}if(o.geometry!=null){let c=o.geometry.spatialReference??p;o.geometry=b(S(o.geometry,c),c,p)}a.push(o),i.push(T(o.attributes[d]))}}y.addMany(N([],a,s,u,r,d))}_applyUpdateEdits({updateResults:e},t){let{geometryType:i,hasM:s,hasZ:r,objectIdField:u,spatialReference:d,featureStore:p,fieldsIndex:y}=this._queryEngine;for(let h of t){let{attributes:a,geometry:o}=h,l=a?.[u];if(l==null){e.push(_(`Identifier field ${u} missing`));continue}if(!p.has(l)){e.push(_(`Feature with object id ${l} missing`));continue}let m=z(p.getFeature(l),i,r,s);if(o!=null){if(i!==j(o)){e.push(_("Incorrect geometry type."));continue}let c=o.spatialReference??d;m.geometry=b(S(o,c),c,d)}if(a){let c=w(y,m.attributes,a);if(c){e.push(c);continue}}p.add(B(m,i,r,s,u)),e.push(T(l))}}_createObjectIdGenerator(e,t){let i=e.fieldsIndex.get(e.objectIdField);if(i.type==="esriFieldTypeString")return()=>i.name+"-"+Date.now().toString(16);let s=Number.NEGATIVE_INFINITY;for(let r of t)r.objectId&&(s=Math.max(s,r.objectId));return s=Math.max(0,s)+1,()=>s++}_assignObjectId(e,t,i=!1){let s=this._queryEngine.objectIdField;e[s]=i&&s in t?t[s]:this._objectIdGenerator()}async _checkProjection(e){try{await I(g,e)}catch{throw new f("geojson-layer","Projection not supported")}}};export{ne as default};
