import{a as pe}from"./chunk-6FRWECPU.js";import{a as ge}from"./chunk-2U44WK2Y.js";import{a as ue}from"./chunk-RDYCHQ7J.js";import{a as me}from"./chunk-EIMGIIJ4.js";import{a as le}from"./chunk-JUMM5VTE.js";import{a as O,c as ce}from"./chunk-JNJTT3PL.js";import{a as he}from"./chunk-2DH3L3DZ.js";import{a as de}from"./chunk-5DVGZXEZ.js";import{a as R}from"./chunk-N3W77OHB.js";import{h as ne}from"./chunk-VUJT53YX.js";import{c as oe}from"./chunk-SWCOPTUX.js";import{b as se}from"./chunk-AEU2INWT.js";import{a as ae}from"./chunk-MJO3PLZV.js";import{d as ie}from"./chunk-BPX3YT3K.js";import{b as G}from"./chunk-YQNUGDFH.js";import{a as te}from"./chunk-KD27XIJC.js";import{a as re}from"./chunk-G7TP3ZYQ.js";import{a as M}from"./chunk-RWCIDBNQ.js";import{l as H}from"./chunk-HM5RIVQC.js";import{D as ee,a as I,c as S,k as w,l as x,v as X,y as $}from"./chunk-LXFQWIWE.js";import{d as Q}from"./chunk-MWSXMSWY.js";import{a as J,c as K}from"./chunk-JRCKELO6.js";import{m as L}from"./chunk-LFH24RLM.js";import{H as y}from"./chunk-QHVIRF5H.js";import{I as Z}from"./chunk-WZDN6K3C.js";import{a as p}from"./chunk-QGVBCWUY.js";import{A as B,D as A,O as Y,e as C,j,u as W,v as b,x as k}from"./chunk-CKJ56T2Q.js";import{r as v}from"./chunk-UHRSAPGQ.js";import{a as U,b as q}from"./chunk-N2WTMF3X.js";function fe(t,e,r){let a=w(t)/x(t),i={width:r,height:r};return a>1.0001?i.height=r/a:a<.9999&&(i.width=r*a),i.width=Math.round(i.width/(w(t)/w(e))),i.height=Math.round(i.height/(x(t)/x(e))),i}function N(t,e){return ne(t,[[e[0],e[1],-1],[e[2],e[1],-1],[e[2],e[3],-1],[e[0],e[3],-1]])}function ye(t,e,r){if(!X(e,r))return N(t,r);let a=[e[1]-r[1],Math.min(e[3],r[3])-Math.max(e[1],r[1]),r[3]-e[3],123456],i=[e[0]-r[0],Math.min(e[2],r[2])-Math.max(e[0],r[0]),r[2]-e[2],123456],n=r[2]-r[0],l=r[3]-r[1],s=i[0]>0&&i[2]>0?3:2,m=a[0]>0&&a[2]>0?3:2,o=(m+1)*(s+1),d=te(3*o),c=re(2*o),h=new Array(6*(m*s-1)),D=0,T=0,V=0,g=0,f=0;for(let _=0;_<4;_++){let z=a[_];if(z<=0)continue;let P=0;for(let E=0;E<4;E++){let F=i[E];F<=0||(d[T++]=r[0]+P,d[T++]=r[1]+D,d[T++]=-1,c[V++]=P/n,c[V++]=D/l,E<3&&_<3&&(E!==1||_!==1)&&(h[f++]=g,h[f++]=g+1,h[f++]=g+s+1,h[f++]=g+1,h[f++]=g+s+2,h[f++]=g+s+1),g++,P+=F)}D+=z}let we=new Array(h.length);return new oe(t,[[M.POSITION,new G(d,h,3,!0)],[M.NORMAL,new G(xe,we,3,!0)],[M.UV0,new G(c,h,2,!0)]])}var xe=[0,0,1];var u=class extends me(ge(le)){constructor(){super(...arguments),this.drapeSourceType=he.RasterImage,this.updatePolicy=de.SYNC,this.fullExtentInLocalViewSpatialReference=null,this.maximumDataResolution=null,this._images=new Array,this._extents=new Array,this._overlays=new Array,this.updateWhenStationary=!0,this._drapeSourceRenderer=null,this.refreshDebounced=Y(async t=>{this.destroyed||await this._doRefresh(t).catch(e=>{A(e)||v.getLogger(this).error(e)})},2e3)}get visibleAtCurrentScale(){let t=this.layer,e="effectiveScaleRange"in t?t.effectiveScaleRange:null;return ie(e,this.view.scale)}initialize(){this._drapeSourceRenderer=this.view.basemapTerrain.overlayManager.registerGeometryDrapeSource(this),this.addHandles(j(()=>this.view.basemapTerrain.overlayManager.unregisterDrapeSource(this))),this.addResolvingPromise(pe(this).then(t=>this._set("fullExtentInLocalViewSpatialReference",t))),this._updatingHandles.add(()=>this.suspended,()=>this._suspendedChangeHandler())}destroy(){this.clear()}setDrapingExtent(t,e){this._spatialReference=e,t.forEach((r,a)=>{this._overlays[a]=r,this._updateImageExtent(r,a)})}_updateImageExtent(t,e){let r=this._clippedExtent(t.extent,_e);if(r==null)return;let a=fe(t.extent,r,t.resolution),i=t.pixelRatio*this.view.state.pixelRatio,{layer:n}=this;if("imageMaxWidth"in n&&n.imageMaxWidth!=null||"imageMaxHeight"in n&&n.imageMaxHeight!=null){let s=n.imageMaxWidth,m=n.imageMaxHeight;if(a.width>s){let o=s/a.width;a.height=Math.floor(a.height*o),a.width=s,i*=o}if(a.height>m){let o=m/a.height;a.width=Math.floor(a.width*o),a.height=m,i*=o}}let l=this._extents[e];l&&ee(l.extent,r)&&this._imageSizeEquals(r,l.imageSize,a)||(this._extents[e]={extent:I(r),imageSize:a,pixelRatio:i},this.suspended||this._fetch(e).catch(s=>{A(s)||v.getLogger(this).error(s)}))}clear(){for(let t=0;t<this._images.length;t++)this._clearImage(t)}async doRefresh(){return this._doRefresh()}async _doRefresh(t){if(this.suspended)return;let e=[];for(let r=0;r<this._extents.length;r++)this._extents[r]&&e.push(this._fetch(r,t));await Promise.allSettled(e)}async processResult(t,e,r){(e instanceof HTMLImageElement||e instanceof HTMLCanvasElement)&&(t.image=e)}findExtentInfoAt(t){for(let e of this._extents){let r=e.extent;if(new L(r[0],r[1],r[2],r[3],this._spatialReference).contains(t))return e}return null}getFetchOptions(){}async redraw(t,e){await J(this._images,async(r,a)=>{r&&(await t(r,e),await this._createStageObjects(a,r.image,e))})}_imageSizeEquals(t,e,r){if(!this.maximumDataResolution)return!1;let a=w(t)/this.maximumDataResolution.x,i=x(t)/this.maximumDataResolution.y,n=a/e.width,l=i/e.height,s=a/r.width,m=i/r.height,o=Math.abs(n-s),d=Math.abs(l-m),c=ae.TESTS_DISABLE_OPTIMIZATIONS?0:1.5;return o<=c&&d<=c}async _fetch(t,e){if(this.suspended)return;let r=this._extents[t],a=r.extent;this._images[t]||(this._images[t]={texture:null,material:null,renderGeometry:null,loadingPromise:null,loadingAbortController:null,image:null,pixelData:null,renderExtent:I(a)});let i=this._images[t];i.loadingAbortController=C(i.loadingAbortController);let n=new L(a[0],a[1],a[2],a[3],this._spatialReference);if(n.width===0||n.height===0)return void this._clearImage(t);let l=new AbortController;i.loadingAbortController=l,B(e,()=>l.abort());let s=l.signal,m=this._waitFetchReady(s).then(async()=>{let o=q(U({requestAsImageElement:!0,pixelRatio:this._overlays[t].pixelRatio},this.getFetchOptions()),{signal:s}),{height:d,width:c}=r.imageSize;return this.layer.fetchImage(n,c,d,o)}).then(o=>{if(k(s))throw v.getLogger(this).warnOnce("A call to fetchImage resolved even though the request was aborted. fetchImage should not resolve if options.signal.aborted is true."),W();return this.processResult(i,o)}).then(()=>{S(i.renderExtent,a)});i.loadingPromise=m,await this._updatingHandles.addPromise(m.then(async()=>{b(s),await this._createStageObjects(t,i.image,s)}).catch(o=>{throw o&&!A(o)&&v.getLogger(this).error(o),o}).finally(()=>{m===i.loadingPromise&&(i.loadingPromise=null,i.loadingAbortController=null)}))}_clearImage(t){let e=this._images[t];if(e){e.renderGeometry!=null&&(this._drapeSourceRenderer.removeGeometries([e.renderGeometry],O.UPDATE),e.renderGeometry=null);let r=this.view._stage,a=e.texture;a?.unload(),r.remove(a),e.texture=null,r.remove(e.material),e.material=null,e.loadingAbortController=C(e.loadingAbortController),e.loadingPromise=null,e.image=null,e.pixelData=null}}async _createStageObjects(t,e,r){let a=this.view._stage,i=this._images[t],n=()=>{i.texture?.unload(),a.remove(i.texture),i.texture=null,i.renderGeometry&&(this._drapeSourceRenderer.removeGeometries([i.renderGeometry],O.UPDATE),i.renderGeometry=null)};if(e){let l=new se(e,{width:e.width,height:e.height,preMultiplyAlpha:!0,wrap:{s:H.CLAMP_TO_EDGE,t:H.CLAMP_TO_EDGE}}),s;if(await K(this._images[t===R.INNER?R.OUTER:R.INNER].loadingPromise),b(r),n(),await a.schedule(()=>l.load(a.renderView.renderingContext),r),a.add(l),i.texture=l,i.material==null?(i.material=new ue({textureId:l.id}),a.add(i.material)):i.material.setParameters({textureId:l.id}),t===R.INNER)s=N(i.material,i.renderExtent);else{let m=this._images[0].renderExtent;if(!m)return void n();s=ye(i.material,m,i.renderExtent)}i.renderGeometry=new ce(s),i.renderGeometry.localOrigin=this._overlays[t].renderLocalOrigin,this._drapeSourceRenderer.addGeometries([i.renderGeometry],O.UPDATE)}else n(),a.remove(i.material),i.material=null}_clippedExtent(t,e){if(this.view.viewingMode!=="local")return S(e,t);let r=this.view.basemapTerrain;return r.ready?$(t,r.extent,e):S(e,t)}_suspendedChangeHandler(){this.suspended?this.clear():this.refreshDebounced()}async _waitFetchReady(t){await Q(()=>this.view.stationary,t),b(t)}};p([y()],u.prototype,"layer",void 0),p([y()],u.prototype,"suspended",void 0),p([y({readOnly:!0})],u.prototype,"fullExtentInLocalViewSpatialReference",void 0),p([y({readOnly:!0})],u.prototype,"visibleAtCurrentScale",null),p([y()],u.prototype,"updating",void 0),u=p([Z("esri.views.3d.layers.DynamicLayerView3D")],u);var it=u,_e=I();export{it as a};
