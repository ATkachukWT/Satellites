import{a as he}from"./chunk-D5CVC3OW.js";import{a as le}from"./chunk-THVHJHIO.js";import{b as me}from"./chunk-JVPRAOU2.js";import{a as pe}from"./chunk-JUMM5VTE.js";import{a as ae}from"./chunk-BV2QH5J4.js";import"./chunk-W2RZ3RCQ.js";import"./chunk-3HISBPJS.js";import"./chunk-75GZ6ETV.js";import"./chunk-VTI633OW.js";import"./chunk-AGNIXKQH.js";import"./chunk-W3HXXDUN.js";import"./chunk-P5DBP5G4.js";import"./chunk-QC6ZIWCS.js";import"./chunk-Q4D6RBGT.js";import"./chunk-5IYUVR2B.js";import"./chunk-ASWKMS6K.js";import{c as oe}from"./chunk-IAG3AFVL.js";import{a as A}from"./chunk-YYQRGXAE.js";import{b as se}from"./chunk-5BRKCXYS.js";import"./chunk-I37YY4RM.js";import"./chunk-D3NZGZ4V.js";import"./chunk-6NVIER6D.js";import"./chunk-KZUZOO74.js";import"./chunk-MCUWKKTW.js";import"./chunk-E4MEDSYW.js";import"./chunk-WH5SLVE3.js";import"./chunk-CUJ2T6EE.js";import"./chunk-E2PEM77A.js";import"./chunk-OTLOUAP3.js";import"./chunk-JXEAVWUK.js";import"./chunk-R3ABULTC.js";import"./chunk-DB752BXH.js";import"./chunk-EQWEJ5AJ.js";import"./chunk-T3DGHEVR.js";import"./chunk-ZOOQQO74.js";import"./chunk-5Q65R7QF.js";import"./chunk-2ZZZKQ4W.js";import"./chunk-SCNTWYD2.js";import"./chunk-C3PAYYXB.js";import"./chunk-FYZRIMPP.js";import"./chunk-47CBJZNC.js";import"./chunk-NGQW42AK.js";import"./chunk-HMRMWMHT.js";import"./chunk-QW4SS6UN.js";import"./chunk-UWWX7VSW.js";import"./chunk-CFF33S4D.js";import"./chunk-M6OVPXT3.js";import"./chunk-UPU3OYP4.js";import"./chunk-FLXA3YE2.js";import"./chunk-BFOAQMH4.js";import{a as ne}from"./chunk-OWY34DUP.js";import"./chunk-4TIUXNXO.js";import"./chunk-CEAEFIX3.js";import"./chunk-ULWS5HLW.js";import"./chunk-QKO2YKBC.js";import"./chunk-MF655E4C.js";import"./chunk-CCTFA5SZ.js";import"./chunk-HUWVQAJL.js";import"./chunk-4X7VNDTG.js";import"./chunk-KE2U7ENE.js";import"./chunk-PSFZFYFC.js";import"./chunk-NRRX2M6N.js";import{b as re,e as M}from"./chunk-PMLKCTEJ.js";import"./chunk-MYO2G5ZH.js";import"./chunk-A45BLB26.js";import"./chunk-BPX3YT3K.js";import"./chunk-47NSYSFY.js";import"./chunk-QXNVQZT7.js";import"./chunk-BYXBJQAS.js";import"./chunk-AKKUUEQK.js";import"./chunk-JLWYDAJB.js";import{a as te,b as ie}from"./chunk-ZH7647AP.js";import"./chunk-MKPAHACK.js";import"./chunk-3QCWBHPT.js";import"./chunk-2T2QPZOS.js";import"./chunk-4YCQZSNI.js";import"./chunk-4D3QHJI2.js";import"./chunk-E2J2V7JN.js";import"./chunk-G7RYJIRW.js";import"./chunk-37H4LYIE.js";import"./chunk-VYZHOYXV.js";import"./chunk-K7YQAHQ7.js";import"./chunk-PGUFA2AC.js";import"./chunk-X7BNFUFQ.js";import"./chunk-XAHD7XBV.js";import"./chunk-U7PX7SHO.js";import"./chunk-HUKD3ORH.js";import"./chunk-3A3BGKXB.js";import"./chunk-SXNHGK6A.js";import"./chunk-TMZQBNSB.js";import"./chunk-PFSX77NO.js";import"./chunk-W45QYQK6.js";import"./chunk-I5V562B6.js";import"./chunk-ONYJLWAD.js";import"./chunk-HBZAOVHW.js";import"./chunk-LCMPSAU3.js";import"./chunk-CRJDOM7J.js";import"./chunk-BCFGKQ2N.js";import"./chunk-YQGS4EZO.js";import"./chunk-3REMXE4W.js";import"./chunk-4ABKPPKG.js";import"./chunk-PMVQ5DJK.js";import"./chunk-I4Q2S2XA.js";import"./chunk-V774RJYN.js";import"./chunk-L2WNUKLP.js";import"./chunk-XITT4JU2.js";import"./chunk-ZBX6HJOS.js";import"./chunk-BSMAMABT.js";import"./chunk-LYNAYPL3.js";import"./chunk-ULANM5YP.js";import"./chunk-77L5NP7A.js";import"./chunk-2G3SBK6Q.js";import"./chunk-VOB6IBIW.js";import{h as T}from"./chunk-63B3IOWG.js";import"./chunk-KAMRW6HF.js";import"./chunk-DJW5LMRG.js";import{a as ee}from"./chunk-DEH76MSI.js";import"./chunk-DVBZA6ZU.js";import"./chunk-TBA3OZMJ.js";import"./chunk-S4QV2MGO.js";import"./chunk-USMAJP2P.js";import"./chunk-PHNFWHVF.js";import"./chunk-4N5OXIEM.js";import"./chunk-DTU6MHUX.js";import"./chunk-NFXNGFHZ.js";import"./chunk-3CDCI3XM.js";import"./chunk-W26XKMAT.js";import"./chunk-NQWYPF77.js";import"./chunk-6KRFVLII.js";import{d as X}from"./chunk-KRAKR4MK.js";import"./chunk-MCO7DSFO.js";import"./chunk-D7WE3OBT.js";import"./chunk-CDP4MSRO.js";import"./chunk-TOH4K6HW.js";import"./chunk-UP6FLASM.js";import"./chunk-DGBDFGKO.js";import"./chunk-44S2QQS2.js";import"./chunk-DQOFEB5P.js";import"./chunk-JTDXB5TK.js";import"./chunk-2NP7F5RO.js";import"./chunk-7QY3BMVN.js";import"./chunk-XEZTJAR4.js";import"./chunk-BUP3AMMF.js";import"./chunk-XCIPBOI4.js";import"./chunk-CWUY5SXW.js";import"./chunk-KD27XIJC.js";import"./chunk-TPFJWNIU.js";import"./chunk-P25RU3X5.js";import"./chunk-XRRQM4E2.js";import"./chunk-GWBRHLNH.js";import"./chunk-W5OI4BJ2.js";import{l as $}from"./chunk-HM5RIVQC.js";import{a as Z}from"./chunk-EM35R6FY.js";import{b as Y}from"./chunk-QXXXCEV5.js";import"./chunk-6B5XFA6F.js";import"./chunk-NHEQ4TAR.js";import"./chunk-RZF6KTKU.js";import"./chunk-HP4LYRR4.js";import"./chunk-AFC2H4Q3.js";import"./chunk-OLOKUDVI.js";import"./chunk-4G7UTTZJ.js";import"./chunk-ZTOZWLEE.js";import"./chunk-RJWOVI3M.js";import"./chunk-SP2CO3KX.js";import"./chunk-NRBJLISB.js";import"./chunk-PTZYZULI.js";import"./chunk-NMLYCCKN.js";import"./chunk-RSDQHAJX.js";import"./chunk-BOVYXYHK.js";import"./chunk-FENRIY2T.js";import"./chunk-WDETDPZG.js";import"./chunk-HX2VGIR2.js";import"./chunk-64QN2VGD.js";import"./chunk-JGEVVXD4.js";import"./chunk-B3FO6PT7.js";import"./chunk-C4UMJHQC.js";import"./chunk-BCREO4Q5.js";import{a as K}from"./chunk-LXFQWIWE.js";import"./chunk-QT6UNBJP.js";import"./chunk-NSYL2RQJ.js";import{a as l,b as j,c as S,i as u,j as V}from"./chunk-MWSXMSWY.js";import"./chunk-JRCKELO6.js";import"./chunk-KJULKTB5.js";import"./chunk-LACL4BQ2.js";import{c as Q}from"./chunk-YR2HD3ZC.js";import"./chunk-GJASVPF6.js";import"./chunk-UBFCO3DV.js";import"./chunk-NMRTZBDM.js";import"./chunk-NI7FJV5X.js";import"./chunk-BUSG3ZOF.js";import"./chunk-XZIOXVVJ.js";import"./chunk-EXJYW3PC.js";import"./chunk-SXQPBCOX.js";import{g as B,i as N,m as J}from"./chunk-LFH24RLM.js";import"./chunk-Z5Q7KLA4.js";import"./chunk-X4LNX4BR.js";import"./chunk-4XZ6X7MQ.js";import"./chunk-WLHY3MMA.js";import"./chunk-KGVXGH6H.js";import"./chunk-ARRCN5K3.js";import"./chunk-LXQPIAN7.js";import"./chunk-FTDD7QBB.js";import"./chunk-DB3UIQCU.js";import"./chunk-SBHKMV3P.js";import"./chunk-R4A63S45.js";import"./chunk-ETE32IYO.js";import"./chunk-ONUGDWDK.js";import"./chunk-SG7CQU4O.js";import{H as C,g as z}from"./chunk-QHVIRF5H.js";import{I as W,i as I}from"./chunk-WZDN6K3C.js";import{a as E}from"./chunk-QGVBCWUY.js";import"./chunk-OJQ73TPF.js";import"./chunk-354SCPDU.js";import"./chunk-OVHPPCBL.js";import"./chunk-IYZFKXJ6.js";import{D as F,c as q,s as c}from"./chunk-CKJ56T2Q.js";import"./chunk-SNFOAZZQ.js";import"./chunk-F6JAWRPN.js";import{r as d,t as R}from"./chunk-UHRSAPGQ.js";import"./chunk-V76GWARL.js";import{a as U,b as D}from"./chunk-N2WTMF3X.js";var de=[1,1],f=ee(),ye={none:T.None,loop:T.Loop,oscillate:T.Oscillate};function _e(e){return e?D(U({type:"CIMAnimatedSymbolProperties"},e),{playAnimation:e.playing,repeatType:e.repeatType?ye[e.repeatType]:void 0}):{type:"CIMAnimatedSymbolProperties"}}var b=class extends ne{constructor(t){super(),this.elementView=t,this.isWrapAround=!1,this.wrapAroundShift=0,this.perspectiveTransform=Z(),this._handles=new z,this._vertices=new Float32Array(8),this._indices=new Uint16Array([0,0,0,1,1,0,1,1,1,1,0,0,0,0,0,1,1,0,1,1]),this._handles.add([l(()=>this.elementView.element.opacity,i=>this.opacity=i,u),l(()=>[this.elementView.coords],()=>{this.requestRender()},u),l(()=>["animationOptions"in this.elementView.element&&this.elementView.element.animationOptions],()=>{this._handles.remove("play"),this.texture=q(this.texture),this.requestRender()},u),j(()=>this.elementView.element.loaded,()=>{let i=this.elementView.element;this.ready(),oe(i)&&i.content!=null&&(this._handles.add([c(i.content,"play",()=>this.requestRender()),c(i.content,"loadeddata",()=>this.requestRender()),c(i.content,"loaded",()=>this.requestRender())]),"requestVideoFrameCallback"in i.content?i.content.requestVideoFrameCallback(()=>this.requestRender()):this._handles.add([c(i.content,"seeked",()=>this.requestRender())]),this.requestRender())},u)]),t.element.load().catch(i=>{d.getLogger("esri.views.2d.layers.MediaLayerView2D").error(new R("element-load-error","Element cannot be displayed",{element:t,error:i}))})}getMesh(t){throw new Error("Method not implemented.")}destroy(){this._handles.destroy(),this.texture=q(this.texture)}get textureSize(){return de}get dvsMat3(){return this.parent.dvsMat3}beforeRender(t){let{context:i}=t,r=this.elementView.element.content;if(r!=null){let o=r instanceof HTMLImageElement,n=r instanceof HTMLVideoElement,s=o?r.naturalWidth:n?r.videoWidth:r.width,p=o?r.naturalHeight:n?r.videoHeight:r.height;if(this._updatePerspectiveTransform(s,p),this.texture)n&&(this.texture.setData(r),this.texture.generateMipmap(),"requestVideoFrameCallback"in r?r.requestVideoFrameCallback(()=>this.requestRender()):r.paused||this.requestRender());else{let m=new re;if(m.wrapMode=$.CLAMP_TO_EDGE,m.preMultiplyAlpha=!0,m.width=s,m.height=p,"getFrame"in r){let w=h=>{this.texture?this.texture.setData(h):this.texture=new M(i,m,h),this.requestRender()};"animationOptions"in this.elementView.element&&this._handles.add(ae(r,_e(this.elementView.element.animationOptions),null,w),"play")}else this.texture=new M(i,m,r);this.texture.generateMipmap(),n&&("requestVideoFrameCallback"in r?r.requestVideoFrameCallback(()=>this.requestRender()):r.paused||this.requestRender())}}super.beforeRender(t)}_createTransforms(){return null}draw(t,i){this.isReady&&this.texture!=null?i.render(t,{transform:{dvs:this.dvsMat3},config:{perspective:this.perspectiveTransform,texSize:de,wrapAroundShift:this.wrapAroundShift,isWrapAround:this.isWrapAround,opacity:this.opacity,texture:{texture:this.texture,unit:0}},position:this._vertices,tex:this._indices}):this.requestRender()}updateDrawCoords(t,i,r,o){let{coords:n,bounds:s}=this.elementView;if(n==null||s==null)return;let[p,m,w,h]=n.rings[0],ue=this._vertices,{x:g,y:v}=t;ue.set([m[0]-g,m[1]-v,p[0]-g,p[1]-v,w[0]-g,w[1]-v,h[0]-g,h[1]-v]);let x=i;if(o){let[P,,k]=s,{worldWidth:H,xBounds:fe}=o,[L,O]=fe;P<L&&k>L?x=H:k>O&&P<O&&(x=-H)}this.wrapAroundShift=x,this.isWrapAround=x!==0}_updatePerspectiveTransform(t,i){let r=this._vertices;se(f,[0,0,t,0,0,i,t,i],[r[0],r[1],r[4],r[5],r[2],r[3],r[6],r[7]]),Y(this.perspectiveTransform,f[6]/f[8]*t,f[7]/f[8]*i)}};var _=class extends me(he(pe)){constructor(){super(...arguments),this._overlayContainer=null,this._fetchQueue=null,this._tileStrategy=null,this._elementReferences=new Map,this._debugGraphicsView=null,this._interaction=null,this.layer=null,this.elements=new Q}initialize(){this.addHandles([l(()=>[this.interactive,this.suspended],async()=>{if(this.interactive&&!this._interaction){let{MediaLayerInteraction:e}=await import("./chunk-HDIWGIRO.js");this._interaction=new e({view:this.view,layer:this.layer}),this.selectedElement!==this._interaction.selectedElement&&(this._interaction.selectedElement=this.selectedElement),this.interactionOptions!==this._interaction.options&&(this._interaction.options=this.interactionOptions)}this._interaction&&(this._interaction.enabled=!this.suspended&&this.interactive)},V),l(()=>this.interactionOptions,e=>{this._interaction&&(this._interaction.options=e)},V),l(()=>this.selectedElement,e=>{this._interaction&&(this._interaction.selectedElement=e)},V)])}attach(){this.addAttachHandles([S(()=>this.layer.effectiveSource,"refresh",()=>{this._tileStrategy.refresh(e=>this._updateTile(e)),this.requestUpdate()}),S(()=>this.layer.effectiveSource,"change",({element:e})=>this._elementUpdateHandler(e))]),this._overlayContainer=new le,this.container.addChild(this._overlayContainer),this._fetchQueue=new te({tileInfoView:this.view.featuresTilingScheme,concurrency:10,process:(e,t)=>this._queryElements(e,t),scheduler:this.scheduler,priority:X.MAPVIEW_FETCH_QUEUE}),this._tileStrategy=new ie({cachePolicy:"purge",resampling:!0,acquireTile:e=>this._acquireTile(e),releaseTile:e=>this._releaseTile(e),tileInfoView:this.view.featuresTilingScheme}),this.requestUpdate()}detach(){this.elements.removeAll(),this._tileStrategy.destroy(),this._fetchQueue.destroy(),this._overlayContainer.removeAllChildren(),this.container.removeAllChildren(),this._elementReferences.clear(),this._debugGraphicsView?.destroy()}supportsSpatialReference(e){return!0}viewChange(){this.requestUpdate()}moveEnd(){this.requestUpdate()}update(e){this._tileStrategy.update(e),this._debugGraphicsView?.update(e)}async hitTest(e,t){let i=[],r=e.normalize(),o=[r.x,r.y];for(let{elementView:{normalizedCoords:n,element:s}}of this._elementReferences.values())n!=null&&B(n.rings,o)&&i.push({type:"media",element:s,layer:this.layer,mapPoint:e,sourcePoint:s.toSource(e)});return i.reverse()}canResume(){return this.layer.source!=null&&super.canResume()}async doRefresh(){this._fetchQueue.reset(),this._tileStrategy.refresh(e=>this._updateTile(e))}_acquireTile(e){let t=new G(e.clone());return this._updateTile(t),t}_updateTile(e){this._updatingHandles.addPromise(this._fetchQueue.push(e.key).then(t=>{let[i,r]=e.setElements(t);this._referenceElements(e,i),this._dereferenceElements(e,r),this.requestUpdate()},t=>{F(t)||d.getLogger(this).error(t)}))}_releaseTile(e){this._fetchQueue.abort(e.key.id),e.elements&&this._dereferenceElements(e,e.elements),this.requestUpdate()}async _queryElements(e,t){let i=this.layer.effectiveSource;if(i==null)return[];this.view.featuresTilingScheme.getTileBounds(a,e,!0);let r=new J({xmin:a[0],ymin:a[1],xmax:a[2],ymax:a[3],spatialReference:this.view.spatialReference});return i.queryElements(r,t)}_referenceElements(e,t){if(this.layer.source!=null)for(let i of t)this._referenceElement(e,i)}_referenceElement(e,t){I(this._elementReferences,t.uid,()=>{let i=new A({element:t,spatialReference:this.view.spatialReference}),r=new b(i);return this._overlayContainer.addChild(r),this.elements.add(t),this._updatingHandles.addPromise(t.load().catch(o=>{d.getLogger("esri.views.2d.layers.MediaLayerView2D").error(new R("element-load-error","Element cannot be displayed",{element:t,error:o}))})),{debugGraphic:null,elementView:i,overlay:r,tiles:new Set}}).tiles.add(e)}_dereferenceElements(e,t){for(let i of t)this._dereferenceElement(e,i)}_dereferenceElement(e,t){let i=this._elementReferences.get(t.uid);i.tiles.delete(e),i.tiles.size||(this._overlayContainer.removeChild(i.overlay),i.overlay.destroy(),i.elementView.destroy(),this._elementReferences.delete(t.uid),this.elements.remove(t),this._debugGraphicsView?.graphics.remove(i.debugGraphic))}_elementUpdateHandler(e){let t=this._elementReferences.get(e.uid);if(t){let r=t.elementView.normalizedCoords;if(r==null)return this._overlayContainer.removeChild(t.overlay),t.overlay.destroy(),t.elementView.destroy(),this._elementReferences.delete(e.uid),this.elements.remove(e),void this._debugGraphicsView?.graphics.remove(t.debugGraphic);let o=[],n=[];for(let s of this._tileStrategy.tiles){let p=ce(this.view.featuresTilingScheme,s,r);t.tiles.has(s)?p||n.push(s):p&&o.push(s)}for(let s of o)this._referenceElement(s,e);for(let s of n)this._dereferenceElement(s,e);return t=this._elementReferences.get(e.uid),void(t?.debugGraphic&&(t.debugGraphic.geometry=t.elementView.normalizedCoords,this._debugGraphicsView.graphicUpdateHandler({graphic:t.debugGraphic,property:"geometry"})))}let i=new A({element:e,spatialReference:this.view.spatialReference}).normalizedCoords;if(i!=null)for(let r of this._tileStrategy.tiles)ce(this.view.featuresTilingScheme,r,i)&&this._referenceElement(r,e)}};E([C()],_.prototype,"layer",void 0),E([C({readOnly:!0})],_.prototype,"elements",void 0),_=E([W("esri.views.2d.layers.MediaLayerView2D")],_);var a=K(),y={xmin:0,ymin:0,xmax:0,ymax:0};function ce(e,t,i){return e.getTileBounds(a,t.key,!0),y.xmin=a[0],y.ymin=a[1],y.xmax=a[2],y.ymax=a[3],N(y,i)}var G=class{constructor(t){this.key=t,this.elements=null,this.isReady=!1,this.visible=!0}setElements(t){let i=[],r=new Set(this.elements);this.elements=t;for(let o of t)r.has(o)?r.delete(o):i.push(o);return this.isReady=!0,[i,Array.from(r)]}destroy(){}},Er=_;export{Er as default};
