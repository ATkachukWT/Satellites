import{a as Z}from"./chunk-NOHUHVCW.js";import{b as X}from"./chunk-F4FOXK2P.js";import{c as Y}from"./chunk-SWCOPTUX.js";import{b as Q}from"./chunk-AEU2INWT.js";import{a as K}from"./chunk-3J3Q4LMA.js";import{b as J}from"./chunk-YQNUGDFH.js";import{a as j}from"./chunk-AOQ57NDM.js";import{a as H,g as d}from"./chunk-ONYJLWAD.js";import{d as W}from"./chunk-XCIPBOI4.js";import{F as L,l as k}from"./chunk-KD27XIJC.js";import{d as z}from"./chunk-Y6YEAKJ5.js";import{a as q}from"./chunk-RWCIDBNQ.js";import{l as C}from"./chunk-HM5RIVQC.js";import{e as U}from"./chunk-BOVYXYHK.js";import{c as R}from"./chunk-JRCKELO6.js";import{E as F}from"./chunk-ETE32IYO.js";import{y as E}from"./chunk-CKJ56T2Q.js";import{r as S,t as V}from"./chunk-UHRSAPGQ.js";var p=()=>S.getLogger("esri.views.3d.layers.graphics.objectResourceUtils"),D=class{constructor(t,a,e){this.resource=t,this.textures=a,this.cachedMemory=e}};async function ke(r,t){let a=await ne(r,t),e=await le(a.textureDefinitions??{},t),u=0;for(let o in e)if(e.hasOwnProperty(o)){let s=e[o];u+=s?.image?s.image.width*s.image.height*4:0}return new D(a,e,u+W(a))}async function ne(r,t){let a=t?.streamDataRequester;if(a)return oe(r,a,t);let e=await R(F(r,t));if(e.ok===!0)return e.value.data;E(e.error),_(e.error)}async function oe(r,t,a){let e=await R(t.request(r,"json",a));if(e.ok===!0)return e.value;E(e.error),_(e.error.details.url)}function _(r){throw new V("",`Request for object resource failed: ${r}`)}function ie(r){let t=r.params,a=t.topology,e=!0;switch(t.vertexAttributes||(p().warn("Geometry must specify vertex attributes"),e=!1),t.topology){case"PerAttributeArray":break;case"Indexed":case null:case void 0:{let o=t.faces;if(o){if(t.vertexAttributes)for(let s in t.vertexAttributes){let i=o[s];i?.values?(i.valueType!=null&&i.valueType!=="UInt32"&&(p().warn(`Unsupported indexed geometry indices type '${i.valueType}', only UInt32 is currently supported`),e=!1),i.valuesPerElement!=null&&i.valuesPerElement!==1&&(p().warn(`Unsupported indexed geometry values per element '${i.valuesPerElement}', only 1 is currently supported`),e=!1)):(p().warn(`Indexed geometry does not specify face indices for '${s}' attribute`),e=!1)}}else p().warn("Indexed geometries must specify faces"),e=!1;break}default:p().warn(`Unsupported topology '${a}'`),e=!1}r.params.material||(p().warn("Geometry requires material"),e=!1);let u=r.params.vertexAttributes;for(let o in u)u[o].values||(p().warn("Geometries with externally defined attributes are not yet supported"),e=!1);return e}function Ce(r,t){let a=new Array,e=new Array,u=new Array,o=new Z,s=r.resource,i=j.parse(s.version||"1.0","wosr");pe.validate(i);let M=s.model.name,g=s.model.geometries,w=s.materialDefinitions??{},v=r.textures,b=0,y=new Map;for(let I=0;I<g.length;I++){let h=g[I];if(!ie(h))continue;let B=ce(h),P=h.params.vertexAttributes,O=[],te=n=>{if(h.params.topology==="PerAttributeArray")return null;let l=h.params.faces;for(let c in l)if(c===n)return l[c].values;return null},N=P[q.POSITION],re=N.values.length/N.valuesPerElement;for(let n in P){let l=P[n],c=l.values,T=te(n)??z(re);O.push([n,new J(c,T,l.valuesPerElement,!0)])}let f=B.texture,m=v&&v[f];if(m&&!y.has(f)){let{image:n,parameters:l}=m,c=new Q(n,l);e.push(c),y.set(f,c)}let $=y.get(f),ae=$?$.id:void 0,A=B.material,x=o.get(A,f);if(x==null){let n=w[A.slice(A.lastIndexOf("/")+1)].params;n.transparency===1&&(n.transparency=0);let l=m&&m.alphaChannelUsage,c=n.transparency>0||l==="transparency"||l==="maskAndTransparency",T=m?ee(m.alphaChannelUsage):void 0,G={ambient:U(n.diffuse),diffuse:U(n.diffuse),opacity:1-(n.transparency||0),transparent:c,textureAlphaMode:T,textureAlphaCutoff:.33,textureId:ae,doubleSided:!0,cullFace:H.None,colorMixMode:n.externalColorMixMode||"tint",textureAlphaPremultiplied:m?.parameters.preMultiplyAlpha??!1};t?.materialParameters&&Object.assign(G,t.materialParameters),x=new X(G,t),o.set(A,f,x)}u.push(x);let se=new Y(x,O);b+=O.find(n=>n[0]===q.POSITION)?.[1]?.indices.length??0,a.push(se)}return{engineResources:[{name:M,stageResources:{textures:e,materials:u,geometries:a},pivotOffset:s.model.pivotOffset,numberOfVertices:b,lodThreshold:null}],referenceBoundingBox:ue(a)}}function ue(r){let t=L();return r.forEach(a=>{let e=a.boundingInfo;e!=null&&(k(t,e.bbMin),k(t,e.bbMax))}),t}async function le(r,t){let a=new Array;for(let o in r){let s=r[o],i=s.images[0].data;if(!i){p().warn("Externally referenced texture data is not yet supported");continue}let M=s.encoding+";base64,"+i,g="/textureDefinitions/"+o,w=s.channels==="rgba"?s.alphaChannelUsage||"transparency":"none",v={noUnpackFlip:!0,wrap:{s:C.REPEAT,t:C.REPEAT},preMultiplyAlpha:ee(w)!==d.Opaque},b=t?.disableTextures?Promise.resolve(null):K(M,t);a.push(b.then(y=>({refId:g,image:y,parameters:v,alphaChannelUsage:w})))}let e=await Promise.all(a),u={};for(let o of e)u[o.refId]=o;return u}function ee(r){switch(r){case"mask":return d.Mask;case"maskAndTransparency":return d.MaskBlend;case"none":return d.Opaque;default:return d.Blend}}function ce(r){let t=r.params;return{id:1,material:t.material,texture:t.texture,region:t.texture}}var pe=new j(1,2,"wosr");export{ke as a,Ce as b};
