import{f as $}from"./chunk-WGX2RQVH.js";import{a as P,b as x}from"./chunk-3S7MXQDG.js";import{a as R}from"./chunk-4Y7EKSO4.js";import{a as V}from"./chunk-HPPVXWXI.js";import{a as D}from"./chunk-HBMVPT4U.js";import{b as S}from"./chunk-NK3VUQOP.js";import{w as W}from"./chunk-M7AB4SQK.js";import{b as _}from"./chunk-TBA3OZMJ.js";import{M as z,g as C,h as c,i as F,j as k,n as G,o as B,p as Q,q as O,r as M,t as H,w as T}from"./chunk-HP4LYRR4.js";import{a as U,b as q}from"./chunk-AFC2H4Q3.js";import{b as j}from"./chunk-4G7UTTZJ.js";import{a as A,c as v,j as N}from"./chunk-MWSXMSWY.js";import{H as p}from"./chunk-QHVIRF5H.js";import{I as L}from"./chunk-WZDN6K3C.js";import{a as d}from"./chunk-QGVBCWUY.js";import{v as w}from"./chunk-CKJ56T2Q.js";import{r as g,t as b}from"./chunk-UHRSAPGQ.js";function Z(y,i){if(i.type!=="feature"&&i.type!=="subtype-group")return[];if(!i.url)return[];let t="utilityNetworks"in y.map?y.map.utilityNetworks??[]:[];for(let e of t)if(e.isUtilityLayer(i)){let r=i.fieldsIndex.get("assetgroup"),s=i.fieldsIndex.get("assettype");return[r?.name,s?.name].filter(o=>o!=null)}return[]}var E=class{constructor(i){this._fieldsIndex=i,this._clauses=[]}async finish(){return{requiresCurrentUser:(await Promise.all(this._clauses)).some(i=>i.currentUserRequired)}}visitClientWhereClause(i){i&&this._clauses.push(U(i,this._fieldsIndex))}visitFeatureReduction(i){if(i)switch(i.type){case"binning":case"cluster":this.visitLabelingInfo(i.labelsVisible,i.labelingInfo)}}visitLabelingInfo(i,t){if(i&&t!=null)for(let e of t)this.visitClientWhereClause(e.where)}visitDisplayFilter(i,t){if(i)for(let e of t?.filters??[])this.visitClientWhereClause(e.where)}visitFilter(i){this.visitClientWhereClause(i?.where)}visitTrackInfo(i){i!=null&&(this.visitLabelingInfo(i?.latestObservations.labelsVisible,i?.latestObservations.labelingInfo),this.visitLabelingInfo(i?.previousObservations.labelsVisible,i?.previousObservations.labelingInfo),this.visitLabelingInfo(i?.trackLines.labelsVisible,i?.trackLines.labelingInfo))}};var we=y=>{let i=class extends y{constructor(...t){super(...t),this._updatingRequiredPromise=null,this.filter=null,this.layer=null,this.requiresCurrentUser=!1,this.requiredFields=[],this.view=null}initialize(){this.addHandles([A(()=>{let t=this.layer,e=this.view;return[t&&"elevationInfo"in t?t.elevationInfo?.featureExpressionInfo:null,t&&"displayField"in t?t.displayField:null,t&&"timeInfo"in t&&t.timeInfo,t&&"renderer"in t&&t.renderer,t&&"labelingInfo"in t&&t.labelingInfo,t&&"floorInfo"in t&&t.floorInfo,e?.requiredFieldsOptions?.featureTitleFields&&t&&"featureTitleFields"in t&&t.featureTitleFields,e?.requiredFieldsOptions?.utilityNetworkFields&&Z(e,t),t.displayFilterInfo,this.displayFilterEnabled,this.filter,this.featureEffect,this.timeExtent,t?.type==="knowledge-graph-sublayer"&&t.parentCompositeLayer.type==="link-chart"&&t.parentCompositeLayer.linkChart?.linkChartProperties.nonspatialDataDisplay?.mode,t?.type==="parquet"&&t.popupTemplate]},()=>this._handleChange(),N),v(()=>this.view?.floors,"change",()=>this._handleChange()),v(()=>this.layer.displayFilterInfo?.filters,"change",()=>this._handleChange()),v(()=>this.layer&&"sublayers"in this.layer?this.layer.sublayers:null,"change",()=>this._handleChange())])}get availableFields(){if(!this.layer)return[];let{layer:t,layer:{fieldsIndex:e},requiredFields:r}=this;return"outFields"in t&&t.outFields?C(e,[...k(e,t.outFields),...r]):C(e,r)}get displayFilterEnabled(){return(this.view?.displayFilterEnabled??!0)&&(!("displayFilterEnabled"in this.layer)||(this.layer?.displayFilterEnabled??!0))}get effectiveDisplayFilter(){let t=this.layer;return this.displayFilterEnabled&&t.displayFilterInfo?S(t.displayFilterInfo,this.view):null}get featureEffect(){return this.layer&&"featureEffect"in this.layer?this.layer.featureEffect:null}set featureEffect(t){this._override("featureEffect",t)}get maximumNumberOfFeatures(){return 0}set maximumNumberOfFeatures(t){g.getLogger(this).error("#maximumNumberOfFeatures=","Setting maximum number of features is not supported")}get maximumNumberOfFeaturesExceeded(){return!1}get signedInUser(){return this.layer?.url?W(this.layer.url):Promise.resolve(null)}highlight(t,e){throw new Error("missing implementation")}createQuery(){let t={outFields:["*"],returnGeometry:!0,outSpatialReference:this.view.spatialReference},e=this.filter!=null?this.filter.createQuery(t):new _(t);return"floorInfo"in this.layer&&this.layer.floorInfo&&(e.where=q(e.where,R(this))),this.displayFilterEnabled&&(e.where=q(e.where,this.effectiveDisplayFilter?.where)),this.timeExtent!=null&&(e.timeExtent=e.timeExtent!=null?e.timeExtent.intersection(this.timeExtent):this.timeExtent.clone()),e}createAggregateQuery(){let t={outFields:["*"],returnGeometry:!0,outSpatialReference:this.view.spatialReference};return new _(t)}queryFeatures(t,e){throw new Error("missing implementation")}queryObjectIds(t,e){throw new Error("missing implementation")}queryFeatureCount(t,e){throw new Error("missing implementation")}queryExtent(t,e){throw new Error("missing implementation")}async fetchPopupFeaturesFromGraphics(t,e){return this._validateFetchPopupFeatures(t,e),this._fetchPopupFeatures(t,e)}_loadArcadeModules(t){return t.expressionInfos?.length||Array.isArray(t.content)&&t.content.some(e=>e.type==="expression")?j():Promise.resolve()}_handleChange(){let t=Promise.all([this._updateRequiredFields(),this._updateClientWhereClauseRequirements()]).then(()=>{});return this._set("_updatingRequiredPromise",t),t.then(()=>{this._updatingRequiredPromise===t&&this._set("_updatingRequiredPromise",null)}),t}async _updateClientWhereClauseRequirements(){if(!this.layer||!this.view)return;let{layer:t}=this,e=new E(t.fieldsIndex);if(e.visitFilter(this.filter),"featureReduction"in t&&e.visitFeatureReduction(t.featureReduction),"labelingInfo"in t&&e.visitLabelingInfo(t.labelsVisible,t.labelingInfo),"trackInfo"in t&&e.visitTrackInfo(t.trackInfo),this.view.type==="2d"&&(e.visitFilter(this.featureEffect?.filter),e.visitDisplayFilter(this.displayFilterEnabled,t.displayFilterInfo),"featureReduction"in t&&e.visitFeatureReduction(t.featureReduction)),t.type==="subtype-group")for(let r of t.sublayers)e.visitLabelingInfo(r.labelsVisible,r.labelingInfo);try{let r=await e.finish();this._set("requiresCurrentUser",r.requiresCurrentUser)}catch(r){g.getLogger(this).error(r)}}async _updateRequiredFields(){if(!this.layer||!this.view)return;let t=this.view.type==="3d",{layer:e,layer:{fieldsIndex:r,objectIdField:s}}=this,o="renderer"in e&&e.renderer,a="orderBy"in e&&e.orderBy,n="featureReduction"in e?e.featureReduction:null,l=new Set,f=[o?o.collectRequiredFields(l,r):null,T(l,e),t&&"elevationInfo"in e?G(l,e):null,this.filter!=null?O(l,e,this.filter):null,t||this.featureEffect==null?null:O(l,e,this.featureEffect.filter),!t&&n?B(l,e,n):null,!t&&a?M(l,e,a):null];if("timeInfo"in e&&e.timeInfo&&this.timeExtent&&c(l,e.fieldsIndex,[e.timeInfo.startField,e.timeInfo.endField]),"timeInfo"in e&&e.timeInfo&&"trackInfo"in e&&e.trackInfo){let{trackInfo:u}=e;c(l,e.fieldsIndex,[e.timeInfo.trackIdField]),e.type!=="feature"&&u.timeField!=="startTimeField"||c(l,e.fieldsIndex,[e.timeInfo.startField]),u.timeField==="endTimeField"&&c(l,e.fieldsIndex,[e.timeInfo.endField]),await Q(l,e)}if("floorInfo"in e&&e.floorInfo&&c(l,e.fieldsIndex,[e.floorInfo.floorField]),"featureTitleFields"in e&&this.view?.requiredFieldsOptions?.featureTitleFields&&e.featureTitleFields&&c(l,e.fieldsIndex,e.featureTitleFields),e.type==="feature"&&e.globalIdField&&this.view?.requiredFieldsOptions?.globalIdField&&c(l,e.fieldsIndex,[e.globalIdField]),this.displayFilterEnabled&&f.push(H(l,e,e.displayFilterInfo)),e.type==="feature"&&t&&e.infoFor3D!=null&&(e.globalIdField==null&&g.getLogger(this).error("globalIdField missing on 3DObjectFeatureLayer"),c(l,e.fieldsIndex,[e.globalIdField])),e.type==="subtype-group"){F(l,r,e.subtypeField);let u=e.sublayers.map(I=>Promise.all([I.renderer?.collectRequiredFields(l,r),T(l,I)]));f.push(Promise.all(u))}if(e.type==="catalog-footprint"&&e.parent){let u=e.parent;c(l,r,[u.itemNameField,u.itemSourceField,u.itemTypeField,u.maxScaleField,u.minScaleField])}e.type==="knowledge-graph-sublayer"&&e.parentCompositeLayer.type==="link-chart"&&F(l,r,$),e.type==="parquet"&&f.push(P(e,e.popupTemplate).then(u=>{for(let I of u)l.add(I)}));let m=await Promise.allSettled(f);F(l,r,s),t&&"displayField"in e&&e.displayField&&F(l,r,e.displayField);for(let u of m)u.status==="rejected"&&g.getLogger(this).error(u.reason);let h=Array.from(l).sort();this._set("requiredFields",h)}_validateFetchPopupFeatures(t,e){if(e!=null)for(let r of t){let s=r.origin&&"layer"in r.origin?r.origin.layer:r.layer;if("popupEnabled"in s&&!s.popupEnabled)throw new b("featurelayerview:fetchPopupFeatures","Popups are disabled",{layer:s});if(r.isAggregate){let o="featureReduction"in s?s.featureReduction:null,a="trackInfo"in s?s.trackInfo:null;if(o==null&&a==null||o!=null&&(!("popupTemplate"in o)||!o.popupEnabled||!o.popupTemplate)||a?.enabled&&(!("popupTemplate"in a)||!a.popupEnabled||!a.popupTemplate))throw new b("featurelayerview:fetchPopupFeatures","Popups are disabled",{layer:s})}else if("popupTemplate"in s&&!x(s,e))throw new b("featurelayerview:fetchPopupFeatures","Layer does not define a popup template",{layer:s})}}_popupFeatureHasRequiredFields(t,e){return z(e,t)}async _fetchPopupFeatures(t,e){let r=new Array(t.length),s=new Map,o=await this._createPopupQuery(t.map(a=>a.origin?.layer??a.layer),e);for(let a=0;a<t.length;a++){let n=t[a];if(n.isAggregate){r[a]=n;continue}let l=n.origin?.layer??n.layer;if(!l||!("popupEnabled"in l))continue;let f=k(this.layer.fieldsIndex,o.outFields),m=x(l,e);if(m==null)continue;let h=await this._loadArcadeModules(m);w(e),h&&h.arcadeUtils.hasGeometryOperations(m)||!this._popupFeatureHasRequiredFields(n,f)?s.set(n.getObjectId(),{graphic:n,index:a}):r[a]=n}if(this.layer.type==="stream"||this.layer.type==="parquet"||s.size===0)return r.filter(Boolean);o.objectIds=Array.from(s.keys());try{let a=await this.layer.queryFeatures(o,e);for(let n of a.features){let{graphic:{geometry:l,origin:f},index:m}=s.get(n.getObjectId());n.geometry||=l,n.origin=f,r[m]=n}}catch{}return r.filter(Boolean)}async _createPopupQuery(t,e){let r=this.layer.createQuery(),s=new Set,o=!1,a=t??[this.layer];for(let n of a){if(!("popupEnabled"in n))continue;let l=x(n,e);if(l==null)continue;let f=await this._loadArcadeModules(l);w(e);let m=f&&f.arcadeUtils.hasGeometryOperations(l);o=!(this.layer.geometryType!=="point"&&!m);let h=await P(this.layer,l);w(e);for(let u of h)s.add(u)}if(r.returnGeometry=o,r.returnZ=o,r.returnM=o,r.outFields=Array.from(s),r.outSpatialReference=this.view.spatialReference,"floorInfo"in this.layer&&this.layer.floorInfo){let n=R(this);n!=null&&(r.where=r.where?`(${r.where}) AND (${n})`:n)}return r}canResume(){return!!super.canResume()&&(this.timeExtent==null||!this.timeExtent.isEmpty)}getTest(){}get test(){}};return d([p()],i.prototype,"_updatingRequiredPromise",void 0),d([p({readOnly:!0})],i.prototype,"availableFields",null),d([p({readOnly:!0})],i.prototype,"displayFilterEnabled",null),d([p({readOnly:!0})],i.prototype,"effectiveDisplayFilter",null),d([p({type:V})],i.prototype,"featureEffect",null),d([p({type:D})],i.prototype,"filter",void 0),d([p()],i.prototype,"layer",void 0),d([p({type:Number})],i.prototype,"maximumNumberOfFeatures",null),d([p({readOnly:!0,type:Boolean})],i.prototype,"maximumNumberOfFeaturesExceeded",null),d([p()],i.prototype,"requiresCurrentUser",void 0),d([p({readOnly:!0})],i.prototype,"requiredFields",void 0),d([p({readOnly:!0})],i.prototype,"signedInUser",null),d([p()],i.prototype,"suspended",void 0),d([p()],i.prototype,"view",void 0),i=d([L("esri.views.layers.FeatureLayerView")],i),i};export{we as a};
