import{a as J}from"./chunk-HWNR66KX.js";import{a as g,b as T,c as _,d as O,e as z,f as H}from"./chunk-KO6SRXH5.js";import"./chunk-WOGTXK7W.js";import{a as L,b as $,c as W}from"./chunk-CQUBHG54.js";import{a as B}from"./chunk-NVYT4DEO.js";import{a as G}from"./chunk-L25QECEE.js";import"./chunk-E4ND5WCV.js";import"./chunk-JX3MPN3R.js";import{c as P}from"./chunk-IE6LCR36.js";import"./chunk-SCNTWYD2.js";import"./chunk-K3Z3MI77.js";import"./chunk-35XAFVAL.js";import{a as b,b as E}from"./chunk-C3PAYYXB.js";import"./chunk-3CWCNPAI.js";import"./chunk-UCYOLKZK.js";import"./chunk-WTZT4FKW.js";import"./chunk-6FDNNAVT.js";import"./chunk-FYZRIMPP.js";import"./chunk-VYI3HIPB.js";import"./chunk-WI3QVC6K.js";import"./chunk-6KRFVLII.js";import"./chunk-G27DRLGO.js";import"./chunk-KRAKR4MK.js";import"./chunk-MCO7DSFO.js";import"./chunk-D7WE3OBT.js";import{a as D}from"./chunk-CDP4MSRO.js";import"./chunk-BCSLWH5H.js";import"./chunk-TOH4K6HW.js";import"./chunk-UP6FLASM.js";import"./chunk-DGBDFGKO.js";import"./chunk-44S2QQS2.js";import"./chunk-DQOFEB5P.js";import"./chunk-JTDXB5TK.js";import{j as C,k as q,l as k}from"./chunk-2NP7F5RO.js";import"./chunk-7QY3BMVN.js";import"./chunk-XEZTJAR4.js";import"./chunk-BUP3AMMF.js";import"./chunk-XCIPBOI4.js";import{a as Z}from"./chunk-CWUY5SXW.js";import"./chunk-KD27XIJC.js";import"./chunk-TPFJWNIU.js";import"./chunk-P25RU3X5.js";import"./chunk-XRRQM4E2.js";import"./chunk-GWBRHLNH.js";import"./chunk-M67YQAIX.js";import"./chunk-NHEQ4TAR.js";import"./chunk-BIRSPTTF.js";import"./chunk-IZLELRQR.js";import"./chunk-7EMOONQX.js";import"./chunk-RZF6KTKU.js";import{x as N,y as U}from"./chunk-HP4LYRR4.js";import"./chunk-AFC2H4Q3.js";import"./chunk-OLOKUDVI.js";import"./chunk-4G7UTTZJ.js";import"./chunk-ZTOZWLEE.js";import"./chunk-RJWOVI3M.js";import"./chunk-SP2CO3KX.js";import"./chunk-NRBJLISB.js";import"./chunk-PTZYZULI.js";import"./chunk-NMLYCCKN.js";import"./chunk-RSDQHAJX.js";import"./chunk-BOVYXYHK.js";import{c as R,g as I}from"./chunk-FENRIY2T.js";import"./chunk-5HJY3X5Y.js";import"./chunk-6RZAM42M.js";import"./chunk-WDETDPZG.js";import"./chunk-HX2VGIR2.js";import"./chunk-64QN2VGD.js";import"./chunk-JGEVVXD4.js";import"./chunk-B3FO6PT7.js";import"./chunk-C4UMJHQC.js";import"./chunk-BCREO4Q5.js";import"./chunk-LXFQWIWE.js";import"./chunk-QT6UNBJP.js";import"./chunk-MWSXMSWY.js";import"./chunk-JRCKELO6.js";import"./chunk-ZVCMULXF.js";import"./chunk-KJULKTB5.js";import{c as M}from"./chunk-LACL4BQ2.js";import"./chunk-YR2HD3ZC.js";import"./chunk-GJASVPF6.js";import"./chunk-UBFCO3DV.js";import"./chunk-BUSG3ZOF.js";import"./chunk-XZIOXVVJ.js";import"./chunk-LFH24RLM.js";import"./chunk-Z5Q7KLA4.js";import"./chunk-X4LNX4BR.js";import"./chunk-4XZ6X7MQ.js";import"./chunk-WLHY3MMA.js";import{C as x}from"./chunk-KGVXGH6H.js";import"./chunk-ARRCN5K3.js";import"./chunk-FTDD7QBB.js";import"./chunk-DB3UIQCU.js";import"./chunk-SBHKMV3P.js";import"./chunk-R4A63S45.js";import"./chunk-ETE32IYO.js";import"./chunk-ONUGDWDK.js";import"./chunk-SG7CQU4O.js";import"./chunk-QHVIRF5H.js";import"./chunk-WZDN6K3C.js";import"./chunk-QGVBCWUY.js";import"./chunk-OJQ73TPF.js";import"./chunk-354SCPDU.js";import"./chunk-OVHPPCBL.js";import"./chunk-IYZFKXJ6.js";import"./chunk-CKJ56T2Q.js";import"./chunk-SNFOAZZQ.js";import"./chunk-F6JAWRPN.js";import{t as F}from"./chunk-UHRSAPGQ.js";import"./chunk-V76GWARL.js";import{a as v,b as A}from"./chunk-N2WTMF3X.js";var Y=x,ee={xmin:-180,ymin:-90,xmax:180,ymax:90,spatialReference:x},te={hasAttachments:!1,capabilities:"query, editing, create, delete, update",useStandardizedQueries:!0,supportsCoordinatesQuantization:!0,supportsReturningQueryGeometry:!0,advancedQueryCapabilities:{supportsQueryAttachments:!1,supportsQueryAttachmentOrderByFields:!1,supportsQueryBins:!0,supportsStatistics:!0,supportsPercentileStatistics:!0,supportsReturningGeometryCentroid:!0,supportsQueryWithDistance:!0,supportsDistinct:!0,supportsReturningQueryExtent:!0,supportsReturningGeometryProperties:!1,supportsHavingClause:!0,supportsOrderBy:!0,supportsPagination:!0,supportsQueryWithResultType:!0,supportsSqlExpression:!0,supportsDisjointSpatialRel:!0,supportsQueryWithCacheHint:!0},queryBinsCapabilities:H};function ie(h){return R(h)?h.z!=null:!!h.hasZ}function se(h){return R(h)?h.m!=null:!!h.hasM}var V=class{constructor(){this._queryEngine=null,this._nextObjectId=null}destroy(){this._queryEngine?.destroy(),this._queryEngine=this._createDefaultAttributes=null}async load(e){let i=[],{features:a}=e,n=this._inferLayerProperties(a,e.fields),l=e.fields||[],d=e.hasM!=null?e.hasM:!!n.hasM,f=e.hasZ!=null?e.hasZ:!!n.hasZ,p=!e.spatialReference&&!n.spatialReference,u=p?Y:e.spatialReference||n.spatialReference,m=p?ee:null,y=e.geometryType||n.geometryType,o=!y,t=e.objectIdField||n.objectIdField,r=e.timeInfo,c=new D(l);if(!o&&(p&&i.push({name:"feature-layer:spatial-reference-not-found",message:"Spatial reference not provided or found in features. Defaults to WGS84"}),!y))throw new F("feature-layer:missing-property","geometryType not set and couldn't be inferred from the provided features");if(!t)throw new F("feature-layer:missing-property","objectIdField not set and couldn't be found in the provided fields");if(n.objectIdField&&t!==n.objectIdField&&(i.push({name:"feature-layer:duplicated-oid-field",message:`Provided objectIdField "${t}" doesn't match the field name "${n.objectIdField}", found in the provided fields`}),t=n.objectIdField),t&&!n.objectIdField){let s=c.get(t);s?(t=s.name,s.type="esriFieldTypeOID",s.editable=!1,s.nullable=!1):l.unshift({alias:t,name:t,type:"esriFieldTypeOID",editable:!1,nullable:!1})}for(let s of l){if(s.name==null&&(s.name=s.alias),s.alias==null&&(s.alias=s.name),!s.name)throw new F("feature-layer:invalid-field-name","field name is missing",{field:s});if(s.name===t&&(s.type="esriFieldTypeOID"),!Z.jsonValues.includes(s.type))throw new F("feature-layer:invalid-field-type",`invalid type for field "${s.name}"`,{field:s});s.length==null&&(s.length=U(s))}let j={};for(let s of l)if(s.type!=="esriFieldTypeOID"&&s.type!=="esriFieldTypeGlobalID"){let S=N(s);S!==void 0&&(j[s.name]=S)}if(r){if(r.startTimeField){let s=c.get(r.startTimeField);s?(r.startTimeField=s.name,s.type="esriFieldTypeDate"):r.startTimeField=null}if(r.endTimeField){let s=c.get(r.endTimeField);s?(r.endTimeField=s.name,s.type="esriFieldTypeDate"):r.endTimeField=null}if(r.trackIdField){let s=c.get(r.trackIdField);s?r.trackIdField=s.name:(r.trackIdField=null,i.push({name:"feature-layer:invalid-timeInfo-trackIdField",message:"trackIdField is missing",details:{timeInfo:r}}))}r.startTimeField||r.endTimeField||(i.push({name:"feature-layer:invalid-timeInfo",message:"startTimeField and endTimeField are missing or invalid",details:{timeInfo:r}}),r=null)}let w=c.dateFields.length?{timeZoneIANA:e.dateFieldsTimeZone??M}:null;this._createDefaultAttributes=$(j,t);let Q={warnings:i,featureErrors:[],layerDefinition:A(v({},te),{drawingInfo:L(y),templates:W(j),extent:m,geometryType:y,objectIdField:t,fields:l,hasZ:f,hasM:d,timeInfo:r,dateFieldsTimeReference:w}),assignedObjectIds:{}};if(this._queryEngine=new P({fieldsIndex:D.fromLayerJSON({fields:l,timeInfo:r,dateFieldsTimeReference:w}),geometryType:y,hasM:d,hasZ:f,objectIdField:t,spatialReference:u,featureStore:new G({geometryType:y,hasM:d,hasZ:f}),timeInfo:r}),!a?.length)return this._nextObjectId=1,Q;let K=J(t,a);return this._nextObjectId=K+1,await b(a,u),this._loadInitialFeatures(Q,a)}async applyEdits(e){let{spatialReference:i,geometryType:a}=this._queryEngine;return await Promise.all([z(i,a),b(e.adds,i),b(e.updates,i)]),this._applyEdits(e)}queryFeatures(e,i={}){return this._queryEngine.executeQuery(e,i.signal)}queryFeatureCount(e,i={}){return this._queryEngine.executeQueryForCount(e,i.signal)}queryObjectIds(e,i={}){return this._queryEngine.executeQueryForIds(e,i.signal)}queryExtent(e,i={}){return this._queryEngine.executeQueryForExtent(e,i.signal)}querySnapping(e,i={}){return B(this._queryEngine,e,i.signal)}queryAttributeBins(e,i={}){return this._queryEngine.executeAttributeBinsQuery(e,i.signal)}_inferLayerProperties(e,i){let a,n,l=null,d=null,f=null;for(let p of e){let u=p.geometry;if(u!=null&&(l||(l=I(u)),d||(d=u.spatialReference),a==null&&(a=ie(u)),n==null&&(n=se(u)),l&&d&&a!=null&&n!=null))break}if(i&&i.length){let p=null;i.some(u=>{let m=u.type==="esriFieldTypeOID",y=!u.type&&u.name&&u.name.toLowerCase()==="objectid";return p=u,m||y})&&(f=p.name)}return{geometryType:l,spatialReference:d,objectIdField:f,hasM:n,hasZ:a}}async _loadInitialFeatures(e,i){let{geometryType:a,hasM:n,hasZ:l,objectIdField:d,spatialReference:f,featureStore:p,fieldsIndex:u}=this._queryEngine,m=[];for(let t of i){if(t.uid!=null&&(e.assignedObjectIds[t.uid]=-1),t.geometry&&a!==I(t.geometry)){e.featureErrors.push(g("Incorrect geometry type."));continue}let r=this._createDefaultAttributes(),c=_(u,r,t.attributes,!0);c?e.featureErrors.push(c):(this._assignObjectId(r,t.attributes,!0),t.attributes=r,t.uid!=null&&(e.assignedObjectIds[t.uid]=t.attributes[d]),t.geometry!=null&&(t.geometry=E(t.geometry,t.geometry.spatialReference,f)),m.push(t))}p.addMany(q([],m,a,l,n,d));let{fullExtent:y,timeExtent:o}=await this._queryEngine.fetchRecomputedExtents();if(e.layerDefinition.extent=y,o){let{start:t,end:r}=o;e.layerDefinition.timeInfo.timeExtent=[t,r]}return e}async _applyEdits(e){let{adds:i,updates:a,deletes:n}=e,l={addResults:[],deleteResults:[],updateResults:[],uidToObjectId:{}};if(i?.length&&this._applyAddEdits(l,i),a?.length&&this._applyUpdateEdits(l,a),n?.length){for(let p of n)l.deleteResults.push(T(p));this._queryEngine.featureStore.removeManyById(n)}let{fullExtent:d,timeExtent:f}=await this._queryEngine.fetchRecomputedExtents();return{extent:d,timeExtent:f,featureEditResults:l}}_applyAddEdits(e,i){let{addResults:a}=e,{geometryType:n,hasM:l,hasZ:d,objectIdField:f,spatialReference:p,featureStore:u,fieldsIndex:m}=this._queryEngine,y=[];for(let o of i){if(o.geometry&&n!==I(o.geometry)){a.push(g("Incorrect geometry type."));continue}let t=this._createDefaultAttributes(),r=_(m,t,o.attributes);if(r)a.push(r);else{if(this._assignObjectId(t,o.attributes),o.attributes=t,o.uid!=null){let c=o.attributes[f];e.uidToObjectId[o.uid]=c}if(o.geometry!=null){let c=o.geometry.spatialReference??p;o.geometry=E(O(o.geometry,c),c,p)}y.push(o),a.push(T(o.attributes[f]))}}u.addMany(q([],y,n,d,l,f))}_applyUpdateEdits({updateResults:e},i){let{geometryType:a,hasM:n,hasZ:l,objectIdField:d,spatialReference:f,featureStore:p,fieldsIndex:u}=this._queryEngine;for(let m of i){let{attributes:y,geometry:o}=m,t=y?.[d];if(t==null){e.push(g(`Identifier field ${d} missing`));continue}if(!p.has(t)){e.push(g(`Feature with object id ${t} missing`));continue}let r=k(p.getFeature(t),a,l,n);if(o!=null){if(a!==I(o)){e.push(g("Incorrect geometry type."));continue}let c=o.spatialReference??f;r.geometry=E(O(o,c),c,f)}if(y){let c=_(u,r.attributes,y);if(c){e.push(c);continue}}p.add(C(r,a,l,n,d)),e.push(T(t))}}_assignObjectId(e,i,a=!1){let n=this._queryEngine.objectIdField;a&&i&&isFinite(i[n])?e[n]=i[n]:e[n]=this._nextObjectId++}};export{V as default};
