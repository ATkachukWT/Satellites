import{d as p}from"./chunk-64QN2VGD.js";import{a as F}from"./chunk-4XZ6X7MQ.js";import{r as T,t as R}from"./chunk-UHRSAPGQ.js";import{a as E,b as P}from"./chunk-N2WTMF3X.js";var M=()=>T.getLogger("esri.support.arcadeOnDemand"),O=["geometry","scale","timeProperties"];function z(t,e){if(e!=null)for(let s of O)e.hasArcadeDependency(s)&&t.add(s);return t}var g;function V(){return g||(g=(async()=>{let t=await import("./chunk-3MQQ6K7E.js");return{arcade:t.arcade,arcadeUtils:t,Dictionary:t.Dictionary,Feature:t.arcadeFeature,Voxel:t.Voxel}})()),g}var B=(t,e,s)=>u.create(t,e,s,null,["$feature","$view"],[]),C=(t,e,s)=>u.create(t,e,s,null,["$feature","$view"],[]),H=(t,e,s,n)=>u.create(t,e,s,n,["$feature","$view"],[]),u=class t{constructor(e,s,n,d,f,c,i){this._dependencies=new Map,this.services=null,this.script=e,this.evaluate=d;let h=Array.isArray(c)?c:c?.fields;this.fields=h??[],this._syntaxTree=n,this._arcade=s,this._arcadeFeature=f,this._spatialReference=i,this._dependencies.set("geometry",s.scriptTouchesGeometry(this._syntaxTree)),this._dependencies.set("scale",this._arcade.referencesMember(this._syntaxTree,"scale")),this._dependencies.set("timeProperties",this._arcade.scriptUsesViewProperties(this._syntaxTree,["timeProperties"]))}static async create(e,s,n,d,f,c){let{arcade:i,Feature:h,Dictionary:w}=await V(),y=s instanceof F?s:F.fromJSON(s),a;try{a=i.parseScript(e,c)}catch(r){return M().error(new R("arcade-bad-expression","Failed to parse arcade script",{script:e,error:r})),null}let A=f.reduce((r,v)=>P(E({},r),{[v]:null}),{}),m=null;d!=null&&(m=new w(d),m.immutable=!0,A.$config=null);let D=i.scriptUsesGeometryEngine(a),j=D&&i.enableGeometrySupport(),G=i.scriptUsesFeatureSet(a)&&i.enableFeatureSetSupport(),b=i.scriptIsAsync(a),x=b&&i.enableAsyncSupport(),U={vars:A,spatialReference:y,useAsync:!!x};await Promise.all([j,G,x]);let k=new Set;await i.loadDependentModules(k,a,null,b,D);let o=new w;o.immutable=!1,o.setField("scale",0);let I=i.compileScript(a,U),L=(r,v)=>{let l=r.$view?.timeZone;if("$view"in r&&r.$view){let S;if(o.setField("scale",typeof r.$view=="object"&&"scale"in r.$view?r.$view.scale:void 0),typeof r.$view=="object"&&"timeProperties"in r.$view&&r.$view.timeProperties!=null){let{currentStart:$,currentEnd:_}=r.$view.timeProperties;S=new w({currentStart:$!=null?l!=null?p.epochToArcadeDate($,l):p.unknownEpochToArcadeDate($):void 0,currentEnd:_!=null?l!=null?p.epochToArcadeDate(_,l):p.unknownEpochToArcadeDate(_):void 0,startIncluded:!0,endIncluded:!0})}o.setField("timeProperties",S),r.$view=o}return m&&(r.$config=m),I({vars:r,spatialReference:y,services:v,timeZone:l})};return new t(e,i,a,L,new h,n,y)}repurposeFeature(e){return e.geometry&&!e.geometry.spatialReference&&(e.geometry.spatialReference=this._spatialReference),this._arcadeFeature.repurposeFromGraphicLikeObject(e.geometry,e.attributes,{fields:this.fields}),this._arcadeFeature}references(e){return this._dependencies.get(e)??!1}};export{z as a,V as b,B as c,C as d,H as e};
