import{a as U}from"./chunk-F7NFZM65.js";import{D as M}from"./chunk-2JKSIF4Q.js";import{c as O}from"./chunk-YQGS4EZO.js";import{a as L}from"./chunk-3REMXE4W.js";import{a as j}from"./chunk-PMVQ5DJK.js";import{b as x}from"./chunk-TBA3OZMJ.js";import{a as D}from"./chunk-JTDXB5TK.js";import{a as T,i as S}from"./chunk-MWSXMSWY.js";import{c as A}from"./chunk-YR2HD3ZC.js";import{a as E}from"./chunk-NMRTZBDM.js";import{H as i,J as k}from"./chunk-QHVIRF5H.js";import{I as v}from"./chunk-WZDN6K3C.js";import{a as o}from"./chunk-QGVBCWUY.js";import{E as q,O as N}from"./chunk-CKJ56T2Q.js";var P={anchor:"esri-widget__anchor",anchorDisabled:"esri-widget__anchor--disabled",button:"esri-button",buttonDisabled:"esri-button--disabled",buttonHalf:"esri-button--half",buttonSecondary:"esri-button--secondary",buttonSmall:"esri-button--small",buttonTertiary:"esri-button--tertiary",buttonThird:"esri-button--third",disabled:"esri-disabled",empty:"esri-widget__content--empty",emptyIllustration:"esri-widget__content-illustration--empty",heading:"esri-widget__heading",hidden:"esri-hidden",input:"esri-input",interactive:"esri-interactive",loader:"esri-widget__loader",loaderAnimation:"esri-widget__loader-animation",loaderText:"esri-widget__loader-text",menu:"esri-menu",menuHeader:"esri-menu__header",menuItem:"esri-menu__list-item",menuItemActive:"esri-menu__list-item--active",menuItemFocus:"esri-menu__list-item--focus",menuList:"esri-menu__list",panel:"esri-widget--panel",panelHeightOnly:"esri-widget--panel-height-only",primaryTick:"primary-tick",primaryTickAmPm:"primary-tick__ampm",primaryTickLabel:"primary-tick__label",rotating:"esri-rotating",secondaryTick:"secondary-tick",select:"esri-select",table:"esri-widget__table",widget:"esri-widget",widgetButton:"esri-widget--button",widgetButtonActive:"esri-widget--button-active",widgetDisabled:"esri-widget--disabled"};var f=class extends k{constructor(t){super(t),this.title=!0,this.description=!0}};o([i({type:Boolean,nonNullable:!0})],f.prototype,"title",void 0),o([i({type:Boolean,nonNullable:!0})],f.prototype,"description",void 0),f=o([v("esri.widgets.Feature.FeatureUtilityNetworkAssociations.VisibleElements")],f);var K=f;var I={fromGlobalId:"fromglobalid",fromNetworkSourceId:"fromnetworksourceid",fromTerminalId:"fromterminalid",toGlobalId:"toglobalid",toNetworkSourceId:"tonetworksourceid",toTerminalId:"toterminalid",associationType:"associationtype",globalId:"globalid",status:"status",isContentVisible:"iscontentvisible",percentAlong:"percentalong",assetGroup:"assetgroup",assetType:"assettype"};var $=100,r=class extends D.ClonableMixin(j.IdentifiableMixin(k)){constructor(t){super(t),this._loaded=!1,this._queryAbortController=null,this._queryPageAbortController=null,this._queryFeatureCountAbortController=null,this.networkSourceIdsInUse=new Set,this.source="popup",this.description=null,this.graphic=null,this.layer=null,this.map=null,this.featureCount=0,this.associationTypes=null,this.showAllEnabled=!1,this.title=null,this.attachmentsFeatureCount=0,this.structureFeatureCount=0,this.contentFeatureCount=0,this.containerFeatureCount=0,this.connectivityFeatureCount=0,this._queryOpenAssociationType=async()=>{this.activeAssociationType&&await this._queryDebounced(this.activeAssociationType)},this._cancelQuery=()=>{let{_queryAbortController:e}=this;e&&e.abort(),this._queryAbortController=null},this._cancelQueryFeatureCount=()=>{let{_queryFeatureCountAbortController:e}=this;e&&e.abort(),this._queryFeatureCountAbortController=null},this._queryController=async e=>{this._cancelQuery();let s=new AbortController;this._queryAbortController=s,await q(this._query(e)),this._queryAbortController===s&&(this._queryAbortController=null)},this._queryFeatureCountController=async()=>{this._loaded=!1,this._cancelQueryFeatureCount();let e=new AbortController;this._queryFeatureCountAbortController=e,await q(this._queryFeatureCount()),this._queryFeatureCountAbortController===e&&(this._queryFeatureCountAbortController=null),this._loaded=!0},this._queryDebounced=N(this._queryController,$),this._queryFeatureCountDebounced=N(this._queryFeatureCountController,$)}initialize(){this.addHandles([T(()=>[this.graphic,this.layer,this.map,this.associationTypes,this.objectId,this.globalId,this.canQuery],()=>this.refresh(),S),T(()=>this.activeAssociationType,t=>this._queryDebounced(t),S)])}destroy(){this._cancelQuery(),this._cancelQueryFeatureCount(),this._destroyAssociatedFeatureViewModels()}get supportsCacheHint(){return!!this.layer?.capabilities?.query?.supportsCacheHint}get canLoad(){return!!this.map&&!!this.associationTypes&&typeof this.globalId=="string"}get canQuery(){let t=this.layer?.capabilities?.query;return!!this.associationTypes&&typeof this.globalId=="string"&&!!t?.supportsPagination}set displayCount(t){this._set("displayCount",Math.max(t??3,0))}get displayCount(){return this._get("displayCount")}get objectId(){return(this.objectIdField&&this.graphic?.attributes?.[this.objectIdField])??null}get objectIdField(){return this.layer?.objectIdField||null}get globalId(){return(this.globalIdField&&this.graphic?.attributes?.[this.globalIdField])??null}get globalIdField(){let{layer:t}=this;return t?.globalIdField}get activeAssociationType(){return this._get("activeAssociationType")}set activeAssociationType(t){t&&!this.associationTypes.includes(t)||this._set("activeAssociationType",t)}get state(){let{_queryAbortController:t,_queryFeatureCountAbortController:e,_queryPageAbortController:s,canQuery:a,_loaded:l,canLoad:u,source:d}=this;return e||u&&!l?"loading":t||s?"querying":!a||d==="popup"&&this.featureCount===0?"disabled":"ready"}get utilityNetwork(){let{layer:t,map:e}=this;if(!t?.loaded||!e)return null;let s=O(t)?t.parent:t;return M(e,s)}get attachmentsAssociations(){return this._get("attachmentsAssociations")||new A}get structureAssociations(){return this._get("structureAssociations")||new A}get contentAssociations(){return this._get("contentAssociations")||new A}get containerAssociations(){return this._get("containerAssociations")||new A}get connectivityAssociations(){return this._get("connectivityAssociations")||new A}get associationFeatures(){return this._get("associationFeatures")||new E}get associationViewModels(){return this._get("associationViewModels")||new Map}async refresh(){await this._queryFeatureCountDebounced(),await this._queryOpenAssociationType()}getFeatureCountForAssociationType(t){switch(t){case"attachment":return this.attachmentsFeatureCount;case"structure":return this.structureFeatureCount;case"content":return this.contentFeatureCount;case"container":return this.containerFeatureCount;case"connectivity":return this.connectivityFeatureCount}}_destroyAssociatedFeatureViewModels(){this.associationViewModels.forEach(t=>t.destroyAll())}async _loadUtiltyNetworks(){let t=this.map;if(!t)return;await Promise.allSettled(t.utilityNetworks?.map(async s=>{await s.load()})??[]);let e=this.utilityNetwork;if(e){let s=a=>{if("layerId"in a&&e.isUtilityLayer(a)){let l=e.getSourceIdByLayerId(a.layerId);l!==null&&this.networkSourceIdsInUse.add(l)}};this._set("networkSourceIdsInUse",new Set),t.allLayers.forEach(s),t.allTables.forEach(s)}}async _findLayersBySourceId(t){let{utilityNetwork:e,map:s}=this,a=c=>{let _=c;return c.url&&_.layerId===l?c.url.replace(/\/\d+$/,"")===e?.featureServiceUrl:!1};await e?.load();let l=e.getLayerIdBySourceId(t),u=s.allLayers.filter(a),d=s.allTables.filter(a),h=u.concat(d).toArray();return await Promise.allSettled(h.map(c=>c.load())),h}_clearAssociations(){this.attachmentsAssociations.removeAll(),this.structureAssociations.removeAll(),this.contentAssociations.removeAll(),this.containerAssociations.removeAll(),this.connectivityAssociations.removeAll()}_clearFeatures(){this.associationFeatures.forEach(t=>t.removeAll()),this.associationFeatures.clear()}_getAssociationsByType(t){switch(t){case"attachment":return this.attachmentsAssociations;case"structure":return this.structureAssociations;case"connectivity":return this.connectivityAssociations;case"container":return this.containerAssociations;case"content":return this.contentAssociations}}async _queryLayer(t,e,s,a,l){let u=t.fieldsIndex.get(I.assetGroup),d=t.fieldsIndex.get(I.assetType),h=s!=null,c=a!=null,_="("+e.map(m=>`'${m}'`).join(", ")+")",p=h?` AND ${u?.name} = ${s}`:"",y=h&&c?` AND ${d?.name} = ${a}`:"",b=`${t.globalIdField} IN ${_}`+p+y,n=new x({outFields:["*"],cacheHint:this.supportsCacheHint,where:b});return await this._queryAll(n,t,{signal:l?.signal})}async _createAssociationFeatureObjects(t,e,s,a,l,u){if(t.length===0)return[];let d=new Map;for(let[c,_]of e){let p=await this._findLayersBySourceId(c);for(let y of p)(await this._queryLayer(y,_,a,l,u)).forEach(b=>{if(this.source==="popup"?b.layer&&b.getEffectivePopupTemplate():b.layer){let n=d.get(b.attributes[y.globalIdField])??[];n.push(b),d.set(b.attributes[y.globalIdField],n)}})}let h=[];return await Promise.all(t.toArray().map(async c=>{let{fromNetworkElement:_,toNetworkElement:p}=c,y=_.globalId===s?p:_,b=d.get(y.globalId)??[];await Promise.all(b.map(async n=>{let m=this.utilityNetwork?.getTerminalById(y?.terminalId)?.name;if(n.layer&&"getFeatureTitle"in n.layer){let g=await n.layer.getFeatureTitle(n);h.push({title:g,association:c,feature:n,terminalName:m})}else h.push({association:c,feature:n,terminalName:m})}))})),h}_parseFeatureObjects(t,e){t.forEach(s=>{let a=s?.feature,l=a.layer,u=e.get(l)??new A;u.add(s),e.set(l,u)})}async _queryAll(t,e,s){let a=[],l=0,u=!1;t.num=e.sourceJSON?.maxRecordCount??2e3;do{t.start=l;let d=await e.queryFeatures(t,s);a.push(...d.features),u=d.exceededTransferLimit,u&&(l+=d.features.length)}while(u);return a}async _queryAssociations(t){let{layer:e,globalId:s,associationTypes:a,utilityNetwork:l,canQuery:u}=this;if(await Promise.allSettled([e?.load(),l?.load()]),this._clearAssociations(),!(u&&e&&a&&l&&s))return;let d=O(e)?e.parent:e,h=new U({globalId:s,networkSourceId:l.getSourceIdByLayerId(d.layerId)}),c=new Set;a.forEach(n=>{switch(n.type){case"attachment":case"structure":c.add("attachment");break;case"container":case"content":c.add("containment");break;case"connectivity":c.add("connectivity"),c.add("junction-junction-connectivity"),c.add("junction-edge-from-connectivity"),c.add("junction-edge-midspan-connectivity"),c.add("junction-edge-to-connectivity")}});let _=await l?.queryAssociations({elements:[h],types:Array.from(c)},{signal:t?.signal}),p=new Map,y=new Map;a.forEach(n=>{y.set(n.type,n),p.set(n.type,[])}),_.forEach(n=>{let{toNetworkElement:m,fromNetworkElement:g}=n;switch(n.associationType){case"connectivity":case"junction-junction-connectivity":case"junction-edge-from-connectivity":case"junction-edge-midspan-connectivity":case"junction-edge-to-connectivity":if(g?.globalId===s){if(this._shouldDiscardNetworkElement(m,"connectivity",y))break;p.get("connectivity")?.push(m.globalId)}else{if(this._shouldDiscardNetworkElement(g,"connectivity",y))break;p.get("connectivity")?.push(g.globalId)}this.connectivityAssociations.add(n);break;case"containment":if(g?.globalId===s){if(this._shouldDiscardNetworkElement(m,"content",y))break;p.get("content")?.push(m.globalId),this.contentAssociations.add(n)}else{if(this._shouldDiscardNetworkElement(g,"container",y))break;p.get("container")?.push(g.globalId),this.containerAssociations.add(n)}break;case"attachment":if(g?.globalId===s){if(this._shouldDiscardNetworkElement(m,"attachment",y))break;p.get("attachment")?.push(m.globalId),this.attachmentsAssociations.add(n)}else{if(this._shouldDiscardNetworkElement(g,"structure",y))break;p.get("structure")?.push(g.globalId),this.structureAssociations.add(n)}}});let b=a.map(async n=>{let{associatedNetworkSourceId:m,associatedAssetGroup:g,associatedAssetType:C}=n,F=p.get(n.type),w=g!=null?await this._countAssociatedFeatures(m,F,g,C,t):F.length;switch(n.type){case"attachment":this._set("attachmentsFeatureCount",w);break;case"structure":this._set("structureFeatureCount",w);break;case"content":this._set("contentFeatureCount",w);break;case"container":this._set("containerFeatureCount",w);break;case"connectivity":this._set("connectivityFeatureCount",w)}});await Promise.allSettled(b)}async _countAssociatedFeatureCount(t,e,s,a,l){let u=t.fieldsIndex.get(I.assetGroup),d=t.fieldsIndex.get(I.assetType),h=a!=null,c="("+e.map(b=>`'${b}'`).join(", ")+")",_=` AND ${u?.name} = ${s}`,p=h?` AND ${d?.name} = ${a}`:"",y=`${t.globalIdField} IN ${c}`+_+p;return t.queryFeatureCount({where:y,outFields:["*"],returnGeometry:!1},{signal:l?.signal})}async _countAssociatedFeatures(t,e,s,a,l){if(e.length===0)return 0;let u=(await this._findLayersBySourceId(t)).map(async d=>this._countAssociatedFeatureCount(d,e,s,a,l));return(await Promise.all(u)).reduce((d,h)=>d+h,0)}async _queryAssociatedFeatures(t,e){let{layer:s,globalId:a,associationTypes:l,utilityNetwork:u,canQuery:d,associationFeatures:h}=this;if(await Promise.allSettled([s?.load(),u?.load()]),!(d&&s&&l&&u))return;let c=this._getAssociationsByType(t.type),{associatedAssetGroup:_,associatedAssetType:p}=t,y=new Map;c.forEach(n=>{let{fromNetworkElement:m,toNetworkElement:g}=n,{networkSourceId:C,elementGlobalId:F}=m.globalId===a?{networkSourceId:g.networkSourceId,elementGlobalId:g.globalId}:{networkSourceId:m.networkSourceId,elementGlobalId:m.globalId},w=y.get(C)||[];w.push(F),y.set(C,w)});let b=await this._createAssociationFeatureObjects(c,y,a,_,p,e);this._parseFeatureObjects(b,h)}async _queryFeatureCount(){await this._loadUtiltyNetworks();let{_queryFeatureCountAbortController:t,canQuery:e}=this;e?(await this._queryAssociations(t),this._set("featureCount",this.attachmentsFeatureCount+this.structureFeatureCount+this.contentFeatureCount+this.containerFeatureCount+this.connectivityFeatureCount)):this._set("featureCount",0)}async _query(t){if(!t)return;await this._loadUtiltyNetworks();let{_queryAbortController:e}=this;this._destroyAssociatedFeatureViewModels(),this._clearFeatures(),this.featureCount!==0&&(this.destroyed||await this._queryAssociatedFeatures(t,{signal:e?.signal}))}_shouldDiscardNetworkElement(t,e,s){if(!t)return!1;let{networkSourceIdsInUse:a}=this,{networkSourceId:l}=t,u=s.get(e)?.associatedNetworkSourceId,d=a.has(l);return u!=null&&u!==l||!d}};o([i()],r.prototype,"_loaded",void 0),o([i()],r.prototype,"_queryAbortController",void 0),o([i()],r.prototype,"_queryPageAbortController",void 0),o([i()],r.prototype,"_queryFeatureCountAbortController",void 0),o([i({readOnly:!0})],r.prototype,"supportsCacheHint",null),o([i({readOnly:!0})],r.prototype,"canLoad",null),o([i({readOnly:!0})],r.prototype,"canQuery",null),o([i()],r.prototype,"networkSourceIdsInUse",void 0),o([i({constructOnly:!0})],r.prototype,"source",void 0),o([i()],r.prototype,"description",void 0),o([i({value:3})],r.prototype,"displayCount",null),o([i({type:L})],r.prototype,"graphic",void 0),o([i()],r.prototype,"layer",void 0),o([i()],r.prototype,"map",void 0),o([i({readOnly:!0})],r.prototype,"objectId",null),o([i({readOnly:!0})],r.prototype,"objectIdField",null),o([i({readOnly:!0})],r.prototype,"globalId",null),o([i({readOnly:!0})],r.prototype,"globalIdField",null),o([i()],r.prototype,"featureCount",void 0),o([i()],r.prototype,"associationTypes",void 0),o([i()],r.prototype,"activeAssociationType",null),o([i()],r.prototype,"showAllEnabled",void 0),o([i()],r.prototype,"state",null),o([i()],r.prototype,"title",void 0),o([i({readOnly:!0})],r.prototype,"utilityNetwork",null),o([i({readOnly:!0})],r.prototype,"attachmentsFeatureCount",void 0),o([i({readOnly:!0})],r.prototype,"structureFeatureCount",void 0),o([i({readOnly:!0})],r.prototype,"attachmentsAssociations",null),o([i({readOnly:!0})],r.prototype,"structureAssociations",null),o([i({readOnly:!0})],r.prototype,"contentFeatureCount",void 0),o([i({readOnly:!0})],r.prototype,"containerFeatureCount",void 0),o([i({readOnly:!0})],r.prototype,"contentAssociations",null),o([i({readOnly:!0})],r.prototype,"containerAssociations",null),o([i({readOnly:!0})],r.prototype,"connectivityFeatureCount",void 0),o([i({readOnly:!0})],r.prototype,"connectivityAssociations",null),o([i({readOnly:!0})],r.prototype,"associationFeatures",null),o([i({readOnly:!0})],r.prototype,"associationViewModels",null),r=o([v("esri.widgets.support.UtilityNetworkAssociations.FeatureUtilityNetworkAssociationsViewModel")],r);var _t=r;export{P as a,K as b,_t as c};
