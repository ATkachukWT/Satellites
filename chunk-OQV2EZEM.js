import{m as q}from"./chunk-2IZGBHXN.js";import{b as B}from"./chunk-UCE3Z44N.js";import{w as j}from"./chunk-2XYAAYOE.js";import{d as L}from"./chunk-PM3EZWDJ.js";import{a as F}from"./chunk-NFXNGFHZ.js";import{d as k,f as w}from"./chunk-KRAKR4MK.js";import{a as D}from"./chunk-MWSXMSWY.js";import{H as x,J as R}from"./chunk-QHVIRF5H.js";import{I as U}from"./chunk-WZDN6K3C.js";import{a as m}from"./chunk-QGVBCWUY.js";import{E as G,O as T,d as S,e as y}from"./chunk-CKJ56T2Q.js";import{a as g,b as v}from"./chunk-N2WTMF3X.js";function mt({predicate:t=()=>!0,snappingManager:n,snappingContext:o,updatingHandles:i,useZ:e=!0}){let s=new q;if(n==null)return{snappingStep:[J,s],cancelSnapping:J};let r,u=null,a=null,c=null,d=()=>{u=y(u),n.doneSnapping(),a?.frameTask.remove(),a=null,r=S(r),c=null},_=tt(n,e,s),f=null,p=null,M=null;return{snappingStep:[l=>{if(!t(l))return l;let{action:C}=l;if(C==="start"){let{info:b}=l,Z=nt(n.view);if(a=et(o,l,Z),a.context.selfSnappingZ=null,!e&&b!=null){let P=it(o.coordinateHelper,b.handle.component);P!=null&&(a.context.selfSnappingZ={value:P,elevationInfo:o.elevationInfo??j})}}if(a!=null){let{context:b,originalScenePos:Z,originalPos:P}=a,{mapEnd:O,mapStart:A,scenePoints:V}=l,I=K(P,E(O,A)),H=E(A,P),W=v(g({},l),{action:"update"}),X=a.context,z=ot(Z,V),N=n.update({point:I,scenePoint:z,context:b});if(M=N,Q(O,N,H,e),f=I,p=z,C!=="end"){let{frameTask:Y}=a;u==null&&(u=new AbortController),c=$=>{i.addPromise(G(_({frameTask:Y,event:W,context:X,point:I,scenePoint:z,delta:H,getLastState:()=>({point:f,scenePoint:p,updatePoint:$.forceUpdate?null:M})},u.signal)))},c({forceUpdate:!1}),r==null&&(r=D(()=>n.options.effectiveEnabled,()=>c?.({forceUpdate:!0})))}}return C==="end"&&d(),l},s],cancelSnapping:l=>(d(),l)}}function tt(t,n,o){return T(async({frameTask:i,point:e,scenePoint:s,context:r,event:u,delta:a,getLastState:c},d)=>{let _=await i.schedule(()=>t.snap({point:e,scenePoint:s,context:r,signal:d}),d);if(_.valid){let f=await i.schedule(()=>_.apply(),d),p=c();p.point!=null&&e!==p.point&&(f=t.update({point:p.point,scenePoint:p.scenePoint,context:r})),p.updatePoint!=null&&F(f,p.updatePoint)||(Q(u.mapEnd,f,a,n),o.execute(u))}})}function nt(t){return t.type==="3d"?t.resourceController.scheduler.registerTask(k.SNAPPING):w}function et(t,n,o){return{context:new B({editGeometryOperations:t.editGeometryOperations,elevationInfo:t.elevationInfo,pointer:t.pointer,vertexHandle:n.info!=null?n.info.handle:null,excludeFeature:t.excludeFeature,feature:t.feature,visualizer:t.visualizer}),originalPos:n.snapOrigin!=null?t.coordinateHelper.vectorToDehydratedPoint(n.snapOrigin):n.mapStart,originalScenePos:n.scenePoints!=null?n.scenePoints.sceneStart:null,frameTask:o}}function K(t,[n,o,i]){let e=L(t);return e.x+=n,e.y+=o,e.hasZ&&(e.z+=i),e}function ot(t,n){return t==null||n==null?null:K(t,E(n.sceneEnd,n.sceneStart))}function E(t,n){let o=t.hasZ&&n.hasZ?t.z-n.z:0;return[t.x-n.x,t.y-n.y,o]}function Q(t,n,[o,i,e],s){t.x=n.x+o,t.y=n.y+i,s&&t.hasZ&&n.hasZ&&(t.z=n.z+e)}function it(t,n){if(!t.hasZ())return null;let o=n.vertices,i=null;for(let e of o){let s=t.getZ(e.pos);if(i!=null&&s!=null&&Math.abs(s-i)>1e-6)return null;i==null&&(i=s)}return i}function J(t){return t}var h=class extends R{constructor(t){super(t),this.constrainResult=n=>n,this._snapPoints=null,this._frameTask=null,this._abortController=null,this._stagedPoint=null,this._snap=T(async(n,o,i,e)=>{let s=this._frameTask;if(s==null)return;let r=await s.schedule(()=>o.snap(v(g({},n),{context:i,signal:e})),e);r.valid&&await s.schedule(()=>{this.stagedPoint=r.apply(),n!==this._snapPoints&&this._snapPoints!=null&&(this.stagedPoint=o.update(v(g({},this._snapPoints),{context:i})))},e)})}get stagedPoint(){return this._stagedPoint}set stagedPoint(t){this._stagedPoint=this.constrainResult(t)}initialize(){let t=this.view.type==="3d"?this.view?.resourceController?.scheduler:null;this._frameTask=t!=null?t.registerTask(k.SNAPPING):w}destroy(){this._abortController=y(this._abortController),this._frameTask=S(this._frameTask)}update(t,n,o){this._snapPoints=t;let{point:i,scenePoint:e}=t,s=n.update({point:i,scenePoint:e,context:o});return this.stagedPoint=s,s}async snap(t,n,o){let{point:i,scenePoint:e}=t;return this.stagedPoint=n.update({point:i,scenePoint:e,context:o}),this._snapPoints=t,this._abortController==null&&(this._abortController=new AbortController),this._snap(t,n,o,this._abortController.signal)}async snapAgainNearPreviousMapPoint(t,n){this._snapPoints!=null&&await this.snap(this._snapPoints,t,n)}abort(){this._abortController=y(this._abortController),this._snapPoints=null}};m([x({constructOnly:!0})],h.prototype,"view",void 0),m([x()],h.prototype,"stagedPoint",null),m([x()],h.prototype,"constrainResult",void 0),m([x()],h.prototype,"_stagedPoint",void 0),h=m([U("esri.views.interactive.snapping.SnappingOperation")],h);export{mt as a,h as b};
