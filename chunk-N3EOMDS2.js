import{a as V}from"./chunk-EGWWS4LL.js";import{a as O}from"./chunk-VEK547EU.js";import{b as I}from"./chunk-6CUAH7AI.js";import"./chunk-OC2XJJQU.js";import"./chunk-54HXR2K7.js";import"./chunk-T4QAGZWF.js";import{e as S}from"./chunk-7BXTHPPE.js";import"./chunk-Q5KIWWVU.js";import"./chunk-KK722UJA.js";import"./chunk-C27Q2S3P.js";import"./chunk-HF2RT2F4.js";import"./chunk-LIECELJH.js";import"./chunk-36MVAC23.js";import"./chunk-ZFRNSCYG.js";import"./chunk-UWWX7VSW.js";import"./chunk-CFF33S4D.js";import"./chunk-2XYAAYOE.js";import{a as E}from"./chunk-BSSTF6JG.js";import"./chunk-NIYDRLW4.js";import{h as L}from"./chunk-CAXK5KYB.js";import"./chunk-3CCK7BDD.js";import"./chunk-LNYBTIG7.js";import"./chunk-NNX76JDG.js";import"./chunk-76O2P2CB.js";import"./chunk-AOQ57NDM.js";import"./chunk-VMECOA4F.js";import"./chunk-JPMGMA4B.js";import"./chunk-DJW5LMRG.js";import"./chunk-ALWV3RJ2.js";import"./chunk-DEH76MSI.js";import{a as C}from"./chunk-DVBZA6ZU.js";import"./chunk-VTGWQ7AP.js";import"./chunk-TBA3OZMJ.js";import"./chunk-S4QV2MGO.js";import"./chunk-USMAJP2P.js";import"./chunk-PHNFWHVF.js";import"./chunk-4N5OXIEM.js";import"./chunk-W26XKMAT.js";import"./chunk-NQWYPF77.js";import"./chunk-JTDXB5TK.js";import"./chunk-CWUY5SXW.js";import"./chunk-GWBRHLNH.js";import"./chunk-QCRXBE6I.js";import"./chunk-G7TP3ZYQ.js";import"./chunk-SBVUMOLF.js";import"./chunk-Y6YEAKJ5.js";import"./chunk-S52JRLJC.js";import"./chunk-U4TLMQTY.js";import"./chunk-PDQQY7RQ.js";import"./chunk-W5OI4BJ2.js";import"./chunk-RWCIDBNQ.js";import"./chunk-2NH7HOKA.js";import"./chunk-HM5RIVQC.js";import"./chunk-EM35R6FY.js";import"./chunk-2ZFXOJDB.js";import"./chunk-QXXXCEV5.js";import"./chunk-6B5XFA6F.js";import"./chunk-NHEQ4TAR.js";import"./chunk-AFC2H4Q3.js";import"./chunk-ZTOZWLEE.js";import"./chunk-NRBJLISB.js";import"./chunk-PTZYZULI.js";import"./chunk-NMLYCCKN.js";import"./chunk-RSDQHAJX.js";import{a as f}from"./chunk-BOVYXYHK.js";import"./chunk-FENRIY2T.js";import"./chunk-JGEVVXD4.js";import"./chunk-B3FO6PT7.js";import"./chunk-C4UMJHQC.js";import"./chunk-BCREO4Q5.js";import"./chunk-LXFQWIWE.js";import"./chunk-QT6UNBJP.js";import"./chunk-V2GNNIXD.js";import"./chunk-NSYL2RQJ.js";import"./chunk-MWSXMSWY.js";import"./chunk-JRCKELO6.js";import"./chunk-ZVCMULXF.js";import"./chunk-KJULKTB5.js";import"./chunk-LACL4BQ2.js";import"./chunk-YR2HD3ZC.js";import"./chunk-GJASVPF6.js";import"./chunk-UBFCO3DV.js";import"./chunk-NI7FJV5X.js";import"./chunk-BUSG3ZOF.js";import"./chunk-XZIOXVVJ.js";import"./chunk-LFH24RLM.js";import"./chunk-Z5Q7KLA4.js";import"./chunk-X4LNX4BR.js";import"./chunk-4XZ6X7MQ.js";import"./chunk-WLHY3MMA.js";import"./chunk-KGVXGH6H.js";import"./chunk-ARRCN5K3.js";import"./chunk-FTDD7QBB.js";import"./chunk-DB3UIQCU.js";import"./chunk-SBHKMV3P.js";import"./chunk-R4A63S45.js";import"./chunk-ETE32IYO.js";import"./chunk-ONUGDWDK.js";import"./chunk-SG7CQU4O.js";import{H as i,J as l}from"./chunk-QHVIRF5H.js";import{I as p}from"./chunk-WZDN6K3C.js";import{a as o}from"./chunk-QGVBCWUY.js";import"./chunk-OJQ73TPF.js";import"./chunk-354SCPDU.js";import"./chunk-OVHPPCBL.js";import"./chunk-IYZFKXJ6.js";import{d as v,e as b,p as g,v as k,x as H}from"./chunk-CKJ56T2Q.js";import"./chunk-SNFOAZZQ.js";import"./chunk-F6JAWRPN.js";import"./chunk-UHRSAPGQ.js";import{w}from"./chunk-V76GWARL.js";import"./chunk-N2WTMF3X.js";var d=class extends l{constructor(e){super(e),this.availability=0,this._ids=new Set}destroy(){this._workerHandle.destroy(),this._workerHandle=null}initialize(){this._workerHandle=new _(this.schedule,{fetchAllEdgeLocations:(e,r)=>this._fetchAllEdgeLocations(e,r)})}async fetchCandidates(e,r){let t=e.coordinateHelper,{point:s}=e,a=W;this.renderCoordsHelper.toRenderCoords(s,t.spatialReference,a);let h=e.distance,c=typeof h=="number"?h:h.distance,m=await this._workerHandle.invoke({bounds:L(a[0],a[1],a[2],c),returnEdge:e.returnEdge,returnVertex:e.vertexMode!=="none"},r);return m.candidates.sort((y,R)=>y.distance-R.distance),m.candidates.map(y=>this._convertCandidate(t,y))}async add(e,r){this._ids.add(e.id),await this._workerHandle.invokeMethod("add",e,r)}async remove(e,r){this._ids.delete(e.id),await this._workerHandle.invokeMethod("remove",e,r)}_convertCandidate(e,r){switch(r.type){case"edge":return new I({objectId:r.objectId,targetPoint:S(this._convertRenderCoordinate(e,r.target)),edgeStart:this._convertRenderCoordinate(e,r.start),edgeEnd:this._convertRenderCoordinate(e,r.end),isDraped:!1});case"vertex":return new O({objectId:r.objectId,targetPoint:S(this._convertRenderCoordinate(e,r.target)),isDraped:!1})}}_convertRenderCoordinate({spatialReference:e},r){let t=f();return this.renderCoordsHelper.fromRenderCoords(r,t,e),t}async _fetchAllEdgeLocations(e,r){let t=[],s=[];for(let{id:a,uid:h}of e.components)this._ids.has(a)&&t.push((async()=>{let c=await this.fetchEdgeLocations(a,r.signal),m=c.locations.buffer;return s.push(m),{id:a,uid:h,objectIds:c.objectIds,locations:m,origin:c.origin,type:c.type}})());return{result:{components:(await Promise.all(t)).filter(({id:a})=>this._ids.has(a))},transferList:s}}};o([i({constructOnly:!0})],d.prototype,"renderCoordsHelper",void 0),o([i({constructOnly:!0})],d.prototype,"fetchEdgeLocations",void 0),o([i({constructOnly:!0})],d.prototype,"schedule",void 0),o([i({readOnly:!0})],d.prototype,"availability",void 0),d=o([p("esri.views.interactive.snapping.featureSources.sceneLayerSource.SceneLayerSnappingSourceWorkerHandle")],d);var _=class extends E{constructor(r,t){super("SceneLayerSnappingSourceWorker","fetchCandidates",{},r,{strategy:"dedicated",client:t})}},W=f();var n=class extends l{get updating(){return this._updatingHandles.updating}constructor(e){super(e),this.availability=1,this._updatingHandles=new C,this._abortController=new AbortController}destroy(){this._tracker=v(this._tracker),this._abortController=b(this._abortController),this._updatingHandles.destroy()}initialize(){let{view:e}=this,r=e.resourceController;this._edgeWorker=new V(x(r)),this._workerHandle=new d({renderCoordsHelper:this.view.renderCoordsHelper,schedule:x(r),fetchEdgeLocations:async(t,s)=>{if(this._tracker==null)throw new Error("tracker-not-initialized");return this._tracker.fetchEdgeLocations(t,this._edgeWorker,s)}}),this._updatingHandles.addPromise(this._setupLayerView()),this.addHandles([g(this._workerHandle),g(this._edgeWorker)])}async fetchCandidates(e,r){return this._workerHandle.fetchCandidates(e,r)}refresh(){}async _setupLayerView(){if(this.destroyed)return;let e=this._abortController?.signal,r=await this.getLayerView();r==null||H(e)||(this._tracker=r.trackSnappingSources({add:(t,s)=>{this._updatingHandles.addPromise(this._workerHandle.add({id:t,bounds:s},e))},remove:t=>{this._updatingHandles.addPromise(this._workerHandle.remove({id:t},e))}}))}};function x(e){return r=>e.immediate.schedule(r)}o([i({constructOnly:!0})],n.prototype,"getLayerView",void 0),o([i({constructOnly:!0})],n.prototype,"view",void 0),o([i({readOnly:!0})],n.prototype,"updating",null),o([i({readOnly:!0})],n.prototype,"availability",void 0),n=o([p("esri.views.interactive.snapping.featureSources.I3SSnappingSource")],n);var u=class extends l{get updating(){return this._i3sSources.some(e=>e.updating)}constructor(e){super(e),this.availability=1,this._i3sSources=[]}destroy(){this._i3sSources.forEach(e=>e.destroy()),this._i3sSources.length=0}initialize(){let{view:e}=this,r=this.layerSource.layer;this._i3sSources=r.type==="building-scene"?this._getBuildingSceneI3SSources(e,r):[this._getSceneLayerI3SSource(e,r)]}async fetchCandidates(e,r){let t=await Promise.all(this._i3sSources.map(s=>s.fetchCandidates(e,r)));return k(r),t.flat()}refresh(){this._i3sSources.forEach(e=>e.refresh())}_getBuildingSceneI3SSources(e,r){return r.allSublayers.toArray().map(t=>t.type==="building-component"?new n({getLayerView:async()=>(await e.whenLayerView(r)).whenSublayerView(t),view:e}):null).filter(w)}_getSceneLayerI3SSource(e,r){return new n({getLayerView:async()=>{let t=await e.whenLayerView(r);return t.type==="scene-layer-graphics-3d"?void 0:t},view:e})}};o([i({constructOnly:!0})],u.prototype,"layerSource",void 0),o([i({constructOnly:!0})],u.prototype,"view",void 0),o([i({readOnly:!0})],u.prototype,"updating",null),o([i({readOnly:!0})],u.prototype,"availability",void 0),u=o([p("esri.views.interactive.snapping.featureSources.SceneLayerSnappingSource")],u);export{u as SceneLayerSnappingSource};
