import{a as ht,b as yt,c as gt,d as _t}from"./chunk-55A3JRI3.js";import{b as pt}from"./chunk-RJZWYGCE.js";import{a as ct}from"./chunk-2U44WK2Y.js";import{a as nt}from"./chunk-JUMM5VTE.js";import{a as p,b as M,c as U,d as $,e as E,f as P,g as F,h as ue,i as q,k as Ke,l as Qe}from"./chunk-U3SOQMWO.js";import{a as dt,b as ut,c as fe,f as vt}from"./chunk-KDKEWJOG.js";import"./chunk-KYSTRHK2.js";import"./chunk-JNLUD3YZ.js";import{a as bt,b as wt}from"./chunk-W5TVDNWG.js";import{b as ft}from"./chunk-IPMZUQ2D.js";import"./chunk-NPWEUFES.js";import{a as mt}from"./chunk-26JWDTE3.js";import"./chunk-GPDZGV7G.js";import"./chunk-XCJ4FRLL.js";import"./chunk-53FQLWMN.js";import"./chunk-PGFEC2N6.js";import"./chunk-5KY2RG7F.js";import"./chunk-XQ4DD6H6.js";import"./chunk-IQA3CVAZ.js";import{c as lt}from"./chunk-2DH3L3DZ.js";import"./chunk-N3W77OHB.js";import{e as ot}from"./chunk-OWV7FEAY.js";import{v as pe}from"./chunk-2XYAAYOE.js";import{c as rt}from"./chunk-3TRID6QS.js";import"./chunk-KE2U7ENE.js";import{a as Ze,b as et}from"./chunk-GI4NW5SA.js";import"./chunk-T5NHE3SD.js";import{a as it,r as at}from"./chunk-YNDA4ZZB.js";import"./chunk-JAN3FVXP.js";import"./chunk-F4HA2HQL.js";import{b as st}from"./chunk-AEU2INWT.js";import"./chunk-Z4UBZ6W2.js";import"./chunk-CMKJEBQJ.js";import"./chunk-3J3Q4LMA.js";import"./chunk-PSNQ2KG3.js";import"./chunk-H6LI7TZP.js";import"./chunk-2IWALBQY.js";import"./chunk-YQHQQW4I.js";import"./chunk-7V6BRQYE.js";import"./chunk-IZU6TNEP.js";import"./chunk-DNN7JJKY.js";import"./chunk-Y7XG5IWW.js";import"./chunk-X5NPIY3C.js";import"./chunk-JXRFF2VE.js";import"./chunk-7WCQBAQY.js";import"./chunk-V4ZQZTCB.js";import"./chunk-PEYNLMWW.js";import"./chunk-FQIIIJGL.js";import"./chunk-SZTSN5BD.js";import"./chunk-VAOSSSLB.js";import"./chunk-6L543SC5.js";import"./chunk-CUV3BSEW.js";import"./chunk-ZCAR53EN.js";import"./chunk-DH67ILIV.js";import"./chunk-7GUYYJRR.js";import{a as he}from"./chunk-WS4AMEGN.js";import"./chunk-CU7FHMWW.js";import"./chunk-CSFAHB4Y.js";import"./chunk-NRRX2M6N.js";import"./chunk-PMLKCTEJ.js";import"./chunk-MYO2G5ZH.js";import"./chunk-MTUYS77G.js";import"./chunk-EG2DTURK.js";import"./chunk-57FV5BVL.js";import"./chunk-YVCKQBWT.js";import"./chunk-4XEE5PE3.js";import"./chunk-O2J7LFYY.js";import"./chunk-YU3IFRYW.js";import"./chunk-XKFJ6GWH.js";import"./chunk-GSXOR3JU.js";import"./chunk-55OTJIMU.js";import"./chunk-EM2AEAFS.js";import{a as tt}from"./chunk-VGAXEXH3.js";import"./chunk-YEPHAEAY.js";import"./chunk-76X7RFM4.js";import"./chunk-GWSX6PRO.js";import"./chunk-ELCBU4NP.js";import"./chunk-GMZFCQJQ.js";import"./chunk-5WDH2LXO.js";import"./chunk-L7NOU4T2.js";import"./chunk-SU7IJ65K.js";import"./chunk-WOZSH7YY.js";import"./chunk-2PJRHNJW.js";import"./chunk-B2RVSTL3.js";import"./chunk-2CKJLDTO.js";import"./chunk-F6TN7E7K.js";import"./chunk-HUUJBVXR.js";import"./chunk-4LDVFWME.js";import"./chunk-A45BLB26.js";import"./chunk-YSD7LK2L.js";import{a as Ye}from"./chunk-CTVZOIWY.js";import"./chunk-TMY7UIU7.js";import{d as Xe}from"./chunk-BPX3YT3K.js";import{a as Je}from"./chunk-LXEWGICX.js";import"./chunk-NIYDRLW4.js";import"./chunk-4K47EN3B.js";import"./chunk-FGY3YBPM.js";import"./chunk-EDOVNTC7.js";import"./chunk-FSWSNKJD.js";import"./chunk-MVDZB4AK.js";import"./chunk-ESSDCWGF.js";import"./chunk-WVKBXQWE.js";import"./chunk-FGEB67EG.js";import"./chunk-YEXMIDOT.js";import"./chunk-GV3ZFCVD.js";import"./chunk-SOEEM7Z7.js";import"./chunk-T7PUQGWM.js";import"./chunk-44A27HB7.js";import"./chunk-47NSYSFY.js";import"./chunk-QXNVQZT7.js";import"./chunk-CAXK5KYB.js";import"./chunk-3CCK7BDD.js";import"./chunk-LNYBTIG7.js";import"./chunk-VYZHOYXV.js";import"./chunk-K7YQAHQ7.js";import"./chunk-XAHD7XBV.js";import{a as $e,b as qe}from"./chunk-J6YGDWJF.js";import{b as S}from"./chunk-YQNUGDFH.js";import{a as ze}from"./chunk-QCZ3ZIGQ.js";import"./chunk-KBDKZSTB.js";import{a as x,g as I,h as z}from"./chunk-ONYJLWAD.js";import"./chunk-VMECOA4F.js";import"./chunk-KOUNUVF6.js";import"./chunk-PHODKV66.js";import{c as We}from"./chunk-JPMGMA4B.js";import{a as Ne}from"./chunk-3REMXE4W.js";import"./chunk-4ABKPPKG.js";import"./chunk-PMVQ5DJK.js";import"./chunk-I4Q2S2XA.js";import"./chunk-V774RJYN.js";import"./chunk-L2WNUKLP.js";import"./chunk-XITT4JU2.js";import"./chunk-ZBX6HJOS.js";import"./chunk-BSMAMABT.js";import"./chunk-LYNAYPL3.js";import"./chunk-ULANM5YP.js";import"./chunk-KAMRW6HF.js";import"./chunk-6DGDLLNL.js";import"./chunk-UWWWQ44M.js";import{b as Ge}from"./chunk-BHB4UQZT.js";import{a as je,e as ke}from"./chunk-DJW5LMRG.js";import{a as de}from"./chunk-ALWV3RJ2.js";import{a as me,d as W}from"./chunk-DEH76MSI.js";import"./chunk-DVBZA6ZU.js";import"./chunk-VTGWQ7AP.js";import"./chunk-PHNFWHVF.js";import"./chunk-NQWYPF77.js";import"./chunk-JTDXB5TK.js";import"./chunk-KD27XIJC.js";import"./chunk-TPFJWNIU.js";import"./chunk-P25RU3X5.js";import"./chunk-XRRQM4E2.js";import"./chunk-GWBRHLNH.js";import{c as He}from"./chunk-QCRXBE6I.js";import"./chunk-G7TP3ZYQ.js";import"./chunk-U4TLMQTY.js";import"./chunk-PDQQY7RQ.js";import{a as L}from"./chunk-RWCIDBNQ.js";import"./chunk-2NH7HOKA.js";import{b as ce,l as v}from"./chunk-HM5RIVQC.js";import"./chunk-EM35R6FY.js";import{C as Be,b as Ae,c as N,d as De,o as Le,p as Se,q as ne,s as Fe,t as Re,u as le}from"./chunk-2ZFXOJDB.js";import"./chunk-QXXXCEV5.js";import{d as Ie,z as Ue}from"./chunk-6B5XFA6F.js";import"./chunk-HP4LYRR4.js";import"./chunk-AFC2H4Q3.js";import"./chunk-OLOKUDVI.js";import"./chunk-4G7UTTZJ.js";import{h as Ee,t as Oe}from"./chunk-ZTOZWLEE.js";import"./chunk-RJWOVI3M.js";import"./chunk-NRBJLISB.js";import{c as Ve}from"./chunk-PTZYZULI.js";import"./chunk-NMLYCCKN.js";import"./chunk-RSDQHAJX.js";import{a as G,e as Pe}from"./chunk-BOVYXYHK.js";import"./chunk-FENRIY2T.js";import"./chunk-HX2VGIR2.js";import"./chunk-64QN2VGD.js";import"./chunk-JGEVVXD4.js";import"./chunk-B3FO6PT7.js";import"./chunk-C4UMJHQC.js";import"./chunk-BCREO4Q5.js";import"./chunk-LXFQWIWE.js";import"./chunk-QT6UNBJP.js";import{a as oe,i as Ce}from"./chunk-MWSXMSWY.js";import"./chunk-JRCKELO6.js";import"./chunk-KJULKTB5.js";import"./chunk-LACL4BQ2.js";import"./chunk-YR2HD3ZC.js";import"./chunk-GJASVPF6.js";import"./chunk-UBFCO3DV.js";import"./chunk-BUSG3ZOF.js";import"./chunk-XZIOXVVJ.js";import"./chunk-EXJYW3PC.js";import"./chunk-SXQPBCOX.js";import"./chunk-LFH24RLM.js";import"./chunk-Z5Q7KLA4.js";import"./chunk-X4LNX4BR.js";import"./chunk-4XZ6X7MQ.js";import"./chunk-WLHY3MMA.js";import{F as xe}from"./chunk-KGVXGH6H.js";import"./chunk-ARRCN5K3.js";import"./chunk-LXQPIAN7.js";import"./chunk-FTDD7QBB.js";import"./chunk-DB3UIQCU.js";import"./chunk-SBHKMV3P.js";import"./chunk-R4A63S45.js";import"./chunk-ETE32IYO.js";import"./chunk-ONUGDWDK.js";import"./chunk-SG7CQU4O.js";import{H as D}from"./chunk-QHVIRF5H.js";import{I as Me}from"./chunk-WZDN6K3C.js";import{a as V}from"./chunk-QGVBCWUY.js";import{b as Te}from"./chunk-OJQ73TPF.js";import"./chunk-354SCPDU.js";import"./chunk-OVHPPCBL.js";import"./chunk-IYZFKXJ6.js";import{b as ae}from"./chunk-CKJ56T2Q.js";import"./chunk-SNFOAZZQ.js";import"./chunk-F6JAWRPN.js";import{r as ie,t as k}from"./chunk-UHRSAPGQ.js";import{a as se}from"./chunk-V76GWARL.js";import"./chunk-N2WTMF3X.js";var J=class extends mt{constructor(e,d,i,o,n,u,l){super(e,0,0,0,d),this.nodesCached=i,this.vboMB=o,this.textureMB=n,this.vboMBCached=u,this.textureMBCached=l}};var Tt={[E.Points]:null,[E.Lines]:null,[E.LineStrip]:null,[E.Triangles]:ce.TRIANGLES,[E.TriangleStrip]:ce.TRIANGLE_STRIP,[E.NotSet]:null},ye={[$.Opaque]:I.Opaque,[$.Mask]:I.Mask,[$.Blend]:I.Blend},Mt={[F.Back]:x.Back,[F.Front]:x.Front,[F.None]:x.None,[F.NotSet]:x.Back},Ct={[P.WrapYBit]:{s:v.CLAMP_TO_EDGE,t:v.REPEAT},[P.WrapXBit]:{s:v.REPEAT,t:v.CLAMP_TO_EDGE},[P.WrapXy]:{s:v.REPEAT,t:v.REPEAT},[P.None]:{s:v.CLAMP_TO_EDGE,t:v.CLAMP_TO_EDGE},[P.NotSet]:{s:v.CLAMP_TO_EDGE,t:v.CLAMP_TO_EDGE}},xt={[p.U8]:1,[p.I8]:1,[p.U16]:2,[p.I16]:2,[p.U32]:4,[p.I32]:4,[p.F32]:4,[p.F64]:8,[p.Utf8String]:1,[p.NotSet]:1};var X=class{constructor(e){this.layerUid=[],this.type=Ze.TILES3D,this.slicePlaneEnabled=!1,this.isGround=!0,this.layerView=e,this.layerUid.push(e.layer.uid)}intersect(e,d,i,o,n,u){let l=e.results,b=e.options.store===et.ALL;if(e.options.filteredLayerUids.includes(this.layerView.layer.uid))return;let f=this.layerView.view._stage.renderView.componentObjectCollection,h=new it(u??!1,e.options.normalRequired);this.layerView.objects.forEach(a=>{a.visible&&a.intersectionGeometry&&f.intersect(a,i,o,e.tolerance,null,h,(c,r,g,m)=>{if(r>=0){if(d!=null&&!d(i,o,r))return;let C=w=>{let _=new ot(this.layerView.layer.uid,()=>this._createTiles3DGraphic(this.layerView.layer,{}));w.set(this.type,_,r,g)};if(this.isGround&&(l.ground.dist==null||r<l.ground.dist)&&C(l.ground),e.options.isFiltered)return;if((l.min.dist==null||r<l.min.dist)&&C(l.min),(l.max.dist==null||r>l.max.dist)&&C(l.max),b){let w=rt(e.ray);C(w),e.results.all.push(w)}}})})}_createTiles3DGraphic(e,d){return new Ne({layer:e,sourceLayer:e,attributes:d})}};var y;(function(t){t[t.API=1]="API",t[t.VerboseAPI=2]="VerboseAPI",t[t.Error=3]="Error"})(y||(y={}));var ge=class{constructor(){this.handle=0,this.isVisible=!1,this.components=[],this.texMemoryUsage=0,this.vboMemoryUsage=0,this.cpuMemoryUsage=0,this.textures=[]}get usedMemory(){return this.texMemoryUsage+this.vboMemoryUsage+this.cpuMemoryUsage}get cachedMemory(){return this.usedMemory}};function Y(t){return Math.round(t/1048.576)/1e3}var O=class extends ct(nt){constructor(){super(...arguments),this.type="integrated-mesh-3dtiles",this._visibleGeometryChangedSchedulerHandle=null,this._wasmLayerId=-1,this.ignoresMemoryFactor=!1,this.drapeTargetType=lt.WithoutRasterImage,this._applySSAO=!se("disable-feature:im-ssao"),this._shadeNormals=!!se("enable-feature:im-shading"),this._lyrHandleToObjects=new Map,this._initialCullFace=new Map,this._suspendedHandle=null,this._dbgFlags=new Set}initialize(){if(this._dbgFlags.add(y.Error),this._dbg(y.VerboseAPI,"Tiles3DLayerView3D initialize() called"),!this._canProjectWithoutEngine())throw new k("layerview:spatial-reference-incompatible","The spatial reference of this scene layer is incompatible with the spatial reference of the view",{});let t=dt(this).then(e=>{this._intersectionHandler=new X(this),this.view.sceneIntersectionHelper.addIntersectionHandler(this._intersectionHandler),this._updatingHandles.add(()=>this.slicePlaneEnabled,i=>this._slicePlaneEnabledChange(i)),this._elevationProvider=new yt({view:this.view,layerElevationSource:this,intersectionHandler:this._intersectionHandler}),this.view.elevationProvider.register("im",this._elevationProvider),this.view.basemapTerrain.overlayManager.registerDrapeTarget(this),this._wasmLayerId=e;let d=this.view.resourceController.memoryController.newCache(`t3d-${this.uid}`,i=>this._onRemoveFromCache(i));this._memCache=d,this.addHandles([oe(()=>this.layer.elevationInfo,i=>this._elevationInfoChanged(i))]),this._suspendedHandle=oe(()=>this.suspended,i=>this._wasm?.setEnabled(this,!i),Ce)}).catch(e=>{if(fe(this),this._wasmLayerId=-1,e===Ke)throw new k("tiles3d:addLayer-failure","The 3d tiles layer description was invalid.",{});if(e===Qe)throw new k("tiles3d:addLayer-failure","The 3d tiles layer web assembly module failed to download.",{})});this.addResolvingPromise(t)}destroy(){this._dbg(y.VerboseAPI,"Tiles3DLayerView3D destroy() called"),fe(this),this._suspendedHandle&&(this._suspendedHandle.remove(),this._suspendedHandle=null),this._intersectionHandler&&(this.view.sceneIntersectionHelper.removeIntersectionHandler(this._intersectionHandler),this._intersectionHandler=null),this._elevationProvider&&(this._elevationProvider.objectsChanged(this._obbs),this.view.elevationProvider.unregister(this._elevationProvider),this._elevationProvider=null),this.view.basemapTerrain.overlayManager.unregisterDrapeTarget(this),this._lyrHandleToObjects.forEach(t=>this.freeObject(t)),this._lyrHandleToObjects.clear(),this._initialCullFace.clear(),this._memCache=ae(this._memCache),this._updatingHandles=ae(this._updatingHandles),this.emit("visible-geometry-changed"),this._visibleGeometryChangedSchedulerHandle&&(this._visibleGeometryChangedSchedulerHandle.remove(),this._visibleGeometryChangedSchedulerHandle=null)}_visibleGeometryChanged(){this._visibleGeometryChangedSchedulerHandle??=Te(()=>{this.emit("visible-geometry-changed"),this._visibleGeometryChangedSchedulerHandle=null})}_slicePlaneEnabledChange(t){this._intersectionHandler&&(this._intersectionHandler.slicePlaneEnabled=t),this.objects.forEach(e=>{let d=this._collection.getMaterial(e);d.commonMaterialParameters.hasSlicePlane=t,d.commonMaterialParameters.cullFace=t?x.None:this._initialCullFace.get(e)})}_elevationInfoChanged(t){this._wasm?.setLayerOffset(this,pe(t))}get _obbs(){return this.objects.map(t=>this._collection.getComponentObb(t))}get _wasm(){return ut(this.view)}get wasmLayerId(){return this._wasmLayerId}get usedMemory(){let t=0;return this._lyrHandleToObjects.forEach(e=>{e.isVisible&&(t+=e.usedMemory)}),t}get unloadedMemory(){return 0}get cachedMemory(){let t=0;return this._lyrHandleToObjects.forEach(e=>{e.isVisible||(t+=e.usedMemory)}),t}get visibleAtCurrentScale(){return Xe(this.layer.effectiveScaleRange,this.view.scale)}get performanceInfo(){let t=0,e=0,d=0,i=0,o=0,n=0;return this._lyrHandleToObjects.forEach(u=>{u.isVisible?(t+=u.texMemoryUsage,e+=u.vboMemoryUsage,o++):(d+=u.texMemoryUsage,i+=u.vboMemoryUsage,n++)}),new J(this.usedMemory,o,n,Y(e),Y(t),Y(i),Y(d))}_canProjectWithoutEngine(){if(this.view.state.viewingMode===ze.Local){let t=this.view.renderSpatialReference?.isWebMercator?3857:this.view.renderSpatialReference?.wkid??-1;if(t!==3857&&t!==32662)return!1}return!0}get _stage(){return this.view._stage}get _collection(){return this._stage.renderView.componentObjectCollection}get elevationOffset(){return pe(this.layer.elevationInfo)}get elevationRange(){let t=this.fullExtent;return t?.zmin&&t?.zmax?new Ye(t.zmin,t.zmax):null}getElevationRange(t){return null}get fullExtent(){return this.layer.fullExtent}get objects(){return Array.from(this._lyrHandleToObjects.values()).reduce((t,e)=>t.concat(e.components),new Array)}isUpdating(){let t=this._wasm;return!(this._wasmLayerId<0||t==null)&&t.isUpdating(this._wasmLayerId)}updatingFlagChanged(){this.notifyChange("updating")}async createRenderable(t){let e=t.meshData;if(e.data==null)throw new Error("meshData.data undefined");if(e.desc=JSON.parse(e.desc),e.desc==null)throw new Error("meshData.desc undefined");let d=Pe(e.desc.origin),i=new Array,o=new Map,n=new ge;n.handle=t.handle,this._lyrHandleToObjects.set(t.handle,n);let u=this.view.basemapTerrain.spatialReference,l,b;if(this.view.viewingMode==="global"){let r=de();Ge(xe,d,r,u),l=je(me(),r),b=ke(me(),l)}else l=W,b=W;let f=de();Ee(f,f,d);let h=Oe(G(),f),a=null,c=G();if(e.desc.obb){let r=e.desc.obb.quaternion;a=new $e(e.desc.obb.center,e.desc.obb.halfSize,We(r[0],r[1],r[2],r[3]))}for(let r=0;r<e.desc.prims.length;r++){let g=e.desc.prims[r];if(this._dbg(y.VerboseAPI,JSON.stringify(g)),Tt[g.ptype]==null||e.data==null){this._dbg(y.VerboseAPI,"[Unsupported Feature] Unsupported primitive mode ("+g.ptype+"). Skipping primitive.");continue}let m=e.desc?.materials&&g.materialId!=null?e.desc.materials[g.materialId]:null,C=m!=null?m.lightingModel:ue.Unlit,{positionView:w,positionAttr:_,normalsView:K,normalsAttr:Q,colorAttr:R,texCoord0Attr:B,indicesView:A}=this.getBufferViews(g,e.data.buffer,l);if(_==null||w==null||A==null)continue;let be=new bt(R!=null,B!=null?he.Default:he.None,K!=null,this._shadeNormals,this._applySSAO),Pt=_.data.length/_.size,Z=(s,T)=>!s||s.data.length/s.size===Pt||(this._dbg(y.Error,`${T} !== numPos. Skipping primitive.`),!1);if(!Z(B,"numTexcoord")||!Z(R,"numColors")||!Z(Q,"normals"))continue;let we=wt(be);if(a!=null?a=a.clone():(a=qe(_),Ie(c,a.center,d),a.center=c),l!==W)for(let s=0;s<w.count;s++)w.getVec(s,c),Ue(c,c,l),w.setVec(s,c);let ee=we.createBuffer(_.data.length),H=new Map([[L.POSITION,_]]);B!=null&&H.set(L.UV0,B),R!=null&&H.set(L.COLOR,R),Q!=null&&H.set(L.NORMALCOMPRESSED,Q),H.forEach((s,T)=>{s!=null&&at(T,s,null,null,ee,0)});let Et=new Uint32Array([0,A.typedBuffer.length]),Ot={vertices:{data:ee.buffer,count:ee.byteLength/we.stride,layoutParameters:be},positionData:{positions:w.typedBuffer,indices:A.typedBuffer},indices:A.typedBuffer,componentOffsets:Et};n.cpuMemoryUsage+=w.count,n.cpuMemoryUsage+=A.count;let _e=this.view.renderSpatialReference,te=G(),re=[1,1,1];ht(h,_e,re,u)||this._dbg(y.Error,"Unsupported coordinate system for IM overlay"),Je(h,_e,te,u);let j=this._collection.createObject(new gt(Ve(te[0],te[1],re[0],re[1]),new _t(h,b),a,Ot));m&&this._collection.updateMaterial(j,s=>{s.baseColor=m.baseColorFactor,s.usePBR=C===ue.Pbr,s.hasParametersFromSource=!1,s.baseColorTexture=this._getTexture(m.baseColorTex,e,o),s.usePBR&&(s.mrrFactors=[m.metallicFactor,m.roughnessFactor,0],s.emissiveFactor=m.emissiveFactor??[0,0,0],s.metallicRoughnessTexture=this._getTexture(m.metalTex,e,o),s.emissionTexture=this._getTexture(m.emissiveTex,e,o),s.occlusionTexture=this._getTexture(m.occlusionTex,e,o),s.normalTexture=this._getTexture(m.normalTex,e,o)),s.objectOpacity=0,s.alphaDiscardMode=I.Mask;let T=[];s.baseColorTexture&&T.push(s.baseColorTexture.loadPromise),s.usePBR&&s.metallicRoughnessTexture&&T.push(s.metallicRoughnessTexture.loadPromise),s.usePBR&&s.emissionTexture&&T.push(s.emissionTexture.loadPromise),s.usePBR&&s.occlusionTexture&&T.push(s.occlusionTexture.loadPromise),s.usePBR&&s.normalTexture&&T.push(s.normalTexture.loadPromise);let ve=Promise.all(T);i.push(ve),ve.then(()=>{s.alphaDiscardMode=ye[m.alphaMode],s.objectOpacity=1,n.texMemoryUsage+=s.baseColorTexture?.glTexture?.usedMemory||0,s.usePBR&&(n.texMemoryUsage+=s.metallicRoughnessTexture?.glTexture?.usedMemory||0,n.texMemoryUsage+=s.emissionTexture?.glTexture?.usedMemory||0,n.texMemoryUsage+=s.occlusionTexture?.glTexture?.usedMemory||0,n.texMemoryUsage+=s.normalTexture?.glTexture?.usedMemory||0)}),s.commonMaterialParameters.doubleSided=m.isDoubleSided,s.commonMaterialParameters.cullFace=m.faceCulling?Mt[m.faceCulling]:x.Back,this._initialCullFace.set(j,s.commonMaterialParameters.cullFace),s.commonMaterialParameters.hasSlicePlane=this.slicePlaneEnabled,s.componentParameters.castShadows=vt.All,s.textureAlphaCutoff=m.alphaCutoff??tt,s.alphaDiscardMode=ye[m.alphaMode],s.isIntegratedMesh=!0,s.polygonOffsetEnabled=!1,s.hasOccludees=!1,s.ellipsoidMode=ft(this.view.spatialReference)}),n.components.push(j),n.vboMemoryUsage+=this._collection.getObjectGPUMemoryUsage(j)}if(await Promise.all(i),o.forEach(r=>{n.textures.push(r)}),!this._memCache)throw new Error("no memCache");return this._memCache.put(`${n.handle}`,n),{memUsageBytes:n.usedMemory}}freeRenderable(t){let e=this._lyrHandleToObjects.get(t);e&&(this.freeObject(e),this._lyrHandleToObjects.delete(t))}freeObject(t){this._memCache&&this._memCache.pop(`${t.handle}`),t.components.forEach(e=>{t.textures.forEach(d=>{this._stage.remove(d)}),this._collection.destroyObject(e),this._initialCullFace.delete(e)})}setRenderableVisibility(t,e,d){if(this._memCache){for(let i=0;i<d;++i){let o=t[i],n=e[i];if(!n)continue;let u=this._lyrHandleToObjects.get(o);u&&(this._visibleGeometryChanged(),u.isVisible=n,u.components.forEach(l=>{this._collection.setObjectVisibility(l,n),this._elevationProvider.objectChanged(this._collection.getComponentObb(l))}),this._memCache.pop(`${o}`))}for(let i=0;i<d;++i){let o=t[i],n=e[i];if(n)continue;let u=this._lyrHandleToObjects.get(o);u&&(this._visibleGeometryChanged(),u.isVisible=n,u.components.forEach(l=>{this._collection.setObjectVisibility(l,n),this._elevationProvider.objectChanged(this._collection.getComponentObb(l))}),this._memCache.put(`${o}`,u))}}}_getTexture(t,e,d){let i=null;if(t&&e.desc?.images&&e.data?.buffer){let o=e.desc.images[t?.imageId];if(i=d.get(o),!i&&o){let n=this._stage.renderView.renderingContext.parameters.maxMaxAnisotropy,u=!!o.mipCount||n>1,l=Ct[t.wrapMode??P.None],b=o.alpha?4:3,f=new Uint8Array(e.data.buffer,o.data.byteOffset,o.data.byteCount),h=null,a=null,c=null;switch(o.format){case M.Raw:o.pixelFormat===q.R8?(h=f,b=1,a=""):o.pixelFormat===q.Rgb8?(h=f,b=3,a=""):o.pixelFormat===q.Rgba8&&(h=f,b=4,a="");break;case M.Dxt1:h=f,b=3,a=z.DDS_ENCODING;break;case M.Dxt5:h=f,b=4,a=z.DDS_ENCODING;break;case M.Basis:h=f,b=3,a=z.KTX2_ENCODING;break;case M.Png:a="image/png",c=document.createElement("img");break;case M.Jpeg:a="image/jpeg",c=document.createElement("img");break;case M.Etc2:a="image/ktx",c=document.createElement("img");break;case M.Astc:this._dbg(y.Error,"Astc texture not supported");break;case M.Pvrtc:this._dbg(y.Error,"Pvrtc texture not supported")}if(c&&a){let r=new Blob([f],{type:a});c.src=URL.createObjectURL(r),h=c}h&&a!=null&&(i=new st(h,{mipmap:u,maxAnisotropy:n,encoding:a,wrap:l,components:b,noUnpackFlip:!0,width:o.mip0Width,height:o.mip0Height}),this._stage.add(i),d.set(o,i))}}return i?new pt(this.view._stage.renderView.textures,i.id):null}getBufferViews(t,e,d){let i,o,n,u,l,b,f,h=null;for(let a=0;a<t.atrbs.length;a++){let c=t.atrbs[a],r=c.view,g=void 0,m=r.byteOffset+r.byteCount,C=r.byteCount/xt[r.type],w=[...Array(C).keys()].map(_=>_);try{switch(c.sem){case U.Position:r.ncomp!==3||r.type!==p.F32?this._dbg(y.Error,"[Unsupported Feature] Unsupported view for Position ("+r+")"):(i=new N(e,r.byteOffset,g,m),o=new S(i.typedBuffer,w,3));break;case U.Normal:if(r.ncomp!==3||r.type!==p.F32)this._dbg(y.Error,"[Unsupported Feature] Unsupported view for Normal ("+r+")");else{let _=new N(e,r.byteOffset,g,m),K=He(_.typedBuffer,d);l=new Be(K),b=new S(l.typedBuffer,w,2)}break;case U.TexCoord:r.ncomp!==2||r.type!==p.F32?this._dbg(y.Error,"[Unsupported Feature] Unsupported view for Texcoord ("+r+")"):u===void 0&&(u=new S(new Ae(e,r.byteOffset,g,m).typedBuffer,w,2));break;case U.Color:r.ncomp===4?(r.type===p.F32&&(h=new De(e,r.byteOffset,g,m)),r.type===p.U8&&(h=new Se(e,r.byteOffset,g,m)),r.type===p.U16&&(h=new Re(e,r.byteOffset,g,m))):r.ncomp===3&&(r.type===p.F32&&(h=new N(e,r.byteOffset,g,m)),r.type===p.U8&&(h=new Le(e,r.byteOffset,g,m)),r.type===p.U16&&(h=new Fe(e,r.byteOffset,g,m))),h==null?this._dbg(y.VerboseAPI,"[Unsupported Feature] Unsupported view for Color ("+r+")"):n=new S(h.typedBuffer,w,r.ncomp);break;case U.FeatureIndex:break;default:this._dbg(y.VerboseAPI,"[Unsupported Feature] Unsupported semantic ("+c.sem+"). Skipping vertex attribute.")}}catch(_){this._dbg(y.VerboseAPI,"Error Creating buffer ("+_+"). Skipping vertex attribute.")}}if(t.index){let a=t.index.view,c=void 0,r=a.byteOffset+a.byteCount;switch(t.index.view.type){case p.U16:f=new ne(e,a.byteOffset,c,r);break;case p.U32:f=new le(e,a.byteOffset,c,r);break;case p.U8:default:this._dbg(y.Error,"[Unsupported Feature] index type not supported ("+a.type+").")}}if(f==null&&i!=null){let a=i.count;if(a<65535){let c=new Uint16Array(a);f=new ne(c)}else{let c=new Uint32Array(a);f=new le(c)}for(let c=0;c<a;c++)f.set(c,c)}return{positionView:i,positionAttr:o,colorAttr:n,texCoord0Attr:u,indicesView:f,normalsView:l,normalsAttr:b}}_onRemoveFromCache(t){this._wasm?.onRenderableEvicted(this,t.handle,t.usedMemory),this.freeRenderable(t.handle)}_dbg(t,e){this._dbgFlags.has(t)&&(t===y.Error?ie.getLogger(this).error(e):ie.getLogger(this).warn(e))}};V([D()],O.prototype,"_visibleGeometryChangedSchedulerHandle",void 0),V([D()],O.prototype,"layer",void 0),V([D({readOnly:!0})],O.prototype,"visibleAtCurrentScale",null),V([D()],O.prototype,"elevationOffset",null),O=V([Me("esri.views.3d.layers.IntegratedMesh3DTilesLayerView3D")],O);var Br=O;export{Br as default};
