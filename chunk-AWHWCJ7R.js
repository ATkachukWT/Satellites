import{b as gt}from"./chunk-XYSEQQOL.js";import{a as ut}from"./chunk-7MEKUIT2.js";import{b as pt,c as ht,d as mt}from"./chunk-WFQUCDHF.js";import{b as ct}from"./chunk-JVPRAOU2.js";import{a as dt}from"./chunk-JUMM5VTE.js";import{a as ot}from"./chunk-MRGB2CKA.js";import{a as nt}from"./chunk-VYGDXVXD.js";import{a as j}from"./chunk-E5THP5GP.js";import"./chunk-4643RUEK.js";import{a as k}from"./chunk-75GZ6ETV.js";import"./chunk-NUJB3HJD.js";import"./chunk-VTI633OW.js";import"./chunk-AGNIXKQH.js";import"./chunk-3ABIMFDV.js";import"./chunk-W3HXXDUN.js";import"./chunk-P5DBP5G4.js";import"./chunk-QC6ZIWCS.js";import"./chunk-Q4D6RBGT.js";import"./chunk-MCWKELO6.js";import"./chunk-5IYUVR2B.js";import"./chunk-ASWKMS6K.js";import{a as at,b as st,d as T}from"./chunk-BWRSM4GV.js";import"./chunk-6NVIER6D.js";import"./chunk-MCUWKKTW.js";import"./chunk-E4MEDSYW.js";import"./chunk-WH5SLVE3.js";import"./chunk-CUJ2T6EE.js";import"./chunk-E2PEM77A.js";import"./chunk-OTLOUAP3.js";import"./chunk-JXEAVWUK.js";import"./chunk-R3ABULTC.js";import"./chunk-DB752BXH.js";import"./chunk-T3DGHEVR.js";import"./chunk-ZOOQQO74.js";import{d as tt,l as et}from"./chunk-KMLF2ICK.js";import"./chunk-5Q65R7QF.js";import"./chunk-2ZZZKQ4W.js";import"./chunk-SCNTWYD2.js";import"./chunk-C3PAYYXB.js";import"./chunk-FYZRIMPP.js";import"./chunk-47CBJZNC.js";import"./chunk-NGQW42AK.js";import{b as lt}from"./chunk-4ZHOYO2J.js";import"./chunk-QW4SS6UN.js";import"./chunk-M6OVPXT3.js";import"./chunk-UPU3OYP4.js";import"./chunk-FLXA3YE2.js";import"./chunk-BFOAQMH4.js";import"./chunk-OWY34DUP.js";import"./chunk-4TIUXNXO.js";import"./chunk-G5XYZLZF.js";import{c as rt}from"./chunk-CEAEFIX3.js";import"./chunk-ULWS5HLW.js";import"./chunk-HUWVQAJL.js";import{c as R}from"./chunk-3O6GAUHL.js";import"./chunk-NOHUHVCW.js";import"./chunk-KE2U7ENE.js";import"./chunk-PSFZFYFC.js";import"./chunk-PTXLSCMJ.js";import"./chunk-NRRX2M6N.js";import{b as N,e as it}from"./chunk-PMLKCTEJ.js";import"./chunk-MYO2G5ZH.js";import"./chunk-A45BLB26.js";import"./chunk-BPX3YT3K.js";import"./chunk-47NSYSFY.js";import"./chunk-QXNVQZT7.js";import"./chunk-BYXBJQAS.js";import"./chunk-JLWYDAJB.js";import"./chunk-3QCWBHPT.js";import"./chunk-2T2QPZOS.js";import"./chunk-4YCQZSNI.js";import"./chunk-4D3QHJI2.js";import"./chunk-E2J2V7JN.js";import"./chunk-G7RYJIRW.js";import"./chunk-37H4LYIE.js";import"./chunk-VYZHOYXV.js";import"./chunk-K7YQAHQ7.js";import"./chunk-PGUFA2AC.js";import"./chunk-X7BNFUFQ.js";import"./chunk-XAHD7XBV.js";import"./chunk-NLZLCUU5.js";import"./chunk-E3UR4EIC.js";import"./chunk-XHEYQWRE.js";import"./chunk-U7PX7SHO.js";import"./chunk-HUKD3ORH.js";import"./chunk-3A3BGKXB.js";import"./chunk-BGOXHRAZ.js";import"./chunk-SXNHGK6A.js";import"./chunk-TMZQBNSB.js";import"./chunk-PFSX77NO.js";import"./chunk-ZJWWZWMH.js";import"./chunk-W45QYQK6.js";import"./chunk-I5V562B6.js";import"./chunk-WPZN772I.js";import"./chunk-AOQ57NDM.js";import"./chunk-ONYJLWAD.js";import"./chunk-HBZAOVHW.js";import"./chunk-JGU5JAYW.js";import"./chunk-LCMPSAU3.js";import"./chunk-CRJDOM7J.js";import"./chunk-BCFGKQ2N.js";import"./chunk-YQGS4EZO.js";import"./chunk-3REMXE4W.js";import"./chunk-4ABKPPKG.js";import"./chunk-PMVQ5DJK.js";import"./chunk-I4Q2S2XA.js";import"./chunk-V774RJYN.js";import"./chunk-L2WNUKLP.js";import"./chunk-XITT4JU2.js";import"./chunk-ZBX6HJOS.js";import"./chunk-BSMAMABT.js";import"./chunk-LYNAYPL3.js";import"./chunk-ULANM5YP.js";import"./chunk-77L5NP7A.js";import"./chunk-2G3SBK6Q.js";import"./chunk-VOB6IBIW.js";import"./chunk-63B3IOWG.js";import"./chunk-KAMRW6HF.js";import"./chunk-DJW5LMRG.js";import"./chunk-DEH76MSI.js";import"./chunk-DVBZA6ZU.js";import"./chunk-TBA3OZMJ.js";import"./chunk-S4QV2MGO.js";import"./chunk-USMAJP2P.js";import"./chunk-PHNFWHVF.js";import"./chunk-4N5OXIEM.js";import"./chunk-DTU6MHUX.js";import"./chunk-NFXNGFHZ.js";import"./chunk-W26XKMAT.js";import"./chunk-NQWYPF77.js";import"./chunk-6KRFVLII.js";import"./chunk-CDP4MSRO.js";import"./chunk-TOH4K6HW.js";import"./chunk-UP6FLASM.js";import"./chunk-DGBDFGKO.js";import{b as $}from"./chunk-44S2QQS2.js";import"./chunk-DQOFEB5P.js";import"./chunk-JTDXB5TK.js";import"./chunk-2NP7F5RO.js";import"./chunk-7QY3BMVN.js";import"./chunk-XEZTJAR4.js";import"./chunk-BUP3AMMF.js";import"./chunk-XCIPBOI4.js";import"./chunk-CWUY5SXW.js";import"./chunk-KD27XIJC.js";import{g as Y,h as M}from"./chunk-TPFJWNIU.js";import"./chunk-P25RU3X5.js";import"./chunk-XRRQM4E2.js";import"./chunk-GWBRHLNH.js";import"./chunk-W5OI4BJ2.js";import{l as G,n as X,p as Z,w as B}from"./chunk-HM5RIVQC.js";import"./chunk-EM35R6FY.js";import"./chunk-QXXXCEV5.js";import"./chunk-6B5XFA6F.js";import"./chunk-M67YQAIX.js";import"./chunk-NHEQ4TAR.js";import"./chunk-RZF6KTKU.js";import"./chunk-HP4LYRR4.js";import"./chunk-AFC2H4Q3.js";import"./chunk-OLOKUDVI.js";import"./chunk-4G7UTTZJ.js";import"./chunk-ZTOZWLEE.js";import"./chunk-RJWOVI3M.js";import"./chunk-SP2CO3KX.js";import"./chunk-NRBJLISB.js";import"./chunk-PTZYZULI.js";import"./chunk-NMLYCCKN.js";import"./chunk-RSDQHAJX.js";import"./chunk-BOVYXYHK.js";import"./chunk-FENRIY2T.js";import"./chunk-5HJY3X5Y.js";import"./chunk-6RZAM42M.js";import"./chunk-WDETDPZG.js";import"./chunk-HX2VGIR2.js";import"./chunk-64QN2VGD.js";import"./chunk-JGEVVXD4.js";import"./chunk-B3FO6PT7.js";import"./chunk-C4UMJHQC.js";import"./chunk-BCREO4Q5.js";import"./chunk-LXFQWIWE.js";import"./chunk-QT6UNBJP.js";import"./chunk-NSYL2RQJ.js";import{a as J}from"./chunk-MWSXMSWY.js";import"./chunk-JRCKELO6.js";import"./chunk-KJULKTB5.js";import"./chunk-LACL4BQ2.js";import{c as H}from"./chunk-YR2HD3ZC.js";import"./chunk-GJASVPF6.js";import"./chunk-UBFCO3DV.js";import"./chunk-NMRTZBDM.js";import"./chunk-NI7FJV5X.js";import"./chunk-BUSG3ZOF.js";import"./chunk-XZIOXVVJ.js";import"./chunk-EXJYW3PC.js";import"./chunk-SXQPBCOX.js";import{m as I}from"./chunk-LFH24RLM.js";import{n as q}from"./chunk-Z5Q7KLA4.js";import"./chunk-X4LNX4BR.js";import{a as E}from"./chunk-4XZ6X7MQ.js";import"./chunk-WLHY3MMA.js";import"./chunk-KGVXGH6H.js";import"./chunk-ARRCN5K3.js";import"./chunk-LXQPIAN7.js";import"./chunk-FTDD7QBB.js";import"./chunk-DB3UIQCU.js";import"./chunk-SBHKMV3P.js";import"./chunk-R4A63S45.js";import{E as Q,c as W}from"./chunk-ETE32IYO.js";import{i as U,j as K}from"./chunk-ONUGDWDK.js";import{f as F}from"./chunk-SG7CQU4O.js";import{H as c}from"./chunk-QHVIRF5H.js";import{I as P}from"./chunk-WZDN6K3C.js";import{a as h}from"./chunk-QGVBCWUY.js";import"./chunk-OJQ73TPF.js";import"./chunk-354SCPDU.js";import"./chunk-OVHPPCBL.js";import"./chunk-IYZFKXJ6.js";import{b as S,e as z}from"./chunk-CKJ56T2Q.js";import"./chunk-SNFOAZZQ.js";import"./chunk-F6JAWRPN.js";import"./chunk-UHRSAPGQ.js";import"./chunk-V76GWARL.js";import{a as D}from"./chunk-N2WTMF3X.js";var u=class extends F{constructor(){super(...arguments),this.id=0,this.rotation=0,this.href="",this.extent=new I}};h([c({nonNullable:!0,json:{write:!0}})],u.prototype,"id",void 0),h([c({nonNullable:!0,json:{write:!0}})],u.prototype,"rotation",void 0),h([c({nonNullable:!0,json:{write:!0}})],u.prototype,"href",void 0),h([c({type:I,nonNullable:!0,json:{write:!0}})],u.prototype,"extent",void 0),u=h([P("esri.layers.support.KMLMapImage")],u);var _t=(()=>{class t{constructor(e){if(this._ownsRctx=!1,e)this._ownsRctx=!1,this._rctx=e;else{if(t._instance)return t._instanceRefCount++,t._instance;t._instanceRefCount=1,t._instance=this,this._ownsRctx=!0;let a=document.createElement("canvas").getContext("webgl2");a.getExtension("OES_texture_float"),this._rctx=new lt(a,{})}let o={applyProjection:!0,bilinear:!1,bicubic:!1},s=ot("raster/reproject","raster/reproject",new Map([["a_position",0]]),o);this._program=this._rctx.programCache.acquire(s.shaders.vertexShader,s.shaders.fragmentShader,s.attributes),this._rctx.useProgram(this._program),this._program.setUniform1f("u_opacity",1),this._program.setUniform1i("u_image",0),this._program.setUniform1i("u_flipY",0),this._program.setUniform1i("u_transformGrid",1),this._quad=new nt(this._rctx,[0,0,1,0,0,1,1,1])}reprojectTexture(e,o,s=!1){let a=M(e.extent,o),n=new q({x:(e.extent.xmax-e.extent.xmin)/e.texture.descriptor.width,y:(e.extent.ymax-e.extent.ymin)/e.texture.descriptor.height,spatialReference:e.extent.spatialReference}),{x:p,y:l}=tt(n,o,e.extent),r=(p+l)/2,_=Math.round((a.xmax-a.xmin)/r),f=Math.round((a.ymax-a.ymin)/r);r=(a.width/_+a.height/f)/2;let L=new q({x:r,y:r,spatialReference:a.spatialReference}),w=et({projectedExtent:a,srcBufferExtent:e.extent,pixelSize:L,hasWrapAround:!0,spacing:[16,16]}),x=gt(this._rctx,w),b=new N(_,f);b.wrapMode=G.CLAMP_TO_EDGE;let m=new rt(this._rctx,b);this._rctx.bindFramebuffer(m),this._rctx.setViewport(0,0,_,f),this._rctx.useProgram(this._program),this._rctx.bindTexture(e.texture,0),this._rctx.bindTexture(x,1),this._quad.bind();let{width:V=0,height:v=0}=e.texture.descriptor;if(this._program.setUniform2f("u_srcImageSize",V,v),this._program.setUniform2fv("u_transformSpacing",w.spacing),this._program.setUniform2fv("u_transformGridSize",w.size),this._program.setUniform2f("u_targetImageSize",_,f),this._quad.draw(),this._quad.unbind(),this._rctx.useProgram(null),this._rctx.bindFramebuffer(null),x.dispose(),s){let{width:C,height:y}=m,O=new ImageData(C??0,y??0);m.readPixels(0,0,C??0,y??0,X.RGBA,Z.UNSIGNED_BYTE,O.data);let ft=m.detachColorTexture(B.COLOR_ATTACHMENT0);return m.dispose(),{texture:ft,extent:a,imageData:O}}let d=m.detachColorTexture(B.COLOR_ATTACHMENT0);return m.dispose(),{texture:d,extent:a}}reprojectBitmapData(e,o){let s=pt(e.bitmapData)?ht(e.bitmapData):e.bitmapData,a=new N;a.wrapMode=G.CLAMP_TO_EDGE,a.width=e.bitmapData.width,a.height=e.bitmapData.height;let n=new it(this._rctx,a,s),p=this.reprojectTexture({texture:n,extent:e.extent},o,!0);p.texture.dispose();let l=document.createElement("canvas"),r=p.imageData;return l.width=r.width,l.height=r.height,l.getContext("2d").putImageData(r,0,0),{bitmapData:l,extent:p.extent}}async loadAndReprojectBitmapData(e,o,s){let a=(await Q(e,{responseType:"image"})).data,n=document.createElement("canvas");n.width=a.width,n.height=a.height;let p=n.getContext("2d");p.drawImage(a,0,0);let l=p.getImageData(0,0,n.width,n.height);if(o.spatialReference.equals(s))return{bitmapData:l,extent:o};let r=this.reprojectBitmapData({bitmapData:l,extent:o},s);return{bitmapData:r.bitmapData,extent:r.extent}}destroy(){this._ownsRctx?(t._instanceRefCount--,t._instanceRefCount===0&&(this._quad.dispose(),this._program.dispose(),this._rctx.dispose(),t._instance=null)):(this._quad.dispose(),this._program.dispose())}}return t._instanceRefCount=0,t})();var A=class{constructor(){this.allSublayers=new Map,this.allPoints=[],this.allPolylines=[],this.allPolygons=[],this.allMapImages=[]}},g=class extends ct(dt){constructor(){super(...arguments),this._bitmapIndex=new Map,this._mapImageContainer=new ut,this._kmlVisualData=new A,this._fetchController=null,this.allVisiblePoints=new R,this.allVisiblePolylines=new R,this.allVisiblePolygons=new R,this.allVisibleMapImages=new H}async hitTest(t,i){let e=this.layer;return[this._pointsView?.hitTest(t),this._polylinesView?.hitTest(t),this._polygonsView?.hitTest(t)].flat().filter(Boolean).map(o=>(o.layer=e,o.sourceLayer=e,{type:"graphic",graphic:o,layer:e,mapPoint:t}))}update(t){this._polygonsView&&this._polygonsView.processUpdate(t),this._polylinesView&&this._polylinesView.processUpdate(t),this._pointsView&&this._pointsView.processUpdate(t)}attach(){this._fetchController=new AbortController,this.container.addChild(this._mapImageContainer),this._polygonsView=new k({view:this.view,graphics:this.allVisiblePolygons,requestUpdateCallback:()=>this.requestUpdate(),container:new j(this.view.featuresTilingScheme)}),this.container.addChild(this._polygonsView.container),this._polylinesView=new k({view:this.view,graphics:this.allVisiblePolylines,requestUpdateCallback:()=>this.requestUpdate(),container:new j(this.view.featuresTilingScheme)}),this.container.addChild(this._polylinesView.container),this._pointsView=new k({view:this.view,graphics:this.allVisiblePoints,requestUpdateCallback:()=>this.requestUpdate(),container:new j(this.view.featuresTilingScheme)}),this.container.addChild(this._pointsView.container),this.addAttachHandles([this.allVisibleMapImages.on("change",t=>{t.added.forEach(i=>this._addMapImage(i)),t.removed.forEach(i=>this._removeMapImage(i))}),J(()=>this.layer.visibleSublayers,t=>{for(let i of this._kmlVisualData.allSublayers.values())i.visibility=0;for(let i of t){let e=this._kmlVisualData.allSublayers.get(i.id);e&&(e.visibility=1)}this._refreshCollections()})]),this._updatingHandles.addPromise(this._fetchService(this._fetchController.signal)),this._imageReprojector=new _t}detach(){this._fetchController=z(this._fetchController),this._mapImageContainer.removeAllChildren(),this.container.removeAllChildren(),this._bitmapIndex.clear(),this._polygonsView=S(this._polygonsView),this._polylinesView=S(this._polylinesView),this._pointsView=S(this._pointsView),this._imageReprojector=S(this._imageReprojector)}viewChange(){this._polygonsView.viewChange(),this._polylinesView.viewChange(),this._pointsView.viewChange()}moveEnd(){}isUpdating(){return this._pointsView.updating||this._polygonsView.updating||this._polylinesView.updating}_addMapImage(t){(this.view.spatialReference?.isWGS84||this.view.spatialReference?.isWebMercator)&&this._imageReprojector.loadAndReprojectBitmapData(t.href,t.extent,this.view.spatialReference).then(i=>{let e=new mt(i.bitmapData);e.x=i.extent.xmin,e.y=i.extent.ymax,e.resolution=i.extent.width/i.bitmapData.width,e.rotation=t.rotation,this._mapImageContainer.addChild(e),this._bitmapIndex.set(t,e)})}async _getViewDependentUrl(t,i){let{viewFormat:e,viewBoundScale:o,httpQuery:s}=t;if(e!=null){if(i==null)throw new Error("Loading this network link requires a view state.");let a;if(await Y(),o!=null&&o!==1){let d=new I(i.extent);d.expand(o),a=d}else a=i.extent;a=M(a,E.WGS84);let n=M(a,E.WebMercator),p=a.xmin,l=a.xmax,r=a.ymin,_=a.ymax,f=i.size[0]*i.pixelRatio,L=i.size[1]*i.pixelRatio,w=Math.max(n.width,n.height),x={"[bboxWest]":p.toString(),"[bboxEast]":l.toString(),"[bboxSouth]":r.toString(),"[bboxNorth]":_.toString(),"[lookatLon]":a.center.x.toString(),"[lookatLat]":a.center.y.toString(),"[lookatRange]":w.toString(),"[lookatTilt]":"0","[lookatHeading]":i.rotation.toString(),"[lookatTerrainLon]":a.center.x.toString(),"[lookatTerrainLat]":a.center.y.toString(),"[lookatTerrainAlt]":"0","[cameraLon]":a.center.x.toString(),"[cameraLat]":a.center.y.toString(),"[cameraAlt]":w.toString(),"[horizFov]":"60","[vertFov]":"60","[horizPixels]":f.toString(),"[vertPixels]":L.toString(),"[terrainEnabled]":"0","[clientVersion]":W,"[kmlVersion]":"2.2","[clientName]":"ArcGIS API for JavaScript","[language]":"en-US"},b=d=>{for(let C in d){let y;for(y in x)d[C]=d[C].replace(y,x[y])}},m=U(e);b(m);let V={};s!=null&&(V=U(s),b(V));let v=$(t.href);return v.query=D(D(D({},v.query),m),V),`${v.path}?${K(m)}`}return t.href}async _fetchService(t){let i=new A;await this._loadVisualData(this.layer.url,i,t),this._kmlVisualData=i,this._refreshCollections()}_refreshCollections(){this.allVisiblePoints.removeAll(),this.allVisiblePolylines.removeAll(),this.allVisiblePolygons.removeAll(),this.allVisibleMapImages.removeAll(),this.allVisiblePoints.addMany(this._kmlVisualData.allPoints.filter(t=>this._isSublayerVisible(t.sublayerId)).map(({item:t})=>t)),this.allVisiblePolylines.addMany(this._kmlVisualData.allPolylines.filter(t=>this._isSublayerVisible(t.sublayerId)).map(({item:t})=>t)),this.allVisiblePolygons.addMany(this._kmlVisualData.allPolygons.filter(t=>this._isSublayerVisible(t.sublayerId)).map(({item:t})=>t)),this.allVisibleMapImages.addMany(this._kmlVisualData.allMapImages.filter(t=>this._isSublayerVisible(t.sublayerId)).map(({item:t})=>t))}_isSublayerVisible(t){let i=this._kmlVisualData.allSublayers.get(t);return!!i?.visibility&&(i.parentFolderId===-1||this._isSublayerVisible(i.parentFolderId))}_loadVisualData(t,i,e){return this._fetchParsedKML(t,e).then(async o=>{for(let s of o.sublayers){i.allSublayers.set(s.id,s);let a=s.points?await T(s.points):[],n=s.polylines?await T(s.polylines):[],p=s.polygons?await T(s.polygons):[],l=s.mapImages?.map(r=>u.fromJSON(r))??[];if(i.allPoints.push(...a.map(r=>({item:r,sublayerId:s.id}))),i.allPolylines.push(...n.map(r=>({item:r,sublayerId:s.id}))),i.allPolygons.push(...p.map(r=>({item:r,sublayerId:s.id}))),i.allMapImages.push(...l.map(r=>({item:r,sublayerId:s.id}))),s.networkLink){let r=await this._getViewDependentUrl(s.networkLink,this.view.state);await this._loadVisualData(r,i,e)}}})}_fetchParsedKML(t,i){return st(t,this.layer.spatialReference,this.layer.refreshInterval,i).then(e=>at(e.data))}_removeMapImage(t){let i=this._bitmapIndex.get(t);i&&(this._mapImageContainer.removeChild(i),this._bitmapIndex.delete(t))}};h([c()],g.prototype,"_pointsView",void 0),h([c()],g.prototype,"_polylinesView",void 0),h([c()],g.prototype,"_polygonsView",void 0),h([c()],g.prototype,"updating",void 0),g=h([P("esri.views.2d.layers.KMLLayerView2D")],g);var de=g;export{de as default};
