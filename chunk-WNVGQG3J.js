import{a as Q,b as $}from"./chunk-TUJMSP4X.js";import{a as X,c as Y,d as ee}from"./chunk-4YX5NE4F.js";import{a as T}from"./chunk-F7MBACHV.js";import{a as K}from"./chunk-5ZS2L6U3.js";import{a as B}from"./chunk-LAVD467M.js";import{b as J}from"./chunk-6CUAH7AI.js";import{a as E}from"./chunk-N5YUEDXE.js";import{n as j,p as U}from"./chunk-T4QAGZWF.js";import{e as A,h as C,j as q,l as P}from"./chunk-7BXTHPPE.js";import{w as R}from"./chunk-2XYAAYOE.js";import{h as I,t as V}from"./chunk-TPFJWNIU.js";import{a as x,h as Z,j as W}from"./chunk-MWSXMSWY.js";import{f as G}from"./chunk-JRCKELO6.js";import{c as S}from"./chunk-YR2HD3ZC.js";import{a as k}from"./chunk-GJASVPF6.js";import{H as o,J as b}from"./chunk-QHVIRF5H.js";import{I as _}from"./chunk-WZDN6K3C.js";import{a as s}from"./chunk-QGVBCWUY.js";import{v as M,x as H}from"./chunk-CKJ56T2Q.js";import{r as N}from"./chunk-UHRSAPGQ.js";import{j as L}from"./chunk-V76GWARL.js";var m=class extends b{constructor(e){super(e),this.layer=null,this.enabled=!0,this.updating=!1,this.availability=1,this.sublayerSources=new S}};s([o({constructOnly:!0})],m.prototype,"layer",void 0),s([o()],m.prototype,"enabled",void 0),s([o()],m.prototype,"updating",void 0),s([o()],m.prototype,"availability",void 0),s([o()],m.prototype,"sublayerSources",void 0),m=s([_("esri.views.interactive.snapping.FeatureSnappingLayerSource")],m);var O=m;var u=class extends b{constructor(e){super(e),this.enabled=!1,this.enabledToggled=!1,this.forceDisabled=!1,this.selfEnabled=!0,this.featureEnabled=!0,this.gridEnabled=!1,this.attributeRulesEnabled=!1,this.featureSources=new S,this.distance=E.distance,this.touchSensitivityMultiplier=E.touchSensitivityMultiplier}get effectiveEnabled(){return!this.forceDisabled&&(this.enabledToggled?!this.enabled:this.enabled)}get effectiveGridEnabled(){return this.effectiveEnabled&&this.gridEnabled}get effectiveSelfEnabled(){return this.effectiveEnabled&&this.selfEnabled}get effectiveFeatureEnabled(){return this.effectiveEnabled&&this.featureEnabled}get _effectiveFeatureSources(){let e=this.featureSources;e.some(te)&&N.getLogger(this).warnOnce("Do not configure SubtypeGroupLayer sources in SnappingOptions.featureSources directly. Create a FeatureSnappingLayerSource for each SubtypeSublayer.");let t=e.filter(re),i=this._get("_effectiveFeatureSources")?.filter(te)??new S;for(let p of t){let c=i.find(l=>l.layer===p.layer.parent);if(c)c.sublayerSources.includes(p)||c.sublayerSources.add(p);else if(p.layer.parent){let l=new O({layer:p.layer.parent});l.sublayerSources.add(p),i.add(l)}}for(let p of i){let c=p.sublayerSources.filter(l=>!t.includes(l));p.sublayerSources.removeMany(c)}i.removeMany(i.filter(p=>p.sublayerSources.length===0));let n=e.filter(ne),r=this._get("_effectiveFeatureSources")??new S,{added:a,removed:d}=L(r.toArray(),[...n,...i]);return r.removeMany(d),r.addMany(a),r}};s([o()],u.prototype,"enabled",void 0),s([o()],u.prototype,"enabledToggled",void 0),s([o()],u.prototype,"forceDisabled",void 0),s([o()],u.prototype,"selfEnabled",void 0),s([o()],u.prototype,"featureEnabled",void 0),s([o()],u.prototype,"gridEnabled",void 0),s([o()],u.prototype,"attributeRulesEnabled",void 0),s([o({type:S.ofType(O)})],u.prototype,"featureSources",void 0),s([o()],u.prototype,"distance",void 0),s([o()],u.prototype,"touchSensitivityMultiplier",void 0),s([o({readOnly:!0})],u.prototype,"effectiveEnabled",null),s([o({readOnly:!0})],u.prototype,"effectiveGridEnabled",null),s([o({readOnly:!0})],u.prototype,"effectiveSelfEnabled",null),s([o({readOnly:!0})],u.prototype,"effectiveFeatureEnabled",null),s([o({readOnly:!0})],u.prototype,"_effectiveFeatureSources",null),u=s([_("esri.views.interactive.snapping.SnappingOptions")],u);var ie=u;function te(e){return e.layer.type==="subtype-group"}function ne(e){return e.layer.type!=="subtype-group"}function re(e){return e.layer.type==="subtype-sublayer"}var f=class extends k.EventedMixin(b){constructor(e){super(e),this.options=new ie,this._engineCache=new Map,this._loadTask=null,this._engines=[],this._currentMainCandidate=null,this._currentOtherActiveCandidates=[],this._currentSnappedType=g.MAIN}initialize(){this.addHandles([x(()=>{let{distance:e,touchSensitivityMultiplier:t,effectiveSelfEnabled:i,effectiveFeatureEnabled:n,effectiveGridEnabled:r}=this.options;return{selfEnabled:i,featureEnabled:n,gridEnabled:this.view.type==="2d"&&r,viewReady:this.view.ready,viewSpatialReference:this.view.spatialReference,distance:e,touchSensitivityMultiplier:t}},(e,t)=>{t&&(this.doneSnapping(),this.emit("changed")),this._loadTask?.abort(),this._loadTask=G(i=>this._updateEngines(e,t,i))},W),x(()=>this.options,e=>{for(let t of this._engines)t.options=e},Z)])}destroy(){this._loadTask?.abort(),this._destroyEngines()}get updating(){return this._engines.some(e=>e.updating)||!this._loadTask?.finished}_destroyEngines(){this._engineCache.forEach(e=>e.destroy()),this._engineCache.clear(),this._engines=[]}async _updateEngines(e,t,i){if(!e.viewReady)return void this._destroyEngines();t?.viewSpatialReference!==e.viewSpatialReference&&this._destroyEngines();let n=this._engineCache,r=await Promise.allSettled([e.featureEnabled&&!n.has("feature")?this._createFeatureSnappingEngine(i):void 0,e.selfEnabled&&!n.has("self")?this._createSelfSnappingEngine(i):void 0,e.gridEnabled&&!n.has("grid")?this._createGridSnappingEngine(i):void 0]);if(i.aborted)for(let a of r)a.status==="fulfilled"&&a.value?.engine.destroy();else{for(let a of r)a.status==="fulfilled"&&a.value&&n.set(a.value.type,a.value.engine);this._engines=Array.from(n.values())}}async _createSelfSnappingEngine(e){let{SelfSnappingEngine:t}=await import("./chunk-MW77VEVH.js");return M(e),{type:"self",engine:new t({view:this.view,options:this.options})}}async _createGridSnappingEngine(e){let{view:t}=this;if(t.type!=="2d")return;let{GridSnappingEngine:i}=await import("./chunk-QYL455P7.js");return M(e),{type:"grid",engine:new i({view:t,options:this.options})}}async _createFeatureSnappingEngine(e){let{FeatureSnappingEngine:t}=await import("./chunk-O7WHQHLH.js");M(e);let{view:i,options:n}=this,{spatialReference:r}=i;return{type:"feature",engine:new t({view:i,options:n,spatialReference:r})}}get _squaredMouseProximityThreshold(){return this.options.distance*this.options.distance}get _squaredTouchProximityThreshold(){let{distance:e,touchSensitivityMultiplier:t}=this.options,i=e*t;return i*i}snap(e){return oe(e)?this._snapMultiPoint(e):this._snapSinglePoint(e)}update(e){let{point:t,context:i}=e;this._removeVisualization();let n=this._currentMainCandidate;if(n==null)return t;let r=this._selectUpdateInput(e);if(r==null)return t;let{spatialReference:a}=i,d=I(r,a);if(d==null)return t;let{view:p}=this,{elevationInfo:c,visualizer:l}=i,h=[],y=C(d,p,c),v=n.constraint.closestTo(y);if(!this._arePointsWithinScreenThreshold(y,v,i)||!z(n,i.drawConstraints))return this._resetSnappingState(),t;n.targetPoint=A(v),h.push(...n.hints);for(let w of this._currentOtherActiveCandidates)z(w,i.drawConstraints)&&(w.targetPoint=A(v),h.push(...w.hints));return l!=null&&this.addHandles(l.draw(h,{spatialReference:a,elevationInfo:pe(i),view:p,selfSnappingZ:i.selfSnappingZ}),F),q(v,p,t,i)}doneSnapping(){this._removeVisualization(),this._resetSnappingState()}_selectUpdateInput({point:e,scenePoint:t}){switch(this._currentSnappedType){case g.MAIN:return e;case g.SCENE:return t}}_resetSnappingState(){this._currentMainCandidate=null,this._currentOtherActiveCandidates=[],this._currentSnappedType=g.MAIN}_removeVisualization(){this.removeHandles(F)}async _snapSinglePoint({point:e,context:t,signal:i}){let{view:n}=this,{elevationInfo:r}=t,a=C(e,n,r),d=await this._fetchCandidates(a,P.ALL,t,i);return this._createSnapResult(a,g.MAIN,d,n,e,t,i)}async _snapMultiPoint({point:e,scenePoint:t,context:i,signal:n}){let{view:r}=this,{coordinateHelper:a,elevationInfo:d,spatialReference:p}=i;await V(t.spatialReference,p);let c=I(t,p),l=C(c,r,d),h=await this._fetchCandidates(l,P.FEATURE,i,n);if(h.length>0){let w=await this._fetchCandidates(l,P.SELF,i,n);return this._createSnapResult(l,g.SCENE,[...h,...w],r,c,i,n)}let y=C(e,r,d),v=await this._fetchCandidates(y,P.SELF,i,n);return this._createSnapResult(y,g.MAIN,v,r,{z:a.hasZ()&&e.hasZ?e.z??0:void 0,m:a.hasM()&&e.hasM?e.m??0:void 0},i,n)}async _fetchCandidates(e,t,i,n){return(await Promise.all(this._engines.map(r=>r.fetchCandidates(e,t,i,n)))).flat()}_createSnapResult(e,t,i,n,r,a,d){return{get valid(){return!H(d)},apply:()=>{let{spatialReference:p}=a,{snappedPoint:c,hints:l}=this._processCandidates(e,t,i,a);return this._removeVisualization(),a.visualizer!=null&&this.addHandles(a.visualizer.draw(l,{spatialReference:p,elevationInfo:R,view:n,selfSnappingZ:a.selfSnappingZ}),F),q(c,n,r,a)}}}_processCandidates(e,t,i,n){if(i.length<1)return this.doneSnapping(),{snappedPoint:e,hints:[]};this._currentSnappedType!==t&&this._resetSnappingState(),U(e,i);let r=this._currentMainCandidate;if(r!=null){let a=se(r,i);if(a>=0){if(!(i[a]instanceof T))return this._intersectWithOtherCandidates(a,i,e,t,n);if(this._arePointsWithinScreenThreshold(e,r.targetPoint,n))return this._updateSnappingCandidate(r,t,i,n)}}return this._intersectWithOtherCandidates(0,i,e,t,n)}_intersectWithOtherCandidates(e,t,i,n,r){let{coordinateHelper:a}=r,d=t[e],p=[];for(let c=0;c<t.length;++c){if(c===e)continue;let l=t[c],h=d.constraint.intersect(l.constraint);if(h)for(let y of h.closestPoints(d.targetPoint))p.push([new T(A(y),d,l,l.isDraped),this._squaredScreenDistance(i,y,a)])}return p.length>0&&(p.sort((c,l)=>c[1]-l[1]),p[0][1]<this._squaredPointProximityThreshold(r.pointer))?this._updateSnappingCandidate(p[0][0],n,t,r):z(d,r.drawConstraints)?this._updateSnappingCandidate(d,n,t,r):{snappedPoint:i,hints:[]}}_updateSnappingCandidate(e,t,i,n){this.doneSnapping(),this._currentMainCandidate=e,this._currentSnappedType=t;let r=this._currentMainCandidate.targetPoint,a=[];a.push(...e.hints);for(let d of i){if(e instanceof T){if(d.constraint.equals(e.first.constraint)||d.constraint.equals(e.second.constraint))continue}else if(d.constraint.equals(e.constraint))continue;let p=d.constraint.closestTo(r);this._squaredScreenDistance(p,r,n.coordinateHelper)<ae()&&(d.targetPoint=r,this._currentOtherActiveCandidates.push(d),a.push(...d.hints))}return{snappedPoint:r,hints:a}}_squaredPointProximityThreshold(e){return e==="touch"?this._squaredTouchProximityThreshold:this._squaredMouseProximityThreshold}_arePointsWithinScreenThreshold(e,t,i){return this._squaredScreenDistance(e,t,i.coordinateHelper)<this._squaredPointProximityThreshold(i.pointer)}_squaredScreenDistance(e,t,i){return j(this._toScreen(e,i),this._toScreen(t,i))}_toScreen(e,t){return ee(e,t.spatialReference,R,this.view)}get test(){}},g;s([o({constructOnly:!0})],f.prototype,"view",void 0),s([o()],f.prototype,"options",void 0),s([o({readOnly:!0})],f.prototype,"updating",null),s([o()],f.prototype,"_loadTask",void 0),s([o()],f.prototype,"_engines",void 0),s([o()],f.prototype,"_squaredMouseProximityThreshold",null),s([o()],f.prototype,"_squaredTouchProximityThreshold",null),f=s([_("esri.views.interactive.snapping.SnappingManager")],f),function(e){e[e.MAIN=0]="MAIN",e[e.SCENE=1]="SCENE"}(g||(g={}));var F="visualization-handle";function ae(){return E.satisfiesConstraintScreenThreshold*E.satisfiesConstraintScreenThreshold}function z(e,t){return!t||t.direction==null&&t.distance==null||!(e instanceof B||e instanceof J||e instanceof K||e instanceof Q||e instanceof $)&&(!(e instanceof X)||t.direction==null&&e.selfSnappingType===Y.LastVertex)}function se(e,t){return e instanceof T?D(t,e.first)>=0&&D(t,e.second)>=0?0:-1:D(t,e)}function D(e,t){let i=-1;for(let n=0;n<e.length;++n)if(t.constraint.equals(e[n].constraint)){i=n;break}return i}function oe(e){return e.scenePoint!=null}function pe({coordinateHelper:e,elevationInfo:t}){return e.hasZ()?R:t}export{O as a,ie as b,f as c};
